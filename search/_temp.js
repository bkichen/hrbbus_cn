/*!
 * jQuery JavaScript Library v1.4.2
 * http://jquery.com/
 *
 * Copyright 2010, John Resig
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://jquery.org/license
 *
 * Includes Sizzle.js
 * http://sizzlejs.com/
 * Copyright 2010, The Dojo Foundation
 * Released under the MIT, BSD, and GPL Licenses.
 *
 * Date: Sat Feb 13 22:33:48 2010 -0500
 */
(function(A,w){function ma(){if(!c.isReady){try{s.documentElement.doScroll("left")}catch(a){setTimeout(ma,1);return}c.ready()}}function Qa(a,b){b.src?c.ajax({url:b.src,async:false,dataType:"script"}):c.globalEval(b.text||b.textContent||b.innerHTML||"");b.parentNode&&b.parentNode.removeChild(b)}function X(a,b,d,f,e,j){var i=a.length;if(typeof b==="object"){for(var o in b)X(a,o,b[o],f,e,d);return a}if(d!==w){f=!j&&f&&c.isFunction(d);for(o=0;o<i;o++)e(a[o],b,f?d.call(a[o],o,e(a[o],b)):d,j);return a}return i?
e(a[0],b):w}function J(){return(new Date).getTime()}function Y(){return false}function Z(){return true}function na(a,b,d){d[0].type=a;return c.event.handle.apply(b,d)}function oa(a){var b,d=[],f=[],e=arguments,j,i,o,k,n,r;i=c.data(this,"events");if(!(a.liveFired===this||!i||!i.live||a.button&&a.type==="click")){a.liveFired=this;var u=i.live.slice(0);for(k=0;k<u.length;k++){i=u[k];i.origType.replace(O,"")===a.type?f.push(i.selector):u.splice(k--,1)}j=c(a.target).closest(f,a.currentTarget);n=0;for(r=
j.length;n<r;n++)for(k=0;k<u.length;k++){i=u[k];if(j[n].selector===i.selector){o=j[n].elem;f=null;if(i.preType==="mouseenter"||i.preType==="mouseleave")f=c(a.relatedTarget).closest(i.selector)[0];if(!f||f!==o)d.push({elem:o,handleObj:i})}}n=0;for(r=d.length;n<r;n++){j=d[n];a.currentTarget=j.elem;a.data=j.handleObj.data;a.handleObj=j.handleObj;if(j.handleObj.origHandler.apply(j.elem,e)===false){b=false;break}}return b}}function pa(a,b){return"live."+(a&&a!=="*"?a+".":"")+b.replace(/\./g,"`").replace(/ /g,
"&")}function qa(a){return!a||!a.parentNode||a.parentNode.nodeType===11}function ra(a,b){var d=0;b.each(function(){if(this.nodeName===(a[d]&&a[d].nodeName)){var f=c.data(a[d++]),e=c.data(this,f);if(f=f&&f.events){delete e.handle;e.events={};for(var j in f)for(var i in f[j])c.event.add(this,j,f[j][i],f[j][i].data)}}})}function sa(a,b,d){var f,e,j;b=b&&b[0]?b[0].ownerDocument||b[0]:s;if(a.length===1&&typeof a[0]==="string"&&a[0].length<512&&b===s&&!ta.test(a[0])&&(c.support.checkClone||!ua.test(a[0]))){e=
true;if(j=c.fragments[a[0]])if(j!==1)f=j}if(!f){f=b.createDocumentFragment();c.clean(a,b,f,d)}if(e)c.fragments[a[0]]=j?f:1;return{fragment:f,cacheable:e}}function K(a,b){var d={};c.each(va.concat.apply([],va.slice(0,b)),function(){d[this]=a});return d}function wa(a){return"scrollTo"in a&&a.document?a:a.nodeType===9?a.defaultView||a.parentWindow:false}var c=function(a,b){return new c.fn.init(a,b)},Ra=A.jQuery,Sa=A.$,s=A.document,T,Ta=/^[^<]*(<[\w\W]+>)[^>]*$|^#([\w-]+)$/,Ua=/^.[^:#\[\.,]*$/,Va=/\S/,
Wa=/^(\s|\u00A0)+|(\s|\u00A0)+$/g,Xa=/^<(\w+)\s*\/?>(?:<\/\1>)?$/,P=navigator.userAgent,xa=false,Q=[],L,$=Object.prototype.toString,aa=Object.prototype.hasOwnProperty,ba=Array.prototype.push,R=Array.prototype.slice,ya=Array.prototype.indexOf;c.fn=c.prototype={init:function(a,b){var d,f;if(!a)return this;if(a.nodeType){this.context=this[0]=a;this.length=1;return this}if(a==="body"&&!b){this.context=s;this[0]=s.body;this.selector="body";this.length=1;return this}if(typeof a==="string")if((d=Ta.exec(a))&&
(d[1]||!b))if(d[1]){f=b?b.ownerDocument||b:s;if(a=Xa.exec(a))if(c.isPlainObject(b)){a=[s.createElement(a[1])];c.fn.attr.call(a,b,true)}else a=[f.createElement(a[1])];else{a=sa([d[1]],[f]);a=(a.cacheable?a.fragment.cloneNode(true):a.fragment).childNodes}return c.merge(this,a)}else{if(b=s.getElementById(d[2])){if(b.id!==d[2])return T.find(a);this.length=1;this[0]=b}this.context=s;this.selector=a;return this}else if(!b&&/^\w+$/.test(a)){this.selector=a;this.context=s;a=s.getElementsByTagName(a);return c.merge(this,
a)}else return!b||b.jquery?(b||T).find(a):c(b).find(a);else if(c.isFunction(a))return T.ready(a);if(a.selector!==w){this.selector=a.selector;this.context=a.context}return c.makeArray(a,this)},selector:"",jquery:"1.4.2",length:0,size:function(){return this.length},toArray:function(){return R.call(this,0)},get:function(a){return a==null?this.toArray():a<0?this.slice(a)[0]:this[a]},pushStack:function(a,b,d){var f=c();c.isArray(a)?ba.apply(f,a):c.merge(f,a);f.prevObject=this;f.context=this.context;if(b===
"find")f.selector=this.selector+(this.selector?" ":"")+d;else if(b)f.selector=this.selector+"."+b+"("+d+")";return f},each:function(a,b){return c.each(this,a,b)},ready:function(a){c.bindReady();if(c.isReady)a.call(s,c);else Q&&Q.push(a);return this},eq:function(a){return a===-1?this.slice(a):this.slice(a,+a+1)},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},slice:function(){return this.pushStack(R.apply(this,arguments),"slice",R.call(arguments).join(","))},map:function(a){return this.pushStack(c.map(this,
function(b,d){return a.call(b,d,b)}))},end:function(){return this.prevObject||c(null)},push:ba,sort:[].sort,splice:[].splice};c.fn.init.prototype=c.fn;c.extend=c.fn.extend=function(){var a=arguments[0]||{},b=1,d=arguments.length,f=false,e,j,i,o;if(typeof a==="boolean"){f=a;a=arguments[1]||{};b=2}if(typeof a!=="object"&&!c.isFunction(a))a={};if(d===b){a=this;--b}for(;b<d;b++)if((e=arguments[b])!=null)for(j in e){i=a[j];o=e[j];if(a!==o)if(f&&o&&(c.isPlainObject(o)||c.isArray(o))){i=i&&(c.isPlainObject(i)||
c.isArray(i))?i:c.isArray(o)?[]:{};a[j]=c.extend(f,i,o)}else if(o!==w)a[j]=o}return a};c.extend({noConflict:function(a){A.$=Sa;if(a)A.jQuery=Ra;return c},isReady:false,ready:function(){if(!c.isReady){if(!s.body)return setTimeout(c.ready,13);c.isReady=true;if(Q){for(var a,b=0;a=Q[b++];)a.call(s,c);Q=null}c.fn.triggerHandler&&c(s).triggerHandler("ready")}},bindReady:function(){if(!xa){xa=true;if(s.readyState==="complete")return c.ready();if(s.addEventListener){s.addEventListener("DOMContentLoaded",
L,false);A.addEventListener("load",c.ready,false)}else if(s.attachEvent){s.attachEvent("onreadystatechange",L);A.attachEvent("onload",c.ready);var a=false;try{a=A.frameElement==null}catch(b){}s.documentElement.doScroll&&a&&ma()}}},isFunction:function(a){return $.call(a)==="[object Function]"},isArray:function(a){return $.call(a)==="[object Array]"},isPlainObject:function(a){if(!a||$.call(a)!=="[object Object]"||a.nodeType||a.setInterval)return false;if(a.constructor&&!aa.call(a,"constructor")&&!aa.call(a.constructor.prototype,
"isPrototypeOf"))return false;var b;for(b in a);return b===w||aa.call(a,b)},isEmptyObject:function(a){for(var b in a)return false;return true},error:function(a){throw a;},parseJSON:function(a){if(typeof a!=="string"||!a)return null;a=c.trim(a);if(/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return A.JSON&&A.JSON.parse?A.JSON.parse(a):(new Function("return "+
a))();else c.error("Invalid JSON: "+a)},noop:function(){},globalEval:function(a){if(a&&Va.test(a)){var b=s.getElementsByTagName("head")[0]||s.documentElement,d=s.createElement("script");d.type="text/javascript";if(c.support.scriptEval)d.appendChild(s.createTextNode(a));else d.text=a;b.insertBefore(d,b.firstChild);b.removeChild(d)}},nodeName:function(a,b){return a.nodeName&&a.nodeName.toUpperCase()===b.toUpperCase()},each:function(a,b,d){var f,e=0,j=a.length,i=j===w||c.isFunction(a);if(d)if(i)for(f in a){if(b.apply(a[f],
d)===false)break}else for(;e<j;){if(b.apply(a[e++],d)===false)break}else if(i)for(f in a){if(b.call(a[f],f,a[f])===false)break}else for(d=a[0];e<j&&b.call(d,e,d)!==false;d=a[++e]);return a},trim:function(a){return(a||"").replace(Wa,"")},makeArray:function(a,b){b=b||[];if(a!=null)a.length==null||typeof a==="string"||c.isFunction(a)||typeof a!=="function"&&a.setInterval?ba.call(b,a):c.merge(b,a);return b},inArray:function(a,b){if(b.indexOf)return b.indexOf(a);for(var d=0,f=b.length;d<f;d++)if(b[d]===
a)return d;return-1},merge:function(a,b){var d=a.length,f=0;if(typeof b.length==="number")for(var e=b.length;f<e;f++)a[d++]=b[f];else for(;b[f]!==w;)a[d++]=b[f++];a.length=d;return a},grep:function(a,b,d){for(var f=[],e=0,j=a.length;e<j;e++)!d!==!b(a[e],e)&&f.push(a[e]);return f},map:function(a,b,d){for(var f=[],e,j=0,i=a.length;j<i;j++){e=b(a[j],j,d);if(e!=null)f[f.length]=e}return f.concat.apply([],f)},guid:1,proxy:function(a,b,d){if(arguments.length===2)if(typeof b==="string"){d=a;a=d[b];b=w}else if(b&&
!c.isFunction(b)){d=b;b=w}if(!b&&a)b=function(){return a.apply(d||this,arguments)};if(a)b.guid=a.guid=a.guid||b.guid||c.guid++;return b},uaMatch:function(a){a=a.toLowerCase();a=/(webkit)[ \/]([\w.]+)/.exec(a)||/(opera)(?:.*version)?[ \/]([\w.]+)/.exec(a)||/(msie) ([\w.]+)/.exec(a)||!/compatible/.test(a)&&/(mozilla)(?:.*? rv:([\w.]+))?/.exec(a)||[];return{browser:a[1]||"",version:a[2]||"0"}},browser:{}});P=c.uaMatch(P);if(P.browser){c.browser[P.browser]=true;c.browser.version=P.version}if(c.browser.webkit)c.browser.safari=
true;if(ya)c.inArray=function(a,b){return ya.call(b,a)};T=c(s);if(s.addEventListener)L=function(){s.removeEventListener("DOMContentLoaded",L,false);c.ready()};else if(s.attachEvent)L=function(){if(s.readyState==="complete"){s.detachEvent("onreadystatechange",L);c.ready()}};(function(){c.support={};var a=s.documentElement,b=s.createElement("script"),d=s.createElement("div"),f="script"+J();d.style.display="none";d.innerHTML="   <link/><table></table><a href='/a' style='color:red;float:left;opacity:.55;'>a</a><input type='checkbox'/>";
var e=d.getElementsByTagName("*"),j=d.getElementsByTagName("a")[0];if(!(!e||!e.length||!j)){c.support={leadingWhitespace:d.firstChild.nodeType===3,tbody:!d.getElementsByTagName("tbody").length,htmlSerialize:!!d.getElementsByTagName("link").length,style:/red/.test(j.getAttribute("style")),hrefNormalized:j.getAttribute("href")==="/a",opacity:/^0.55$/.test(j.style.opacity),cssFloat:!!j.style.cssFloat,checkOn:d.getElementsByTagName("input")[0].value==="on",optSelected:s.createElement("select").appendChild(s.createElement("option")).selected,
parentNode:d.removeChild(d.appendChild(s.createElement("div"))).parentNode===null,deleteExpando:true,checkClone:false,scriptEval:false,noCloneEvent:true,boxModel:null};b.type="text/javascript";try{b.appendChild(s.createTextNode("window."+f+"=1;"))}catch(i){}a.insertBefore(b,a.firstChild);if(A[f]){c.support.scriptEval=true;delete A[f]}try{delete b.test}catch(o){c.support.deleteExpando=false}a.removeChild(b);if(d.attachEvent&&d.fireEvent){d.attachEvent("onclick",function k(){c.support.noCloneEvent=
false;d.detachEvent("onclick",k)});d.cloneNode(true).fireEvent("onclick")}d=s.createElement("div");d.innerHTML="<input type='radio' name='radiotest' checked='checked'/>";a=s.createDocumentFragment();a.appendChild(d.firstChild);c.support.checkClone=a.cloneNode(true).cloneNode(true).lastChild.checked;c(function(){var k=s.createElement("div");k.style.width=k.style.paddingLeft="1px";s.body.appendChild(k);c.boxModel=c.support.boxModel=k.offsetWidth===2;s.body.removeChild(k).style.display="none"});a=function(k){var n=
s.createElement("div");k="on"+k;var r=k in n;if(!r){n.setAttribute(k,"return;");r=typeof n[k]==="function"}return r};c.support.submitBubbles=a("submit");c.support.changeBubbles=a("change");a=b=d=e=j=null}})();c.props={"for":"htmlFor","class":"className",readonly:"readOnly",maxlength:"maxLength",cellspacing:"cellSpacing",rowspan:"rowSpan",colspan:"colSpan",tabindex:"tabIndex",usemap:"useMap",frameborder:"frameBorder"};var G="jQuery"+J(),Ya=0,za={};c.extend({cache:{},expando:G,noData:{embed:true,object:true,
applet:true},data:function(a,b,d){if(!(a.nodeName&&c.noData[a.nodeName.toLowerCase()])){a=a==A?za:a;var f=a[G],e=c.cache;if(!f&&typeof b==="string"&&d===w)return null;f||(f=++Ya);if(typeof b==="object"){a[G]=f;e[f]=c.extend(true,{},b)}else if(!e[f]){a[G]=f;e[f]={}}a=e[f];if(d!==w)a[b]=d;return typeof b==="string"?a[b]:a}},removeData:function(a,b){if(!(a.nodeName&&c.noData[a.nodeName.toLowerCase()])){a=a==A?za:a;var d=a[G],f=c.cache,e=f[d];if(b){if(e){delete e[b];c.isEmptyObject(e)&&c.removeData(a)}}else{if(c.support.deleteExpando)delete a[c.expando];
else a.removeAttribute&&a.removeAttribute(c.expando);delete f[d]}}}});c.fn.extend({data:function(a,b){if(typeof a==="undefined"&&this.length)return c.data(this[0]);else if(typeof a==="object")return this.each(function(){c.data(this,a)});var d=a.split(".");d[1]=d[1]?"."+d[1]:"";if(b===w){var f=this.triggerHandler("getData"+d[1]+"!",[d[0]]);if(f===w&&this.length)f=c.data(this[0],a);return f===w&&d[1]?this.data(d[0]):f}else return this.trigger("setData"+d[1]+"!",[d[0],b]).each(function(){c.data(this,
a,b)})},removeData:function(a){return this.each(function(){c.removeData(this,a)})}});c.extend({queue:function(a,b,d){if(a){b=(b||"fx")+"queue";var f=c.data(a,b);if(!d)return f||[];if(!f||c.isArray(d))f=c.data(a,b,c.makeArray(d));else f.push(d);return f}},dequeue:function(a,b){b=b||"fx";var d=c.queue(a,b),f=d.shift();if(f==="inprogress")f=d.shift();if(f){b==="fx"&&d.unshift("inprogress");f.call(a,function(){c.dequeue(a,b)})}}});c.fn.extend({queue:function(a,b){if(typeof a!=="string"){b=a;a="fx"}if(b===
w)return c.queue(this[0],a);return this.each(function(){var d=c.queue(this,a,b);a==="fx"&&d[0]!=="inprogress"&&c.dequeue(this,a)})},dequeue:function(a){return this.each(function(){c.dequeue(this,a)})},delay:function(a,b){a=c.fx?c.fx.speeds[a]||a:a;b=b||"fx";return this.queue(b,function(){var d=this;setTimeout(function(){c.dequeue(d,b)},a)})},clearQueue:function(a){return this.queue(a||"fx",[])}});var Aa=/[\n\t]/g,ca=/\s+/,Za=/\r/g,$a=/href|src|style/,ab=/(button|input)/i,bb=/(button|input|object|select|textarea)/i,
cb=/^(a|area)$/i,Ba=/radio|checkbox/;c.fn.extend({attr:function(a,b){return X(this,a,b,true,c.attr)},removeAttr:function(a){return this.each(function(){c.attr(this,a,"");this.nodeType===1&&this.removeAttribute(a)})},addClass:function(a){if(c.isFunction(a))return this.each(function(n){var r=c(this);r.addClass(a.call(this,n,r.attr("class")))});if(a&&typeof a==="string")for(var b=(a||"").split(ca),d=0,f=this.length;d<f;d++){var e=this[d];if(e.nodeType===1)if(e.className){for(var j=" "+e.className+" ",
i=e.className,o=0,k=b.length;o<k;o++)if(j.indexOf(" "+b[o]+" ")<0)i+=" "+b[o];e.className=c.trim(i)}else e.className=a}return this},removeClass:function(a){if(c.isFunction(a))return this.each(function(k){var n=c(this);n.removeClass(a.call(this,k,n.attr("class")))});if(a&&typeof a==="string"||a===w)for(var b=(a||"").split(ca),d=0,f=this.length;d<f;d++){var e=this[d];if(e.nodeType===1&&e.className)if(a){for(var j=(" "+e.className+" ").replace(Aa," "),i=0,o=b.length;i<o;i++)j=j.replace(" "+b[i]+" ",
" ");e.className=c.trim(j)}else e.className=""}return this},toggleClass:function(a,b){var d=typeof a,f=typeof b==="boolean";if(c.isFunction(a))return this.each(function(e){var j=c(this);j.toggleClass(a.call(this,e,j.attr("class"),b),b)});return this.each(function(){if(d==="string")for(var e,j=0,i=c(this),o=b,k=a.split(ca);e=k[j++];){o=f?o:!i.hasClass(e);i[o?"addClass":"removeClass"](e)}else if(d==="undefined"||d==="boolean"){this.className&&c.data(this,"__className__",this.className);this.className=
this.className||a===false?"":c.data(this,"__className__")||""}})},hasClass:function(a){a=" "+a+" ";for(var b=0,d=this.length;b<d;b++)if((" "+this[b].className+" ").replace(Aa," ").indexOf(a)>-1)return true;return false},val:function(a){if(a===w){var b=this[0];if(b){if(c.nodeName(b,"option"))return(b.attributes.value||{}).specified?b.value:b.text;if(c.nodeName(b,"select")){var d=b.selectedIndex,f=[],e=b.options;b=b.type==="select-one";if(d<0)return null;var j=b?d:0;for(d=b?d+1:e.length;j<d;j++){var i=
e[j];if(i.selected){a=c(i).val();if(b)return a;f.push(a)}}return f}if(Ba.test(b.type)&&!c.support.checkOn)return b.getAttribute("value")===null?"on":b.value;return(b.value||"").replace(Za,"")}return w}var o=c.isFunction(a);return this.each(function(k){var n=c(this),r=a;if(this.nodeType===1){if(o)r=a.call(this,k,n.val());if(typeof r==="number")r+="";if(c.isArray(r)&&Ba.test(this.type))this.checked=c.inArray(n.val(),r)>=0;else if(c.nodeName(this,"select")){var u=c.makeArray(r);c("option",this).each(function(){this.selected=
c.inArray(c(this).val(),u)>=0});if(!u.length)this.selectedIndex=-1}else this.value=r}})}});c.extend({attrFn:{val:true,css:true,html:true,text:true,data:true,width:true,height:true,offset:true},attr:function(a,b,d,f){if(!a||a.nodeType===3||a.nodeType===8)return w;if(f&&b in c.attrFn)return c(a)[b](d);f=a.nodeType!==1||!c.isXMLDoc(a);var e=d!==w;b=f&&c.props[b]||b;if(a.nodeType===1){var j=$a.test(b);if(b in a&&f&&!j){if(e){b==="type"&&ab.test(a.nodeName)&&a.parentNode&&c.error("type property can't be changed");
a[b]=d}if(c.nodeName(a,"form")&&a.getAttributeNode(b))return a.getAttributeNode(b).nodeValue;if(b==="tabIndex")return(b=a.getAttributeNode("tabIndex"))&&b.specified?b.value:bb.test(a.nodeName)||cb.test(a.nodeName)&&a.href?0:w;return a[b]}if(!c.support.style&&f&&b==="style"){if(e)a.style.cssText=""+d;return a.style.cssText}e&&a.setAttribute(b,""+d);a=!c.support.hrefNormalized&&f&&j?a.getAttribute(b,2):a.getAttribute(b);return a===null?w:a}return c.style(a,b,d)}});var O=/\.(.*)$/,db=function(a){return a.replace(/[^\w\s\.\|`]/g,
function(b){return"\\"+b})};c.event={add:function(a,b,d,f){if(!(a.nodeType===3||a.nodeType===8)){if(a.setInterval&&a!==A&&!a.frameElement)a=A;var e,j;if(d.handler){e=d;d=e.handler}if(!d.guid)d.guid=c.guid++;if(j=c.data(a)){var i=j.events=j.events||{},o=j.handle;if(!o)j.handle=o=function(){return typeof c!=="undefined"&&!c.event.triggered?c.event.handle.apply(o.elem,arguments):w};o.elem=a;b=b.split(" ");for(var k,n=0,r;k=b[n++];){j=e?c.extend({},e):{handler:d,data:f};if(k.indexOf(".")>-1){r=k.split(".");
k=r.shift();j.namespace=r.slice(0).sort().join(".")}else{r=[];j.namespace=""}j.type=k;j.guid=d.guid;var u=i[k],z=c.event.special[k]||{};if(!u){u=i[k]=[];if(!z.setup||z.setup.call(a,f,r,o)===false)if(a.addEventListener)a.addEventListener(k,o,false);else a.attachEvent&&a.attachEvent("on"+k,o)}if(z.add){z.add.call(a,j);if(!j.handler.guid)j.handler.guid=d.guid}u.push(j);c.event.global[k]=true}a=null}}},global:{},remove:function(a,b,d,f){if(!(a.nodeType===3||a.nodeType===8)){var e,j=0,i,o,k,n,r,u,z=c.data(a),
C=z&&z.events;if(z&&C){if(b&&b.type){d=b.handler;b=b.type}if(!b||typeof b==="string"&&b.charAt(0)==="."){b=b||"";for(e in C)c.event.remove(a,e+b)}else{for(b=b.split(" ");e=b[j++];){n=e;i=e.indexOf(".")<0;o=[];if(!i){o=e.split(".");e=o.shift();k=new RegExp("(^|\\.)"+c.map(o.slice(0).sort(),db).join("\\.(?:.*\\.)?")+"(\\.|$)")}if(r=C[e])if(d){n=c.event.special[e]||{};for(B=f||0;B<r.length;B++){u=r[B];if(d.guid===u.guid){if(i||k.test(u.namespace)){f==null&&r.splice(B--,1);n.remove&&n.remove.call(a,u)}if(f!=
null)break}}if(r.length===0||f!=null&&r.length===1){if(!n.teardown||n.teardown.call(a,o)===false)Ca(a,e,z.handle);delete C[e]}}else for(var B=0;B<r.length;B++){u=r[B];if(i||k.test(u.namespace)){c.event.remove(a,n,u.handler,B);r.splice(B--,1)}}}if(c.isEmptyObject(C)){if(b=z.handle)b.elem=null;delete z.events;delete z.handle;c.isEmptyObject(z)&&c.removeData(a)}}}}},trigger:function(a,b,d,f){var e=a.type||a;if(!f){a=typeof a==="object"?a[G]?a:c.extend(c.Event(e),a):c.Event(e);if(e.indexOf("!")>=0){a.type=
e=e.slice(0,-1);a.exclusive=true}if(!d){a.stopPropagation();c.event.global[e]&&c.each(c.cache,function(){this.events&&this.events[e]&&c.event.trigger(a,b,this.handle.elem)})}if(!d||d.nodeType===3||d.nodeType===8)return w;a.result=w;a.target=d;b=c.makeArray(b);b.unshift(a)}a.currentTarget=d;(f=c.data(d,"handle"))&&f.apply(d,b);f=d.parentNode||d.ownerDocument;try{if(!(d&&d.nodeName&&c.noData[d.nodeName.toLowerCase()]))if(d["on"+e]&&d["on"+e].apply(d,b)===false)a.result=false}catch(j){}if(!a.isPropagationStopped()&&
f)c.event.trigger(a,b,f,true);else if(!a.isDefaultPrevented()){f=a.target;var i,o=c.nodeName(f,"a")&&e==="click",k=c.event.special[e]||{};if((!k._default||k._default.call(d,a)===false)&&!o&&!(f&&f.nodeName&&c.noData[f.nodeName.toLowerCase()])){try{if(f[e]){if(i=f["on"+e])f["on"+e]=null;c.event.triggered=true;f[e]()}}catch(n){}if(i)f["on"+e]=i;c.event.triggered=false}}},handle:function(a){var b,d,f,e;a=arguments[0]=c.event.fix(a||A.event);a.currentTarget=this;b=a.type.indexOf(".")<0&&!a.exclusive;
if(!b){d=a.type.split(".");a.type=d.shift();f=new RegExp("(^|\\.)"+d.slice(0).sort().join("\\.(?:.*\\.)?")+"(\\.|$)")}e=c.data(this,"events");d=e[a.type];if(e&&d){d=d.slice(0);e=0;for(var j=d.length;e<j;e++){var i=d[e];if(b||f.test(i.namespace)){a.handler=i.handler;a.data=i.data;a.handleObj=i;i=i.handler.apply(this,arguments);if(i!==w){a.result=i;if(i===false){a.preventDefault();a.stopPropagation()}}if(a.isImmediatePropagationStopped())break}}}return a.result},props:"altKey attrChange attrName bubbles button cancelable charCode clientX clientY ctrlKey currentTarget data detail eventPhase fromElement handler keyCode layerX layerY metaKey newValue offsetX offsetY originalTarget pageX pageY prevValue relatedNode relatedTarget screenX screenY shiftKey srcElement target toElement view wheelDelta which".split(" "),
fix:function(a){if(a[G])return a;var b=a;a=c.Event(b);for(var d=this.props.length,f;d;){f=this.props[--d];a[f]=b[f]}if(!a.target)a.target=a.srcElement||s;if(a.target.nodeType===3)a.target=a.target.parentNode;if(!a.relatedTarget&&a.fromElement)a.relatedTarget=a.fromElement===a.target?a.toElement:a.fromElement;if(a.pageX==null&&a.clientX!=null){b=s.documentElement;d=s.body;a.pageX=a.clientX+(b&&b.scrollLeft||d&&d.scrollLeft||0)-(b&&b.clientLeft||d&&d.clientLeft||0);a.pageY=a.clientY+(b&&b.scrollTop||
d&&d.scrollTop||0)-(b&&b.clientTop||d&&d.clientTop||0)}if(!a.which&&(a.charCode||a.charCode===0?a.charCode:a.keyCode))a.which=a.charCode||a.keyCode;if(!a.metaKey&&a.ctrlKey)a.metaKey=a.ctrlKey;if(!a.which&&a.button!==w)a.which=a.button&1?1:a.button&2?3:a.button&4?2:0;return a},guid:1E8,proxy:c.proxy,special:{ready:{setup:c.bindReady,teardown:c.noop},live:{add:function(a){c.event.add(this,a.origType,c.extend({},a,{handler:oa}))},remove:function(a){var b=true,d=a.origType.replace(O,"");c.each(c.data(this,
"events").live||[],function(){if(d===this.origType.replace(O,""))return b=false});b&&c.event.remove(this,a.origType,oa)}},beforeunload:{setup:function(a,b,d){if(this.setInterval)this.onbeforeunload=d;return false},teardown:function(a,b){if(this.onbeforeunload===b)this.onbeforeunload=null}}}};var Ca=s.removeEventListener?function(a,b,d){a.removeEventListener(b,d,false)}:function(a,b,d){a.detachEvent("on"+b,d)};c.Event=function(a){if(!this.preventDefault)return new c.Event(a);if(a&&a.type){this.originalEvent=
a;this.type=a.type}else this.type=a;this.timeStamp=J();this[G]=true};c.Event.prototype={preventDefault:function(){this.isDefaultPrevented=Z;var a=this.originalEvent;if(a){a.preventDefault&&a.preventDefault();a.returnValue=false}},stopPropagation:function(){this.isPropagationStopped=Z;var a=this.originalEvent;if(a){a.stopPropagation&&a.stopPropagation();a.cancelBubble=true}},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=Z;this.stopPropagation()},isDefaultPrevented:Y,isPropagationStopped:Y,
isImmediatePropagationStopped:Y};var Da=function(a){var b=a.relatedTarget;try{for(;b&&b!==this;)b=b.parentNode;if(b!==this){a.type=a.data;c.event.handle.apply(this,arguments)}}catch(d){}},Ea=function(a){a.type=a.data;c.event.handle.apply(this,arguments)};c.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(a,b){c.event.special[a]={setup:function(d){c.event.add(this,b,d&&d.selector?Ea:Da,a)},teardown:function(d){c.event.remove(this,b,d&&d.selector?Ea:Da)}}});if(!c.support.submitBubbles)c.event.special.submit=
{setup:function(){if(this.nodeName.toLowerCase()!=="form"){c.event.add(this,"click.specialSubmit",function(a){var b=a.target,d=b.type;if((d==="submit"||d==="image")&&c(b).closest("form").length)return na("submit",this,arguments)});c.event.add(this,"keypress.specialSubmit",function(a){var b=a.target,d=b.type;if((d==="text"||d==="password")&&c(b).closest("form").length&&a.keyCode===13)return na("submit",this,arguments)})}else return false},teardown:function(){c.event.remove(this,".specialSubmit")}};
if(!c.support.changeBubbles){var da=/textarea|input|select/i,ea,Fa=function(a){var b=a.type,d=a.value;if(b==="radio"||b==="checkbox")d=a.checked;else if(b==="select-multiple")d=a.selectedIndex>-1?c.map(a.options,function(f){return f.selected}).join("-"):"";else if(a.nodeName.toLowerCase()==="select")d=a.selectedIndex;return d},fa=function(a,b){var d=a.target,f,e;if(!(!da.test(d.nodeName)||d.readOnly)){f=c.data(d,"_change_data");e=Fa(d);if(a.type!=="focusout"||d.type!=="radio")c.data(d,"_change_data",
e);if(!(f===w||e===f))if(f!=null||e){a.type="change";return c.event.trigger(a,b,d)}}};c.event.special.change={filters:{focusout:fa,click:function(a){var b=a.target,d=b.type;if(d==="radio"||d==="checkbox"||b.nodeName.toLowerCase()==="select")return fa.call(this,a)},keydown:function(a){var b=a.target,d=b.type;if(a.keyCode===13&&b.nodeName.toLowerCase()!=="textarea"||a.keyCode===32&&(d==="checkbox"||d==="radio")||d==="select-multiple")return fa.call(this,a)},beforeactivate:function(a){a=a.target;c.data(a,
"_change_data",Fa(a))}},setup:function(){if(this.type==="file")return false;for(var a in ea)c.event.add(this,a+".specialChange",ea[a]);return da.test(this.nodeName)},teardown:function(){c.event.remove(this,".specialChange");return da.test(this.nodeName)}};ea=c.event.special.change.filters}s.addEventListener&&c.each({focus:"focusin",blur:"focusout"},function(a,b){function d(f){f=c.event.fix(f);f.type=b;return c.event.handle.call(this,f)}c.event.special[b]={setup:function(){this.addEventListener(a,
d,true)},teardown:function(){this.removeEventListener(a,d,true)}}});c.each(["bind","one"],function(a,b){c.fn[b]=function(d,f,e){if(typeof d==="object"){for(var j in d)this[b](j,f,d[j],e);return this}if(c.isFunction(f)){e=f;f=w}var i=b==="one"?c.proxy(e,function(k){c(this).unbind(k,i);return e.apply(this,arguments)}):e;if(d==="unload"&&b!=="one")this.one(d,f,e);else{j=0;for(var o=this.length;j<o;j++)c.event.add(this[j],d,i,f)}return this}});c.fn.extend({unbind:function(a,b){if(typeof a==="object"&&
!a.preventDefault)for(var d in a)this.unbind(d,a[d]);else{d=0;for(var f=this.length;d<f;d++)c.event.remove(this[d],a,b)}return this},delegate:function(a,b,d,f){return this.live(b,d,f,a)},undelegate:function(a,b,d){return arguments.length===0?this.unbind("live"):this.die(b,null,d,a)},trigger:function(a,b){return this.each(function(){c.event.trigger(a,b,this)})},triggerHandler:function(a,b){if(this[0]){a=c.Event(a);a.preventDefault();a.stopPropagation();c.event.trigger(a,b,this[0]);return a.result}},
toggle:function(a){for(var b=arguments,d=1;d<b.length;)c.proxy(a,b[d++]);return this.click(c.proxy(a,function(f){var e=(c.data(this,"lastToggle"+a.guid)||0)%d;c.data(this,"lastToggle"+a.guid,e+1);f.preventDefault();return b[e].apply(this,arguments)||false}))},hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)}});var Ga={focus:"focusin",blur:"focusout",mouseenter:"mouseover",mouseleave:"mouseout"};c.each(["live","die"],function(a,b){c.fn[b]=function(d,f,e,j){var i,o=0,k,n,r=j||this.selector,
u=j?this:c(this.context);if(c.isFunction(f)){e=f;f=w}for(d=(d||"").split(" ");(i=d[o++])!=null;){j=O.exec(i);k="";if(j){k=j[0];i=i.replace(O,"")}if(i==="hover")d.push("mouseenter"+k,"mouseleave"+k);else{n=i;if(i==="focus"||i==="blur"){d.push(Ga[i]+k);i+=k}else i=(Ga[i]||i)+k;b==="live"?u.each(function(){c.event.add(this,pa(i,r),{data:f,selector:r,handler:e,origType:i,origHandler:e,preType:n})}):u.unbind(pa(i,r),e)}}return this}});c.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error".split(" "),
function(a,b){c.fn[b]=function(d){return d?this.bind(b,d):this.trigger(b)};if(c.attrFn)c.attrFn[b]=true});A.attachEvent&&!A.addEventListener&&A.attachEvent("onunload",function(){for(var a in c.cache)if(c.cache[a].handle)try{c.event.remove(c.cache[a].handle.elem)}catch(b){}});(function(){function a(g){for(var h="",l,m=0;g[m];m++){l=g[m];if(l.nodeType===3||l.nodeType===4)h+=l.nodeValue;else if(l.nodeType!==8)h+=a(l.childNodes)}return h}function b(g,h,l,m,q,p){q=0;for(var v=m.length;q<v;q++){var t=m[q];
if(t){t=t[g];for(var y=false;t;){if(t.sizcache===l){y=m[t.sizset];break}if(t.nodeType===1&&!p){t.sizcache=l;t.sizset=q}if(t.nodeName.toLowerCase()===h){y=t;break}t=t[g]}m[q]=y}}}function d(g,h,l,m,q,p){q=0;for(var v=m.length;q<v;q++){var t=m[q];if(t){t=t[g];for(var y=false;t;){if(t.sizcache===l){y=m[t.sizset];break}if(t.nodeType===1){if(!p){t.sizcache=l;t.sizset=q}if(typeof h!=="string"){if(t===h){y=true;break}}else if(k.filter(h,[t]).length>0){y=t;break}}t=t[g]}m[q]=y}}}var f=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^[\]]*\]|['"][^'"]*['"]|[^[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g,
e=0,j=Object.prototype.toString,i=false,o=true;[0,0].sort(function(){o=false;return 0});var k=function(g,h,l,m){l=l||[];var q=h=h||s;if(h.nodeType!==1&&h.nodeType!==9)return[];if(!g||typeof g!=="string")return l;for(var p=[],v,t,y,S,H=true,M=x(h),I=g;(f.exec(""),v=f.exec(I))!==null;){I=v[3];p.push(v[1]);if(v[2]){S=v[3];break}}if(p.length>1&&r.exec(g))if(p.length===2&&n.relative[p[0]])t=ga(p[0]+p[1],h);else for(t=n.relative[p[0]]?[h]:k(p.shift(),h);p.length;){g=p.shift();if(n.relative[g])g+=p.shift();
t=ga(g,t)}else{if(!m&&p.length>1&&h.nodeType===9&&!M&&n.match.ID.test(p[0])&&!n.match.ID.test(p[p.length-1])){v=k.find(p.shift(),h,M);h=v.expr?k.filter(v.expr,v.set)[0]:v.set[0]}if(h){v=m?{expr:p.pop(),set:z(m)}:k.find(p.pop(),p.length===1&&(p[0]==="~"||p[0]==="+")&&h.parentNode?h.parentNode:h,M);t=v.expr?k.filter(v.expr,v.set):v.set;if(p.length>0)y=z(t);else H=false;for(;p.length;){var D=p.pop();v=D;if(n.relative[D])v=p.pop();else D="";if(v==null)v=h;n.relative[D](y,v,M)}}else y=[]}y||(y=t);y||k.error(D||
g);if(j.call(y)==="[object Array]")if(H)if(h&&h.nodeType===1)for(g=0;y[g]!=null;g++){if(y[g]&&(y[g]===true||y[g].nodeType===1&&E(h,y[g])))l.push(t[g])}else for(g=0;y[g]!=null;g++)y[g]&&y[g].nodeType===1&&l.push(t[g]);else l.push.apply(l,y);else z(y,l);if(S){k(S,q,l,m);k.uniqueSort(l)}return l};k.uniqueSort=function(g){if(B){i=o;g.sort(B);if(i)for(var h=1;h<g.length;h++)g[h]===g[h-1]&&g.splice(h--,1)}return g};k.matches=function(g,h){return k(g,null,null,h)};k.find=function(g,h,l){var m,q;if(!g)return[];
for(var p=0,v=n.order.length;p<v;p++){var t=n.order[p];if(q=n.leftMatch[t].exec(g)){var y=q[1];q.splice(1,1);if(y.substr(y.length-1)!=="\\"){q[1]=(q[1]||"").replace(/\\/g,"");m=n.find[t](q,h,l);if(m!=null){g=g.replace(n.match[t],"");break}}}}m||(m=h.getElementsByTagName("*"));return{set:m,expr:g}};k.filter=function(g,h,l,m){for(var q=g,p=[],v=h,t,y,S=h&&h[0]&&x(h[0]);g&&h.length;){for(var H in n.filter)if((t=n.leftMatch[H].exec(g))!=null&&t[2]){var M=n.filter[H],I,D;D=t[1];y=false;t.splice(1,1);if(D.substr(D.length-
1)!=="\\"){if(v===p)p=[];if(n.preFilter[H])if(t=n.preFilter[H](t,v,l,p,m,S)){if(t===true)continue}else y=I=true;if(t)for(var U=0;(D=v[U])!=null;U++)if(D){I=M(D,t,U,v);var Ha=m^!!I;if(l&&I!=null)if(Ha)y=true;else v[U]=false;else if(Ha){p.push(D);y=true}}if(I!==w){l||(v=p);g=g.replace(n.match[H],"");if(!y)return[];break}}}if(g===q)if(y==null)k.error(g);else break;q=g}return v};k.error=function(g){throw"Syntax error, unrecognized expression: "+g;};var n=k.selectors={order:["ID","NAME","TAG"],match:{ID:/#((?:[\w\u00c0-\uFFFF-]|\\.)+)/,
CLASS:/\.((?:[\w\u00c0-\uFFFF-]|\\.)+)/,NAME:/\[name=['"]*((?:[\w\u00c0-\uFFFF-]|\\.)+)['"]*\]/,ATTR:/\[\s*((?:[\w\u00c0-\uFFFF-]|\\.)+)\s*(?:(\S?=)\s*(['"]*)(.*?)\3|)\s*\]/,TAG:/^((?:[\w\u00c0-\uFFFF\*-]|\\.)+)/,CHILD:/:(only|nth|last|first)-child(?:\((even|odd|[\dn+-]*)\))?/,POS:/:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^-]|$)/,PSEUDO:/:((?:[\w\u00c0-\uFFFF-]|\\.)+)(?:\((['"]?)((?:\([^\)]+\)|[^\(\)]*)+)\2\))?/},leftMatch:{},attrMap:{"class":"className","for":"htmlFor"},attrHandle:{href:function(g){return g.getAttribute("href")}},
relative:{"+":function(g,h){var l=typeof h==="string",m=l&&!/\W/.test(h);l=l&&!m;if(m)h=h.toLowerCase();m=0;for(var q=g.length,p;m<q;m++)if(p=g[m]){for(;(p=p.previousSibling)&&p.nodeType!==1;);g[m]=l||p&&p.nodeName.toLowerCase()===h?p||false:p===h}l&&k.filter(h,g,true)},">":function(g,h){var l=typeof h==="string";if(l&&!/\W/.test(h)){h=h.toLowerCase();for(var m=0,q=g.length;m<q;m++){var p=g[m];if(p){l=p.parentNode;g[m]=l.nodeName.toLowerCase()===h?l:false}}}else{m=0;for(q=g.length;m<q;m++)if(p=g[m])g[m]=
l?p.parentNode:p.parentNode===h;l&&k.filter(h,g,true)}},"":function(g,h,l){var m=e++,q=d;if(typeof h==="string"&&!/\W/.test(h)){var p=h=h.toLowerCase();q=b}q("parentNode",h,m,g,p,l)},"~":function(g,h,l){var m=e++,q=d;if(typeof h==="string"&&!/\W/.test(h)){var p=h=h.toLowerCase();q=b}q("previousSibling",h,m,g,p,l)}},find:{ID:function(g,h,l){if(typeof h.getElementById!=="undefined"&&!l)return(g=h.getElementById(g[1]))?[g]:[]},NAME:function(g,h){if(typeof h.getElementsByName!=="undefined"){var l=[];
h=h.getElementsByName(g[1]);for(var m=0,q=h.length;m<q;m++)h[m].getAttribute("name")===g[1]&&l.push(h[m]);return l.length===0?null:l}},TAG:function(g,h){return h.getElementsByTagName(g[1])}},preFilter:{CLASS:function(g,h,l,m,q,p){g=" "+g[1].replace(/\\/g,"")+" ";if(p)return g;p=0;for(var v;(v=h[p])!=null;p++)if(v)if(q^(v.className&&(" "+v.className+" ").replace(/[\t\n]/g," ").indexOf(g)>=0))l||m.push(v);else if(l)h[p]=false;return false},ID:function(g){return g[1].replace(/\\/g,"")},TAG:function(g){return g[1].toLowerCase()},
CHILD:function(g){if(g[1]==="nth"){var h=/(-?)(\d*)n((?:\+|-)?\d*)/.exec(g[2]==="even"&&"2n"||g[2]==="odd"&&"2n+1"||!/\D/.test(g[2])&&"0n+"+g[2]||g[2]);g[2]=h[1]+(h[2]||1)-0;g[3]=h[3]-0}g[0]=e++;return g},ATTR:function(g,h,l,m,q,p){h=g[1].replace(/\\/g,"");if(!p&&n.attrMap[h])g[1]=n.attrMap[h];if(g[2]==="~=")g[4]=" "+g[4]+" ";return g},PSEUDO:function(g,h,l,m,q){if(g[1]==="not")if((f.exec(g[3])||"").length>1||/^\w/.test(g[3]))g[3]=k(g[3],null,null,h);else{g=k.filter(g[3],h,l,true^q);l||m.push.apply(m,
g);return false}else if(n.match.POS.test(g[0])||n.match.CHILD.test(g[0]))return true;return g},POS:function(g){g.unshift(true);return g}},filters:{enabled:function(g){return g.disabled===false&&g.type!=="hidden"},disabled:function(g){return g.disabled===true},checked:function(g){return g.checked===true},selected:function(g){return g.selected===true},parent:function(g){return!!g.firstChild},empty:function(g){return!g.firstChild},has:function(g,h,l){return!!k(l[3],g).length},header:function(g){return/h\d/i.test(g.nodeName)},
text:function(g){return"text"===g.type},radio:function(g){return"radio"===g.type},checkbox:function(g){return"checkbox"===g.type},file:function(g){return"file"===g.type},password:function(g){return"password"===g.type},submit:function(g){return"submit"===g.type},image:function(g){return"image"===g.type},reset:function(g){return"reset"===g.type},button:function(g){return"button"===g.type||g.nodeName.toLowerCase()==="button"},input:function(g){return/input|select|textarea|button/i.test(g.nodeName)}},
setFilters:{first:function(g,h){return h===0},last:function(g,h,l,m){return h===m.length-1},even:function(g,h){return h%2===0},odd:function(g,h){return h%2===1},lt:function(g,h,l){return h<l[3]-0},gt:function(g,h,l){return h>l[3]-0},nth:function(g,h,l){return l[3]-0===h},eq:function(g,h,l){return l[3]-0===h}},filter:{PSEUDO:function(g,h,l,m){var q=h[1],p=n.filters[q];if(p)return p(g,l,h,m);else if(q==="contains")return(g.textContent||g.innerText||a([g])||"").indexOf(h[3])>=0;else if(q==="not"){h=
h[3];l=0;for(m=h.length;l<m;l++)if(h[l]===g)return false;return true}else k.error("Syntax error, unrecognized expression: "+q)},CHILD:function(g,h){var l=h[1],m=g;switch(l){case "only":case "first":for(;m=m.previousSibling;)if(m.nodeType===1)return false;if(l==="first")return true;m=g;case "last":for(;m=m.nextSibling;)if(m.nodeType===1)return false;return true;case "nth":l=h[2];var q=h[3];if(l===1&&q===0)return true;h=h[0];var p=g.parentNode;if(p&&(p.sizcache!==h||!g.nodeIndex)){var v=0;for(m=p.firstChild;m;m=
m.nextSibling)if(m.nodeType===1)m.nodeIndex=++v;p.sizcache=h}g=g.nodeIndex-q;return l===0?g===0:g%l===0&&g/l>=0}},ID:function(g,h){return g.nodeType===1&&g.getAttribute("id")===h},TAG:function(g,h){return h==="*"&&g.nodeType===1||g.nodeName.toLowerCase()===h},CLASS:function(g,h){return(" "+(g.className||g.getAttribute("class"))+" ").indexOf(h)>-1},ATTR:function(g,h){var l=h[1];g=n.attrHandle[l]?n.attrHandle[l](g):g[l]!=null?g[l]:g.getAttribute(l);l=g+"";var m=h[2];h=h[4];return g==null?m==="!=":m===
"="?l===h:m==="*="?l.indexOf(h)>=0:m==="~="?(" "+l+" ").indexOf(h)>=0:!h?l&&g!==false:m==="!="?l!==h:m==="^="?l.indexOf(h)===0:m==="$="?l.substr(l.length-h.length)===h:m==="|="?l===h||l.substr(0,h.length+1)===h+"-":false},POS:function(g,h,l,m){var q=n.setFilters[h[2]];if(q)return q(g,l,h,m)}}},r=n.match.POS;for(var u in n.match){n.match[u]=new RegExp(n.match[u].source+/(?![^\[]*\])(?![^\(]*\))/.source);n.leftMatch[u]=new RegExp(/(^(?:.|\r|\n)*?)/.source+n.match[u].source.replace(/\\(\d+)/g,function(g,
h){return"\\"+(h-0+1)}))}var z=function(g,h){g=Array.prototype.slice.call(g,0);if(h){h.push.apply(h,g);return h}return g};try{Array.prototype.slice.call(s.documentElement.childNodes,0)}catch(C){z=function(g,h){h=h||[];if(j.call(g)==="[object Array]")Array.prototype.push.apply(h,g);else if(typeof g.length==="number")for(var l=0,m=g.length;l<m;l++)h.push(g[l]);else for(l=0;g[l];l++)h.push(g[l]);return h}}var B;if(s.documentElement.compareDocumentPosition)B=function(g,h){if(!g.compareDocumentPosition||
!h.compareDocumentPosition){if(g==h)i=true;return g.compareDocumentPosition?-1:1}g=g.compareDocumentPosition(h)&4?-1:g===h?0:1;if(g===0)i=true;return g};else if("sourceIndex"in s.documentElement)B=function(g,h){if(!g.sourceIndex||!h.sourceIndex){if(g==h)i=true;return g.sourceIndex?-1:1}g=g.sourceIndex-h.sourceIndex;if(g===0)i=true;return g};else if(s.createRange)B=function(g,h){if(!g.ownerDocument||!h.ownerDocument){if(g==h)i=true;return g.ownerDocument?-1:1}var l=g.ownerDocument.createRange(),m=
h.ownerDocument.createRange();l.setStart(g,0);l.setEnd(g,0);m.setStart(h,0);m.setEnd(h,0);g=l.compareBoundaryPoints(Range.START_TO_END,m);if(g===0)i=true;return g};(function(){var g=s.createElement("div"),h="script"+(new Date).getTime();g.innerHTML="<a name='"+h+"'/>";var l=s.documentElement;l.insertBefore(g,l.firstChild);if(s.getElementById(h)){n.find.ID=function(m,q,p){if(typeof q.getElementById!=="undefined"&&!p)return(q=q.getElementById(m[1]))?q.id===m[1]||typeof q.getAttributeNode!=="undefined"&&
q.getAttributeNode("id").nodeValue===m[1]?[q]:w:[]};n.filter.ID=function(m,q){var p=typeof m.getAttributeNode!=="undefined"&&m.getAttributeNode("id");return m.nodeType===1&&p&&p.nodeValue===q}}l.removeChild(g);l=g=null})();(function(){var g=s.createElement("div");g.appendChild(s.createComment(""));if(g.getElementsByTagName("*").length>0)n.find.TAG=function(h,l){l=l.getElementsByTagName(h[1]);if(h[1]==="*"){h=[];for(var m=0;l[m];m++)l[m].nodeType===1&&h.push(l[m]);l=h}return l};g.innerHTML="<a href='#'></a>";
if(g.firstChild&&typeof g.firstChild.getAttribute!=="undefined"&&g.firstChild.getAttribute("href")!=="#")n.attrHandle.href=function(h){return h.getAttribute("href",2)};g=null})();s.querySelectorAll&&function(){var g=k,h=s.createElement("div");h.innerHTML="<p class='TEST'></p>";if(!(h.querySelectorAll&&h.querySelectorAll(".TEST").length===0)){k=function(m,q,p,v){q=q||s;if(!v&&q.nodeType===9&&!x(q))try{return z(q.querySelectorAll(m),p)}catch(t){}return g(m,q,p,v)};for(var l in g)k[l]=g[l];h=null}}();
(function(){var g=s.createElement("div");g.innerHTML="<div class='test e'></div><div class='test'></div>";if(!(!g.getElementsByClassName||g.getElementsByClassName("e").length===0)){g.lastChild.className="e";if(g.getElementsByClassName("e").length!==1){n.order.splice(1,0,"CLASS");n.find.CLASS=function(h,l,m){if(typeof l.getElementsByClassName!=="undefined"&&!m)return l.getElementsByClassName(h[1])};g=null}}})();var E=s.compareDocumentPosition?function(g,h){return!!(g.compareDocumentPosition(h)&16)}:
function(g,h){return g!==h&&(g.contains?g.contains(h):true)},x=function(g){return(g=(g?g.ownerDocument||g:0).documentElement)?g.nodeName!=="HTML":false},ga=function(g,h){var l=[],m="",q;for(h=h.nodeType?[h]:h;q=n.match.PSEUDO.exec(g);){m+=q[0];g=g.replace(n.match.PSEUDO,"")}g=n.relative[g]?g+"*":g;q=0;for(var p=h.length;q<p;q++)k(g,h[q],l);return k.filter(m,l)};c.find=k;c.expr=k.selectors;c.expr[":"]=c.expr.filters;c.unique=k.uniqueSort;c.text=a;c.isXMLDoc=x;c.contains=E})();var eb=/Until$/,fb=/^(?:parents|prevUntil|prevAll)/,
gb=/,/;R=Array.prototype.slice;var Ia=function(a,b,d){if(c.isFunction(b))return c.grep(a,function(e,j){return!!b.call(e,j,e)===d});else if(b.nodeType)return c.grep(a,function(e){return e===b===d});else if(typeof b==="string"){var f=c.grep(a,function(e){return e.nodeType===1});if(Ua.test(b))return c.filter(b,f,!d);else b=c.filter(b,f)}return c.grep(a,function(e){return c.inArray(e,b)>=0===d})};c.fn.extend({find:function(a){for(var b=this.pushStack("","find",a),d=0,f=0,e=this.length;f<e;f++){d=b.length;
c.find(a,this[f],b);if(f>0)for(var j=d;j<b.length;j++)for(var i=0;i<d;i++)if(b[i]===b[j]){b.splice(j--,1);break}}return b},has:function(a){var b=c(a);return this.filter(function(){for(var d=0,f=b.length;d<f;d++)if(c.contains(this,b[d]))return true})},not:function(a){return this.pushStack(Ia(this,a,false),"not",a)},filter:function(a){return this.pushStack(Ia(this,a,true),"filter",a)},is:function(a){return!!a&&c.filter(a,this).length>0},closest:function(a,b){if(c.isArray(a)){var d=[],f=this[0],e,j=
{},i;if(f&&a.length){e=0;for(var o=a.length;e<o;e++){i=a[e];j[i]||(j[i]=c.expr.match.POS.test(i)?c(i,b||this.context):i)}for(;f&&f.ownerDocument&&f!==b;){for(i in j){e=j[i];if(e.jquery?e.index(f)>-1:c(f).is(e)){d.push({selector:i,elem:f});delete j[i]}}f=f.parentNode}}return d}var k=c.expr.match.POS.test(a)?c(a,b||this.context):null;return this.map(function(n,r){for(;r&&r.ownerDocument&&r!==b;){if(k?k.index(r)>-1:c(r).is(a))return r;r=r.parentNode}return null})},index:function(a){if(!a||typeof a===
"string")return c.inArray(this[0],a?c(a):this.parent().children());return c.inArray(a.jquery?a[0]:a,this)},add:function(a,b){a=typeof a==="string"?c(a,b||this.context):c.makeArray(a);b=c.merge(this.get(),a);return this.pushStack(qa(a[0])||qa(b[0])?b:c.unique(b))},andSelf:function(){return this.add(this.prevObject)}});c.each({parent:function(a){return(a=a.parentNode)&&a.nodeType!==11?a:null},parents:function(a){return c.dir(a,"parentNode")},parentsUntil:function(a,b,d){return c.dir(a,"parentNode",
d)},next:function(a){return c.nth(a,2,"nextSibling")},prev:function(a){return c.nth(a,2,"previousSibling")},nextAll:function(a){return c.dir(a,"nextSibling")},prevAll:function(a){return c.dir(a,"previousSibling")},nextUntil:function(a,b,d){return c.dir(a,"nextSibling",d)},prevUntil:function(a,b,d){return c.dir(a,"previousSibling",d)},siblings:function(a){return c.sibling(a.parentNode.firstChild,a)},children:function(a){return c.sibling(a.firstChild)},contents:function(a){return c.nodeName(a,"iframe")?
a.contentDocument||a.contentWindow.document:c.makeArray(a.childNodes)}},function(a,b){c.fn[a]=function(d,f){var e=c.map(this,b,d);eb.test(a)||(f=d);if(f&&typeof f==="string")e=c.filter(f,e);e=this.length>1?c.unique(e):e;if((this.length>1||gb.test(f))&&fb.test(a))e=e.reverse();return this.pushStack(e,a,R.call(arguments).join(","))}});c.extend({filter:function(a,b,d){if(d)a=":not("+a+")";return c.find.matches(a,b)},dir:function(a,b,d){var f=[];for(a=a[b];a&&a.nodeType!==9&&(d===w||a.nodeType!==1||!c(a).is(d));){a.nodeType===
1&&f.push(a);a=a[b]}return f},nth:function(a,b,d){b=b||1;for(var f=0;a;a=a[d])if(a.nodeType===1&&++f===b)break;return a},sibling:function(a,b){for(var d=[];a;a=a.nextSibling)a.nodeType===1&&a!==b&&d.push(a);return d}});var Ja=/ jQuery\d+="(?:\d+|null)"/g,V=/^\s+/,Ka=/(<([\w:]+)[^>]*?)\/>/g,hb=/^(?:area|br|col|embed|hr|img|input|link|meta|param)$/i,La=/<([\w:]+)/,ib=/<tbody/i,jb=/<|&#?\w+;/,ta=/<script|<object|<embed|<option|<style/i,ua=/checked\s*(?:[^=]|=\s*.checked.)/i,Ma=function(a,b,d){return hb.test(d)?
a:b+"></"+d+">"},F={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],area:[1,"<map>","</map>"],_default:[0,"",""]};F.optgroup=F.option;F.tbody=F.tfoot=F.colgroup=F.caption=F.thead;F.th=F.td;if(!c.support.htmlSerialize)F._default=[1,"div<div>","</div>"];c.fn.extend({text:function(a){if(c.isFunction(a))return this.each(function(b){var d=
c(this);d.text(a.call(this,b,d.text()))});if(typeof a!=="object"&&a!==w)return this.empty().append((this[0]&&this[0].ownerDocument||s).createTextNode(a));return c.text(this)},wrapAll:function(a){if(c.isFunction(a))return this.each(function(d){c(this).wrapAll(a.call(this,d))});if(this[0]){var b=c(a,this[0].ownerDocument).eq(0).clone(true);this[0].parentNode&&b.insertBefore(this[0]);b.map(function(){for(var d=this;d.firstChild&&d.firstChild.nodeType===1;)d=d.firstChild;return d}).append(this)}return this},
wrapInner:function(a){if(c.isFunction(a))return this.each(function(b){c(this).wrapInner(a.call(this,b))});return this.each(function(){var b=c(this),d=b.contents();d.length?d.wrapAll(a):b.append(a)})},wrap:function(a){return this.each(function(){c(this).wrapAll(a)})},unwrap:function(){return this.parent().each(function(){c.nodeName(this,"body")||c(this).replaceWith(this.childNodes)}).end()},append:function(){return this.domManip(arguments,true,function(a){this.nodeType===1&&this.appendChild(a)})},
prepend:function(){return this.domManip(arguments,true,function(a){this.nodeType===1&&this.insertBefore(a,this.firstChild)})},before:function(){if(this[0]&&this[0].parentNode)return this.domManip(arguments,false,function(b){this.parentNode.insertBefore(b,this)});else if(arguments.length){var a=c(arguments[0]);a.push.apply(a,this.toArray());return this.pushStack(a,"before",arguments)}},after:function(){if(this[0]&&this[0].parentNode)return this.domManip(arguments,false,function(b){this.parentNode.insertBefore(b,
this.nextSibling)});else if(arguments.length){var a=this.pushStack(this,"after",arguments);a.push.apply(a,c(arguments[0]).toArray());return a}},remove:function(a,b){for(var d=0,f;(f=this[d])!=null;d++)if(!a||c.filter(a,[f]).length){if(!b&&f.nodeType===1){c.cleanData(f.getElementsByTagName("*"));c.cleanData([f])}f.parentNode&&f.parentNode.removeChild(f)}return this},empty:function(){for(var a=0,b;(b=this[a])!=null;a++)for(b.nodeType===1&&c.cleanData(b.getElementsByTagName("*"));b.firstChild;)b.removeChild(b.firstChild);
return this},clone:function(a){var b=this.map(function(){if(!c.support.noCloneEvent&&!c.isXMLDoc(this)){var d=this.outerHTML,f=this.ownerDocument;if(!d){d=f.createElement("div");d.appendChild(this.cloneNode(true));d=d.innerHTML}return c.clean([d.replace(Ja,"").replace(/=([^="'>\s]+\/)>/g,'="$1">').replace(V,"")],f)[0]}else return this.cloneNode(true)});if(a===true){ra(this,b);ra(this.find("*"),b.find("*"))}return b},html:function(a){if(a===w)return this[0]&&this[0].nodeType===1?this[0].innerHTML.replace(Ja,
""):null;else if(typeof a==="string"&&!ta.test(a)&&(c.support.leadingWhitespace||!V.test(a))&&!F[(La.exec(a)||["",""])[1].toLowerCase()]){a=a.replace(Ka,Ma);try{for(var b=0,d=this.length;b<d;b++)if(this[b].nodeType===1){c.cleanData(this[b].getElementsByTagName("*"));this[b].innerHTML=a}}catch(f){this.empty().append(a)}}else c.isFunction(a)?this.each(function(e){var j=c(this),i=j.html();j.empty().append(function(){return a.call(this,e,i)})}):this.empty().append(a);return this},replaceWith:function(a){if(this[0]&&
this[0].parentNode){if(c.isFunction(a))return this.each(function(b){var d=c(this),f=d.html();d.replaceWith(a.call(this,b,f))});if(typeof a!=="string")a=c(a).detach();return this.each(function(){var b=this.nextSibling,d=this.parentNode;c(this).remove();b?c(b).before(a):c(d).append(a)})}else return this.pushStack(c(c.isFunction(a)?a():a),"replaceWith",a)},detach:function(a){return this.remove(a,true)},domManip:function(a,b,d){function f(u){return c.nodeName(u,"table")?u.getElementsByTagName("tbody")[0]||
u.appendChild(u.ownerDocument.createElement("tbody")):u}var e,j,i=a[0],o=[],k;if(!c.support.checkClone&&arguments.length===3&&typeof i==="string"&&ua.test(i))return this.each(function(){c(this).domManip(a,b,d,true)});if(c.isFunction(i))return this.each(function(u){var z=c(this);a[0]=i.call(this,u,b?z.html():w);z.domManip(a,b,d)});if(this[0]){e=i&&i.parentNode;e=c.support.parentNode&&e&&e.nodeType===11&&e.childNodes.length===this.length?{fragment:e}:sa(a,this,o);k=e.fragment;if(j=k.childNodes.length===
1?(k=k.firstChild):k.firstChild){b=b&&c.nodeName(j,"tr");for(var n=0,r=this.length;n<r;n++)d.call(b?f(this[n],j):this[n],n>0||e.cacheable||this.length>1?k.cloneNode(true):k)}o.length&&c.each(o,Qa)}return this}});c.fragments={};c.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){c.fn[a]=function(d){var f=[];d=c(d);var e=this.length===1&&this[0].parentNode;if(e&&e.nodeType===11&&e.childNodes.length===1&&d.length===1){d[b](this[0]);
return this}else{e=0;for(var j=d.length;e<j;e++){var i=(e>0?this.clone(true):this).get();c.fn[b].apply(c(d[e]),i);f=f.concat(i)}return this.pushStack(f,a,d.selector)}}});c.extend({clean:function(a,b,d,f){b=b||s;if(typeof b.createElement==="undefined")b=b.ownerDocument||b[0]&&b[0].ownerDocument||s;for(var e=[],j=0,i;(i=a[j])!=null;j++){if(typeof i==="number")i+="";if(i){if(typeof i==="string"&&!jb.test(i))i=b.createTextNode(i);else if(typeof i==="string"){i=i.replace(Ka,Ma);var o=(La.exec(i)||["",
""])[1].toLowerCase(),k=F[o]||F._default,n=k[0],r=b.createElement("div");for(r.innerHTML=k[1]+i+k[2];n--;)r=r.lastChild;if(!c.support.tbody){n=ib.test(i);o=o==="table"&&!n?r.firstChild&&r.firstChild.childNodes:k[1]==="<table>"&&!n?r.childNodes:[];for(k=o.length-1;k>=0;--k)c.nodeName(o[k],"tbody")&&!o[k].childNodes.length&&o[k].parentNode.removeChild(o[k])}!c.support.leadingWhitespace&&V.test(i)&&r.insertBefore(b.createTextNode(V.exec(i)[0]),r.firstChild);i=r.childNodes}if(i.nodeType)e.push(i);else e=
c.merge(e,i)}}if(d)for(j=0;e[j];j++)if(f&&c.nodeName(e[j],"script")&&(!e[j].type||e[j].type.toLowerCase()==="text/javascript"))f.push(e[j].parentNode?e[j].parentNode.removeChild(e[j]):e[j]);else{e[j].nodeType===1&&e.splice.apply(e,[j+1,0].concat(c.makeArray(e[j].getElementsByTagName("script"))));d.appendChild(e[j])}return e},cleanData:function(a){for(var b,d,f=c.cache,e=c.event.special,j=c.support.deleteExpando,i=0,o;(o=a[i])!=null;i++)if(d=o[c.expando]){b=f[d];if(b.events)for(var k in b.events)e[k]?
c.event.remove(o,k):Ca(o,k,b.handle);if(j)delete o[c.expando];else o.removeAttribute&&o.removeAttribute(c.expando);delete f[d]}}});var kb=/z-?index|font-?weight|opacity|zoom|line-?height/i,Na=/alpha\([^)]*\)/,Oa=/opacity=([^)]*)/,ha=/float/i,ia=/-([a-z])/ig,lb=/([A-Z])/g,mb=/^-?\d+(?:px)?$/i,nb=/^-?\d/,ob={position:"absolute",visibility:"hidden",display:"block"},pb=["Left","Right"],qb=["Top","Bottom"],rb=s.defaultView&&s.defaultView.getComputedStyle,Pa=c.support.cssFloat?"cssFloat":"styleFloat",ja=
function(a,b){return b.toUpperCase()};c.fn.css=function(a,b){return X(this,a,b,true,function(d,f,e){if(e===w)return c.curCSS(d,f);if(typeof e==="number"&&!kb.test(f))e+="px";c.style(d,f,e)})};c.extend({style:function(a,b,d){if(!a||a.nodeType===3||a.nodeType===8)return w;if((b==="width"||b==="height")&&parseFloat(d)<0)d=w;var f=a.style||a,e=d!==w;if(!c.support.opacity&&b==="opacity"){if(e){f.zoom=1;b=parseInt(d,10)+""==="NaN"?"":"alpha(opacity="+d*100+")";a=f.filter||c.curCSS(a,"filter")||"";f.filter=
Na.test(a)?a.replace(Na,b):b}return f.filter&&f.filter.indexOf("opacity=")>=0?parseFloat(Oa.exec(f.filter)[1])/100+"":""}if(ha.test(b))b=Pa;b=b.replace(ia,ja);if(e)f[b]=d;return f[b]},css:function(a,b,d,f){if(b==="width"||b==="height"){var e,j=b==="width"?pb:qb;function i(){e=b==="width"?a.offsetWidth:a.offsetHeight;f!=="border"&&c.each(j,function(){f||(e-=parseFloat(c.curCSS(a,"padding"+this,true))||0);if(f==="margin")e+=parseFloat(c.curCSS(a,"margin"+this,true))||0;else e-=parseFloat(c.curCSS(a,
"border"+this+"Width",true))||0})}a.offsetWidth!==0?i():c.swap(a,ob,i);return Math.max(0,Math.round(e))}return c.curCSS(a,b,d)},curCSS:function(a,b,d){var f,e=a.style;if(!c.support.opacity&&b==="opacity"&&a.currentStyle){f=Oa.test(a.currentStyle.filter||"")?parseFloat(RegExp.$1)/100+"":"";return f===""?"1":f}if(ha.test(b))b=Pa;if(!d&&e&&e[b])f=e[b];else if(rb){if(ha.test(b))b="float";b=b.replace(lb,"-$1").toLowerCase();e=a.ownerDocument.defaultView;if(!e)return null;if(a=e.getComputedStyle(a,null))f=
a.getPropertyValue(b);if(b==="opacity"&&f==="")f="1"}else if(a.currentStyle){d=b.replace(ia,ja);f=a.currentStyle[b]||a.currentStyle[d];if(!mb.test(f)&&nb.test(f)){b=e.left;var j=a.runtimeStyle.left;a.runtimeStyle.left=a.currentStyle.left;e.left=d==="fontSize"?"1em":f||0;f=e.pixelLeft+"px";e.left=b;a.runtimeStyle.left=j}}return f},swap:function(a,b,d){var f={};for(var e in b){f[e]=a.style[e];a.style[e]=b[e]}d.call(a);for(e in b)a.style[e]=f[e]}});if(c.expr&&c.expr.filters){c.expr.filters.hidden=function(a){var b=
a.offsetWidth,d=a.offsetHeight,f=a.nodeName.toLowerCase()==="tr";return b===0&&d===0&&!f?true:b>0&&d>0&&!f?false:c.curCSS(a,"display")==="none"};c.expr.filters.visible=function(a){return!c.expr.filters.hidden(a)}}var sb=J(),tb=/<script(.|\s)*?\/script>/gi,ub=/select|textarea/i,vb=/color|date|datetime|email|hidden|month|number|password|range|search|tel|text|time|url|week/i,N=/=\?(&|$)/,ka=/\?/,wb=/(\?|&)_=.*?(&|$)/,xb=/^(\w+:)?\/\/([^\/?#]+)/,yb=/%20/g,zb=c.fn.load;c.fn.extend({load:function(a,b,d){if(typeof a!==
"string")return zb.call(this,a);else if(!this.length)return this;var f=a.indexOf(" ");if(f>=0){var e=a.slice(f,a.length);a=a.slice(0,f)}f="GET";if(b)if(c.isFunction(b)){d=b;b=null}else if(typeof b==="object"){b=c.param(b,c.ajaxSettings.traditional);f="POST"}var j=this;c.ajax({url:a,type:f,dataType:"html",data:b,complete:function(i,o){if(o==="success"||o==="notmodified")j.html(e?c("<div />").append(i.responseText.replace(tb,"")).find(e):i.responseText);d&&j.each(d,[i.responseText,o,i])}});return this},
serialize:function(){return c.param(this.serializeArray())},serializeArray:function(){return this.map(function(){return this.elements?c.makeArray(this.elements):this}).filter(function(){return this.name&&!this.disabled&&(this.checked||ub.test(this.nodeName)||vb.test(this.type))}).map(function(a,b){a=c(this).val();return a==null?null:c.isArray(a)?c.map(a,function(d){return{name:b.name,value:d}}):{name:b.name,value:a}}).get()}});c.each("ajaxStart ajaxStop ajaxComplete ajaxError ajaxSuccess ajaxSend".split(" "),
function(a,b){c.fn[b]=function(d){return this.bind(b,d)}});c.extend({get:function(a,b,d,f){if(c.isFunction(b)){f=f||d;d=b;b=null}return c.ajax({type:"GET",url:a,data:b,success:d,dataType:f})},getScript:function(a,b){return c.get(a,null,b,"script")},getJSON:function(a,b,d){return c.get(a,b,d,"json")},post:function(a,b,d,f){if(c.isFunction(b)){f=f||d;d=b;b={}}return c.ajax({type:"POST",url:a,data:b,success:d,dataType:f})},ajaxSetup:function(a){c.extend(c.ajaxSettings,a)},ajaxSettings:{url:location.href,
global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:A.XMLHttpRequest&&(A.location.protocol!=="file:"||!A.ActiveXObject)?function(){return new A.XMLHttpRequest}:function(){try{return new A.ActiveXObject("Microsoft.XMLHTTP")}catch(a){}},accepts:{xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"}},lastModified:{},etag:{},ajax:function(a){function b(){e.success&&
e.success.call(k,o,i,x);e.global&&f("ajaxSuccess",[x,e])}function d(){e.complete&&e.complete.call(k,x,i);e.global&&f("ajaxComplete",[x,e]);e.global&&!--c.active&&c.event.trigger("ajaxStop")}function f(q,p){(e.context?c(e.context):c.event).trigger(q,p)}var e=c.extend(true,{},c.ajaxSettings,a),j,i,o,k=a&&a.context||e,n=e.type.toUpperCase();if(e.data&&e.processData&&typeof e.data!=="string")e.data=c.param(e.data,e.traditional);if(e.dataType==="jsonp"){if(n==="GET")N.test(e.url)||(e.url+=(ka.test(e.url)?
"&":"?")+(e.jsonp||"callback")+"=?");else if(!e.data||!N.test(e.data))e.data=(e.data?e.data+"&":"")+(e.jsonp||"callback")+"=?";e.dataType="json"}if(e.dataType==="json"&&(e.data&&N.test(e.data)||N.test(e.url))){j=e.jsonpCallback||"jsonp"+sb++;if(e.data)e.data=(e.data+"").replace(N,"="+j+"$1");e.url=e.url.replace(N,"="+j+"$1");e.dataType="script";A[j]=A[j]||function(q){o=q;b();d();A[j]=w;try{delete A[j]}catch(p){}z&&z.removeChild(C)}}if(e.dataType==="script"&&e.cache===null)e.cache=false;if(e.cache===
false&&n==="GET"){var r=J(),u=e.url.replace(wb,"$1_="+r+"$2");e.url=u+(u===e.url?(ka.test(e.url)?"&":"?")+"_="+r:"")}if(e.data&&n==="GET")e.url+=(ka.test(e.url)?"&":"?")+e.data;e.global&&!c.active++&&c.event.trigger("ajaxStart");r=(r=xb.exec(e.url))&&(r[1]&&r[1]!==location.protocol||r[2]!==location.host);if(e.dataType==="script"&&n==="GET"&&r){var z=s.getElementsByTagName("head")[0]||s.documentElement,C=s.createElement("script");C.src=e.url;if(e.scriptCharset)C.charset=e.scriptCharset;if(!j){var B=
false;C.onload=C.onreadystatechange=function(){if(!B&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){B=true;b();d();C.onload=C.onreadystatechange=null;z&&C.parentNode&&z.removeChild(C)}}}z.insertBefore(C,z.firstChild);return w}var E=false,x=e.xhr();if(x){e.username?x.open(n,e.url,e.async,e.username,e.password):x.open(n,e.url,e.async);try{if(e.data||a&&a.contentType)x.setRequestHeader("Content-Type",e.contentType);if(e.ifModified){c.lastModified[e.url]&&x.setRequestHeader("If-Modified-Since",
c.lastModified[e.url]);c.etag[e.url]&&x.setRequestHeader("If-None-Match",c.etag[e.url])}r||x.setRequestHeader("X-Requested-With","XMLHttpRequest");x.setRequestHeader("Accept",e.dataType&&e.accepts[e.dataType]?e.accepts[e.dataType]+", */*":e.accepts._default)}catch(ga){}if(e.beforeSend&&e.beforeSend.call(k,x,e)===false){e.global&&!--c.active&&c.event.trigger("ajaxStop");x.abort();return false}e.global&&f("ajaxSend",[x,e]);var g=x.onreadystatechange=function(q){if(!x||x.readyState===0||q==="abort"){E||
d();E=true;if(x)x.onreadystatechange=c.noop}else if(!E&&x&&(x.readyState===4||q==="timeout")){E=true;x.onreadystatechange=c.noop;i=q==="timeout"?"timeout":!c.httpSuccess(x)?"error":e.ifModified&&c.httpNotModified(x,e.url)?"notmodified":"success";var p;if(i==="success")try{o=c.httpData(x,e.dataType,e)}catch(v){i="parsererror";p=v}if(i==="success"||i==="notmodified")j||b();else c.handleError(e,x,i,p);d();q==="timeout"&&x.abort();if(e.async)x=null}};try{var h=x.abort;x.abort=function(){x&&h.call(x);
g("abort")}}catch(l){}e.async&&e.timeout>0&&setTimeout(function(){x&&!E&&g("timeout")},e.timeout);try{x.send(n==="POST"||n==="PUT"||n==="DELETE"?e.data:null)}catch(m){c.handleError(e,x,null,m);d()}e.async||g();return x}},handleError:function(a,b,d,f){if(a.error)a.error.call(a.context||a,b,d,f);if(a.global)(a.context?c(a.context):c.event).trigger("ajaxError",[b,a,f])},active:0,httpSuccess:function(a){try{return!a.status&&location.protocol==="file:"||a.status>=200&&a.status<300||a.status===304||a.status===
1223||a.status===0}catch(b){}return false},httpNotModified:function(a,b){var d=a.getResponseHeader("Last-Modified"),f=a.getResponseHeader("Etag");if(d)c.lastModified[b]=d;if(f)c.etag[b]=f;return a.status===304||a.status===0},httpData:function(a,b,d){var f=a.getResponseHeader("content-type")||"",e=b==="xml"||!b&&f.indexOf("xml")>=0;a=e?a.responseXML:a.responseText;e&&a.documentElement.nodeName==="parsererror"&&c.error("parsererror");if(d&&d.dataFilter)a=d.dataFilter(a,b);if(typeof a==="string")if(b===
"json"||!b&&f.indexOf("json")>=0)a=c.parseJSON(a);else if(b==="script"||!b&&f.indexOf("javascript")>=0)c.globalEval(a);return a},param:function(a,b){function d(i,o){if(c.isArray(o))c.each(o,function(k,n){b||/\[\]$/.test(i)?f(i,n):d(i+"["+(typeof n==="object"||c.isArray(n)?k:"")+"]",n)});else!b&&o!=null&&typeof o==="object"?c.each(o,function(k,n){d(i+"["+k+"]",n)}):f(i,o)}function f(i,o){o=c.isFunction(o)?o():o;e[e.length]=encodeURIComponent(i)+"="+encodeURIComponent(o)}var e=[];if(b===w)b=c.ajaxSettings.traditional;
if(c.isArray(a)||a.jquery)c.each(a,function(){f(this.name,this.value)});else for(var j in a)d(j,a[j]);return e.join("&").replace(yb,"+")}});var la={},Ab=/toggle|show|hide/,Bb=/^([+-]=)?([\d+-.]+)(.*)$/,W,va=[["height","marginTop","marginBottom","paddingTop","paddingBottom"],["width","marginLeft","marginRight","paddingLeft","paddingRight"],["opacity"]];c.fn.extend({show:function(a,b){if(a||a===0)return this.animate(K("show",3),a,b);else{a=0;for(b=this.length;a<b;a++){var d=c.data(this[a],"olddisplay");
this[a].style.display=d||"";if(c.css(this[a],"display")==="none"){d=this[a].nodeName;var f;if(la[d])f=la[d];else{var e=c("<"+d+" />").appendTo("body");f=e.css("display");if(f==="none")f="block";e.remove();la[d]=f}c.data(this[a],"olddisplay",f)}}a=0;for(b=this.length;a<b;a++)this[a].style.display=c.data(this[a],"olddisplay")||"";return this}},hide:function(a,b){if(a||a===0)return this.animate(K("hide",3),a,b);else{a=0;for(b=this.length;a<b;a++){var d=c.data(this[a],"olddisplay");!d&&d!=="none"&&c.data(this[a],
"olddisplay",c.css(this[a],"display"))}a=0;for(b=this.length;a<b;a++)this[a].style.display="none";return this}},_toggle:c.fn.toggle,toggle:function(a,b){var d=typeof a==="boolean";if(c.isFunction(a)&&c.isFunction(b))this._toggle.apply(this,arguments);else a==null||d?this.each(function(){var f=d?a:c(this).is(":hidden");c(this)[f?"show":"hide"]()}):this.animate(K("toggle",3),a,b);return this},fadeTo:function(a,b,d){return this.filter(":hidden").css("opacity",0).show().end().animate({opacity:b},a,d)},
animate:function(a,b,d,f){var e=c.speed(b,d,f);if(c.isEmptyObject(a))return this.each(e.complete);return this[e.queue===false?"each":"queue"](function(){var j=c.extend({},e),i,o=this.nodeType===1&&c(this).is(":hidden"),k=this;for(i in a){var n=i.replace(ia,ja);if(i!==n){a[n]=a[i];delete a[i];i=n}if(a[i]==="hide"&&o||a[i]==="show"&&!o)return j.complete.call(this);if((i==="height"||i==="width")&&this.style){j.display=c.css(this,"display");j.overflow=this.style.overflow}if(c.isArray(a[i])){(j.specialEasing=
j.specialEasing||{})[i]=a[i][1];a[i]=a[i][0]}}if(j.overflow!=null)this.style.overflow="hidden";j.curAnim=c.extend({},a);c.each(a,function(r,u){var z=new c.fx(k,j,r);if(Ab.test(u))z[u==="toggle"?o?"show":"hide":u](a);else{var C=Bb.exec(u),B=z.cur(true)||0;if(C){u=parseFloat(C[2]);var E=C[3]||"px";if(E!=="px"){k.style[r]=(u||1)+E;B=(u||1)/z.cur(true)*B;k.style[r]=B+E}if(C[1])u=(C[1]==="-="?-1:1)*u+B;z.custom(B,u,E)}else z.custom(B,u,"")}});return true})},stop:function(a,b){var d=c.timers;a&&this.queue([]);
this.each(function(){for(var f=d.length-1;f>=0;f--)if(d[f].elem===this){b&&d[f](true);d.splice(f,1)}});b||this.dequeue();return this}});c.each({slideDown:K("show",1),slideUp:K("hide",1),slideToggle:K("toggle",1),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"}},function(a,b){c.fn[a]=function(d,f){return this.animate(b,d,f)}});c.extend({speed:function(a,b,d){var f=a&&typeof a==="object"?a:{complete:d||!d&&b||c.isFunction(a)&&a,duration:a,easing:d&&b||b&&!c.isFunction(b)&&b};f.duration=c.fx.off?0:typeof f.duration===
"number"?f.duration:c.fx.speeds[f.duration]||c.fx.speeds._default;f.old=f.complete;f.complete=function(){f.queue!==false&&c(this).dequeue();c.isFunction(f.old)&&f.old.call(this)};return f},easing:{linear:function(a,b,d,f){return d+f*a},swing:function(a,b,d,f){return(-Math.cos(a*Math.PI)/2+0.5)*f+d}},timers:[],fx:function(a,b,d){this.options=b;this.elem=a;this.prop=d;if(!b.orig)b.orig={}}});c.fx.prototype={update:function(){this.options.step&&this.options.step.call(this.elem,this.now,this);(c.fx.step[this.prop]||
c.fx.step._default)(this);if((this.prop==="height"||this.prop==="width")&&this.elem.style)this.elem.style.display="block"},cur:function(a){if(this.elem[this.prop]!=null&&(!this.elem.style||this.elem.style[this.prop]==null))return this.elem[this.prop];return(a=parseFloat(c.css(this.elem,this.prop,a)))&&a>-10000?a:parseFloat(c.curCSS(this.elem,this.prop))||0},custom:function(a,b,d){function f(j){return e.step(j)}this.startTime=J();this.start=a;this.end=b;this.unit=d||this.unit||"px";this.now=this.start;
this.pos=this.state=0;var e=this;f.elem=this.elem;if(f()&&c.timers.push(f)&&!W)W=setInterval(c.fx.tick,13)},show:function(){this.options.orig[this.prop]=c.style(this.elem,this.prop);this.options.show=true;this.custom(this.prop==="width"||this.prop==="height"?1:0,this.cur());c(this.elem).show()},hide:function(){this.options.orig[this.prop]=c.style(this.elem,this.prop);this.options.hide=true;this.custom(this.cur(),0)},step:function(a){var b=J(),d=true;if(a||b>=this.options.duration+this.startTime){this.now=
this.end;this.pos=this.state=1;this.update();this.options.curAnim[this.prop]=true;for(var f in this.options.curAnim)if(this.options.curAnim[f]!==true)d=false;if(d){if(this.options.display!=null){this.elem.style.overflow=this.options.overflow;a=c.data(this.elem,"olddisplay");this.elem.style.display=a?a:this.options.display;if(c.css(this.elem,"display")==="none")this.elem.style.display="block"}this.options.hide&&c(this.elem).hide();if(this.options.hide||this.options.show)for(var e in this.options.curAnim)c.style(this.elem,
e,this.options.orig[e]);this.options.complete.call(this.elem)}return false}else{e=b-this.startTime;this.state=e/this.options.duration;a=this.options.easing||(c.easing.swing?"swing":"linear");this.pos=c.easing[this.options.specialEasing&&this.options.specialEasing[this.prop]||a](this.state,e,0,1,this.options.duration);this.now=this.start+(this.end-this.start)*this.pos;this.update()}return true}};c.extend(c.fx,{tick:function(){for(var a=c.timers,b=0;b<a.length;b++)a[b]()||a.splice(b--,1);a.length||
c.fx.stop()},stop:function(){clearInterval(W);W=null},speeds:{slow:600,fast:200,_default:400},step:{opacity:function(a){c.style(a.elem,"opacity",a.now)},_default:function(a){if(a.elem.style&&a.elem.style[a.prop]!=null)a.elem.style[a.prop]=(a.prop==="width"||a.prop==="height"?Math.max(0,a.now):a.now)+a.unit;else a.elem[a.prop]=a.now}}});if(c.expr&&c.expr.filters)c.expr.filters.animated=function(a){return c.grep(c.timers,function(b){return a===b.elem}).length};c.fn.offset="getBoundingClientRect"in s.documentElement?
function(a){var b=this[0];if(a)return this.each(function(e){c.offset.setOffset(this,a,e)});if(!b||!b.ownerDocument)return null;if(b===b.ownerDocument.body)return c.offset.bodyOffset(b);var d=b.getBoundingClientRect(),f=b.ownerDocument;b=f.body;f=f.documentElement;return{top:d.top+(self.pageYOffset||c.support.boxModel&&f.scrollTop||b.scrollTop)-(f.clientTop||b.clientTop||0),left:d.left+(self.pageXOffset||c.support.boxModel&&f.scrollLeft||b.scrollLeft)-(f.clientLeft||b.clientLeft||0)}}:function(a){var b=
this[0];if(a)return this.each(function(r){c.offset.setOffset(this,a,r)});if(!b||!b.ownerDocument)return null;if(b===b.ownerDocument.body)return c.offset.bodyOffset(b);c.offset.initialize();var d=b.offsetParent,f=b,e=b.ownerDocument,j,i=e.documentElement,o=e.body;f=(e=e.defaultView)?e.getComputedStyle(b,null):b.currentStyle;for(var k=b.offsetTop,n=b.offsetLeft;(b=b.parentNode)&&b!==o&&b!==i;){if(c.offset.supportsFixedPosition&&f.position==="fixed")break;j=e?e.getComputedStyle(b,null):b.currentStyle;
k-=b.scrollTop;n-=b.scrollLeft;if(b===d){k+=b.offsetTop;n+=b.offsetLeft;if(c.offset.doesNotAddBorder&&!(c.offset.doesAddBorderForTableAndCells&&/^t(able|d|h)$/i.test(b.nodeName))){k+=parseFloat(j.borderTopWidth)||0;n+=parseFloat(j.borderLeftWidth)||0}f=d;d=b.offsetParent}if(c.offset.subtractsBorderForOverflowNotVisible&&j.overflow!=="visible"){k+=parseFloat(j.borderTopWidth)||0;n+=parseFloat(j.borderLeftWidth)||0}f=j}if(f.position==="relative"||f.position==="static"){k+=o.offsetTop;n+=o.offsetLeft}if(c.offset.supportsFixedPosition&&
f.position==="fixed"){k+=Math.max(i.scrollTop,o.scrollTop);n+=Math.max(i.scrollLeft,o.scrollLeft)}return{top:k,left:n}};c.offset={initialize:function(){var a=s.body,b=s.createElement("div"),d,f,e,j=parseFloat(c.curCSS(a,"marginTop",true))||0;c.extend(b.style,{position:"absolute",top:0,left:0,margin:0,border:0,width:"1px",height:"1px",visibility:"hidden"});b.innerHTML="<div style='position:absolute;top:0;left:0;margin:0;border:5px solid #000;padding:0;width:1px;height:1px;'><div></div></div><table style='position:absolute;top:0;left:0;margin:0;border:5px solid #000;padding:0;width:1px;height:1px;' cellpadding='0' cellspacing='0'><tr><td></td></tr></table>";
a.insertBefore(b,a.firstChild);d=b.firstChild;f=d.firstChild;e=d.nextSibling.firstChild.firstChild;this.doesNotAddBorder=f.offsetTop!==5;this.doesAddBorderForTableAndCells=e.offsetTop===5;f.style.position="fixed";f.style.top="20px";this.supportsFixedPosition=f.offsetTop===20||f.offsetTop===15;f.style.position=f.style.top="";d.style.overflow="hidden";d.style.position="relative";this.subtractsBorderForOverflowNotVisible=f.offsetTop===-5;this.doesNotIncludeMarginInBodyOffset=a.offsetTop!==j;a.removeChild(b);
c.offset.initialize=c.noop},bodyOffset:function(a){var b=a.offsetTop,d=a.offsetLeft;c.offset.initialize();if(c.offset.doesNotIncludeMarginInBodyOffset){b+=parseFloat(c.curCSS(a,"marginTop",true))||0;d+=parseFloat(c.curCSS(a,"marginLeft",true))||0}return{top:b,left:d}},setOffset:function(a,b,d){if(/static/.test(c.curCSS(a,"position")))a.style.position="relative";var f=c(a),e=f.offset(),j=parseInt(c.curCSS(a,"top",true),10)||0,i=parseInt(c.curCSS(a,"left",true),10)||0;if(c.isFunction(b))b=b.call(a,
d,e);d={top:b.top-e.top+j,left:b.left-e.left+i};"using"in b?b.using.call(a,d):f.css(d)}};c.fn.extend({position:function(){if(!this[0])return null;var a=this[0],b=this.offsetParent(),d=this.offset(),f=/^body|html$/i.test(b[0].nodeName)?{top:0,left:0}:b.offset();d.top-=parseFloat(c.curCSS(a,"marginTop",true))||0;d.left-=parseFloat(c.curCSS(a,"marginLeft",true))||0;f.top+=parseFloat(c.curCSS(b[0],"borderTopWidth",true))||0;f.left+=parseFloat(c.curCSS(b[0],"borderLeftWidth",true))||0;return{top:d.top-
f.top,left:d.left-f.left}},offsetParent:function(){return this.map(function(){for(var a=this.offsetParent||s.body;a&&!/^body|html$/i.test(a.nodeName)&&c.css(a,"position")==="static";)a=a.offsetParent;return a})}});c.each(["Left","Top"],function(a,b){var d="scroll"+b;c.fn[d]=function(f){var e=this[0],j;if(!e)return null;if(f!==w)return this.each(function(){if(j=wa(this))j.scrollTo(!a?f:c(j).scrollLeft(),a?f:c(j).scrollTop());else this[d]=f});else return(j=wa(e))?"pageXOffset"in j?j[a?"pageYOffset":
"pageXOffset"]:c.support.boxModel&&j.document.documentElement[d]||j.document.body[d]:e[d]}});c.each(["Height","Width"],function(a,b){var d=b.toLowerCase();c.fn["inner"+b]=function(){return this[0]?c.css(this[0],d,false,"padding"):null};c.fn["outer"+b]=function(f){return this[0]?c.css(this[0],d,false,f?"margin":"border"):null};c.fn[d]=function(f){var e=this[0];if(!e)return f==null?null:this;if(c.isFunction(f))return this.each(function(j){var i=c(this);i[d](f.call(this,j,i[d]()))});return"scrollTo"in
e&&e.document?e.document.compatMode==="CSS1Compat"&&e.document.documentElement["client"+b]||e.document.body["client"+b]:e.nodeType===9?Math.max(e.documentElement["client"+b],e.body["scroll"+b],e.documentElement["scroll"+b],e.body["offset"+b],e.documentElement["offset"+b]):f===w?c.css(e,d):this.css(d,typeof f==="string"?f:f+"px")}});A.jQuery=A.$=c})(window);

/* Copyright (c) 2006 Brandon Aaron (http://brandonaaron.net)
 * Dual licensed under the MIT (http://www.opensource.org/licenses/mit-license.php)
 * and GPL (http://www.opensource.org/licenses/gpl-license.php) licenses.
 *
 * $LastChangedDate: 2007-07-21 18:45:56 -0500 (Sat, 21 Jul 2007) $
 * $Rev: 2447 $
 *
 * Version 2.1.1
 */
(function($){$.fn.bgIframe=$.fn.bgiframe=function(s){if($.browser.msie&&/6.0/.test(navigator.userAgent)){s=$.extend({top:'auto',left:'auto',width:'auto',height:'auto',opacity:true,src:'javascript:false;'},s||{});var prop=function(n){return n&&n.constructor==Number?n+'px':n;},html='<iframe class="bgiframe"frameborder="0"tabindex="-1"src="'+s.src+'"'+'style="display:block;position:absolute;z-index:-1;'+(s.opacity!==false?'filter:Alpha(Opacity=\'0\');':'')+'top:'+(s.top=='auto'?'expression(((parseInt(this.parentNode.currentStyle.borderTopWidth)||0)*-1)+\'px\')':prop(s.top))+';'+'left:'+(s.left=='auto'?'expression(((parseInt(this.parentNode.currentStyle.borderLeftWidth)||0)*-1)+\'px\')':prop(s.left))+';'+'width:'+(s.width=='auto'?'expression(this.parentNode.offsetWidth+\'px\')':prop(s.width))+';'+'height:'+(s.height=='auto'?'expression(this.parentNode.offsetHeight+\'px\')':prop(s.height))+';'+'"/>';return this.each(function(){if($('> iframe.bgiframe',this).length==0)this.insertBefore(document.createElement(html),this.firstChild);});}return this;};})(jQuery);

/**
This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

/**
 * (C) 2008 Syronex / J.M. Rosengard
 * http://www.syronex.com/software/jquery-color-picker
 *
 * - Check mark is either black or white, depending on the darkness 
 *   of the color selected.
 * - Fixed a bug in the original plugin that led to problems when there is 
 *   more than one colorPicker in a document.
 *
 * This is based on: 
 *
 * jQuery colorSelect plugin 0.9
 * http://plugins.jquery.com/project/colorPickerAgain
 * Copyright (c) 2008 Otaku RzO (Renzo Galo Castro Jurado).
 * (Original author URL & domain name no longer available.)
 *
 */


(function(a){a.fn.colorPicker=function(j){var h=a.extend({},{color:new Array("#FFFFFF","#EEEEEE","#FFFF88","#FF7400","#CDEB8B","#6BBA70","#006E2E","#C3D9FF","#4096EE","#356AA0","#FF0096","#B02B2C","#000000"),defaultColor:0,columns:0,click:function(){}},j);return this.each(function(){var d=a(this),b=a.meta?a.extend({},h,d.data()):h,c=typeof b.defaultColor=="number"?b.defaultColor:-1,e="";for(i=0;i<b.color.length;i++){e+='<div style="background-color:'+b.color[i]+';"></div>';if(c==-1&&b.defaultColor==
b.color[i])c=i}d.html('<div class="jColorSelect">'+e+"</div>");var g=d.children(".jColorSelect").children("div");e=17*(b.columns>0?b.columns:b.color.length);d.children(".jColorSelect").css("width",e);g.each(function(f){a(this).click(function(){if(c!=f){if(c>-1){cell=g.eq(c);cell.hasClass("check")&&cell.removeClass("check").removeClass("checkwht").removeClass("checkblk")}c=f;a(this).addClass("check").addClass(isdark(b.color[f])?"checkwht":"checkblk");b.click(b.color[f])}})});_tmp=c;c=-1;g.eq(_tmp).trigger("click")})}})(jQuery);
function isdark(a){a=parseInt(a.substr(1),16);return(a>>>16)+(a>>>8&255)+(a&255)<500};




var SWFUpload;SWFUpload==void 0&&(SWFUpload=function(a){this.initSWFUpload(a)});SWFUpload.prototype.initSWFUpload=function(a){try{this.customSettings={},this.settings=a,this.eventQueue=[],this.movieName="SWFUpload_"+SWFUpload.movieCount++,this.movieElement=null,SWFUpload.instances[this.movieName]=this,this.initSettings(),this.loadFlash(),this.displayDebugInfo()}catch(b){throw delete SWFUpload.instances[this.movieName],b;}};SWFUpload.instances={};SWFUpload.movieCount=0;SWFUpload.version="2.2.0 2009-03-25";
SWFUpload.QUEUE_ERROR={QUEUE_LIMIT_EXCEEDED:-100,FILE_EXCEEDS_SIZE_LIMIT:-110,ZERO_BYTE_FILE:-120,INVALID_FILETYPE:-130};SWFUpload.UPLOAD_ERROR={HTTP_ERROR:-200,MISSING_UPLOAD_URL:-210,IO_ERROR:-220,SECURITY_ERROR:-230,UPLOAD_LIMIT_EXCEEDED:-240,UPLOAD_FAILED:-250,SPECIFIED_FILE_ID_NOT_FOUND:-260,FILE_VALIDATION_FAILED:-270,FILE_CANCELLED:-280,UPLOAD_STOPPED:-290};SWFUpload.FILE_STATUS={QUEUED:-1,IN_PROGRESS:-2,ERROR:-3,COMPLETE:-4,CANCELLED:-5};
SWFUpload.BUTTON_ACTION={SELECT_FILE:-100,SELECT_FILES:-110,START_UPLOAD:-120};SWFUpload.CURSOR={ARROW:-1,HAND:-2};SWFUpload.WINDOW_MODE={WINDOW:"window",TRANSPARENT:"transparent",OPAQUE:"opaque"};SWFUpload.completeURL=function(a){if(typeof a!=="string"||a.match(/^https?:\/\//i)||a.match(/^\//))return a;var b=window.location.pathname.lastIndexOf("/");path=b<=0?"/":window.location.pathname.substr(0,b)+"/";return path+a};
SWFUpload.prototype.initSettings=function(){this.ensureDefault=function(a,b){this.settings[a]=this.settings[a]==void 0?b:this.settings[a]};this.ensureDefault("upload_url","");this.ensureDefault("preserve_relative_urls",!1);this.ensureDefault("file_post_name","Filedata");this.ensureDefault("post_params",{});this.ensureDefault("use_query_string",!1);this.ensureDefault("requeue_on_error",!1);this.ensureDefault("http_success",[]);this.ensureDefault("assume_success_timeout",0);this.ensureDefault("file_types",
"*.*");this.ensureDefault("file_types_description","All Files");this.ensureDefault("file_size_limit",0);this.ensureDefault("file_upload_limit",0);this.ensureDefault("file_queue_limit",0);this.ensureDefault("flash_url","swfupload.swf");this.ensureDefault("prevent_swf_caching",!0);this.ensureDefault("button_image_url","");this.ensureDefault("button_width",1);this.ensureDefault("button_height",1);this.ensureDefault("button_text","");this.ensureDefault("button_text_style","color: #000000; font-size: 16pt;");
this.ensureDefault("button_text_top_padding",0);this.ensureDefault("button_text_left_padding",0);this.ensureDefault("button_action",SWFUpload.BUTTON_ACTION.SELECT_FILES);this.ensureDefault("button_disabled",!1);this.ensureDefault("button_placeholder_id","");this.ensureDefault("button_placeholder",null);this.ensureDefault("button_cursor",SWFUpload.CURSOR.ARROW);this.ensureDefault("button_window_mode",SWFUpload.WINDOW_MODE.WINDOW);this.ensureDefault("debug",!1);this.settings.debug_enabled=this.settings.debug;
this.settings.return_upload_start_handler=this.returnUploadStart;this.ensureDefault("swfupload_loaded_handler",null);this.ensureDefault("file_dialog_start_handler",null);this.ensureDefault("file_queued_handler",null);this.ensureDefault("file_queue_error_handler",null);this.ensureDefault("file_dialog_complete_handler",null);this.ensureDefault("upload_start_handler",null);this.ensureDefault("upload_progress_handler",null);this.ensureDefault("upload_error_handler",null);this.ensureDefault("upload_success_handler",
null);this.ensureDefault("upload_complete_handler",null);this.ensureDefault("debug_handler",this.debugMessage);this.ensureDefault("custom_settings",{});this.customSettings=this.settings.custom_settings;if(this.settings.prevent_swf_caching)this.settings.flash_url=this.settings.flash_url+(this.settings.flash_url.indexOf("?")<0?"?":"&")+"preventswfcaching="+(new Date).getTime();if(!this.settings.preserve_relative_urls)this.settings.upload_url=SWFUpload.completeURL(this.settings.upload_url),this.settings.button_image_url=
SWFUpload.completeURL(this.settings.button_image_url);delete this.ensureDefault};
SWFUpload.prototype.loadFlash=function(){var a,b;if(document.getElementById(this.movieName)!==null)throw"ID "+this.movieName+" is already in use. The Flash Object could not be added";a=document.getElementById(this.settings.button_placeholder_id)||this.settings.button_placeholder;if(a==void 0)throw"Could not find the placeholder element: "+this.settings.button_placeholder_id;b=document.createElement("div");b.innerHTML=this.getFlashHTML();a.parentNode.replaceChild(b.firstChild,a);window[this.movieName]==
void 0&&(window[this.movieName]=this.getMovieElement())};
SWFUpload.prototype.getFlashHTML=function(){return['<object id="',this.movieName,'" type="application/x-shockwave-flash" data="',this.settings.flash_url,'" width="',this.settings.button_width,'" height="',this.settings.button_height,'" class="swfupload"><param name="wmode" value="',this.settings.button_window_mode,'" /><param name="movie" value="',this.settings.flash_url,'" /><param name="quality" value="high" /><param name="menu" value="false" /><param name="allowScriptAccess" value="always" />','<param name="flashvars" value="'+
this.getFlashVars()+'" />',"</object>"].join("")};
SWFUpload.prototype.getFlashVars=function(){var a=this.buildParamString(),b=this.settings.http_success.join(",");return["movieName=",encodeURIComponent(this.movieName),"&amp;uploadURL=",encodeURIComponent(this.settings.upload_url),"&amp;useQueryString=",encodeURIComponent(this.settings.use_query_string),"&amp;requeueOnError=",encodeURIComponent(this.settings.requeue_on_error),"&amp;httpSuccess=",encodeURIComponent(b),"&amp;assumeSuccessTimeout=",encodeURIComponent(this.settings.assume_success_timeout),"&amp;params=",
encodeURIComponent(a),"&amp;filePostName=",encodeURIComponent(this.settings.file_post_name),"&amp;fileTypes=",encodeURIComponent(this.settings.file_types),"&amp;fileTypesDescription=",encodeURIComponent(this.settings.file_types_description),"&amp;fileSizeLimit=",encodeURIComponent(this.settings.file_size_limit),"&amp;fileUploadLimit=",encodeURIComponent(this.settings.file_upload_limit),"&amp;fileQueueLimit=",encodeURIComponent(this.settings.file_queue_limit),"&amp;debugEnabled=",encodeURIComponent(this.settings.debug_enabled),
"&amp;buttonImageURL=",encodeURIComponent(this.settings.button_image_url),"&amp;buttonWidth=",encodeURIComponent(this.settings.button_width),"&amp;buttonHeight=",encodeURIComponent(this.settings.button_height),"&amp;buttonText=",encodeURIComponent(this.settings.button_text),"&amp;buttonTextTopPadding=",encodeURIComponent(this.settings.button_text_top_padding),"&amp;buttonTextLeftPadding=",encodeURIComponent(this.settings.button_text_left_padding),"&amp;buttonTextStyle=",encodeURIComponent(this.settings.button_text_style),
"&amp;buttonAction=",encodeURIComponent(this.settings.button_action),"&amp;buttonDisabled=",encodeURIComponent(this.settings.button_disabled),"&amp;buttonCursor=",encodeURIComponent(this.settings.button_cursor)].join("")};SWFUpload.prototype.getMovieElement=function(){if(this.movieElement==void 0)this.movieElement=document.getElementById(this.movieName);if(this.movieElement===null)throw"Could not find Flash element";return this.movieElement};
SWFUpload.prototype.buildParamString=function(){var a=this.settings.post_params,b=[];if(typeof a==="object")for(var c in a)a.hasOwnProperty(c)&&b.push(encodeURIComponent(c.toString())+"="+encodeURIComponent(a[c].toString()));return b.join("&amp;")};
SWFUpload.prototype.destroy=function(){try{this.cancelUpload(null,!1);var a=null;if((a=this.getMovieElement())&&typeof a.CallFunction==="unknown"){for(var b in a)try{typeof a[b]==="function"&&(a[b]=null)}catch(c){}try{a.parentNode.removeChild(a)}catch(d){}}window[this.movieName]=null;SWFUpload.instances[this.movieName]=null;delete SWFUpload.instances[this.movieName];this.movieName=this.eventQueue=this.customSettings=this.settings=this.movieElement=null;return!0}catch(e){return!1}};
SWFUpload.prototype.displayDebugInfo=function(){this.debug(["---SWFUpload Instance Info---\nVersion: ",SWFUpload.version,"\nMovie Name: ",this.movieName,"\nSettings:\n\tupload_url:               ",this.settings.upload_url,"\n\tflash_url:                ",this.settings.flash_url,"\n\tuse_query_string:         ",this.settings.use_query_string.toString(),"\n\trequeue_on_error:         ",this.settings.requeue_on_error.toString(),"\n\thttp_success:             ",this.settings.http_success.join(", "),"\n\tassume_success_timeout:   ",
this.settings.assume_success_timeout,"\n\tfile_post_name:           ",this.settings.file_post_name,"\n\tpost_params:              ",this.settings.post_params.toString(),"\n\tfile_types:               ",this.settings.file_types,"\n\tfile_types_description:   ",this.settings.file_types_description,"\n\tfile_size_limit:          ",this.settings.file_size_limit,"\n\tfile_upload_limit:        ",this.settings.file_upload_limit,"\n\tfile_queue_limit:         ",this.settings.file_queue_limit,"\n\tdebug:                    ",
this.settings.debug.toString(),"\n\tprevent_swf_caching:      ",this.settings.prevent_swf_caching.toString(),"\n\tbutton_placeholder_id:    ",this.settings.button_placeholder_id.toString(),"\n\tbutton_placeholder:       ",this.settings.button_placeholder?"Set":"Not Set","\n\tbutton_image_url:         ",this.settings.button_image_url.toString(),"\n\tbutton_width:             ",this.settings.button_width.toString(),"\n\tbutton_height:            ",this.settings.button_height.toString(),"\n\tbutton_text:              ",
this.settings.button_text.toString(),"\n\tbutton_text_style:        ",this.settings.button_text_style.toString(),"\n\tbutton_text_top_padding:  ",this.settings.button_text_top_padding.toString(),"\n\tbutton_text_left_padding: ",this.settings.button_text_left_padding.toString(),"\n\tbutton_action:            ",this.settings.button_action.toString(),"\n\tbutton_disabled:          ",this.settings.button_disabled.toString(),"\n\tcustom_settings:          ",this.settings.custom_settings.toString(),"\nEvent Handlers:\n\tswfupload_loaded_handler assigned:  ",
(typeof this.settings.swfupload_loaded_handler==="function").toString(),"\n\tfile_dialog_start_handler assigned: ",(typeof this.settings.file_dialog_start_handler==="function").toString(),"\n\tfile_queued_handler assigned:       ",(typeof this.settings.file_queued_handler==="function").toString(),"\n\tfile_queue_error_handler assigned:  ",(typeof this.settings.file_queue_error_handler==="function").toString(),"\n\tupload_start_handler assigned:      ",(typeof this.settings.upload_start_handler===
"function").toString(),"\n\tupload_progress_handler assigned:   ",(typeof this.settings.upload_progress_handler==="function").toString(),"\n\tupload_error_handler assigned:      ",(typeof this.settings.upload_error_handler==="function").toString(),"\n\tupload_success_handler assigned:    ",(typeof this.settings.upload_success_handler==="function").toString(),"\n\tupload_complete_handler assigned:   ",(typeof this.settings.upload_complete_handler==="function").toString(),"\n\tdebug_handler assigned:             ",
(typeof this.settings.debug_handler==="function").toString(),"\n"].join(""))};SWFUpload.prototype.addSetting=function(a,b,c){return b==void 0?this.settings[a]=c:this.settings[a]=b};SWFUpload.prototype.getSetting=function(a){return this.settings[a]!=void 0?this.settings[a]:""};
SWFUpload.prototype.callFlash=function(a,b){var b=b||[],c=this.getMovieElement(),d,e;try{e=c.CallFunction('<invoke name="'+a+'" returntype="javascript">'+__flash__argumentsToXML(b,0)+"</invoke>"),d=eval(e)}catch(f){throw"Call to "+a+" failed";}d!=void 0&&typeof d.post==="object"&&(d=this.unescapeFilePostParams(d));return d};SWFUpload.prototype.selectFile=function(){this.callFlash("SelectFile")};SWFUpload.prototype.selectFiles=function(){this.callFlash("SelectFiles")};
SWFUpload.prototype.startUpload=function(a){this.callFlash("StartUpload",[a])};SWFUpload.prototype.cancelUpload=function(a,b){b!==!1&&(b=!0);this.callFlash("CancelUpload",[a,b])};SWFUpload.prototype.stopUpload=function(){this.callFlash("StopUpload")};SWFUpload.prototype.getStats=function(){return this.callFlash("GetStats")};SWFUpload.prototype.setStats=function(a){this.callFlash("SetStats",[a])};
SWFUpload.prototype.getFile=function(a){return typeof a==="number"?this.callFlash("GetFileByIndex",[a]):this.callFlash("GetFile",[a])};SWFUpload.prototype.addFileParam=function(a,b,c){return this.callFlash("AddFileParam",[a,b,c])};SWFUpload.prototype.removeFileParam=function(a,b){this.callFlash("RemoveFileParam",[a,b])};SWFUpload.prototype.setUploadURL=function(a){this.settings.upload_url=a.toString();this.callFlash("SetUploadURL",[a])};
SWFUpload.prototype.setPostParams=function(a){this.settings.post_params=a;this.callFlash("SetPostParams",[a])};SWFUpload.prototype.addPostParam=function(a,b){this.settings.post_params[a]=b;this.callFlash("SetPostParams",[this.settings.post_params])};SWFUpload.prototype.removePostParam=function(a){delete this.settings.post_params[a];this.callFlash("SetPostParams",[this.settings.post_params])};
SWFUpload.prototype.setFileTypes=function(a,b){this.settings.file_types=a;this.settings.file_types_description=b;this.callFlash("SetFileTypes",[a,b])};SWFUpload.prototype.setFileSizeLimit=function(a){this.settings.file_size_limit=a;this.callFlash("SetFileSizeLimit",[a])};SWFUpload.prototype.setFileUploadLimit=function(a){this.settings.file_upload_limit=a;this.callFlash("SetFileUploadLimit",[a])};
SWFUpload.prototype.setFileQueueLimit=function(a){this.settings.file_queue_limit=a;this.callFlash("SetFileQueueLimit",[a])};SWFUpload.prototype.setFilePostName=function(a){this.settings.file_post_name=a;this.callFlash("SetFilePostName",[a])};SWFUpload.prototype.setUseQueryString=function(a){this.settings.use_query_string=a;this.callFlash("SetUseQueryString",[a])};SWFUpload.prototype.setRequeueOnError=function(a){this.settings.requeue_on_error=a;this.callFlash("SetRequeueOnError",[a])};
SWFUpload.prototype.setHTTPSuccess=function(a){typeof a==="string"&&(a=a.replace(" ","").split(","));this.settings.http_success=a;this.callFlash("SetHTTPSuccess",[a])};SWFUpload.prototype.setAssumeSuccessTimeout=function(a){this.settings.assume_success_timeout=a;this.callFlash("SetAssumeSuccessTimeout",[a])};SWFUpload.prototype.setDebugEnabled=function(a){this.settings.debug_enabled=a;this.callFlash("SetDebugEnabled",[a])};
SWFUpload.prototype.setButtonImageURL=function(a){a==void 0&&(a="");this.settings.button_image_url=a;this.callFlash("SetButtonImageURL",[a])};SWFUpload.prototype.setButtonDimensions=function(a,b){this.settings.button_width=a;this.settings.button_height=b;var c=this.getMovieElement();if(c!=void 0)c.style.width=a+"px",c.style.height=b+"px";this.callFlash("SetButtonDimensions",[a,b])};SWFUpload.prototype.setButtonText=function(a){this.settings.button_text=a;this.callFlash("SetButtonText",[a])};
SWFUpload.prototype.setButtonTextPadding=function(a,b){this.settings.button_text_top_padding=b;this.settings.button_text_left_padding=a;this.callFlash("SetButtonTextPadding",[a,b])};SWFUpload.prototype.setButtonTextStyle=function(a){this.settings.button_text_style=a;this.callFlash("SetButtonTextStyle",[a])};SWFUpload.prototype.setButtonDisabled=function(a){this.settings.button_disabled=a;this.callFlash("SetButtonDisabled",[a])};
SWFUpload.prototype.setButtonAction=function(a){this.settings.button_action=a;this.callFlash("SetButtonAction",[a])};SWFUpload.prototype.setButtonCursor=function(a){this.settings.button_cursor=a;this.callFlash("SetButtonCursor",[a])};
SWFUpload.prototype.queueEvent=function(a,b){b==void 0?b=[]:b instanceof Array||(b=[b]);var c=this;if(typeof this.settings[a]==="function")this.eventQueue.push(function(){this.settings[a].apply(this,b)}),setTimeout(function(){c.executeNextEvent()},0);else if(this.settings[a]!==null)throw"Event handler "+a+" is unknown or is not a function";};SWFUpload.prototype.executeNextEvent=function(){var a=this.eventQueue?this.eventQueue.shift():null;typeof a==="function"&&a.apply(this)};
SWFUpload.prototype.unescapeFilePostParams=function(a){var b=/[$]([0-9a-f]{4})/i,c={},d;if(a!=void 0){for(var e in a.post)if(a.post.hasOwnProperty(e)){d=e;for(var f;(f=b.exec(d))!==null;)d=d.replace(f[0],String.fromCharCode(parseInt("0x"+f[1],16)));c[d]=a.post[e]}a.post=c}return a};SWFUpload.prototype.testExternalInterface=function(){try{return this.callFlash("TestExternalInterface")}catch(a){return!1}};
SWFUpload.prototype.flashReady=function(){var a=this.getMovieElement();a?(this.cleanUp(a),this.queueEvent("swfupload_loaded_handler")):this.debug("Flash called back ready but the flash movie can't be found.")};
SWFUpload.prototype.cleanUp=function(a){try{if(this.movieElement&&typeof a.CallFunction==="unknown"){this.debug("Removing Flash functions hooks (this should only run in IE and should prevent memory leaks)");for(var b in a)try{typeof a[b]==="function"&&(a[b]=null)}catch(c){}}}catch(d){}window.__flash__removeCallback=function(a,b){try{a&&(a[b]=null)}catch(c){}}};SWFUpload.prototype.fileDialogStart=function(){this.queueEvent("file_dialog_start_handler")};
SWFUpload.prototype.fileQueued=function(a){a=this.unescapeFilePostParams(a);this.queueEvent("file_queued_handler",a)};SWFUpload.prototype.fileQueueError=function(a,b,c){a=this.unescapeFilePostParams(a);this.queueEvent("file_queue_error_handler",[a,b,c])};SWFUpload.prototype.fileDialogComplete=function(a,b,c){this.queueEvent("file_dialog_complete_handler",[a,b,c])};SWFUpload.prototype.uploadStart=function(a){a=this.unescapeFilePostParams(a);this.queueEvent("return_upload_start_handler",a)};
SWFUpload.prototype.returnUploadStart=function(a){var b;if(typeof this.settings.upload_start_handler==="function")a=this.unescapeFilePostParams(a),b=this.settings.upload_start_handler.call(this,a);else if(this.settings.upload_start_handler!=void 0)throw"upload_start_handler must be a function";b===void 0&&(b=!0);this.callFlash("ReturnUploadStart",[!!b])};SWFUpload.prototype.uploadProgress=function(a,b,c){a=this.unescapeFilePostParams(a);this.queueEvent("upload_progress_handler",[a,b,c])};
SWFUpload.prototype.uploadError=function(a,b,c){a=this.unescapeFilePostParams(a);this.queueEvent("upload_error_handler",[a,b,c])};SWFUpload.prototype.uploadSuccess=function(a,b,c){a=this.unescapeFilePostParams(a);this.queueEvent("upload_success_handler",[a,b,c])};SWFUpload.prototype.uploadComplete=function(a){a=this.unescapeFilePostParams(a);this.queueEvent("upload_complete_handler",a)};SWFUpload.prototype.debug=function(a){this.queueEvent("debug_handler",a)};
SWFUpload.prototype.debugMessage=function(a){if(this.settings.debug){var b=[];if(typeof a==="object"&&typeof a.name==="string"&&typeof a.message==="string"){for(var c in a)a.hasOwnProperty(c)&&b.push(c+": "+a[c]);a=b.join("\n")||"";b=a.split("\n");a="EXCEPTION: "+b.join("\nEXCEPTION: ")}SWFUpload.Console.writeLine(a)}};SWFUpload.Console={};
SWFUpload.Console.writeLine=function(a){var b,c;try{b=document.getElementById("SWFUpload_Console");if(!b)c=document.createElement("form"),document.getElementsByTagName("body")[0].appendChild(c),b=document.createElement("textarea"),b.id="SWFUpload_Console",b.style.fontFamily="monospace",b.setAttribute("wrap","off"),b.wrap="off",b.style.overflow="auto",b.style.width="700px",b.style.height="350px",b.style.margin="5px",c.appendChild(b);b.value+=a+"\n";b.scrollTop=b.scrollHeight-b.clientHeight}catch(d){alert("Exception: "+
d.name+" Message: "+d.message)}};
(function(a){var b="swfupload_preload_handler,swfupload_load_failed_handler,swfupload_loaded_handler,file_dialog_start_handler,file_queued_handler,file_queue_error_handler,file_dialog_complete_handler,upload_resize_start_handler,upload_start_handler,upload_progress_handler,upload_error_handler,upload_success_handler,upload_complete_handler,mouse_click_handler,mouse_out_handler,mouse_over_handler,queue_complete_handler".split(","),c=[];a.fn.swfupload=function(){var d=a.makeArray(arguments);return this.each(function(){var e;
if(d.length==1&&typeof d[0]=="object"){if(e=a(this).data("__swfu"),!e){var f=d[0],h=a(this);e=[];a.merge(e,b);a.merge(e,c);a.each(e,function(b,c){var d=c.replace(/_handler$/,"").replace(/_([a-z])/g,function(a,b){return b.toUpperCase()});f[c]=function(){var b=a.Event(d);h.trigger(b,a.makeArray(arguments));return!b.isDefaultPrevented()}});a(this).data("__swfu",new SWFUpload(f))}}else if(d.length>0&&typeof d[0]=="string"){var g=d.shift();(e=a(this).data("__swfu"))&&e[g]&&e[g].apply(e,d)}})};a.swfupload=
{additionalHandlers:function(){if(arguments.length===0)return c.slice();else a(arguments).each(function(b,e){a.merge(c,a.makeArray(e))})},defaultHandlers:function(){return b.slice()},getInstance:function(b){return a(b).data("__swfu")}}})(jQuery);


//  js/jquery.lightbox-0.5.js 
(function(b){b.fn.imageBox=function(a){function m(){b("body").append('<div id="jquery-overlay"></div><div id="jquery-lightbox"><div id="lightbox-container-image-box"><div id="lightbox-container-image"><img id="lightbox-image"><div style="" id="lightbox-nav"><a href="#" id="lightbox-nav-btnPrev"></a><a href="#" id="lightbox-nav-btnNext"></a></div><div id="lightbox-loading"><a href="#" id="lightbox-loading-link"><img src="'+a.imageLoading+'"></a></div></div></div><div id="lightbox-container-image-data-box"><div id="lightbox-container-image-data"><div id="lightbox-image-details"><span id="lightbox-image-details-caption"></span><span id="lightbox-image-details-currentNumber"></span></div><div id="lightbox-secNav"><a href="#" id="lightbox-secNav-btnClose"><img src="'+
a.imageBtnClose+'"></a></div></div></div></div>');var c=i();b("#jquery-overlay").css({backgroundColor:a.overlayBgColor,opacity:a.overlayOpacity,width:c[0],height:c[1]}).fadeIn();var g=k();b("#jquery-lightbox").css({top:g[1]+c[3]/10,left:g[0]}).show();b("#jquery-overlay,#jquery-lightbox").click(function(){j()});b("#lightbox-loading-link,#lightbox-secNav-btnClose").click(function(){j();return!1});b(window).resize(function(){var a=i();b("#jquery-overlay").css({width:a[0],height:a[1]});var c=k();b("#jquery-lightbox").css({top:c[1]+
a[3]/10,left:c[0]})})}function f(){b("#lightbox-loading").show();a.fixedNavigation?b("#lightbox-image,#lightbox-container-image-data-box,#lightbox-image-details-currentNumber").hide():b("#lightbox-image,#lightbox-nav,#lightbox-nav-btnPrev,#lightbox-nav-btnNext,#lightbox-container-image-data-box,#lightbox-image-details-currentNumber").hide();var c=new Image;c.onload=function(){b("#lightbox-image").attr("src",a.imageArray[a.activeImage][0]);var g=c.width,d=c.height,e=i()[1]-150;d>e&&(g*=e/d,d=e);b("#lightbox-image").height(d);
n(g,d);c.onload=function(){}};c.src=a.imageArray[a.activeImage][0]}function n(c,g){var d=b("#lightbox-container-image-box").width(),e=b("#lightbox-container-image-box").height(),f=c+a.containerBorderSize*2,h=g+a.containerBorderSize*2;d-=f;e-=h;b("#lightbox-container-image-box").animate({width:f,height:h},a.containerResizeSpeed,function(){o()});d==0&&e==0&&(b.browser.msie?l(250):l(100));b("#lightbox-container-image-data-box").css({width:c});b("#lightbox-nav-btnPrev,#lightbox-nav-btnNext").css({height:g+
a.containerBorderSize*2})}function o(){b("#lightbox-loading").hide();b("#lightbox-image").fadeIn(function(){b("#lightbox-container-image-data-box").slideDown("fast");b("#lightbox-image-details-caption").hide();a.imageArray[a.activeImage][1]&&b("#lightbox-image-details-caption").html(a.imageArray[a.activeImage][1]).show();a.imageArray.length>1&&b("#lightbox-image-details-currentNumber").html(a.txtImage+" "+(a.activeImage+1)+" "+a.txtOf+" "+a.imageArray.length).show();p()});if(a.imageArray.length-1>
a.activeImage)objNext=new Image,objNext.src=a.imageArray[a.activeImage+1][0];if(a.activeImage>0)objPrev=new Image,objPrev.src=a.imageArray[a.activeImage-1][0]}function p(){b("#lightbox-nav").show();b("#lightbox-nav-btnPrev,#lightbox-nav-btnNext").css({background:"transparent url("+a.imageBlank+") no-repeat"});a.activeImage!=0&&(a.fixedNavigation?b("#lightbox-nav-btnPrev").css({background:"url("+a.imageBtnPrev+") left 15% no-repeat"}).unbind().bind("click",function(){a.activeImage-=1;f();return!1}):
b("#lightbox-nav-btnPrev").unbind().hover(function(){b(this).css({background:"url("+a.imageBtnPrev+") left 15% no-repeat"})},function(){b(this).css({background:"transparent url("+a.imageBlank+") no-repeat"})}).show().bind("click",function(){a.activeImage-=1;f();return!1}));a.activeImage!=a.imageArray.length-1&&(a.fixedNavigation?b("#lightbox-nav-btnNext").css({background:"url("+a.imageBtnNext+") right 15% no-repeat"}).unbind().bind("click",function(){a.activeImage+=1;f();return!1}):b("#lightbox-nav-btnNext").unbind().hover(function(){b(this).css({background:"url("+
a.imageBtnNext+") right 15% no-repeat"})},function(){b(this).css({background:"transparent url("+a.imageBlank+") no-repeat"})}).show().bind("click",function(){a.activeImage+=1;f();return!1}));q()}function q(){b(document).keydown(function(c){c==null?(keycode=event.keyCode,escapeKey=27):(keycode=c.keyCode,escapeKey=c.DOM_VK_ESCAPE);key=String.fromCharCode(keycode).toLowerCase();(key==a.keyToClose||key=="x"||keycode==escapeKey)&&j();if((key==a.keyToPrev||keycode==37)&&a.activeImage!=0)a.activeImage-=
1,f(),b(document).unbind();if((key==a.keyToNext||keycode==39)&&a.activeImage!=a.imageArray.length-1)a.activeImage+=1,f(),b(document).unbind()})}function j(){b("#jquery-lightbox").remove();b("#jquery-overlay").fadeOut(function(){b("#jquery-overlay").remove()});b("embed, object, select").css({visibility:"visible"})}function i(){var a,b;window.innerHeight&&window.scrollMaxY?(a=window.innerWidth+window.scrollMaxX,b=window.innerHeight+window.scrollMaxY):document.body.scrollHeight>document.body.offsetHeight?
(a=document.body.scrollWidth,b=document.body.scrollHeight):(a=document.body.offsetWidth,b=document.body.offsetHeight);var d,e;if(self.innerHeight)d=document.documentElement.clientWidth?document.documentElement.clientWidth:self.innerWidth,e=self.innerHeight;else if(document.documentElement&&document.documentElement.clientHeight)d=document.documentElement.clientWidth,e=document.documentElement.clientHeight;else if(document.body)d=document.body.clientWidth,e=document.body.clientHeight;pageHeight=b<e?
e:b;pageWidth=a<d?a:d;return arrayPageSize=[pageWidth,pageHeight,d,e]}function k(){var a,b;if(self.pageYOffset)b=self.pageYOffset,a=self.pageXOffset;else if(document.documentElement&&document.documentElement.scrollTop)b=document.documentElement.scrollTop,a=document.documentElement.scrollLeft;else if(document.body)b=document.body.scrollTop,a=document.body.scrollLeft;return arrayPageScroll=[a,b]}function l(a){var b=new Date;do var d=new Date;while(d-b<a)}var a=jQuery.extend({overlayBgColor:"#000",overlayOpacity:0.8,
fixedNavigation:!1,imageLoading:"http://img.mapbar.com/web/3in1/imgs/lightbox/loading.gif",imageBtnPrev:"http://img.mapbar.com/web/3in1/imgs/lightbox/btn-prev.gif",imageBtnNext:"http://img.mapbar.com/web/3in1/imgs/lightbox/btn-next.gif",imageBtnClose:"http://img.mapbar.com/web/3in1/imgs/lightbox/btn-close.gif",imageBlank:"http://img.mapbar.com/web/3in1/imgs/lightbox/blank.gif",containerBorderSize:10,containerResizeSpeed:400,txtImage:"",txtOf:"/",keyToClose:"c",keyToPrev:"p",keyToNext:"n",imageArray:[],
activeImage:0},a),h=this;return this.unbind("click").click(function(){b("embed, object, select").css({visibility:"hidden"});m();a.imageArray.length=0;a.activeImage=0;if(h.length==1)a.imageArray.push([this.getAttribute("href"),this.getAttribute("title")]);else for(var c=0;c<h.length;c++)a.imageArray.push([h[c].getAttribute("href"),h[c].getAttribute("title")]);for(;a.imageArray[a.activeImage][0]!=this.getAttribute("href");)a.activeImage++;f();return!1})}})(jQuery);

//
function cut_str(str, len)
{
    if(!str || !len) { return ''; }
    //21
    var a = 0;
    //
    var temp = '';
    for (var i=0;i<str.length;i++)
    {
        if (str.charCodeAt(i)>255)
        {
             a+=2;
        }else{
             a++;
        }
        //
        if(a > len) { return temp + '...'; }
        //
         temp += str.charAt(i);
    }
    //
    return str;
}
/*
  ()
 prototype
 
 obj.superClasses Array 
 obj.className String 
 obj.isKClassO Boolean  true KClass
 obj.superclassOf Function 
 obj.toString Function 
 wangzheng
 1.0
 2010-01-10
 2010-03-16
 */
var KClass = new (function () {

    // =
    var _classList = {};
    
	///**
    // * 
    // */
    //var _toString = function()
    //{
        //var thisString = [];
        //for (var i in this)
        //    if (typeof this[i] != 'function' && i != "className")
        //        thisString.push(i + "=" + this[i]);
        //return thisString.join(",");
	//	return "";
    //};
    var _classSuperClass = function(thisClass, superClass)
    {
        var superClasses = thisClass.prototype.superClasses;
        for(var i = 0; i < superClasses.length; i++)
        {
            if(superClass == superClasses[i]) return true;
            if(_classSuperClass(superClasses[i], superClass)) return true;
        }
        return false;
    };

    /**
     * 
     */
    var _superclassOf = function(_superClass)
    {
        if(_superClass instanceof Function) return _classSuperClass(_classList[this.className], _superClass);
        return false;
    };

    /**
     * 
     * @param className 
     * @param superClass 
     * @uncrunch
     */
    this.create = function(className, superClass)
    {
        if (!className) return;
        /**
         * ,
         * initialize
         */
        var thisClass = function()
        {
            var superClasses = thisClass.prototype.superClasses;
            if(superClasses instanceof Array)
            {
                for(var i = 0; i < superClasses.length; i++)
                    if(superClasses[i] instanceof Function) superClasses[i].apply(this, arguments);
            }
            if (thisClass.initialize) thisClass.initialize.apply(this, arguments);
        };
        if (_classList[className]) delete _classList[className];
        _classList[className] = thisClass;

        var _superClasses = [];

        /**
         * prototype
         * prototype
         */
        if (superClass instanceof Function)
        {
            var TempF = new Function();
            TempF.prototype = superClass.prototype;
            thisClass.prototype = new TempF();
            thisClass.prototype.constructor = thisClass;
            _superClasses.push(superClass);
            for(var i = 2; i < arguments.length; i++)
            {
                if(arguments[i] instanceof Function)
                {
                    for(var j in arguments[i].prototype)
                        thisClass.prototype[j] = arguments[i].prototype[j];
                    _superClasses.push(arguments[i]);
                }
            }
        }
        /**
         * superClassesclassNameisKClassOsuperclassOftoString
         */
        //@uncrunch 
        thisClass.prototype.superClasses = _superClasses;
        //@uncrunch 
        thisClass.prototype.className = className;
        //@uncrunch KClass
        thisClass.prototype.isKClassO = true;
        //@uncrunch 
        thisClass.prototype.superclassOf = _superclassOf;
        ////@uncrunch 
        //if(!thisClass.prototype.toString) thisClass.prototype.toString = _toString;
        return thisClass;
    };
})();
/*
 
 */
/*
 KAccordion opts?  javascript 
 */
var KAccordionOptions =
{
    //@uncrunch Boolean  	true
    animation : true
    //@uncrunch Boolean  	false
    ,collapse : false
    //@uncrunch Boolean  	true
    ,autoheight : true
    //@uncrunch 	Boolean  	 true
    ,multiple : true
    // @uncrunch 	Integer  	0 multiple 
    ,initexpand : 0
    //@uncrunch
    ,_$P : ["KWidgetOptions"]
};
/*
KAccount 
 */
var KAccountInfo =
{
    //@uncrunch  	String  	
    user : undefined
    // @uncrunch 	String  	ID
    ,uid : undefined
	// @uncrunch 	String  	
    ,email : undefined
	// @uncrunch 	Boolean  	
    ,signin : undefined
};
/*
  KArea  opts?  javascript 
 */
var KAreaOptions =
{
    //@uncrunch KBrushOptions
    brush : undefined
    //@uncrunch KInfoWindow 
    ,infowin : undefined
    //@uncrunch Boolean false
    ,editable : false
    //@uncrunch Boolean true
    ,editHilite : true
    ////@uncrunch
    ,hiliteBrush : undefined
    //@uncrunch String 	temp
    ,group : "temp"
};
/*
  KLineOptions  KAreaOptions  brush  javascript 
 */
var KBrushOptions =
{
    //@uncrunch 
    color : "#ff0000"
    //@uncrunch 5
    ,width : 5
    //@uncrunch false
    ,dashed : false
    //@uncrunch 60
    ,transparency : 60
    //@uncrunch 
    ,bgcolor : "#ff0000"
    //@uncrunch 60
    ,bgtransparency : 60
    //@uncrunch false
    ,overlap : false
    //@uncrunch  	KDirMarkStyleOptions  	
    ,dmstyle : undefined
};
/*
KBubble opts?  javascript 
 */
var KBubbleOptions =
{
    //@uncrunch
    _$P : ["KWidgetOptions"]
};
/*
KBubble.open() ?opts?? javascript 
 */
var KBubbleShowOptions =
{
    //@uncrunch 	KSize 	
    size : undefined
    //@uncrunch 	Boolean 	
    ,closebtn : true
    //@uncrunch 
    ,outside : true
    //@uncrunch KPostion 	
    ,pos : undefined
    //@uncrunch  	Integer  	0 pos==KPosition.TOP  KPosition.BOTTOM 
    ,anchorx : 0
    //@uncrunch  	Integer  	0 pos==KPosition.LEFT  KPosition.RIGHT 
    ,anchory : 0
    //@uncrunch 	Integer 	0
    ,offsetx : 0
    //@uncrunch 	Integer 	0
    ,offsety : 0
    // @uncrunch 	Integer  	0 pos==KPosition.TOP  KPosition.BOTTOM 
    ,marginx : 0
    // @uncrunch 	Integer  	0 pos==KPosition.LEFT  KPosition.RIGHT 
    ,marginy : 0
    //@uncrunch 	Integer  	5px IE 0px
    ,corneradius : 5
    //@uncrunch  	Boolean  	 true 
    ,autolayout : true
    //@uncrunch   	Boolean  	  pos  
    ,force : undefined
    //@uncrunch  	Boolean  	 node  true 
    ,arrow : true
};
/*
KBusearch ?opts?? javascript 
 */
var KBusearchOptions =
{
    //@uncrunch  	Node  	
    result : undefined
    // @uncrunch 	Node  	undefined
    ,mapcontainer : undefined
    // @uncrunch 	Boolean  	true
    ,initmap : true
    //@uncrunch  	String  	
    ,busurl : undefined
    // @uncrunch 	String  	
    ,lineurl : undefined
    //  @uncrunch	String  	
    ,stationurl : undefined
    // @uncrunch 	KSender  	 undefined
    ,sender : undefined
    // @uncrunch 	KPrinter  	 undefined
    ,printer : undefined
    //@uncrunch  	KSearchbox  	 undefined
    ,searchbox : undefined
    //@uncrunch   	KStationListOptions  	KStationListOptions.citylist  true
    ,slopts : undefined
    //@uncrunch
    ,_$P : ["KWidgetOptions"]
};
/*

 */
var KCallback =
{
    // @uncrunch 	Function  	 undefined
    fun : undefined
    // @uncrunch 	Object  	 undefined
    ,thisobj : undefined
    // @uncrunch 	Any  	 undefined
    ,data : undefined
};
/*
	 KTools.checkSpace() 
*/
var KCheckSpaceOptions =
{
	//@uncrunch KPosition	checkSpace(pt, size, KPosition.TOP | KPosition.LEFT) 
    pos : undefined
	//@uncrunch Integer	element  rect  0 
    ,offsetx : 0
	//@uncrunch Integer	element  rect  0 
    ,offsety : 0
	//@uncrunch Integer	element  rect  0 
    ,marginx : 0
	//@uncrunch Integer	element  rect  0 
    ,marginy : 0
	
};
/**
 *  KCity   javascript 
 */
var KCityInfo =
{
    //@uncrunch 	String 	
    name : ""
	//@uncrunch 	String	
	,ename : ""
    //@uncrunch 	String 	
    ,latlon:""
    //@uncrunch 	Integer 	 K_MIN_ZOOM_LEVEL  K_MAX_ZOOM_LEVEL 
    ,level:undefined
    // 	@uncrunch String 	
    ,province:""
	//@uncrunch   	Boolean  	 true  
	,bus : true
};
/*
KCityList opts?  javascript 
 */
var KCityListOptions =
{
    //@uncrunch 	Boolean 	
    sugurl : undefined
    //@uncrunch 	Integer 	suggest8
    ,suglimit : 8
    //	@uncrunch String 	jsonhtml
    ,sugajaxmode : undefined
    //@uncrunch 	Boolean 	true
    ,citylist : true
//    //@uncrunch 	KSize 	width,height
//    ,clsize : undefined
    //@uncrunch 	String 	
    ,mburl : ""
    // @uncrunch 	KCityInfo  	
    ,defcity : {name:"", latlon:"HETCUFZVVHUEE", level:8, province:"", ename:"beijing"}
    //@uncrunch
    ,_$P : ["KWidgetOptions"]
    // @uncrunch 	Boolean  false 
    ,autocomplete : true
  //@uncrunch String  KCityList.setCity()KCityListOptions.laturl
    ,laturl:undefined
    //@uncrunch Boolean KCityListcitylisttrue 
    ,onehot:true
    //@uncrunch Node undefined domready
    ,hcnode : undefined
    //@uncrunch Node DIV undefined domready
    ,mcnode : undefined
    //@uncrunch Booleanfalse
    ,newcitylist : false
};
/*
  KTools.setCookie()  opts?  javascript 
 */
var KCookieOptions =
{
    //@uncrunch Integer +
    expires : 5
    //@uncrunch Cookies  mapbar.com 
    ,domain : "mapbar.com"
    //@uncrunch Cookies  / 
    ,path : "/"
};
var KDatePickerOptions = {
    //@uncrunch String "yyyy-mm-dd"
    format: "yyyy-mm-dd"
	//@uncrunch Date undefined
    ,min: undefined
	//@uncrunch Date undefined
    ,max: undefined
	//@uncrunch Integer  ,1
    ,month: 1
	//@uncrunch Date undefined
    ,date: undefined
	//@uncrunch String htmlundefined
    ,tip: undefined
	//@uncrunch Node undefined
	,icon:undefined
	//@uncrunch Node undefined
	,box:undefined
	//@uncrunch KDatePicker KDatePickerKDatePicker,undefined
    ,referpicker: undefined
	//@uncrunch
    ,_$P: ["KWidgetOptions"]
}
/*
 KDialog.open()  opts?  javascript 
 */
var KDialogOpenOptions =
{
    //@uncrunch   	KPoint  	 KDialogOptions.dragrange 
    pos:undefined
    //@uncrunch   	KSize  	 KDialogOptions.size
    ,size:undefined
    //@uncrunch   	Boolean  	false
    ,modal:false
};
/*
 KDialog  opts?  javascript 
 */
var KDialogOptions =
{
    //@uncrunch   	String  	
    title:""
    //@uncrunch   	Boolean  	false
    ,autopen:false
    //@uncrunch   	Boolean  	 ie6  select  true  ie6  true
    ,bgiframe:true
    //@uncrunch   	Boolean  	true
    ,dragable:true
    //@uncrunch   	Boolean  	true
    ,resizeable:true
    //@uncrunch   	KSize  	300pxauto
    ,size:undefined
    //@uncrunch   	Boolean  	false
    ,minbtn:false
    //@uncrunch   	Boolean  	false
    ,maxbtn:false
    //@uncrunch   	Boolean  	true
    ,closebtn:true
    //@uncrunch   	KBounds  	!
    ,dragrange:undefined
	//@uncrunch 	KSize	 resizeable=true  size width,height
	,minsize:undefined
    //@uncrunch
    ,_$P : ["KWidgetOptions"]
};
/*
 
 :
 :1.0
 :2010-01-15
 :2010-01-16
 */
var KDialogState =
{
    //@uncrunch 
    NORMAL : 1
    //@uncrunch 
    ,MINI : 2
    //@uncrunch 
    ,MAX : 4
    //@uncrunch 
    ,CLOSE : 8
    //@uncrunch 
    ,HIDE : 16
};
/*
 KLine.setDirMarkers()  opts?  javascript  
 */
var KDirMarkOptions =
{
    // @uncrunch 	Integer  	  K_MIN_ZOOM_LEVEL   K_MAX_ZOOM_LEVEL  K_MAX_ZOOM_LEVEL-2 
    minlevel : undefined
    // @uncrunch 	Integer  	  K_MIN_ZOOM_LEVEL   K_MAX_ZOOM_LEVEL  K_MAX_ZOOM_LEVEL 
    ,maxlevel : undefined
    // @uncrunch 	Boolean  	 true  
    ,redraw : true
};
/*
 KBrushOptions.dmstyle  javascript 
 */
var KDirMarkStyleOptions =
{
    // @uncrunch 	String  	 #0000FF  
    color : "#0000FF"
    // @uncrunch 	Integer  	 KBrushOptions.width * 4 
    ,size : undefined
    // @uncrunch 	Integer  	 KBrushOptions.transparency  
    ,transparency:undefined
    // @uncrunch 	Integer  	 1
    ,strokeWidth : 1
    //@uncrunch  	Integer  	 #FFFFFF  
    ,strokeColor : "#FFFFFF"
    //@uncrunch  	Boolean  	 100
    ,strokeTransparency : 100
};
/*
KDropList opts?  javascript 
 */
var KDropListOptions =
{
    //@uncrunch 	Boolean 	 multiple==false 
    select2text : undefined
    //@uncrunch
    ,_$P : ["KWidgetOptions", "KBubbleShowOptions", "KListOptions", "KDropPanelOptions"]
};
/*
KDropPanel opts?  javascript 
 */
var KDropPanelOptions =
{
	//@uncrunch Boolean Domfalse
	hover:false
    //@uncrunch
    ,_$P : ["KWidgetOptions", "KBubbleShowOptions"]
};
/*

 */
var KFBErrorType =
{
    // @uncrunch 	
    INFO : 1
    // @uncrunch 	
    ,LOCATION : 2
    //  @uncrunch	
    ,INEXISTENT : 4
    // @uncrunch	
    ,OTHER : 8
};
/*
 KFeedback 
 */
var KFeedbackInfo =
{
    // @uncrunch KFeedbackType	 KFeedbackType.POI_ERROR 
    type : undefined
    // @uncrunch 	KFBErrorType	 type==KFeedbackType.ERROR  KFBErrorType.INFO 
    ,errortype : undefined
    
	/*
	// @uncrunch		String	
    ,name :undefined
    // @uncrunch		String	
    ,address:undefined
    // @uncrunch 	String	
    ,phone:undefined
	*/
	
	//@uncrunch	KPOInfo	
	,poinfo : undefined
	// @uncrunch			String	
    ,notes:undefined
    // @uncrunch 	String	
    ,contact : undefined
	//@uncrunch	String	
	,url : undefined
};
/*

 */
var KFeedbackType =
{
    // @uncrunch 	POI
    POI_ERROR : 1
    // @uncrunch 	
    ,ROUTE_ERROR : 2
    //  @uncrunch	
    ,USERPOI : 4
    // @uncrunch	
    ,SUGGEST : 8
};
/*
 KGeocoder   javascript  
 */
var KGeocoderInfo =
{
    // @uncrunch 	String  	
    latlon : undefined
    // @uncrunch 	Integer  	
    ,zoom : undefined
    // @uncrunch 	String  	
    ,province : undefined
    // @uncrunch 	String  	
    ,city : undefined
    // @uncrunch 	String  	
    ,district : undefined
    // @uncrunch  	String  	
    ,street : undefined
};
/*
 KTools.getBounds() 
 */
var KGetBoundsOptions =
{
    //@uncrunch Boolean  	 true
    margin : true
    //@uncrunch  	Boolean  	 false
    ,padding : false
    //@uncrunch   	Boolean  	 false
    ,border : false
};
/*
KHScrollList opts?  javascript 
 */
var KHScrollListOptions =
{
    //@uncrunch  	Boolean  	 true  false 
    multiple : true
    //@uncrunch  	Integer  	 listcount 
    ,scrollcount : 5
    //@uncrunch  	Boolean  	 true 
    ,animation : true
    //@uncrunch
    ,_$P : ["KWidgetOptions"]
};
/*
  KIcon  opts? 
  javascript 
 */
var KIconOptions =
{
    //@uncrunch string  src  Node  Dom
    img : undefined
    //@uncrunch KPoint 
    ,anchor : undefined
    //@uncrunch KSize 	 imgHtml 
    ,size : undefined
    //@uncrunch String src
    ,shadow : undefined
    //@uncrunch KPoint 
    ,shadowAnchor : undefined
    //@uncrunch KSize 	 shadowHtml 
    ,shadowSize : undefined
    //@uncrunch String 
    ,snapIcon : undefined
    // @uncrunch 	String  	img  KMarker.setIconClass() 
    ,cssname : undefined
    //@uncrunch   	Boolean  	ie6 true
    ,disableIE6shadow : true
};
/*
  KInfoWindow  opts?  javascript 
 */
var KInfoWindowOptions =
{
    //@uncrunch String  	HTML
    title : ""
    //@uncrunch KHtmlContent  	HTML
    ,content : ""
    //@uncrunch KSize 
    ,size : undefined
    //@uncrunch KPoint 
    ,anchor : undefined
    //@uncrunch  	Boolean  	 true  
    ,cmarea : true
    // @uncrunch 	KIwCmData  	 undefined 
    ,cmdata : undefined
    //@uncrunch   	Any  	 undefined  
    ,extdata : undefined
};
/*

 */
var KIwCmData =
{
    //@uncrunch  	KPOInfo  	
    poi : undefined
    //@uncrunch  	KCallback  	 undefined  false  
    ,allinecbk: false
    //@uncrunch  	Boolean  	 true  
    ,navigator : true
};
/*
  KLabel  opts?  javascript 
 */
var KLabelOptions =
{
    //@uncrunch html String dom
    label : undefined
    //@uncrunch false
    ,defaultStyle : false
    //@uncrunch false ?
    ,wordwrap : false
    //@uncrunch HTML
    ,snapText : undefined
    //@uncrunch KPoint 
    ,anchor : undefined
    //@uncrunch 0
    ,transparence : 100.0
    //@uncrunch KPosition.RIGHTanchor
    ,pos : undefined
};
/*

 */
var KLightboxOptions =
{
    // @uncrunch 	Node  	 undefined
    element : undefined
    // @uncrunch 	Boolean  	 false  
    ,visible : false
    // 	@uncrunch String  	16gray
    ,bgcolor : "gray"
    // @uncrunch 	String  	
    ,bgimg : undefined
    //@uncrunch  
    ,alpha : 0.5
};
/*
  KLine  opts?  javascript 
 */
var KLineOptions =
{
    //@uncrunch KBrushOptions
    brush : undefined
    //@uncrunch KInfoWindow 
    ,infowin : undefined
    //@uncrunch  false
    ,editable : false
    //@uncrunch false
    ,path : false
    //@uncrunch true
    ,editHilite : true
    //@uncrunch
    ,hiliteBrush : undefined
    //@uncrunch String 	temp
    ,group : "temp"
    //@uncrunch  	Boolean  	ie6/7/8 false 
    ,disableIE678overlap : false
};
/*
 
 */
var KListItem =
{
    //@uncrunch  	Integer  	!  0 KList.insert() 
    index : 0
    //@uncrunch String 
    ,text : ""
    //@uncrunch String 
    ,kvalue : ""
    // @uncrunch 	Boolean  	 true KListOptions.deletable  KList 
    ,deletable : true
    // @uncrunch 	Boolean  	 true KListOptions.editable  KList 
    ,editable : true
    // @uncrunch 	Node  	!  Dom 
    ,node : undefined
    // @uncrunch 	Boolean  	 false insert() 
    ,selected : false
    //@uncrunch 	String  	!  KList 
    ,iconClass : undefined
    //@uncrunch  	String  	!  KHScrollList 
    ,itemClass : undefined
};
/*
KList opts?  javascript 
 */
var KListOptions =
{
    // @uncrunch 	Boolean  	 true false 
    editable : true
    //@uncrunch  	Boolean  	 true false 
    ,deleteable : true
	//@uncrunch	Boolean	  true   beforemove  remove()  remove() 
	,confirmdelete : true
    // @uncrunch 	Boolean  	 true false 
    ,sortable : true
    // @uncrunch 	Boolean  	 true  false 
    ,multiple : true
    //@uncrunch 	Boolean  	 true  multiple=false 
    ,deselect : true
    //@uncrunch   	Boolean  	 true  
    ,checkbox : true
    //@uncrunch  	Boolean  	 true 
    ,scroll2view : true
    //@uncrunch
    ,_$P : ["KWidgetOptions"]
};
/*
 KLocalsearch  opts?  javascript 
 */
var KLocalsearchOptions =
{
    //@uncrunch   	  	Node  	undefined
    mapcontainer : undefined
    //@uncrunch   	Boolean  	true
    ,initmap:true
    //@uncrunch  	String  	
    ,tipurl : undefined
    //@uncrunch  	String  	
    ,url : undefined
    //  @uncrunch	 KSender  	 undefined
    ,sender : undefined
    // @uncrunch 	KSearchbox  	 undefined
    ,searchbox : undefined
	//@uncrunch	KPrinter	 undefined
	,printer : undefined
    //@uncrunch
    ,_$P : ["KWidgetOptions"]
};
/*
 
 :wangzheng
 :1.0
 :2010-01-15
 :2010-01-16
 */
var KMapCtrlState =
{
    //@uncrunch 
    NORMAL : 1
    //@uncrunch 
    ,MEDIUM : 2
    //@uncrunch 
    ,MINI : 4
    //@uncrunch 
    ,HIDE : 8
};
/*
 KMapMarkers 
 */
var KMapMarkerInfo =
{
    // @uncrunch 	String	id
    nid : undefined
    //@uncrunch  	Integer	
    ,order : undefined
    // @uncrunch 	KHtmlContent	
    ,title : undefined
    // @uncrunch 	KHtmlContent	
    ,content : undefined
    //@uncrunch 	KOverlayType	
    ,type : undefined
	//@uncrunch  	KHtmlContent  	
	,img : undefined
    //@uncrunch     String  
    ,latlons : undefined
    //@uncrunch     String  JSON
    ,style : undefined
};
/*
 
 :wangzheng
 :1.0
 :2010-01-15
 :2010-01-16
 */
var KMapMode =
{
    //@uncrunch
    PAN : 'PAN'
    //@uncrunch
    ,ZOOMIN : 'ZOOMIN'
    //@uncrunch 
    ,ZOOMOUT : 'ZOOMOUT'
    //@uncrunch 
    ,LOOKUP : 'LOOKUP'
    //@uncrunch 
    ,BOOKMARK : 'BOOKMARK'
    //@uncrunch 
    ,MEASURE : 'MEASURE'
    //@uncrunch 
    ,DRAWLINE : 'DRAWLINE'
    //@uncrunch 
    ,DRAWAREA : 'DRAWAREA'
    //@uncrunch 
    ,SNAPSHOT : 'SNAPSHOT'
    //@uncrunch 
    ,DISABLE : 'DISABLE'
	//@uncrunch 
	,ROADLINE : "ROADLINE"
};
/*
 
 */
var KMapOptions =
{
    //@uncrunch  @uncrunch
    center : undefined
    //@uncrunch MIN_ZOOM_LEVELMIN_ZOOM_LEVELMAX_ZOOM_LEVEL
    ,zoom : 8
    //@uncrunch true
    ,click2center : true
    //@uncrunch MapCtrlState.NORMAL
    ,overview : undefined
    //@uncrunch 
    ,fishbone : undefined
    //@uncrunch true
    ,mousewheel : true
};
/*
  KMarker  opts?  javascript 
 */
var KMarkerOptions =
{
    //@uncrunch KIconOptions  KIcon
    icon : undefined
    //@uncrunch KLabelOptions 
    ,label : undefined
    //@uncrunch KInfoWindowOptions 
    ,infowin : undefined
    //@uncrunch Boolean true
    ,bouncy : true
    //@uncrunch Boolean false
    ,editable : false
    //@uncrunch Boolean true
    ,autohide : true
    //@uncrunch Boolean false
    ,hoverLabel : false
    //@uncrunch String 	temp
    ,group : "temp"
};
/*
 KNamedValue[]  
 */
var KMsgBoxButtons =
{
    //@uncrunch  	
    OK : [{name:"ok",kvalue:""}]
    //@uncrunch  	
    ,OKCancel : [{name:"ok",kvalue:""}, {name:"cancel", kvalue:""}]
    //@uncrunch  	
    ,YesNo : [{name:"yes",kvalue:""}, {name:"no",kvalue:""}]
    //@uncrunch  	
    ,YesNoCancel : [{name:"yes",kvalue:""}, {name:"no",kvalue:""}, {name:"cancel",kvalue:""}]
    //@uncrunch  	
    ,RetryCancel : [{name:"retry",kvalue:""}, {name:"cancel",kvalue:""}]
};
/*
KTools.showMsg()  opts 
 */
var KMsgBoxOpenOptions =
{
    //@uncrunch  	String  	
    theme : "mwp"
    //@uncrunch  	String  	 undefined   undefined 
    ,title : undefined
    //@uncrunch  	KNamedValue[]  	 KNamedValue.name  closedcbk  KNamedValue.kvalue  KMsgBoxButtons   KMsgBoxButtons.OK  0
    ,buttons : undefined
    //@uncrunch  	Integer  	 0 
    ,autoclose : 0
    //@uncrunch  	KCallback  	  undefined  * action String  closemode  * button KNamedValue  action=="button"   KTools.showMsg()  KMsgBox()  closed 
    ,closedcbk : undefined
    //@uncrunch  	Node  	 undefined   undefined 
    ,node : undefined
    //@uncrunch   	KBounds  	 node==undefined   KTools.getBounds(window) 
    ,range : undefined
    //@uncrunch  	KBubbleShowOptions  	 KBubble  undefined 
    ,buboptions : undefined
    //@uncrunch  	Integer  	20px
    ,cbmargin : 20
};
/*
    KMsgBox opts?  javascript  
 */
var KMsgBoxOptions =
{
    //@uncrunch
    _$P : ["KWidgetOptions"]
};
/**
 * 
 */
var KNamedValue =
{
    //@uncrunch  	String  	
    name : undefined
    //@uncrunch  	Any  	
    ,kvalue : undefined
};
/*
KNavsearch  opts?  javascript 
 */
var KNavsearchOptions =
{
    // @uncrunch 	Node  	undefined
    mapcontainer : undefined
    // @uncrunch  	Boolean  	true
    ,initmap : true
    //   @uncrunch	String  	
    ,url : undefined
    //   @uncrunch	String  	
    ,roadurl : undefined
    //  @uncrunch 	KCityListOptions  	
    ,cylopts : undefined
    //   @uncrunch	KStdSuggestOptions  	
    ,sugopts : undefined
    //  @uncrunch 	KStationListOptions  	
    ,slopts : undefined
    // 	 @uncrunch KSender  	 undefined
    ,sender : undefined
    //  @uncrunch 	KPrinter  	 undefined
    ,printer : undefined
    // @uncrunch  	KSearchbox  	 undefined
    ,searchbox : undefined
	//@uncrunch	KPrinter	 undefined
	,printer : undefined
    //@uncrunch
    ,_$P : ["KWidgetOptions"]
};
/*
 
 */
var KOverlayType =
{
    //@uncrunch 
    MARKER : 1
    //@uncrunch 
    ,POLYLINE : 2
    //@uncrunch  - 
    ,ROADLINE : 4
    //@uncrunch 
    ,AREA : 8
};
/*
KPageHeader  opts?  javascript 
*/
var KPageHeaderOptions =
{
    //@uncrunch     Boolean      true
    citychange : true
    //@uncrunch     Boolean      false
    ,weather : false
    //@uncrunch     Boolean      true
    ,account : true
    //@uncrunch     String      
    ,url : undefined
    //@uncrunch     String      
    ,hurl : undefined
    //@uncrunch     String      
    ,hturl : undefined
    //@uncrunch     String       #hturl# ()
    ,htutag : '#hturl#'
    //@uncrunch     KSearchboxOptions   
    ,shxopts : undefined
    //@uncrunch     KCityListOptions    
    ,cylopts : undefined
    //@uncrunch     KStdAccountOptions  
    ,accopts : undefined
    //@uncrunch     String       'ls' (ls    bs    navs   ns   bs	   bl    bst ',''bs,bl')
    ,defselect : 'ls'
    //@uncrunch     String[]      ['val1','val2']  []
    ,defsv : []
    //@uncrunch     KCityInfo   KCityListKSearchbox
    ,defcity : {name:"", latlon:"HETCUFZVVHUEE", level:8, province:"", ename:"beijing"}
    //@uncrunch     String      undefined
    ,instancename : undefined
};  
/*

 */
var KPOInfo =
{
    // @uncrunch 	String  	
    city : undefined
    // @uncrunch 	String  	
    ,name : undefined
    //  @uncrunch	String  	ID
    ,pid : undefined
    // @uncrunch	 String  	
    ,latlon : undefined
    // @uncrunch	KPOIType  	 KPOIType.NORMAL  
    ,type : undefined
	//@uncrunch	String	
	,address :undefined
	//@uncrunch	String	
	,phone : undefined
	//@uncrunch	String	id
	,uid:undefined
	//@uncrunch	Integer	
	,level:undefined
};
/*

 :
 :1.0
 :2010-04-29
 :2010-04-29
 */
var KPOIType =
{
    //@uncrunch 
    NORMAL : 1
    //@uncrunch 
    ,DRAGNODE : 2
    //@uncrunch 
    ,MIDNODE : 4
	//@uncrunch 
	,BUSTATION : 8
};
/*
 
 :wangzheng
 :1.0
 :2010-01-15
 :2010-01-16
 */
var KPosition =
{
    ////@uncrunch
    TOP : 1
    //@uncrunch
    ,BOTTOM : 2
    //@uncrunch
    ,LEFT : 4
    //@uncrunch
    ,RIGHT : 8
};
/*
 KPrinter.print()  opts   javascript 
 */
var KPrintOptions =
{
	//@uncrunch	KQueryOptions	
	queryopts : undefined
	// @uncrunch 	String[]  	 KMarker.toString()  KMarker.fromString() 
    ,markers : undefined
    // @uncrunch 	String[]  	 KLine.toString()  KLine.fromString() 
    ,lines : undefined
	//@uncrunch	String	1
	,resultnum : undefined
	//@uncrunch	Integer	1
	,pagenum : 1
};
/*
  KQuery.query()  opts   javascript 
 
 */
var KQueryOptions =
{
    //@uncrunch  	KQueryType  	
    type : undefined
    //@uncrunch   	KPOInfo  	
    ,ls : undefined
    //@uncrunch  	KPOInfo  	
    ,navorig : undefined
    // @uncrunch 	KPOInfo  	
    ,navdest : undefined
    // @uncrunch 	KPOInfo  	
    ,busorig : undefined
    // @uncrunch 	KPOInfo  	
    ,busdest : undefined
    // @uncrunch 	KPOInfo  	
    ,busline : undefined
    // @uncrunch 	KPOInfo  	
    ,bustation : undefined
    // @uncrunch    String  	
    ,mid : undefined
//    // @uncrunch 	KPOInfo  	
//    ,nb : undefined
    // @uncrunch 	KPOInfo  	
    ,center : undefined
	// @uncrunch 	Boolean  	 false 
	,highway : false
};
/*

*/
var KQueryType =
{
    // @uncrunch 	
    localsearch : "ls"
    // @uncrunch 	
    ,busearch : "bs"
    // @uncrunch 	
    ,busline : "bl"
    //@uncrunch 	
    ,bustation : "bst"
    // @uncrunch 	
    ,navsearch : "navs"
};
/*

 */
var KRouteInfo =
{
    // @uncrunch 	String	
    name : undefined
    // @uncrunch 	KQueryOptions	
    ,type : undefined
    //  @uncrunch	KQueryOptions	
    ,queryopts : undefined
    // @uncrunch	Integer	1
    ,pagenum : undefined
    // @uncrunch	Integer	1
    ,resultnum : undefined
};
/*

 */
var KRouteType =
{
    // @uncrunch 	
    BUS : "bs"
    // @uncrunch 	
    ,NAVIGATION : "navs"
};
/*
 KSearchbox opts?  javascript 
 */
var KSearchboxOptions =
{
    //@uncrunch Boolean  	true
    suggest:true
    //@uncrunch Boolean  	true
    ,demolist:true
    //@uncrunch customdemo  Boolean  HTML,false
    ,customdemo:false
    //@uncrunch KPosition  	KPosition.BOTTOM
    ,demopos:undefined
    //@uncrunch  	Boolean  	false
    ,citylist:false
    //@uncrunch  	KCallback  	 citylist  KCallback.fun  KCity.city()  undefined 
    ,cityfun : undefined
    // @uncrunch  	Boolean  	true
    ,autoquery : true
    // @uncrunch  	KCallback  	undefined KQueryOptions 
    ,preprocessFun : undefined
    // @uncrunch 	KStdSuggestOptions  	 Suggest  suggest 
    ,sugopts : undefined
    //@uncrunch  	KCityListOptions  	 citylist  
    ,cylopts : undefined
    //@uncrunch
    ,_$P : ["KWidgetOptions"]
	//@uncrunch Integer searchcheck=0check=1searchcheck=20 
	,check: 0
	//@uncrunch Object cookie{ls : "",bod : "",nod : "",nb : ""}lsbodnodnb"Cookiesundefined
	,defaultdemo:undefined,
	//@uncrunch Object undefined
	hints: undefined,
	//@uncrunch Object undefined
	txtlen: undefined,
	//@uncrunch Integer 3
	demos:3,
	//@uncrunch String ",",
	demohint:","
};
/**
 *  KSender   javascript 
 */
var KSenderOptions =
{
    //@uncrunch String  	
    url : undefined
    //@uncrunch
    ,_$P : ["KWidgetOptions"]
};
/*
  KSender.send()  opts   javascript 
 */
var KSendOptions =
{
    // @uncrunch 	KSendType  	 KSendType.all  
    sendtype : undefined
    // @uncrunch 	KQueryType  	 KManager.lastExecutedQuerier()  KQuery  KQueryType.localsearch 
    ,querytype : undefined
    // @uncrunch 	KNamedValue[]  	 undefined  
    ,sms : undefined
    //@uncrunch  	KNamedValue[]  	 undefined  
    ,email : undefined
    // @uncrunch 	KNamedValue[]  	GPS undefined  
    ,gps : undefined
	//@uncrunch 	KSendType	
	,selected : undefined
};
/**
 * 
 */
var KSendType =
{
    //@uncrunch  	all  	
    all : 1
    //@uncrunch  	none  	
    ,none : 2
    // @uncrunch 	sms  	
    ,sms : 4
    //@uncrunch  	mms  	
    ,mms : 8
    //@uncrunch 	email  	
    ,email : 16
    //@uncrunch  	gps  	gps
    ,gps : 32
    //@uncrunch  	car  	
    ,car : 64
};
/*
 KAccount.signin()  opts   javascript 
 */
var KSigninOptions =
{
    //@uncrunch  	String  	
    user : undefined
    // @uncrunch 	String  	
    ,pwd : undefined
};
/*
 KAccount.signout()  opts   javascript 
 */
var KSignoutOptions =
{
};
/*
KMap.snapshot()  opts 
 */
var KSnapshotOptions =
{
    // @uncrunch 	MPoint  	
    latlon : undefined
    // @uncrunch 	KSize  	
    ,size : undefined
    // @uncrunch 	Integer  	
    ,zoom : undefined
    // @uncrunch 	String  	jpg  png png 
    ,format : "png"
    //@uncrunch   	KCallback  	 undefined url
    ,oncomplete : undefined
};
/*
KStationListOptions  opts?  javascript 
 */
var KStationListOptions =
{
    //@uncrunch 	Node  	undefined
    mapcontainer :undefined
    //  @uncrunch	Boolean  	true
    ,initmap : true
    //  @uncrunch	String  	
    ,url : undefined
    //  @uncrunch	 Node  	 Dom  
    ,submitbtn : undefined
    //    @uncrunch		Boolean  	 false 
    ,citylist : false
    //   @uncrunch	 	KCityListOptions  	 citylist  
    ,cylopts : undefined
    // @uncrunch 	KQueryType  	 KQueryType.busearch  KQueryType.navsearch
    ,querytype : undefined
    // @uncrunch 	KSearchbox  	 undefined
    ,searchbox : undefined
    // @uncrunch 	KSearchbox  	 true
    ,origarea : true
    // @uncrunch 	KSearchbox  	 true
    ,destarea : true
    //@uncrunch   	Boolean  	 selectdone  true
    ,nonstop : true
    //@uncrunch   	Boolean  	/selectdone true 
    ,autoselect :true
    //@uncrunch   	Boolean  	 Hash  true
    ,changehash : true
    //@uncrunch  	Integer  	10
    ,pagesize : 10
    //@uncrunch  	Integer  	6
    ,pagecount : 6
    //@uncrunch   	Boolean  	 false 
    ,autoheight :false
	 //@uncrunch   	Boolean  	false
	 ,simplenoresult :false
    //@uncrunch
    ,_$P : ["KWidgetOptions"]
};
/*
KStdAccount  opts?  javascript 
 */
var KStdAccountOptions =
{
    //@uncrunch  	String  	http://www.mapbar.com/mapjson/checkLogin.jspuserNamepasswordrhttp://www.mapbar.com/mapjson/checkLogin.jsp?userName=panxin299&password=coki97410&r=0.9776952032384973
    url : "http://www.mapbar.com/mapjson/checkLogin.jsp"
    // @uncrunch 	String  	http://passport.mapbar.com/accounts/forgotpasswd.jsp
    ,pwdurl : "http://passport.mapbar.com/accounts/forgotpasswd.jsp"
	// @uncrunch 	String  	http://passport.mapbar.com/reg.jsp
    ,regurl : "http://passport.mapbar.com/reg.jsp"
	// @uncrunch 	Integer	360
	,timelen : 360
	//@uncrunch
    ,_$P : ["KWidgetOptions"]
};
/*
KStdFeedback  opts?  javascript 
*/
var KStdFeedbackOptions =
{
    // @uncrunch 		Node	undefined
    mapcontainer : undefined
    //@uncrunch  	String	 undefined 
    ,url :undefined
	//@uncrunch	Boolean	 false 
	,closebtn : false
    //@uncrunch
    ,_$P : ["KWidgetOptions"]
};
/*
 KStdGeocoder  opts?  javascript 
 */
var KStdGeocoderOptions =
{
	//@uncrunch 
    citylist : true
    //@uncrunch   	Boolean  	true
    ,district:true
    //@uncrunch   	Boolean  	true
    ,street:true
    //@uncrunch  	String  	
    ,url : ""
    //@uncrunch 	Node  	 undefined 
    ,mapcontainer : undefined
    //@uncrunch  	KCityListOptions  	 citylist  
    ,cylopts : undefined
    //@uncrunch
    ,_$P : ["KWidgetOptions"]
};
/*
KStdMapMarkers  opts?  javascript 
 */
var KStdMapMarkersOptions =
{
    //@uncrunch  	String	  undefined
    shareurl : undefined
	//@uncrunch 	Node	undefined
	,mapcontainer : undefined
	//@uncrunch	String	  undefined
	,loadurl : undefined
	//@uncrunch String  	  undefined
	,roadurl : undefined
	//@uncrunch  	String  	  undefined 
	,uploadurl : undefined
    //@uncrunch     String  undefined
    ,latlonurl : undefined
    //@uncrunch
    ,_$P : ["KWidgetOptions"]
    //@uncrunch Node 
    ,sharebtn : undefined
    //@uncrunch Node 
    ,clearbtn : undefined
    //@uncrunch Node 
    ,markbtn : undefined
    //@uncrunch Object 
    ,offset : {top : 0, left : 0}
    //@uncrunch Number zindex11
    ,zindex : 11
};
/*
KStdPrinter  opts?  javascript 
 */
var KStdPrinterOptions =
{
    // @uncrunch String  	
    lsurl : undefined
	//@uncrunch	String	
	,bsurl:undefined
	//@uncrunch	String	
	,blurl:undefined
	//@uncrunch	String	
	,bsturl:undefined
	//@uncrunch	String	
	,navsurl:undefined
};
/**
 * KStdSender  opts?  javascript 
 */
var KStdSenderOptions =
{
    // @uncrunch 	String  	
    previewurl : undefined
	//@uncrunch 	Integer	20
	,smslimit : 20
	//@uncrunch	Integer	7
	,smsinterval : 7
	//@uncrunch	KCallback	KCallback.fun  KAccount.account()  undefined 
	,signinfun : undefined
    //@uncrunch
    ,_$P : ["KWidgetOptions", "KSenderOptions"]
};
/*
 KSuggest  opts?  javascript 
 */
var KStdSuggestOptions =
{
    //@uncrunch String 	 pnode pnode  div  body 
    node : ""
    //@uncrunch Integer  	8
    ,listlimit:8
    //@uncrunch Integer  	200ms
    ,speed:200
    //@uncrunch Integer  	1
    ,charcount:1
    //@uncrunch  	String  	suggest
    ,url:""
    //@uncrunch Boolean  	true
    ,fullmatch:true
    // @uncrunch 	KCallback  	
    ,preprocessDataFun : undefined
    // @uncrunch 	Boolean  	 true 
    ,autocomplete : true
    // @uncrunch 	Boolean  	 true 
    ,cache : true
    // @uncrunch 	Integer  	 10  cache==true  
    ,cachelimit : 10
    //@uncrunch  	Boolean  	 false 
    ,autorevert : false
    //@uncrunch Integer  	 0
    ,minwidth:0
    //@uncrunch
    ,_$P : ["KWidgetOptions"]
};
/*
 KStdTabs opts?  javascript 
 */
var KStdTabsOptions =
{
    //@uncrunch Boolean  	false
    collapse : false
    //@uncrunch
    ,_$P : ["KWidgetOptions"]
};
/*
  KSuggest   javascript 
 */
var KSuggestInfo =
{
    //@uncrunch 	String 	
    text:undefined
    //@uncrunch 	Any 	
    ,kvalue:undefined
};
/*
  KTabs   javascript 
 */
var KTabItem =
{
    //@uncrunch 	Integer 	! 0insert() 
    index:0
    //@uncrunch 	String 	!  html  KTabItem  insert()  KTabItem 
    ,text:""
    //@uncrunch 		String 	
    ,kvalue:""
    //@uncrunch 	String 	!  html  KTabItem  insert()  KTabItem 
    ,content:""
    //@uncrunch 	Node 	!  Dom  insert() 
    ,tabDom : undefined
    //@uncrunch 	Node 	!  Dom  insert() 
    ,contentDom : undefined
    //@uncrunch 	String 	 id  Url  insert()  content 
    ,url:""
    //@uncrunch 	Boolean 	 false  insert()  
    ,selected:false
    //@uncrunch 	Boolean 	true
    ,once:true
};
/*

 */
var KWidgetFlag =
{
    // @uncrunch 	sbx  	Mapbar
    searchbox : "sbx"
    //@uncrunch 	sl  	
    ,stationlist : "sl"
    // @uncrunch 	ls  	
    ,localsearch : "ls"
    // @uncrunch 	bs  	
    ,busearch : "bs"
    // 	@uncrunch navs  	
    ,navsearch : "navs"
	// @uncrunch 	fdb	
    ,feedback : "fdb"
	// @uncrunch 	smm 
    ,mapmarkers : "smm"
};
/*
KWidget 
 */
var KWidgetOptions =
{
    //@uncrunch  	String  	 "mwp" 
    theme : "mwp"
    // @uncrunch 	Boolean  	 true  theme  false 
    ,userstyle : false
};
/*
 
 wangzheng
 1.0
 2010-1-15
 2010-4-26
 :
 opt#201012071501
 this._zindexMax
 bug#201012151652
  this._zindexMaxopera
 */
var KTools = new (function() {

    var _hiddenJDom;
    if ($.browser.msie) {
		$(function() {
			_hiddenJDom = $("<div style='position:absolute;left: -10000px;top:-10000px;'/>").appendTo(document.body);
		});
	}else{
		_hiddenJDom = $("<div style='position:absolute;left: -10000px;top:-10000px;'/>").appendTo(document.body);
	}
    // DTD @uncrunch
    this.isStrict = document.compatMode == "CSS1Compat";

    this._argsToArray = function(args)
    {
        return Array.prototype.slice.apply(args);
    };

    this._isElement = function(o)
    {
        if (typeof o == 'object' && o != null)
            return (o == window || o == document || o.nodeType == 1);
        else return false;
    };

    this._arrayContains = function(_array, value)
    {
        for (var i = 0; i < _array.length; i++)
            if (_array[i] == value) return true;
        return false;
    };

    this._arrayDel = function(_array, index)
    {
        if(!_array || !_array[index]) return _array;
        return _array.slice(0,index).concat(_array.slice(index+1,_array.length));
    };

    /**
     * Dom
     * @param node
     * @uncrunch
     */
    this.removeNode = function(node) {
    	if (!_hiddenJDom) {
			return;
		}
		var n = node;
		if (document.all) {
			if (n && n.tagName != 'BODY') {
				if (n.parentNode) n.parentNode.removeChild(n);
				_hiddenJDom.append(n);
				_hiddenJDom.remove(n);
			}
		} else if (n && n.tagName != 'BODY') {
			if (n.parentNode) {
				n.parentNode.removeChild(n);
			} else {
				_hiddenJDom.html("");
				_hiddenJDom.append(n);
				_hiddenJDom.remove(n);
			}
		}
		n = null;
	};

    /**
	 * @param _this
	 * @param fun
	 * @param time
	 * @uncrunch
	 */
    this.timeout = function(_this, fun, time)
    {
        if (typeof _this != 'object' || typeof fun != 'function' || typeof time != 'number') return;
        return setTimeout(function() {
            fun.apply(_this, this._argsToArray(arguments).slice(3));
        }, parseInt(time));
    };

    /**
     *
     * @param _this
     * @param fun
     * @param time
     * @uncrunch
     */
    this.interval = function(_this, fun, time)
    {
        if (typeof _this != 'object' || typeof fun != 'function' || typeof time != 'number') {
            return;
        }
        return setInterval(function() {
            fun.apply(_this, this._argsToArray(arguments).slice(3));
        }, parseInt(time));
    };

    /**
     * @param html
     * @uncrunch
     */
    this.measSize = function(html) {
		if (!_hiddenJDom) {
			return;
		}
		html = $(html);
		_hiddenJDom.append(html);
		return new KSize(html.outerWidth(true), html.outerHeight(true));
	};

    /**
	 * @param src
	 * @uncrunch
	 */
    this.imgSize = function(src)
    {
        var img = new Image();
        img.src = src;
        return new KSize(img.width, img.height);
    };
    /**
     * cookiescookiesecure=truecookiesname
     * @param name String 
     * @param value String 
     * @param opts KCookieOptions K_COOKIE
     * @uncrunch
     */
    this.setCookie = function(name, value, opts)
    {
        opts = this.copyOptions(opts, KCookieOptions);
        var cookie = name + "=" + escape(value) + ";";
        if (opts.expires)
        {
            var expires = new Date();
            expires.setTime(expires.getTime() + 1000 * 60 * 60 * 24 * opts.expires);
            cookie += "expires=" + expires.toGMTString() + ";";
        }
        if (opts.domain) cookie += "domain=" + opts.domain + ";";
        if (opts.path) cookie += "path=" + opts.path;
        document.cookie = cookie;
    };

    /**
     * cookiesname
     * @param name String 
     *  String namenull
     * @uncrunch
     */
    this.getCookie = function(name)
    {
        var value = document.cookie.match(new RegExp("(^| )" + name + "=([^;]*)(;|$)"));
        if (value != null) return unescape(value[2]);
        return null;
    };

    /**
     *  obj1-objN   target   obj1  target  target 
     * 1.options _$Poptions
     * 2.optionscopy 
     * @param target Object 
     * @uncrunch
     */
    this.copyOptions = function(target)
    {
        if (target == null && typeof target == 'object') return target;
        if (typeof target != 'object')  target = {};
        for (var i = 1; i < arguments.length; i++)
        {
            var orig = arguments[i];
            if (typeof orig == 'object')
            {
                if(orig._$P instanceof Array)
                {
                    for(var m = 0; m < orig._$P.length; m++) $.extend(orig, eval(orig._$P[m]));
                    delete orig._$P;
                }
                for (var i in orig)
                {
                    var origI = orig[i];
                    if (typeof target[i] == 'undefined')
                    {
                        if (typeof origI == 'object' && origI != null)
                        {
                            //KObject
                            if (origI.isKClassO && origI.superclassOf(KObject))
                                target[i] = origI.clone();
                            else
                                target[i] = origI;
                        } else  target[i] = origI;
                    }
                }
            }
        }
        return target;
    };

    /**
     * range  element   rect  opts  
     * @param element KBounds  
     * @param rect KSize  
     * @param range KBounds  
     * @param opts KCheckSpaceOptions
     * @uncrunch
     */
    this.checkSpace = function(element, rect, range, opts)
    {
        if(!(element instanceof KBounds) || !(rect instanceof KSize) || !(range instanceof KBounds)) return null;
        opts = KTools.copyOptions(opts, KCheckSpaceOptions);
        var tpos = KPosition.TOP|KPosition.BOTTOM|KPosition.LEFT|KPosition.RIGHT;
        if(opts.pos == undefined) opts.pos = tpos;
        var _poss = [KPosition.BOTTOM, KPosition.RIGHT, KPosition.LEFT, KPosition.TOP];
        var _poss_ = ["bottom", "right", "left", "top"];
        var _4pos = {bottom : undefined, right : undefined, left : undefined, top : undefined};
        for(var i = 0; i < _poss.length; i++)
        {
            if((opts.pos&_poss[i]) != _poss[i]) continue;
            var _ops = _poss[i];
            var _ops_ = _poss_[i];
            _4pos[_ops_] = {max:null,min:null,size:null,usable:false};
            var _bounds = new KBounds(new KPoint(0,0), new KPoint(0,0));
            var _size = null;

            if (_ops == KPosition.BOTTOM || _ops == KPosition.TOP)
            {
                _bounds.min.x = element.min.x - (rect.width - opts.offsetx);
                _bounds.max.x = element.max.x + (rect.width - opts.offsetx);
                if (_ops == KPosition.BOTTOM) {
                    _bounds.min.y = element.max.y + opts.marginy;
                    _bounds.max.y = _bounds.min.y + rect.height;
                } else {
                    _bounds.max.y = element.min.y - opts.marginy;
                    _bounds.min.y = _bounds.max.y - rect.height;
                }
            } else if (_ops == KPosition.LEFT || _ops == KPosition.RIGHT) {
                _bounds.min.y = element.min.y - (rect.height - opts.offsety);
                _bounds.max.y = element.max.y + (rect.height - opts.offsety);
                if (_ops == KPosition.RIGHT) {
                    _bounds.min.x = element.max.x + opts.marginx;
                    _bounds.max.x = _bounds.min.x + rect.width;
                } else {
                    _bounds.max.x = element.min.x - opts.marginx;
                    _bounds.min.x = _bounds.max.x - rect.width;
                }
            }
            _4pos[_ops_].max = _bounds;
            _bounds = range.intersect(_bounds);
            _size = _bounds.intersect(new KBounds(_bounds.min.x + "," + _bounds.min.y + "," + rect.width + "," + rect.height)).size();
            if (_size.width >= rect.width && _size.height >= rect.height) _4pos[_ops_].usable = true;
            _4pos[_ops_].min = _bounds;
            _4pos[_ops_].size = _size;
        }
        return _4pos;
    };
    /**
     * domHTML
     * @param dom
     * :Dom 
     * @uncrunch
     */
    this.domHTML = function(dom)
    {
        if (this._isElement(dom))
        {
            dom = $(dom);
            if(!dom.parent()[0]) $(dom).wrap("<div></div>");
            return dom.parent().html();
        }
    };

    /**
     * name=value&x=y    name  value
     * @param str
     * @param name
     */
    this._getParam = function(str, name)
    {
        if (typeof str != 'string' || typeof name != 'string' || str.length < 1 || name.length < 1) return "";
        var i = str.indexOf(name + "=");
        if (i != -1) i += name.length + 1;
        str = str.substring(i);
        var j = str.indexOf("&");
        if (j == -1)
            return str;
        else
            return str.substring(0, j);
    };

    var ua = navigator.userAgent.toLowerCase();
    var s = null;
    //@uncrunch
    this.isIE6 = false;
    if (s = ua.match(new RegExp("msie ([\\d.]+)")))  this.isIE6 = (parseInt(s[1]) == 6);

    /**
     *  dom document dom  window 
     * @param dom Node 
     * @param optsKGetBoundsOptions 
     * @return KBounds 
     * @uncrunch
     */
    this.getBounds = function(dom, opts)
    {
        if(this._isElement(dom))
        {
            opts = this.copyOptions(opts, KGetBoundsOptions);
            var _omargin = !opts.margin;
            var _opadding = !opts.padding;
            var _oborder = !opts.border;
            var jDom = $(dom);
            var left = jDom.scrollLeft();
            var top = jDom.scrollTop();
            var width = jDom.width();
            var height = jDom.height();
            if(dom != window && dom != document)
            {
                left = jDom.offset().left;
                top = jDom.offset().top;

                if(!opts.margin)//margin
                {
                    width = jDom.outerWidth(true);
                    height = jDom.outerHeight(true);
                    left -= (width - jDom.outerWidth()) / 2;
                    top -= (height - jDom.outerHeight()) / 2;
                } else {
                    if(!opts.border) {//border
                        width = jDom.outerWidth();
                        height = jDom.outerHeight();
                    } else {
                        var _innerW = jDom.innerWidth();
                        var _innerH = jDom.innerHeight();
                        left += (jDom.outerWidth() - _innerW) / 2;
                        top += (jDom.outerHeight() - _innerH) / 2;
                        if(!opts.padding) {//padding
                            width = _innerW;
                            height = _innerH;
                        } else {
                            left += (_innerW - width) / 2;
                            top += (_innerH - height) / 2;
                        }
                    }
                }
            }
            return new KBounds(new KPoint(left, top), new KPoint(left + width, top + height));
        } else {
            return new KBounds(new KPoint(0,0), new KPoint(0,0));
        }
    };

    /**
     *  optionsType  element attributes  opts    opts  
     * @param opts Object 
     * @param element Node 
     * @param optionsType Type  optionsType 
     * @return Object
     * @uncrunch
     */
    this.copyAttr2Options = function(opts, element, optionsType)
    {
        if(!this._isElement(element) || typeof optionsType != "object") return {};
        if(typeof opts != 'object') opts = {};
        var eDom = $(element);
        for(var i in optionsType)
        {
            if(typeof opts[i] == 'undefined' && typeof eDom.attr(i) != "undefined")
            {
                if(typeof optionsType[i] == 'number')
                {
                    opts[i] = eDom.attr(i) * 1;
                } else if(typeof optionsType[i] == 'boolean') {
                    opts[i] = ((eDom.attr(i) + "").toLowerCase() == "true");
                } else {
                    opts[i] = eDom.attr(i);
                }
            } else {
                opts[i] = optionsType[i];
            }
        }
        return opts;
    };

    /**
     *  Options  opts2  opts1 
     * @param opts1 Options 
     * @param opts2 Options 
     * @return Options  opts2  opts1 
     * @uncrunch
     */
    this.compareOptions = function(opts1, opts2)
    {
        var opts = {};
        if(typeof opts2 == 'object')
        {
            if(typeof opts1 != 'object') opts1 = {};
            for(var i in opts2)
            {
                if(typeof opts2[i] === "object" && opts2[i].equals)
                {
                    if(!opts2[i].equals(opts1[i])) opts[i] = opts2[i];
                } else if(opts2[i] != opts1[i]) {
                    opts[i] = opts2[i];
                }
            }
        }
        return opts;
    };
    /**
     *  HTML 
     * @param String
     * @return String
     * @uncrunch
     */
    this.removeHTMLTag = function(s) {
        var r = new RegExp("<.*?>|\r|\n","gi");
        return function(s) {
            return s.replace(r,"");
        };
    }();

    //@uncrunch
    this._zindexMax = 99999;//2000000000;2147483520 2147483584 2147483584; 
    //Opera doesn't support bigger value
	
    var _lightBoxElement = undefined;
    var _lightBoxDom = undefined;
	var _lightBoxDoms = {};

	//dsl
    var _lightBoxDocResizeFun = function() {
        KTools.lightbox({visible:true});
    };

//	this._tempzindex = this._zindexMax;
    /**
     *  Light Box 
     * element
     * @param opts KLightboxOptions 
     * @uncrunch
     */
    this.lightbox = function(opts)
    {
        var _bgcolor = opts ? opts.bgcolor : undefined;
        var _bgimg = opts ? opts.bgimg : undefined;
        var _alpha = opts ? opts.alpha : undefined;

        opts = KTools.copyOptions(opts, KLightboxOptions);
        if(opts.visible)
        {
            //lightBox div body
            if(!_lightBoxDom) _lightBoxDom = $("<div style=\"position:absolute;left:0px;top:0px;margin:0px;padding:0px;border:none;z-index:"+(this._zindexMax - 1)+";display:none;\"></div>").appendTo(document.body).get(0);
            if(KTools.isIE6) $(_lightBoxDom).bgiframe();

            if(opts.element && _lightBoxElement != opts.element)
            {
                if(_lightBoxElement) $(_lightBoxElement).css({"z-index": _lightBoxElement._oldZIndex});
                _lightBoxElement = opts.element;
                _bgcolor = opts.bgcolor;
                _bgimg = opts.bgimg;
                _alpha = opts.alpha;
            }
            if(_alpha) $(_lightBoxDom).css("opacity", ""+opts.alpha).css("*filter", "Alpha(Opacity="+(opts.alpha * 100)+")");
            if(_bgcolor) $(_lightBoxDom).css("background-color", "" + opts.bgcolor);
            if(typeof _bgimg == "string") $(_lightBoxDom).css("background", "url(\""+opts.bgimg+"\") repeat scroll 50% 50% "+opts.bgcolor+"");
            //lightBox div
            if(_lightBoxElement)
            {

				if(!_lightBoxElement._oldZIndex) _lightBoxElement._oldZIndex = $(_lightBoxElement).css("z-index");
                $(_lightBoxElement).css({"z-index": "" + (this._zindexMax), "position":"absolute"});
                $(_lightBoxDom).hide();
                var width = $(document).width();
                var height = $(document).height();
                if(KTools.isIE6)
                {
	                width = $(document.body).outerWidth(true);
	                height = $(document.body).outerHeight(true);
	                if(width < $(window).width()) width = $(window).width();
	                if(height < $(window).height()) height = $(window).height();
                }
                $(_lightBoxDom).css({"width": width + "px", "height": height + "px"}).show();
            }
            KEvent.bind(_lightBoxDom, "click", KTools._stopPropagation);
            if(_lightBoxDocResizeFun._binded != true)
            {
                KEvent.bind(window, "resize", _lightBoxDocResizeFun);
                _lightBoxDocResizeFun._binded = true;
            }
        } else {
            if(opts.element && _lightBoxElement != opts.element) return;
            if(_lightBoxDocResizeFun._binded === true)
            {
                KEvent.unbind(window, "resize", _lightBoxDocResizeFun);
                _lightBoxDocResizeFun._binded = false;
            }
            //
            if(_lightBoxElement && _lightBoxDom)
            {
                $(_lightBoxElement).css("z-index", _lightBoxElement._oldZIndex);
                _lightBoxElement = undefined;
                $(_lightBoxDom).hide();
            }
        }
    };
    var _scrollDoms = {};
    /**
     *  element  view  view   element  
     * @param element Node 
     * @param view Node 
     * @param speed Speed "slow", "normal", "fast"
     * @uncrunch
     */
    this.scrollIntoView = function(element, view, speed, moreX, moreY)
    {
        if(!element || !view) return;
        element = $(element);
        view = $(view);
        if(typeof view.get(0)._$id === "undefined") view.get(0)._$id = KTools.timeCode();
        if(_scrollDoms[view.get(0)._$id])
        {
            view.stop();
            delete _scrollDoms[view.get(0)._$id];
        }
        _scrollDoms[view.get(0)._$id] = true;
        var _scrollBounds = KTools.getBounds(view[0]);
        var _focusBounds = KTools.getBounds(element[0], {margin:false});
		var _scrollSize = _scrollBounds.size();
		var _focusSize = _focusBounds.size();
        if(!_scrollBounds.contains(_focusBounds))
        {
            var _x = 0, _y = 0;
			_x = _scrollBounds.min.x - _focusBounds.min.x;
            if(_scrollSize.width > _focusSize.width && _scrollBounds.max.x < _focusBounds.max.x) _x = _scrollBounds.max.x - _focusBounds.max.x;
            _y = _scrollBounds.min.y - _focusBounds.min.y;
            if(_scrollSize.height > _focusSize.height && _scrollBounds.max.y < _focusBounds.max.y) _y = _scrollBounds.max.y - _focusBounds.max.y;
            if(_x != 0 || _y != 0) view.animate({scrollTop:view.scrollTop() - _y, scrollLeft:view.scrollLeft() - _x}, speed);
        }
    };

    var _msgDomStr = '<div class="mwp_mbx" style="top:-10000px;left:-100px;"><div class="mwp_bub" style="z-index:'+(this._zindexMax - 5)+';"><div class="mwp_bub_c"><h3 class="mwp_mbx_t"></h3><div class="mwp_mbx_c"></div><div class="mwp_mbx_ba"></div></div><span class="mwp_bub_a mwp_bub_ar"></span><span class="mwp_bub_clb"><a href="javascript:void(0);" title=""></a></span></div><div class="mwp_mbx_s" style="z-index:'+(this._zindexMax - 6)+';;"></div></div>';
    var _msgCase = {};
    var _msgResizeFun = function(){
        if(_msgCase)
        {
            for(var i in _msgCase)
            {
                if(_msgCase[i]) _msgCase[i]._obj.layout();
            }
        }
    };

    /**
     *  msg  id   KTools.hideMsg() 
     *   
     *  KMsgBox  KTools.hideMsg() 
     *  msg  Node  KTools.hideMsg() 
     *  KMsgBoxOpenOptions.node 
     * @param msg KHtmlContent 
     * @param opts KMsgBoxOpenOptions 
     * @return String  id
     * @uncrunch
     */
    this.showMsg = function(msg, opts)
    {
        if(typeof msg === 'string' || KTools._isElement(msg))
        {
            var _parent = undefined;
            if(KTools._isElement(msg))
            {
                _parent = $(msg).parent();
            }
            if(!opts) opts = {};
            if(!opts.theme) opts.theme = KMsgBoxOpenOptions.theme;
            var mb = new KMsgBox($(_msgDomStr).appendTo(document.body)[0], {theme:opts.theme});
            if(!opts.lightbox && _lightBoxElement){
				$(mb.dom()).css("z-index", ++this._zindexMax);
			} 
            KEvent.bind(window,"resize", _msgResizeFun);
            _msgCase[mb.id()] = {_obj:mb, _parent:_parent, msg:msg};
            KEvent.bind(mb, "closed", function(evt, _obj, action, button) {
                KTools.hideMsg(evt.data._id);
                if(evt.data.closedcbk) evt.data.closedcbk(action, button);
                KEvent.clear(mb);
            }, {_id:mb.id(), closedcbk:opts.closedcbk});
            _msgCase[mb.id()].timeout = setTimeout(function(){mb.open(msg, opts);});
            return mb.id();
        }
    };

    /**
     *  msgid 
     * @param msgid
     * @uncrunch
     */
    this.hideMsg = function(msgid)
    {
        var mb = _msgCase[msgid];
        delete _msgCase[msgid];
        if(mb)
        {   
			clearTimeout(mb.timeout);
			mb._obj.close();
            if(mb._parent) mb._parent.append(mb.msg);
            mb._obj.finalize();
        }
    };
    
    /**
     *  msgid 
     * @param msgid
     * @uncrunch
     */
    this.resizeMsg = function(msgid)
    {
        var mb = _msgCase[msgid];
        mb._obj.layout();
    };

    /**
     * 
     * @param msgid
     * @uncrunch
     */
    this.getMsg = function(msgid)
    {
        var mb = _msgCase[msgid];
        if(mb) return mb._obj;
    };

    var _codeIndex = 0;
    /**
     *  @uncrunch
     */
    this.timeCode = function()
    {
        return new Date().getTime() + "_" + (_codeIndex++);
    };

    /**
     *  url 
     * @param name String 
     * @param url String 
     * @uncrunch
     */
    this.addFavorite = function(name, url, node)
    {
        if (window.sidebar) {
            window.sidebar.addPanel(name, url, "");
        } else if (document.all) {
            window.external.AddFavorite(url, name);
        } else if (window.opera && window.print) {
			var mbm = node;
			if (mbm) {
				mbm.setAttribute('rel', 'sidebar');
				mbm.setAttribute('href', url);
				mbm.setAttribute('title', name);
				mbm.click();
			}
        } else {
			return;
		}
    };

    /**
     * HTML
     * @param html String html
     * @uncrunch
     */
    this.text = function(html)
    {
        var r = new RegExp("<.*?>|\r|\n","gi");
        return function(html) {
            return html.replace(r,"");
        };
    }();

    this._stopPropagation = function(event)
    {
        event.stopPropagation();
        return false;
    };

    /**
     * 
     * @uncrunch
     */
    this.finalize = function()
    {
        for(var i in _msgCase) this.hideMsg(i);
        _msgCase = null;
        _hiddenJDom = null;
        _scrollDoms = null;
        KEvent.unbind(window,"resize", _msgResizeFun);
    };

    /**
     * 
     * @return KObject[]
     * @uncrunch
     */
    this.dependent = function()
    {
        return [KCookieOptions, KSize, KPosition, KPoint, jQuery, KBounds, KObject, KGetBoundsOptions, KCheckSpaceOptions, KLightboxOptions, KMsgBox, KMsgBoxOpenOptions];
    };
})();
/*
 
 :wangzheng
 :1.0
 2010-1-15
 2010-01-26
 */
var KObject = KClass.create("KObject");

/**
 * 
 * KObject Class KObject
 * @uncrunch
 */
KObject.prototype.getType = function()
{
    return this.constructor;
};

/**
 * 
 * String KObject
 * @uncrunch
 */
KObject.prototype.getTypeString = function()
{
    return this.className;
};

/**
 * 
 * @uncrunch
 */
KObject.prototype.clone = function()
{
};

/**
 * objtrue
 * @uncrunch
 */
KObject.prototype.equals = function(obj)
{
    return this == obj;
};

/**
 * @overwrite
 * @uncrunch
 */
KObject.prototype.toString = function()
{
	return "";
};

/**
 * 
 * @uncrunch
 */
KObject.prototype.finalize = function()
{
    for(var i in this)
    {
        this[i] = null;
    }
};



/**
 * @uncrunch
 */
KObject.prototype.dependent = function()
{
    return [KClass];
};
/*
 Dom
 wangzheng
 1.0
 2010-1-15
 2010-1-26
 */
var KEvent = new (function() {

    var _tMaplet = (typeof Maplet) == 'function';
    //adaptersevtname->{}[]
    var _funRm = function(obj, fun)
    {
        for (var i = 0; i < obj.length; i++)
            if (obj[i].fun == fun)
            {
                obj.splice(i, 1);
                return;
            }
    };

    //obj -> string[] evtname
    var _objArray = {};

    /**
     * @return 
     * @uncrunch
     */
    this.version = function()
    {
        return "1.0";
    };

    /**
     * @return 
     * @uncrunch
     */
    this.cnname = function()
    {
        return "";
    };

    /**
     * Dom
     * @param obj Object KMapKEvent.bind(KMap.maplet(mapcontainer), "click", eventHandler)
     * @param evtname String 
     * @param fun Function 
     * @param data ?
     * @param thisobj ?
     * @uncrunch
     */
    this.bind = function(obj, evtname, fun, data, thisobj)
    {
        
        var _tKMap = (typeof KMap) == 'object';
        if (typeof obj != 'object' || obj == null || typeof evtname != 'string' || typeof fun != 'function') return;
        //dom
        if (KTools._isElement(obj) || obj.jquery)
        {
            //Jquery
            $(obj).bind(evtname, data, fun);
        }  else if (_tMaplet && (obj._isSelfEvt == true || obj instanceof Maplet))//bind
        {
            if (_tKMap && (obj == KMap || obj instanceof Maplet))
            {
                KMap.bind(obj, evtname, fun, data, thisobj);
            } else
                obj.bind(obj, evtname, fun, data, thisobj);
        } else {
            //
            if (!obj.adapters) obj.adapters = {};
            if (!obj.adapters[evtname]) obj.adapters[evtname] = [];
            if (!KTools._arrayContains(obj.adapters[evtname], fun)) obj.adapters[evtname].push({fun:fun, data:data, thisobj:thisobj});
        }
        if(typeof obj._eId == 'undefined') obj._eId = KTools.timeCode();
        if (!_objArray[obj._eId]) _objArray[obj._eId] = {obj:obj, evts:[]};
        _objArray[obj._eId].evts.push(evtname);
    };

    /**
     * 
     * @param obj Object 
     * @param evtname String 
     * @param fun Function 
     * @uncrunch
     */
    this.unbind = function(obj, evtname, fun)
    {
        var _tKMap = (typeof KMap) == 'object';
        if (typeof obj != 'object' || typeof evtname != 'string' || typeof fun != 'function') return;
        //dom
        if (KTools._isElement(obj) || obj.jquery)
        {
            $(obj).unbind(evtname, fun);
            return;
        }
        //unbind
        if (_tMaplet && _tKMap && ((obj == KMap && obj._isSelfEvt == true) || obj instanceof Maplet))
        {
            if (obj == KMap) obj = KMap.getCurrentMap();
            if (evtname == 'mapinit') obj = KMap;
            if (KMap.adapters[obj] && KMap.adapters[obj][evtname])
                _funRm(KMap.adapters[obj][evtname], fun);
        } else
            if (obj.adapters && obj.adapters[evtname]) _funRm(obj.adapters[evtname], fun);
    };

    /**
     * evtnameobj
     * @param obj Object 
     * @param evtname String 
     * @uncrunch
     */
    this.clear = function(obj, evtname)
    {
        var _tKMap = (typeof KMap) == 'object';
        if (typeof obj != 'object') return;
        //dom
        if (KTools._isElement(obj) || obj.jquery)
        {
            if (typeof evtname == 'string')
                $(obj).unbind(evtname);
            else
                $(obj).unbind();
            return;
        }
        if (_tMaplet && _tKMap && ((obj == KMap && obj._isSelfEvt == true) || obj instanceof Maplet))
        {
            if (obj == KMap) obj = KMap.getCurrentMap();
            if (evtname == 'mapinit') obj = KMap;
            if (KMap.adapters[obj])
                if (typeof evtname == 'string')
                    delete KMap.adapters[obj][evtname];
                else
                    for (var i in KMap.adapters[obj]) delete KMap.adapters[obj][i];
        } else {
            if (obj.adapters)
                if (typeof evtname == 'string')
                    delete obj.adapters[evtname];
                else
                    for (var i in obj.adapters) delete obj.adapters[i];
        }
    };

    /**
     * evtname
     * @param obj Object 
     * @param evtname String 
     * ... thisObj, ...
     * @uncrunch
     */
    this.trigger = function(obj, evtname)
    {
        var _tKMap = (typeof KMap) == 'object';
        if (typeof obj != 'object' || typeof evtname != 'string') return;
        //dom
        if (KTools._isElement(obj) || obj.jquery)
        {
            $(obj).trigger(evtname, KTools._argsToArray(arguments).slice(2));
            return;
        }
        if (_tMaplet && _tKMap && ((obj == KMap && obj._isSelfEvt == true) || obj instanceof Maplet))
        {
            if (obj == KMap) obj = KMap.getCurrentMap();
            if (evtname == 'mapinit') obj = KMap;
            if (KMap.adapters[obj] && KMap.adapters[obj][evtname])
            {
                var funs = KMap.adapters[obj][evtname];
                for (var i = 0; i < funs.length; i++)
                {
                    var args = [{data:funs[i].data}];
                    args = args.concat(KTools._argsToArray(arguments).slice(2))
                    if (funs[i].thisobj)
                        funs[i].fun.apply(funs[i].thisobj, args);
                    else
                        funs[i].fun.apply(obj, args);
                }
            }
        } else {
            if (obj.adapters && obj.adapters[evtname])
            {
                var funs = obj.adapters[evtname];
                for (var i = 0; i < funs.length; i++)
                {
                    var args = [{data:funs[i].data}];
                    args = args.concat(KTools._argsToArray(arguments).slice(2))
                    if (funs[i].thisobj)
                        funs[i].fun.apply(funs[i].thisobj, args);
                    else
                        funs[i].fun.apply(obj, args);
                }
            }
        }
    };

    /**
     * 
     * @uncrunch
     */
    this.finalize = function()
    {
        for (var i in _objArray)
        {
            if (KTools._isElement(_objArray[i].obj) || _objArray[i].obj.jquery) {
                for (var j = 0; j < _objArray[i].evts.length; j ++) {
                    $(_objArray[i].obj).unbind(_objArray[i].evts[j]);
                }
            } else {
                for (var j = 0; j < _objArray[i].evts.length; j ++) this.clear(i, _objArray[i].evts[j]);
            }
        }
        _objArray = null;
    };
    /**
     * 
     * @return KObject[]
     * @uncrunch
     */
    this.dependent = function()
    {
        return [KTools, jQuery];
    };
})();
/*
 Hash
 :wangzheng
 1.0
 :2010-1-25
 :2010-1-25 14:15
 */
var KUrlHash = KClass.create("KUrlHash", KObject);

/**
 *  KUrlHash 
 */
KUrlHash.initialize = function()
{
    //url:key -> value
    this._UrlHash = {};
};

/**
 *  KUrlHash 
 * @param keys String 
 * KUrlHash 
 * @uncrunch
 */
KUrlHash.parseKeys = function(keys)
{
    if (typeof keys != 'string' || keys.length < 1) return null;
    var obj = new KUrlHash();
    var keys = keys.split(",");
    for (var i = 0; i < keys.length; i ++)
        obj._UrlHash[keys[i]] = "";
    return obj;
};

/**
 * Hash KUrlHash 
 * @param hash hashString 
 * KUrlHash 
 * @uncrunch
 */
KUrlHash.parseByHash = function(hash, decode)
{
    if (typeof hash != 'string' || hash.length < 1) return null;
	if(typeof decode != "boolean") decode = true;
    var obj = new KUrlHash();
    hash = hash.replace(/^\#/, "");
	//if(decode) hash = decodeURIComponent(decodeURIComponent(hash));
    hash = hash.split("&");
    for (var i = 0; i < hash.length; i ++)
    {
		if(decode){
			hash[i] = decodeURIComponent(decodeURIComponent(hash[i]));
		}
        var _hash = hash[i].split("=");
        if (_hash[0])
        {
            obj._UrlHash[_hash[0]] = "";
            if (_hash[1])
            {
                obj._UrlHash[_hash[0]] = _hash[1];
            }
        }
    }
    return obj;
};

/**
 *  url  encodeURIComponent() 
 * @param url String 
 * @return String  url 
 * @uncrunch
 */
KUrlHash.encode = function(url)
{
	return KUrlHash.parseByHash(url, false).toString();
};

/**
 *  url 
 * @param url String 
 * @return String  url 
 * @uncrunch
 */
KUrlHash.decode = function(url)
{
	return KUrlHash.parseByHash(url, true).toString(false);
};

/**
 *  key 
 * @param key String 
 * @param value String 
 * @uncrunch
 */
KUrlHash.prototype.setKey = function(key, value)
{
    if (typeof key != 'string') return;
	if(typeof value == "undefined") value = "";
    this._UrlHash[key] = new String(value);
};

/**
 * 
 * @return String
 * @uncrunch
 */
KUrlHash.prototype.keys = function()
{
    var _key = [];
    for(var i in this._UrlHash)
    {
        _key.push(i);
    }
    return _key.join(",");
};

/**
 *  key  null
 * @param key String 
 * @return  String 
 * @uncrunch
 */
KUrlHash.prototype.value = function(key)
{
    if (typeof key != 'string') return null;
    if (this._UrlHash[key])  return this._UrlHash[key];
    return null;
};

/**
 *  true
 * @param key String 
 * @uncrunch
 */
KUrlHash.prototype.containsKey = function(key)
{
    if (typeof key != 'string') return false;
    return (typeof this._UrlHash[key] == 'string');
};

/**
 *  key 
 * @param key String 
 * @uncrunch
 */
KUrlHash.prototype.remove = function(key)
{
    if (typeof key != 'string')
        this._UrlHash = {};
    else delete this._UrlHash[key];
};

/**
 *  keys 
 * @param keys String 
 * @return Boolean
 * @uncrunch
 */
KUrlHash.prototype.equalsKeys = function(keys)
{
    return (this.keys().split(",").sort().join(",") === keys.split(",").sort().join(","));
};

/**
 * @overwrite
 * @uncrunch
 */
KUrlHash.prototype.equals = function(other)
{
    if(other instanceof KUrlHash)
    {
        return this.equalsKeys(other.keys()) && (this.toString().split("&").sort().join("&") === other.toString().split("&").sort().join("&"));
    }
    return false;
};

/**
 * @return url hash
 * @uncrunch
 */
KUrlHash.prototype.toString = function(encode)
{
	if(typeof encode != "boolean") encode = true;
    var _keyValue = [];
    for(var i in this._UrlHash)
    {
		var valueI = this._UrlHash[i];
		if(encode) valueI = encodeURIComponent(encodeURIComponent(valueI));
        _keyValue.push(i + "=" + valueI);
    }
    return _keyValue.join("&");
};

/**
 * @overwrite
 * @uncrunch
 */
KUrlHash.prototype.clone = function()
{
    var _new = new KUrlHash();
    _new._UrlHash = {};
    for(var i in this._UrlHash) _new._UrlHash[i] = this._UrlHash[i];
    return _new;
};

/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KUrlHash.prototype.dependent = function()
{
    return [KObject];
};
/*
 AjaxScript
 wangzheng
 1.0
 2010-01-20
 2010-01-20
 */
var KHistory = new (function() {
    var _iframDom = null;

    if($.browser.msie)
    {
        $(window).ready(function(){
            _iframDom = $('<iframe name="historyFrame" width="0" height="0" frameborder="no" border="0" MARGINWIDTH="0" MARGINHEIGHT="0" SCROLLING="no"></iframe>').appendTo(document.body);
            KEvent.bind(KListener, "hashchanged", function(evt, hashobj, self) {
                if(self != true)
                {
                    historyFrame.document.open('text/html');
                    historyFrame.document.write('<html><head></head><body onload = "window.parent.KListener.setHash(window.parent.KUrlHash.parseByHash(it.value), true, true, true);"><input name="it" value="'+hashobj.toString()+'"/></body></html>');
                    historyFrame.document.close();
                }
            });
        });
    }
    /**
     * @return 
     * @uncrunch
     */
    this.version = function()
    {
        return "1.0";
    };

    /**
     * @return 
     * @uncrunch
     */
    this.cnname = function()
    {
        return "";
    };
    /**
     * 
     * @param hashstr String Hash
     * @uncrunch
     */
    this.add = function(hashstr)
    {
//        if (typeof hashstr == 'string' && hashstr != _historyList[_historyList.length - 1])
//        {
//            if (_historyList.length > _nowIndex + 1)
//                _historyList.splice(_nowIndex + 1, _historyList.length - _nowIndex - 1);
//            _historyList.push(hashstr);
//            _nowIndex = _historyList.length;
//        }
    };

    /**
     * 
     * @uncrunch
     */
    this.back = function()
    {
        history.go(-1);
    };

    /**
     * 
     * @uncrunch
     */
    this.forward = function()
    {
        history.go(1);
    };
    /**
     * 
     * @return KObject[]
     * @uncrunch
     */
    this.dependent = function()
    {
        return [jQuery, KListener];
    };
})();

/*
 Url Hash
 1. Hash
 2. Hash
 Widgets Manager
 wangzheng
 1.0
 2010-01-20
 2010-01-20


opt# 1009281140
http://jira.mapbar.com/browse/MWP-120
 */
var KListener = new (function() {

    var _hash = null;
    var _time = null;
    var _this = this;

    /**
     * @return 
     * @uncrunch
     */
    this.version = function()
    {
        return "1.0";
    };

    /**
     * @return 
     * @uncrunch
     */
    this.cnname = function()
    {
        return " ";
    };

    /**
     *  hashobj HashHash force 
     * @param hashobj UrlHash 
     * @param change Boolean Hashtrue
     * @param force Boolean  false
     * @uncrunch
     */
    this.setHash = function(hashobj, change, force)
    {
        if(!(hashobj instanceof KUrlHash)) return;
        if(typeof change != "boolean") change = true;
        if(typeof force != "boolean") force = false;
        var self = arguments[3];
        if(hashobj.equals(_hash))
        {
            if(force && !self) _doManagerAndTrigger(hashobj, self);
        } else {
            _hash = hashobj;
            if(change) window.location.hash = "#" + decodeURIComponent(hashobj.toString());
            if(force) _doManagerAndTrigger(hashobj, self);
            else if(change) KEvent.trigger(KListener, "hashchanged", hashobj, self);
        }
    };
    var _doManagerAndTrigger = function(hashobj, self)
    {
        //opt# 1009281140 fix begin
        //delete by panx
        //var list = KManager.matchByHash(hashobj);
        //add by panx
        var list = [];
        if(hashobj.containsKey(KConfig.get("mwpf"))) {
            var wf = hashobj.value(KConfig.get("mwpf"));
            list = KManager.match(wf, KQuery);
        }
        if(list.length==0) list = KManager.matchByHash(hashobj);
        //opt# 1009281140 fix end
        var _tri = null;
        if(list && list.length > 0)
        {
            _tri = list[0];
            setTimeout(function(){
                _tri.queryByHash(hashobj);
            });
        }
        KEvent.trigger(KListener, "hashchanged", hashobj, self);
        return _tri;
    };
    var _listen = function()
    {
        var _lHash = window.location.href.replace(/[^#]*#/, "").replace(/%25/ig, "%2525");
        var _nowHash = KUrlHash.parseByHash(_lHash);
        if(_nowHash && !_nowHash.equals(_hash))
        {
            _hash = _nowHash;
            return _doManagerAndTrigger(_nowHash, false);
        }
        return null;
    };
     /**
     * @uncrunch
     */
    this._newHash = true;
    /**
     * 
     * @uncrunch
     */
    this.start = function()
    {
		this.firstURL = window.location.href;
        if(_time != null) return;
        _time = setInterval(function() {
            _listen();
        }, parseInt(KConfig.get("LISTENER_INTERVAL")));
        KEvent.trigger(KListener, "initialized", _listen());
    };
    /**
     * 
     * @uncrunch
     */
    this.stop = function()
    {
        if(_time == null) return;
        clearInterval(_time);
        _time = null;
    };

    /**
     * @uncrunch
     */
    this.finalize = function()
    {
        this.stop();
        _hash = null;
    };
    
    /**
     * 
     * @return KObject[]
     * @uncrunch
     */
    this.dependent = function()
    {
        return [KEvent, KUrlHash, KHistory];
    };
})();

/*
 
 :wangzheng
 :1.0
 2010-1-15
 2010-01-25
 */
var KManager = new (function() {

    //: {KWidgetid() -> KWidget}
    var _id = {};
    // { -> {KWidgetid() -> KWidget}}
    var _className = {};
    //{group -> {KWidgetid() -> KWidget}}
    var _group = {};
    // : {KWidget flag -> {KWidgetid() -> KWidget}}
    var _flag = {};
    var _this = this;
    /**
     * @return 
     * @uncrunch
     */
    this.version = function()
    {
        return "1.0";
    };

    /**
     * @return 
     * @uncrunch
     */
    this.cnname = function()
    {
        return "";
    };

    /**
     * 
     * @param widget KWidget 
     * @uncrunch
     */
    this.register = function(widget)
    {
        if (widget && widget.isKClassO && widget.superclassOf(KWidget) && !_id[widget.id()])
        {
            if (!_className[widget.className]) _className[widget.className] = {};
            _className[widget.className][widget.id()] = widget;
            if (widget.isCentral() == true) _className[widget.className].central = widget;
            if (!_group[widget.group()]) _group[widget.group()] = {};
            _group[widget.group()][widget.id()] = widget;
            if (!_flag[widget.flag()]) _flag[widget.flag()] = {};
            _flag[widget.flag()][widget.id()] = widget;
            _id[widget.id()] = widget;
         }
    };

    /**
     * 
     * @param widget KWidget 
     * @uncrunch
     */
    this.unregister = function(widget)
    {
        if (widget && widget.isKClassO && widget.superclassOf(KWidget) && _id[widget.id()])
        {
            delete _className[widget.className][widget.id()];
            if (_className[widget.className].central == widget)
            {
                _className[widget.className].central = null;
                for (var i in _className[widget.className])
                {
                    if(i === 'central') continue;   
                    if (_className[widget.className][i].isCentral() == true)
                        _className[widget.className].central = i;
                }

            }
            if (_group[widget.group()] && _group[widget.group()][widget.id()]) delete _group[widget.group()][widget.id()];
            if (_flag[widget.flag()] && _flag[widget.flag()][widget.id()]) delete _flag[widget.flag()][widget.id()];
            delete _id[widget.id()];
        }
    };

    /**
     * widget_classflagwidget_class 
     * @param flag String 
     * widget_classKWidget Class  KQuery
     * @return KWidget[] null
     * @uncrunch
     */
    this.match = function(flag, widget_class)
    {
        if (!flag) return [];
        var obj = [];
        if (_flag[flag])
        {
            if (typeof widget_class == 'function')
            {
                for (var i in _flag[flag])
                    if (_flag[flag][i] && (_flag[flag][i] instanceof widget_class || _flag[flag][i].superclassOf(widget_class))) obj.push(_flag[flag][i]);
            } else
                for (var i in _flag[flag])
                    obj.push(_flag[flag][i]);
        }
        return obj;
    };

    var _testHashKeysArray = function(hash, hashKeysArray)
    {
        if(hashKeysArray instanceof Array)
        {
            for(var m = 0; m < hashKeysArray.length; m++)
            {
                if(hash.equalsKeys(hashKeysArray[m])) return true
            }
        }
        return false;
    };

    /**
     * widget_classHashwidget_class
     * @param hash String 
     * @param widget_class KWidget Class  KQuery
     * KWidget[] 
     * @uncrunch
     */
    this.matchByHash = function(hash, widget_class)
    {
        if (!(hash instanceof KUrlHash)) return;
        var list = [];
        if (typeof widget_class == 'function')
        {
            for(var i in _id)
                if(_id[i].superclassOf(KQuery) && (KQuery == widget_class || _id[i] instanceof widget_class || _id[i].superclassOf(widget_class)) && _testHashKeysArray(hash, _id[i].hashKeys())) list.push(_id[i]);
        } else {
            for(var i in _id) if(_id[i].superclassOf(KQuery) && _testHashKeysArray(hash, _id[i].hashKeys())) list.push(_id[i]);
        }
        return list;
    };

    /**
     * 
     * @param type String 
     * KWidget[] 
     * @uncrunch
     */
    this.getByType = function(widget_class)
    {
        if (typeof widget_class != 'function') return [];
        var list = [];
            if(typeof widget_class == "function")
                for (var i in _id)
                    if(_id[i] instanceof widget_class || _id[i].superclassOf(widget_class)) list.push(_id[i]);
        return list;
    };

    /**
     * 
     * @param data Any 
     * @param widget_class KWidegt,KQuery
     * @param group String String 
     * @uncrunch
     */
    this.notify = function(data, widget_class, group)
    {
        if (!data) return;
        if (typeof widget_class == 'function')
        {
            if (typeof group == 'string' && _group[group])
            {
                for (var i in _id)
                    if (_group[group][i] && (_id[i] instanceof widget_class || _id[i].superclassOf(widget_class))) _id[i].notify(data);
            } else {
                for (var i in _id)
                    if(_id[i] instanceof widget_class || _id[i].superclassOf(widget_class)) _id[i].notify(data);
            }
        } else if (typeof widget_class == 'string')
        {
            group = widget_class;
            if(_group[group])
                for (var i in _id)
                    if (_group[group][i] && (_id[i] instanceof widget_class || _id[i].superclassOf(widget_class))) _id[i].notify(data);
        } else {
            for (var i in _id)
                _id[i].notify(data);
        }
    };

    /**
     * 
     * @param widget_class KWidget Class KQuery
     * @return KWidget null
     * @uncrunch
     */
    this.central = function(widget_class)
    {
        if (typeof widget_class != 'function') return null;
        if (_className[widget_class.prototype.className]) return _className[widget_class.prototype.className].central;
        return null;
    };

    /**
     * widgetwidget_class
     * @param widget_class KWidget Class KQuery
     * @param widget KWidget 
     * @uncrunch
     */
    this.setCentral = function(widget_class, widget)
    {
        if (typeof widget_class != 'function' || !widget) return;
        if (_className[widget_class.prototype.className]) _className[widget_class.prototype.className].central = widget;
    };

    /**
     * widget_class 
     * @param group String 
     * @param widget_class KWidget Class KQuery
     * @return KWidget[] 
     * @uncrunch
     */
    this.getByGroup = function(group, widget_class)
    {
        if (typeof group != 'string') return [];
        var list = [];
        if (typeof widget_class == 'function')
        {
            if (_group[group])
                for (var i in _group[group])
                    if (_group[group][i] instanceof widget_class || _group[group][i].superclassOf(widget_class)) list.push(_group[group][i]);
        } else {
            if (_group[group])
                for (var i in _group[group])
                    list.push(_group[group][i]);
        }
        return list;
    };

    /**
     * 
     * @param widget KWidget 
     * @uncrunch
     */
    this.setGroup = function(widget)
    {
        if (_group[widget._oldGroup] && _group[widget._oldGroup][widget.id()])
        {
            delete _group[widget._oldGroup][widget.id()];
            if (!_group[widget.group()]) _group[widget.group()] = {};
            _group[widget.group()][widget.id()] = widget;
        }
    };

    /**
     * @uncrunch
     */
    this.layout = function()
    {
        var widget = _className;
        for(var i in widget)
        {
            for(var o in widget[i])
            {
                widget[i][o].layout();
            }
        }
    };

    var _lastExeQuery = undefined;

    /**
     *  KQuery  
     * @return KQuery  undefined
     * @uncrunch
     */
    this.lastExecutedQuerier = function()
    {
        return _lastExeQuery;
    };

    /**
     *  KQuery  
     * @param query KQuery 
     * @uncrunch
     */
    this.setLastExecutedQuerier = function(query)
    {
        if(query && query.superclassOf && query.superclassOf(KQuery))
        {
            _lastExeQuery = query;
        }
    };

    /**
     * @uncrunch
     */
    this.finalize = function()
    {
        if(_id) for(var i in _id)  {
            _id[i].finalize();
        }
        _id = {};
        _className = {};
        _group = {};
        _flag = {};
    };
    /**
     * 
     * @return KObject[]
     * @uncrunch
     */
    this.dependent = function()
    {
        return [KWidget, jQuery];
    };
})();

/*
 
 wangzheng
 1.0
 2010-4-2
 2010-4-2
 */
var KConfig = new (function() {

    /**
     * @return 
     * @uncrunch
     */
    this.version = function()
    {
        return "1.0";
    };

    /**
     * @return 
     * @uncrunch
     */
    this.cnname = function()
    {
        return "";
    };
    
    //"id > {value:string/obj(objobj), fun:}"
    var _name = {};
    var _funs = {};
    //String 
    _funs["s"] = function(value, data)
    {
        for(var i in data)
        {
            value = value.replace(new RegExp("\\["+i+"\\]", "ig"), data[i]);
        }
        return value;
    };
    //KMarkerOptions 
    _funs["mo"] = function(value, data)
    {
        var _value = $.extend(true, {}, value);
        for(var i in data)
        {
            var _i = "["+i+"]";
            var _reg = new RegExp("\\["+i+"\\]", "ig");
            if(_value.icon && typeof _value.icon.img == "string" && _value.icon.img.indexOf(_i) != -1)
            {
                _value.icon.img = _value.icon.img.replace(_reg, data[i]);
            }
            if(_value.icon && typeof _value.icon.snapIcon == "string" && _value.icon.snapIcon.indexOf(_i) != -1)
            {
                _value.icon.snapIcon = _value.icon.snapIcon.replace(_reg, data[i]);
            }
            if(_value.label && typeof _value.label.label == "string" && _value.label.label.indexOf(_i) != -1)
            {
                _value.label.label = _value.label.label.replace(_reg, data[i]);
                continue;
            }
            if(_value.icon && typeof _value.icon.shadow == "string" && _value.icon.shadow.indexOf(_i) != -1)
            {
                _value.icon.shadow = _value.icon.shadow.replace(_reg, data[i]);
                continue;
            }
        }
        return _value;
    };
    //KInfoWindowOptions 
    _funs["iwo"] = function(value, data)
    {
        var _value = $.extend(true, {}, value);
        for(var i in data)
        {
            var _i = "["+i+"]";
            var _reg = new RegExp("\\["+i+"\\]", "ig");
            if(typeof _value.content == "string" && _value.content.indexOf(_i) != -1)
            {
                _value.content = _value.content.replace(_reg, data[i]);
            }
        }
        return _value;
    };
    //KLineOptions 
    _funs["lo"] = function(value, data)
    {
        return value;
    };

    /**
     * 
     * @param name tring 
     * @return String 
     * @uncrunch
     */
    this.get = function(name, data)
    {
        var _nameObj = _name[name];
        if(!_nameObj) return null;
        if(!data || typeof data != "object") data = {};
        if(_nameObj.fun) return _nameObj.fun(_nameObj.value, data);
        if(typeof _nameObj.value == "object") return $.extend(true, {}, _nameObj.value);
		return _nameObj.value;
    };

    /**
     * 
     * @param name String 
     * @param value String 
     * @uncrunch
     */
    this.set = function(name, value)
    {
        if(typeof name != 'string') return;
        if(!_name[name]) _name[name] = {};
        var _nameObj = _name[name];
        _nameObj.value = value;
        var type = name.split("_")[1];
        if(type) _nameObj.fun = _funs[type];
    };

    /**
     * @uncrunch
     */
    this.finalize = function()
    {
        _name = null;
    };

    /**
     * 
     * @return KObject[]
     * @uncrunch
     */
    this.dependent = function()
    {
        return [jQuery];
    };
})();
/*
 
  : wangzheng
 1.0
 :2010-1-15
 :2010-1-25 10:15
 var sss = kkk;
 */
var KWidget = KClass.create("KWidget", KObject);

/**
 * 
 */
KWidget.initialize = function()
{
    //ID KManager
    this._id = KTools.timeCode();
    this._theme = "mwp";
    this._central = false;
    this._dom = undefined;
    this._opts = undefined;
    this._group = "temp";
    this._oldGroup = undefined;
    this._enabled = true;
};

KWidget.prototype.id = function()
{
    return this._id;
};

/**
 * KManager  widgetData() 
 * @return Boolean false
 * @uncrunch
 */
KWidget.prototype.isCentral = function()
{
    return this._central;
};

/**
 * 
 * @param bool  Boolean 
 * @uncrunch
 */
KWidget.prototype.setCentral = function(bool)
{
    this._central = bool;
};

/**
 * @return Dom
 * @uncrunch
 */
KWidget.prototype.dom = function()
{
    return this._dom;
};

/**
 * @return 
 * @uncrunch
 */
KWidget.prototype.version = function()
{
    return "1.0";
};

/**
 * @return 
 * @uncrunch
 */
KWidget.prototype.cnname = function()
{
};

/**
 * 
 * @return String 
 * @uncrunch
 */
KWidget.prototype.flag = function()
{
    return "widget";
};

/**
 * msg
 * @param msg
 * @uncrunch
 */
KWidget.prototype.notify = function(msg)
{
};

/**
 * 
 * @return KBounds 
 * @uncrunch
 */
KWidget.prototype.getBounds = function()
{
    return KTools.getBounds(this._dom);
};

/**
 * 
 * @param scheme
 * @uncrunch
 */
KWidget.prototype.setTheme = function(scheme)
{
    this._theme = scheme;
};

/**
 * null
 * @uncrunch
 */
KWidget.prototype.theme = function()
{
    return this._theme;
};

/**
 * 
 * @uncrunch
 */
KWidget.prototype.enabled = function()
{
    return this._enabled;
};

/**
 * 
 * @uncrunch
 */
KWidget.prototype.enable = function()
{
    this._enabled = true;
};

/**
 * 
 * @uncrunch
 */
KWidget.prototype.disable = function()
{
    this._enabled = false;
};

/**
 * 
 * @uncrunch
 */
KWidget.prototype.clearResult = function()
{
};

/**
 * 
 * @uncrunch
 */
KWidget.prototype.options = function()
{
    return this._opts;
};

/**
 * obj 
 * @param obj
 * @uncrunch
 */
KWidget.prototype.setOptions = function(obj)
{
    this._opts = obj;
};

/**
 * UIUI
 * @uncrunch
 */
KWidget.prototype.collapse = function()
{
};

/**
 * UI
 * @uncrunch
 */
KWidget.prototype.expand = function()
{
};

/**
 *
 * @uncrunch
 */
KWidget.prototype.group = function()
{
    return this._group;
};

/**
 * 
 * @param group String 
 * @uncrunch
 */
KWidget.prototype.setGroup = function(group)
{
    this._oldGroup = this._group;
    this._group = group;
    if (typeof KManager == "undefined") return;
    KManager.setGroup(this, group);
};

/**
 *  _dom.style.display = ""
 * @uncrunch
 */
KWidget.prototype.show = function()
{
    if(KTools._isElement(this._dom)) this._dom.style.display = "";
};

/**
 *  _dom.style.display = "none"
 * @uncrunch
 */
KWidget.prototype.hide = function()
{
    if(KTools._isElement(this._dom)) this._dom.style.display = "none";
};

/**
 * 
 * @uncrunch
 */
KWidget.prototype.layout = function()
{
};

/**
 * _dom.style.display!="none"
 * @return Boolean 
 * @uncrunch
 */
KWidget.prototype.visible = function()
{
    if(this._dom)return $(this._dom).is(":visible");
    return false;
};

/**
 * @uncrunch
 */
KWidget.prototype.finalize = function()
{
    KManager.unregister(this);
    KTools.removeNode(this._dom);
    KObject.prototype.finalize.apply(this);
};

/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KWidget.prototype.dependent = function()
{
    return [KObject, KManager, KTools, KWidgetOptions];
};
/*
 UI
 :wangzheng
 :1.0
 2010-1-15
 2010-01-25
 */
var KQuery = KClass.create("KQuery", KWidget);

/**
 * 
 */
KQuery.initialize = function()
{
    //String 	
    this._hashkeys = [];
    //KQueryOptions 	 undefined
    this._queryopts = undefined;
    //Object 	 undefined
    this._result = undefined;
};

/**
 * Hash
 * @uncrunch
 */
KQuery.prototype.hashKeys = function()
{
    return this._hashkeys;
};

/**
 *  _hashkeys = keys
 * @param keys String 
 * @uncrunch
 */
KQuery.prototype.setHashKeys = function(keys)
{
    this._hashkeys = keys;
};

/**
 *  	 opts  _queryopts = opts  KManager.setlLastExecutedQuerier()   
 * @param opts KQueryOptions 
 * @uncrunch
 */
KQuery.prototype.query = function(opts)
{
    this._queryopts = opts;
    KManager.setLastExecutedQuerier(this);
};

/**
 *  _queryopts 
 * @return KQueryOptions 
 * @uncrunch
 */
KQuery.prototype.queryOptions = function()
{
    return this._queryopts;
};

/**
 * 
 * @return Object 
 * @uncrunch
 */
KQuery.prototype.result = function()
{
    return this._result;
};

/**
 * Hash
 * @param hash KUrlHash 
 * @uncrunch
 */
KQuery.prototype.queryByHash = function(hash)
{
};

/**
 *	
 * @uncrunch
 */
KQuery.prototype.print = function()
{
};

/**
 *	
 * @uncrunch
 */
KQuery.prototype.send = function(sendtype, selected)
{
};

/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KQuery.prototype.dependent = function()
{
    return [KWidget, KQueryOptions];
};
/*
 
 wangzheng
 1.0
 2010-01-20
 2010-01-26 1551
 */
var KTabs = KClass.create("KTabs", KWidget);

/**
 * 
 */
KTabs.initialize = function()
{
    //	KTabItem 	
    this._current = undefined;
    // 	KTabItem[] 	
    this._tabs = undefined;
};

/**
 * 	 _current 
 * @return KTabItem 
 * @uncrunch
 */
KTabs.prototype.current = function()
{
    return this._current;
};

/**
 * 
 * @param index Integer 
 * @uncrunch
 */
KTabs.prototype.select = function(index)
{
};

/**
 * 	 _tabs.length 
 * @return Integer 
 * @uncrunch
 */
KTabs.prototype.length = function()
{
    if(this._tabs instanceof  Array) return this._tabs.length;
    return 0;
};

/**
 *  _tabs 
 * @return KTabItem[] 
 * @uncrunch
 */
KTabs.prototype.tabs = function()
{
    return this._tabs;
};

/**
 * 	 _tabs[index] 
 * @param index Integer 
 * @return KTabItem 
 * @uncrunch
 */
KTabs.prototype.tab = function(index)
{
    if(this._tabs instanceof Array && typeof index == 'number' && index < this._tabs.length) return this._tabs[index];
    return null;
};

/**
 * item.indexitemindex
 * @param item KTabItem 
 * @uncrunch
 */
KTabs.prototype.insert = function(item)
{
};

/**
 * item
 * @param index Integer 
 * @uncrunch
 */
KTabs.prototype.remove = function(index)
{
    if(this._tabs instanceof Array && typeof index == 'number' && index < this._tabs.length) this._tabs.splice(index,1);
};

/**
 * 
 * @param index Integer 
 * @uncrunch
 */
KTabs.prototype.hideTab = function(index)
{
};

/**
 * 
 * @param index Integer 
 * @uncrunch
 */
KTabs.prototype.showTab = function(index)
{
};

/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KTabs.prototype.dependent = function()
{
    return [KWidget, KTabItem, KEvent];
};
/*
 
 wangzheng
 1.0
 2010-01-20
 2010-02-01
 */
var KCity = KClass.create("KCity", KWidget);

KCity.initialize = function()
{
    this._city = undefined;
};

/**
 * 
 * @return KCityInfo 
 * @uncrunch
 */
KCity.prototype.city = function()
{
    return this._city;
};

/**
 * 
 * @param data KCityInfo
 * @uncrunch
 */
KCity.prototype.setCity = function(data)
{
    this._city = data;
};

/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KCity.prototype.dependent = function()
{
    return [KWidget];
};
/*
 
 wangzheng
 1.0
 2010-01-20
 2010-01-20
 */
var KGeocoder = KClass.create("KGeocoder", KWidget);

/**
 *  parsecomplete 
 * @param latlon String 
 * @uncrunch
 */
KGeocoder.prototype.parse = function(latlon)
{
};

/**
 * 
 * @return String 
 * @uncrunch
 */
KGeocoder.prototype.province = function()
{
};

/**
 * 
 * @return String 
 * @uncrunch
 */
KGeocoder.prototype.city = function()
{
};

/**
 * 
 * @return String 
 * @uncrunch
 */
KGeocoder.prototype.district = function()
{
};

/**
 * 
 * @return String 
 * @uncrunch
 */
KGeocoder.prototype.street = function()
{
};

/**
 * 
 * @return String 
 * @uncrunch
 */
KGeocoder.prototype.latlon = function()
{
};

/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KGeocoder.prototype.dependent = function()
{
    return [KWidget];
};
/*
 
 :wangzheng
 :1.0
 2010-1-15
 2010-01-15
 */
var KSuggest = KClass.create("KSuggest", KWidget);

KSuggest.initialize = function()
{
    // 	Node 	
    this._textbox = undefined;
    // 	KSuggestInfo 	
    this._data = undefined;
};

/**
 *  _data 
 * @return KSuggsetInfo 
 * @uncrunch
 */
KSuggest.prototype.data = function()
{
    return this._data;
};

/**
 *  _data = data
 * @param data KSuggsetInfo 
 * @uncrunch
 */
KSuggest.prototype.setData = function(data)
{
    this._data = data;
};

/**
 *  Dom  _textbox
 * @return Node 
 * @uncrunch
 */
KSuggest.prototype.textbox = function()
{
    return this._textbox;
};

/**
 * textbox
 * @param textbox Node 
 * @uncrunch
 */
KSuggest.prototype.hideTip = function(textbox)
{
};

/**
 * @overwrite
 * @uncrunch
 */
KSuggest.prototype.dependent = function()
{
    return [KWidget, KSuggestInfo];
};
/*
 
 :wangzheng
 :1.0
 2010-1-15
 2010-01-25
 */
var KPoint = KClass.create("KPoint", KObject);

/**
 *  xyKPoint
 * @param x
 * @param y
 */
KPoint.initialize = function(x, y)
{
//    if(typeof x == 'string' && x.length > 0)
//    {
//        var str = x;
//        str = str.split(",");
//        if(str.length == 2)
//        {
//            x = parseFloat(str[0]);
//            y = parseFloat(str[1]);
//        }
//    }
    
    if (typeof x != 'number') x = 0;
    if (typeof y != 'number') y = 0;
    //@uncrunch
    this.x = x;
    //@uncrunch
    this.y = y;
};

/**
 *  xyotherxy true  
 * xyxy true
 * @return Boolean
 * @uncrunch
 */
KPoint.prototype.equals = function()
{
    var other, x, y;
    if (arguments.length == 1)
    {
        other = arguments[0];
        if (!other || !(other instanceof KPoint)) return false;
        x = other.x;
        y = other.y;
    } else {
        x = arguments[0];
        y = arguments[1];
    }
    if (this.x == x && this.y == y) return true;
    return false;
};

/**
 * xy
 * @return KPoint
 * @uncrunch
 */
KPoint.prototype.clone = function()
{
    return new KPoint(this.x, this.y);
};

/**
 *  toString() 
 * @param str String 
 * @return KPoint 
 * @uncrunch
 */
KPoint.fromString = function(str)
{
    var _new = new KPoint();
    if(typeof str == "string" && str)
    {
        var _o = eval("new Object("+str+")");
        _new.x = _o.x;
        _new.y = _o.y;
    }
    return _new;
};


/**
 *  x,y 
 * @return String 
 * @uncrunch
 */
KPoint.prototype.toString = function()
{
    return '{x:'+this.x + ', y:' + this.y+'}';
};

/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KPoint.prototype.dependent = function()
{
    return [KObject];
};
/*
 
 :wangzheng
 :1.0
 2010-4-15
 2010-04-15
 */
var KPrinter = KClass.create("KPrinter", KWidget);

/**
 * 
 * @param opts KPrintOptions 
 * @uncrunch
 */
KPrinter.prototype.print = function(opts)
{
    //this._opts = KTools.copyOptions(opts, KPrintOptions);
};

/**
 * @overwrite
 * @uncrunch
 */
KPrinter.prototype.dependent = function()
{
    return [KWidget, KPrintOptions];
};
/*
 
 :wangzheng
 :1.0
 2010-7-16
 2010-07-16
 */
var KMapMarkers = KClass.create("KMapMarkers", KQuery);

/**
 * 
 */
KMapMarkers.initialize = function()
{
};

/**
 * 
 * @return Boolean 
 * @uncrunch
 */
KMapMarkers.prototype.save = function()
{
	return true;
};

/**
 * 
 * @return Boolean 
 * @uncrunch
 */
KMapMarkers.prototype.load = function()
{
	return true;
};


/**
 *  rid 
 * @param rid 
 * @return KMapMarkerInfo[]  0
 * @uncrunch
 */
KMapMarkers.prototype.markers = function(rid)
{
	return [];
};

/**
 * 
 * @param mapmarker  KMapMarker 
 * @return Boolean 
 * @uncrunch
 */
KMapMarkers.prototype.add = function(mapmarker)
{
	return true;
};


/**
 * 
 * @param mapmarker  KMapMarker 
 * @return Boolean 
 * @uncrunch
 */
KMapMarkers.prototype.update = function(mapmarker)
{
	return true;
};

/**
 * 
 * @param mapmarker  KMapMarker 
 * @return Boolean 
 * @uncrunch
 */
KMapMarkers.prototype.remove = function(mapmarker)
{
	return true;
};

/**
 * @overwrite
 * @uncrunch
 */
KMapMarkers.prototype.dependent = function()
{
    return [KQuery, KMapMarkerInfo];
};
/*
 Mapbar 
 :wangzheng
 :1.0
 2010-07-14
 2010-07-14
 */
var KAccount = KClass.create("KAccount", KWidget);

/**
 *  signin 
 * @param opts KSigninOptions 
 * @uncrunch
 */
KAccount.prototype.signin = function(opts)
{
    //this._opts = KTools.copyOptions(opts, KSigninOptions);
};

/**
 * 
 * @param opts KSignoutOptions 
 * @return KAccountInfo 
 * @uncrunch
 */
KAccount.prototype.signout = function(opts)
{
    //this._opts = KTools.copyOptions(opts, KSignoutOptions);
};

/**
 *  signin 
 * @return KAccountInfo 
 * @uncrunch
 */
KAccount.prototype.account = function()
{
};

/**
 * @overwrite
 * @uncrunch
 */
KAccount.prototype.dependent = function()
{
    return [KWidget, KSigninOptions];
};
/*
 
 :wangzheng
 :1.0
 2010-07-27
 2010-07-27
 */
var KFeedback = KClass.create("KFeedback", KWidget);

/**
 *  info 
 * @param info KFeedbackInfo  
 * @uncrunch
 */
KFeedback.prototype.feedback = function(info)
{
};

/**
 * @overwrite
 * @uncrunch
 */
KFeedback.prototype.dependent = function()
{
    return [KWidget, KFeedbackInfo];
};
/*
 
  KSize  width  height 
 :wangzheng
 :1.0
 2010-1-15
 2010-01-25
 */
var KSize = KClass.create("KSize", KObject);

/**
 *  KSize
 * @param width
 * @param height
 */
KSize.initialize = function(width, height)
{
//    if(typeof width == 'string' && width.length > 0)
//    {
//        var str = width;
//        str = str.split(",");
//        if(str.length == 2)
//        {
//            width = parseFloat(str[0]);
//            height = parseFloat(str[1]);
//        }
//    }
    if (typeof width != 'number') width = 0;
    if (typeof height != 'number') height = 0;
    //@uncrunch
    this.width = width;
    //@uncrunch
    this.height = height;
};

/**
 *  widthheightotherwidthheight true  
 * widthheightwidthheight true
 * @return Boolean
 * @uncrunch
 */
KSize.prototype.equals = function()
{
    var other, width, height;
    if (arguments.length == 1)
    {
        other = arguments[0];
        if (!(other instanceof KSize)) return false;
        width = other.width;
        height = other.height;
    } else {
        width = arguments[0];
        height = arguments[1];
    }
    if (this.width == width && this.height == height) return true;
    return false;
};

/**
 * 
 * @return KSize
 * @uncrunch
 */
KSize.prototype.clone = function()
{
    return new KSize(this.width, this.height);
};

/**
 *  toString() 
 * @param str String 
 * @return KSize 
 */
KSize.fromString = function(str)
{
    var _new = new KSize();
    if(typeof str == "string" && str)
    {
        var _o = eval("new Object("+str+")");
        _new.width = _o.width;
        _new.height = _o.height;
    }
    return _new;
};

/**
 *  width,height 
 * @return String
 * @uncrunch
 */
KSize.prototype.toString = function()
{
    return "{width:"+this.width + ",height:" + this.height+"}";
};
/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KSize.prototype.dependent = function()
{
    return [KObject];
};
/*
 
 :wangzheng
 :1.0
 2010-1-15
 2010-01-27
 */
var KBounds = KClass.create("KBounds", KObject);

/**
 * 
 * @param minpt
 * @param maxpt
 */
KBounds.initialize = function(minpt, maxpt)
{
//    if (typeof minpt == 'string' && minpt.length > 0)
//    {
//        var str = minpt;
//        str = str.split(",");
//        if (str.length == 4)
//        {
//            minpt = new KPoint(str[0] + "," + str[1]);
//            maxpt = new KPoint(minpt.x + parseFloat(str[2]), minpt.y + parseFloat(str[3]));
//        }
//    }
    if (! (minpt instanceof KPoint)) minpt = new KPoint(0, 0);
    if (! (maxpt instanceof KPoint)) maxpt = new KPoint(Number.MAX_VALUE, Number.MAX_VALUE);
    //@uncrunch
    this.min = minpt;
    //@uncrunch
    this.max = maxpt;
};

/**
 * other true
 * @param other
 * @uncrunch
 */
KBounds.prototype.equals = function(other)
{
    if (!other || !(other instanceof KBounds)) return false;
    if (this.min.equals(other.min) && this.max.equals(other.max)) return true;
    return false;
};

/**
 * 
 *  parseInt()
 * @uncrunch
 */
KBounds.prototype.mid = function()
{
    return new KPoint(parseFloat((this.max.x + this.min.x) / 2), parseFloat((this.max.y + this.min.y) / 2));
};
/**
 * 
 * @return KSize
 * @uncrunch
 */
KBounds.prototype.size = function()
{
    return new KSize(this.max.x - this.min.x, this.max.y - this.min.y);
};
/**
 *  true 
 *  true
 * @param arg
 * @uncrunch
 */
KBounds.prototype.contains = function(arg) {
    if (!arg) return false;
    if (arg instanceof KPoint)
    {
        if (arg.x >= this.min.x && arg.x <= this.max.x && arg.y >= this.min.y && arg.y <= this.max.y) return true;
    }
    else if (arg instanceof KBounds)
    {
        if (this.contains(arg.min) && this.contains(arg.max)) return true;
    }
    arg = null;
    return false;
};
/**
 * 
 * truefalse
 * @param bounds
 * @uncrunch
 */
KBounds.prototype.intersects = function(bounds) {
    if (!(bounds instanceof KBounds)) return false;
    if(this.min.x - bounds.min.x > bounds.size().width || bounds.min.x - this.min.x > this.size().width
            || this.min.y - bounds.min.y > bounds.size().height || bounds.min.y - this.min.y > this.size().height)
    return false;
    return true;
};

/**
 * 
 * @param bounds  KBounds
 * @return KBounds
 * @uncrunch
 */
KBounds.prototype.intersect = function(bounds)
{
    if (!bounds || !(bounds instanceof KBounds)) return null;
    var _min = new KPoint(0, 0);
    var _max = new KPoint(0, 0);
    if (this.contains(bounds) == true || this.intersects(bounds) == true)
    {
        _min.x = (this.min.x > bounds.min.x) ? this.min.x : bounds.min.x;
        _min.y = (this.min.y > bounds.min.y) ? this.min.y : bounds.min.y;
        _max.x = (this.max.x > bounds.max.x) ? bounds.max.x : this.max.x;
        _max.y = (this.max.y > bounds.max.y) ? bounds.max.y : this.max.y;
    }
    return new KBounds(_min, _max);
};

/**
 * @return KBounds
 * @uncrunch
 */
KBounds.prototype.clone = function()
{
    return new KBounds(this.min.clone(), this.max.clone());
};

/**
 *  toString() 
 * @param str String 
 * @return KBounds 
 */
KBounds.fromString = function(str)
{
    var _new = new KBounds();
    if(typeof str == 'string' && str)
    {
        var _o = eval("new Object("+str+")");
        _new.min = KPoint.fromString(_o.min);
        _new.max = KPoint.fromString(_o.max);
    }
    return _new;
};

/**
 * @return String
 * @uncrunch
 */
KBounds.prototype.toString = function()
{
    return '{min:"'+this.min.toString()+'", max:"'+this.max.toString()+'"}';
};

/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KBounds.prototype.dependent = function()
{
    return [KObject, KPoint, KSize];
};

/*
 
 :wangzheng
 :1.0
 :2010-01-25
 :2010-01-25 17:00
 */
var KMapBounds = KClass.create("KMapBounds", KObject);

/**
 * minlatlonmaxlatlon
 * @param minlatlon MPoint 
 * @param maxlatlon MPoint 
 */
KMapBounds.initialize = function(minlatlon, maxlatlon, map_container)
{
    if (typeof MPoint == 'undefined' || !(minlatlon instanceof MPoint) || !(maxlatlon instanceof MPoint)) return;
    //@uncrunch
    this.min = minlatlon;
    //@uncrunch
    this.max = maxlatlon;
    if (map_container) this._map = KMap.maplet(map_container);
    if (!this._map) this._map = KMap.getCurrentMap();
};

KMapBounds.prototype._initToMap = function()
{
    if (this._map)
    {
        if (this.min)
            this.min.initialize(this._map);
        if (this.max)
            this.max.initialize(this._map);
    }
};

/**
 * other true
 * @param other KMapBoundss 
 * @return Boolean 
 * @uncrunch
 */
KMapBounds.prototype.equals = function(other)
{
    this._initToMap();
    if (other instanceof KMapBounds)
        if (this.min.mapX == other.min.mapX && this.max.mapX == other.max.mapX && this.min.mapY == other.min.mapY && this.max.mapY == other.max.mapY)
            return true;
    return false;
};

/**
 * 
 * @return MPoint ;
 * @uncrunch
 */
KMapBounds.prototype.mid = function()
{
    this._initToMap();
    var centerX = (this.max.mapX + this.min.mapX) / 2;
    var centerY = (this.max.mapY + this.min.mapY) / 2;
    if (this._map) return new MPoint(this._map.toMapCoordinate(centerX, centerY));
    return null;
};

/**
 * 
 * @return KSize ;
 * @uncrunch
 */
KMapBounds.prototype.size = function()
{
    this._initToMap();
    return new KSize(this.max.mapX - this.min.mapX, this.min.mapY - this.max.mapY);
};

/**
 *  true
 * @param obj MPoint  KMapBoundss 
 * @return Boolean 
 * @uncrunch
 */
KMapBounds.prototype.contains = function(obj)
{
    if (this._map)
    {
        if (obj instanceof MPoint)
        {
            var latlon = obj;
            this._initToMap();
            latlon.initialize(this._map);
            return new KBounds(new KPoint(this.min.mapX, this.min.mapY), new KPoint(this.max.mapX, this.max.mapY)).contains(new KPoint(latlon.mapX, latlon.mapY));
        } else if (obj instanceof KMapBounds)
        {
            this._initToMap();
            var bounds = obj;
            bounds._initToMap();
            return new KBounds(new KPoint(this.max.mapX, this.min.mapY), new KPoint(this.max.mapX, this.min.mapY)).contains(new KBounds(new KPoint(bounds.max.mapX, bounds.min.mapY), new KPoint(bounds.max.mapX, bounds.min.mapY)));
        }
    }
};


/**
 *  true
 * @param obj MPoint  KMapBounds 
 * @return Boolean 
 * @uncrunch
 */
KMapBounds.prototype.intersects = function(bounds)
{
    if (this._map && bounds instanceof KMapBounds)
    {
        this._initToMap();
        bounds._initToMap();
        return new KBounds(new KPoint(this.max.mapX, this.min.mapY), new KPoint(this.max.mapX, this.min.mapY)).intersects(new KBounds(new KPoint(bounds.max.mapX, bounds.min.mapY), new KPoint(bounds.max.mapX, bounds.min.mapY)));
    }
};

/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KMapBounds.prototype.dependent = function()
{
    return [KObject, KMap, KSize, KBounds, KPoint];
};

/*
 
 :wangzheng
 :1.0
 2010-1-15
 2010-01-25
 */
var KOverlay = KClass.create("KOverlay", KObject);

/**
 * 
 */
KOverlay.initialize = function()
{
    this._olListener = {};
    this._mapletListener = {};
    this._isSelfEvt = true;
    var _id = KTools.timeCode();
    //@uncrunch
    this.id = function()
    {
        return _id;
    };
    //@uncrunch
    this.adapters = {};
    //@uncrunch
    this.extdata = {};
    this._ol = undefined;
    this._mc = undefined;
    this._oldGroup = undefined;
    this._group = undefined;
    this._olListener = {};
    this._visible = false;
};

/**
 * ID
 * @uncrunch
 */
KOverlay.prototype.ol = function()
{
    return this._ol;
};

/**
 * 
 * @uncrunch
 */
KOverlay.prototype.options = function()
{
    return this._opts;
};

/**
 * obj 
 * @param obj Object 
 * @uncrunch
 */
KOverlay.prototype.setOptions = function(obj)
{
	//
	if(this._openedInfo) {
		
		if (obj.infowin.title) {
			this._ol.info.setTitle(obj.infowin.title);
		}
		if (obj.infowin.content) {
			KTools.removeNode(this._opts.infowin._contentDom);
			this._opts.infowin._contentDom = null;
			KMap.openInfoWindow(this, undefined, undefined, true);
		}
		
		
//		if (obj.infowin.title) {
//			this._ol.info.setTitle(obj.infowin.title);
//		}
//		return;
//		if(obj.infowin.content) {
//			var parent = $(this._opts.infowin._contentDom).parent();
//			KTools.removeNode(this._opts.infowin._contentDom);
//        	this._opts.infowin._contentDom = null;
//			parent.empty().append($(obj.infowin.content));
//		}
	}
};

/**
 * container
 * @uncrunch
 */
KOverlay.prototype.mc = function()
{
    return this._mc;
};

/**
 * namedatanamestring
 * @param name
 * @param data
 * @uncrunch
 */
KOverlay.prototype.addExtdata = function(name, data)
{
    if (!name || !data || !isStr(name)) return;
    this.extdata[name] = data;
};

/**
 * name
 * @param name
 * @uncrunch
 */
KOverlay.prototype.removeExtdata = function(name)
{
    if (typeof name == 'string')
    {
        delete this.extdata[name];
    } else {
        delete this.extdata;
        this.extdata = {};
    }
};

/**
 * 
 * @uncrunch
 */
KOverlay.prototype.remove = function()
{
    if (this.ol()) KMap._removeOverlay(this);
    this._mc = undefined;
    KEvent.trigger.apply(this, [this, 'remove']);
    this.finalize();
};

/**
 * 
 * @uncrunch
 */
KOverlay.prototype.show = function()
{
    if (this._visible == false && this.ol())
    {
        KMap.maplet(this.mc()).addOverlay(this.ol());
        this._visible = true;
    }

    KEvent.trigger.apply(this, [this, 'visibilitychanged', this, true]);
};

/**
 * 
 * @uncrunch
 */
KOverlay.prototype.hide = function()
{
    if (this._visible == true && this.ol())
    {
        KMap.maplet(this.mc()).removeOverlay(this.ol());
        this._visible = false;
    }
    KEvent.trigger.apply(this, [this, 'visibilitychanged', this, false]);
};

/**
 * 
 * @param able Boolean 
 * @uncrunch
 */
KOverlay.prototype.setEditable = function(able)
{
};

/**
 * @uncrunch
 */
KOverlay.prototype.editable = function()
{
};

/**
 * @uncrunch
 */
KOverlay.prototype.clone = function()
{
    if (typeof KMarker == 'undefined' || typeof KLine == 'undefined' || typeof KArea == 'undefined') return;
    if (this instanceof KLine || this instanceof KArea)
        return new this.constructor(this.ol.pts, this.opts);
    else if (this instanceof KMarker)
        return new this.constructor(this.ol.pt, this.opts);
};

/**
 * 
 * @uncrunch
 */
KOverlay.prototype.group = function()
{
    return this._group;
};

/**
 * 
 * @param group String 
 * @uncrunch
 */
KOverlay.prototype.setGroup = function(group)
{
    this._oldGroup = this._group;
    this._group = group;
    if (this._mc) KMap._updateOverlayGroup(this);
};

/**
 *  Dom  
 * @return Node 
 * @uncrunch
 */
KOverlay.prototype.iwcDom = function()
{
    if(this._opts && this._opts.infowin && this._opts.infowin._contentDom) return this._opts.infowin._contentDom;
    return null;
};

KOverlay.prototype._parseObjToString = function(obj)
{
    var _str = new Array();
    for(var i in obj)
    {
        var oi = obj[i];
        if(typeof oi == "object" && oi != null)
        {
            if(KTools._isElement(oi))
            {
                oi = KTools.domHTML(oi);
            } else if(oi.isKClassO) {
                oi = oi.toString();
            } else {
                oi = this._parseObjToString(oi);
            }
            oi = '"'+oi.replace(/\\/ig,"\\\\").replace(/([\"\'])/ig, '\\$1')+'"';//.replace(/([\"\'])/ig, '\\$1')
        } else if(typeof oi == "string") {
            oi = '"'+oi.replace(/\\/ig,"\\\\").replace(/([\"\'])/ig, '\\$1')+'"';
        }
        _str.push(i+':'+oi);
    }
    return '{'+_str.join(",")+'}';
};

KOverlay._parseStringToObj = function(str)
{
    var _o = eval("new Object("+str+")");
    for(var i in _o)
    {
        var _oI = _o[i];
        if(typeof _oI == "string" && _oI.indexOf("{") == 0)
        {
            if(i == "anchor" || i == "shadowAnchor")
            {
                _o[i] = KPoint.fromString(_oI);
            } else {
                if(i == "size" || i == "shadowSize")
                    _o[i] = KSize.fromString(_oI);
                else
                    _o[i] = KOverlay._parseStringToObj(_oI);
            }
        }
    }
    return _o;
};

/**
 * @overwrite
 * @uncrunch
 */
KOverlay.prototype.finalize = function()
{
    KEvent.clear(this);
    KWidget.prototype.finalize.call(this);
};

/**
 * 
 * @param obj
 * @param evtname
 * @param fun
 * @param data
 * @uncrunch
 */
KOverlay.prototype.bind = function(obj, evtname, fun, data, thisobj)
{
    var this_ = this;
    evtname = evtname.toLowerCase();
    switch (evtname) {
        case 'click' :
            if (!this._olListener["click"])
            {
                this._olListener["click"] = MEvent.addListener(this_.ol(), "click", function(ol, event, latlon) {
                    var point = null;
                    if(this_ instanceof KMarker) point =  ol.pt;
                    else point = new MPoint(latlon);
                    KEvent.trigger.apply(this_, [this_, 'click', this_, point]);
                });
            }
            break;
        case 'infowindowopen' :
            if (!this._olListener["iw_beforeopen"])
                this._olListener["iw_beforeopen"] = MEvent.addListener(this_.ol(), "iw_beforeopen", function(ol) {
                    if(ol == this_.ol()) KEvent.trigger.apply(this_, [this_, 'infowindowopen', this_, ol]);
                });
            break;
        case 'infowindowclose' :
            if (!this._mapletListener["iw_hide"])
                this._mapletListener["iw_hide"] = MEvent.addListener(maplet, "iw_hide", function(ol) {
                    if(ol == this_.ol()) KEvent.trigger.apply(this_, [this_, 'infowindowclose', this_]);
                });
            break;
    }
    if (!this.adapters) this.adapters = {};
    if (!this.adapters[evtname]) this.adapters[evtname] = [];
    if (!KTools._arrayContains(this.adapters[evtname], fun)) this.adapters[evtname].push({fun:fun, data:data, thisobj:thisobj});
};

/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KOverlay.prototype.dependent = function()
{
    return [KObject, KMap, KEvent, KTools];
};
/*
 
 :wangzheng
 :1.0
 2010-4-15
 2010-04-15
 */
var KSender = KClass.create("KSender", KWidget);

/**
 * 
 * @param opts KSendOptions 
 * @uncrunch
 */
KSender.prototype.send = function(opts)
{
    //this._opts = KTools.copyOptions(opts, KSendOptions);
};

/**
 * @overwrite
 * @uncrunch
 */
KSender.prototype.dependent = function()
{
    return [KWidget, KSendOptions];
};
/*
 APIMPolyline
 :wangzheng
 :1.0
 2010-1-15
 2010-01-25

 bug 1010291555
 1. setBrush()

 bug 1011011202
 KLine.hilite()currlevel
 bug#1012071010
 KLine.hilite()
 */
var KLine = KClass.create("KLine", KOverlay);

/**
 * KLine
 * @param pts String   MPoint[] 
 * @param opts KLineOptions 
 */
KLine.initialize = function(pts, opts)
{
    this._opts = KTools.copyOptions(opts, KLineOptions);
    this._group = this._opts.group;
    this._ol = this._makerMLine(pts, this._opts);
    this._ol.brush.fill = false;
    this._hiliteKLine = undefined;
    this._olListener = {};
    var _this = this;
    if(_this._opts.infowin)
    {
        this._olListener["iw_click"] = MEvent.addListener(this._ol, 'click', function() {
            _this._ol.setInfoWindow(null);
            setTimeout(function () {KMap.openInfoWindow(_this);});
            /*KMap.openInfoWindow(_this);
             * change by tanzh*/
        });
    }
};

/**
 * 
 * @param pts String 
 * @param levels String 
 * @param opts KLineOptions 
 * @uncrunch
 */
KLine.fromEncoded = function(pts, levels, opts)
{
    if (Maplet && KMap.getCurrentMap() instanceof Maplet && typeof pts == 'string' && typeof levels == 'string')
    {
        var _pts = KMap.getCurrentMap().decodeLine(pts, levels);
        if (_pts) return new KLine(_pts, opts);
    }
    return null;
};

/**
 * 
 * @param begin Integer 
 * @param end Integer 
 *  @param currlevel Boolean  false
 * @uncrunch
 */
KLine.prototype.hilite = function( begin, end, currlevel)
 {
	// 
	if (this._hiliteKLine != null) {
		KMap.getCurrentMap().removeOverlay(this._hiliteKLine.ol(), true);
		this._hiliteKLine.finalize();
	}
	// bug 1011011202 fix begin
	// delete by panx
	// this._hiliteKLine = new KLine(this.ol().getPointsByLevelGroup(begin, end), {brush : this._opts.hiliteBrush});
	// add by panx
	//if (typeof currlevel == "boolean" && currlevel) {
	if (currlevel===true) {
		this._hiliteKLine = new KLine(this.ol().getPointsByLevelGroup(begin, end), {
			brush : this._opts.hiliteBrush
		});
	} else {
		this._hiliteKLine = new KLine(this.latlons(begin, end), {
			brush : this._opts.hiliteBrush
		});
	}
	// bug 1011011202 fix end
	KMap.maplet(this._mc).addOverlay(this._hiliteKLine.ol());
};

/**
 * 
 *
 * @uncrunch
 */
KLine.prototype.resume = function()
{
    if (this._hiliteKLine != null)
    {
        KMap.maplet(this._mc).removeOverlay(this._hiliteKLine.ol(), true);
        this._hiliteKLine = null;
    }
};

/**
 * path
 * @param able Boolean 
 * @param path Boolean 
 * @uncrunch
 */
KLine.prototype.setEditable = function(able, path)
{
    if (typeof able == 'boolean')
    {
        this._ol.setEditable(able);
        this._opts.editable = able;
        if (typeof path == 'boolean')
        {
            this._opts.path = path;
            if (able) this._ol.setEditMode(path ? "path" : "default", this._opts.editHilite);
        }
    }
};

/**
 * brush
 * @param brush KBrush 
 * @uncrunch
 */
KLine.prototype.setBrush = function(brush)
{
    brush = KTools.copyOptions(brush, this._opts.brush);
    this._ol.setBrush(this._makeMBrush(brush));
    this._opts.brush = brush;
    KEvent.trigger(this, "brushchanged", this, brush);
};

/**
 * KLine KAreaMLine
 * @param pts
 * @param opts
 */
KLine.prototype._makerMLine = function(pts, opts)
{
    var points;
    if (typeof pts == 'string')
    {
        var latLons = pts.split(",");
        points = [];
        for (var i = 0; i < latLons.length; i++) points.push(new MPoint(latLons[i]));
    } else if (pts instanceof Array)
        points = pts;
    else return null;
    var brush = this._makeMBrush(opts.brush);
    if(opts.infowin) opts.infowin = KTools.copyOptions(opts.infowin, KInfoWindowOptions);
    var mLine = new MPolyline(points, brush, null);
    mLine.setEditable(opts.editable);
    if (opts.editable) mLine.setEditMode(opts.path ? "path" : "default", opts.editHilite);
    return mLine;
};

/**
 * KBrushMBrush
 * @param kbrush
 */
KLine.prototype._makeMBrush = function(kbrush)
{
    var brush = new MBrush();
    kbrush = KTools.copyOptions(kbrush, KBrushOptions);
    kbrush.dmstyle = KTools.copyOptions(kbrush.dmstyle, KDirMarkStyleOptions);
    brush.color = kbrush.color;
    //bug 1010291555.1 fix begin
    //del by panx
    //brush.width = kbrush.width;
    //add by panx
    brush.stroke = kbrush.width;
    //bug 1010291555.1 fix end
    brush.fill = (kbrush.fill == true);
    if (kbrush.dashed) brush.style = 1;
    brush.transparency = kbrush.transparency;
    brush.bgcolor = kbrush.bgcolor;
    brush.bgtransparency = kbrush.bgtransparency;
    brush.overlap.enable = kbrush.overlap;
    if(brush.overlap.enable && this._opts.disableIE678overlap && $.browser.msie) brush.overlap.enable = false;
    brush.overlap.transparency = 50;
    return brush;
};


/**
 * 
 * @param opts 
 * @uncrunch
 */
KLine.prototype.setOptions = function(opts)
{
    if (typeof opts != 'object' || opts == this._opts) return;
    $.extend(true, this._opts, opts);
    if (typeof opts.brush == "object" && opts.brush != null) {
        this.setBrush(this._opts.brush);
    }
    if (typeof opts.infowin == "object")
    {
        if(!this._olListener["iw_click"])
        {
            this._olListener["iw_click"] = MEvent.addListener(this._ol, 'click', function() {
                _this._ol.setInfoWindow(null);
                KMap.openInfoWindow(_this);
            });
        }
		if(this._opts.infowin) this._opts.infowin = KTools.copyOptions(this._opts.infowin, KInfoWindowOptions);
		KOverlay.prototype.setOptions.apply(this, [opts]);
    }
    if (typeof opts.editable == 'boolean') this.setEditable(opts.editable, this._opts.path);
};

/**
 *   type=="begin"  "end"  MPoint   type=="all" 
 *  0
 * @param begin String  "begin","end","all"    Integer  0 
 * @param end Integer   
 * @return MPoint  MPoint[] 
 * @uncrunch
 */
KLine.prototype.latlons = function(begin, end)
{
    if(!this._ol || !(this._ol.pts instanceof Array) || this._ol.pts.length < 1) return [];
	if(begin == undefined) begin = "all";
    if(typeof begin === "string")
    {
        switch(begin)
        {
            case "begin" :
                return this._ol.pts[0];
                break;
            case "end" :
                return this._ol.pts[this._ol.pts.length - 1];
                break;
            case "all" :
                return this._ol.pts;
                break;
        }
    } else {
        begin = parseInt(begin);
        end = parseInt(end);
        if(begin < 0) begin = 0;
        end++;
        if(end > this._ol.pts.length) end = this._ol.pts.length;
        if(begin > end) return [];
        return this._ol.pts.slice(begin, end);
    }
};

/**
 * @uncrunch
 */
KLine.prototype.editable = function()
{
    if(this._ol) return this._ol.bEditable;
    return false;
};

/**
 * 
 * @param idx Integer[]  latlons("all")  undefined
 * @param opts KDirMarkOptions 
 * @uncrunch
 */
KLine.prototype.addDirMarkers = function(idx, opts)
{
    if(this._ol && idx instanceof Array)
    {
        if(!this._dMOptions) this._dMOptions = KTools.copyOptions({}, KDirMarkOptions);
        opts = KTools.copyOptions(opts, this._dMOptions);
        this._ol.setDirMark({
            minLevel: opts.minLevel
            ,maxLevel: opts.maxLevel
            ,pts: idx
        }, opts.redraw);
    }
};

/**
 * 
 * @uncrunch
 */
KLine.prototype.clearDirMarkers = function()
{
    this.addDirMarkers([]);
};

/**
 *  begin  end 
 * @param begin Integer
 * @param end Integer
 * @uncrunch
 */
KLine.prototype.fitzoom = function(begin, end)
{
    var _latlons;
    if(typeof begin == "number" && typeof end == "number")
       _latlons = this.latlons(begin, end);
    else _latlons = this.latlons("all");
    var _mm = KMap.maxmin(_latlons);
    KMap.fitzoom([_mm.min, _mm.max]);
};

/**
 *  toString() 
 * @param str String 
 * @return KMarker 
 */
KLine.fromString = function(str)
{
    if(typeof str == "string" && str)
    {
        var _o = eval("new Object("+str+")");
        if(arguments[1]) return new arguments[1](_o.latlons, KOverlay._parseStringToObj(_o.options));
        return new KLine(_o.latlons, KOverlay._parseStringToObj(_o.options));
    }
    return null;
};

/**
 * @overwrite
 * @uncrunch
 */
KLine.prototype.toString = function()
{
    var _points = this.latlons("all");
    if(_points)
    {
        var _latlons = [];
        for(var i = 0; i < _points.length; i++)
        {
            _latlons.push(_points[i].getPid());
        }
        return '{latlons:"'+_latlons.join(",")+'", options:"'+this._parseObjToString(this._opts).replace(/\\/ig,"\\\\").replace(/([\"\'])/ig, '\\$1')+'"}';//.replace(/([\"\'])/ig, '\\$1')
    }
    return "";
};


KLine.prototype._dragstart = false;

/**
 * 
 * @param obj
 * @param evtname
 * @param fun
 * @param data
 * @uncrunch
 */
KLine.prototype.bind = function(obj, evtname, fun, data, thisobj)
{
    var this_ = this;
    evtname = evtname.toLowerCase();
    if (evtname == 'click' || evtname == 'infowindowopen' || evtname == 'infowindowclose' || evtname == 'remove' || evtname == 'visibilitychanged')
    {
        KOverlay.prototype.bind.apply(this, [this_, evtname, fun, data, thisobj]);
        return;
    }
    switch (evtname) {
        case 'modified' :
            if(!this._olListener["drag"])
                this._olListener["drag"] = MEvent.addListener(this._ol, 'drag', function(polyline) {
                    KEvent.trigger(this_, "modified", this_);
                });
            if(!this._olListener["edit"])
                this._olListener["edit"] = MEvent.addListener(this._ol, 'edit', function(polyline) {
                    KEvent.trigger(this_, "modified", this_);
                });
            break;
        case 'pathnode_dragstart' : ;
        case 'pathnode_draging' :
            if(!this._olListener["nodedrag_move"])
                this._olListener["nodedrag_move"] = MEvent.addListener(this._ol, 'nodedrag_move', function(polyline, marker) {
                    if(this_._dragstart == false)
                    {
                        this_._dragstart = true;
                        KEvent.trigger(this_, "pathnode_dragstart", this_, marker.pt);
                    }
                    KEvent.trigger(this_, "pathnode_draging", this_, marker.pt);
                });
            if(!this._olListener["nodedrag"])
                this._olListener["nodedrag"] = MEvent.addListener(this._ol, 'nodedrag', function(polyline, marker) {
                    this_._dragstart = false;
                    KEvent.trigger(this_, "pathnode_dragend", this_, marker.pt);
                });
            if(!this._olListener["drag_hovering"])
                this._olListener["drag_hovering"] = MEvent.addListener(this._ol, 'drag_hovering', function(polyline, marker) {
                    KEvent.trigger(this_, "pathnode_hovering", this_, marker.pt);
                });
            break;
    }
    if (!this.adapters) this.adapters = {};
    if (!this.adapters[evtname]) this.adapters[evtname] = [];
    if (!KTools._arrayContains(this.adapters[evtname], fun)) this.adapters[evtname].push({fun:fun, data:data, thisobj: thisobj});
};

/**
 * @overwrite
 * @uncrunch
 */
KLine.prototype.finalize = function()
{
    if(this._olListener)
    {
        for(var i in this._olListener) MEvent.removeListener(this._olListener[i]);
    }
    KEvent.clear(this);
    if(this._opts && this._opts.infowin) KTools.removeNode(this._opts.infowin._contentDom);
    this.resume();
    KOverlay.prototype.finalize.apply(this);
};

/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KLine.prototype.dependent = function()
{
    return [KOverlay, KTools, KLineOptions, KMap,KInfoWindowOptions, KBrushOptions, jQuery, KDirMarkStyleOptions, KDirMarkOptions];
};
/*
 APIMMarker
 :wangzheng
 :1.0
 :2010-01-15
 :2010-01-29
 */
var KMarker = KClass.create("KMarker", KOverlay);

/**
 * KMarkerOptions latlon 
 * @param latlon MPoint
 * @param opts
 */
KMarker.initialize = function(latlon, opts)
{
    var _this = this;
    this._olListener = {};
    //@uncrunch
    this.adapters = {};
    if (typeof latlon == "string")
    {
        this._point = new MPoint(latlon);
    } else if (latlon instanceof MPoint)
    {
        this._point = latlon;
    }

    this._opts = KTools.copyOptions(opts, KMarkerOptions);
    this._group = this._opts.group;

    if(this._opts.icon) this._opts.icon = KTools.copyOptions(this._opts.icon, KIconOptions);
    if(this._opts.infowin) this._opts.infowin = KTools.copyOptions(this._opts.infowin, KInfoWindowOptions);
    if(this._opts.label) this._opts.label = KTools.copyOptions(this._opts.label, KLabelOptions);
    if(!this._opts.icon) return;

    var obj = this._conveIconAndShadow();
    
    var icon = obj.icon;
    var shadow = obj.shadow;

    var infowin = null;
//    this._label = this._conveLabel();
    this._ol = new MMarker(this._point, icon, infowin, this._conveLabel(), shadow);

    this._ol.dragAnimation = this._opts.bouncy;
    this._ol.autoHide = this._opts.autoHide;
    this._ol.setEditable(this._opts.editable);
    this._updateLabel();
    this._olListener["iw_click"] = MEvent.addListener(this._ol, 'click', function() {
        if(_this._opts && _this._opts.infowin)
        {
            _this._ol.setInfoWindow(null);
			//KMap.openInfoWindow(_this);
            setTimeout(function(){KMap.openInfoWindow(_this);});
        }
    });
};

/**
 * 
 * @param pos KPosition.RIGHT
 * @uncrunch
 */
KMarker.prototype.hilite = function(pos)
{
    if (!pos) pos = KPosition.RIGHT;
    this._ol.icon.hilite();
};

/**
 * 
 * @uncrunch
 */
KMarker.prototype.resume = function()
{
    //this._opts.icon.img.resume();
};

/**
 * 
 * @uncrunch
 */
KMarker.prototype.showLabel = function()
{
    this._ol.label.setVisible(true);
};

/**
 * 
 * @uncrunch
 */
KMarker.prototype.hideLabel = function()
{
    this._ol.label.setVisible(false);
};

/**
 * 
 * 
 * @uncrunch
 */
KMarker.prototype.setEditable = function(able)
{
    if (typeof able != 'boolean') able = false;
    this._ol.setEditable(able);
};

/**
 * 
 * @param obj
 * @param evtname
 * @param fun
 * @param data
 * @uncrunch
 */
KMarker.prototype.bind = function(obj, evtname, fun, data, thisobj)
{
    var this_ = this;
    evtname = evtname.toLowerCase();
    if (evtname == 'click' || evtname == 'infowindowopen' || evtname == 'infowindowclose' || evtname == 'remove' || evtname == 'visibilitychanged')
    {
        KOverlay.prototype.bind.apply(this, [this_, evtname, fun, data, thisobj]);
        return;
    }
    switch (evtname) {
        case 'dragstart' :
            if(!this._olListener["dragstart"])
                this._olListener["dragstart"] = MEvent.addListener(this._ol, 'dragstart', function(marker, point) {
                    KEvent.trigger(this_, "dragstart", this_, point);
                });
            break;
        case 'draging' :
            if(!this._olListener["draging"])
                this._olListener["draging"] = MEvent.addListener(this._ol, 'draging', function(marker, point) {
                    KEvent.trigger(this_, "draging", this_, point);
                });
            break;
        case 'dragend' :
            if(!this._olListener["dragend"])
                this._olListener["dragend"] = MEvent.addListener(this._ol, 'drag', function(marker) {
                    KEvent.trigger(this_, "dragend", this_, marker.pt);
                });
            break;
        case 'mouseover' :
            if(!this._olListener["mouseover_"])
                this._olListener["mouseover_"] = MEvent.addListener(this._ol, 'mouseover', function(marker) {
                    KEvent.trigger(this_, "mouseover", this_);
                });
            break;
        case 'mouseout' :
            if(!this._olListener["mouseout_"])
                this._olListener["mouseout_"] = MEvent.addListener(this._ol, 'mouseout', function(marker) {
                    KEvent.trigger(this_, "mouseout", this_);
                });
            break;
    }
    if (!this.adapters) this.adapters = {};
    if (!this.adapters[evtname]) this.adapters[evtname] = [];
    if (!KTools._arrayContains(this.adapters[evtname], fun)) this.adapters[evtname].push({fun:fun, data:data, thisobj: thisobj});
};

/**
 * 
 * @param opts 
 * @uncrunch
 */
KMarker.prototype.setOptions = function(opts)
{

    if (typeof opts != 'object' || opts == this._opts) return;

    if(opts.group && opts.group != this._group) this.setGroup(opts.group);
    $.extend(true, this._opts, opts);
    if(this._opts.icon) this._opts.icon = KTools.copyOptions(this._opts.icon, KIconOptions);
    if(this._opts.label) this._opts.label = KTools.copyOptions(this._opts.label, KLabelOptions);
    if(opts.infowin)
    {
        if(this._opts.infowin) this._opts.infowin = KTools.copyOptions(this._opts.infowin, KInfoWindowOptions);
		KOverlay.prototype.setOptions.apply(this, [opts]);
    }
    //icon
    if (opts.icon)
    {
        if(opts.icon.img || opts.shadow || opts.icon.size || opts.icon.anchor || opts.icon.shadowSize)
        {
            var iconAndShadow = this._conveIconAndShadow();
            this._ol.setIcon(iconAndShadow.icon, true);
            this._ol.setShadow(iconAndShadow.shadow, true);
        } else if(opts.icon.snapIcon) {
            this._ol.icon.div.firstChild.firstChild.setAttribute(Maplet.MICON_IMGSRC_FLAG, opts.icon.snapIcon);
        }
    }
    if (typeof opts.label == "object")
    {
        if(this._ol.label) KTools.removeNode(this._ol.label.div);
        this._ol.setLabel(this._conveLabel(), true);
    }

    this._ol.dragAnimation = this._opts.bouncy;
    this._ol.autoHide = this._opts.autoHide;
    if (typeof opts.editable == 'boolean') this._ol.setEditable(this._opts.editable);
    if (this._ol.label)
    {
        this._updateLabel();
    } else {
        if (this._olListener["mouseover"])
        {
            MEvent.removeListener(this._olListener["mouseover"]);
            delete this._olListener["mouseover"];
        }
        if (this._olListener["mouseout"])
        {
            MEvent.removeListener(this._olListener["mouseout"]);
            delete this._olListener["mouseout"];
        }
    }

};

KMarker.prototype._updateLabel = function()
{
    var _this = this;
    if (this._ol && this._ol.label)
    {
        var label = this._ol.label;
        if(this._opts.hoverLabel)
        {
            label.setVisible(false);
            if(!this._olListener["mouseover"]) this._olListener["mouseover"] = MEvent.addListener(this._ol, 'mouseover', function(marker) {
                label.setVisible(true);
            });
            if(!this._olListener["mouseout"]) this._olListener["mouseout"] = MEvent.addListener(this._ol, 'mouseout', function() {
                label.setVisible(false);
            });
        } else {
            label.setVisible(true);
            if(this._olListener["mouseover"]) MEvent.removeListener(this._olListener["mouseover"]);
            if(this._olListener["mouseover"]) MEvent.removeListener(this._olListener["mouseout"]);
            delete this._olListener["mouseover"];
            delete this._olListener["mouseout"];
        }
        if (this._opts.label.wordwrap)
            label.div.style.wordWrap = 'break-word';
        else
            label.div.style.wordWrap = 'normal';
    }
};

/**
 * @return MPoint
 * @uncrunch
 */
KMarker.prototype.latlon = function()
{
    return this._point;
};

/**
 * 
 * @param latlon String  MPoint
 * @uncrunch
 */
KMarker.prototype.setLatlon = function(latlon)
{
    if(this._ol && latlon)
    {
        if(!(latlon instanceof MPoint)) latlon = new MPoint(latlon);
        this._point = latlon;
        this._ol.setPoint(latlon, true);
    }
};

KMarker.prototype._conveIconAndShadow = function()
{
    var icon_opt = this._opts.icon;
    if (!icon_opt || !icon_opt.img) return;
    var icon_size = undefined;

    if (icon_opt.size instanceof KSize)
        icon_size = icon_opt.size;
    else {
        if (typeof icon_opt.img == "string" && icon_opt.img.indexOf("<") == -1)
            icon_size = KTools.imgSize(icon_opt.img);
        else {
            icon_opt.img = $(icon_opt.img)[0];
            icon_size = KTools.measSize(icon_opt.img);
        }
        icon_opt.size = icon_size;
    }
    var icon_anchor = undefined;
    if (icon_opt.anchor instanceof KPoint) icon_anchor = icon_opt.anchor;
    else
    {
        icon_anchor = new KPoint(icon_size.width / 2, icon_size.height);
        icon_opt.anchor = icon_anchor;
    }

    var icon = new MIcon(icon_opt.img, icon_size.width, icon_size.height, icon_anchor.x, icon_anchor.y);
    if(typeof icon_opt.snapIcon == "string") icon.div.firstChild.firstChild.setAttribute(Maplet.MICON_IMGSRC_FLAG, icon_opt.snapIcon);
    if(typeof icon_opt.cssname == "string") icon.div.firstChild.className = icon_opt.cssname;
    var shadow = null;
    if (icon_opt.shadow && (!KTools.isIE6 || icon_opt.disableIE6shadow === false))
    {
        var icon_shadow_size = undefined;
        if (icon_opt.shadowSize instanceof KSize)
            icon_shadow_size = icon_opt.shadowSize;
        else {
            if (typeof icon_opt.shadow != "object" && icon_opt.shadow.indexOf("<") == -1)
                icon_shadow_size = KTools.imgSize(icon_opt.shadow);
            else
            {
                icon_opt.shadow = $(icon_opt.shadow)[0];
                icon_shadow_size = KTools.measSize(icon_opt.shadow);
            }
            icon_opt.shadowSize = icon_shadow_size;
        }
        if (icon_shadow_size instanceof KSize && icon_shadow_size.width > 0 && icon_shadow_size.height > 0)
        {
            var icon_shadow_anchor = undefined;
            if (icon_opt.shadowAnchor instanceof KPoint) icon_shadow_anchor = icon_opt.shadowAnchor;
            if (icon_shadow_anchor)
                shadow = new MIconShadow(icon_opt.shadow, icon_shadow_size.width, icon_shadow_size.height, icon_shadow_anchor.x, icon_shadow_anchor.y);
            else
                shadow = new MIconShadow(icon_opt.shadow, icon_shadow_size.width, icon_shadow_size.height);
        }
    }
    return {
        icon:icon
        ,shadow:shadow
    };
};

KMarker.prototype._conveLabel = function()
{
//    return null;
    var label = null;
    var label_opt = this._opts.label;
    var icon_size = this._opts.icon.size;
    if (label_opt)
    {
        var x = 0;
        var y = 0;
        //label
        if (label_opt.anchor instanceof KPoint)
        {
            x = label_opt.anchor.x;
            y = label_opt.anchor.y;
        } else if (label_opt.pos) {
            if(typeof label_opt.label == "string" && label_opt.label.indexOf("<") == -1) label_opt.label = "<div>"+label_opt.label+"</div>";
            label_opt.label = $(label_opt.label)[0];
            
            var size = KTools.measSize(label_opt.label);
            if (size instanceof KSize)
                switch (label_opt.pos) {
                    case KPosition.TOP :
                        x = - (size.width / 2 - icon_size.width / 2);
                        y = - size.height;
                        break;
                    case KPosition.BOTTOM :
                        x = - (size.width / 2 - icon_size.width / 2);
                        y = icon_size.height;
                        break;
                    case KPosition.LEFT :
                        x = - size.width;
                        y = - (size.height / 2 - icon_size.height / 2);
                        break;
                    case KPosition.RIGHT :
                        x = icon_size.width;
                        y = - (size.height / 2 - icon_size.height / 2);
                        break;
                }
            label_opt.anchor = new KPoint(x, y);
        }
        
        if (x != 0 || y != 0)
        {
            label = new MLabel(label_opt.label, {
                xoffset: x
                ,yoffset: y
//                ,opacity: label_opt.transparence
                ,enableStyle: label_opt.defaultStyle
                ,visible: !this._opts.hoverLabel
            });
            if (label_opt.snapText) $(label.div).attr(""+Maplet.MLABEL_TEXT_FLAG, label_opt.snapText);
        }
    }
    return label;
};

KMarker.prototype._conveInfowin = function()
{
    var infowin = null;
    var infowin_opt = this._opts.infowin;
    if (infowin_opt) infowin = KTools._makeMinfoWindow(infowin_opt);
    return infowin;
};

/**
 * 
 * @param classname String  KIconOptions.img  
 * @uncrunch
 */
KMarker.prototype.setIconClass = function(classname)
{
    if(typeof classname == "string") {
		this.ol().icon.div.firstChild.firstChild.className = classname;
		
		//var _text = this._opts.icon.img;
		//if(_text) {
		//	if(/^[^\<]*<[^\>]*class=[^\>]*>/.test(_text)) {
		//		this._opts.icon.img = _text.replace(/class=[^\ \>]*/, "class=\""+classname+"\"");
		//	} else {
		//		this._opts.icon.img = _text.replace(/^([^\<]<[^\>]*)\>/, "$1 class=\""+classname+"\">");
		//	}
		//}
	}
};

/**
 * 
 * @param classname String  KIconOptions.img  
 * @uncrunch
 */
KMarker.prototype.setLabelClass = function(classname)
{
    if(typeof classname == "string" && this.ol() &&this.ol().label) {
		this.ol().label.div.firstChild.className = classname;
	}
};

/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KMarker.prototype.dependent = function()
{
    return [KTools, KOverlay, KMarkerOptions, KPosition, KSize, KPoint, KInfoWindowOptions, KLabelOptions, KIconOptions, jQuery];
};

/**
 *  Dom  
 * @return Node 
 * @uncrunch
 */
KMarker.prototype.iconDom = function()
{
    if(this._ol && this._ol.icon) return this._ol.icon.div;
};

/**
 *  Dom  
 * @return Node 
 * @uncrunch
 */
KMarker.prototype.labelDom = function()
{
    if(this._ol && this._ol.label) return this._ol.label.div;
};


/**
 * @uncrunch
 */
KMarker.prototype.editable = function()
{
    if(this._ol) return this._ol.bEditable;
    return false;
};

/**
 *  Dom  
 * @return Node 
 * @uncrunch
 */
KMarker.prototype.shadowDom = function()
{
    if(this._ol && this._ol.shadow) return this._ol.shadow.div;
};

/**
 *  toString() 
 * @param str String 
 * @return KMarker 
 */
KMarker.fromString = function(str)
{
    if(typeof str == "string" && str)
    {
        var _o = eval("new Object("+str+")");
        return new KMarker(_o.latlon, KOverlay._parseStringToObj(_o.options));
    }
    return null;
};

/**
 *  Dom  innerHTML   Dom UI 
 * @uncrunch
 */
KMarker.prototype.syncHtml2Attribute = function()
{
	var _labelHtml = $(this.labelDom()).html();
	if(_labelHtml.indexOf("<") != -1 && this._opts && this._opts.label && this._opts.label) {
		this._opts.label.label = _labelHtml;
//		this._opts.label.snapText = $(this.labelDom()).text();
	}
};

/**
 * @overwrite
 * @uncrunch
 */
KMarker.prototype.toString = function()
{
    return '{latlon:"'+this.latlon().pid+'", options:"'+this._parseObjToString(this._opts).replace(/[\n\r]+/ig,"").replace(/\\/ig,"\\\\").replace(/([\"\'])/ig, '\\$1')+'"}';//.replace(/([\"\'])/ig, '\\$1')
};


/**
 * @overwrite
 * @uncrunch
 */
KMarker.prototype.finalize = function()
{
    if(this._olListener)
    {
        for(var i in this._olListener) MEvent.removeListener(this._olListener[i]);
    }
    KEvent.clear(this);
    if(this._opts && this._opts.infowin) KTools.removeNode(this._opts.infowin._contentDom);
    KOverlay.prototype.finalize.apply(this);
};
/*
 APIMPolyline
 wangzheng
 1.0
 2010-1-15
 2010-1-26
 */
var KArea = KClass.create("KArea", KLine);

/**
 * KArea
 * @param pts String 
 * @param opts KAreaOptions 
 */
KArea.initialize = function(pts, opts)
{
    this._opts = KTools.copyOptions(opts, KAreaOptions);
    this._opts.brush.fill = true;
    this._opts.hiliteBrush.fill = true;
    this._brush = this._opts.brush;
    this._group = this._opts.group;
    this._ol.brush.fill = true;
};

/**
 * 
 * @uncrunch
 */
KArea.prototype.hilite = function()
{
    //
    this.setBrush(this._opts.hiliteBrush);
};

/**
 * 
 * @uncrunch
 */
KArea.prototype.resume = function()
{
    //
    this.setBrush(this._brush);
};

/**
 * 
 * @param latlon MPoint 
 * @return Boolean 
 * @uncrunch
 */
KArea.prototype.contains = function(latlon)
{
    return _isInsidePolygon(latlon, this._ol.pts)
};

/**
 *  toString() 
 * @param str String 
 * @return KMarker 
 */
KArea.fromString = function(str)
{
    return KLine.fromString(str, KArea);
};

/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KArea.prototype.dependent = function()
{
    return [KLine, KAreaOptions, KTools];
};

/*
 API
 1.API
 2.
 3.BugKB
 :wangzheng
 :1.0
 :2010-1-15
 :2010-1-22 14:26

 */

var KMap = new (function() {
    this._isSelfEvt = true;
    // container //Dom - > Maplet
    var _hiddenJDom = $("<div style='display:none;'/>").appendTo(document.body);
    var _containers = {};
    var _containerList = [];
    // maplet->dom
    //Maplet
    var _maplets = {};
    var _map = undefined;
    //{group -> }
    var _markers = {};
    var _lines = {};
    var _areas = {};
    //
    var _currentMode;
    //maplet -> listener
    var _mapletListener = {};
    //@uncrunch maplet -> {evtname->Function[]}
    this.adapters = {};
    var _KSnapshotOptions = undefined;
    var _snapshot_select = undefined;
    var _snapshot_done = undefined;
    var _overviewRect = null;
    var _disableDiv = undefined;
    var _mapFishJDom = undefined;
    var _options = undefined;
    var mapContext = undefined;
    var _getOverlays = function(olObj, type, id)
    {
        if(!_map) return null;
        var typeOls;		
		var ms = [];
		if(typeof type == 'string' && (typeOls = olObj[type]))
		{
			if(typeof id == 'string') return typeOls[id];
            for(var i in typeOls) ms.push(typeOls[i]);
		} else {
			for(var i in olObj)
				for(var j in olObj[i]) ms.push(olObj[i][j]);
		}
		return ms;
    };
    var _clearOverlays = function(olObj, type)
    {
        if(!_map) return;
        _map.hideBubble();
        if (typeof type != 'string') type = "temp";
        var typeOls = olObj[type];
        if (!(typeOls instanceof Object)) return;
        for (var i in typeOls) _removeOverlay(olObj, typeOls[i]);
        delete olObj[type];
    };
    var _removeOverlay = function(olObj, ol)
    {
        if(olObj && ol && ol.group && _map)
        {
            if(olObj[ol.group()] && olObj[ol.group()][ol.id()])
            {
                _map.removeOverlay(ol.ol(), true);
                delete olObj[ol.group()][ol.id()];
                ol.finalize();
            }
        }
    };

    var _drawLineCallbakStr = function(str)
    {
        str = str.substring(str.indexOf(":") + 1);
        str = str.substring(0, str.lastIndexOf(","));
        var array = str.split(",");
        var _array = [];
        for (var i = 0; i < array.length; i ++)
            _array.push(new MPoint(array[i]));
        return _array;
    };

    /**
     * @return 
     * @uncrunch
     */
    this.version = function()
    {
        return "1.0";
    };

    /**
     * @return 
     * @uncrunch
     */
    this.cnname = function()
    {
        return "";
    };

    //
    /**
     * 
     * @param container
     * @param options
     * @uncrunch
     */
    this.init = function(container, options)
    {
        if (!KTools._isElement(container)) {
            return;
        }

        _options = options = KTools.copyOptions(options, KMapOptions);

        MOUSEWHEEL = options.mousewheel;
        container._timeCode = KTools.timeCode();
        
        var _maplet = _containers[container._timeCode] = new Maplet(container);
        //API
        maplet = _maplet;
        _maplet._$_timeCode = KTools.timeCode();
        _maplets[_maplet._$_timeCode] = container;
        _maplet.clickToCenter = options.click2center;
        mapContext = _maplet;
        switch (options.overview) {
            case KMapCtrlState.NORMAL :
                _maplet.showOverview(true, true);
                break;
            case KMapCtrlState.MEDIUM :
                break;
            case KMapCtrlState.MINI :
                _maplet.showOverview(true, false);
                break;
            case KMapCtrlState.HIDE :
                _maplet.showOverview(false);
                break;
        }

        switch (options.fishbone) {
            case KMapCtrlState.NORMAL :
                _maplet.addControl(new MStandardControl());
                break;
            case KMapCtrlState.MEDIUM :
                _maplet.addControl(new MStandardControl({
                    view : {ruler : false}
                }));
                break;
            case KMapCtrlState.MINI :
                _maplet.addControl(new MStandardControl({
                    view :
                    {
                        ruler : false
                        ,pan : false
                    }
                }));
                break;
            case KMapCtrlState.HIDE :
                _maplet.addControl(new MStandardControl({
                    view :
                    {
                        ruler : false
                        ,pan : false
                        ,zoomout : false
                        ,zoomin : false
                    }
                }));
                break;
        }
        _maplet.centerAndZoom(options.center, options.zoom);
        if (!_map) _map = _maplet;
        _mapFishJDom = $(_maplet.controlCanvas.dom);
        var _oldZoom = options.zoom;
        var _oldCenter = options.center;
        _mapletListener["zoomed"] = MEvent.addListener(_maplet, "zoom", function(info) {
            var zoom = parseInt(KTools._getParam(info, "zm"));
            var vBound = _map.getViewBound();
            var bounds = new KMapBounds(new MPoint(vBound.LeftDown), new MPoint(vBound.RightUp), _maplets[_map._$_timeCode]);
            if(_map.getCenter() != _oldCenter)
            {
                _oldCenter = _map.getCenter();
                KEvent.trigger(_map, 'centerchanged', _maplets[_map._$_timeCode], new MPoint(_oldCenter));
            }
            KEvent.trigger(_map, 'zoomed', _maplets[_map._$_timeCode], _oldZoom, parseInt(KTools._getParam(info, "zm")), _map.getCenter(),  bounds);
            _oldZoom = zoom;
        });
		//openBubblePan true
        _mapletListener["pan"] = MEvent.addListener(_maplet, "pan", function(point, openBubblePan) {
            if(_map.getCenter() != _oldCenter)
            {
                _oldCenter = _map.getCenter();
                KEvent.trigger(_map, 'centerchanged', _maplets[_map._$_timeCode], new MPoint(_oldCenter), openBubblePan);
            }
        });
		/*add by liufang 20131203 start
		  
		*/
		_mapletListener["mousedown"] = MEvent.addListener(_maplet, "mousedown", function(e) {
            KEvent.trigger(_map, 'mousedown', _maplets[_map._$_timeCode], e);
        });
		/*add by liufang 20131203 end*/
		
		_currentMode = KMapMode.PAN;
        var _uOCenter = _oldCenter;
        var _uOZoom = _oldZoom;
        _mapletListener["update"] = MEvent.addListener(_maplet, "update", function(point) {
            if(_map.getCenter() != _uOCenter || _map.getZoomLevel() != _uOZoom)
            {
                _uOCenter = _map.getCenter();
                _uOZoom = _map.getZoomLevel();
                var vBound = _map.getViewBound();
                var bounds = new KMapBounds(new MPoint(vBound.LeftDown), new MPoint(vBound.RightUp));
                KEvent.trigger(_map, 'geocode', _maplets[_map._$_timeCode], _uOZoom, new MPoint(_uOCenter), bounds);
            }
        });


        _mapletListener["snapshot"] = MEvent.addListener(_map, "snapshot", function(info) {

            if(!_snapshot_select)
            {
                if(_KSnapshotOptions && _KSnapshotOptions.oncomplete)
                {
                    with(_KSnapshotOptions.oncomplete)
                    {
                        fun.apply(thisobj, [data, info]);
                    }
                    _snapshotIng = false;
                }
                _KSnapshotOptions = undefined;
                return;
            }
            var _opt = {latlon:new MPoint(_map.getCenter()), zoom:_map.getZoomLevel(), size: _snapshot_select.size(), format:"png"};
            _snapshot_select = undefined;
            KEvent.trigger(_map, 'snapshot', _maplets[_map._$_timeCode], _snapshot_done, _opt, info);
        });

        _mapletListener["snapshot_done"] = MEvent.addListener(_map, "snapshot_done", function(info) {
            if (info == 'preview')
            {
                _snapshot_done = info;
            } else {
                var _opt = {latlon:new MPoint(_map.getCenter()), zoom:_map.getZoomLevel(), size: _snapshot_select.size(), format:"png"};
                KEvent.trigger(_map, 'snapshot', _maplets[_map._$_timeCode], info, _opt, "");
            }
            setTimeout(function() {
                KMap.setMode(KMapMode.PAN);
            });
        });
        _mapletListener["snapshot_select"] = MEvent.addListener(_map, "snapshot_select", function(_obj) {
            _snapshot_select = new KBounds(new KPoint(_obj.x, _obj.y), new KPoint(_obj.x + _obj.width, _obj.y + _obj.height));
        });

		_mapletListener["setmode"] = MEvent.addListener(maplet, "setmode", function(mode){
			var _newMode;
			if(mode == "pan") {
				//dsl
				_newMode = KMapMode.PAN;
			} else if(mode == "measure") {
				_newMode = KMapMode.MEASURE;
			} else {
				return;
			}

			KEvent.trigger.apply(_map, [_map, 'modechanged', _maplets[_map._$_timeCode], _currentMode, _newMode]);
			_currentMode = _newMode;
		});
		_mapletListener["roadline"] = MEvent.addListener(maplet, "roadline", function(nodes, lines) {
			var _nodes = [];
			for(var i = 0; i < nodes.length; i++) {
				_nodes.push(nodes[i].pt);
				maplet.removeOverlay(nodes[i]);
			}
			var _lines = [];
			for(var i = 0; i < lines.length; i++) {
				_lines = _lines.concat(lines[i].pts);
				maplet.removeOverlay(lines[i]);
			}
			KEvent.trigger(KMap, 'roadline', _maplets[_map._$_timeCode], _nodes, _lines);
		});
		//
		_mapletListener["iw_hide"] = MEvent.addListener(_map, "iw_hide", function(mol) {
			var kol;
			//ols =={group:{ id_23:}}
			var getKol = function(ols) {
				var ol;
				if (!ols) {
					return;
				}
				for ( var g in ols) {
					if (ols[g]) {
						for ( var h in ols[g]) {
							if (ols[g][h] && ols[g][h]._ol && ols[g][h]._ol === mol) {
								ol = ols[g][h];
								break;
							}
						}
					}
					if (ol) {
						break;
					}
				}
				return ol;
			};
			//
			kol = getKol(_markers) || getKol(_lines) || getKol(_areas) || mol; 
			//
			KEvent.trigger(KMap, 'iw_hide', _containerList[0], kol);
		});
		//
        _containerList.push(container);
        KEvent.trigger.apply(_map, [KMap, 'mapinit', container, _map]);
    };

    this._removeOverlay = function(ol)
    {
        if (ol instanceof KMarker)
            delete _markers[ol.group()][ol.id()];
        else if (ol instanceof KLine)
            delete _lines[ol.group()][ol.id()];
        else if (ol instanceof KArea)
                delete _areas[ol.group()][ol.id()];
        _map.removeOverlay(ol.ol(), true);
    };

    	
    /**
     * Mapletcontainer
     * @param container
     * @return Maplet
     * @uncrunch
     */
    this.maplet = function(container)
    {
        if(KTools._isElement(container)) return _containers[container._timeCode];
        if(_containerList.length > 0) return _containers[_containerList[0]._timeCode];
        return undefined;
    };

    /**
     * container
     * @param container node
     * @uncrunch
     */
    this.isInitialized = function(container)
    {
        if(_containers) {
            if(KTools._isElement(container))  return !!_containers[container._timeCode];
            if(_containerList && _containerList.length > 0) return !!_containers[_containerList[0]._timeCode];
        }
        return false;
    };

    /**
     * KMapKMap.init()
     * @param container
     * @uncrunch
     */
    this.setCurrentMap = function(container)
    {
        _map = this.maplet(container);
    };

    /**
     * 
     * return Maplet
     * @uncrunch
     */
    this.getCurrentMap = function()
    {
        return _map;
    };

	/**
     * 
     * return KMapMode  
     * @uncrunch
     */
	this.mode = function()
	{
		return _currentMode;
	};

    /**
     * 
     * @param mode  KMapMode
     * @uncrunch
     */
    this.setMode = function(mode)
    {
        if (!_map || !KMapMode[mode]) return;
        //DISABLE  	?
        //SNAPSHOT  	?
        switch (mode) {
            case KMapMode.DISABLE :
                if (!_disableDiv)  _disableDiv = $("<div style=' position: absolute;left:0px;top:0px;width:100%;height:100%;display:none; z-index:99999999;*Filter: Alpha(Opacity=50);-moz-opacity:0.5;opacity: 0.5; background:#fff;'/>").appendTo(_map.map);
                _disableDiv.css("display", 'block');
                MOUSEWHEEL = false;
                break;
            case KMapMode.SNAPSHOT :
                if (_disableDiv)_disableDiv.css("display", 'none');
                MOUSEWHEEL = _options.mousewheel;
                if (_mapFishJDom) _mapFishJDom.css("display", 'none');
                _overviewRect = this.getOverviewRect();
                _map.showOverview(false);
                _map.setMode(mode);
                _map.showScale(false);
                break;
            case KMapMode.PAN :
                KMap.resumeMap();
                _map.setMode("pan");
                break;
            default :
                if (_disableDiv)_disableDiv.css("display", 'none');
                MOUSEWHEEL = _options.mousewheel;
                if(mode == KMapMode.ROADLINE)
				{
					_map.setMode('roadline');
				}
				else _map.setMode(mode);
        }
		if(mode == KMapMode.PAN || mode == KMapMode.MEASURE) return;
		//var out:
        KEvent.trigger.apply(_map, [_map, 'modechanged', _maplets[_map._$_timeCode], _currentMode, mode]);
        _currentMode = mode;
    };

    /**
     * @uncrunch
     */
    this.resumeMap = function()
    {
        if(_overviewRect) _map.showOverview(_overviewRect.v, _overviewRect.s);
        _map.showScale(true);
        if (_mapFishJDom) _mapFishJDom.css("display", 'block');
        MOUSEWHEEL = _options.mousewheel;
    };

    /**
     * @uncrunch
     */
    this.getOverviewRect  = function()
    {
        var _rect = _map.overview.getRect();
        return {v:(_rect.max.x - _rect.min.x != 0), s:(_rect.max.x - _rect.min.x > 30)};
    };

    

    /**
     * 
     * @param type String "temp"
     * @param marker KMarker 
     * @param center Boolean markerfalse
     * @param openiw Boolean markerfalse
     * @uncrunch
     */
    this.addMarker = function(marker, center, openiw)
    {
        if (!_map || !(marker instanceof KMarker)) return;
        var group = marker.group();
        if (!(_markers[group] instanceof Object)) _markers[group] = {};
        marker._mc = _maplets[_map._$_timeCode];
        _markers[group][marker.id()] = marker;
        _map.addOverlay(marker.ol());
        marker._visible = true;
        if (typeof center != 'boolean') center = false;
        if (center) this.setCenter(marker.latlon());
        if (typeof openiw != 'boolean') openiw = false;
        if (openiw) this.openInfoWindow(marker);
        //container: Node Dom
        //marker: KMarker 
        KEvent.trigger.apply(_map, [_map, 'addmarker', _maplets[_map._$_timeCode], marker]);
    };

    /**
     * 
     * @param type String "temp"
     * @param markers KMarker[] 
     * @param autozoom Boolean true
     * @uncrunch
     */
    this.addMarkers = function(markers, autozoom)
    {
        if (!_map || !(markers instanceof Array)) return;
        if (typeof autozoom != 'boolean') autozoom = true;
        for (var i = 0; i < markers.length; i++) this.addMarker(markers[i], false, false);
        if (autozoom) _map.setAutoZoom();
    };

    /**
     * 
     * @return MPoint 
     * @uncrunch
     */
    this.center = function()
    {
        if(_map) return new MPoint(_map.getCenter());
        return null;
    };

    /**
     * 
     * @return Integer K_MIN_ZOOM_LEVELK_MAX_ZOOM_LEVEL
     * @uncrunch
     */
    this.zoom = function()
    {
        if(_map) return _map.getZoomLevel();
        return null;
    };

    /**
     * @uncrunch
     */
    this.centerAndZoom = function(latlon, zoom)
    {
        if(!_map || !latlon || typeof zoom != "number") return;
        var point = latlon;
        if(typeof point === "string") point = new MPoint(latlon);
        _map.hideBubble();
        _map.centerAndZoom(point, zoom);
    };
    /**
     *  level 
     * @uncrunch
     */
    this.setCenter = function(latlon, level)
    {
        if(!_map || !latlon) return;
        var point = latlon;
        if(typeof point === "string") point = new MPoint(latlon);
        if(typeof level === 'number') _map.centerAndZoom(point, level);
        else _map.setCenter(point);
    };

    /**
     * 
     * @param type String "temp"
     * @param line KLine 
     * @param autozoom Boolean false
     * @uncrunch
     */
    this.addLine = function(line, autozoom)
    {
        if (!_map || !(line instanceof KLine)) return;
        var group = line.group();
        if (!(_lines[group] instanceof Object)) _lines[group] = {};
        line._mc = _maplets[_map._$_timeCode];
        _lines[group][line.id()] = line;
        _map.addOverlay(line.ol());
        line._visible = true;
        if (typeof autozoom != 'boolean') autozoom = false;
        if (autozoom) _map.setAutoZoom();
        KEvent.trigger.apply(_map, [_map, 'addline', _maplets[_map._$_timeCode], line]);
    };

    /**
     * 
     * @param type String "temp"
     * @param lines KMarker[] 
     * @param autozoom Boolean true
     * @uncrunch
     */
    this.addLines = function(lines, autozoom)
    {
        if (!_map || !(lines instanceof Array)) return;
        if (typeof autozoom != 'boolean') autozoom = true;
        for (var i = 0; i < lines.length; i++) this.addLine(lines[i], false);
        if (autozoom) _map.setAutoZoom();
    };

    /**
     * 
     * @param type String "temp"
     * @param area KArea 
     * @param autozoom Boolean false
     * @uncrunch
     */
    this.addArea = function(area, autozoom)
    {
        if (!_map || !(area instanceof KArea)) return;
        var group = area.group();
        if (!(_areas[group] instanceof Object)) _areas[group] = {};
        area._mc = _maplets[_map._$_timeCode];
        _areas[group][area.id()] = area;
        _map.addOverlay(area.ol());
        area._visible = true;
        if (typeof autozoom != 'boolean') autozoom = false;
        if (autozoom) _map.setAutoZoom();
        KEvent.trigger.apply(_map, [_map, 'addarea', _maplets[_map._$_timeCode], area]);
    };

    /**
     * 
     * @param type String "temp"
     * @param areas KArea[] 
     * @param autozoom Boolean true
     * @uncrunch
     */
    this.addAreas = function(areas, autozoom)
    {
        if (!_map || !(areas instanceof Array)) return;
        if (typeof autozoom != 'boolean') autozoom = true;
        for (var i = 0; i < areas.length; i++) this.addLine(areas[i], false);
        if (autozoom) _map.setAutoZoom();
    };

    /**
     * id
     * @param type String "temp"
     * @param id String  KMarkerid
     * @uncrunch
     */
    this.getMarkers = function(group, id)
    {
        return _getOverlays(_markers, group, id);
    };

    /**
     * id
     * @param type String "temp"
     * @param id String  ID
     * @uncrunch
     */
    this.getLines = function(group, id)
    {
        return _getOverlays(_lines, group, id);
    };

    /**
     * KLineid
     * @param type String "temp"
     * @param id String  ID
     * @uncrunch
     */
    this.getAreas = function(group, id)
    {
        return _getOverlays(_areas, group, id);
    };

    /**
     * type
     * @param type String "temp"
     * @uncrunch
     */
    this.clearMarker = function(group)
    {
        if(!_map) return;
        _clearOverlays(_markers, group);
    };

    /**
     * type
     * @param type String "temp"
     * @uncrunch
     */
    this.clearLine = function(group)
    {
        if(!_map) return;
        _clearOverlays(_lines, group);
    };

    /**
     * type
     * @param type String "temp"
     * @uncrunch
     */
    this.clearArea = function(group)
    {
        _clearOverlays(_areas, group);
    };

    /**
     * 
     * @param marker KMarker 
     * @uncrunch
     */
    this.removeMarker = function(marker)
    {
        _removeOverlay(_markers, marker);
    };
    
    /**
     * 
     * @param line KLine 
     * @uncrunch
     */
    this.removeLine = function(line)
    {
        _removeOverlay(_lines, line);
    };

    /**
     * 
     * @param area KArea 
     * @uncrunch
     */
    this.removeArea = function(area)
    {
        _removeOverlay(_areas, area);
    };

    /**
     * type
     * @param type String "temp"
     * @uncrunch
     */
    this.clear = function(group)
    {
        this.clearMarker(group);
        this.clearLine(group);
        this.clearArea(group);
    };

    /**
     * 
     * Boolean truetrue
     * @uncrunch
     */
    this.checkCenter = function()
    {
        return _map.getCenter() == "NANRNANZNANRNAN";
    };

    /**
     * statestateKMapCtrlState.NORMAL
     * @param state KMapCtrlState 
     * @uncrunch
     */
    this.setCtrlState = function(state)
    {
        if(!_map) return;
        if (!state) state = KMapCtrlState.NORMAL;
        switch (state) {
            case KMapCtrlState.NORMAL :
                _map.controlCanvas.setView({
                    ruler : true
                    ,pan : true
                    ,zoomout : true
                    ,zoomin : true
                });
                _map.showOverview(true, true);
                break;
            case KMapCtrlState.MEDIUM :
                _map.controlCanvas.setView({
                    ruler : false
                    ,pan : true
                    ,zoomout : true
                    ,zoomin : true
                });
                break;
            case KMapCtrlState.MINI :
                _map.controlCanvas.setView({
                    ruler : false
                    ,pan : false
                    ,zoomout : true
                    ,zoomin : true
                });
                _map.showOverview(true, false);
                break;
            case KMapCtrlState.HIDE :
                _map.controlCanvas.setView({
                    ruler : false
                    ,pan : false
                    ,zoomout : false
                    ,zoomin : false
                });
                _map.showOverview(false);
                break;
        }
    };

    /**
     *  container  container 
     * @param size KSize
     * @param container NODE
     * @uncrunch
     */
    this.resize = function(size, container)
    {
    	try{
    		if(!(size instanceof KSize)) return;
	        var _maplet = this.maplet(container);
	        if(!_maplet) _maplet = _map;
	        _maplet.resize(size.width, size.height);
    	}catch(e){
    		//try catch  ie6js
    	}
       
    };

    /**
     * latlons  
     * @param latlons MPoint[] 
     * @return Object min  max MPoint  
     * @uncrunch
     */
    this.maxmin = function(latlons)
    {
        var _mm = {};
        if(_map && latlons instanceof Array && latlons.length > 0)
        {
            var _maxX,_maxY,_minX,_minY;
            for(var i = 0; i < latlons.length; i++)
            {
                var pt = latlons[i];
                if(pt instanceof MPoint)
                {
                    if(!pt.maplet) pt.initialize(_map);
                    if(_maxX == undefined)
                    {
                        _maxX = pt.mapX;
                        _maxY = pt.mapY;
                        _minX = pt.mapX;
                        _minY = pt.mapY;
                    } else {
                        if(_maxX < pt.mapX) _maxX = pt.mapX;
                        if(_maxY < pt.mapY) _maxY = pt.mapY;
                        if(_minX > pt.mapX) _minX = pt.mapX;
                        if(_minY > pt.mapY) _minY = pt.mapY;
                    }
                }
            }
            if(_maxX != undefined)
            {
                _mm.min = new MPoint(_map.toMapCoordinate(_minX, _minY));
                _mm.max = new MPoint(_map.toMapCoordinate(_maxX, _maxY));
            }
        }
        return _mm;
    };

    /**
     *  pts 
     * @param latlons MPoint[] 
     * @uncrunch
     */
    this.fitzoom = function(latlons)
    {
        if(_map)
        {
            var min, max;
            if(latlons instanceof Array && latlons.length > 1)
            {
                if(latlons.length != 2)
                {
                    var _mm = this.maxmin(latlons);
                    min = _mm.min;
                    max = _mm.max;
                } else {
                    min = latlons[0];
                    max = latlons[1];
                }
            }
            if(!(min instanceof MPoint) || !(max instanceof MPoint))
                _map.setAutoZoom();
            else {
                var rt = _map.getFitZoomLevel(min, max);
                if(rt.center instanceof MPoint)
                {
                    if(typeof rt.level == "number") _map.centerAndZoom(rt.center, rt.level);
                    else _map.setCenter(rt.center);
                }
            }
        }
    };
    var _cursorTip = null;
    var _cursorTipEvent = null;
    var _cursorTipDom = null;
    /**
     *  content  KMap.hideCursorTip()  
     * @param content
     * @uncrunch
     */
    this.showCursorTip = function(content)
    {
        if(!content || !_map) return;

        if(!_cursorTipDom) _cursorTipDom = $(KConfig.get("map_s_ct",{n:'&nbsp;'}));
        if(!_cursorTip)
        {
            _cursorTip = new MPanel({content:_cursorTipDom.get(0), location:{type:"xy"}});
            _map.addPanel(_cursorTip);
            _cursorTip.show();
        }
        if(KTools._isElement(content))
        {
            _cursorTipDom.empty();
            _cursorTipDom.append(content);
        } else _cursorTipDom.html(content);
        _cursorTip.setLocation({x:maplet.moveX+10,y:maplet.moveY});
        var tSize = KTools.getBounds(_cursorTip.dom).size();

        if(!_cursorTipEvent)
        {
            _cursorTipEvent = {};
            _cursorTipEvent["mousemove"] = MEvent.addListener(_map, "mousemove", function(e, point){
                _cursorTip.show();
                _cursorTip.setLocation({x:maplet.moveX+10,y:maplet.moveY-tSize.height/2});
            });
        }
    };

    /**
     * 
     * @uncrunch
     */
    this.hideCursorTip = function(content)
    {
        if(_map)
        {
            if(_cursorTip)
            {
                _map.removePanel(_cursorTip, true);
                _cursorTip = null;
            }
            if(_cursorTipEvent)
            {
                MEvent.removeListener(_cursorTipEvent["mousemove"]);
                _cursorTipEvent = null;
            }
        }
    };

    var _commIW = null;
    var _commIWContentJDom = null;
    var _commIWUserJDom = null;
    var _commIWCommJDom = null;
    var _commRootDivs = null;
    var _commIWCommBts = null;
    var _commIWCommDivs = null;
    var _commIWCommInputTexts = null;
    var _commIWCommForms = null;
    var _commIWCommInputBts = null;
    var _commKMarker = null;
    var _commIWNavLinks = null;
    var _commDefaultIcon = $('<div style="width:0px;height:0px;font-size:0px;"></div>');
    var _lastOpenKOL = null;
    
    //suggestdom
    var _iwddInputDom = null; 
    var _iwcfInputDom = null; 
    var _iwzbInputDom = null; 
    var _iwddInputSuggest = null;
    var _iwcfInputSuggest = null; 
    var _iwzbInputSuggest = null; 
    
    //suggest    
    var _getSuggestUrl = function() {
    	var url = window.location.href + '';
    	url = url.replace('#','&');
    	url = KUrlHash.parseByHash(url)._UrlHash;
    	var currentCity = '';
    	try{
    		if(url['c']){
    			currentCity = url['c'];
    		};    		
    	}catch(e){};
    	var sugopts = "./s?s=json&t=ks&c=" + encodeURIComponent(encodeURIComponent(currentCity));
    	return sugopts;
    };
    var _inputSuggestArray = [];
    
    //suggest
    var _setAttr = function(dom, num){
    	var minWidth = [117,117,190];
    	var sugurl = _getSuggestUrl();
    	dom.attr('mfg','ls');
    	dom.attr('autocomplete','off');
    	dom.selector = "#infowin_cm input[mfg='ls']";
    	if (_inputSuggestArray && typeof _inputSuggestArray[num] != "undefined") {
    		_inputSuggestArray[num].clearCache();
    		if(dom.attr('class').indexOf('mwpg_iw_cur') < 0 && !dom.val()){
            	dom.attr('class',dom.attr('class')+' mwpg_iw_cur');
        	}
    		_inputSuggestArray[num].setOptions( {
    			url : sugurl
    		});
    	}else {
    		_inputSuggestArray[num] = new KStdSuggest(dom, {
				'url' : sugurl,
				'autocomplete' : false,
				'listlimit' : 5,
				'minwidth' : minWidth[num],
				'cache':false
    		});
    	}
    };
    
    var _makeCommIW = function()
    {
    	MEvent.addListener(_map, "iw_hide",function() {
            _commIWContentJDom.appendTo(_hiddenJDom);
            if(_lastOpenKOL === _commKMarker) _map.removeOverlay(_commKMarker.ol());
			if(_lastOpenKOL) _lastOpenKOL._openedInfo = false;
        });
        _commIWContentJDom = $("" + KConfig.get("iw_cm") + "");
        var _divs = $(">div", _commIWContentJDom);
        _commIWUserJDom = _divs.eq(0);	//_ic  
        _commIWCommJDom = _divs.eq(1);	//_iw 
        _commRootDivs = $(">div", _commIWCommJDom);		//
        _commIWNavLinks = $(">a", _commRootDivs.eq(2));		//
        _commIWCommBts = $(">ul:eq(0) >li",_commRootDivs.eq(0));	//
        _commIWCommDivs = $(">div", _commRootDivs.eq(0));	//
        _commIWCommForms = $(">form",_commIWCommDivs);		//form
        _commIWCommInputTexts = $("input[type='text']",_commIWCommForms);    
        _commIWCommInputBts = $("input[type='button']",_commIWCommForms);
        _initCommEvents();
        _commIW = new MInfoWindow("", _commIWContentJDom[0]);
        _commKMarker = new KMarker("HETCUFZVVHUEE", {icon:{img:_commDefaultIcon[0]}});
        
        //suggest               
        _iwddInputDom = _commIWCommInputTexts.eq(0);
        _iwcfInputDom = _commIWCommInputTexts.eq(1);
        _iwzbInputDom = _commIWCommInputTexts.eq(2);        
        _setAttr(_iwddInputDom,0);
        _setAttr(_iwcfInputDom,1);
        _setAttr(_iwzbInputDom,2);        
        _iwddInputDom.focus(function(){		_setAttr(_iwddInputDom,0);     	});
        _iwcfInputDom.focus(function(){   	_setAttr(_iwcfInputDom,1);    	});
        _iwzbInputDom.focus(function(){ 	_setAttr(_iwzbInputDom,2);    	});
        
        _iwddInputDom.blur(function(){		
        	if(_iwddInputDom.attr('class').indexOf('mwpg_iw_cur') > 0){
        		_iwddInputDom.attr('class',_iwddInputDom.attr('class').replace(' mwpg_iw_cur',''));
    	} 	});
        _iwcfInputDom.blur(function(){		
        	if(_iwcfInputDom.attr('class').indexOf('mwpg_iw_cur') > 0){
        		_iwcfInputDom.attr('class',_iwcfInputDom.attr('class').replace(' mwpg_iw_cur',''));
    	} 	});
        _iwzbInputDom.blur(function(){		
        	if(_iwzbInputDom.attr('class').indexOf('mwpg_iw_cur') > 0){
        		_iwzbInputDom.attr('class',_iwzbInputDom.attr('class').replace(' mwpg_iw_cur',''));
    	} 	});
    };
    var _alertmsg = function(dom){
      KTools.showMsg('<div style="padding:5px 10px 5px 10px;font-size:13px;"></div>', {title:"",lightbox:true,closedcbk:function(){_lastOpenKOL&&_lastOpenKOL._openedInfo&&dom.focus();},buboptions:{outside:false,closebtn:true}});
    };
    var _btClickOrFormSubm = function(){
        var _poi = _lastOpenKOL.options().infowin.cmdata.poi;
        var _inputPoi = {city: _poi.city};
        var _flag,queryOpts = {};
        var _cookieKey;
        if(typeof this._btI != "undefined")
        {
            if(this._btI < 2)
            {
                if(_commIWCommInputTexts[0].value == "") {_alertmsg(_commIWCommInputTexts[0]);return false;}
                _inputPoi.name = _commIWCommInputTexts[0].value;
                _cookieKey = "ls";
                if(this._btI == 0)
                {
                    queryOpts.busdest = _poi;
                    queryOpts.busorig = _inputPoi;
                } else {
                    queryOpts.navdest = _poi;
                    queryOpts.navorig = _inputPoi;
                }
            } else {
                if(_commIWCommInputTexts[1].value == "") { _alertmsg(_commIWCommInputTexts[1]);return false;}
                _inputPoi.name = _commIWCommInputTexts[1].value;
                _cookieKey = "ls";
                if(this._btI == 2)
                {
                    queryOpts.busdest = _inputPoi;
                    queryOpts.busorig = _poi;
                } else {
                    queryOpts.navdest = _inputPoi;
                    queryOpts.navorig = _poi;
                }
            }
            _flag = (this._btI % 2 == 0)? KWidgetFlag.busearch : KWidgetFlag.navsearch;
        } else {
            if(_commIWCommInputTexts[2].value == "") {_alertmsg(_commIWCommInputTexts[2]); return false;}
            _cookieKey = "nb";
            _flag = KWidgetFlag.localsearch;
            queryOpts.center = _poi;
            _inputPoi.name = _commIWCommInputTexts[2].value;
            queryOpts.ls = _inputPoi;
        }
        var _newValue = _inputPoi.name;
        if(_cookieKey == "nb")
        {
            _newValue = _poi.name + ":" + _newValue;
        }
        {
            var _oldCookie = KTools.getCookie(_cookieKey);
            if(typeof _oldCookie == "string")
            {
                var _newValue_ = _newValue.replace(/([\?\*\\\[\]\(\)\{\}\^\$])/ig,"\\$1");
                if(_oldCookie != _newValue && !new RegExp("^"+_newValue_ + ",").test(_oldCookie) && !new RegExp(","+_newValue_ + "$").test(_oldCookie) && _oldCookie.indexOf(","+_newValue_ + ",") == -1)
				{
					var _douM = _oldCookie.match(/\,/ig);
					if(_douM && _douM.length >= 4) _oldCookie = _oldCookie.replace(/^[^\,]*\,/, "");
					_oldCookie += "," + _newValue;
					KTools.setCookie(_cookieKey, _oldCookie);
				}
            } else  KTools.setCookie(_cookieKey, _newValue);
        }

        queryOpts.type = _flag;
        KEvent.trigger(KMap, "cmfun", _containerList[0], queryOpts);
        return false;
    };
    var _hisClickFun = function(evt)
    {
        var _index = evt.data._index;
        var _str = evt.data._str;
        _commIWCommInputTexts.eq(_index).get(0).value = _str;
        if(_index === 2) KEvent.trigger(_commIWCommForms[2], "submit");
    };
    var lastSelectBt = null;
    var _btClickFun = function(){
        if(lastSelectBt && lastSelectBt._selected)
        {
            lastSelectBt._selected = false;
            _commIWCommDivs.eq(lastSelectBt._index).removeClass("mwpg_iw_cs");
            $(lastSelectBt).removeClass("mwpg_iw_s");
        }
        if(!this._selected)
        {
            lastSelectBt = this;
            this._selected = true;
            _commIWCommDivs.eq(this._index).addClass("mwpg_iw_cs");
            $(this).addClass("mwpg_iw_s");
            
            var his = _commIWCommDivs.eq(3);
            var hisList;
            switch(this._index)
            {
                case 0:hisList = KTools.getCookie("ls");break;
                case 1:hisList = KTools.getCookie("ls");break;
                case 2:
                    hisList = KTools.getCookie("nb");
                    if(hisList) hisList = hisList.replace(/[^,]*:/ig, "");
                    break;
            }
            if(hisList)
            {
                $("a", his).each(function(){
                    KEvent.clear(this);
                });
                his.html("");
                hisList = hisList.split(",");
                var _temp = ",";
                for(var i = 0; i < hisList.length; i++)
                {
                    var str = hisList[i];
                    if(!str || _temp.indexOf(","+str + ",") != -1) continue;
                    _temp += str + ",";
                    var a = $('<a href="javascript:void(0);">'+str+'</a>')[0];
                    KEvent.bind(a, "click", _hisClickFun, {_index:this._index, _str:str});
                    his.append(a);
                    his.append("&nbsp;");
                }
                his.show();
                _commRootDivs.eq(1).hide();
            } else {
                his.hide();
                //div
             //   _commRootDivs.eq(1).show();
            }
        }
    };
    var _leveAsClickFun = function(){
        switch($(this).text()){
            case "" :
                    _map.setZoomLevel(4);
                    break;
            case "" :
                    _map.setZoomLevel(8);
                    break;
            case "" :
                    _map.setZoomLevel(10);
                    break;
            case "" :
                    _map.setZoomLevel(13);
                    break;
            case "" :
                    var cmdata = _lastOpenKOL.options().infowin.cmdata;
                    if(cmdata.allinecbk && cmdata.allinecbk.fun)
                        cmdata.allinecbk.fun.apply(cmdata.allinecbk.thisobj, [cmdata.allinecbk.data]);
                    break;
        };
    };

    var _initCommEvents = function()
    {
        var i = 0;
        _commIWCommBts.each(function(){
            this._index = i++;
            _commIWCommDivs.eq(this._index).removeClass("mwpg_iw_cs");
            $(this).removeClass("mwpg_iw_s");
            KEvent.bind(this, "click", _btClickFun);
        });
        //
        _commIWNavLinks.each(function(){
            KEvent.bind(this, "click", _leveAsClickFun);
        });
        //

        var _btI = 0;
        _commIWCommInputBts.each(function() {
            this._btI = _btI++;
            KEvent.bind(this, "click", _btClickOrFormSubm);
        });

        
        KEvent.bind(_commIWCommForms[2], "submit", _btClickOrFormSubm);
    };
    //c 
    var _updateComm = function(c)
    {
        var his = _commIWCommDivs.eq(3);
        his.hide();
        //
        KEvent.trigger(_commIWCommBts.get(c), "click");
        //
        _commIWCommInputTexts.each(function(){
            this.value = "";
        });
    };

    /**
     * 
     * @param overlay :KOverlay  /latlon MPoint /pt KPoint
     * @param opts KInfoWindowOptions
     * @param size KSize
     * @param   trueafteropeninfowindow
     * @uncrunch
     */
    this.openInfoWindow = function(overlay, opts, size)
    {
        if(!_commIW) _makeCommIW();
        if(typeof overlay != "object" || !_map) return;
        if(_lastOpenKOL && _lastOpenKOL.ol) {
            if(_lastOpenKOL != overlay)
            {
                _lastOpenKOL.ol().setInfoWindow(null);
				_lastOpenKOL._openedInfo = false;
            }
            _lastOpenKOL = null;
        }
        if(typeof overlay === "string" && overlay.length >= 13)
        {
            this.openInfoWindow(new MPoint(overlay), opts, size);
        } else if(overlay instanceof KPoint)
        {
            this.openInfoWindow(new MPoint(_map.toMapCoordinate(overlay.x, overlay.y)), opts, size);
        } else if(overlay instanceof MPoint)
        {
            if(!(size instanceof MPoint)) size = new KSize(0, 0);
            _map.addOverlay(_commKMarker.ol());
            _commKMarker.setOptions({infowin:null});
            _commKMarker.setOptions({infowin:opts});
            _commKMarker.setLatlon(overlay);
            this.openInfoWindow(_commKMarker);
        } else if(overlay.isKClassO && overlay.superclassOf(KOverlay))
        {
            var _ol = overlay.ol();
            var _iw = overlay.options().infowin;
            if(!_iw) return;
            if(!_iw._contentDom)
            {
                if(typeof _iw.content === 'string' && _iw.content.length > 0)
                {
                    _iw._contentDom = $("<div>"+_iw.content+"</div>")[0];
                } else {
                    _iw._contentDom = _iw.content;
                }
            }
			_commIWUserJDom.children().eq(0).appendTo(_hiddenJDom);
            _commIWUserJDom.append(_iw._contentDom);
//            _commIWUserJDom.empty().append(_iw._contentDom);
            _commIWCommJDom.hide();
            _commIWNavLinks.eq(4).hide();
            if(_iw.cmarea)
            {
                _commIWCommJDom.show();
                _commRootDivs.eq(0).hide();
                _commRootDivs.eq(1).hide();
                _commRootDivs.eq(2).show();
                _commRootDivs.eq(2).css("padding", "0px");
                if(_iw.cmdata){
                    _commRootDivs.eq(2).css("padding", "");
                    if(_iw.cmdata.poi)
                    {
                        _commRootDivs.eq(0).show();
                        //  
                        if(overlay.menunb){
                        	_updateComm(2);
                        }else{
                        	_updateComm(0);
                        }
                        
                    }
                    if(_iw.cmdata.navigator == false) _commRootDivs.eq(2).hide();
                    if(_iw.cmdata.allinecbk) _commIWNavLinks.eq(4).show();
                }
            }
            _commIW.setTitle(_iw.title);

            // overlay._classObj  poi
            if(overlay._classObj){
                KEvent.trigger(overlay._classObj, "beforeopeninfowindow", _containerList[0], overlay);
            }else{
                KEvent.trigger(KMap, "beforeopeninfowindow", _containerList[0], overlay);
            }

            _ol.setInfoWindow(_commIW);
			_ol.openInfoWindow();
            _lastOpenKOL = overlay;
			_lastOpenKOL._openedInfo = true;
			//   trueafteropeninfowindow
            if(!arguments[3]) {
            	// overlay._classObj  poi
            	if(overlay._classObj){
                    KEvent.trigger(overlay._classObj, "afteropeninfowindow", _containerList[0], overlay);
            	}else{
                    KEvent.trigger(KMap, "afteropeninfowindow", _containerList[0], overlay);
                }
            };
        }
    };

    /**
     * 
     * @uncrunch
     */
    this.closeInfoWindow = function()
    {
        if(_map) _map.hideBubble();
    };

	
	/**
     * 
	 * imgsrc String 
     * @uncrunch
     */
	this.setCursorIcon = function(imgsrc)
	{
		if(typeof imgsrc == "string" && _map)
		{
			_map.setCursorIcon(imgsrc);
		}
	};

    var _snapshotIng = false;
	
	/**
     * @uncrunch
     */
    this.snapshot = function(opts)
    {
        _KSnapshotOptions = KTools.copyOptions(opts, KSnapshotOptions);
        if(!_KSnapshotOptions.oncomplete) return;
        if(_map) {
            with(_KSnapshotOptions)
            {
                if(!latlon) latlon = new MPoint(_map.getCenter());
                if(typeof zoom != 'number') zoom = _map.getZoomLevel();
                if(!size) size = new KSize(_map.width, _map.height);
                if(!oncomplete.thisobj) oncomplete.thisobj = KMap;
                if(!oncomplete.data) oncomplete.data = {};
                latlon.initialize(_map);
                _map.snapshotBox.snapshot({
                    mode:"custom"
                    ,x :latlon.mapX - size.width/2
                    ,y :latlon.mapY - size.height/2
                    ,width : size.width
                    ,height : size.height
                    ,zoom : zoom
                    ,format:format
                });
            }
            _snapshotIng = true;
        }
    };
	
	/**
	 * 
	 * @param {Object} latlons MPoint[] 
	 * @return Number  
	 * @uncrunch
	 */
	this.distance = function(latlons)
	{
		if(_map) return _map.measDistance(latlons);
		return 0;
	};
	
	/**
	 *  
	 * @param {Object} latlons MPoint[] 
	 * @return Number  
	 * @uncrunch
	 */
	this.area = function(latlons)
	{
		if(_map) return _map.measArea(latlons);
		return 0;
	};


	/**
	 * 
	 * @param x: Integer  x 
	 * @param y: Integer  y 
	 * @param callbackFunction: Function callbackFunction
	 * @return 
	 * @uncrunch
	 */
	this.moveMap = function(x, y, callbackFunction)
	{
		if(_map) {
			_map.panTo(x, y, callbackFunction);
		}
	};
	
	/**
	 * 
	 * @param 
	 * @return Number  
	 * @uncrunch
	 */
	this.getMapViewBound = function(){
		if(_map) {
			return _map.getViewBound();  
		}
		return null;
	};
	/**
	 * 
	 * @param 
	 * @return 
	 * @uncrunch
	 */
	this.isOpenedOverlay = function(){
		if(_lastOpenKOL && _lastOpenKOL._openedInfo){
			return true;
		}else {
			return false;	
		}
			
	};
    /**
     * 
     * @param overlay
     */
    this._updateOverlayGroup = function(overlay)
    {
        if (overlay && overlay._oldGroup)
        {
            if (overlay instanceof KMarker)
            {
                if (_markers[overlay._oldGroup] && _markers[overlay._oldGroup][overlay.id()]) delete _markers[overlay._oldGroup][overlay.id()];
                if (!_markers[overlay.group()]) _markers[overlay.group()] = {};
                _markers[overlay.group()][overlay.id()] = overlay;
            } else if (overlay instanceof KLine)
            {
                if (_lines[overlay._oldGroup] && _lines[overlay._oldGroup][overlay.id()]) delete _lines[overlay._oldGroup][overlay.id()];
                if (!_lines[overlay.group()]) _lines[overlay.group()] = {};
                _lines[overlay.group()][overlay.id()] = overlay;
            } else if (overlay instanceof KArea)
            {
                if (_areas[overlay._oldGroup] && _areas[overlay._oldGroup][overlay.id()]) delete _areas[overlay._oldGroup][overlay.id()];
                if (!_areas[overlay.group()]) _areas[overlay.group()] = {};
                _areas[overlay.group()][overlay.id()] = overlay;
            }
        }
    };

    /**
     * 
     * @param obj
     * @param evtname
     * @param fun
     * @uncrunch
     */
    this.bind = function(obj, evtname, fun, data, thisobj)
    {
        if (obj == KMap) obj = _map;
        evtname = evtname.toLowerCase();
        switch (evtname) {
            case 'mapinit' :
                obj = KMap;
                break;
            case 'centerchanged' :
                break;
			case 'mousedown' : 
				break;
            case 'bookmark' :
                if (!_mapletListener["bookmark"])
                    _mapletListener["bookmark"] = MEvent.addListener(obj, "bookmark", function(point) {
                        KEvent.trigger.apply(obj, [obj, 'bookmark', _maplets[_map._$_timeCode], new MPoint(KTools._getParam(point, "latlon"))]);
                    });
                break;
            case 'drawline' :
                if (!_mapletListener["drawline"])
                    _mapletListener["drawline"] = MEvent.addListener(obj, "drawline", function(latlons) {
                        KEvent.trigger.apply(obj, [obj, 'drawline', _maplets[_map._$_timeCode], _drawLineCallbakStr(latlons)]);
                    });
                break;
            case 'drawarea' :
                if (!_mapletListener["drawarea"])
                    _mapletListener["drawarea"] = MEvent.addListener(obj, "drawarea", function(latlons) {
                        KEvent.trigger.apply(obj, [obj, 'drawarea', _maplets[_map._$_timeCode], _drawLineCallbakStr(latlons)]);
                    });
                break;
            case 'lookup' :
                if (!_mapletListener["lookup"])
                    _mapletListener["lookup"] = MEvent.addListener(obj, "lookup", function(_obj) {
                        var bounds = new KMapBounds(new MPoint(KTools._getParam(_obj, "min")), new MPoint(KTools._getParam(_obj, "max")));
                        KEvent.trigger.apply(obj, [obj, 'lookup', _maplets[_map._$_timeCode], _map.getCenter(), bounds]);
                    });
                break;
            case 'layerclick' :
                if (!_mapletListener["layer_click"])
                    _mapletListener["layer_click"] = MEvent.addListener(obj, "layer_click", function(data) {
                        KEvent.trigger.apply(obj, [obj, 'layerclick', _maplets[_map._$_timeCode], data]);
                    });
                break;
        }
        if (!KMap.adapters[obj]) KMap.adapters[obj] = {};
        if (!KMap.adapters[obj][evtname]) KMap.adapters[obj][evtname] = [];
        if (!KTools._arrayContains(KMap.adapters[obj][evtname], fun)) KMap.adapters[obj][evtname].push({fun:fun, data:data, thisobj:thisobj});
    };
    /**
     * 
     * @uncrunch
     */
    this.finalize = function()
    {
        if(_map)
        {
            for (var i in _mapletListener) MEvent.removeListener(_mapletListener[i]);
            for (var i in _markers) _clearOverlays(_markers, i);
            for (var i in _lines) _clearOverlays(_lines, i);
            for (var i in _areas) _clearOverlays(_areas, i);
            this.hideCursorTip();
//            _map.finalize();
            _map = null;
            maplet = null;
        }
        KTools.removeNode(_hiddenJDom[0]);
        _hiddenJDom = null;
        _containers = null;
        _maplets = null;
        _markers = null;
        _areas = null;
        _lines = null;

        _mapletListener = null;
        _snapshot_select = null;
        _snapshot_done = null;
        _overviewRect = null;
        _disableDiv = null;
        _mapFishJDom = null;
        _options = null;
        _map = null;
    };
    /**
     * 
     * @return KObject[]
     * @uncrunch
     */
    this.dependent = function()
    {
        return [KConfig,KTools,KMapOptions,KMapCtrlState,KMapBounds,KEvent,KMarker,KLine,KArea,KMapMode,KBounds,KPoint,KSize,jQuery,KWidgetFlag,KSnapshotOptions,KStdSuggeest,KStdSuggest,KUrlHash];
    };
    /**
     * 
     * @param lonlat 
     * @param callBack 
     * @uncrunch
     */
    this.getGeo = function (lonlat,callBack){
        $.ajax({
            url : base_url + '?z=14&ct=m&t=ig&l=' + lonlat
            ,type:'GET'
            ,dataType : 'json'
            ,success : function(data) {
                if (data) {
                    callBack(data.c,data.c + data.d + data.a || '');
                }else{
                    callBack();
                }
            }
        });
    };
})();
/*
 
 songyr zhangsq
 1.0.2
 2010-01-25
 2011-01-28 14:26
 ============================================
 
 */

var KAccordion = KClass.create("KAccordion", KTabs);

//
KAccordion.conf =
{
    CLASSNAME :
    {
        //div
        A : "_arr_a"
        // h3 
        ,US : "_arr_us"
        // h3
        ,S : "_arr_s"
        //div
        ,C : "_arr_c"
        ,SC : "_arr_sc"
        //div
        ,USC : "_arr_usc"
        //
        ,H : "_arr_h"
    }
};

/**
 *   
 * @param arg  
 */
KAccordion.prototype._getClassName = function(arg)
{
    if (!this.options().userstyle && arg && KAccordion.conf.CLASSNAME[arg])
    {
        return this.options().theme + KAccordion.conf.CLASSNAME[arg];
    }
    return undefined;
};
/**
 * 
 * @param container Node
 * @param opts KStdTabsOptions
 * @uncrunch
 */
KAccordion.initialize = function(container, opts)
{
    var _this = this;
    //opts
    this.setOptions(KAccordionOptions);
    this.setOptions(opts);
    //
    this._mul = this.options().multiple && this.options().collapse;
    this.setTheme(this.options().theme);
    //Dom
    this._jDom = $(container);
    this._dom = this._jDom[0];
    this.headers = $("h3", this.dom());
    //
    this.options().animation = false;
    this._jDom.addClass(this._getClassName("A"));
    this.headers.addClass(this._getClassName("US"));
    this.headers.next().addClass(this._getClassName("C"));
    this._items = [];
    this._current = null;
    this._expanded = [];
    this.headers.each(function(){
        var jq_this = $(this);
        _this.insert({
            index : jq_this.attr("index")
            ,text : jq_this.attr("text")
            ,kvalue : jq_this.attr("value")
            ,url : jq_this.attr("url") == ""?null:jq_this.attr("url")
            ,once : jq_this.attr("once") != "false"
            ,content : jq_this.attr("content")
            ,selected: jq_this.attr("selected") != "false"
            //
            ,tabDom :jq_this
        });
    });
    if (this.options().multiple && this.headers.length < this.options().initexpand)
    {
        
        for(var i = 0, j = this._items.length;i < j ;i++){
            this.select(i, true);
        }
    }else{
        this.headers.next().hide();
    }
    this._jDom.show();
};
//KWidget 
KAccordion.prototype.finalize = function() {
    this._jDom.children().remove();
    KEvent.clear(this, "dataloaded");
    this.clear();
};
/**
 * 
 * @return String 
 * @uncrunch
 */
KAccordion.prototype.version = function()
{
    return "1.0.2";
};
/**
 * 
 * @return String
 * @uncrunch
 */
KAccordion.prototype.cnname = function()
{
    return "";
};
/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KAccordion.prototype.dependent = function()
{
    return [KTabs,jQuery,KEvent,KAccordionOptions,KTabItem,KTools];
};
/**
 * obj 
 * @param obj
 * @uncrunch
 */
KAccordion.prototype.setOptions = function(obj)
{
    this._opts = KTools.copyOptions(obj, this.options());
};
/**
 * 
 * @param scheme
 * @uncrunch
 */
KAccordion.prototype.setTheme = function(scheme)
{
    this._theme = scheme;
};
//KTabs 
/**
 * 
 * @param index Integer 
 * @uncrunch
 */
KAccordion.prototype.select = function(index, notAnimate)
{
    var _this = this;
    var item = this.getItemByIndex(index);
    //  
    if (this.current() == item && !this.options().collapse) return;
    if (item.contentDom.length == 0 && !this.isAjax(item)) return;
    if (item.url == "fun") {
        KEvent.trigger(this, "funtab", item);
        return;
    }
    //ajaxcontent
    if (this.isAjax(item))
    {
        item.contentDom = item.contentDom.html() == null ? $("<div/>").addClass(this._getClassName("C")) : item.tabDom.next("div");
        $.ajax({
            type: "GET",
            url:item.url,
            success: function(data)
            {
                if(!data){
                    _this.unselect(item);
                    return;
                }
                //itemurl
                if(data && data.r){
                    if(item.once) {
                        delete item.url;
                    }
                }else {
                    KTools.showMsg("", {node : item.tabDom});
                    return;
                }
                item.contentDom.html(data.r[0].h);
                // dom
                item.data = data;
                KEvent.trigger(item, "dataloaded", _this, data, item);
            },
            error : function(XMLHttpRequest, textStatus, errorThrown){
                KTools.showMsg(errorThrown, {node : item.tabDom});
            },
            dataType:"json"
        });
    }
    var exItems = this.expanded();
    //
    if (exItems.length === 0) {
        if(!this.isAjax(item)){
            _this.openFirst(item, notAnimate);
        }else{
            KEvent.bind(item, "dataloaded", function(evt, obj, data, dom){
                _this.openFirst(item, notAnimate, true);
            });
        }
        return;
    }
    //item   exItems
    var iInEx = this._findItem(item);
    if (iInEx != -1 && this.options().collapse) {
        this.unselect(item);
        this._expanded = $.grep(this._expanded, function(n) {
            return n.index != iInEx;
        });
        var exLen = this._expanded.length;
        this._current = exLen ? this._expanded[exLen - 1] : null;
        return;
    }
    if (this._mul) {
        if(this.options().animation){
            item.contentDom.slideDown(function(){
                _this.execAnimitFun(item);
            });
        }else{
            item.contentDom.show();
            _this.execAnimitFun(item);
        }
        this.expanded().push(item);
        this._current = item;
    } else {
        if (this.options().animation)
        {
            if(this.isAjax(item)){
                //
                KEvent.bind(item, "dataloaded", function(evt, obj, data, dom){
                    //
                    _this.dataloadedFun.apply(_this, [dom]);
                    //
                    _this.execAnimitFun.apply(_this, [dom, true]);
                });
            }else{
                this.dataloadedFun.apply(_this, [item]);
            }
        } else {
            if(this.isAjax(item)){
                //
                KEvent.bind(item, "dataloaded", function(evt, obj, data, dom){
                    //
                    _this.unselect(_this._current);
                    _this._expanded = [];
                    window.setTimeout(function(){
                    dom.contentDom.show();
                    //
                    _this.execAnimitFun.apply(_this, [dom, true]);
                    }, 0);
                });
            }else{
                this.unselect(this._current);
                this._expanded = [];
                window.setTimeout(function(){
                    item.contentDom.show();
                    _this.execAnimitFun(item);
                }, 0);
                return;
            }
        }
    }
    if(!this.isAjax(item) && !this.options().animation && !notAnimate){
        this.execAnimitFun(item);
    }
};
KAccordion.prototype.openFirst = function(item, notAnimate, isTrigger){
    var _this = this;
    if(this.options().animation && !notAnimate){
        item.contentDom.slideDown(function(){
            _this.execAnimitFun(item);
        });
    }else{
        item.contentDom.show();
    }
    this._current = item;
    this._expanded.push(item);
    item.tabDom.addClass(this._getClassName("S")).removeClass(this._getClassName("H")).removeClass(this._getClassName("US"));
    //editClass
    item.contentDom.addClass(this._getClassName("SC")).removeClass(this._getClassName("USC"));
    _this.triggerEvents(item, isTrigger);
};
KAccordion.prototype.execAnimitFun = function(item, isTrigger){
    item.tabDom.addClass(this._getClassName("S")).removeClass(this._getClassName("H")).removeClass(this._getClassName("US"));
    //editClass
    item.contentDom.addClass(this._getClassName("SC")).removeClass(this._getClassName("USC"));
    this._current = item;
    this._expanded.push(item);
    this.triggerEvents(item, isTrigger);
};
KAccordion.prototype.dataloadedFun = function(item, isTrigger){
    var _this = this;
    var s = item.contentDom;
    var overflow = s.css('overflow'),
            percentDone,
            showProps = {},
            hideProps = {},
            toFX = [ "height", "paddingTop", "paddingBottom" ],
            originalWidth;

    originalWidth = s[0].style.width;
    s.width(parseInt(s.parent().width(), 10) - parseInt(s.css("paddingLeft"), 10) - parseInt(s.css("paddingRight"), 10) - (parseInt(s.css("borderLeftWidth"), 10) || 0) - (parseInt(s.css("borderRightWidth"), 10) || 0));

    $.each(toFX, function(i, prop) {
        hideProps[prop] = 'hide';
        var parts = ('' + $.css(s[0], prop)).match(/^([\d+-.]+)(.*)$/);
        showProps[prop] = {
            value: parts[1],
            unit: parts[2] || 'px'
        };
    });
    s.css({ height: 0, overflow: 'hidden' }).show();
    this._current.contentDom.animate(hideProps, {
        step:function(now, settings) {
            _this.animating = true;
            if (settings.prop == 'height')
            {
                percentDone = (settings.now - settings.start) / (settings.end - settings.start);
            }
            s[0].style[settings.prop] = (percentDone * showProps[settings.prop].value) + showProps[settings.prop].unit;

        },
         complete: function() {
             _this.animating = false;
             if (_this.options().autoheight) {
             s.css("height", "");
             }
             s.css("width", originalWidth);
             s.css({overflow: overflow});
         }
    });
    this._current.tabDom.removeClass(this._getClassName("S")).removeClass(this._getClassName("H")).addClass(this._getClassName("US"));
    //editClass
    this._current.contentDom.addClass(this._getClassName("USC")).removeClass(this._getClassName("SC"));
    this._expanded = [];
};
KAccordion.prototype.triggerEvents = function(item , isDataLoaded){
    var _this = this;
    KEvent.trigger(_this, "selected", item, _this._current);
    if(isDataLoaded) KEvent.trigger(_this, "dataloaded", _this ,item.data, item); 
};
/**
 * item.indexitemindex
 * @param item KTabItem 
 * @uncrunch
 */
KAccordion.prototype.insert = function(item)
{
    var _this = this;
    //index_items
    var index = item.index == 0 ? 0 : item.index || this._items.length;
    //index>_items.length index_items
    //index<0  ,
    index = Math.min(this._items.length, Math.max(0, index));
    item.index = index;
    if (this.length() == index)
    {
        this._items.push(item);
    }
    //item
    else
    {
        this._items = $.map(this._items, function(obj, i) {
            if (i == index)
            {
                item.index = i;
                obj.index = i + 1;
                return [item, obj];
            }
            else
            {
                if (i > index)
                {
                    obj.index = i + 1;
                }
                return obj;
            }
        });
    }
    //
    if (!item.tabDom)
    {
        this.getTabDom(item);
        this.getContentDom(item);
        if (index < 1)
        {
            $("h3", this.dom()).eq(0).before($(item.tabDom)).before($(item.contentDom));
        }
        else
        {
            $("h3", this.dom()).eq(index - 1).next().after($(item.contentDom)).after($(item.tabDom));
        }
    }
    //DOM                      .
    else
    {
        item.contentDom = item.tabDom.next();
    }
    item.tabDom.click(function() {
        if(!_this.options().collapse && $(item.contentDom).is(':visible')) KEvent.trigger(_this, 'headclick', _this, item);
        _this.select(item);
    });
    item.tabDom.hover(function(){
        if(!$(item.contentDom).is(':visible')) KEvent.trigger(_this, 'headmouseenter', _this, item);
        if(!_this.animating && _this._current != item){
            item.tabDom.addClass(_this._getClassName("H"));
        }
    }, function(){
        if(!$(item.contentDom).is(':visible')) KEvent.trigger(_this, 'headmouseleave', _this, item);
        if(!_this.animating && _this._current != item){
            item.tabDom.removeClass(_this._getClassName("H"));
        }
    });
    //editClass
    item.contentDom.addClass((this._getClassName("C")));
};

/**
 * item
 * @param index Integer 
 * @uncrunch
 */
KAccordion.prototype.remove = function(index)
{
    if (arguments.length === 0)
    {
        //remove all
        this.clear();
        return;
    }
    var item = this.getItemByIndex(index);
    //remove item
    this._items = $.grep(this._items, function(obj, i) {
        return obj.index !== item.index;
    });
    //index
    $.each(this._items, function(i, item) {
        item.index = i;
    });
    if (this.current() == item)
    {
        this._current = null;
    }
    $(item.tabDom).remove();
    item.tabDom = undefined;
    $(item.contentDom).remove();
    item.contentDom = undefined;
    this._setAutoHeight(true);
};

/**
 * 
 * @param index Integer 
 * @uncrunch
 */
KAccordion.prototype.hideTab = function(index)
{
    var item = this.getItemByIndex(index);
    $(item.tabDom).hide();
    $(item.contentDom).hide();
};
/**
 * 
 * @param index Integer 
 * @uncrunch
 */
KAccordion.prototype.showTab = function(index)
{
    var item = this.getItemByIndex(index);
    $(item.tabDom).show();
};
/**
 * 
 * @param item KTabItem 
 */
KAccordion.prototype.unselect = function(item, callback, noAnimation)
{
    //noAnimation ? $(item.contentDom).hide() : (this.options().animation ? $(item.contentDom).slideUp(callback) : $(item.contentDom).hide());
    if(this.options().animation && !noAnimation){
        if(typeof callback == "function"){
            item.contentDom.slideUp(callback);
        }else{
            item.contentDom.slideUp();
        }
    }else{
        item.contentDom.hide();
    }
    $(item.tabDom).removeClass(this._getClassName("S")).addClass(this._getClassName("US"));
    $(item.contentDom).addClass(this._getClassName("USC")).removeClass(this._getClassName("SC"));
};
/**
 * 
 * @uncrunch
 */
KAccordion.prototype.length = function()
{
    return this._items.length;
};
/**
 * 
 * KTabItem[] 
 * @uncrunch
 */
KAccordion.prototype.tabs = function()
{
    return this._items;
};
/**
 * 
 * @uncrunch
 */
KAccordion.prototype.layout = function()
{
    var parent = this._jDom.parent();
    if(this.options().autoheight){
        parent.css({height:""});
        return;
    }
    var p_y = parent.outerHeight() - parent.height();
    var b_y = this._jDom.outerHeight() - this._jDom.height();
    var aheight = parent.height() - p_y;
    parent.height(aheight);
    var p_x = parent.outerWidth() - parent.width();
    var b_x = this._jDom.outerWidth() - this._jDom.width();
    if((parent.width()- p_x) == 0) return;
    var awidth = parent.width()- p_x;
    parent.width(awidth);
};
/**
 * index
 * @param index
 * KTabItem 
 *  @uncrunch
 */
KAccordion.prototype.tab = function(index)
{
    if (index > this._items.length - 1)
    {
        index = this._items.length - 1
    }
    else if (index < 0)
    {
        index = 0;
    }
    return this._items[index];
};
/**
 * 
 * @param item KTabItem 
 */
KAccordion.prototype._setAutoHeight = function(clear)
{

    if (!this.options().autoheight)
    {
        //item
        if (clear === true)
        {
            $("h3", this.dom()).next().each(function() {
            }).height("");
        }
        var maxHeight = 0;
        $("h3", this.dom()).next().each(function() {
            maxHeight = Math.max(maxHeight, $(this).outerHeight());
        }).height(maxHeight);
    }
};
/**
 *   JQUERY
 * @param item
 */
KAccordion.prototype.getTabDom = function(item)
{
    item.tabDom = $("<h3/>").html(item.text).append($("<b/>"));
    item.tabDom.addClass(this._getClassName("US"));
};
/**
 * URL
 * @param item
 * @param url
 */
KAccordion.prototype._getContentDomFromUrl = function(item, url)
{
    if (!this.isAjax(item))
    {
        item.contentDom = $(url);
    }
    else
    {
        item.contentDom = $("<div/>").html(item.content || "").hide();
        item.contentDom.load(item.url);
    }
    item.contentDom.addClass(this._getClassName("C"));
};
/**
 *   jquery
 * @param item
 */
KAccordion.prototype.getContentDom = function(item)
{
    var url = item.url;
    if (url)
    {
        this._getContentDomFromUrl(item, url);
    }
    else
    {
        item.contentDom = $("<div/>").html(item.content || "").hide();
        item.contentDom.addClass(this._getClassName("C"));
    }
};
/**
 * URL
 * @param item
 */
KAccordion.prototype.isAjax = function(item)
{
    if (item.url)
    {
        return new RegExp("^[^#]", "g").test(item.url);
    }
    else
    {
        return false;
    }
};
/**
 * INDEXITEM
 * @param index
 */
KAccordion.prototype.getItemByIndex = function(index)
{
    if (typeof index == "number") {
        return this.tab(index);
    }
    else return index;
};
/**
 *  KAccordionOptions.multiple 
 */
KAccordion.prototype.current = function(){
    if(this.options().multiple){
        return this.expanded();
    }else{
        return this._current;
    }
};
/**
 * 
 */
KAccordion.prototype.clear = function()
{
    for (var i = 0; i < this._items.length; i++)
    {
        var item = this._items[i];
        $(item.tabDom).remove();
        item.tabDom = undefined;
        $(item.contentDom).remove();
        item.contentDom = undefined;

        this._items[i] = undefined;
    }
    this._current = null;
    this._items.length = 0;
    this._jDom.remove();
};
/**
 * 
 * @uncrunch
 */
KAccordion.prototype.expanded = function()
{
    return this._expanded;
};
/**
 * 
 * @uncrunch
 */
KAccordion.prototype.collapse = function()
{
    var _this = this;
    $(this.expanded()).each(function() {
        _this.unselect(this);
    });
    this._current = null;
    this._expanded = [];
};
/**
 * item
 * @param item
 */
KAccordion.prototype._findItem = function(item) {
    var exItems = this.expanded();
    for (var i = exItems.length - 1; i >= 0; i--) {
        if (item.index === exItems[i].index) {
            return item.index;
        }
    }
    return -1;
};
/*
  KBubble extends KWidget
 
 * 
 * 
 * 
 o 
 o 
 wangzheng
 1.0
 2010-02-26
 2010-02-26 23:07
 ============================================
 
 */
var KBubble = KClass.create("KBubble", KWidget);

/**
 * KBubble opts 
 * @param container
 * @param opts
 */
KBubble.initialize = function(container, opts)
{
    //
    this._content = undefined;
    //
    this._cursor = undefined;
    //A
    this._close = undefined;
    this._openOpts = undefined;
    this._element = undefined;
    var _this = this;
    this._windowCloseFun = function(event) {
        if ($(_this._dom).is(":visible") == true && _this._openOpts && (_this._openOpts.outside == true))//_this._openOpts.outside == true  \\|| _this._openOpts.closebtn == false
        {
            if(!_this._element || !_this._dom || _this._element.get(0) === event.target || _this._dom === event.target || $("*", _this._element).index(event.target) != -1 || $("*", _this._dom).index(event.target) != -1) return;
            _this.hide("document");
        }
    };
    this._position = undefined;
    if (KTools._isElement(container))
    {
        this._dom = container;
        this._opts = KTools.copyOptions(opts, KBubbleOptions);
        this._theme = this._opts.theme;
        //add by zhangsq
        $(this._dom).removeClass().addClass(this._theme + '_bub');
        this._content = $(">div", this._dom).eq(0);
        var _spans = $(">span", this._dom);
        this._cursor = _spans.eq(0);
        this._close = _spans.eq(1);
        this._doms = [this._dom, this._content.get(0), this._cursor.get(0), this._close.get(0)];
        if (this._opts.userstyle == false) this._updateThemeClass(false);
        $(this._dom).hide();
        KEvent.bind(this._dom, "focus", function() {
            KEvent.trigger.apply(_this, [_this, 'focus', _this]);
        });
        if (this._close.length > 0)
        {
            KEvent.bind(this._close[0], "click", function() {
                _this.hide("closebtn");
            });
        }
        
        KEvent.bind(document, "click", this._windowCloseFun);
    }
};

/**
 * @overwrite
 * @uncrunch
 */
KBubble.prototype.version = function()
{
    return "1.0";
};

/**
 * @overwrite
 * @uncrunch
 */
KBubble.prototype.cnname = function()
{
    return "";
};

/**
 * @overwrite
 * @uncrunch
 */
KBubble.prototype.setOptions = function(obj)
{
    this._opts = KTools.copyOptions(obj, this._opts);
    this._theme = this._opts.theme;
    this._updateThemeClass(this._opts.userstyle);
};

/**
 * @overwrite
 * @uncrunch
 */
KBubble.prototype.setTheme = function(scheme)
{
    if (typeof scheme == 'string')
    {
        this._theme = scheme;
        this._updateThemeClass(this._opts.userstyle);
    }
};

/**
 * @overwrite
 * @uncrunch
 */
KBubble.prototype.layout = function()
{
    if (this._dom && this.visible() == true && this._cursor && this._cursor.length > 0 && this._element && this._element.length > 0)
    {//
        var _thisJDom = $(this._dom);
        var _windowBounds = KTools.getBounds(window);
//        _windowBounds.max.x -= 50;
        var _elementBounds = KTools.getBounds(this._element.get(0));
        var _elementSize = _elementBounds.size();
        var _elementSize_W2 = _elementSize.width/2;
        var _elementSize_H2 = _elementSize.height/2;
        var _domBounds = KTools.getBounds(_thisJDom.get(0));
        var _domSize = _domBounds.size();
        var _domSize_W2 = _domSize.width/2;
        var _domSize_H2 = _domSize.height/2;
        //4 ,maxBounds(),minBounds(),size(_dom),good(boolean)
        this._position = this._openOpts.pos;
        if(this._position != KPosition.TOP && this._position != KPosition.BOTTOM && this._position != KPosition.LEFT && this._position != KPosition.RIGHT) this._position = undefined;
        var _offsetx_ = 0;
        var _offsety_ = 0;
        var _marginx_ = 0;
        var _marginy_ = 0;
        var _cursorSize = null;
        this._updateCursorClass(KPosition.TOP);
        if(this._openOpts.arrow) _cursorSize = KTools.getBounds($(this._cursor).get(0)).size();
        else _cursorSize = new KSize(0, 0);
        var _cursorSize_W2 = _cursorSize.width/2;
        var _cursorSize_H2 = _cursorSize.height/2;
        _offsetx_ = _cursorSize_W2 + this._openOpts.corneradius;
        _marginy_ = _cursorSize.height + this._openOpts.marginy;
        this._updateCursorClass(KPosition.LEFT);
        if(this._openOpts.arrow) _cursorSize = KTools.getBounds($(this._cursor).get(0)).size();
        else _cursorSize = new KSize(0, 0);
        _offsety_ = _cursorSize_W2 + this._openOpts.corneradius;
        _marginx_ = _cursorSize.height + this._openOpts.marginy;
        var _4pos = {};
        if(this._openOpts.autolayout == true) _4pos = KTools.checkSpace(_elementBounds, _domSize, _windowBounds, {offsetx:_offsetx_, offsety:_offsety_, marginx:_marginx_, marginy:_marginy_, pos:this._position});
        var _poss = [KPosition.BOTTOM, KPosition.RIGHT, KPosition.TOP, KPosition.LEFT];
        var _poss_ = {};
        _poss_[KPosition.BOTTOM] = "bottom";
        _poss_[KPosition.RIGHT] = "right";
        _poss_[KPosition.LEFT] = "left";
        _poss_[KPosition.TOP] = "top";
        _poss_["top"] = KPosition.TOP;
        _poss_["right"] = KPosition.RIGHT;
        _poss_["left"] = KPosition.LEFT;
        _poss_["bottom"] = KPosition.BOTTOM;
        if(this._position == undefined)
        {
            var maxPos = undefined;
            for(var i = 0; i < _poss.length; i++)
            {
                var _posI = _4pos[_poss_[_poss[i]]];
                if(_posI)
                {
                    if(_posI.usable)
                    {
                        this._position = _poss[i];
                        break;
                    } else {
                        if(maxPos) {
                            if ( _posI.size.width * _posI.size.height > _4pos[maxPos].size.width * _4pos[maxPos].size.height) maxPos = _poss_[_poss[i]];
                        } else maxPos = _poss_[_poss[i]];
                    }
                }
            }
            if(this._position == undefined)
            {
                if(maxPos) this._position = _poss_[maxPos];
                else this._position = KPosition.BOTTOM;
            }
        }

        var _anchorx = this._openOpts.anchorx;
        //  
        var _anchory = this._openOpts.anchory;
        //  
        var _offsetx = this._openOpts.offsetx;
        ////  
        var _offsety = this._openOpts.offsety;
        var _minBounds = undefined;
        var _maxBounds = undefined;
        if(_4pos[_poss_[this._position]])
        {
            _minBounds = _4pos[_poss_[this._position]].min;
            _maxBounds = _4pos[_poss_[this._position]].max;
        }
        this._updateCursorClass(this._position);
        if(this._openOpts.arrow) _cursorSize = KTools.getBounds($(this._cursor).get(0)).size();
            else _cursorSize = new KSize(0, 0);
        _cursorSize_W2 = _cursorSize.width/2;
        _cursorSize_H2 = _cursorSize.height/2;
        if(this._position == KPosition.TOP || this._position == KPosition.BOTTOM)
        {
            if(_anchorx > _elementSize_W2)
                _anchorx = _elementSize_W2;
            if(_anchorx < -_elementSize_W2)
                _anchorx = -_elementSize_W2;
            if(_offsetx > _domSize_W2 - this._openOpts.corneradius - _cursorSize_W2)
                _offsetx = _domSize_W2 - this._openOpts.corneradius - _cursorSize_W2;
            if(_offsetx < -(_domSize_W2 - this._openOpts.corneradius - _cursorSize_W2))
                _offsetx = -(_domSize_W2 - this._openOpts.corneradius - _cursorSize_W2);
            var floatLeft = (_elementSize_W2 + _anchorx -  _domSize_W2 -  _offsetx);
            if(this._openOpts.autolayout == true && _minBounds.min.x != _minBounds.max.x)
            {
                var _left = _elementBounds.min.x + floatLeft;
                if(_minBounds.max.x - _left < _domSize.width)
                    _left = _minBounds.max.x - _domSize.width;
                if(_left < _minBounds.min.x) _left = _minBounds.min.x;
                if(_left + _domSize.width > _maxBounds.max.x)
                    _left = _maxBounds.max.x - _domSize.width;
                if(_left < _maxBounds.min.x)
                    _left = _maxBounds.min.x;
                floatLeft = _left - _elementBounds.min.x;
                if(_elementSize_W2 + _anchorx - floatLeft - this._openOpts.corneradius - _cursorSize_W2 < 0)
                    _anchorx =  floatLeft + this._openOpts.corneradius + _cursorSize_W2 - _elementSize_W2;
                if(_domSize.width + floatLeft - this._openOpts.corneradius - _cursorSize_W2 - _elementSize_W2 - _anchorx < 0)
                    _anchorx = _domSize.width + floatLeft - this._openOpts.corneradius - _cursorSize_W2 - _elementSize_W2;
            }
            var _leftCSS = (_thisJDom.position().left - _domBounds.min.x + _elementBounds.min.x + floatLeft) + "px";
            if(this._position == KPosition.TOP)
                _thisJDom.css({"top": (_thisJDom.position().top - _domBounds.min.y + (_elementBounds.min.y - _domSize.height - _cursorSize.height - this._openOpts.marginy)) + "px", "left":_leftCSS});
            else  _thisJDom.css({"top": (_thisJDom.position().top - _domBounds.min.y + (_elementBounds.min.y + _elementSize.height + _cursorSize.height + this._openOpts.marginy)) + "px", "left":_leftCSS});
            this._cursor.css({"top": "", "left": (_elementSize_W2 - floatLeft - _cursorSize_W2 + _anchorx) + "px"});
        } else {
            if(_anchory > _elementSize_H2)
                _anchory = _elementSize_H2;
            if(_anchory < -_elementSize_H2)
                _anchory = -_elementSize_H2;
            if(_offsety > _domSize_H2 - this._openOpts.corneradius - _cursorSize_H2)
                _offsety = _domSize_H2 - this._openOpts.corneradius - _cursorSize_H2;
            if(_offsety < -(_domSize_H2 - this._openOpts.corneradius - _cursorSize_H2))
                _offsety = -(_domSize_H2 - this._openOpts.corneradius - _cursorSize_H2);
            var floatTop = (_elementSize_H2 + _anchory -  _domSize_H2 -  _offsety);
            if(this._openOpts.autolayout == true && _minBounds.min.y != _minBounds.max.y)
            {
                var _top = _elementBounds.min.y +  floatTop;
                if(_minBounds.max.y - _top < _domSize.height)
                    _top = _minBounds.max.y - _domSize.height;
                if(_top < _minBounds.min.y)
                    _top = _minBounds.min.y;
                if(_top + _domSize.height > _maxBounds.max.y)
                    _top = _maxBounds.max.y - _domSize.height;
                if(_top < _maxBounds.min.y)
                    _top = _maxBounds.min.y;
                floatTop = _top - _elementBounds.min.y;
                if(_elementSize_H2 + _anchory - floatTop - this._openOpts.corneradius - _cursorSize_H2 < 0)
                    _anchory =  floatTop + this._openOpts.corneradius + _cursorSize_H2 - _elementSize_H2;
                if(_domSize.height + floatTop - this._openOpts.corneradius - _cursorSize_H2 - _elementSize_H2 - _anchory < 0)
                    _anchory = _domSize.height + floatTop - this._openOpts.corneradius - _cursorSize_H2 - _elementSize_H2;
            }
            var _topCSS = (_thisJDom.position().top - _domBounds.min.y + (_elementBounds.min.y + floatTop)) + "px";
            if(this._position == KPosition.LEFT)
                _thisJDom.css({"left": (_thisJDom.position().left - _domBounds.min.x + (_elementBounds.min.x - _domSize.width - _cursorSize.width - this._openOpts.marginx)) + "px", "top" : _topCSS});
            else _thisJDom.css({"left": (_thisJDom.position().left - _domBounds.min.x + (_elementBounds.min.x + _elementSize.width + _cursorSize.width + this._openOpts.marginx)) + "px", "top" : _topCSS});
            this._cursor.css({"left": "", "top": (_elementSize_H2 - floatTop - _cursorSize_H2 + _anchory) + "px"});
        }
    }
};

/**
 * @overwrite
 * @uncrunch
 */
KBubble.prototype.clearResult = function()
{
    if (this._content && this._content.length > 0)
    {
        this._content.html("");
    }
};

/**
 *  opts  element 
 * @param element Node 
 * @param opts KBubbleShowOptions 
 * @uncrunch
 */
KBubble.prototype.show = function(element, opts)
{
    var _this = this;
    if (KTools._isElement(element) && this._dom)
    {
        this._element = $(element);

        var oldV = this.visible();
        if(!oldV)
        {
            $(this._dom).show();
        }
        var _thisJDom = $(this._dom);
        if (_thisJDom.parent().length < 1) $(document.body).append(this._dom);
        var _eBounds = KTools.getBounds(this._element[0]);
        this._openOpts = KTools.copyOptions(opts, KBubbleShowOptions);
        if(!this._openOpts.arrow) this._cursor.hide();
        if($.browser.msie) this._openOpts.corneradius = 0;
        //
        if (opts.size instanceof KSize) this.resize(this._openOpts.size, true);
        else {
			//_thisJDom.css({"height":"auto","width":"auto"});
            this.resize(new KSize(_thisJDom.width(), _thisJDom.height()), true, true);
        }
        //
        if (this._openOpts.closebtn == true)
        {
            //  
            if (this._close && this._close.length > 0)
            {
                this._close.show();
            }
            else  this._openOpts.closebtn = false;
        } else {
            this._close.hide();
        }
        _thisJDom.bgiframe();
        //
        this.layout();
        if(!oldV) KEvent.trigger.apply(this, [this, 'aftershow', this]);
    }
};

/**
 * @overwirte
 * @uncrunch
 */
KBubble.prototype.hide = function()
{
    var _this = this;
    if(!$(_this._dom).is(":visible")) return;
    var action = arguments[0];
    KEvent.trigger(_this, 'beforehide', _this, action);
    $(_this._dom).hide();
//        $(_this._dom).css("opacity", "");
        if(typeof action != "string") action = "method";
        KEvent.trigger(_this, 'afterhide', _this, action);
//    $(_this._dom).animate({opacity:"0"},"fast", function() {
//
//    });
};

/**
 *  element  dom    html 
 * @param obj Node  String 
 * @uncrunch
 */
KBubble.prototype.setContent = function(obj)
{
    if (!this._content || this._content.length < 1) return;
    if (KTools._isElement(obj))
    {
        this._content.empty();
        this._content.append(obj);
    } else if (typeof obj == 'string')  this._content.html(obj);
};

/**
 * 
 * @param zindex Integer 
 * @uncrunch
 */
KBubble.prototype.setZIndex = function(zindex)
{
    if (!this._dom) return;
    if (typeof zindex == 'number') $(this._dom).css("z-index", zindex);
};

/**
 * 
 * @param size KSize 
 * @uncrunch
 */
KBubble.prototype.resize = function(size, _selfU)
{
    if (!this._dom) return;
    if (size instanceof KSize)
    {
        switch (this._position)
        {
            case KPosition.TOP :
                $(this._dom).css("top", ($(this._dom).position().top - size.height + $(this._dom).height() ) + "px");
                break;
            case KPosition.LEFT :
                $(this._dom).css("left", ($(this._dom).position().left - size.width + $(this._dom).width() ) + "px");
                break;
        }
        if (!arguments[2]) {
			if(this._openOpts) this._openOpts.size = size;
			$(this._dom).css({
				"width": size.width + "px",
				"height": size.height + "px"
			});
		}
        if(!_selfU) {
			this.layout();
			KEvent.trigger.apply(this, [this, 'afteresize', this, size]);
		}
    }
};

KBubble.prototype._updateThemeClass = function(useDefault)
{
    if (this._dom)
    {
        if (useDefault == false)
        {
            this._setClass(this._dom, this._theme + "_bub");
            this._setClass(this._content.get(0), this._theme + "_bub_c");
            if (this._cursor.get(0)) {
                if (this._cursor.get(0).className != "")
                    this._setClass(this._cursor.get(0), this._cursor.get(0).className.replace(/[^\ ]*?_bub_a [^\ ]*?_bub_a([tblr])/g, this._theme + "_bub_a " + this._theme + "_bub_a$1"));
                else
                    this._setClass(this._cursor.get(0), this._theme + "_bub_a " + this._theme + "_bub_ar");
            }
            $(this._close).addClass(this._theme + "_bub_clb ");
        }
    }
};

KBubble.prototype._setClass = function(dom, className)
{
    if (dom) dom.className = className;
};

KBubble.prototype._updateCursorClass = function(pos)
{
    if (pos)
    {
        switch (pos)
        {
            case KPosition.BOTTOM:
                pos = 't';
                break;
            case KPosition.TOP:
                pos = 'b';
                break;
            case KPosition.LEFT:
                pos = 'r';
                break;
            case KPosition.RIGHT:
                pos = 'l';
                break;
            default : return;
        }
        this._cursor.get(0).className = this._cursor.get(0).className.replace(/_bub_a[rtlb]/g, "_bub_a" + pos);
    }
};

/**
 * @overwrite
 * @uncrunch
 */
KBubble.prototype.finalize = function()
{
    KEvent.unbind(document, "mousedown", this._windowCloseFun);
    KEvent.clear(this._dom);
    KEvent.clear(this._content.get(0));
    KEvent.clear(this._cursor.get(0));
    KEvent.clear(this._close.get(0));
    KWidget.prototype.finalize.apply(this);
};

/**
 * @overwrite
 * @uncrunch
 */
KBubble.prototype.dependent = function()
{
    return [KWidget, KTools, KBubbleOptions,jQuery, KSize,KEvent, KPosition, KBubbleShowOptions];
};
/*
 
 songyr fuyg
 2.1.2
 2010-03-18
 2011-08-02 23:01
 ============================================
 */
var KBusearch = KClass.create("KBusearch", KQuery);
KBusearch.conf = {
    CLASSNAME: {
        BS: "_bs " // div
        ,
        EPT: "_bs_ept"// 
        ,
        TSR: "_bs_tsr " // div
        ,
        LSR: "_bs_lsr " // (div)
        ,
        LSRD: "_bs_lsrd" // ->div
        ,
        SSR: "_bs_ssr " // (div)
        ,
        STIP: "_bs_stip"//
        ,
        T: "_bs_tss_t " // /(div)
        ,
        LH: "_bs_tsr_lh" // (li)
        ,
        CTRL: "_bs_tsr_ctrl" // (div)
        ,
        RL: "_bs_lsr_rl"// 
        ,
        LT: "_bs_lsr_lt " // (div)
        ,
        SL: "_bs_lsr_sl" // (div)
        ,
        SLL: "_bs_lsr_sll" // (ul)
        ,
        SLR: "_bs_lsr_slr" // (ul)
        ,
        LID: "_bs_lsr_lid" // (div)
        ,
        SD: "_bs_ssr_sd" // 
        ,
        SS: "_bs_ssr_ss" // (dt)
        ,
        BUS: "_bs_ssr_bus"// 
        ,
        SW: "_bs_ssr_sw"// 
        ,
        SND: "_bs_snd" // 
        // :"_bs_s# //(# = 1~10)
        ,
        LD: "_bs_ld" // 
        ,
        DL: "_bs_dl" // 
        ,
        LI: "_bs_li"//
        ,
        SI: "_bs_si"//
        ,
        SSRD: "_bs_ssrd"//
        ,
        CO2: "_bs_g_co2",

        TH: "_bs_tsr_th"//
    }
};
/**
 * 
 *
 * @param container
 *            {Node}
 * @param opts
 *            KBusearch
 * @uncrunch
 */
KBusearch.initialize = function(container, opts){
    var _this = this;

    // opts
    // this.setOptions(KBusearchOptions);
    this._opts = KTools.copyOptions({}, KBusearchOptions);
    this.setOptions(opts);
    this.setTheme(this.options().theme);
    this.cssClassName = this._initCssName(this.options().theme);
    this._POI_TITLE_CLASSNAME = "mwpg_tl";
    // "ac,st,mc,qbus," + "on,oid,ol"[] +"dn,did,dl"[]
    var _tempKeys = ["ac,st,mc,qbus,on,dn", "ac,st,mc,qbus,on,did,dl", "ac,st,mc,qbus,on,did", "ac,st,mc,qbus,on,dn,dl", "ac,st,mc,qbus,on,dl", "ac,st,mc,qbus,on,dn,did", "ac,st,mc,qbus,on,on,oid,ol", "ac,st,mc,qbus,oid,ol,dn", "ac,st,mc,qbus,oid,ol,did,dl", "ac,st,mc,qbus,oid,ol,did", "ac,st,mc,qbus,oid,ol,dn,dl", "ac,st,mc,qbus,oid,ol,dl", "ac,st,mc,qbus,oid,ol,dn,did", "ac,st,mc,qbus,oid,ol,on,oid,ol", "ac,st,mc,qbus,oid,dn", "ac,st,mc,qbus,oid,did,dl", "ac,st,mc,qbus,oid,did", "ac,st,mc,qbus,oid,dn,dl", "ac,st,mc,qbus,oid,dl", "ac,st,mc,qbus,oid,dn,did", "ac,st,mc,qbus,oid,on,oid,ol", "ac,st,mc,qbus,on,ol,dn", "ac,st,mc,qbus,on,ol,did,dl", "ac,st,mc,qbus,on,ol,did", "ac,st,mc,qbus,on,ol,dn,dl", "ac,st,mc,qbus,on,ol,dl", "ac,st,mc,qbus,on,ol,dn,did", "ac,st,mc,qbus,on,ol,on,oid,ol", "ac,st,mc,qbus,ol,dn", "ac,st,mc,qbus,ol,did,dl", "ac,st,mc,qbus,ol,did", "ac,st,mc,qbus,ol,dn,dl", "ac,st,mc,qbus,ol,dl", "ac,st,mc,qbus,ol,dn,did", "ac,st,mc,qbus,ol,on,oid,ol", "ac,st,mc,qbus,on,oid,dn", "ac,st,mc,qbus,on,oid,did,dl", "ac,st,mc,qbus,on,oid,did", "ac,st,mc,qbus,on,oid,dn,dl", "ac,st,mc,qbus,on,oid,dl", "ac,st,mc,qbus,on,oid,dn,did", "ac,st,mc,qbus,on,oid,on,oid,ol", "ac,st,mc,qbus,on,oid,ol,dn", "ac,st,mc,qbus,on,oid,ol,did,dl", "ac,st,mc,qbus,on,oid,ol,did", "ac,st,mc,qbus,on,oid,ol,dn,dl", "ac,st,mc,qbus,on,oid,ol,dl", "ac,st,mc,qbus,on,oid,ol,dn,did", "ac,st,mc,qbus,on,oid,ol,on,oid,ol"];
    this._hashkeys = ["ac,city,keyword", "ac,city,origName,destName", "ac,oc,on,dc,dn", "ac,on,dn,st,mc,qbus,oid,did", "ac,on,dn,st,mc,qbus,oid,did,dl", "ac,on,dn,st,mc,qbus,oid,did,ol", "ac,on,dn,st,mc,qbus,oid,did,ol,dl", "ac,ol,on,ot,dl,dn,dt,tt,c", "ac,city,keyword,n", "ac,city,origName,destName,n", "ac,oc,on,dc,dn,n", "ac,on,dn,st,mc,qbus,oid,did,n", "ac,ol,on,ot,dl,dn,dt,tt,c,n"];
    this._hashkeys = this._hashkeys.concat(_tempKeys);
    // add by fuyg: mwpf _hashkeys
    _this._mwpf = KConfig.get("mwpf");
    //
    this._mapIsInited = false;
    KEvent.bind(KMap, "mapinit", function(){
        _this._mapIsInited = true;
    });
    // 
    this._$dom = $(container).addClass(this.cssClassName.BS);
    _this._dom = _this._$dom.get(0);
    var divs = this._$dom.children("div");
    // 
    this._transferDom = divs.eq(0).hide();
    // 
    this._busSearchDom = divs.eq(1).addClass(this.cssClassName.TSR);
    this._busSearchMsgBox = divs.eq(2).addClass(this.cssClassName.EPT);
    // 
    this._busLineDom = divs.eq(3).addClass(this.cssClassName.LSR);
    this._busLineMsgBox = divs.eq(4).addClass(this.cssClassName.EPT);
    // 
    this._busStationDom = divs.eq(5).addClass(this.cssClassName.SSR);
    this._busStationMsgBox = divs.eq(6).addClass(this.cssClassName.EPT);
    //
    this._busCo2ShowDom = divs.eq(7).addClass(this.cssClassName.CO2).hide();
    this._busCo2ShowDistance = $(">p>span", this._busCo2ShowDom).eq(0);
    this._busCo2ShowUI = $(">ul", this._busCo2ShowDom).eq(0);
    //
    this._$taxiFareDom = divs.eq(8).addClass("").hide();
    this._taxiContent = undefined;
    //
    this._msgId = undefined;
    // undefined 
    this._queryopts = undefined;
    // undefined 
    this._result = undefined;
    // 
    _this._lastBusearchOpts = null;
    // ,
    _this._bindMapEvents();
    // N,0, 
    _this._showOnlyN = _this._lastOnlyN = -1;
    // KAccordionItemindex, data
    _this._currentItem = null;
    // KTabItem
    _this._curTabItem = null;
    //send()
    this._description = null;
    //KStationList
    this._allowReList = false;
    this.busSearchAc = [];
	//added by zy1,
	this._sendSMSArray = new Array(3);
	//added by zy, ""
	this._nm = null;
	//added by zy, 
	this._tabsCurrent = null;
	//added by zwq urlHash
	this._busUrlHash = null;
	//added by zwq tab
	this._busTabTitle = null;
	//added by zwq tab""checkedfalse
	this._busTab1Checked = false;
	this._busTab2Checked = false;
	this._busTab3Checked = false;
	//added by zwq ,true
	this._innerFlag = true;
	//added by zwq 
	this._bLineLength = null;
	//this._ajaxFlag = false;
	//,
	this.markerBak = null;
	this.optsBak = null;
	//added by zwq markermarker
	this.dragmarkerFlag = true;
    this.sMarker = undefined;
    this.eMarker = undefined;
    
    this.menuMarkerType = undefined;
    
};



/***********************************************************************************************************************
 * KObject 
 **********************************************************************************************************************/
/**
 * 
 *
 * @uncrunch
 */
KBusearch.prototype.finalize = function(){
    if (this._objKStationList) {
        this._objKStationList.finalize();
    }
};
/***********************************************************************************************************************
 * KWidget 
 **********************************************************************************************************************/
/**
 * 
 *
 * @return String 
 * @uncrunch
 */
KBusearch.prototype.version = function(){
    return "2.1.2";
};
/**
 * 
 *
 * @return String
 * @uncrunch
 */
KBusearch.prototype.cnname = function(){
    return "";
};
/**
 * 
 *
 * @return KObject[]
 * @uncrunch
 */
KBusearch.prototype.dependent = function(){
    return [KAccordion, KBusearchOptions, KClass, KConfig, KEvent, KFeedbackInfo, KFeedbackType, KLine, KListener, KMap, KMarker, KNamedValue, KObject, KPOIType, KPOInfo, KQuery, KQueryOptions, KQueryType, KRouteInfo, KRouteType, KSendOptions, KSendType, KStationList, KStationListOptions, KStdTabs, KTabItem, KTabs, KTools, KUrlHash, KWidget, KWidgetFlag, jQuery];
};
/**
 * obj 
 *
 * @param obj
 * @uncrunch
 */
KBusearch.prototype.setOptions = function(obj){
    // this._opts = KTools.copyOptions(obj, this.options());
    var opts = $.extend(true, {}, this.options(), obj);
    // /
    if (opts.slopts) {
        opts.slopts.citylist = false;
        opts.slopts.searchbox = false;
        opts.slopts.samecity = true;
        opts.slopts.autoselect = true;
        opts.slopts.changehash = false;
        // KBusearchKBusearch()KStationList,()
        opts.slopts.initmap = false;
    }
    this._opts = opts;
};
/**
 * 
 *
 * @param scheme
 * @uncrunch
 */
KBusearch.prototype.setTheme = function(scheme){
    this._theme = scheme;
};
/**
 * FLAG
 *
 * @return {String}
 * @uncrunch
 */
KBusearch.prototype.flag = function(){
    return KWidgetFlag.busearch;
};
/**
 * 
 *
 * @uncrunch
 */
KBusearch.prototype.layout = function(){
	if (this._msgId) {
		KTools.hideMsg(this._msgId);
		this._msgId=undefined;
	}
    this._layoutDom();
};
/**
 * 
 *
 * @uncrunch
 */
KBusearch.prototype.clearResult = function(){
    this._clearAllOverlay("all");
    this._hideDom();
};
/*
 * _station1 -- 1 _station2 -- 2
 *
 * _line --  _line_s --  _line_e -- 
 *
 * _search_s --  _search_s_all --  _search_l --  _search_l_w -- *  
 * KWidgetFlag.busearch "bs"
 */
/***********************************************************************************************************************
 * KQuery
 **********************************************************************************************************************/
/**
 * opts
 *
 * @param opts
 *            KQueryOptions 
 * @uncrunch
 */
KBusearch.prototype.query = function(opts,optFlag){
	var _this = this;
    var curShowOnlyN = _this._showOnlyN;
    _this._showOnlyN = -1;
    this._queryopts = opts;
    this._description = this._sendkey = this._queryHash = this._currentItem = null;
    _this._clearAllOverlay("all");
    KMap.clearMarker("ls_center");
    //bug
    if (!opts || !opts.tt) {
        this._clearBusSearchAc();
    }
    KEvent.trigger(this, "searchbefore", this, opts);
    if (this.options().searchbox) {
        this.options().searchbox.query(KTools.copyOptions({}, opts), true);
    }
    if (typeof this._qUrlHash == "undefined") {
        // _url_:url,; _ac:urlac
        var _url_, optsChild, _ac, _key;
        var kpInfo = {
            busorig: {},
            busdest: {}
        };
        // KQueryOptionstttt query()
        if (opts.tt) {// ttKStdTabstabItemsubway, nonstop, shortWalk

            for (_key in KPOInfo) {
                kpInfo["busorig"][_key] = _key;
                kpInfo["busdest"][_key] = _key;
            }
        } else {
            for (_key in KPOInfo) {
                kpInfo[_key] = _key;
            }
        }
        //()
        if (opts.type === KQueryType.busearch) {
            if (opts.busorig && opts.busorig.latlon && opts.busdest && opts.busdest.latlon) {
                if (!opts.city) {
                    if (opts.busorig.city && opts.busdest.city) {
                        if (opts.busorig.city === opts.busdest.city) {
                            opts.city = opts.busorig.city;
                        }
                    }
                }
                if (opts.city && !opts.tt) {
                    opts.tt = "subway";
                }
            }
            //
            //tt,
            if (!opts.__byinner) {
                this._lastBusearchOpts = {
                    busorig: {
                        city: opts.busorig.city || opts.city,
                        name: opts.busorig.name
                    },
                    busdest: {
                        city: opts.busdest.city || opts.city,
                        name: opts.busdest.name
                    },
                    type: KQueryType.busearch
                };
            } else {
                delete opts.bylist;
            }
        }
        // {KQueryOptions}.type KQueryType, KQueryType localsearch, busearch, busline, bustation, navsearch
        switch (opts.type) {
            /***********************************************************************************************************
             * 
             **********************************************************************************************************/
            case KQueryType.busearch:
                if (!opts.tt) {// tt
                	//false,
                	_this._innerFlag = false;
                    optsChild = "busearch";
                    _ac = "bus";
                    // KStdTabsKTabItem__hasQueriedfalse
                    if (this._objKStdTabs && this._objKStdTabs.tabs) {
                        var tabItems = this._objKStdTabs.tabs();
                        $.each(tabItems, function(index, item){
                            if (item) {
                                item.__hasQueried = false;
                            }
                        });
                    }
                    _this._busTab1Checked = false;
                    _this._busTab2Checked = false;
                    _this._busTab3Checked = false;
                   
                    //$("#sopt").removeAttr("checked");
                    //
                    this._clearAllOverlay("all");
                    // KStationList, 
                    this._queryByStationList(opts);
                    return;
                } else {// 
                    // 
                    this.showObj = {
                        dom: this._busSearchDom,
                        type: KQueryType.busearch + "_2"
                    };
                    //
                    if(optFlag==false){
                     	this._busTab1Checked=false;
                     	this._busTab2Checked=false;
                     	this._busTab3Checked=false;
                    }
                    if (!this._objKStdTabs) {// KStdTabs
                        this._objKStdTabs = new KStdTabs(this._busSearchDom.children("div")[0]);
                        /** ,2.0 */
                        this._objKStdTabs.hideTab(4);
                        /** ,2.0 */
                        _this._curTabItem = _this._objKStdTabs.current();
//                        this._clearBusSearchAc();
                    }
                    KEvent.clear(this._objKStdTabs, "selected");
                    KEvent.bind(this._objKStdTabs, "selected", function(evt, obj, old_item, item){
                        /** ,2.0 */
                        if (item.index === 4) {
                            return;
                        }
                        /** ,2.0 */
                        var old_tt = opts.tt;
                        var tts = ["subway", "nonstop", "shortWalk","unsubway"];
                        opts.tt = tts[item.index];
                        _this._busTabTitle = opts.tt;
                        if (old_tt != opts.tt) {
                            if (!item.__hasQueried) {// 
                                item.__hasQueried = true;
                                opts.__byinner = true;
                                _this.query(opts);
                            } else {
                                if (item.__hashString) {
                                    KListener.setHash(KUrlHash.parseByHash(item._hashString), true);
                                };
                                var objKAccordion = _this.busSearchAc[item.index];
                                if (objKAccordion) {
                                    var selectedTab = objKAccordion.current();
                                    if (selectedTab) {
                                        _this._currentItem = selectedTab;
                                        _this._bindLi.apply(_this, [selectedTab, false]);
                                        _this._bindCheckBox.apply(_this, [selectedTab, false]);
                                    }
                                }
                            }
                        }
                        _this._curTabItem = item;
                    });
                    //
                    _url_ = this.options().busurl;
                    _ac = "bt";
                    // ""
                    opts.tt = opts.tt || "subway";
                }
                break;
            /***********************************************************************************************************
             * 
             **********************************************************************************************************/
            case KQueryType.busline:
                _this._allowReList = false;
                _this._curTabItem = null;// 

                this.showObj = {
                    dom: this._busLineDom,
                    type: opts.type//KQueryType.busline
                };
                optsChild = "busline";
                _url_ = this.options().lineurl;
                _ac = "line";
                kpInfo.name = "keyword";
                break;
            /***********************************************************************************************************
             * 
             **********************************************************************************************************/
            case KQueryType.bustation:
                _this._allowReList = false;
                _this._curTabItem = null;
                this.showObj = {
                    dom: this._busStationDom,
                    type: opts.type
                };
                optsChild = "bustation";
                _url_ = this.options().stationurl;
                _ac = "station";
                // KPOInfonamehash keyword
                kpInfo.name = "keyword";
                break;
        }
        // this._qUrlHashurlhash
        this._qUrlHash = new KUrlHash();
        if (_ac == "bt") {//  return;
            var orig = opts["busorig"];
            var dest = opts["busdest"];
            this._qUrlHash.setKey("ol", orig.latlon);
            this._qUrlHash.setKey("on", orig.name);
            this._qUrlHash.setKey("ot", orig.type);
            orig.pid && this._qUrlHash.setKey("oid", orig.pid);
            this._qUrlHash.setKey("dl", dest.latlon);
            this._qUrlHash.setKey("dn", dest.name);
            this._qUrlHash.setKey("dt", dest.type);
            dest.pid && this._qUrlHash.setKey("did", dest.pid);
            this._qUrlHash.setKey("tt", opts.tt);
            this._qUrlHash.setKey("c", opts.city);
            this._qUrlHash.setKey("ac", _ac);
            // 
            curShowOnlyN > -1 && (_this._qUrlHash.setKey("n", curShowOnlyN));
            // add by fuyg
            _this._qUrlHash.setKey(_this._mwpf, _this.flag());
            // url
            KListener.setHash(this._qUrlHash, true);
            //
            var _newhash = this._qUrlHash.clone();
            // widthheight
            var wh = this._getMapWH();
            _newhash.setKey("w", wh.w + "");
            _newhash.setKey("h", wh.h + "");
            // _queryHashhash
            this._queryHash = _newhash;
            // _queryUrlurl
            this._queryUrl = _url_ + "&" + _newhash.toString();
            var current = this._objKStdTabs.current();
            current.__hashString = this._qUrlHash.toString();
            this._qUrlHash = undefined;
            var t_idx = current.index;
            var curr_ac = this.busSearchAc[t_idx];
            var t_tts = ["subway", "nonstop", "shortWalk","unsubway"];
            var t_tt = t_tts[t_idx] || t_tts[0];
            if (!curr_ac) {// KAccordion,
                this._requestData(this._queryUrl, opts.type, opts.tt);
            } else {// KAccordion,
                var _oqueryopts = this._oqueryopts;
                if ((_oqueryopts.busdest.latlon != this._queryopts.busdest.latlon ||
                _oqueryopts.busorig.latlon != this._queryopts.busorig.latlon ||
                curShowOnlyN !== _this._lastOnlyN) &&
                t_tt == this._queryopts.tt) {// KAccordion
                    for (var idx = 0; idx < this.busSearchAc.length; idx++) {
                        if (this.busSearchAc[idx] && curr_ac != this.busSearchAc[idx]) {
                            this.busSearchAc[idx].finalize();
                            this.busSearchAc[idx] = null;
                        }
                    }
                    // _oqueryopts
                    this._oqueryopts = KTools.copyOptions({}, opts);
                    this._requestData(this._queryUrl, opts.type, opts.tt);
                } else {// 
                    KEvent.trigger(curr_ac, "selected", curr_ac.current());
                }
            }
            return;
        } // else {
        // 
        for (var j in KPOInfo) {
            if (kpInfo[j] === "city" || kpInfo[j] === "keyword") {
                this._qUrlHash.setKey(kpInfo[j], opts[optsChild][j]);
            }
        }
        // }
        //line?
        this._qUrlHash.setKey("ac", _ac);
        // 
        curShowOnlyN > -1 && (_this._qUrlHash.setKey("n", curShowOnlyN));
        // add by fuyg
        _this._qUrlHash.setKey(_this._mwpf, _this.flag());
        //
        KListener.setHash(this._qUrlHash, true);
    }
    this._queryUrl = this._parseURL(opts, curShowOnlyN);
    this._qUrlHash = undefined;
    this._requestData(this._queryUrl, opts.type);
};
/**
 * Hash
 *
 * @param hash
 *            KUrlHash 
 * @uncrunch
 */
KBusearch.prototype.queryByHash = function(hash){
    // hash to opts
    var _this = this;
    var opts = KTools.copyOptions({}, KQueryOptions);
    var matches = {
        bus: "busearch",
        station: "bustation",
        line: "busline",
        bt: "bt"
    };
    var optsChild = matches[hash.value("ac").toString()];
    opts.type = optsChild === "bt" ? KQueryType.busearch : KQueryType[optsChild];
    opts[optsChild] = KTools.copyOptions({}, KPOInfo);
    for (var j in KPOInfo) {
        opts[optsChild][j] = hash.value(j === "name" ? "keyword" : j);
    }
    if (opts.type === KQueryType.busearch) {
        if (optsChild === "bt") {
            opts.busorig = {
                latlon: hash.value("ol"),
                name: hash.value("on"),
                pid: hash.value("oid"),
                type: hash.value("ot")
            };
            opts.busdest = {
                latlon: hash.value("dl"),
                name: hash.value("dn"),
                pid: hash.value("did"),
                type: hash.value("dt")
            };
            opts.tt = hash.value("tt");
            opts.city = hash.value("c");
        } else {
            opts.busorig = {
                city: hash.value("oc"),
                name: hash.value("on"),
                pid: hash.value("oid"),
                latlon: hash.value("ol")
            };
            if (hash.value("os") && !hash.value("ol") && !hash.value("oid")) {
                opts.busorig.latlon = hash.value("on");
                opts.busorig.name = hash.value("os");
            }
            opts.busdest = {
                city: hash.value("dc"),
                name: hash.value("dn"),
                pid: hash.value("did"),
                latlon: hash.value("dl")
            };
            if (hash.value("ds") && !hash.value("dl") && !hash.value("did")) {
                opts.busdest.latlon = hash.value("dn");
                opts.busdest.name = hash.value("ds");
            }
            opts.city = hash.value("mc");
        }
    }
    //
    var paramN = parseInt(hash.value("n") || "-1", 10);
    _this._showOnlyN = isNaN(paramN) ? -1 : paramN;
    //
    if (this._objKStdTabs && this._objKStdTabs.tabs) {
        var tabs = this._objKStdTabs.tabs();
        if (tabs) {
            for (var t = 0; t < tabs.length; t++) {
                tabs[t].__hasQueried = tabs[t].__hashString = false;
            }
        }
    }
    //
    this.query(opts);
};
/**
 * 
 *
 * @param sendtype
 *            KSendType  KSendType.all
 * @param selected
 *            KSendType 
 * @uncrunch
 */
KBusearch.prototype.send = function(sendtype, selected){
    if (this._opts.sender) {
        var ksopt = KTools.copyOptions({}, KSendOptions);
        ksopt.sendtype = sendtype || (KSendType.email | KSendType.sms);
        ksopt.selected = selected;
        ksopt.email = [];
        ksopt.sms = [];
        var qopts = KTools.copyOptions({}, this._queryopts);
        ksopt.querytype = qopts.type;
        var sendHash = this._queryHash.clone();
        if (this._currentItem) {
            sendHash.setKey("n", this._currentItem.index);
        }
        var em_t = "";
        switch (qopts.type) {
            case KQueryType.busearch:
                em_t = "btsm";
                if (this._currentItem && this._currentItem.crValue) {
                    sendHash.setKey("cr", this._currentItem.crValue);
                }
                break;
            case KQueryType.busline:
                em_t = "blsm";
                if (this._currentItem) {
                    sendHash.setKey("rn", this._currentItem.data.r[0].n);
                }
                break;
            case KQueryType.bustation:
                em_t = "bssm";
                break;
            default:
                em_t = "btsm";
                break;
        }
        sendHash.setKey("t", em_t);
        
        //added by zwq,
       
        if(this._busTabTitle==="subway"&&this._busTab1Checked===true){
        	sendHash.setKey("isb",true);
		}
		if(this._busTabTitle==="nonstop"&&this._busTab2Checked===true){
			sendHash.setKey("isb",true);
		}
		if(this._busTabTitle==="shortWalk"&&this._busTab3Checked===true){
			sendHash.setKey("isb",true);
		}
        var emailStr = sendHash.toString();
        ksopt.email.push(this._getKNamedValue("url", emailStr));		
		//added by zy,
		var SMSContents,sendkey;
		//added by zwq bug_objKStdTabs
		var currentTabIndex;
		if(this._objKStdTabs){
			currentTabIndex = $(this._objKStdTabs.current().contentDom[0]).index() - 1;
		}
		//
		if (this._result.tt && this._result.sb) {
			var aIndex = ($('.mwp_arr_c:visible').index() - 1) / 2;
			SMSContents = this._sendSMSArray[currentTabIndex][aIndex].mv;
            sendkey = this._sendSMSArray[currentTabIndex][aIndex].mk;
		}
		else {
			SMSContents = this._description;
            sendkey = this._sendkey;
		}
        ksopt.sms.push(this._getKNamedValue("", {
            // @uncrunch
            content: SMSContents,
            sendkey: sendkey,
            // @uncrunch
            adtext: '',
            // @uncrunch
            selected: false
        }));
        this._opts.sender.send(ksopt);
    }
};
/**
 * 
 *
 * @uncrunch
 */
KBusearch.prototype.print = function(){
    var _this = this;
    var printer = this.options().printer;
    if (!printer) {
        return;
    }
    var opts = {};
    var qopts = KTools.copyOptions({}, this._queryopts);
    switch (qopts.type) {
        case KQueryType.busearch:
            break;
        case KQueryType.busline:
            break;
        case KQueryType.bustation:
            break;
    }
    if (this._currentItem) {
        opts.resultnum = this._currentItem.index;
    }
    //
    if (opts.resultnum === 0 && _this._lastOnlyN > -1) {
        opts.resultnum = _this._lastOnlyN;
    }
    //
    opts.queryopts = qopts;
    var newMKS = [], newLines = [];
    var markers = KMap.getMarkers();
    var lines = KMap.getLines();
    var i, j;
    for (i = 0, j = markers ? markers.length : 0; i < markers.length; i++) {
        newMKS.push(markers[i].toString());
    }
    for (i = 0, j = lines ? lines.length : 0; i < lines.length; i++) {
        newLines.push(lines[i].toString());
    }
    opts.markers = newMKS;
    opts.lines = newLines;
    //
    //	if(_this._currentItem.data && _this._currentItem.data.r[0] && _this._currentItem.data.r[0].n){
    //		opts.lineName = _this._currentItem.data.r[0].n;
    //	}
    printer.print(opts);
};
/***********************************************************************************************************************
 * 
 **********************************************************************************************************************/
/**
 * 
 *
 * @returns Number -1
 * @uncrunch
 */
KBusearch.prototype.selectedResult = function(){
    var _this = this;
    if (_this._currentItem && typeof _this._currentItem.index === "number") {
        return _this._currentItem.index;
    } else {
        return -1;
    }
};
/**
 * 
 *
 * @returns KTabItem  undefined
 * @uncrunch
 */
KBusearch.prototype.selectedTab = function(){
    var _this = this;
    if (_this._curTabItem) {
        return _this._curTabItem;
    } else {
        return undefined;
    }
};
/**
 * 
 *
 * @uncrunch
 */
KBusearch.prototype.reListStations = function(){
    var _this = this;
    _this._clearAllOverlay("all");
    if (!_this._objKStationList) {
        this._createStationList();
    }
    if (_this._objKStationList && _this._lastBusearchOpts) {
        this._setAutoSelectOpts(false);
        KEvent.bind(_this._objKStationList, "selectdone", function(){
            KEvent.unbind(_this._objKStationList, "selectdone", arguments.callee);
            _this._setAutoSelectOpts(true);
        });
        this._opts.searchbox && this._opts.searchbox.query(_this._lastBusearchOpts, true);
        _this._queryByStationList(_this._lastBusearchOpts);
    }
    //add by zwq[]
    _this._innerFlag = false;
    _this._busTab1Checked = false;
    _this._busTab2Checked = false;
    _this._busTab3Checked = false;
};
/**
 * KStationList
 *
 * @uncrunch
 */
KBusearch.prototype.allowReList = function(){
    //KBusearch.prototype.justQueriedByList=function(){
    return !!this._allowReList;
};
/**
 * 
 *
 * @param opts
 *            KMsgBoxOpenOptionsopts
 * @return
 * @uncrunch
 */
KBusearch.prototype.showTaxiFare = function(opts){
    if (!opts || !this.supportTaxi()) {
        return;
    }
    //
    if (!this._$taxiFareDom || !this._$taxiFareDom.length || !this._taxiContent) {
        return;
    }
    opts = $.extend(true, {}, opts);
    var _this = this;
    var bubOpts = opts.buboptions || {};
    bubOpts = KTools.copyOptions(bubOpts, KBubbleShowOptions);
    //bubOpts.arrow = false;
    //
    var msgOpts = KTools.copyOptions(opts, KMsgBoxOpenOptions);
    msgOpts.closedcbk = function(){
        _this._$taxiFareDom.hide().html("");
    };
    msgOpts.buboptions = bubOpts;
    //msgOpts.theme = "blue";
    //msgOpts.title = "";
    //
    if (!this._$taxiFareDom.is(":visible")) {
        //this._$taxiFareDom.html(this._taxiContent.replace(/\<p[^<]+/g, "<p></p>")).show();
        this._$taxiFareDom.html(this._taxiContent).show();
        this._msgId = KTools.showMsg(this._$taxiFareDom.get(0), msgOpts);
    } else {
        this._$taxiFareDom.hide().html("");
        KTools.hideMsg(this._msgId);
    }
    //
};
/**
 * 
 *
 * @return Boolean
 * @uncrunch
 */
KBusearch.prototype.supportTaxi = function(){
    return (!!this._taxiContent);
};
/***********************************************************************************************************************
 * 
 **********************************************************************************************************************/
/**
 * dom
 *
 * @param dom
 *            dom
 * @param type
 *            {KQueryType}
 */
KBusearch.prototype._showDom = function(dom, type){
    this._hideDom(type);
    if (!dom) {
        return;
    }
    // this.d_null
    if (this.d_null) {
        if (type == KQueryType.bustation) {
            this._busStationMsgBox.show();
            this._busStationDom.hide();
        } else if (type == KQueryType.busline) {
            this._busLineMsgBox.show();
            this._busLineDom.hide();
        } else if (type == KQueryType.busearch + "_2") {
            this._busSearchMsgBox.show();
        }
        this.d_null = false;
    } else {
        dom.show();
        this.layout();
    }
};
/**
 * KAccordion
 */
KBusearch.prototype._clearBusSearchAc = function(){
    if (this.busSearchAc) {
        for (var i = 0; i < this.busSearchAc.length; i++) {
            this.busSearchAc[i] && this.busSearchAc[i].finalize();
        }
    }
    this.busSearchAc = [];
};
KBusearch.prototype._hideDom = function(type){
    type != KQueryType.busearch && this._objKStationList && this._objKStationList.clearResult();
    if (type != KQueryType.busearch + "_2" && this._objKStdTabs) {
        var flag = this.flag();
        if(this.dragmarkerFlag){
        	KMap.clear(flag + "_search_s");
        }
        KMap.clear(flag + "_search_l");
        KMap.clear(flag + "_search_l_w");
        KMap.clear(flag + "_search_s_all");
        this._clearBusSearchAc();
    }
    this._busLineDom.hide();
    this._busSearchDom.hide();
    this._busStationDom.hide();
    type != KQueryType.busearch && this._transferDom.hide();
    if (this._objKStdTabs && this._objKStdTabs.tabs) {
        var tabs = this._objKStdTabs.tabs();
        if (tabs) {
            for (var t = 0; t < tabs.length; t++) {
                tabs[t].__hasQueried = tabs[t].__hashString = false;
            }
        }
    }
    this._busSearchMsgBox.hide();
    this._busStationMsgBox.hide();
    this._busLineMsgBox.hide();
};
/**
 * KStationList
 *
 * @param opts
 *            queryoptsions
 */
KBusearch.prototype._queryByStationList = function(opts){
    var _this = this;
    var defaultSubmit = false;
    _this._hideDom(opts.type);
    if (this._objKStdTabs && this._objKStdTabs.tabs) {
        var tabs = this._objKStdTabs.tabs();
        if (tabs) {
            for (var t = 0; t < tabs.length; t++) {
                tabs[t].__hasQueried = false;
            }
        }
    }
    this._createStationList();
    this.layout();
    var opts1 = KTools.copyOptions({}, KQueryOptions);
    opts1.busorig = KTools.copyOptions(opts.busorig, KPOInfo);
    opts1.busdest = KTools.copyOptions(opts.busdest, KPOInfo);
    opts1.city = opts.city || opts1.busorig.city;
    opts1.type = KQueryType.busearch;
    //this._lastBusearchOpts = $.extend(true, {}, opts1);
    this._opts.searchbox && this._opts.searchbox.query(opts1, true);
    this._objKStationList.query(opts1);
};
KBusearch.prototype._createStationList = function(){
    var _this = this;
    if (!this._objKStationList) {
        this._objKStationList = new KStationList(this._transferDom, _this.options().slopts);
        KEvent.bind(this._objKStationList, "selectdone", function(eventinfo, widget, origInfo, destInfo){
            this.clearResult();
            //_this._lastBusearchOpts = $.extend(true, {}, this.queryOptions());
            var qOpts = {
                busorig: $.extend(true, {}, origInfo),
                busdest: $.extend(true, {}, destInfo),
                type: KQueryType.busearch,
                city: origInfo.city || destInfo.city || "",
                tt: "subway",
                __byinner: true
            };
            defaultSubmit = true;
            _this.query(qOpts);
        });
        KEvent.bind(this._objKStationList, "changehash", function(event, widget, queryOpts, urlHash){
            var hash = urlHash.clone();
            hash.setKey(_this._mwpf, _this.flag());
            KListener.setHash(hash);
        });
        KEvent.bind(this._objKStationList, "locationchanged", function(event, widget, which, info){
            // searchbox
            if (_this._opts.searchbox) {
                var opts = $.extend(true, {}, this.queryOptions());
                // searchbox
                if (which === "orig") {
                    opts.busorig = info;
                    opts.busdest = undefined;
                } else if (which === "dest") {
                    opts.busorig = undefined;
                    opts.busdest = info;
                }
                _this._opts.searchbox.query(opts, true);
            }
        });
        KEvent.bind(this._objKStationList, "submitbtn", function(evt, w, v){
            KEvent.trigger(_this, "sl_submitbtn", _this, v);
        });
        KEvent.bind(this._objKStationList, "mapready", function(evt, w, c, l){
            KEvent.trigger(_this, "mapready", _this, c, l);
        });
        KEvent.bind(this._objKStationList, "resultshown", function(evt, w, a, r){
            // KStationList
            this.show();
            this.layout();
            if (_this._opts.searchbox) {
                this.showNoResultTip(_this._opts.searchbox.getCurrInputs());
            }
            // 
            defaultSubmit = false;
            KEvent.trigger(_this, "resultshown", _this, "stationlist", r);
            KEvent.trigger(_this, "sl_resultshown", _this);
        });
        KEvent.bind(this._objKStationList, "resultloaded", function(evt, wgt, action, result){
            KEvent.trigger(_this, "sl_resultloaded", _this);
            // searchbox
            if (_this._opts.searchbox) {
                var _opts = $.extend(true, {}, this.queryOptions());
                var origName = "", destName = "";
                if (!((_opts && _opts.busorig && !_opts.busorig.name) || (_opts.busdest && !_opts.busdest.name))) {
                    return;
                }
                try {
                    origName = result.s.d[0].n;
                } catch (ex) {
                }
                try {
                    destName = result.e.d[0].n;
                } catch (ex) {
                }
                !_opts.busorig.name && (_opts.busorig.name = origName || "");
                !_opts.busdest.name && (_opts.busdest.name = destName || "");
                _this._opts.searchbox.query(_opts, true);
            }
        });
    }
};
KBusearch.prototype._parseURL = function(opts, onlyN){
    var _url, optsChild, parsedURL = [];
    switch (opts.type) {
        case KQueryType.busearch:
            optsChild = "busearch";
            _url = this.options().busurl;
            break;
        // 
        case KQueryType.busline:
            optsChild = "busline";
            _url = this.options().lineurl;
            break;
        // 
        case KQueryType.bustation:
            optsChild = "bustation";
            _url = this.options().stationurl;
            break;
    }
    parsedURL.push(_url);
    var wh = this._getMapWH();
    parsedURL.push("&w=" + wh.w);
    parsedURL.push("&h=" + wh.h);
    var _newHash = new KUrlHash();
    for (var i in KPOInfo) {
        if (opts[optsChild][i]) {
            _newHash.setKey(i === "name" ? "k" : i.substring(0, 1), opts[optsChild][i]);
        }
    }
    _newHash.setKey("w", wh.w + "");
    _newHash.setKey("h", wh.h + "");
    onlyN > -1 && (_newHash.setKey("n", onlyN));
    this._queryHash = _newHash.clone();
    return _url + "&" + _newHash.toString();
};
KBusearch.prototype._requestData = function(url, type, tab_t){
    var _this = this;
//	if(_this._ajaxFlag){
//		return;
//	}
//	_this._ajaxFlag=true;
    // 
    var paramN = url.match(/\&n=(\d{0,3})/);
    if (paramN && paramN[1]) {
        paramN = parseInt(paramN[1], 10);
        paramN = isNaN(paramN) ? -1 : paramN;
    } else {// , -1
        paramN = -1;
    }
    
    $.ajax({
        type: "GET",
        url: url,
        success: function(data){
            // 
            _this._lastOnlyN = paramN;
            (data && data.r && data.r.length && data.r.length > 1 && _this._lastOnlyN >= data.r.length) &&
            (_this._lastOnlyN = -1);
            /**
             * resultshown, resultloadedaction   transfer  lines  stations
             *
             */
            var actionType = null, $noRltDom = null;
        	
            switch (type) {
                case KQueryType.busearch:
                    actionType = "transfer";
                    _this._allowReList = true;
                    $noRltDom = _this._busSearchMsgBox;
                    break;
                case KQueryType.busline:
                    actionType = "lines";
                    $noRltDom = _this._busLineMsgBox;
                    break;
                case KQueryType.bustation:
                    actionType = "stations";
                    $noRltDom = _this._busStationMsgBox;
                    break;
            }
        	
            //
            var isNoResult = !!(!data || !data.r || data.r.length === 0 || (data.t && parseInt(data.t, 10) == 0));
            //
            _this._result = data;
			//added by zy1,bug
			var currentTabIndex;
			switch (_this._queryopts.tt) {
				case 'subway':
					currentTabIndex = 0;
					break;
				case 'nonstop':
					currentTabIndex = 1;
					break;
				case 'shortWalk':
					currentTabIndex = 2;
					break;
				case 'unsubway':
					currentTabIndex = 3;
					break;	
			}
        	
			//ajax
			if(!_this._sendSMSArray[currentTabIndex] || _this._sendSMSArray[currentTabIndex]!=_this._result.r) _this._sendSMSArray[currentTabIndex] = _this._result.r;
			//added over
            _this._taxiContent = undefined;
            actionType && KEvent.trigger(_this, "resultloaded", _this, actionType, data);
//			//added by zy,sb_nm
			if (data && data.sb === 'true') {
//				
//				if (!_this._nm) {
//					_this._nm = 'false';
//				}
				//ie6""
				var isIE=!!window.ActiveXObject;   
				var isIE6=isIE&&!window.XMLHttpRequest;   
				var isIE8=isIE&&!!document.documentMode;   
				var isIE7=isIE&&!isIE6&&!isIE8;  
				
				if ($(_this._objKStdTabs._dom).find('.mwp_stb_c').eq(_this._tabsCurrent).find('input').get(0)) {
					if (!isIE6&&!isIE7) {
						$(_this._objKStdTabs._dom).find('.mwp_stb_c').eq(_this._tabsCurrent).find('input').attr('disabled', '');
					}
				}
			}
			
			//added over
            !isNoResult && _this._initMapTriggest(type);
            if (isNoResult) {// 
            	//_this.optsBak = KTools.copyOptions({}, _this._queryopts)
            	_this.optsBak = $.extend(true, {}, _this._queryopts);
            	_this.clearResult();
        	    KEvent.trigger(_this, "noresults", _this, type, $noRltDom ? $noRltDom.get(0) : null);
        	    KTools.showMsg("");
                $noRltDom.show();
            	if(_this.markerBak){
            		_this.sMarker = _this._createSoeMarkerForTrans(_this.markerBak , "s");
            		_this.eMarker= _this._createSoeMarkerForTrans(_this.markerBak , "e");
	                //added by zwq 
            		_this.sMarker.setEditable(true);
            		_this.eMarker.setEditable(true);
	                KEvent.bind(_this.sMarker, "dragend", _this._draged, {marker: _this.sMarker, type : 's'}, _this);
	                KEvent.bind(_this.eMarker, "dragend", _this._draged, {marker: _this.eMarker, type : 'e'}, _this);
	                KMap.addMarkers([_this.sMarker, _this.eMarker], false);
	                _this.sMarker.hilite();
	                _this.eMarker.hilite();
            	}
            }
         
            actionType && KEvent.trigger(_this, "resultshown", _this, actionType, _this._result);
            
        	
        },
        error: function(){
            KTools.showMsg("");
            if (!KMap.isInitialized(_this._opts.mapcontainer)) {
                KEvent.trigger(_this, "mapready", _this/* ,_point,_zoom */);
            }
        },
        dataType: "json"
    });
};
/**
 * 
 *
 * @param type
 *            {KQueryType}
 */
KBusearch.prototype._initMapTriggest = function(type){
    var _this = this;
    _this._fitzoomflag = true;
    //  + 
    var point, zoom;
    if (_this._result) {
        var obj = (this._result.m && this._result.m) || (this._result.r && this._result.r[0] && this._result.r[0].m);
        point = obj.a ? new MPoint(obj.a) : undefined;
        zoom = obj.b || undefined;
    }
    
    if (!KMap.isInitialized(_this._opts.mapcontainer)) {// 
        _this._fitzoomflag = false;
        KEvent.bind(KMap, "mapinit", function(){
            // 
            KEvent.unbind(KMap, "mapinit", arguments.callee);
            // 
            type == "bustation2" ? _this._dataToOverlay(_this._result) : _this._dataToDom(_this._result, _this._queryopts.type, _this._queryopts.tt);
            _this.showObj && _this._showDom(_this.showObj.dom, _this.showObj.type, _this._result);
            _this.showObj = null;
        });
        KEvent.trigger(_this, "mapready", _this, point, zoom);
    } else {// 
        KMap.setCenter(point, zoom);
        // 
        type == "bustation2" ? _this._dataToOverlay(_this._result) : _this._dataToDom(_this._result, _this._queryopts.type, _this._queryopts.tt);
	  
        _this.showObj && _this._showDom(_this.showObj.dom, _this.showObj.type);
        _this.showObj = null;
    	
    }
	
};
/**
 * , 
 *
 * @param data
 *            
 */
KBusearch.prototype._dataToOverlay = function(data){
    if (!data || !data.r || data.r.length == 0) {
        return KTools.showMsg("");
    }
    var group = this.flag() + "_station2";
    KMap.clear(group);
    //
    var createMarker = function(name, latlon, link, group, soe){
        var opts = KConfig.get("mk_mo_sdt", {
            n: name,
            t: soe
        });
        opts.infowin = KConfig.get("iw_iwo_st", {
            h: link
        });
        opts.infowin.title = name;
        opts.infowin.cmdata = {
            poi: KTools.copyOptions({
                type: KQueryType.busearch,
                name: name,
                city: this._queryopts.bustation.city,
                latlon: latlon
            }, KPOInfo)
        };
        opts.group = group;
        return new KMarker(latlon, opts);
    };
    //
    var r = data.r[0];
    var opts = KConfig.get("ln_lo_bst");
    opts.group = group;
    // 
    var line = KLine.fromEncoded(r["p"], r["l"], opts);
    // 
    KMap.addMarkers([createMarker(r["fs"], r["fl"], r["b"] + r["fn"], group, "s"), createMarker(r["ls"], r["ll"], r["b"] + r["ln"], group, "e")], false);
    KMap.addLine(line);
    //  
    r.m && KMap.setCenter(r.m.a, parseInt(r.m.b));

};
/**
 * @param data
 *            {Object}
 * @param type
 *            {KQueryType}
 * @param tab_t
 *            TabType, KStdTabstabItemsubway, nonstop, shortWalk undefined
 */
KBusearch.prototype._dataToDom = function(data, type, tab_t){
	// added by zwq
	KMap.clearLine();
    if (type === undefined) {
        return;
    }
    var _this = this;
    //
    if (type === KQueryType.bustation) {
        /***************************************************************************************************************
         * 
         **************************************************************************************************************/
        _this._busStationDataHandler(data);
    } else if (type === KQueryType.busline) {
        /***************************************************************************************************************
         * 
         **************************************************************************************************************/
        //
        if (!data || !data.r || data.r.length == 0) {
            return (_this.d_null = true);
        }
        //
        if (parseInt(data.t, 10) > 0) {
			//added by zwq,
			var similarA = [];
			for(var i=0; i<data.r.length; i++){
				similarA.push("<a target='_blank' href='javascript:void(0);' mfg='" + data.r[i].b + "'>" + data.r[i].a + "</a>")
			}
			if (data.r.length < 2) {
				var similarDom = "<div style='display:none' class='mwp_bs_stip'><span></span>" + similarA.join('') + "</div>";
				_this._bLineLength = true;
				//this._busLineDom.find('.mwp_bs_lsrd').height(this._busLineDom.find('.mwp_bs_lsrd').height() + 10);
			} else {
                var similarDom = "<div class='mwp_bs_stip'><span></span>" + similarA.join('') + "</div>";
            }

            var $headLinks = this._busLineDom.empty().html(similarDom).find("a");
            $headLinks.click(function(event){
                event.preventDefault();
                var $thisLink = $(this);
                if ($thisLink.hasClass(_this.cssClassName.DL)) {
                    return;
                }
                //
                _this._currentItem = {
                    "index": $headLinks.index($thisLink)
                };
                //
                $thisLink.addClass(_this.cssClassName.DL).siblings().removeClass(_this.cssClassName.DL);
                if ($thisLink.data("buslinedata")) {
                    _this._currentItem.data = $thisLink.data("buslinedata");
                    return _this._busLineDataHandler($thisLink.data("buslinedata"), data.c);
                }
                var keyword = $.trim($thisLink.attr("mfg") || "");
                if (!keyword) {
                    return;
                }
                var lineHash = new KUrlHash();
                var wh = _this._getMapWH();
                lineHash.setKey("w", wh.w + "");
                lineHash.setKey("h", wh.h + "");
                lineHash.setKey("ss", "true");
                lineHash.setKey("c", data.c);
                lineHash.setKey("t", "bsr");
                lineHash.setKey("rn", keyword);
                //lineUrlHash.setKey("rn", "1");
                var prefix = _this.options().lineurl;
                var qMark = prefix.indexOf("?");
                prefix = qMark > -1 ? prefix.substring(0, qMark + 1) : prefix + "?";
                $.ajax({
                    type: "GET",
                    url: (prefix + lineHash.toString()),
                    success: function(reData){
                        if (!reData || !reData.r) {
                            return KTools.showMsg("");
                        }
                        _this._currentItem.data = reData;
                        _this._busLineDataHandler(reData, data.c);
                        $thisLink.data("buslinedata", reData);
                    },
                    error: function(){
                        KTools.showMsg("");
                    },
                    dataType: "json"
                });
            });
            var n = _this._lastOnlyN > $headLinks.length - 1 || _this._lastOnlyN === -1 ? 0 : _this._lastOnlyN;
            $headLinks.eq(n).trigger("click");
        } else {
            _this.showObj.dom = _this._busLineMsgBox;
        }
    } else if (type == KQueryType.busearch) {
    	
        /***************************************************************************************************************
         * 
         **************************************************************************************************************/
    	 
        var types = {
            "subway": 0,
            "nonstop": 1,
            "shortWalk": 2,
            "unsubway": 3
        };
        var eq_i = types[data.tt] || 0;
        //""
        if(!_this._innerFlag){
//	        	$('[name=sopt]:checkbox').attr('checked',false);
	    		$('input[type=checkbox]').each(function(){
	    			if($(this).attr('name') == 'sopt'){ 
	    				$(this).attr('checked', false);
	    			}
	    		});
				_this._innerFlag = true;
        }
    	this._objKStdTabs.select(eq_i);
        if (!data || !data.r || data.r.length == 0) {
            return (_this.d_null = true);
        }
        this._taxiContent = data.taxi || "";
        this.busSearchAc[eq_i] && this.busSearchAc[eq_i].finalize && this.busSearchAc[eq_i].finalize();
        this._$ssr = $("<div/>").appendTo(this._busSearchDom.children("div").eq(0).children("div").eq(eq_i));// .addClass(this.cssClassName.LSR));
        var _html = [], i, j;
        for (i = 0, j = data.r.length; i < j; i++) {
            _html.push(data.r[i].h);
        }
        this._$ssr.empty().html(_html.join(""));
        //added by zwq sb""dom
		this._$ssr.parent().find('.mwp_bs_sopt').hide();
		if(data.sb=='true') {
			this._$ssr.parent().find('.mwp_bs_sopt').show();
		}
		//_busTabTitleURL
		if(!_this._busTabTitle){
			_this._busTabTitle = KUrlHash.parseByHash(location.href, false)._UrlHash.tt;
		}
		if (data && data.sb && data.sb === 'true' && this._$ssr.parent().find('.mwp_bs_sopt').length == 0) {
//			
		}
    
    	 
        /**
         *  KStdTabs 33
         * 3
         */
		
        var acco = this.busSearchAc[eq_i] = new KAccordion(this._$ssr.eq(0), {
            collapse: false,
            multiple: false
        });
        
        this._oqueryopts = KTools.copyOptions({}, _this._queryopts);
        var tabs = acco.tabs();
        // _this.substringTitle(this_busSearchAcTabs);
        function parseBusSearchAcItemUrl(tabs){
            var opts = _this._queryopts;
            var orig = opts.busorig;
            var dest = opts.busdest;
            var _qUrlHash = new KUrlHash();
            _qUrlHash.setKey("ol", orig.latlon);
            _qUrlHash.setKey("on", orig.name);
            _qUrlHash.setKey("ot", orig.type);
            orig.pid && _qUrlHash.setKey("oid", orig.pid);
            _qUrlHash.setKey("dl", dest.latlon);
            _qUrlHash.setKey("dn", dest.name);
            _qUrlHash.setKey("dt", dest.type);
            dest.pid && _qUrlHash.setKey("did", dest.pid);
            _qUrlHash.setKey("tt", opts.tt);
            _qUrlHash.setKey("c", opts.city);
			//added by zy,nm
			if(data && data.sb && data.sb === "true"){
				_qUrlHash.setKey("nm", 'some');
			}
			//added by zy,nm
			if(data.nm && data.nm === 'false'){
				_qUrlHash.setKey("nm", 'false');
			}
			else if(data.nm && data.nm === 'true'){
				_qUrlHash.setKey("nm", 'true');
			}

            var wh = _this._getMapWH();
            _qUrlHash.setKey("w", wh.w + "");
            _qUrlHash.setKey("h", wh.h + "");

            //
            var arrR = _this._result.r;
            for (var i = 0; i < tabs.length; i++) {
                _qUrlHash.setKey("bn", i + "");
                $(tabs[i].tabDom).data("urlhash", _qUrlHash.toString());
                if (i > 0) {
                    // KAccordion tabs, 
                    tabs[i].url = _this.options().busurl.replace("bt", "btd") + "&" + _qUrlHash.toString();
                }
                // for hoverlines
                if (arrR && arrR[i] && arrR[i].j) {
                    $(tabs[i].tabDom).data("hoverlines", _this._getHoverLines(arrR[i].j));
                }
            }
        }
    
        parseBusSearchAcItemUrl(tabs);
        tabs[0].data = data;
    
        _this._busCo2Click(tabs[0]);
        //
//        _this._ajaxFlag = false;
        KEvent.bind(acco, "selected", function(evt, item){
            _this._currentItem = item;
            _this._bindLi.apply(_this, [item, false]);
            _this._bindCheckBox.apply(_this, [item, false]);
        });
        KEvent.bind(acco, "dataloaded", function(evt, ac, data, item){
            _this._busCo2Click(item);
        });
    	
        KEvent.bind(acco, "headclick", function(evt, ac, item){
            var dataM = "";
            try {
                dataM = item.data.r[0].m;
            } catch (ex) {
                return;
            }
            if (dataM && dataM.a && dataM.b) {
                KMap.setCenter(dataM.a, parseInt(dataM.b, 10));
            }
        });
        var hoverLinesGroup = _this.flag() + "_hoverlines";
        KEvent.bind(acco, "headmouseenter", function(evt, ac, item){
            if (item && item.tabDom) {
                var hoverLines = $(item.tabDom).data("hoverlines");
                if (hoverLines) {
                    var lines = _this._parseToLines(hoverLines.pt, hoverLines.lv, "ln_lo_gray", hoverLinesGroup);
                    KMap.addLines(lines, false);
                }
            }
        });
        KEvent.bind(acco, "headmouseleave", function(evt, ac, item){
            KMap.clearLine(hoverLinesGroup);
        });
        acco.select(0, true);
    	
        
    }
    	
};
KBusearch.prototype._createMarkerForBusLine = function($a, index, length, urlHead, stationType){
    var _this = this;
    var markerOpts;
    var isSoe = (index == 0 || index == length - 1);
    var name = $a.text();
    name = $.trim(name.replace(/(\d+.)/i, ""));
    if (isSoe) {
        markerOpts = KConfig.get("mk_mo_sdt", {
            n: name,
            t: index == 0 ? "s" : "e"
        });
        markerOpts.hoverLabel = false;
        markerOpts.group = _this.flag() + "_line_s";
    } else {
        markerOpts = KConfig.get("mk_mo_s", {
            n: name,
            t: stationType
        });
        markerOpts.hoverLabel = true;
        markerOpts.group = _this.flag() + "_line";
    }
    // h:, infoWindow"
    markerOpts.infowin = KConfig.get("iw_iwo_st", {
        h: urlHead + $a.attr("n"),
        cd: "none",
        fs: "none",
        nb: "none"
    });
    markerOpts.infowin.title = name;
    return (new KMarker($a.attr("ll"), markerOpts));
};
/**
 *
 */
KBusearch.prototype._createBustationMarker = function(latlon, index, urlHead, url, title){
    var _this = this;
    var markerOpts = KConfig.get("mk_mo_sn", {
        a: index + 1
    });
    markerOpts.infowin = KConfig.get("iw_iwo_st", {
        h: urlHead + url,
        cd: "none",
        fs: "none",
        nb: "none"
    });
    markerOpts.infowin.title = title;
    var poiInfo = KTools.copyOptions({
        type: KQueryType.busearch,
        name: title,
        city: _this._queryopts.bustation.city,
        latlon: latlon
    }, KPOInfo);
    markerOpts.infowin.cmdata = {
        poi: poiInfo
    };
    markerOpts.group = _this.flag() + "_station1";
    return (new KMarker(latlon, markerOpts));
};
/**
 * @param data
 *            {Object}
 *
 */
KBusearch.prototype._busStationDataHandler = function(data){
    var _this = this;
    if (!data || !data.r || data.r.length == 0) {
        _this.d_null = true;
        return;
    }
    _this._busStationMsgBox.hide();
    //
    var stationNames = [];
    for (var index = 0; index < data.r.length; index++) {
        stationNames.push(data.r[index].n);
    }
    //html
	//added by zy,div
	if (data && data.r) {
		if(data.r.length > 1) var headHtml = '<div class="' + this.options().theme + '_bs_stip"><span></span><a href="javascript:void(0);">' + stationNames.join('</a><a href="javascript:void(0);">') + '</a></div>';
		else var headHtml = '<div style="display:none" class="' + this.options().theme + '_bs_stip"><span></span><a href="javascript:void(0);">' + stationNames.join('</a><a href="javascript:void(0);">') + '</a></div>';
	}
    this._busStationDom.empty().html(headHtml);
    var $contentDiv = $("<div/>").addClass(this.cssClassName.SSRD).appendTo(this._busStationDom);
    var $stationContentDiv = $("<div/>").addClass(this.cssClassName.SI).appendTo($contentDiv);
    var $headDiv = this._busStationDom.children("div").eq(0);
    //
    var $headLinks = $headDiv.find("a");
    $headLinks.bind("click", function(event){
        event.preventDefault();
        if ($(this).hasClass(_this.cssClassName.DL)) {
            return;
        }
        //KMap.clear(_this.flag() + "_station1");
        _this._clearAllOverlay("all");
        $(this).addClass(_this.cssClassName.DL).siblings().removeClass(_this.cssClassName.DL);
        //
        var index = $headLinks.index($(this));
        _this._currentItem = {
            "index": index,
            "data": data.r[index]
        };
        //html
        $stationContentDiv.empty().html(data.r[index].h + data.f);
        var tagAs = $stationContentDiv.find("li>a");
        tagAs.each(function(index){//stationContentDiv, 
            var html = $(this).html();
            //html = html.toLowerCase();
            var fullName = html.substring(0, html.toLowerCase().indexOf("<span"));
            html = _this._deleteForSMS(html).replace("-", "");
            $(this).empty().html(html).data("fullname", fullName);
        });
        tagAs.bind("click", function(){//
            var $aLine = $(this);
            if ($aLine.data("linedata")) {
                _this._bustationDataToLine($aLine.data("linedata"), data.c);
                return;
            }
            var keyword = $(this).data("fullname");
            var lineUrlHash = new KUrlHash();
            var wh = _this._getMapWH();
            lineUrlHash.setKey("w", wh.w + "");
            lineUrlHash.setKey("h", wh.h + "");
            //lineUrlHash.setKey("ss", "true");
            lineUrlHash.setKey("c", data.c);
            lineUrlHash.setKey("t", "bsr");
            lineUrlHash.setKey("rn", keyword);
            //lineUrlHash.setKey("o", reData.r[0].o);
            var lineUrlHead = _this.options().stationurl;
            var questionMark = lineUrlHead.indexOf("?");
            if (questionMark > -1) {
                lineUrlHead = lineUrlHead.substring(0, questionMark + 1);
            } else {
                lineUrlHead = lineUrlHead + "?";
            }
          
            $.ajax({
            	
                type: "GET",
                url: (lineUrlHead + lineUrlHash.toString()),
                success: function(reData){
                    if (!reData || !reData.r) {
                        KTools.showMsg("");
                        return;
                    }
                    _this._bustationDataToLine(reData, data.c);
                    $aLine.data("linedata", reData);
                },
                error: function(){
                    KTools.showMsg("");
                },
                dataType: "json"
            });
        }).find("span").bind("click", function(event){
            event.stopPropagation();
            window.open($(this).attr("url"));
        });
        //
        var urlHead = data.b;
        var name = $stationContentDiv.find("h3").text();
        var $dts = $stationContentDiv.find("dl>dt");
        //
        var mouseOverHandler = function($dtOrMarker, is$dt){
            var $dt, marker, index, toScroll = false;
            if (is$dt === true) {
                $dt = $dtOrMarker;
                index = $dts.index($dt);
                marker = $dt.data("marker");
            } else {
                marker = this;
                index = marker._relateDtIndex;
                $dt = $dts.eq(index);
                toScroll = true;
            }
            if (!$dt || !marker) {
                return;
            }
            $dts.each(function(curIndex){
                var ss = _this.cssClassName.SS;
                if (curIndex === index) {
                    $dt.addClass(ss);
                    marker.setIconClass(KConfig.get("mk_s_snh", {
                        a: index + 1
                    }));
                    marker.hilite();
                } else {
                    if ($(this).hasClass(ss)) {
                        $(this).removeClass(ss);
                        var curMarker = $(this).data("marker");
                        if (curMarker) {
                            curMarker.setIconClass(KConfig.get("mk_s_snn", {
                                a: curIndex + 1
                            }));
                        }
                    }
                }
            });
            //
            toScroll && KTools.scrollIntoView($dt.get(0), $dt.parent().parent().parent().parent().get(0), "normal");
        };
        //marker
        var latlons = [];
        $dts.each(function(dtIndex){
            var marker = _this._createBustationMarker($(this).attr("lat"), dtIndex, urlHead, data.r[index].z, name);
            marker._relateDtIndex = dtIndex;
            KMap.addMarker(marker);
            latlons.push(marker.latlon());
            KEvent.bind(marker, "mouseover", mouseOverHandler);
            $(this).data("marker", marker);
        });
        // dt
        $dts.bind("mouseover", function(){
            mouseOverHandler($(this), true);
        }).bind("click", function(){
            var marker = $(this).data("marker");
            if (marker) {
                KMap.closeInfoWindow();
                KMap.setCenter(marker.latlon());
                KMap.openInfoWindow(marker);
            }
        });
        KMap.fitzoom(latlons);
        //
        var liNames = [];
        $stationContentDiv.find("ul>li").each(function(){
            var txt = $(this).text();
            var index = txt.indexOf("(");
            if (index > -1) {
                txt = txt.substring(0, index);
            }
            liNames.push(txt);
        });
        //
//        var wyBstDom = ''
//        $stationContentDiv.find("ul>li").last().after(wyBstDom);
        
        _this._description = _this._currentItem.data.mv || (name + "" + liNames.length + ":" + liNames.join(",")); // ;
        _this._sendkey = _this._currentItem.data.mk || '';

        //""
        $stationContentDiv.find("a[mfg='ssms']").eq(0).click(function(){
            _this.send(KSendType.sms, KSendType.sms);
        });
        //""
        $stationContentDiv.find("a[mfg='smail']").eq(0).click(function(){
            _this.send(KSendType.email, KSendType.email);
        });
        //""
        $stationContentDiv.find("a[mfg='scp']").eq(0).click(function(){
        });
        //""
        $stationContentDiv.find("a[mfg='sprt']").eq(0).click(function(){
            _this.print();
        });
        //""
        $stationContentDiv.find("a[mfg='serr']").eq(0).click(function(){//

            var fbinfo = KTools.copyOptions({}, KFeedbackInfo);
            fbinfo.type = KFeedbackType.ROUTE_ERROR;
            fbinfo.notes = name;
            fbinfo.url = location.href + "&n=" + _this.selectedResult();
            var krinfo = KTools.copyOptions({}, KRouteInfo);
            krinfo.name = name;
            krinfo.type = KRouteType.BUS;
            krinfo.queryopts = KTools.copyOptions({}, _this._queryopts);
            krinfo.resultnum = _this._currentItem.index;
            KEvent.trigger(_this, "feedback", _this, fbinfo, krinfo);
        });
        //
        //
        _this.layout();
        var headHeight = $headDiv.outerHeight(true);
        var extraHeight = $contentDiv.outerHeight(true) - $contentDiv.innerHeight();
        var contentHeight = _this._busStationDom.innerHeight() - headHeight - extraHeight;
        if(data.r.length<2){
        	contentHeight = contentHeight+26 ;
        }
        $contentDiv.css("height", contentHeight + "px");
    });
    //$headDiv
    window.setTimeout(function(){
        $headLinks.eq(0).trigger("click");
    }, 0);
};
/**
 *
 */
KBusearch.prototype._bustationDataToLine = function(lineData, city){
    var _this = this;
    var group = _this.flag() + "_station2";
    KMap.clear(group);
    var latlon = lineData.r[0].m.a, level = parseInt(lineData.r[0].m.b, 10);
    KMap.setCenter(latlon, level);
    //
    var lineOpts = KConfig.get("ln_lo_bst");
    lineOpts.group = group;
    lineOpts.overlap = !KTools.isIE6;
    line = KLine.fromEncoded(lineData.r[0].p, lineData.r[0].l, lineOpts);
    KMap.addLine(line);
    //
    var sMarker = _this._createSoeMarkerForStation(lineData.r[0], city, "s");
    var eMarker = _this._createSoeMarkerForStation(lineData.r[0], city, "e");
    KMap.addMarkers([sMarker, eMarker], false);
    //
    KMap.setCenter(lineData.r[0].m.a, parseInt(lineData.r[0].m.b, 10));
};
/**
 * 
 *
 * @param itemData
 *            {Object} 
 * @param soe
 *            {String} "s" or "e"
 * @returns {KMarker}
 */
KBusearch.prototype._createSoeMarkerForStation = function(itemData, city, soe){
    var _this = this;
    var name = (soe === "s") ? itemData.fs : itemData.ls;
    // marker
    var markerOpts = KConfig.get("mk_mo_sdt", {
        n: name,
        t: soe
    });
    // group
    markerOpts.group = _this.flag() + "_station2";
    // InfoWindow""
    var hUrl = (soe === "s") ? itemData.fn : itemData.ln;
    var urlHead = itemData.b;
    if (hUrl && urlHead) {
        markerOpts.infowin = KConfig.get("iw_iwo_st", {
            h: urlHead + hUrl,
            cd: "none",
            fs: "none",
            nb: "none"
        });
    }
    // tittle
    markerOpts.infowin.title = name;
    // commonData
    var latlon = (soe === "s") ? itemData.fl : itemData.ll;
    markerOpts.infowin.cmdata = {
        poi: KTools.copyOptions({
            type: KQueryType.busearch,
            name: name,
            city: city,
            latlon: latlon
        }, KPOInfo)
    };
    // snapText
    if (markerOpts.label) {
        markerOpts.label.snapText = name;
    }
    //
    return new KMarker(latlon, markerOpts);
};
/**
 * 
 *
 * @param origName
 *            
 * @param destName
 *            
 */
KBusearch.prototype._setFavoriteTitle = function(origName, destName){
    var _pref = "" + origName + "" + destName;
    this._favoriteTitle = _pref + "    :";
};
/**
 * 
 *
 * @param item
 *            {KAccordion}
 */
KBusearch.prototype._busCo2Click = function(item){
    var c = item.contentDom.children("div");
    var _this = this;
    var _busCo2Href = $(c).find("a[mfg='bsc']").eq(0);
    //
//    var _wycxdom = ''
    var _wycxFlag = c.eq(0).find("div").eq(1).find("a[mfg='wycx']").eq(0).length;
//    if(_wycxFlag == 0 ){
//    	c.eq(0).find("div").eq(1).append(_wycxdom);
//    }
	//""
    $("a[mfg='bsms']", c).eq(0).click(function(){
        _this.send(KSendType.sms, KSendType.sms);
    });
    //""
    $("a[mfg='bmail']", c).eq(0).click(function(){
        _this.send(KSendType.email, KSendType.email);
    });
    //
    $("a[mfg='bcp']", c).eq(0).click(function(){
        //_this.send();
    });
    //
    $("a[mfg='bprt']", c).eq(0).click(function(){
        _this.print();
    });
    //
    $("a[mfg='bads']", c).eq(0).text("");
    //
    $("a[mfg='berr']", c).eq(0).click(function(){//

        var fbinfo = KTools.copyOptions({}, KFeedbackInfo);
        fbinfo.type = KFeedbackType.ROUTE_ERROR;
        fbinfo.url = location.href + "&n=" + _this.selectedResult();
        var krinfo = KTools.copyOptions({}, KRouteInfo);
        var notText = $(item.tabDom).find("strong>span").text();
        krinfo.name = $.trim($(item.tabDom).text().replace(notText, ""));
        krinfo.type = KRouteType.BUS;
        krinfo.queryopts = KTools.copyOptions({}, _this._queryopts);
        krinfo.resultnum = item.index;
        KEvent.trigger(_this, "feedback", _this, fbinfo, krinfo);
    });
    var _busCo2Content = $(">span", _busCo2Href);
    
    //<--20121210 -->
    _busCo2Href.hide();
    
    
    _busCo2Href.click(function(){
        if (!_this._busCo2ShowDom.is(":visible")) {
            _this._updateCo2ShowDom(item);
            _this._busCo2ShowDom.show();
            _this._msgId = KTools.showMsg(_this._busCo2ShowDom.get(0), {
                closedcbk: function(){
                    _this._busCo2ShowDom.hide();
                },
                node: _busCo2Content.get(0),
                cbmargin: 0,
                buboptions: {
                    offsetx: 113
                }
            });
        } else {
            _this._busCo2ShowDom.hide();
            KTools.hideMsg(_this._msgId);
            _this._msgId = undefined;
        }
    });
};
/**
 *
 * @param item
 *            {KTabItem}
 * @returns
 */
KBusearch.prototype._busLineDataHandler = function(reData, city){
    var _this = this;
    this._clearAllOverlay("busline");
    // update html
    var $divKids = _this._busLineDom.children("div");
    var $contentDiv = $divKids.eq(1);
    if (!$contentDiv.length) {
        $contentDiv = $("<div/>").addClass(_this.cssClassName.LSRD).appendTo(_this._busLineDom);
    }
    // $contentDiv.addClass(_this.cssClassName.LI);
    var extra = $contentDiv.outerHeight(true) - $contentDiv.innerHeight();
    var height = _this._busLineDom.innerHeight() - $divKids.eq(0).outerHeight(true) - extra;
    //added by zwq 
    if(_this._bLineLength&&!KTools.isIE6){
    	height = height + 25;
    	_this._bLineLength = null;
    }
    if (KTools.isIE6) {//
        height = height - 5;
    }
    $contentDiv.height(height + "px").empty().html("<div class='" + _this.cssClassName.LI + "'>" + reData.r[0].h + "</div>");
    // update map -> line
    var lineOpts = KConfig.get("ln_lo_bsl");
    lineOpts.group = _this.flag() + "_line";
    lineOpts.overlap = !KTools.isIE6;
    var line = KLine.fromEncoded(reData.r[0].p, reData.r[0].l, lineOpts);
    if (line) {
        KMap.addLine(line);
    }
    // update map -> markers
    var pointerMarkers = [];
    var soeMarkers = [];
    var $tagAs = $contentDiv.find("li>a");
    var len = $tagAs.length;
    $tagAs.each(function(index){
        var marker = _this._createMarkerForBusLine($(this), index, len, reData.r[0].b, reData.r[0].t);
        KMap.addMarker(marker);
        var isSoe = (index === 0 || index === len - 1);
        isSoe && marker.hilite();
        (isSoe ? soeMarkers : pointerMarkers).push(marker);
        $(this).data("marker", marker).data("isSoe", isSoe);
    });
    //
    if (reData.r[0].m && reData.r[0].m.a && reData.r[0].m.b) {
        var level = parseInt(reData.r[0].m.b, 10);
        KMap.setCenter(reData.r[0].m.a, isNaN(level) ? 8 : level);
    }
    //dom
    var $checkBox = $contentDiv.find("input:checkbox");
    $tagAs.bind("click", function(){
        var marker = $(this).data("marker");
        var latlon = $(this).attr("ll");
        if (marker && latlon) {
            KMap.closeInfoWindow();
            KMap.setCenter(latlon);
            KMap.openInfoWindow(marker);
        }
    }).hover(function(){
        var marker = $(this).data("marker");
        var isSoe = $(this).data("isSoe");
        if (!marker) {
            return;
        }
        // 
        if (!isSoe && $checkBox.is(":checked") !== true && typeof marker.setOptions === "function") {
            marker.setOptions({
                hoverLabel: false
            });
        }
        marker.hilite();
    }, function(){
        var marker = $(this).data("marker");
        var isSoe = $(this).data("isSoe");
        if (!marker) {
            return;
        }
        // 
        if (!isSoe && $checkBox.is(":checked") !== true && typeof marker.setOptions === "function") {
            marker.setOptions({
                hoverLabel: true
            });
        }
        //KMap.closeInfoWindow();
    });
    //$checkBox
    $checkBox.bind("click", function(){
        if ($(this).is(":checked")) {
            $.each(pointerMarkers, function(index, marker){
                marker && marker.setOptions && marker.setOptions({
                    hoverLabel: false
                });
            });
        } else {
            $.each(pointerMarkers, function(index, marker){
                marker && marker.setOptions && marker.setOptions({
                    hoverLabel: true
                });
            });
            $.each(soeMarkers, function(index, marker){
                marker && marker.hilite && marker.hilite();
            });
        }
    });
    //""
    var $reLink = $contentDiv.children("div:eq(0)").children("div:eq(1)").find("a").eq("0");
    $reLink.bind("click", function(event){
        event.preventDefault();
        var lineUrlHash = new KUrlHash();
        var wh = _this._getMapWH();
        lineUrlHash.setKey("w", wh.w + "");
        lineUrlHash.setKey("h", wh.h + "");
        lineUrlHash.setKey("ss", "true");
        lineUrlHash.setKey("c", city);
        lineUrlHash.setKey("t", "bsr");
        lineUrlHash.setKey("rn", reData.r[0].rn);
        lineUrlHash.setKey("o", reData.r[0].o);
        var lineUrlHead = _this.options().lineurl;
        var qMark = lineUrlHead.indexOf("?");
        lineUrlHead = qMark > -1 ? lineUrlHead.substring(0, qMark + 1) : lineUrlHead + "?";
        
        $.ajax({
            type: "GET",
            url: (lineUrlHead + lineUrlHash.toString()),
            success: function(reData){
                if (!reData || !reData.r) {
                    return KTools.showMsg("");
                }
                _this._currentItem.data = reData;
                _this._busLineDataHandler(reData, city);
            },
            error: function(){
                KTools.showMsg("");
            },
            dataType: "json"
        });
    });
    //
    var description = [$contentDiv.find("h3").text(), "(" + $contentDiv.find("h4").text() + ")"];
    var feedBackName = description.join("");
    $contentDiv.children("div:eq(0)").children("div:eq(3)").find("p").each(function(){
        description.push($(this).text());
    });
    _this._description = reData.r[0].mv || description.join("");
    _this._sendkey = reData.r[0].mk || '';

    //
//    var wyBlDom = ''
//    $contentDiv.children("div:eq(0)").children("div:eq(3)").find("p").last().after(wyBlDom)
    
    //""
    $contentDiv.find("a[mfg='lsms']").bind("click", function(){
        _this.send(KSendType.sms, KSendType.sms);
    });
    //""
    $contentDiv.find("a[mfg='lmail']").bind("click", function(){
        _this.send(KSendType.email, KSendType.email);
    });
    //""
    $contentDiv.find("a[mfg='lcp']").bind("click", function(){
    });
    //""
    $contentDiv.find("a[mfg='lprt']").bind("click", function(){
        _this.print();
    });
    //""
    $contentDiv.find("a[mfg='lerr']").bind("click", function(){//

        var fbinfo = KTools.copyOptions({}, KFeedbackInfo);
        fbinfo.type = KFeedbackType.ROUTE_ERROR;
        fbinfo.url = location.href + "&n=" + _this.selectedResult();
        var krinfo = KTools.copyOptions({}, KRouteInfo);
        krinfo.name = feedBackName;
        krinfo.type = KRouteType.BUS;
        krinfo.queryopts = KTools.copyOptions({}, _this._queryopts);
        krinfo.resultnum = _this._currentItem.index;
        KEvent.trigger(_this, "feedback", _this, fbinfo, krinfo);
    });
};
/**
 *
 * @param item
 *            {KTabItem}
 * @returns
 */
KBusearch.prototype._bindCheckBox = function(item){
    var _this = this;
    if (!item || !item.data) {
        return;
    }
    // r[0].s
    var data = item.data.r[0].s;
    var group = _this.flag() + "_search_s_all";
    var clickFunc = function(){
        !$(this).attr("checked") ? KMap.clear(group) : $.each(data, function(index){
            var newMarker = _this._createPointMarker(data[index], group, item.data.r[0].b, true);
            // _bs_resultNum JSONarray index
            newMarker._bs_resultNum = index;
            KMap.addMarker(newMarker);
        });
    };
    $("input:checkbox", item.contentDom).attr("checked", false).unbind("click").bind("click", clickFunc);
    
};
/**
 *
 * @param markerData
 *            {Object} n, t, h, l
 * @param urlHead
 *            {String}
 * @returns
 */
KBusearch.prototype._createPointMarker = function(markerData, group, urlHead, isWalk){
    var _this = this;
    // 
    var name = (isWalk === true) ? markerData.n : markerData.sn;
    var latlon = (isWalk === true) ? markerData.l : markerData.sl;
    var markerOpts = KConfig.get("mk_mo_s", {
        n: name,
        t: markerData.t
    });
    var fValue = markerData.f;
    // group
    markerOpts.group = group;
    // ""
    markerOpts.infowin = KConfig.get("iw_iwo_st", {
        "v": "none",
        "nb": "none",
        "fs": "none",
        "err": "none",
        "c": (fValue === "" && markerData.r) ? ("" + markerData.r) : "",
        "d": (fValue === "" && markerData.combo) ? ("" + markerData.combo.split(",").join(" ")) : ""
    });
    markerOpts.infowin.cmarea = false;
    markerOpts.hoverLabel = true;
    // snapText
    if (name) {
        markerOpts.label && (markerOpts.label.snapText = name);
    } else {
        markerOpts.label = null;
    }
    //
    var title = name;
    if (fValue === "" || fValue === "") {
        title = "<a href='" + (urlHead + (markerData.h || markerData.szn)) + "' target='_blank' class='" +
        this._POI_TITLE_CLASSNAME +
        "'>" +
        name +
        "</a>" +
        fValue;
    }
    // title
    markerOpts.infowin.title = title;
    // commonData
    markerOpts.infowin.cmdata = {
        poi: KTools.copyOptions({
            type: KQueryType.busearch,
            name: name,
            city: _this._queryopts.city,
            latlon: latlon
        }, KPOInfo)
    };
    return new KMarker(latlon, markerOpts);
};
KBusearch.prototype._parseToLines = function(arrPts, arrLevels, optFlag, group){
    var lines = [];
    if (!(arrPts instanceof Array) || !(arrLevels instanceof Array) || !arrPts.length || !arrLevels.length) {
        return lines;
    }
    var len = arrPts.length, lineOpts;
    for (var index = 0; index < len; index++) {
        lineOpts = KConfig.get(optFlag);
        lineOpts.group = group;
        lineOpts.overlap = !KTools.isIE6;
        lines.push(KLine.fromEncoded(arrPts[index], arrLevels[index], lineOpts));
    }
    return lines;
};
/**
 * @param item
 *            {KTabs} KAccordionKTabs
 */
KBusearch.prototype._bindLi = function(item){
    var _this = this;
    if (!item || !item.data || !item.data.r[0] || !item.data.r[0].j) {
        return;
    }
    //
    var itemUrlHash = KUrlHash.parseByHash($(item.tabDom).data("urlhash"));
    //var parentTabsIndex = $(item.tabDom).data("parent_tabs_index");
    var firtItemData = item.data.r[0];
    var lis = $("li", item.contentDom.children("ol"));
    var lisLen = lis.length;
    var lisData = firtItemData.j;
    var memId = firtItemData.mid;
    var flag = this.flag();
    //
    var btns = $(".mwp_ns_sdc",lis);
    btns.unbind().bind("click", function(e){
    	e.preventDefault();
        e.stopPropagation();
        var walkspan = $(this).next("div");
        walkspan.is(':visible') ? walkspan.hide() : walkspan.show();
        $(this).removeClass().addClass(walkspan.is(':visible') ? 'mwp_ns_sdo' : 'mwp_ns_sdc').html('<span></span>' + (walkspan.is(':visible') ? '' : ''));;
    });
    //
    var ps = $(">p", item.contentDom);
    var hiLi = _this.options().theme + KBusearch.conf.CLASSNAME.LH;
    var hiP = _this.options().theme + KBusearch.conf.CLASSNAME.TH;
    var mouseEnterHandler = function(){
        ps.removeClass(hiP);
        lis.removeClass(hiLi);
        $(this).addClass($(this).is("li") ? hiLi : hiP);
    }
    ps.unbind("mouseenter").bind("mouseenter", mouseEnterHandler);
    lis.unbind("mouseenter").bind("mouseenter", mouseEnterHandler);
    //
    var openMarkerWin = function(event){
        event.stopPropagation();
        // marker
        var marker = $(this).parent().data("marker");
        if (marker) {
            marker.hilite();
            KMap.closeInfoWindow();
            KMap.setCenter(marker.latlon(), 15);
            KMap.openInfoWindow(marker);
        }
    }
    //
    this._clearAllOverlay("trans");
    lis.each(function(index, li){
        var liData = lisData[index], lines;
        
        var subwayToOthers,subwayGateLine
        // liData.t:"s"=> , "b"=>
        if (!liData.szn) {
            // 
            if (liData.pt && liData.lv) {
				//added by zy,
//				var subwayToOthersArray = liData.pt.slice(0,1);;
//				var subwayGateLineArray = liData.pt.slice(1);
                lines = _this._parseToLines(liData.pt, liData.lv, "ln_lo_wk", flag + "_search_l_w");
//                subwayToOthers = _this._parseToLines(subwayToOthersArray, liData.lv, "ln_lo_wk", flag + "_search_l_w");
//                subwayGateLine = _this._parseToLines(subwayGateLineArray, liData.lv, "ln_lo_subWalk", flag + "_search_l_w");
                if (lines.length) {
                   KMap.addLines(lines, false);
//                   KMap.addLines(subwayToOthers, false);
//                   KMap.addLines(subwayGateLine, false);
                   $(this).data("walkline", lines);
                }
            }
            //   marker
            if (liData.l && liData.n && index < lisLen - 1) {
                var marker = _this._createPointMarker(liData, flag + "_search_s", firtItemData.b, true);
                KMap.addMarker(marker);
                $(this).data("marker", marker);
            }
        } else {
            // 
            if (liData.lv && liData.pt) {
                lines = _this._parseToLines(liData.pt, liData.lv, "ln_lo_bss", flag + "_search_l");
                if (lines.length) {
                    KMap.addLines(lines, false);
                    $(this).data("line", lines);
                }
            }
            //   marker
            if (liData.sl && liData.sn && index < lisLen - 1) {
                var marker = _this._createPointMarker(liData, flag + "_search_s", firtItemData.b, false);
                KMap.addMarker(marker);
                $(this).data("marker", marker);
            }
        }
    }).unbind("click").bind("click", function(){
        // 
        var lines = $(this).data("line") || $(this).data("walkline");
        if (lines && lines.length) {
            var begin = lines[0].latlons("begin");
            var end = lines[lines.length - 1].latlons("end");
            KMap.fitzoom([begin, end]);
            // liKLine
//            lines[0].hilite();
//            _this._hLine = lines[0];
            
            
            $.each(lines, function(lineIndex, line){
            	line.hilite();
            });
            /*$.each(lines, function(lineIndex, line){
			//added by zy,
            	//lineIndex == 0 && line.hilite();
            });*/
            // KLine
            $(this).siblings().each(function(){
                var sibLines = $(this).data("line") || $(this).data("walkline");
                if (sibLines && sibLines.length) {
                    $.each(sibLines, function(sibIndex, sibLine){
                    	sibLine.resume();
                    });
                }
            });
        }
        //}).unbind("mouseover").bind("mouseover", function() {// li
        //	var className = _this.options().theme + KBusearch.conf.CLASSNAME.LH;
        //	$(this).addClass(className).siblings("." + className).removeClass(className);
    }).find("a[class!=mwp_ns_sdc]").unbind("click").bind("click", function(event){// 
        // 
        event.stopPropagation();
        event.preventDefault();
        //
        var index = lis.index($(this).parent());
        var liData = lisData[index];
        var cs = liData.cs || "";
        var comRoute = $(this).text();
        var defaultRoute = liData.n;
        var urlHash = itemUrlHash.clone();
//        var comboRoute = [];
//        lis.each(function(liIndex){
//            if ($(this).data("line") && $(this).find("a").length) {
//                if (index === liIndex) {
//                    comboRoute.push((lisData[index].cs || "") + "," + comRoute);
//                } else {
//                    comboRoute.push((lisData[liIndex].cs || "") + "," + $(this).find("strong").text());
//                }
//            }
//        });
        var crValue = _this._getMergeLines(lisData,index,comRoute).join(':');
//        comboRoute.join("|");
        _this._queryopts.preferredBusline = crValue;
        urlHash.setKey("cr", crValue);
        urlHash.setKey("mid", memId);
        urlHash.setKey("t", "btc");
		//added by zy,btcajaxnm
        var _lisearch = false;
        if(_this._busTabTitle==="subway"&&_this._busTab1Checked===true){
        	_lisearch = true;
		}
		if(_this._busTabTitle==="nonstop"&&_this._busTab2Checked===true){
			_lisearch = true;
		}
		if(_this._busTabTitle==="shortWalk"&&_this._busTab3Checked===true){
			_lisearch = true;
		}
		 
        _this._nm && urlHash.setKey("nm", _lisearch);
        var urlHead = _this.options().busurl;
        var qMark = urlHead.indexOf("?");
        urlHead = qMark > -1 ? urlHead.substring(0, qMark + 1) : urlHead + "?";
       
        $.ajax({
            type: "GET",
            url: urlHead + urlHash.toString(),
            success: function(data){
                if (!data || !data.r) {
                    return KTools.showMsg("");
                }
                item.data = data;
                var html = /^<h3[^\>]+>(.+)<\/h3><div[^\>]+>(.+)<\/div>$/i.exec(data.r[0].h);
                $(item.tabDom).empty().html(html[1]);
                $(item.contentDom).empty().html(html[2]);
                //
                if (data.r[0] && data.r[0].j) {
                    $(item.tabDom).data("hoverlines", _this._getHoverLines(data.r[0].j));
                }
                // _this.busSearchAc[parentTabsIndex].select(item.index, true);
                _this._bindLi.apply(_this, [item, false]);
                _this._bindCheckBox.apply(_this, [item, false]);
                _this._busCo2Click(item);
                _this._currentItem && (_this._currentItem.crValue = crValue);
            },
            error: function(){
                KTools.showMsg("");
            },
            dataType: "json"
        });
    }).end().find("em").unbind("click").bind("click", openMarkerWin);
    // 
    _this._description = firtItemData.mv || _this._simplizeText($(item.contentDom).find("ol").text());
    _this._sendkey = firtItemData.mk || '';
    // 
    firtItemData.m && KMap.setCenter(firtItemData.m.a, parseInt(firtItemData.m.b));
    //  ### added by zwq 
    _this.sMarker = _this._createSoeMarkerForTrans(item.data, "s");
	_this.eMarker = _this._createSoeMarkerForTrans(item.data, "e");
//	_updateLabelContent(_this.sMarker,);
//	_updateLabelContent(_this.eMarker,);
    // added by zwq 
    _this.markerBak = item.data;
    //added by zwq 
    _this.sMarker.setEditable(true);
    _this.eMarker.setEditable(true);
    _this.dragmarkerFlag = true;
    KEvent.bind(_this.sMarker, "dragend", _this._draged, {marker: _this.sMarker, type : 's'}, this);
    KEvent.bind(_this.eMarker, "dragend", _this._draged, {marker: _this.eMarker, type : 'e'}, this);
    KMap.addMarkers([_this.sMarker, _this.eMarker], false);
    lis.eq(lisLen - 1).data("marker", _this.eMarker);
    ps.eq(0).data("marker", _this.sMarker).end().eq(1).data("marker", _this.eMarker).end().find("strong").unbind("click").bind("click", openMarkerWin)
    _this.sMarker.hilite();
    _this.eMarker.hilite();
};

/*
*
 */
KBusearch.prototype._getMergeLines = function(liData,index,mergeName){
    var lines = [];
    if(liData instanceof Array && liData.length > 0){
        for(var i = 0; i < liData.length; i++){
            if(liData[i].f == '' && index != i){
                lines.push(liData[i].n);
            }else if(liData[i].f == ''){
                lines.push(mergeName);
            }
        }
    }
    return lines;
};


/**
 * 
 */
KBusearch.prototype._dragStart = function(e, o, p)
{
};
/**
 * 
 * @param e KEventInfo
 * @param o KOverlay KMarkerKLine
 * @param p MPoint
 */
KBusearch.prototype._draging = function(e, o, p)
{
};
/**
 * 
 * @param e KEventInfo
 * @param o KOverlay KMarkerKLine
 * @param p MPoint
 */
KBusearch.prototype._draged = function(e, o, p)
{
	var _this = this;
	var startBySelf = "";
	var endBySelf = "";

    _this.dragmarkerFlag = false;
    if(!_this._queryopts){
        _this._queryopts = _this.optsBak;
    }
    var type = e.data.type;

    KMap.getGeo(p.getPid(),function(city,name){
        if(type == "s"){
            if(_this._queryopts && _this._queryopts.busorig){
                _this._queryopts.busorig.city = city || '';
                _this._queryopts.busorig.name = name || startBySelf;
                _this._queryopts.busorig.latlon = p.getPid();
            }
            _this._updateLabelContent(e.data.marker,name || startBySelf);
        }
        if(type == "e"){
            if(_this._queryopts && _this._queryopts.busdest){
                _this._queryopts.busdest.city = city || '';
                _this._queryopts.busdest.name = name || endBySelf;
                _this._queryopts.busdest.latlon = p.getPid();
            }
            _this._updateLabelContent(e.data.marker,name || endBySelf);
        }
        //
        e.data.marker.setLatlon(p.getPid());
        if(_this._queryopts && _this._queryopts.busorig && _this._queryopts.busdest){

            if (_this._queryopts.busorig.latlon && _this._queryopts.busdest.latlon) {
                _this._clearBusSearchAc();
                _this.query(_this._queryopts);
            } else {
                _this._queryByStationList(_this._queryopts);
            }

        }

    });
};

KBusearch.prototype._updateLabelContent = function(marker, content) {
    if(!marker || !marker.labelDom) return ;
    var labelDom = marker.labelDom();
	if (!content) {
		content = "";
	}
	$("[mfg='lbl']", labelDom).eq(0).html(content);
};

/**
 * 
 * @param type
 * @param latlon
 * @param name
 * @param city
 * @uncrunch
 */
KBusearch.prototype.menuaddMarker = function(type,latlon,name,city){
	var _this = this ;
	var labelvalue = name || "";
	var markerOpts = KConfig.get("mk_mo_sdt", {
	    n: name,
	    t: type
	});
	markerOpts.group = this.flag()+"_search_s";
	markerOpts.label.label = '<div class="mwpg_std_sl" mfg="lbl">'+labelvalue+'</div>';
	if(type === "s"){
        //bussResultKBusearch._objKStationList._queryopts
        if(!$(_this._transferDom).is(":hidden")){
            _this._objKStationList._dragEndMarker({data:'s'},null,new MPoint(latlon),name);
        }else{
            _this.sMarker && KMap.removeMarker(_this.sMarker);
            _this.sMarker = new KMarker(latlon, markerOpts);
            _this.sMarker.city = city;
            _this.sMarker.name = name;
            KMap.addMarker(_this.sMarker,false,false);
            _this.sMarker.setEditable(true);
            KEvent.bind(_this.sMarker, "dragend", _this._draged, {marker: _this.sMarker, type : 's'}, _this);
        }
	}else{
        if(!$(_this._transferDom).is(":hidden")){
            _this._objKStationList._dragEndMarker({data:'e'},null,new MPoint(latlon),name);
        }else{
            _this.eMarker && KMap.removeMarker(_this.eMarker);
            _this.eMarker = new KMarker(latlon, markerOpts);
            _this.eMarker.city = city;
            _this.eMarker.name = name;
            KMap.addMarker(_this.eMarker,false,false);
            _this.eMarker.setEditable(true);
            KEvent.bind(_this.eMarker, "dragend", _this._draged, {marker: _this.eMarker, type : 'e'}, _this);
        }
	}
	if(_this.sMarker && _this.sMarker._opts && _this.eMarker && _this.eMarker._opts){
		if(type === "s"){
			_this.menuMarkerType = "start"
		}else{
			_this.menuMarkerType = "end"
		}
		_this.menuQuery(_this.sMarker,_this.eMarker,city);

	}
};

/**
 * 
 *
 * @param spoint
 *            KMarker marker
 * @param epoint
 *            KMarker marker
 * @returns
 */
KBusearch.prototype.menuQuery = function(spoint,epoint,menuCity)
{
	var _this = this;
	var poiname = "";
	var opts = KTools.copyOptions({}, KQueryOptions);
	opts.type = "bs" ;
	opts.busorig = {
        latlon: spoint._point.pid,
        pid: spoint._point.pid,
        name:spoint.name || (_this._queryopts && _this._queryopts.busorig && _this._queryopts.busorig.name) || poiname,
        city:spoint.city || (_this._queryopts && _this._queryopts.busorig && _this._queryopts.busorig.city) || menuCity
    };
	opts.busdest = {
        latlon: epoint._point.pid,
        pid: epoint._point.pid,
        name:epoint.name || (_this._queryopts && _this._queryopts.busdest && _this._queryopts.busdest.name) || poiname,
        city:epoint.city || (_this._queryopts && _this._queryopts.busdest && _this._queryopts.busdest.city) || menuCity
    };
    _this.menuMarkerType = undefined;
	opts.tt = (_this._queryopts && _this._queryopts.tt) || "subway";
	opts.city = menuCity;
    _this._clearBusSearchAc();
	_this.query(opts);
};

/**
/**
 * 
 *
 * @param data
 *            {Object} 
 * @param startOrEnd
 *            {String} "s" or "e"
 * @returns {KMarker}
 */


KBusearch.prototype._createSoeMarkerForTrans = function(data, startOrEnd){
    var name = (startOrEnd === "s") ? data.on : data.dn;

    // marker
    var markerOpts = KConfig.get("mk_mo_sdt", {
        n: name,
        t: startOrEnd
    });
    // group
    markerOpts.group = this.flag() + "_search_s";
    // InfoWindow""
    var hcode = (startOrEnd === "s") ? data.oh : data.dh, isStation = false, sArr = data.r[0].s;
    if (sArr && sArr.length) {
        for (var iSArr = 0; iSArr < sArr.length; iSArr++) {
            if (sArr[iSArr].h && sArr[iSArr].h === hcode) {
                isStation = true;
                break;
            }
        }
    }
    var poInfo = this._queryopts[startOrEnd === "s" ? "busorig" : "busdest"];
    if (!isStation && poInfo.type) {
        var t = parseInt(poInfo.type, 10);
        if (t === KPOIType.BUSTATION) {
            isStation = true;
        }
    }
    var poi = (startOrEnd === "s") ? data.oPoi : data.dPoi;
    if (!poi.c) {
        markerOpts.infowin = KConfig.get("iw_iwo_st", {
            v: "none",
            cd: "none",
            fs: "none"
        });
        markerOpts.infowin.title = name;
    } else {
        markerOpts.infowin = KConfig.get("iw_iwo_st", isStation ? {
            h: poi.c,
            cd: "none",
            fs: "none"
        } : {
            v: "none",
            fs: "none",
            c: poi.b,
            d: poi.a
        });
        markerOpts.infowin.title = isStation ? name : ("<a href='" + poi.c + "' target='_blank' class='" +
        this._POI_TITLE_CLASSNAME +
        "'>" +
        name +
        "</a>");
    }
    var latlon = (startOrEnd === "s") ? data.ol : data.dl;
    markerOpts.infowin.cmarea = false;
    markerOpts.infowin.cmdata = {
        poi: KTools.copyOptions({
            type: KQueryType.busearch,
            name: name,
            city: this._queryopts.city,
            latlon: latlon
        }, KPOInfo)
    };
    // snapText
    markerOpts.label && (markerOpts.label.snapText = name);
    //
    return new KMarker(latlon, markerOpts);
};
KBusearch.prototype._layoutDom = function(){
    var parseToNumber = function(str){
        var num = parseInt(str, 10);
        return isNaN(num) ? 0 : (num < 0 ? 0 : num);
    };
    var aheight = parseToNumber(this._$dom.css("height")) || this._$dom.height();
    var awidth = parseToNumber(this._$dom.css("width")) || this._$dom.width();
    this._transferDom.css({
        height: aheight - parseToNumber(this._transferDom.css("padding-top"))
    });
    this._busSearchDom.height(aheight - parseToNumber(this._busSearchDom.css("padding-top")));
    this._busLineDom.height(aheight - parseToNumber(this._busLineDom.css("padding-top")));
    this._busLineDom.width(awidth);
    this._busStationDom.height(aheight - parseToNumber(this._busStationDom.css("padding-top")));
    this._busStationDom.width(awidth);
    this._objKStationList && this._objKStationList.layout();
    this._objKStdTabs && this._objKStdTabs.layout();
    this._layoutLineOrStation(this._busLineDom);
    this._layoutLineOrStation(this._busStationDom);
};
/**
 * 
 *
 * @return {Object}
 */
KBusearch.prototype._getMapWH = function(){
    var mapc = $(this.options().mapcontainer);
    return {
        w: mapc.width(),
        h: mapc.height()
    };
};
KBusearch.prototype._updateCo2ShowDom = function(item){
    var date_e = item.data.r[0]["e"];
    this._busCo2ShowDistance.empty().html(item.data.r[0]["d"]);
    $(">strong", $(">li[mfg='bscebk']", this._busCo2ShowUI)).empty().html(date_e.a);
    $(">strong", $(">li[mfg='bscmoto']", this._busCo2ShowUI)).empty().html(date_e.b);
    $(">strong", $(">li[mfg='bsctram']", this._busCo2ShowUI)).empty().html(date_e.c);
    $(">strong", $(">li[mfg='bscbus']", this._busCo2ShowUI)).empty().html(date_e.d);
    $(">strong", $(">li[mfg='bscsbw']", this._busCo2ShowUI)).empty().html(date_e.e);
    $(">strong", $(">li[mfg='bsccar']", this._busCo2ShowUI)).empty().html(date_e.f);
    $(">strong", $(">li[mfg='bsccoach']", this._busCo2ShowUI)).empty().html(date_e.g);
    $(">strong", $(">li[mfg='bsctrain']", this._busCo2ShowUI)).empty().html(date_e.h);
    $(">strong", $(">li[mfg='bscplain']", this._busCo2ShowUI)).empty().html(date_e.i);
};
KBusearch.prototype._getKNamedValue = function(name, kvalue){
    var knamedvalue = KTools.copyOptions({}, KNamedValue);
    knamedvalue.name = name;
    knamedvalue.kvalue = kvalue;
    return knamedvalue;
};
/**
 * 
 */
KBusearch.prototype._bindMapEvents = function(){
    var _this = this;
    if (!_this._opts || !(KMap.isInitialized(_this._opts.mapcontainer) || KMap.isInitialized())) {
        window.setTimeout(function(){
            KBusearch.prototype._bindMapEvents.apply(_this);
        }, 200);
        return;
    }
    KEvent.bind(KMap, "afteropeninfowindow", function(event, map, theMarker){
        if (theMarker instanceof KMarker && typeof theMarker.group === "function") {
            if (theMarker._bs_bind_iwin_open === true) {
                return;
            }
            var infoDom = theMarker.iwcDom();
            if (!infoDom) {
                return;
            }
            var curGroup = theMarker.group();
            var curFlag = _this.flag();
            var groups = ["_station2", "_station1", "_search_s", "_search_l", "_search_l_w", "_search_s_all", "_line", "_line_s", "_line_e"];
            var isOwern = false;
            $.each(groups, function(i, val){
                if (curGroup === curFlag + val) {
                    // return false $.each
                    return !(isOwern = true);
                }
            });
            if (!isOwern) {
                return;
            }
            var latlon = "", name = "";
            try {
                latlon = theMarker.latlon().getPid();
            } catch (ex) {
            }
            try {
                name = $(theMarker.labelDom()).text();
            } catch (ex) {
            }
            if (latlon === "" && name === "") {
                return;
            }
            var fbinfo = {
                "type": KFeedbackType.POI_ERROR,
                "poinfo": {
                    "name": name,
                    "latlon": latlon
                },
                "url": location.href + "&n=" + _this.selectedResult()
            };
            // 
            if (fbinfo) {
                $("a[mfg='err']", infoDom).eq(0).bind("click", function(){
                    KEvent.trigger(_this, "feedback", _this, fbinfo);
                });
            }
            // 
            var $fs = $("a[mfg='fs']", infoDom).eq(0);
            if ($fs && $fs.length) {
                $fs.hide();
            }
            //
            //
            var $nbTopDiv = $("div[mfg='nb']", infoDom).eq(0);
            if ($nbTopDiv && $nbTopDiv.length) {
                var opts = KTools.copyOptions({
                    type: KQueryType.localsearch
                }, KQueryOptions);
                var poi;
                try {
                    poi = theMarker.options().infowin.cmdata.poi;
                } catch (ex) {
                    //$nbTopDiv.hide();
                    return;
                }
                opts.center = $.extend(true, {}, poi);
                opts.ls = KTools.copyOptions({
                    city: opts.center.city
                }, KPOInfo);
                var handler = function(evt){
                    evt.preventDefault();
                    var keyword = "";
                    if (evt.type === "submit") {// the form

                        var $input = $(this).find(":text");
                        keyword = $.trim($input.val());
                        if (!keyword) {//if no keyword, show message

                            KTools.showMsg('<div style="padding:5px 10px 5px 10px;font-size:13px;"></div>', {
                                title: "",
                                lightbox: true,
                                closedcbk: function(){
                                    $input.focus();
                                },
                                buboptions: {
                                    outside: false,
                                    closebtn: true
                                }
                            });
                            return;
                        }
                    } else {// the <a/> element

                        keyword = $(this).text();
                    }
                    var queryOpts = $.extend(true, {}, opts);
                    queryOpts.ls.name = keyword;
                    KEvent.trigger(_this, "nbsearch", _this, queryOpts);
                };
                //
                $("form", $nbTopDiv).unbind("submit").bind("submit", handler);
                $("a", $nbTopDiv).unbind("click").bind("click", handler);
            }
            //
            theMarker._bs_bind_iwin_open = true;
        }
    });
};
/**
 *
 * @param str
 *            String
 * @return String
 */
KBusearch.prototype._simplizeText = function(str){
    return (typeof str !== "string") ? "" : (str.replace("", "").replace(//g, "").replace(/([^()]+)/g, "$1"));
};
/**
 * 
 *
 * @param str
 *            String
 * @return String
 */
KBusearch.prototype._deleteForSMS = function(str){
//    return typeof str !== "string" ? "" : str.replace(/|||/g, "");
	return str;
};
/**
 * KStationListOptionsautoselect 
 *
 * @param {Boolean}
 *            isAuto
 */
KBusearch.prototype._setAutoSelectOpts = function(isAuto){
    isAuto = !!isAuto;
    if (this._opts.slopts) {
        this._opts.slopts.autoselect = isAuto;
        this._objKStationList.setOptions(this._opts.slopts);
    }
};
/**
 * 
 * @param type {String} trans, "busline","bustation", "all"
 * @returns
 */
KBusearch.prototype._clearAllOverlay = function(type){
	if(this._hLine){
		this._hLine.resume();
		this._hLine = undefined;
	}
    var flag = this.flag();
    var types = {
        trans: "_search_s,_search_l,_search_l_w,_search_s_all,_hoverlines",
        busline: "_line,_line_s,_line_e",
        bustation: "_station1,_station2"
    };
    types.all = types.trans + "," + types.busline + "," + types.bustation;
    var groups = (types[type || "all"] || types.all).split(",");
    $.each(groups, function(index, value){
        KMap.clear(flag + value);
    });
};
/**
 *
 * @param theme
 * @returns
 */
KBusearch.prototype._initCssName = function(theme){
    var initCss = {};
    for (var i in KBusearch.conf.CLASSNAME) {
        initCss[i] = theme + KBusearch.conf.CLASSNAME[i];
    }
    return initCss;
};
KBusearch.prototype._layoutLineOrStation = function($dom){
    if (!$dom || !$dom.children) {
        return;
    }
    var $kids = $dom.children("div");
    var $head = $kids.eq(0), $cont = $kids.eq(1);
    if (!$head || !$head.length) {
        return;
    }
    var domH = parseInt($dom.css("height"), 10);
    //var domW = $dom.width();
    var headH = $head.outerHeight(true);
    if ($cont && $cont.length) {
        var cExtraH = $cont.outerHeight(true) - $cont.height();
        //var cExtraW = $cont.outerWidth(true) - $cont.width();
        var contH = domH - headH;
        //var contW = domW - cExtraW;
        $cont.css({
            height: contH//,
            //width : contW
        });
    }
};
/***
 *
 * @param arrJ {Array}
 * @returns {Object}
 */
KBusearch.prototype._getHoverLines = function(arrJ){
    var lines = {
        pt: [],
        lv: []
    };
    for (var i = 0; i < arrJ.length; i++) {
        if (arrJ[i] && arrJ[i].pt && arrJ[i].lv) {
            lines.pt = lines.pt.concat(arrJ[i].pt);
            lines.lv = lines.lv.concat(arrJ[i].lv);
        }
    }
    return lines;
};

/**
 * added by zwq
 * 
 * */
KBusearch.prototype._checkBusCboxChecked = function(){
	_this = this;
	if(_this._busTabTitle==="subway"&&_this._busTab1Checked===false){
		if(_this._innerFlag){
			$("#sopt").attr('checked',false);
		}else{
			$('[name=sopt]:checkbox').attr('checked',false);
			_this._innerFlag = true;
		}
	}else if(_this._busTabTitle==="subway"&&_this._busTab1Checked===true){
		//""removeAtrr
		if(!$("#sopt").attr('checked')&&_this._innerFlag){
			$("#sopt").attr('checked',true);
		}
		_this._innerFlag = true;
	}
	if(_this._busTabTitle==="nonstop"&&_this._busTab2Checked===false){
		if(_this._innerFlag){
			$("#sopt").attr('checked',false);
		}else{
			$('[name=sopt]:checkbox').attr('checked',false);
			_this._innerFlag = true;
		}
	}else if(_this._busTabTitle==="nonstop"&&_this._busTab2Checked===true){
		if(!$("#sopt").attr('checked')&&_this._innerFlag){
			$("#sopt").attr('checked',true);
		}
		_this._innerFlag = true;
	}
	if(_this._busTabTitle==="shortWalk"&&_this._busTab3Checked===false){
		if(_this._innerFlag){
			$("#sopt").attr('checked',false);
		}else{
			$('[name=sopt]:checkbox').attr('checked',false);
			_this._innerFlag = true;
		}
	}else if(_this._busTabTitle==="shortWalk"&&_this._busTab3Checked===true){
		if(!$("#sopt").attr('checked')&&_this._innerFlag){
			$("#sopt").attr('checked',true);
		}
		_this._innerFlag = true;
	}
};

/**
 * 
 * @param type
 * @returns {{s: *, e: *}}
 * @uncrunch
 */
KBusearch.prototype.getStartAndEnd = function(type){

    var t = {};
    if(this.sMarker){
        t.s = this.sMarker;
    }else if(this._queryopts && this._queryopts.busorig){
        t.s = this._queryopts.busorig;
    }else{
        t.s = null;
    }
    if(this.eMarker){
        t.e = this.eMarker;
    }else if(this._queryopts && this._queryopts.busdest){
        t.e = this._queryopts.busdest;
    }else{
        t.e = null;
    }
    return jQuery.extend(true, {}, t);
};

/**
 * 
 * @uncrunch
 */
KBusearch.prototype.removeStartAndEnd = function (){
    if(this.sMarker){
        this.sMarker = null;
    }
    if(this._queryopts && this._queryopts.busorig){
        this._queryopts.busorig = null;
    }
    if(this.eMarker){
        this.eMarker = null;
    }
    if(this._queryopts && this._queryopts.busdest){
        this._queryopts.busdest = null;
    }
};

/*
 
 xionggq  fuyg zhangwq
 2.0.0
 2010-02-22
 2010-02-30 15:14
 ============================================
 
 bug# 100707051826
 finalizeDOMbug
 opt#1011171805
 theme
 opt#1011261147

opt#1011301027
onehot(KCityList)
opt#1012011324

bug#1012021557
IE7
opt# 1012301047
(IEdomreadybody)
//bug#1012301514

 */
var KCityList = KClass.create("KCityList", KCity);

KCityList.conf =
{
    CLASSNAME :
    {
        //div
        CYL : "_cyl"
        //	span
        ,I : "_cyl_i"
        //
        ,M : "_cyl_m"
        //.
        ,CLE : "_cyl_cle"
        //div
        ,H : "_cyl_g_h"
    }
};

/**
 * 
 * @param container
 * @param opts
 */
KCityList.initialize = function(container, opts)
{
	
    var _this = this;
    //added by fuyg, 
    _this._cityTempInfo={};
    //
    this._morecityFlag = false // 
    this._showClick = false;//
    this._opts = KTools.copyOptions(opts, KCityListOptions);
    this._oldTheme = this._opts.theme;
    this.setTheme(this.options().theme);
    this._city = this._opts.defcity;
    this._suggestList = null;
    this._hotCityTabs = null;
    this._suggestArray = [];
    this._initTab = false;
    this._domAll = $(container);
    this._dom = this._domAll.get(0);
    this._inputDom = $(">span input", this._domAll);
//    this._inputDom.focus(function()
//    {
//        $(this).select();
//    });
    this._inputDom.val(this._city.name);
    this._inputDom.keydown(function(e)
    {
        if (e.keyCode == 13)
        {
            _this._inputDom.blur();
            _this._inputDom.focus();
        }
    });
    this._aDom = $(">span a", this._domAll);
    this._aDom.attr("cl_mc", "xgq");
    $(">div", this._domAll).eq(0).hide();
    //opt# 1012301047 fix begin
    //delete by zhangsq
    /*var appendToBody = function($dom){
    	if($.browser.msie){
        	$(function(){
        		$dom.appendTo($("body"));
        	});
        }else{
        	$dom.appendTo($("body"));
        }
    };*/
    //delete by zhangsq
    /*this._hotCityDom = $(">div", this._domAll).eq(0).addClass(
			this.theme() + KCityList.conf.CLASSNAME.H).hide();*/
    //add by zhangsq
    this._hotCityDom = $(this.options().hcnode ? this.options().hcnode : $('>div', this._domAll).eq(0)).addClass(this.theme() + KCityList.conf.CLASSNAME.H).hide();
    
    (!this.options().hcnode) && this._hotCityDom.appendTo($('body'));
    //delete by zhangsq
    //appendToBody(this._hotCityDom);
    //opt# 1012301047 fix end
    //
    this._tabCloseDom = $(">span", _this._hotCityDom);
    this._moreCityDom = $(">a", this._tabCloseDom.prev());
    this._suggestDom = this._hotCityDom.next();

    this._cityliDom = null;
    this._moreCityliDom = null;

    this._updateThemeOptions();
    this._updateSugOptions();
    this._updateTabsOptions();
    this._updateCloseOptions();

    // 
    this._hotCityDom.click(function(e) {
        e.stopPropagation();
    });
    this._inputDom.focus(function(e) {
        e.stopPropagation();
        $(this).select();
        //_this._hotCityDom.hide();
        _this._closeTabs();
    });
    
    //added by zwq dom
    this._cityListType = this._opts.newcitylist;
    if(_this._cityListType){
    	var newListOutLine = "<div class='mwp_cyl_mc_n' style='min-width: 400px;min-height: 300px; width:424px;height:341px; z-index: 10000;'><h6></h6><a class='mwp_cyl_mcc_n' href='javascript:void(0);' title=''></a>";
    	var hotcity = '<div class="mwp_cyl_new" > <strong>'+
		   '<a href="javascript:void(0);" l="GTAURRVUJBGBJ" z="1" ib="0" en="beijing"></a>'+
		   '<a href="javascript:void(0);" l="HETCUFWVVHUEE" z="8" ib="1" en="beijing"></a>'+
		   '<a href="javascript:void(0);" l="IJSRVJXVIWCHC" z="8" ib="1" en="shanghai"></a>'+
		   '<a href="javascript:void(0);" l="IJJDGAXUABUIW" z="8" ib="1" en="guangzhou"></a>'+
		   '<a href="javascript:void(0);" l="ISSGSEVUAHSIH" z="9" ib="1" en="shenzhen"></a>'+
		   '<a href="javascript:void(0);" l="HAAUTSVTUJCFE" z="8" ib="1" en="chengdu"></a>'+
		   '<a href="javascript:void(0);" l="HFISFCXTWJRFB" z="8" ib="1" en="chongqing"></a>'+
		   '<a href="javascript:void(0);" l="HBWVHUXURIDUI" z="8" ib="1" en="xian"></a>'+
		   '<a href="javascript:void(0);" l="IEGEITWVGCVHF" z="8" ib="1" en="nanjing"></a>'+
		   '</strong></div>';
    	var newListInLine = "<input type='text' value=''><button type='button'></button><span></span><dl><dt><ul><li class='mwp_cyl_mcs_n'><a href='javascript:void(0);'></a></li><li><a href='javascript:void(0);'></a></li></ul></dt><dd></dd><dd class='mwp_cyl_district_n'></dd></dl></div>";
    	this._moreCityListDom = $(newListOutLine + hotcity + newListInLine).hide();
    }else{
    	this._moreCityListDom = $("<div class='mwp_cyl_mc' style='min-width: 400px;min-height: 300px; width:50\%;height:50\%; z-index: 10000;'><dl><dt><ul><li class='mwp_cyl_mcs'><a href='javascript:void(0);'></a></li><li><a href='javascript:void(0);'></a></li></ul><a class='mwp_cyl_mcc' href='javascript:void(0);' title=''></a></dt><dd></dd><dd class='mwp_cyl_district'></dd></dl></div>").hide();
    }
    this.options().mcnode ? this._moreCityListDom.appendTo(this.options().mcnode) : this._moreCityListDom.appendTo($('body'));
    //delete by zhangsq
    //appendToBody(this._moreCityListDom);
    this._moreCityDlDom = $(">dl>dd", this._moreCityListDom);
    var liDoms = $(">dl>dt>ul>li>a", this._moreCityListDom);
    liDoms.eq(0).click(function() {
        _this._changeMoreCity(0);
    });
    liDoms.eq(1).click(function() {
        _this._changeMoreCity(1);
    });
    
    if(_this._cityListType){
    	$(">a", this._moreCityListDom).eq(0).click(function() {
    		_this._hideMoreCity();
    	});
    
    }else{
    	$(">dl>dt>a", this._moreCityListDom).click(function() {
            _this._hideMoreCity();
        });
    }
    this._moreCityListDom.click(function(e) {
        e.stopPropagation();
    });
    this._moreCityDom.click(function(e) {
        e.stopPropagation();
         _this.showMoreCity();
    });
    this._inputDom.change(function() {
        if ($(this).val().replace(/(^\s*)|(\s*$)/g, '') == "")
        {
            $(this).val(_this._city.name);
        }
    });
    //
    $(window).bind("resize",function(){
    	if(_this._cityListType){
    		var $list = _this._moreCityListDom;
    		var divheight = $list.outerHeight();
			var divwidth = $list.outerWidth();
			var position = _this._inputDom.offset();
			var inh = _this._inputDom.outerHeight();
			var inw = _this._inputDom.outerWidth();
			var t = position.top + inh +4;
			var l = position.left - 5 ;
			$list.css( {
				top : t > 0 ? t : 0,
				left : l > 0 ? l : 0
			});
			if($.browser.msie){
				$list.css( {
					height:divheight,
					width:455,
					top : t > 0 ? t : 0,
					left : l > 0 ? l : 0
				});
			}
    	}
    	if(!_this._cityListType){
    		_this.layout();
    	}
    });
};
KCityList.prototype._changeMoreCity = function(num)
{
	
    var _this = this;
    //edit by zwq 
    var mcityCss = "mwp_cyl_mcs";
    if(_this._opts.newcitylist){
    	mcityCss = "mwp_cyl_mcs_n";
    }
    var morecity = _this._opts.mburl;
    if (morecity && (morecity.indexOf("?") != -1))
    {
        var indexnum = morecity.indexOf("?");
        morecity = morecity.substring(0, indexnum);
    }
    var liDoms = $(">dl>dt>ul>li", this._moreCityListDom);
    if (num == 0)
    {
        this._moreCityDlDom.eq(0).show();
        liDoms.eq(0).addClass(mcityCss);
        liDoms.eq(1).removeClass(mcityCss);
        _this._moreCityDlDom.eq(1).hide();
         _this._layoutMoreCity();
    }
    else
    {

        liDoms.eq(1).addClass(mcityCss);
        this._moreCityDlDom.eq(0).hide();
        liDoms.eq(0).removeClass(mcityCss);
        if (this._moreCityDlDom.eq(1).html() == "")
        {
           var mcurl = "?t=cl&s=html";
           if(_this._cityListType){
        	   mcurl += "&hh=true"
           }
           this._moreCityDlDom.eq(1).empty().load(morecity + mcurl, function() {
                _this._addClickMoreEvent($(this));
               //bug#1012301514 fix begin
               //edit by zhangsq
                if(liDoms.eq(1).attr('class') == mcityCss)
                {
                    _this._moreCityDlDom.eq(1).show();
                   _this._layoutMoreCity();
                }
               //bug#1012301514 fix end
            });
        }
        else
        {
           _this._moreCityDlDom.eq(1).show();
           this._layoutMoreCity();
        }
    }
};
/**
 * 
 * @return String 
 * @uncrunch
 */
KCityList.prototype.version = function()
{
    return "2.0.0";
};
/**
 * 
 * @uncrunch
 */
KCityList.prototype.finalize = function()
{
    var _this = this;
    var sugIndex=0;
    for (sugIndex = 0; sugIndex < _this._suggestArray.length; sugIndex++)
    {
    	if(_this._suggestArray[sugIndex]&&_this._suggestArray[sugIndex].finalize)
    	{
    		_this._suggestArray[sugIndex].finalize();
    	}
    }
    _this._suggestArray = null;
    this._city = null;
    if (this._cityliDom != null)
    {
        this._cityliDom.each(function() {
            KEvent.clear($(this));
        });
    }
    if (this._moreCityliDom != null)
    {
        this._moreCityliDom.each(function() {
            KEvent.clear($(this));
        });
    }
    KEvent.clear(_this._tabCloseDom);
    KEvent.clear(_this._moreCityDom);
    KEvent.clear(_this._aDom);
    this._moreCityListDom.remove();
    this._moreCityliDom = null;
    this._cityliDom = null;
    if(this._hotCityTabs){this._hotCityTabs.finalize();}
    if(this._hotCityDom){this._hotCityDom.remove();}
    KCity.prototype.finalize.call(this);

};
/**
 * 
 * @return String
 * @uncrunch
 */
KCityList.prototype.cnname = function()
{
    return "";
};

/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KCityList.prototype.dependent = function()
{
    return [ KCity, KCityListOptions, KClass, KEvent, KMsgBox, KObject, KSize, KStdSuggest, KStdTabs, KTools, KUrlHash, jQuery ];
};

/**
 * 
 * @param opt
 */
KCityList.prototype._setOptions = function(opt)
{
    var _this = this;
    //this._oldTheme = this._opts;
    var diffOpts = KTools.compareOptions(this._opts, opt);
    $.each(diffOpts, function(name, value) {
        switch (name)
        {
            case 'theme':
                _this._setOption({'theme':value});
                _this._updateThemeOptions();
                break;
            case 'sugurl':
                _this._setOption({'sugurl':value});
                _this._updateSugOptions();
                break;
            case 'citylist':
                _this._setOption({'citylist':value});
                _this._updateTabsOptions();
                break;
            case  'mburl':
                _this._setOption({'mburl':value});
                _this._updateTabsOptions();
                break;
            case  'suglimit':
                _this._setOption({'suglimit':value});
                _this._updateSugOptions();
                break;
            case 'closebtn':
                _this._setOption({'closebtn':value});
                _this._updateCloseOptions();
                break;
            case "autocomplete":
            	_this._setOption({'autocomplete':value});
            	_this._updateKStdSuggestOpts({'autocomplete':value});
            	break;
            default:
        }
    });
};
/**
 * 
 * @uncrunch
 */
KCityList.prototype.setTheme = function(scheme)
{
    var newTheme = {'theme': scheme};
    this._setOption(newTheme);
};
/**
 * 
 * @param opt
 * @uncrunch
 */
KCityList.prototype.setOptions = function(opt)
{
    this._setOptions(opt);
};
/**
 * 
 * @uncrunch
 */
KCityList.prototype.layout = function()
{
	var _this=this;
    var h = jQuery(window).height();
    var w = jQuery(window).width();
    var $dom = this._moreCityListDom;
    var t = (h - divheight) / 2 > 0 ? (h - divheight) / 2 : 0;
	var l = (w - divwidth) / 2 > 0 ? (w - divwidth) / 2 : 0;
	var divheight = $dom.outerHeight();
	var divwidth = $dom.outerWidth();
	var extraH = $dom.outerHeight() - divheight;
	var extraW = $dom.outerWidth() - divwidth;
	extraH = extraH > 0 ? extraH : 0;
	extraW = extraW > 0 ? extraW : 0;
	if($.browser.msie){
		divheight = h * 0.5;
		divwidth = w * 0.5;
		if(parseInt($.browser.version)<7){
			divheight = divheight < 300 ? 300 : divheight;
			divwidth = divwidth < 400 ? 400 : divwidth;
		}
	}
	var t = (h - divheight - extraH)/2;
	var l = (w - divwidth -extraW)/2;
	//
	//
    $dom.css({top:t>0 ? t: 0,left:l>0 ? l:0});
    if($.browser.msie){
    	$dom.css({height:divheight,width:divwidth});
    }
     if (!this._setTabPosition())
    {
        var inputBound = KTools.getBounds(this._inputDom.get(0));
        var inputHeight = inputBound.max.y - inputBound.min.y;
        var spandom = $(">span", this._domAll);
        var inputBound = KTools.getBounds(spandom.get(0));
        this._hotCityDom.css({top : inputHeight+inputBound.min.y,left : inputBound.min.x});
    }
    this._layoutMoreCity();
};
KCityList.prototype._layoutMoreCity = function() {
	if (this._moreCityListDom && this._moreCityListDom.is(":visible")) {
		if (this._moreCityDlDom.eq(0).is(":visible")) {
			var ulDom = $("ul[mfg='lc']", this._moreCityListDom).eq(0);
			ulDom.css( {
				height : "0px"
			});
			var ulpadding = ulDom.outerHeight(true) - ulDom.height();
			var height = KTools.getBounds(this._moreCityListDom[0], {
				border : true,
				padding : true
			}).max.y - KTools.getBounds(ulDom.get(0), {
				margin : false
			}).min.y - ulpadding;
			ulDom.css( {
				height : height
			});
		} else if (this._moreCityDlDom.eq(1).is(":visible")) {
			var ulDom = $("ul[mfg='lc']", this._moreCityListDom).eq(1);
			ulDom.css( {
				height : "0px"
			});
			var ulpadding = ulDom.outerHeight(true) - ulDom.height();
			var height = KTools.getBounds(this._moreCityListDom[0], {
				border : true,
				padding : true
			}).max.y - KTools.getBounds(ulDom.get(0), {
				margin : false
			}).min.y - ulpadding;
			ulDom.css( {
				height : height
			});
		}
	}
};
/**
 *  Dom 
 * 
 * @uncrunch
 */
KCityList.prototype.dom = function()
{
    return this._domAll;
};
/**
 *  options
 * @param opt
 */
/**
 * 
 * @param cityInfo
 * @uncrunch
 */
KCityList.prototype.setCity = function(cityinfo)
{
	if(!cityinfo || !cityinfo.name){
		return;
	}
	var _this=this;
    var oldCityInfo = this._city;
    var isRequest = false;
    //var props = ["name","ename","latlon","level","province","bus"];
    var props = ["name","latlon"];
    var prop;
    for(var i=0; i<props.length; i++){
    	if(cityinfo[props[i]]==undefined){
    		isRequest =true;
    		break;
    	}
    }
    var laturl = this.options().laturl;
    var hash = new KUrlHash();
    hash.setKey("t", "cn");
    hash.setKey("c", cityinfo.name);
    if (isRequest && laturl) {
    	var questionMark = laturl.indexOf("?");
		if (questionMark > -1) {
			laturl = laturl.substring(0, questionMark);
		}
		$.ajax( {
			url : laturl+"?"+ hash.toString(),
			dataType : "json",
			success : function(data) {
				if(!data || !data.f){
					KTools.showMsg("");
					return;
				}
				var info = {
					name : data.a,
					ename : data.c,
					latlon : data.f,
					level : parseInt(data.g),
					bus : data.h === "1" ? true : false
				};
				if (isNaN(info.level) || cityinfo.level) {// level,level
					var level = parseInt(cityinfo.level);
					if (!isNaN(level)) {
						info.level = level;
					}
				}
				_this._inputDom.val(info.name);
				KEvent.trigger(_this, "citychanged", _this, info, oldCityInfo);
				_this._city = info;
				if (_this._suggestArray && _this._suggestArray.length > 0) {
					_this._suggestArray[0].setData( {
						text : info.name,
						zoom : info.level,
						kvalue : info.latlon,
						bus : info.bus,
						_ename : info.ename
					});
				}
			},
			error : function() {
				KTools.showMsg("");
			}
		});
	} else {
		this._inputDom.val(cityinfo.name);
		KEvent.trigger(this, "citychanged", this, cityinfo, oldCityInfo);
		this._city = cityinfo;
		if (this._suggestArray && this._suggestArray.length > 0) {
			this._suggestArray[0].setData( {
				text : cityinfo.name,
				zoom : cityinfo.level,
				kvalue : cityinfo.latlon,
				bus : cityinfo.bus,
				_ename : cityinfo.ename
			});
		}
	}
   

};
/**
 * /tabs
 */
KCityList.prototype._closeOrShowTabs = function() {
	if(this._cityListType){
		if(this._moreCityListDom.is(":visible")){
			this._hideMoreCity();
		}else{
			this._showClick = true;
			this.showNewCity();
		}
	}else{
		if (this._hotCityDom.is(":visible")) {
			this._closeTabs();
		} else {
			this._showTabs();
			// KEvent.trigger(this,"beforeopenhotcity",this);
		}
	}
};
KCityList.prototype._showTabs = function()
{
    var _this = this;
    if (!this._setTabPosition())
    {
        var inputBound = KTools.getBounds(this._inputDom.get(0));
        var inputHeight = inputBound.max.y - inputBound.min.y;
        var spandom = $(">span", this._domAll);
        var inputBound = KTools.getBounds(spandom.get(0));
        this._hotCityDom.css({top : inputHeight+inputBound.min.y,left : inputBound.min.x});
    }
     if (this._hotCityTabs != null)
    {
       _this._hotCityTabs.select(0);
    }
     if(!this._hotCityDom.is(":visible"))
    {
      this._hotCityDom.show();
      KEvent.trigger(this,"beforeopenhotcity",this);
    } 
};
KCityList.prototype._closeTabs = function()
{
  var _this = this;  
     if (this._hotCityTabs != null)
    {
       _this._hotCityTabs.select(0);
    }
     if(this._hotCityDom.is(":visible"))
    {
        this._hotCityDom.hide();
    }
};
KCityList.prototype._addTabsDom = function()
{
    var _this = this;
    if (!this._initTab)
    {
		this._hotCityTabs = new KStdTabs(this._hotCityDom);
        this._initTab = true;
        KEvent.bind(_this._hotCityTabs, "selected",
                function(eventinfo, widget, oldItem, currentItem)
                {
                    //setTimeout(function(){_this._addClickEvent(currentItem.contentDom);},0);
                }
                );
        KEvent.bind(_this._hotCityTabs, "datashown",
                function(eventinfo, widget, data, container)
                {
                    setTimeout(function(){_this._addClickEvent(container);},0);
                });
       
        //window.setTimeout
        //window.setTimeout(function(){_this._addClickEvent(_this._hotCityTabs.current().contentDom)},0);
    }
};
/**
 * tabs
 */
KCityList.prototype._updateTabsOptions = function()
{
    var _this = this;
    if (this._opts.citylist || typeof this._opts.citylist == "undefined")
    {	
        this._aDom.unbind("click");
        this._tabCloseDom.unbind("click");
        this._aDom.click(function() {
        	if(!_this._cityListType){
        		_this._addTabsDom();
                _this._closeOrShowTabs();
        	}else{
        		_this._closeOrShowTabs();
        		//_this.showNewCity();
        	}
        });
        this._tabCloseDom.click(function(e) {
            e.stopPropagation();
            _this._closeTabs();
        });
        //}
    }
    else
    {
        this._aDom.unbind("click");
        //this._hotCityTabs = null;

    }
    if (this._opts.mburl && this._opts.mburl != "")
    {
        this._moreCityDom.show();
    }
    else
    {
        this._moreCityDom.hide();
        this._updateThemeOptions();
    }
};
/**
 * suggest
 */
KCityList.prototype._updateSugOptions = function()
{
    var _this = this;
    if (this._opts.sugurl && this._opts.sugurl != "")
    {
        var sugurl = _this._opts.sugurl;
        if (sugurl.indexOf("?") != -1)
        {
            var num = sugurl.indexOf("?");
            sugurl = sugurl.substring(0, num);
        }
        var hash = new KUrlHash();
         hash.setKey("t","cs");
         hash.setKey("s","json");
        sugurl = sugurl + "?"+ hash.toString();
        if (_this._suggestArray.length == 0)
        {
            _this._suggestArray = KStdSuggest.bind(_this._inputDom.get(0), {
				'url' : sugurl,
				minwidth : 200,
				'listlimit' : this._opts.suglimit,
				autorevert : false,
				"autocomplete" : (_this._opts.autocomplete === false ? false : true)
			/*,'node':_this._suggestDom*/});
            _this._suggestArray[0].setData( {
				text : _this._city.name,
				kvalue : {
					"a" : _this._city.latlon,
					"b" : _this._city.level,
					"c" : (_this._city.bus === true) ? "1" : "0",
					"d" : _this._city.ename
				}
			});
            _this._inputDom.val(_this._city.name);//KStdSuggest inputbug
            if (typeof _this._suggestArray != "undefined" && _this._suggestArray.length > 0)
            {
                KEvent.bind(_this._suggestArray[0], "datachanged", function(eventInfo, widget, suggsetInfo)
                {
                    var oldCityInfo = _this._city;
                    _this._city = {
						"name" : suggsetInfo.text,
						"latlon" : suggsetInfo.kvalue.a,
						"level" : suggsetInfo.kvalue.b,
						"bus" : (suggsetInfo.kvalue.c === "1" ? true : false),
						"ename": suggsetInfo.kvalue.d
					};
                    if (_this._city.name != oldCityInfo.name) {
						KEvent.trigger(_this, "citychanged", _this, _this._city, oldCityInfo);
					}
                });
            }
        }
        else
        {
            _this._suggestArray[0].setOptions({"listlimit": _this._opts.suglimit});
        }
        var inputHeight = this._inputDom.height() + 8;
        _this._suggestDom.css({top : inputHeight});
        //$(">div:last-child",_this._domAll).css({top : inputHeight});
    }
    else
    {
        //this._suggestDom.hide();
        if (_this._suggestArray && _this._suggestArray.length >= 1)
        {
            _this._suggestArray[0].finalize();
        }
        _this._suggestArray = [];
    }
};

/**
 * theme
 */
KCityList.prototype._updateThemeOptions = function()
{
	var old = this._oldTheme, th= this.theme(),  oNames = KCityList.conf.CLASSNAME;
    this._domAll.removeClass(old + oNames.CYL).addClass(th + oNames.CYL).find("span:first").removeClass(old + oNames.I)
			.addClass(th + oNames.I);
	this._moreCityDom.parent().removeClass(old + oNames.M).addClass(th + oNames.M);
	this._tabCloseDom.removeClass(old + oNames.CLE).addClass(th + oNames.CLE);
	this._hotCityDom.removeClass(old + oNames.H).addClass(th + oNames.H);
};

/**
 * tabs
 */
KCityList.prototype._hideTabs = function()
{
    this._hotCityDom.hide();
};
/**
 * 
 * @param clDom
 */
KCityList.prototype._addClickEvent = function(clDom)
{
    var _this = this;
    var liClickFun = function(e)
    {
        e.stopPropagation();
        var cityInfo = {
			"name" : $(this).html(),
			"latlon" : $(this).attr("l"),
			"level" : $(this).attr("z"),
			"ename":$(this).attr("en"),
			"province" : $(this).attr("p"),
			"bus" : ($(this).attr("ib") == "1" ? true : false)
		};
        _this._closeTabs();
        _this.setCity(cityInfo);
        return false;
    };
    this._cityliDom = $(">ul>li a,>li a,>dl>dd a", clDom);
    this._cityliDom.each(function(index) {
		$(this).unbind("click").click(liClickFun);
		// $(this).attr("onclick", "return false;");
		});


};
/**
 * 
 * 
 * @param clDom
 */
KCityList.prototype._addClickMoreEvent = function(clDom,type)
{
	
    var _this = this;
    var liClickFun = function(e)
    {
        e.stopPropagation();
        var cityInfo = {
			"name" : $(this).html(),
			"latlon" : $(this).attr("l"),
			"level" : $(this).attr("z"),
			"ename":$(this).attr("en"),
			"province" : $(this).attr("p"),
			"bus" : ($(this).attr("ib") == "1" ? true : false)
		};
        _this._closeTabs();
        _this._moreCityListDom.hide();
        _this.setCity(cityInfo);
        //opt# 1012301047 fix begin
        //edit by zhangsq
        $(function(){KTools.lightbox({});});
        //opt# 1012301047 fix end
    };
    // added by zwq 
    var eventType = type;
    if(eventType){
    	var hotDom = $(">strong>a",clDom);
    	hotDom.each(
            function()
            {
                $(this).unbind("click");
                $(this).click(liClickFun);
            });
    }else{
        this._moreCityliDom = $(">div a,li a", clDom);
        this._moreCityliDom.each(
                function()
                {
                    $(this).unbind("click");
                    $(this).click(liClickFun);
                });
    }
};
/**
 * option
 * @param opt
 */
KCityList.prototype._setOption = function(opt)
{
    this._oldTheme = this._opts.theme;
    this._opts = KTools.copyOptions(opt, this._opts);
};
KCityList.prototype._updateCloseOptions = function() {
	var _this = this;
	var clickFun = function(e) {
		var ev = window.event || e;
		var obj = ev.target || ev.srcElement;
		//
		if (_this._aDom) {
			if ($(obj).attr("cl_mc") !== _this._aDom.attr("cl_mc")) {
				// _this._hotCityDom.hide();
				_this._closeTabs();
			} else {
				if (_this.options().onehot) {
					if ($(obj).get(0) !== _this._aDom.get(0)) {
						// _this._hotCityDom.hide();
						_this._closeTabs();
					}
				}
			}
		} else {
		}
	};
	if (_this._opts.closebtn || typeof _this._opts.closebtn == "undefined") {
		KEvent.unbind(jQuery(document), "click", clickFun);
		_this._tabCloseDom.show();
	} else {
		KEvent.bind(jQuery(document), "click", clickFun);
		_this._tabCloseDom.hide();
	}
};
/**
 * 
 * @uncrunch
 */
KCityList.prototype.hideHotCity = function()
{
    //var _this =this;
    //this._hotCityDom.hide();
     this._closeTabs();
};
/**
 * 
 * @returns
 */
KCityList.prototype._hideMoreCity = function()
{
    //this._hotCityDom.hide();
     this._hotCityDom.hide();
    $(this.options().mcnode).hide();
    this._moreCityListDom.hide();
    //opt# 1012301047 fix begin
    //edit by zhangsq
    $(function(){KTools.lightbox({});});
    //opt# 1012301047 fix end
};

//
KCityList.prototype._setTabPosition = function()
{
    var spandom = $(">span", this._domAll);
    var inputBound = KTools.getBounds(spandom.get(0));
    var windwoBound = KTools.getBounds(window);
    var tabHeight = this._hotCityDom.outerHeight();
    var tabWidth = this._hotCityDom.outerWidth();
    var range = new KSize(parseInt(tabWidth), parseInt(tabHeight));
    var bounds = KTools.checkSpace(inputBound, range, windwoBound);
    var proArray = ['bottom','top','left','right'];
    var length = proArray.length;
    var positionIndex = 0;
    var tempBound = null;
    for (var i = 0; i < length; i++)
    {
        if (bounds[proArray[i]].usable)
        {
            positionIndex = i;
            tempBound = bounds[proArray[i]].min;
            break;
        }
        /* else
         {
         var  tsrang = bounds[proArray[i]].width * bounds[proArray[i]].height;
         if( srang< tsrang)
         {
         srang = tsrang;
         }
         }*/
    }
    var positionx = 0;
    var positiony = 0;
    if (tempBound != null)
    {
        if (positionIndex == 0 || positionIndex == 1)
        {
            if (inputBound.min.x + tabWidth + 4 > tempBound.max.x)
            {
                positionx = (tempBound.max.x - tabWidth)  - 4;
            }
            else
            {
                positionx =inputBound.min.x;
            }
            if (positionIndex == 0)
            {
                positiony = inputBound.size().height + 4 + inputBound.min.y;
            }
            else
            {
                positiony = 0 - tabHeight - 4 + inputBound.min.y;
            }
        }
        else
        {
            if (inputBound.min.y + tabHeight + 4 > tempBound.max.y)
            {
                positiony = (tempBound.max.y - tabHeight) - 4;
            }
            else
            {
               positiony  =tempBound.max.y;
            }
            if (positionIndex == 3)
            {
                positionx = inputBound.size().width + 4 + inputBound.min.x;
            }
            else
            {
                positionx = 0 - tabWidth - 4 +  inputBound.min.x;
            }
        }
        this._hotCityDom.css({top:positiony,left:positionx});
        return true;
    }
    else
    {
        return false;
    }
};

/**
 * ()
 * @uncrunch
 */
KCityList.prototype.hideMoreCity = KCityList.prototype._hideMoreCity;
/**
 * 
 * @uncrunch
 */
KCityList.prototype.showHotCity = function() {
	var _this = this;
	_this._addTabsDom();
	_this._showTabs();
};
/**
 * 
 * @uncrunch
 */
KCityList.prototype.showMoreCity = function() {
	var _this = this;
	_this._closeTabs();
	var $dl = _this._moreCityDlDom;
	var $list = _this._moreCityListDom;
	if(_this._morecityFlag){
		$dl.eq(0).empty();
		//_this._morecityFlag = false;
	}
	if ($dl.eq(0).html() == "") {
		$dl.eq(0).empty().load(_this._opts.mburl, function() {
            //opt# 1012301047 fix begin
            //add by zhangsq
            $dl.eq(0).show();
			$("ul[mfg='lc']", $list).eq(0).css( {
				height : "100px"
			});
            $(_this.options().mcnode).show();
			$list.show();

			var h = $(window).height();
			var w = $(window).width();
			var divheight = $list.outerHeight();
			var divwidth = $list.outerWidth();
			var extraH = $list.outerHeight() - divheight;
			var extraW = $list.outerWidth() - divwidth;
			extraH = extraH > 0 ? extraH : 0;
			extraW = extraW > 0 ? extraW : 0;
			if($.browser.msie){
				divheight = h * 0.5;
				divwidth = w * 0.5;
				if(parseInt($.browser.version)<7){
					divheight = divheight < 300 ? 300 : divheight;
					divwidth = divwidth < 400 ? 400 : divwidth;
				}
			}
			var t = (h - divheight - extraH)/2;
			var l = (w - divwidth -extraW)/2;
			$list.css( {
				top : t > 0 ? t : 0,
				left : l > 0 ? l : 0
			});
			if($.browser.msie){
				$list.css( {
					height:divheight,
					width:divwidth
				});
			}
			_this._addClickMoreEvent($dl.eq(0));
			if(_this._cityListType){
				var newHotDom = $(">div", _this._moreCityListDom);
				_this._addClickMoreEvent(newHotDom,true);
				_this._updateNewCitySugOptions();
			}
            //delete by zhangsq
			/*$dl.eq(0).show();
			$("ul[mfg='lc']", $list).eq(0).css( {
				height : "100px"
			});
            $(_this.options().mcnode).show();
			$list.show();*/
            //edit by zhangsq
            $(function(){KTools.lightbox( {element : $list,visible : true});});
            //opt# 1012301047 fix end
			_this._layoutMoreCity();
			$dl.eq(1).hide();
		});
	} else {
        $(_this.options().mcnode).show();
		$list.show();
		_this._moreCityListDom.show();
		var h = $(window).height();
		var w = $(window).width();
		var divheight = $list.outerHeight();
		var divwidth = $list.outerWidth();
		var extraH = $list.outerHeight() - divheight;
		var extraW = $list.outerWidth() - divwidth;
		extraH = extraH > 0 ? extraH : 0;
		extraW = extraW > 0 ? extraW : 0;
		if($.browser.msie){
			divheight = h * 0.5;
			divwidth = w * 0.5;
			if(parseInt($.browser.version)<7){
				divheight = divheight < 300 ? 300 : divheight;
				divwidth = divwidth < 400 ? 400 : divwidth;
			}
		}
		var t = (h - divheight - extraH)/2;
		var l = (w - divwidth -extraW)/2;
		$list.css( {
			top : t > 0 ? t : 0,
			left : l > 0 ? l : 0
		});
		if($.browser.msie){
			$list.css( {
				height:divheight,
				width:divwidth
			});
		}
		_this._addClickMoreEvent($dl.eq(0));
		if(_this._cityListType){
			var newHotDom = $(">div", _this._moreCityListDom);
			_this._addClickMoreEvent(newHotDom,true);
			_this._updateNewCitySugOptions();
		}
        //opt# 1012301047 fix begin
        //edit by zhangsq
        $(function(){KTools.lightbox( {element : $list,visible : true});});
        //opt# 1012301047 fix end
		_this._changeMoreCity(0);
	}
};


KCityList.prototype._updateKStdSuggestOpts = function(opts) {
	var _this = this;
	if (!_this._suggestArray || !_this._suggestArray[0]) {
		return;
	}
	if (_this._suggestArray[0].setOptions) {
		_this._suggestArray[0].setOptions(opts);
	}
};

/**
 * 
 * @uncrunch
 */
KCityList.prototype.showNewCity = function() {
	var _this = this;
	_this._closeTabs();
	var $dl = _this._moreCityDlDom;
	var $list = _this._moreCityListDom;
	_this._morecityFlag = true ; //showMoreCity$dl.eq(0)
	if ($dl.eq(0).html() == "") {
		$dl.eq(0).empty().load(_this._opts.mburl, function() {
            //opt# 1012301047 fix begin
            //add by zhangsq
            $dl.eq(0).show();
			$("ul[mfg='lc']", $list).eq(0).css( {
				height : "100px"
			});
            $(_this.options().mcnode).show();
			$list.show();
			var divheight = $list.outerHeight();
			var divwidth = $list.outerWidth();
			var position = _this._inputDom.offset();
			var inh = _this._inputDom.outerHeight();
			var inw = _this._inputDom.outerWidth();
			var t = position.top + inh +4;
			var l = position.left - 5 ;
			$list.css( {
				top : t > 0 ? t : 0,
				left : l > 0 ? l : 0
			});
			if($.browser.msie){
				$list.css( {
					height:divheight,
					width:divwidth,
					top : t > 0 ? t : 0,
					left : l > 0 ? l : 0
				});
			}
			//added by zwq 
			var newHotDom = $(">div", _this._moreCityListDom);
			_this._updateNewCitySugOptions();
			_this._addClickMoreEvent(newHotDom,true);
			_this._addClickMoreEvent($dl.eq(0));
			/*change by liufang 20131128 start*/
			if($.browser.msie) {
				_this._blurColsedCityForIE();
			} else {
				_this._blurColsedCity();
			}
			/*change by liufang 20131128 end*/
			
			/*delete by liufang 20131128 start*/
			/*
			if(!$.browser.msie){
				_this._blurColsedCity();
			}
			*/
            //opt# 1012301047 fix end
			_this._layoutMoreCity();
			$dl.eq(1).hide();
		});
	} else {
        $(_this.options().mcnode).show();
		$list.show();
		var divheight = $list.outerHeight();
		var divwidth = $list.outerWidth();
		var position = _this._inputDom.offset();
		var inh = _this._inputDom.outerHeight();
		var inw = _this._inputDom.outerWidth();
		var t = position.top + inh +4;
		var l = position.left - 5 ;
		$list.css( {
			top : t > 0 ? t : 0,
			left : l > 0 ? l : 0
		});
		if($.browser.msie){
			$list.css( {
				height:divheight,
				width:divwidth,
				top : t > 0 ? t : 0,
				left : l > 0 ? l : 0
			});
		}
		_this._updateNewCitySugOptions();
        //edit by zhangsq
		//edit by zwq 
		if(!_this._cityListType){
			$(function(){KTools.lightbox( {element : $list,visible : true});});
		}
        //opt# 1012301047 fix end
		_this._changeMoreCity(0);
	}
	$(">input", _this._moreCityListDom).val("");
};
/**
 * inputsuggest
 */
KCityList.prototype._updateNewCitySugOptions = function()
{
    var _this = this;
    var newInputDom = $(">input", _this._moreCityListDom);
    var newbutton = $(">button", _this._moreCityListDom);
    var newspan = $(">span", _this._moreCityListDom);
    var svalue = newspan.html();
    newspan.html("");
    var ivalue = newInputDom.val();
    newInputDom.focus(function(e) {
        e.stopPropagation();
        newspan.html("");
        newInputDom.val() == ivalue ? newInputDom.val("") : newInputDom.select();
    }).blur(function(e) {
        e.stopPropagation();
        newInputDom.val() == "" && newInputDom.val(ivalue);
    })
    _this._suggestArray = [];
    if (this._opts.sugurl && this._opts.sugurl != "")
    {
        var sugurl = _this._opts.sugurl;
        if (sugurl.indexOf("?") != -1)
        {
            var num = sugurl.indexOf("?");
            sugurl = sugurl.substring(0, num);
        }
        var hash = new KUrlHash();
        hash.setKey("t","cs");
        hash.setKey("s","json");
        sugurl = sugurl + "?"+ hash.toString();
        if (_this._suggestArray.length == 0)
        {
            _this._suggestArray = KStdSuggest.bind(newInputDom.get(0), {
				'url' : sugurl,
				minwidth : 200,
				'listlimit' : this._opts.suglimit,
				autorevert : false,
				cache:false,
				autocomplete : true//(_this._opts.autocomplete === false ? false : true)
			});
            _this._suggestArray[0].setData( {
				text : _this._city.name,
				kvalue : {
					"a" : _this._city.latlon,
					"b" : _this._city.level,
					"c" : (_this._city.bus === true) ? "1" : "0",
					"d" : _this._city.ename
				}
			});
            //newInputDom.val(_this._city.name);//KStdSuggest inputbug
            var nodata = true;
            var oldCityInfo = _this._city;
            if (typeof _this._suggestArray != "undefined" && _this._suggestArray.length > 0)
            {
                KEvent.bind(_this._suggestArray[0], "datachanged", function(eventInfo, widget, suggsetInfo)
                {
                	oldCityInfo = _this._city;
                    _this._city = {
						"name" : suggsetInfo.text,
						"latlon" : suggsetInfo.kvalue.a,
						"level" : suggsetInfo.kvalue.b,
						"bus" : (suggsetInfo.kvalue.c === "1" ? true : false),
						"ename": suggsetInfo.kvalue.d
					};
                });
            }
            KEvent.bind(_this._suggestArray[0], "nodata", function(){
            	nodata = false;
            }); 
            KEvent.bind(_this._suggestArray[0], "hasdata", function(){
            	nodata = true;
            }); 
            newInputDom.keydown(function(e){
            	if(e.keyCode == 13){
            		var surl = _this._getURL(newInputDom.val());
            		$.getJSON(surl , function(data){
            			if(data.a && data.a.length >0){
        			        e.stopPropagation();
        			        var cityInfo = {
        						"name" : data.a[0].c.split("<span>")[0],
        						"latlon" : data.a[0].b.a,
        						"level" : data.a[0].b.b,
        						"ename":data.a[0].b.d,
        						"province" : "",
        						"bus" : (data.a[0].b.c == "1" ? true : false)
        					};
        			        _this._closeTabs();
        			        _this._moreCityListDom.hide();
        			        _this.setCity(cityInfo);
        			        $(function(){KTools.lightbox({});});
            			}else{
            				newspan.html(svalue);
            			}
                    });
            	}
            });
            newbutton.click(function(e){
            	e.stopPropagation();
            	if(nodata){
            		_this._moreCityListDom.hide();
                    _this.setCity(_this._city);
                    if (_this._city.name != oldCityInfo.name) {
						KEvent.trigger(_this, "citychanged", _this, _this._city, oldCityInfo);
					}
            	}else{
            		newspan.html(svalue);
            		if(newspan.html() === ""){
            			nodata = true;
            		}
            	}
                $(function(){KTools.lightbox({});}); 
            });
        }
        else
        {
            _this._suggestArray[0].setOptions({"listlimit": _this._opts.suglimit});
        }
        var inputHeight = newInputDom.height() + 8;
        _this._suggestDom.css({top : inputHeight});
    }
    else
    {
        if (_this._suggestArray && _this._suggestArray.length >= 1)
        {
            _this._suggestArray[0].finalize();
        }
        _this._suggestArray = [];
    }
};

/**
 * 
 */

KCityList.prototype._blurColsedCity = function() {
	var _this = this;
	var clickFun = function(e) {
		var ev = window.event || e;
		var obj = ev.target || ev.srcElement;
		if($(obj).attr("cl_mc") !== _this._aDom.attr("cl_mc")){
			_this._moreCityListDom.hide();
		}else{
			if ($(obj).get(0) !== _this._aDom.get(0)) {
				_this._moreCityListDom.hide();
			}
		}
	};
	KEvent.bind(jQuery(document), "click", clickFun);
};
/**
 * IE
 * add by liufang 20131128
 */
KCityList.prototype._blurColsedCityForIE = function() {
	var _this = this;	
	var clickFun = function(e) {
	var ev = window.event || e;
	var obj = ev.target || ev.srcElement;
		//domci_mcdom
		//
		if(!($(obj).attr("cl_mc"))) {
			_this._moreCityListDom.hide();
		}
	};
	KEvent.bind(jQuery(document), "click", clickFun);
};

/**
 * URL
 * @param q
 */
KCityList.prototype._getURL = function(k) {
    var hash = new KUrlHash();
    hash.setKey("t", "cs");
    hash.setKey("s", "json");
    hash.setKey("a", 8);
    hash.setKey("k", k);
    return this.options().sugurl + "?" + hash.toString();
};
/*
 
 fuyg
 1.0.1
 2011-03-22
 2011-03-28
 ============================================
 
 */
var KDatePicker = KClass.create("KDatePicker", KWidget);
KDatePicker.conf = {
    CLASSNAME: {
        //
        DTP: "_dtp",
        //
        PRE: "_dtp_pre",
        //
        NEXT: "_dtp_next",
        //
        WL: "_dtp_wl",
        //
        WR: "_dtp_wr",
        //
        H: "_dtp_h",
        //DIV
        C: "_dtp_c",
        //
        WKE: "_dtp_wke",
        //
        CUR: "_dtp_cur",
        //
        S: "_dtp_s",
        //
        E: "_dtp_e",
        //
        TIP: "_dtp_tip"
    }
};
/**
 * 
 * @param {InputElement} input 
 * @param {KDatePickerOptions} opts
 */
KDatePicker.initialize = function(input, opts){
    var _this = this;
    this._input = $(input).get(0);
	//  added by zy
    if($(input).length > 0) this._input.readOnly = true;
    var $input = $(this._input);
    if ($input.attr("type") !== "text") {
        throw new Error("KDatePicker!");
    }
    //input
    this._eventNS = ".kdatepicker";
    $input.unbind(this._eventNS).bind("focus" + this._eventNS + " click" + this._eventNS, function(){
        _this._focusHandler.apply(_this, arguments);
    });
    $(document).bind("click" + this._eventNS + " focus" + this._eventNS, function(event){
        if (event.target == _this._input) {
            return;
        }
        if (_this._opts.icon && (event.target == _this._opts.icon || $.contains(_this._opts.icon, event.target))) {
            return;
        }
        if ($.contains(_this._dom, event.target)) {
            return;
        }
        _this.hide();
    });
    //
    this._theme = null;
    this._cssClass = null;
    this._dom = null;
    this._selectedDate = null;
    //DOM
    this._isInited = false;
    this._initOpts(opts);
	$(window).bind("resize"+this._eventNS, function(){
		_this.hide.apply(_this);
	});
};
/******************************************************
 * KWidget
 *****************************************************/
/**
 * @return 
 * @uncrunch
 */
KDatePicker.prototype.cnname = function(){
    return "";
};
/**
 * @return 
 * @uncrunch
 */
KDatePicker.prototype.version = function(){
    return "1.0.1";
};
/**
 * 
 * @param scheme
 * @uncrunch
 */
KDatePicker.prototype.setTheme = function(scheme){
    this._theme = scheme;
    //do something
};
/**
 * obj 
 * @param obj {KDatePickerOptions}
 * @uncrunch
 */
KDatePicker.prototype.setOptions = function(obj){
	var _this=this;
    obj = KTools.copyOptions(obj, KDatePickerOptions);
    var diffOpts = KTools.compareOptions(this._opts, obj);
	//
    $.each(diffOpts, function(name, value){
        switch (name) {
            case "min":
				_this._setMin(value);
                break;
            case "max":
                break;
            case "date":
                break;
            case "month":
                break;
            case "min":
                break;
            case "min":
                break;
        }
    });
};
/**
 * 
 * @uncrunch
 */
KDatePicker.prototype.show = function(){
    var date = this._dateParser($(this._input).val());
    if (this._isInited === true) {
        if (this._isDateObject(date)) {
            this._opts.date = date;
        }
        var firstMonth = this._firstMonth();
        this._updateCalender(firstMonth, this._opts.month);
        $(this._dom).show();
        this.layout();
    }
};
/**
 * 
 * @uncrunch
 */
KDatePicker.prototype.hide = function(){
    $(this._dom).hide();
};
/**
 * 
 * @uncrunch
 */
KDatePicker.prototype.layout = function(){
    var offset = $(this._input).offset();
    var height = $(this._input).height();
    var $box = $(this._opts.box);
    var boxOffset = $box.offset();
    var boxWidth = $box.innerWidth();
    var boxHeight = $box.innerHeight();
    //
    var domWidth = $(this._dom).outerWidth(true);
    var domHeight = $(this._dom).outerHeight(true);
    var domAbsPosTop = offset.top + height + 7;
    var domAbsPosLeft = offset.left;
    var domRefPosTop = domAbsPosTop - boxOffset.top;
    var domRefPosLeft = domAbsPosLeft - boxOffset.left;
    //
    while (domRefPosTop + domHeight > boxHeight) {
        domRefPosTop--;
    }
    domAbsPosTop = boxOffset.top + (domRefPosTop < 0 ? 0 : domRefPosTop);
    while (domRefPosLeft + domWidth > boxWidth) {
        domRefPosLeft--;
    }
	domRefPosLeft = domRefPosLeft -16;
    domAbsPosLeft = boxOffset.left + (domRefPosLeft < 0 ? 0 : domRefPosLeft) ;
    //
    $(this._dom).css({
        top: domAbsPosTop + "px",
        left: domAbsPosLeft + "px"
    });
};
/**
 * @uncrunch
 */
KDatePicker.prototype.finalize = function(){
    $(this._input).unbind(this._eventNS);
    $(document).unbind(this._eventNS);
	$(window).unbind(this._eventNS);
    $(this._dom).unbind();
    $(this._dom).find(">a").unbind();
    if (this._opts.icon && this._opts.icon.nodeType === 1) {
        $(this._opts.icon).unbind(this._eventNS);
    }
    //
    KWidget.prototype.finalize.apply(this);
};
/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KDatePicker.prototype.dependent = function(){
    return [jQuery, KClass, KObject, KManager, KEvent, KTools, KWidgetOptions, KWidget, KDatePickerOptions];
};
/******************************************************
 * 
 *****************************************************/
/***
 *
 * @param {Boolean} isFormated  formattrue
 * @return {Date} Date
 * @uncrunch
 */
KDatePicker.prototype.getDate = function(isFormated){
    return (isFormated !== false ? this.formatDate(this._opts.date) : this._opts.date);
};
/***
 *
 * @param {Object} date
 * @return
 * @uncrunch
 */
KDatePicker.prototype.setDate = function(date){
    this._setDate(date);
};
/***
 *
 * @param {Date} date
 * @param {String} format ,format
 * @return {String} 
 * @uncrunch
 */
KDatePicker.prototype.formatDate = function(date, format){
    var cDate = this._customDate(date);
    if (cDate && cDate.orig) {
        format = (typeof format === "string") ? format : "yyyy-mm-dd";
        return format.replace(/y+/ig, cDate.y).replace(/m+/ig, this._prefixZero(cDate.m, 2)).replace(/d+/ig, this._prefixZero(cDate.d, 2));
    }
};
/**
 * KDatePicker
 * @param {KDatePicker} picker
 */
KDatePicker.prototype.setReferPicker = function(picker){
    if (this._isPicker(picker) && this !== picker) {
        this._opts.referpicker = picker;
    }
};
/******************************************************
 * 
 *****************************************************/
/***
 *
 * @return {Date}
 */
KDatePicker.prototype._getReferDate = function(){
};
/***
 *
 * @param {Date} date  DatedateParser()Date
 * @return
 */
KDatePicker.prototype._setReferDate = function(date){
};
/**
 * Date
 * @param {Object} obj
 * @return {Boolean}
 */
KDatePicker.prototype._isDateObject = function(obj){
    return (obj && (obj instanceof Date) && !isNaN(obj.getTime()));
};
/**
 * focus
 */
KDatePicker.prototype._focusHandler = function(){
    this.show();
};
/**
 * 
 * @return {Object}
 */
KDatePicker.prototype._setClassName = function(theme){
    var th = theme || "mwp";
    var CN = KDatePicker.conf.CLASSNAME;
    var klass = {};
    for (var k in CN) {
        klass[k] = th + CN[k];
    }
    return (this._cssClass = klass);
};
/**
 * 
 * @param {KDatePickerOptions} obj
 */
KDatePicker.prototype._initOpts = function(obj){
    var _this = this;
    var temp = "";
    var opts = $.extend(true, {}, obj);
    opts = KTools.copyOptions(opts, KDatePickerOptions);
    opts.icon = (obj.icon && obj.icon.nodeType === 1) ? obj.icon : undefined;
    opts.box = (obj.box && obj.box.nodeType === 1) ? obj.box : document.body;
    //
    //check options
    opts.month = parseInt(opts.month, 10);
    opts.month = (isNaN(opts.month) || opts.month < 1) ? 1 : opts.month;
    this._theme = opts.theme || "mwp";
    this._setClassName(this._theme);
    opts.min = this._isDateObject(opts.min) ? opts.min : undefined;
    opts.max = this._isDateObject(opts.max) ? opts.max : undefined;
    if (opts.min && opts.max) {
        if (opts.min.getTime() > opts.max.getTime()) {
            temp = opts.max;
            opts.max = opts.min;
            opts.min = temp;
        }
    }
    //
    if (opts.icon) {
        $(opts.icon).bind("click" + this._eventNS, function(event){
            event.preventDefault();
            _this.show();
        });
    }
    opts.referpicker = this._isPicker(opts.referpicker) ? opts.referpicker : undefined;
    //
    this._opts = opts;
    //
    this._createTopContainer();
    var cDate = this._customDate(opts.date);
    if (this._isDateObject(opts.date)) {
        if (opts.min && this._compareCustomDate(cDate, this._customDate(opts.min)) < 0) {
            opts.date = undefined;
        } else if (opts.max && this._compareCustomDate(cDate, this._customDate(opts.max)) > 0) {
            opts.date = undefined;
        } else {
            opts.date = new Date(opts.date.getTime());
        }
    } else {
        opts.date = undefined;
    }
    //
    var firstMonth = this._firstMonth();
    var rows = this._calenderRows(firstMonth, opts.month);
    //
    opts.month > 1 ? this._createMulti(this._dom, opts.month, firstMonth, rows) : this._createOne(this._dom, firstMonth, rows);
    //
    this._createTip(this._dom, opts.tip);
    this._setDate(opts.date);
    //
	$(this._dom).css({
        top: 0,
        left: 0
    });
	var domWidth = $(this._dom).width();
	//width
	$(this._dom).css({
       width: domWidth +"px"
    });
	//
    this._isInited = true;
};
/***
 * 
 */
KDatePicker.prototype._createTopContainer = function(){
    var _this = this;
    var html = '<div class="' + this._cssClass.DTP + '"><a class="' + this._cssClass.PRE + '" href="javascript:void(0);">&lt;</a><a class="' + this._cssClass.NEXT + '" href="javascript:void(0);">&gt;</a></div>';
    var $dom = $(html).appendTo(document.body).hide();
    this._dom = $dom.get(0);
    this.layout();
    //
    //$dom.bind("click", this._selectHandler);
    $dom.bind("click", function(){
        _this._selectHandler.apply(_this, arguments);
    });
    $dom.find(">a").eq(0).bind("click", function(){
        _this._showPrevPage.apply(_this, arguments);
    }).end().eq(1).bind("click", function(){
        _this._showNextPage.apply(_this, arguments);
    });
    //
};
/**
 * 
 * @param {Event} event jQuery Event
 */
KDatePicker.prototype._selectHandler = function(event){
    if (!event || !event.target) {
        return;
    }
//	//KDatePicker added by zy
//	if(this._opts.referpicker){
//		this._opts.referpicker._input.select();
//	}
    event.preventDefault();
    //event.stopPropagation();
    var $target = $(event.target);
    if ($target.is("a") && $target.parent().is("td")) {
        $(this._input).val($target.text());
        //
        $(this._dom).find("table tbody td a").removeClass(this._cssClass.S);
        $target.addClass(this._cssClass.S);
        var $strong = $target.parents("table").eq(0).parent().prev("div").eq(0).find("strong:first");
        var cDate = this._customDate($strong.data("date"));
        var date = new Date(cDate.y, cDate.m - 1, parseInt($target.text(), 10));
        this._opts.date = date;
        this.hide();
        $(this._input).val(this.formatDate(date, this._opts.format));
        KEvent.trigger(this, "selected", this, new Date(date.getTime()));
    } else {
        return;
    }
};
/**
 * 
 * @param {Event} event jQuery Event
 */
KDatePicker.prototype._showPrevPage = function(event){
    //event.stopPropagation();
    event.preventDefault();
    var month = this._opts.month;
    var currentFirst = this._firstMonthOfPage();
    var prevFirst = this._prevMonth(currentFirst, this._opts.month);
    this._updateCalender(prevFirst, month);
};
/**
 * 
 * @param {Event} event jQuery Event
 */
KDatePicker.prototype._showNextPage = function(event){
    //event.stopPropagation();
    event.preventDefault();
    var month = this._opts.month;
    var currentFirst = this._firstMonthOfPage();
    var nextFirst = this._nextMonth(currentFirst, this._opts.month);
    this._updateCalender(nextFirst, month);
};
/**
 * 
 * @param {Date} firstMonth
 * @param {Integer} month 
 */
KDatePicker.prototype._updateCalender = function(firstMonth, month){
    var $tables = $(this._dom).find(">div>div>table");
    var rows = this._calenderRows(firstMonth, month);
    for (var index = 0; index < month; index++) {
        this._updateMonth($tables.get(index), (index === 0 ? firstMonth : this._nextMonth(firstMonth, index)), rows);
    }
    this._setDate(this._opts.date);
    if (this._isPicker(this._opts.referpicker)) {
        var referDate = this._opts.referpicker.getDate(false);
        this._setDate(referDate, true);
    }
};
/**
 * 
 * @param {HTMLElement} parent
 * @param {Date} date
 */
KDatePicker.prototype._createOne = function(parent, date, rows){
    this._createTableContainer(parent, true, date);
    $(this._dom).find(">div:first>div").eq(1).append(this._createTableHtml(date, rows));
};
/**
 * 
 * @param {HTMLElement} parent
 * @parsm {Integer}  multi
 * @param {Date} date
 */
KDatePicker.prototype._createMulti = function(parent, multi, date, rows){
    this._createOne(parent, date, rows);
    var temp = "";
    for (var index = 1; index < multi; index++) {
        temp = this._nextMonth(date, index);
        this._createTableContainer(parent, false, temp);
        $(this._dom).find(">div:eq(" + index + ")>div").eq(1).append(this._createTableHtml(temp, rows));
    }
};
/**
 * 
 * @param {HTMLElement} parent
 * @param {Boolean} isLeft
 * @param {Date} date 
 */
KDatePicker.prototype._createTableContainer = function(parent, isLeft, date){
    date = this._customDate(date);
    var html = [('<div class="' + this._cssClass[isLeft ? "WL" : "WR"] + '">')];
    html.push('<div class="' + this._cssClass.H + '"><strong>' + ((date && date.orig) ? (date.y + "" + date.m + "") : "&nbsp;") + '</strong></div>');
    html.push('<div class="' + this._cssClass.C + '"></div>');
    html.push('</div>');
    $(parent).append(html.join(""));
    var $divs = $(parent).find(">div");
    $divs.eq($divs.length - 1).find(">div>strong").eq(0).data("date", date.orig);
};
/**
 *tableHtml
 * @param {Date}date
 * @return {String}
 */
KDatePicker.prototype._createTableHtml = function(date, rows){
    var html = ["<table>"];
    html.push(this._createTheadHtml());
    html.push(this._createTbodyHtml(date, rows));
    html.push("</table>");
    return html.join("");
};
/**
 *theadHtml
 * @param {Date}date
 * @return {String}
 */
KDatePicker.prototype._createTheadHtml = function(){
    var k = this._cssClass.WKE;
    return '<thead><tr><th class="' + k + '"></th><th></th><th></th><th></th><th></th><th></th><th class="' + k + '"></th></tr></thead>';
};
/**
 *tbodyHtml
 * @param {Date}date
 * @return {String}
 */
KDatePicker.prototype._createTbodyHtml = function(date, rows){
    var html = ["<tbody>"];
    html.push(this._createTbodyInnerHtml(date, rows));
    html.push("</tbody>");
    return html.join("");
};
/**
 *tbodyinnerHtml
 * @param {Date}date
 * @return {String}
 */
KDatePicker.prototype._createTbodyInnerHtml = function(date, rows){
    var now = new Date();
    var today = this._customDate(now);
    var current = this._customDate(date);
    var min = this._customDate(this._opts.min), max = this._customDate(this._opts.max);
    var first = this._firstDayOfMonth(current), last = this._lastDayOfMonth(current);
    //
    var todayInMonth = (today.y === first.y && today.m === first.m);
    var minInMonth = (min && min.orig) ? (min.y === first.y && min.m === first.m) : false;
    var maxInMonth = (max && max.orig) ? (max.y === first.y && max.m === first.m) : false;
    var todayInMinOrMax = (!min || (min && min.orig && this._compareCustomDate(today, min) >= 0)) && (!max || (max && max.orig && this._compareCustomDate(today, max) <= 0));
    var lessThanMinMonth = !!(min && min.orig && this._compareCustomDate(current, min) < 0);
    var moreThanMaxMonth = !!(max && max.orig && this._compareCustomDate(current, max) > 0);
    var html = ["<tr>"];
    var temp = "";
    var rowCounter = 1;
    var addtionRows = 0;
    //
    for (var wIndex = 0; wIndex < first.w; wIndex++) {
        html.push("<td>&nbsp;</td>");
    }
    for (var dIndex = first.d; dIndex <= last.d; dIndex++) {
        //
        if (todayInMonth && today.d === dIndex) {
            temp = todayInMinOrMax ? ('<td><a href="javascript:void(0);"  class="' + this._cssClass.CUR + '">' + dIndex + '</a></td>') : ('<td><div class="' + this._cssClass.CUR + '">' + dIndex + '</div></td>');
        } else {
            if (minInMonth && maxInMonth) {
                temp = (dIndex >= min.d && dIndex <= max.d) ? ('<td><a href="javascript:void(0);">' + dIndex + '</a></td>') : ('<td>' + dIndex + '</td>');
            } else if (minInMonth) {
                temp = (dIndex >= min.d) ? ('<td><a href="javascript:void(0);">' + dIndex + '</a></td>') : ('<td>' + dIndex + '</td>');
            } else if (maxInMonth) {
                temp = (dIndex <= max.d) ? ('<td><a href="javascript:void(0);">' + dIndex + '</a></td>') : ('<td>' + dIndex + '</td>');
            } else {
                if (lessThanMinMonth || moreThanMaxMonth) {
                    temp = '<td>' + dIndex + '</td>';
                } else {
                    temp = '<td><a href="javascript:void(0);">' + dIndex + '</a></td>';
                };
                
            }
        }
        //
        html.push(temp);
        //
        if ((first.w + (dIndex - 1)) % 7 === 6) {
            if (dIndex === last.d) {
                html.push("</tr>")
            } else {
                html.push("</tr><tr>")
                rowCounter++;
            }
        }
    }
    for (wIndex = last.w; wIndex < 6; wIndex++) {
        html.push("<td>&nbsp;</td>");
    }
    html.push((last.w === 6) ? "" : "</tr>")
    addtionRows = rows - rowCounter;
    for (wIndex = 0; wIndex < addtionRows; wIndex++) {
        html.push("<tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>");
    }
    //
    return html.join("");
};
/**
 *
 * @param {Date} date
 * @return {CustomDate}  CustomDateundefined
 */
KDatePicker.prototype._customDate = function(date){
    if (this._isDateObject(date)) {
        var obj = {
            y: date.getFullYear(),
            m: date.getMonth() + 1,
            d: date.getDate(),
            w: date.getDay(),
            orig: date
        }
        return obj;
    }
};
/***
 * CustomDate
 * @param {CustomDate} cdateA
 * @param {CustomDate} cdateB
 * @return 0, cdateA<cdateBcdateA>cdateB
 */
KDatePicker.prototype._compareCustomDate = function(cdateA, cdateB){
    return (cdateA.y - cdateB.y) || (cdateA.m - cdateB.m) || (cdateA.d - cdateB.d) || 0;
};
/***
 * CustomDate
 * @param {CustomDate} cdateA
 * @param {CustomDate} cdateB
 * @return 0, cdateA<cdateBcdateA>cdateB
 */
KDatePicker.prototype._compareMonth = function(cdateA, cdateB){
    return (cdateA.y - cdateB.y) || (cdateA.m - cdateB.m) || 0;
};
/**
 * 
 * @param {CustomDate} date
 * @return {CustomDate}
 */
KDatePicker.prototype._firstDayOfMonth = function(date){
    var first = new Date(date.y, date.m - 1, 1);
    return this._customDate(first);
};
/**
 * 
 * @param {CustomDate} date  CustomDate this._customDate()
 * @return {CustomDate}
 */
KDatePicker.prototype._lastDayOfMonth = function(date){
    var next = new Date(date.y, date.m, 1);
    var last = new Date(next.getTime() - 86400000);// 86400000=24*60*60*1000
    return this._customDate(last);
};
/**
 * N
 * @param {Date} date
 * @param {Integer} step 1
 * @param {Date}
 */
KDatePicker.prototype._nextMonth = function(date, step){
    step = (typeof step !== "number" || isNaN(step)) ? 1 : step;
    date = this._customDate(date);
    return new Date(date.y, (date.m - 1) + step, 1);
};
/**
 * N
 * @param {Date} date
 * @param {Integer} step 1
 * @param {Date}
 */
KDatePicker.prototype._prevMonth = function(date, step){
    step = (typeof step !== "number" || isNaN(step)) ? 1 : step;
    date = this._customDate(date);
    return new Date(date.y, (date.m - 1) - step, 1);
};
/**
 *KDatePicker
 * @param {Object} obj
 */
KDatePicker.prototype._isPicker = function(obj){
    return (obj && obj.isKClassO && obj.isKClassO === true && obj.className && obj.className === "KDatePicker");
};
/**
 *
 * @param {HTMLElement} parent
 * @param {String} html
 */
KDatePicker.prototype._createTip = function(parent, html){
    var k = this._cssClass.TIP;
    html = (html == null && html !== "") ? ("<div class='" + k + "' style='display:none'></div>") : ("<div class='" + k + "'>" + html + "</div>");
    $(parent).append(html);
};
/**
 * 
 * @param {Date} date
 * @return {Integer}
 */
KDatePicker.prototype._monthRows = function(date){
    date = this._customDate(date);
    var first = this._firstDayOfMonth(date);
    var last = this._lastDayOfMonth(date);
    return Math.ceil((last.d + first.w + (6 - last.w)) / 7);
};
/**
 * 
 * @param {Object} firstMonth  
 * @param {Object} n 
 * @return {Integer} 46
 */
KDatePicker.prototype._calenderRows = function(firstMonth, n){
    var rows = this._monthRows(firstMonth), temp, date;
    for (var index = 1; index < n; index++) {
        date = this._nextMonth(firstMonth, index);
        temp = this._monthRows(date);
        rows = (temp > rows) ? temp : rows;
    };
    
    return ((rows < 4 || rows > 6) ? 6 : rows);
};
/**
 * 
 * @param {Date} date
 * @param {Boolean} isRefer false
 */
KDatePicker.prototype._setDate = function(date, isRefer){
    var _this = this;
    var cDate = this._customDate(date);
    if (!cDate || !cDate.orig) {
        return;
    }
    isRefer = (isRefer === true) ? true : false;
    var strongElem = "";
    var klass = this._cssClass[isRefer ? "E" : "S"];
    //
    $(this._dom).find("div>div>strong").each(function(){
        if (_this._compareMonth(cDate, _this._customDate($(this).data("date"))) === 0) {
            strongElem = $(this).get(0);
            return false;
        }
    });
    //
    if (strongElem) {
        var $elems = $(strongElem).parent().next("div").eq(0).find("table td");
        if ($elems.length) {
            $elems.each(function(){
                if (cDate.d === parseInt($(this).text(), 10)) {
                    $(_this._dom).find("table td a").removeClass(klass);
                    $(_this._dom).find("table td div").removeClass(klass);
                    if (isRefer) {
                        var $kid  = $(this).find("a");
						if($kid.length){
							$kid.addClass(klass);
						}else{
							$kid  = $(this).find("div");
							if($kid.length){
								$kid.addClass(klass);
							}else{
                                $(this).html("<div class='" + klass + "'>" + $(this).text() + "</div>");
							}
						} 
                    } else {
						$(this).find("a").addClass(klass);
                        _this._opts.date = date;
                        $(_this._input).val(_this.formatDate(date, _this._opts.format));
                    }
                    return false;
                }
            });
        }
    }
};
/**
 * 
 * @param {HTMLElement} table  Table
 * @param {Date} date Date
 * @param {Integer} rows 
 */
KDatePicker.prototype._updateMonth = function(table, date, rows){
    var tbodyInner = this._createTbodyInnerHtml(date, rows);
    $(table).find("tbody").html(tbodyInner);
    var strongElem = $(table).parent().prev("div").find("strong").get(0);
    this._updateMonthTitle(strongElem, date)
};
/**
 * 
 * @param {HTMLElement} element
 * @param {Date} date
 */
KDatePicker.prototype._updateMonthTitle = function(element, date){
    var cDate = this._customDate(date);
    $(element).html(cDate.y + "" + cDate.m + "").data("date", date);
};
/**
 * 
 * @return {Date}
 */
KDatePicker.prototype._firstMonthOfPage = function(){
    var firstStrong = $(this._dom).find(">div>div>strong").get(0);
    return $(firstStrong).data("date");
};
/**
 * Date
 * @param {String} txt
 * @return {Date}
 */
KDatePicker.prototype._dateParser = function(txt){
    txt = txt.replace(/[^\d]+/g, ",");
    var date = new Date(txt);
    //window.alert(this._isDateObject(date) );
    if (!this._isDateObject(date)) {
        //"yyyy-mm-dd"
        var arr = txt.split(",");
        date = new Date(parseInt(arr[0], 10), parseInt(arr[1], 10) - 1, parseInt(arr[2], 10));
    };
    
    return (this._isDateObject(date) ? date : undefined);
};
/**
 *  this._opts.date  this._opts.referpicker
 * @return {Date}
 */
KDatePicker.prototype._firstMonth = function(){
    var selected = this._isDateObject(this._opts.date) ? this._opts.date : undefined;
    var refered = (this._isPicker(this._opts.referpicker) && this._opts.referpicker.getDate) ? this._opts.referpicker.getDate(false) : undefined;
    refered = this._isDateObject(refered) ? refered : undefined;
    var firstMonth;
    //
    if (selected && refered) {
        var cSelected = this._customDate(selected);
        var cRefered = this._customDate(refered);
        if (cSelected.y === cRefered.y && Math.abs(cSelected.m - cRefered.m) < this._opts.month) {
            firstMonth = new Date((cSelected.m > cRefered.m) ? refered.getTime() : selected.getTime());
        } else {
            firstMonth = new Date(selected.getTime());
        }
    } else if (selected) {
        firstMonth = new Date(selected.getTime());
    } else if (refered) {
        firstMonth = new Date(refered.getTime());
    } else {
        firstMonth = new Date();
    }
    return firstMonth;
};
/**
 * 
 * @param {Integer} num
 * @param {Integer} n
 */
KDatePicker.prototype._prefixZero = function(num, n){
    while ((num + "").length < n) {
        num = "0" + num;
    }
	return num;
};
/***
 * 
 * @param {Date} date
 */
KDatePicker.prototype._setMin = function(date){
    if (this._isDateObject(date)) {
        var cDate = this._customDate(date);
		//
		var cOldMin = this._customDate(this._opts.min);
		if(cOldMin && this._compareCustomDate(cDate, cOldMin)===0){
			return;
		}
        //
        var month = this._opts.month;
        var cFirstMonth = this._customDate(this._firstMonthOfPage());
        //
        var cDateTotalMonths = cDate.y * 12 + cDate.m;
        var cFirstMonthTotalMonths = cFirstMonth.y * 12 + cFirstMonth.m;
        //
        var isUpdateUI = (cDateTotalMonths >= cFirstMonthTotalMonths && cDateTotalMonths <= cFirstMonthTotalMonths + month - 1) ? true : false;
		//
        this._opts.min = date;
        if (isUpdateUI) {
			this._updateCalender(cFirstMonth.orig, month);
        }
    }
};


/*
  
 pengkun  gongyong  zhangshiqi
 1.0
 2010-02-05
 2010-11-24 15:40
 ============================================
 
 opt# 1007201600 by zhangshiqi
 afteresizeresizecontentsize
 bug# 1011231847 by zhangsq
 
 bug# 1011241540
 dragrangeBug
 */
var KDialog = KClass.create("KDialog", KWidget);
KDialog.conf = {
    //@uncrunch
    classNamePrefix : "_dlg"
    //@uncrunch
    ,classNameArr : ",t,tc,tb,tbi,tba,tbr,tbc,c,rh,rn,rh,re,rh,rs,rh,rw,rh,rse,min".split(",")
    //@uncrunch
    ,CLASSNAME  : {}
};
$.each(KDialog.conf.classNameArr,
    function(i, val)
    {
        KDialog.conf.CLASSNAME[(val == '' ? 'A' : val.toUpperCase())] = KDialog.conf.classNamePrefix + (val == '' ? '' : '_' + val);
    }
);

/**
 * 
 * @param container Node
 * @param opts KDialogOptions
 * @uncrunch
 */
KDialog.initialize = function(container, opts)
{
    var _this = this;

    this._jDom = $(container).css('display', 'block');
    this._dom = this._jDom[0];

    this._opts = KTools.copyOptions(opts, KDialogOptions);

    //
    this._minSize = this.options().minsize ? this.options().minsize : new KSize(0,0);

    this.setTheme(this.options().theme);
    this._getDom();

    if (!this.options().userstyle) {
        this._buildCss();
    }
    if (this.options().title) {
        this._titleTxt.html(this.options().title);
    }

    //
    this._setHeaderDrag(this.options().dragable);

    if (this.options().resizeable) {
        this._buildResize();
        this._setResizeDomState(true);
    }
    else {
        this._setResizeDomState(false);
    }

    if (this.options().size) {
        this.resize(this.options().size);
    }
    //bgiframe
    if ($.browser.msie && $.browser.version == "6.0" && this.options().bgiframe) {
        this._jDom.bgiframe();
    }

    //dom
    this._setBtnDomState(this.options().minbtn, this.options().maxbtn, false, this.options().closebtn);

    //
    KEvent.bind(this._btnMin.get(0), "click", function(evt) {
        _this.setState(KDialogState.MINI);
    });
    KEvent.bind(this._btnMax.get(0), "click", function(evt) {
        _this.setState(KDialogState.MAX);
    });
    KEvent.bind(this._btnRet.get(0), "click", function(evt) {
        _this.setState(KDialogState.NORMAL);
    });
    KEvent.bind(this._btnClose.get(0), "click", function(evt) {
        _this.setState(KDialogState.CLOSE);
    });

    this._titleContainer.dblclick(function() {
        if (_this._state == KDialogState.NORMAL && _this.options().maxbtn) {
            _this.setState(KDialogState.MAX);
        }
        else if (_this._state == KDialogState.MINI || _this._state == KDialogState.MAX) {
            _this.setState(KDialogState.NORMAL);
        }
    });

    if (this.options().autopen) {
        this.open();
    }
    else {
        this.hide();
    }

    this._jDom.bind("focus", function() {
        KEvent.trigger(_this, "focus", _this);
    });
};

/**
 * 
 * @return String 
 * @uncrunch
 */
KDialog.prototype.version = function()
{
    return "1.0";
};

/**
 * 
 * @return String
 * @uncrunch
 */
KDialog.prototype.cnname = function()
{
    return "";
};

/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KDialog.prototype.dependent = function()
{
    return [KWidget, jQuery, KDialogOptions,KDialogOpenOptions, KDialogState,KEvent,KTools];
};

/**
 *  Dom 
 * @return Node
 * @uncrunch
 */
KDialog.prototype.content = function()
{
    return this._contentContainer.get(0);
};

/**
 * 
 * @param opts KDialogOptions
 * @uncrunch
 */
KDialog.prototype.setOptions = function(opts)
{
    var _this = this;
    var diffOpts = KTools.compareOptions(this._opts, opts);
    $.each(diffOpts, function(name, value) {
        if (name == 'theme') {
            _this.setTheme(value);
        }
        else if (name == 'title') {
            _this._titleDom.html(value);
        }
        else if (name == 'bgiframe') {

        }
        else if (name == "dragable") {
            _this._setHeaderDrag(value);
        }
        else if (name == "resizeable") {
            _this._buildResize();
            _this._setResizeDomState(value);
        }
        else if (name == "size") {
            _this._jDom.css({width : value.width,height : value.height});
        }
        else if (name == "minbtn") {
            _this._showOrHide(_this._btnMin, value);
        }
        else if (name == "maxbtn") {
            _this._showOrHide(_this._btnMax, value);
        }
        else if (name == "closebtn") {
            _this._showOrHide(_this._btnClose, value);
        }
        else if (name == "dragrange") {
            //bug# 1011231847 fix begin
            _this._opts.dragrange = value;
            //bug# 1011241540 fix being
            //delete by zhangsq
            //_this._resetBounds();
            //bug# 1011241540 fix end
            //bug# 1011231847 fix end
            //resize
            /*_this.setState(KDialogState.CLOSE);
            _this.open();*/
        }
        else if (name == "minsize") {
            _this._minSize = value;
        }
    });
    //bug# 1011231847 fix begin
    if(opts.dragrange)
    {
        //bug# 1011241540 fix begin
        // add by zhangsq
        this._resetBounds();
        //bug# 1011241540 fix end
    }
    //bug# 1011231847 fix end
    this._opts = KTools.copyOptions(this._opts, opts);
};

/**
 * 
 */
KDialog.prototype._resetBounds = function()
{
    //
    var _pBounds = this._getParentBounds();
    //
    var _cBounds = KTools.getBounds(this._dom, {border : true});
    //
    var _nBounds = new KBounds(_cBounds.min, new KPoint(_cBounds.min.x + this.options().minsize.width, _cBounds.min.y + this.options().minsize.height));
    //
    var _pSize = {width : _pBounds.max.x - _pBounds.min.x, height : _pBounds.max.y - _pBounds.min.y};
    //
    var _cSize = {width : _cBounds.max.x - _cBounds.min.x, height : _cBounds.max.y - _cBounds.min.y};
    //
    var _eBounds = new KBounds(_cBounds.min, new KPoint(0, 0));
    var _rxSign = false;
    var _rySign = false;
    var _css = {};
    if(_pSize.width < _cSize.width)
    {
        _rxSign = true;
        if(_pSize.width < (this.options().minsize.width + parseInt(this._jDom.css('border-left-width')) + parseInt(this._jDom.css('border-right-width'))))
        {
            _css.width = (_pSize.width - parseInt(this._jDom.css('border-left-width')) - parseInt(this._jDom.css('border-right-width'))) + 'px';
            _eBounds.max.x = _cBounds.min.x + (_pSize.width - parseInt(this._jDom.css('border-left-width')) - parseInt(this._jDom.css('border-right-width')));
        }
        else
        {
            /*_css.width = this.options().minsize.width + 'px';
            _eBounds.max.x = _cBounds.min.x + this.options().minsize.width;*/
            _css.width = (_pSize.width - parseInt(this._jDom.css('border-left-width')) - parseInt(this._jDom.css('border-right-width'))) + 'px';
            _eBounds.max.x = _cBounds.min.x + (_pSize.width - parseInt(this._jDom.css('border-left-width')) - parseInt(this._jDom.css('border-right-width')));
        }
    }
    if(_pSize.height < _cSize.height)
    {
        _rySign = true;
        if(_pSize.height < (this.options().minsize.height + parseInt(this._jDom.css('border-top-width')) + parseInt(this._jDom.css('border-bottom-width'))))
        {
            _css.height = (_pSize.height - parseInt(this._jDom.css('border-top-width')) - parseInt(this._jDom.css('border-bottom-width'))) + 'px';
            _eBounds.max.y = _cBounds.min.y + (_pSize.height - parseInt(this._jDom.css('border-top-width')) - parseInt(this._jDom.css('border-bottom-width')));
        }
        else
        {
            /*_css.height = this.options().minsize.height + 'px';
            _eBounds.max.y = _cBounds.min.y + this.options().minsize.height;*/
            _css.height = (_pSize.height - parseInt(this._jDom.css('border-top-width')) - parseInt(this._jDom.css('border-bottom-width'))) + 'px';
            _eBounds.max.y = _cBounds.min.y + (_pSize.height - parseInt(this._jDom.css('border-top-width')) - parseInt(this._jDom.css('border-bottom-width')));
        }
    }
    if((_rxSign ? _eBounds.max.x : _cBounds.max.x) > _pBounds.max.x)
    {
        if(((_rxSign ? _eBounds.max.x : _cBounds.max.x) - (_rxSign ? _eBounds.min.x : _cBounds.min.x)) < _pSize.width)
        {
            _css.left = (_pBounds.max.x - (_rxSign ? (_eBounds.max.x - _eBounds.min.x + parseInt(this._jDom.css('border-left-width')) + parseInt(this._jDom.css('border-right-width'))) : (_cBounds.max.x - _cBounds.min.x + parseInt(this._jDom.css('border-left-width')) + parseInt(this._jDom.css('border-right-width'))))) + 'px';
        }
        else
        {
            _css.left = _pBounds.min.x + 'px';
        }
    }
    if((_rySign ? _eBounds.max.y : _cBounds.max.y) > _pBounds.max.y)
    {
        if(((_rySign ? _eBounds.max.y : _cBounds.max.y) - (_rySign ? _eBounds.min.y : _cBounds.min.y)) < _pSize.height)
        {
            _css.top = (_pBounds.max.y - (_rySign ? (_eBounds.max.y - _eBounds.min.y + parseInt(this._jDom.css('border-top-width')) + parseInt(this._jDom.css('border-bottom-width'))) : (_cBounds.max.y - _cBounds.min.y + parseInt(this._jDom.css('border-top-width')) + parseInt(this._jDom.css('border-bottom-width'))))) + 'px';
        }
        else
        {
            _css.top = _pBounds.min.y + 'px';
        }
    }
    this._jDom.css(_css);
    KEvent.trigger(this, "resize", this, undefined, this._getContentSize());

    _rxSign = false;
    _rySign = false;
};

/**
 * 
 * @param scheme
 * @uncrunch
 */
KDialog.prototype.setTheme = function(scheme)
{
    var oldTheme = this._theme;
    this._theme = scheme;
    this._updateClass(this._jDom, oldTheme, KDialog.conf.CLASSNAME.A);
    this._updateClass(this._titleContainer, oldTheme, KDialog.conf.CLASSNAME.T);
    this._updateClass(this._titleDom, oldTheme, KDialog.conf.CLASSNAME.TC);
    this._updateClass(this._btnContainer, oldTheme, KDialog.conf.CLASSNAME.TB);
    this._updateClass(this._btnMin, oldTheme, KDialog.conf.CLASSNAME.TBI);
    this._updateClass(this._btnMax, oldTheme, KDialog.conf.CLASSNAME.TBA);
    this._updateClass(this._btnRet, oldTheme, KDialog.conf.CLASSNAME.TBR);
    this._updateClass(this._btnClose, oldTheme, KDialog.conf.CLASSNAME.TBC);
    this._updateClass(this._contentContainer, oldTheme, KDialog.conf.CLASSNAME.C);
    this._updateClass(this._handleN, oldTheme, KDialog.conf.CLASSNAME.RH);
    this._updateClass(this._handleN, oldTheme, KDialog.conf.CLASSNAME.RN);
    this._updateClass(this._handleE, oldTheme, KDialog.conf.CLASSNAME.RH);
    this._updateClass(this._handleE, oldTheme, KDialog.conf.CLASSNAME.RE);
    this._updateClass(this._handleS, oldTheme, KDialog.conf.CLASSNAME.RH);
    this._updateClass(this._handleS, oldTheme, KDialog.conf.CLASSNAME.RS);
    this._updateClass(this._handleW, oldTheme, KDialog.conf.CLASSNAME.RH);
    this._updateClass(this._handleW, oldTheme, KDialog.conf.CLASSNAME.RW);
    this._updateClass(this._handleSE, oldTheme, KDialog.conf.CLASSNAME.RH);
    this._updateClass(this._handleSE, oldTheme, KDialog.conf.CLASSNAME.RSE);
};

/**
 * @param dom jQuery
 * @param oldTheme  String
 * @param className     String
 */
KDialog.prototype._updateClass = function(dom, oldTheme, className)
{
    if (dom) {
        dom.removeClass(this._getClassName(className, oldTheme)).addClass(this._getClassName(className));
    }
}

/**
 * 
 * @uncrunch
 */
KDialog.prototype.finalize = function()
{
    //this._super.finalize.apply(this);
    KWidget.prototype.finalize.apply(this);
};

/**
 * 
 * @param opts KDialogOpenOptions
 * @uncrunch
 */
KDialog.prototype.open = function(opts)
{
    this._openOptions = KTools.copyOptions(opts, KDialogOpenOptions);

    if (!this._state || this._state == KDialogState.HIDE || this._state == KDialogState.CLOSE) {
        this._jDom.show();
        this._state = KDialogState.NORMAL;

        var pBounds = this._getParentBounds();
        var maxWidth = pBounds.size().width;
        var maxHeight = pBounds.size().height;
        var size = this._openOptions.size ? this._openOptions.size : this.options().size;
        if (!size) {
            this._jDom.css({width : maxWidth > 300 ? 300 : maxWidth});
            //bug# 1011231847 fix begin
            size = new KSize(300, 300);
            //bug# 1011231847 fix end
        }
        else {
            size.width = maxWidth > size.width ? size.width : maxWidth;
            size.height = maxHeight > size.height ? size.height : maxHeight;
            this._jDom.css({width : size.width,height : size.height})
        }
        if (this._openOptions.pos && pBounds.contains(this._openOptions.pos)) {
            var position = this._openOptions.pos;
        }
        else {
            var position = new KPoint(Math.round(pBounds.mid().x - size.width / 2), Math.round(pBounds.mid().y - size.height / 2));
        }
        this.moveTo(position);

        this._setBtnDomState(this.options().minbtn, this.options().maxbtn, false, this.options().closebtn);

        if (this.options().resizeable) {
            this._buildResize();
            this._setResizeDomState(true);
        }
        else {
            this._setResizeDomState(false);
        }

        //css
        $("." + this._getClassName(KDialog.conf.CLASSNAME.TB)).css("zoom", "1");
        KEvent.trigger(this, "open", this);
    }
};

/**
 * 
 * @uncrunch
 */
KDialog.prototype.close = function()
{
    this.setState(KDialogState.CLOSE);
};

/**
 * 
 * @uncrunch
 */
KDialog.prototype.hide = function()
{
    this.setState(KDialogState.HIDE);
};

/**
 * 
 */
KDialog.prototype._min = function()
{
    //
    this._recordNormalState();

    //css
    this._jDom.addClass(this._getClassName(KDialog.conf.CLASSNAME.MIN));

    //
    this._setHeaderDrag(this.options().dragable);

    this._jDom.css({"left" : this._normalPoint.x,"top" : this._normalPoint.y});
    this._jDom.css({'width':(this._minSize.width > 0 ? this._minSize.width : (this._titleDom.outerWidth() + this._btnContainer.outerWidth())) + 'px','height':'auto'});

    //
    this._setBtnDomState(false, this.options().maxbtn, true, this.options().closebtn);

    //resizedom
    this._setResizeDomState(false);
};

/**
 * 
 */
KDialog.prototype._max = function()
{
    //class
    if (this._state == KDialogState.MINI) {
        this._jDom.removeClass(this._getClassName(KDialog.conf.CLASSNAME.MIN));
    }


    //
    this._recordNormalState();


    var pBounds = this._getParentBounds();
    this._jDom.css({"left" : pBounds.min.x,"top" : pBounds.min.y});

    //    alert(pBounds.max.x - pBounds.min.x);

    var rb = this._getRB();
    this._jDom.css({"width":pBounds.max.x - pBounds.min.x - rb.right,"height": pBounds.max.y - pBounds.min.y - rb.bottom});

    //
    this._setHeaderDrag(false);

    //
    this._setBtnDomState(this.options().minbtn, false, true, this.options().closebtn);

    //resize
    this._setResizeDomState(false);
};

/**
 * 
 */
KDialog.prototype._restore = function()
{
    if (this._state == KDialogState.MINI) {
        this._jDom.removeClass(this._getClassName(KDialog.conf.CLASSNAME.MIN));
    }

    this._setHeaderDrag(this.options().dragable);
    this._moveAndResize(this._normalPoint, this._normalSize);

    //
    this._setBtnDomState(this.options().minbtn, this.options().maxbtn, false, this.options().closebtn);

    //resize
    this._setResizeDomState(this.options().resizeable);
};

/**
 * 
 * @return contentsize KSize 
 */
KDialog.prototype._getContentSize = function()
{
    var _width = this._contentContainer.innerWidth();
    var _height = this._jDom.innerHeight() - parseInt(this._jDom.css('padding-bottom')) - parseInt(this._jDom.css('padding-top')) - this._titleContainer.outerHeight() - parseInt(this._contentContainer.css('padding-top')) - parseInt(this._contentContainer.css('padding-bottom'));
    return new KSize(_width, _height);      
};

/**
 * 
 */
KDialog.prototype._hide = function()
{
    this._jDom.hide();
}

/**
 * 
 */
KDialog.prototype._close = function()
{
    KEvent.trigger(this, "close", this);
    this._hide();
}

/**
 * 
 * @uncrunch
 */
KDialog.prototype.state = function()
{
    return this._state;
};

/**
 * 
 * @param state KDialogState
 * @uncrunch
 */
KDialog.prototype.setState = function(state)
{
    //
    if (state == this._state) {
        return;
    }
    //
    switch (state) {
        case KDialogState.NORMAL :
            this._restore();
            break;
        case KDialogState.MINI :
            this._min();
            break;
        case KDialogState.MAX :
            this._max();
            break;
        case KDialogState.CLOSE :
            this._close();
            break;
        case KDialogState.HIDE :
            this._hide();
            break;
        default :
            break;
    }

    //
    this._state = state;
};

/**
 * 
 * @param zindex Integer
 * @uncrunch
 */
KDialog.prototype.setZIndex = function(zindex)
{
    this._jDom.css("zIndex", zindex);
};

/**
 * 
 * @param size KSize
 * @uncrunch
 */
KDialog.prototype.resize = function(size)
{
    if (size.width >= (this._minSize.width > 0 ? this._minSize.width : (this._titleDom.outerWidth() + this._btnContainer.outerWidth())))
    {
        this._jDom.width(size.width);
    }
    if (size.height >= (this._minSize.height > 0 ? this._minSize.height : this._titleContainer.outerHeight()))
    {
        this._jDom.height(size.height);
        //this._contentContainer.height(size.height - this._titleContainer.outerHeight() - parseInt(this._jDom.css('padding-top')) - parseInt(this._jDom.css('padding-bottom')) - parseInt(this._contentContainer.css('padding-top')));
    }
    KEvent.trigger(this, "resize", this, size, this._getContentSize());
};
/**
 * 
 * @param point KPoint
 * @uncrunch
 */
KDialog.prototype.moveTo = function(point)
{
    var dom = this._jDom;
    var pBounds = this._getParentBounds();

    var rb = this._getRB();

    if (point.x < pBounds.min.x) {
        point.x = pBounds.min.x;
    }
    if (point.y < pBounds.min.y) {
        point.y = pBounds.min.y;
    }
    if (point.x + dom.width() > pBounds.max.x - rb.right) {
        point.x = pBounds.max.x - dom.width() - rb.right;
    }
    if (point.y + dom.height() > pBounds.max.y - rb.bottom) {
        point.y = pBounds.max.y - dom.height() - rb.bottom;
    }

    this._jDom.css({left : point.x,top : point.y});

    //normal point
    if (this._state == KDialogState.MINI) {
        this._normalPoint = new KPoint(point.x, point.y);// KTools.getBounds(this._jDom.get(0)).min;
    }
};

/**
 * 
 * @uncrunch
 */
KDialog.prototype.layout = function()
{
    if (this._state == KDialogState.MAX) {
        this._max();
    }
}

/**
 * 
 * @param className String
 * @param theme String
 */
KDialog.prototype._getClassName = function(className, theme)
{
    if (!theme) {
        theme = this.theme();
    }
    return theme + className;
};

/**
 * DOM
 */
KDialog.prototype._getDom = function()
{
    //
    this._titleContainer = $('div:first', this._jDom);
    //
    this._titleDom = $('h3', this._titleContainer);
    //
    this._titleIcon = $('b', this._titleDom);
    //
    this._titleTxt = $('span', this._titleDom);
    //
    this._btnContainer = $('div', this._titleContainer);
    //
    this._btnMin = $('a[mfg="min"]', this._btnContainer);
    //
    this._btnRet = $('a[mfg="rst"]', this._btnContainer);
    //
    this._btnMax = $('a[mfg="max"]', this._btnContainer);
    //
    this._btnClose = $('a[mfg="cb"]', this._btnContainer);
    //
    this._contentContainer = this._titleContainer.next();
    //
    this._handleN = this._contentContainer.next();
    //
    this._handleE = this._handleN.next();
    //
    this._handleS = this._handleE.next();
    //
    this._handleW = this._handleS.next();
    //
    this._handleSE = this._handleW.next();
};
/**
 * CSS
 */
KDialog.prototype._buildCss = function()
{
    //begin
    this._jDom.addClass(this._getClassName(KDialog.conf.CLASSNAME.A));
    this._titleContainer.addClass(this._getClassName(KDialog.conf.CLASSNAME.T));
    this._titleDom.addClass(this._getClassName(KDialog.conf.CLASSNAME.TC));
    this._btnContainer.addClass(this._getClassName(KDialog.conf.CLASSNAME.TB));
    this._btnMin.addClass(this._getClassName(KDialog.conf.CLASSNAME.TBI));
    this._btnMax.addClass(this._getClassName(KDialog.conf.CLASSNAME.TBA));
    this._btnRet.addClass(this._getClassName(KDialog.conf.CLASSNAME.TBR));
    this._btnClose.addClass(this._getClassName(KDialog.conf.CLASSNAME.TBC));
    this._contentContainer.addClass(this._getClassName(KDialog.conf.CLASSNAME.C));
    this._handleN.addClass(this._getClassName(KDialog.conf.CLASSNAME.RH)).addClass(this._getClassName(KDialog.conf.CLASSNAME.RN));
    this._handleE.addClass(this._getClassName(KDialog.conf.CLASSNAME.RH)).addClass(this._getClassName(KDialog.conf.CLASSNAME.RE));
    this._handleS.addClass(this._getClassName(KDialog.conf.CLASSNAME.RH)).addClass(this._getClassName(KDialog.conf.CLASSNAME.RS));
    this._handleW.addClass(this._getClassName(KDialog.conf.CLASSNAME.RH)).addClass(this._getClassName(KDialog.conf.CLASSNAME.RW));
    this._handleSE.addClass(this._getClassName(KDialog.conf.CLASSNAME.RH)).addClass(this._getClassName(KDialog.conf.CLASSNAME.RSE));
    //end
};
/**
 * 
 */
KDialog.prototype._buildHeadDrag = function()
{
    var _this = this;

    //head
    var _left = 0;
    var _top = 0;
    this._buildDrag({
        dom : this._titleContainer
        ,drag : function(obj) {
            //var beginOffset = obj.beginOffset;
            var beginPoint = obj.beginPoint;
            var movePoint = obj.movePoint;
            _this.moveTo(new KPoint(movePoint.x - beginPoint.x + _left, movePoint.y - beginPoint.y + _top));
        }
        ,dragStart : function() {
            var offset = _this._jDom.offset();
            _left = offset.left;
            _top = offset.top;
        }
    });
};
/**
 * 
 */
KDialog.prototype._buildResize = function()
{
    this._handleSE.css("-moz-user-select", "none");
    this._handleN.css("-moz-user-select", "none");
    this._handleS.css("-moz-user-select", "none");
    this._handleW.css("-moz-user-select", "none");
    this._handleE.css("-moz-user-select", "none");


    this._buildDragForResize(this._handleSE, "corner");
    this._buildDragForResize(this._handleN, "top");
    this._buildDragForResize(this._handleS, "bottom");
    this._buildDragForResize(this._handleW, "left");
    this._buildDragForResize(this._handleE, "right");
};

/**
 * 
 * @param obj Object
 */
KDialog.prototype._buildDrag = function(obj)
{
    var dom = obj.dom;
    var drag = obj.drag;
    var dragStart = obj.dragStart || function() {
    };
    var dragEnd = obj.dragEnd || function() {
    };

    var beginOffset = null;
    var beginPoint = new KPoint(0, 0);

    var getCallbackParam = function(otherParma)
    {
        return $.extend({
            //@uncrunch
            beginOffset : beginOffset
            //@uncrunch
            ,beginPoint : beginPoint
        }, otherParma);
    };
    var docMouseMoveFunc = function(evt)
    {
        //_this.moveTo(new KPoint(evt.clientX - beginPoint.x, evt.clientY - beginPoint.y));
        drag(getCallbackParam({
            movePoint : new KPoint(evt.clientX, evt.clientY)
        }));
    };
    var docMouseUpFunc = function()
    {
        $(document)
                .unbind("mousemove", docMouseMoveFunc)
                .unbind("mouseup", docMouseUpFunc)
                ;
        dom.unbind("selectstart", headSelectStartFunc);

        dragEnd(getCallbackParam());
    };
    var headSelectStartFunc = function() {
        return false;
    };

    dom.mousedown(
            function(evt)
            {
                beginOffset = $(this).bind("selectstart", headSelectStartFunc).offset();
                beginPoint.x = evt.clientX;// - beginOffset.left;
                beginPoint.y = evt.clientY;// - beginOffset.top;

                dragStart(getCallbackParam());

                $(document)
                        .mousemove(docMouseMoveFunc)
                        .mouseup(docMouseUpFunc)
                        ;
            }
            );
};
/**
 * 
 * @param dom Node
 * @param flag Boolean
 */
KDialog.prototype._showOrHide = function(dom, flag)
{
    flag ? dom.show() : dom.hide();
};

/**
 * 
 */
KDialog.prototype._recordNormalState = function()
{
    if (KDialogState.NORMAL == this._state) {
        this._normalSize = new KSize(this._jDom.width(), this._jDom.height());
        this._normalPoint = KTools.getBounds(this._jDom.get(0)).min;
    }
};

/**
 * 
 * @param bool Boolean
 */
KDialog.prototype._setHeaderDrag = function(bool) {
    if (bool) {
        this._buildHeadDrag();
        this._titleContainer.css("cursor", "move");
    }
    else {
        this._titleContainer.unbind("mousedown");
        this._titleContainer.css("cursor", "default");
    }
};

/**
 * resizedom
 * @param flag Boolean
 */
KDialog.prototype._setResizeDomState = function(flag)
{
    this._showOrHide(this._handleSE, flag);
    this._showOrHide(this._handleN, flag);
    this._showOrHide(this._handleS, flag);
    this._showOrHide(this._handleW, flag);
    this._showOrHide(this._handleE, flag);
};

/**
 * minmaxrestoreclosedom
 * @param min Boolean
 * @param max Boolean
 * @param restore Boolean
 * @param close Boolean
 */
KDialog.prototype._setBtnDomState = function(min, max, restore, close)
{
    this._showOrHide(this._btnMin, min);
    this._showOrHide(this._btnMax, max);
    this._showOrHide(this._btnRet, restore);
    this._showOrHide(this._btnClose, close);
};

/**
 * resizedom
 * @param rdom  Node
 * @param type String
 */
KDialog.prototype._buildDragForResize = function(rdom, type) {
    var _this = this;

    var dom = this._jDom;
    var _width = 0;
    var _height = 0;
    var _body_cursor = null;

    this._buildDrag({
        //@uncrunch
        dom : rdom
        //@uncrunch
        ,drag : function(obj) {
            var beginOffset = obj.beginOffset;
            var beginPoint = obj.beginPoint;
            var movePoint = obj.movePoint;
            var pBounds = _this._getParentBounds();

            if ("corner" == type) {
                if (movePoint.x > pBounds.max.x) {
                    movePoint.x = pBounds.max.x;
                }

                if (movePoint.y > pBounds.max.y) {
                    movePoint.y = pBounds.max.y;
                }
                _this.resize(new KSize(_width + movePoint.x - beginPoint.x - (beginPoint.x - beginOffset.left) - $(window).scrollLeft(), _height + movePoint.y - beginPoint.y - (beginPoint.y - beginOffset.top) - $(document).scrollTop()));
            }
            else if ("top" == type) {
                if (movePoint.y >= pBounds.min.y) {
                    _this._moveAndResize(new KPoint(dom.offset().left, movePoint.y), new KSize(-1, _height - movePoint.y + beginPoint.y - (beginPoint.y - beginOffset.top) - $(document).scrollTop()), 'top');
                }
            }
            else if ("bottom" == type) {
                if (movePoint.y > pBounds.max.y) {
                    movePoint.y = pBounds.max.y;
                }
                _this.resize(new KSize(-1, _height + movePoint.y - beginPoint.y - (beginPoint.y - beginOffset.top) - $(document).scrollTop()));
            }
            else if ("left" == type) {
                if (movePoint.x >= pBounds.min.x) {
                    _this._moveAndResize(new KPoint(movePoint.x, dom.offset().top), new KSize(_width - movePoint.x + beginPoint.x - (beginPoint.x - beginOffset.left) - $(document).scrollLeft(), -1), 'left')
                }
            }
            else if ("right" == type) {
                if (movePoint.x > pBounds.max.x) {
                    movePoint.x = pBounds.max.x;
                }
                _this.resize(new KSize(_width + movePoint.x - beginPoint.x - (beginPoint.x - beginOffset.left) - $(document).scrollLeft(), -1));
            }
        }
        //@uncrunch
        ,dragStart : function() {
            _width = dom.width();
            _height = dom.height();

            var body = $(document.body);
            _body_cursor = body.css("cursor");
            if ("corner" == type) {
                body.css("cursor", "se-resize");
            }
            else if ("right" == type) {
                body.css("cursor", "e-resize");
            }
            else {
                body.css("cursor", "s-resize");
            }
        }
        //@uncrunch
        ,dragEnd : function() {
            $(document.body).css("cursor", "");
        }
    });
};

/**
 * 
 * @param point KPoint
 * @param size KSize
 */
KDialog.prototype._moveAndResize = function(point, size)
{
    this.resize(size);
    if(!arguments[2])
    {
        this.moveTo(point);
    }
    else
    {
        var _minWidth = this._minSize.width > 0 ? this._minSize.width : (this._titleDom.outerWidth() + this._btnContainer.outerWidth());
        var _minHeight = this._minSize.height > 0 ? this._minSize.height : this._titleContainer.outerHeight();
        if(((arguments[2] == 'left') && (size.width > _minWidth)) || ((arguments[2] == 'top') && (size.height > _minHeight)))
        {
            this.moveTo(point);
        }
    }
};

/**
 * 
 * @return KBounds
 */
KDialog.prototype._getParentBounds = function()
{
    return this.options().dragrange ? this.options().dragrange : KTools.getBounds(window);
};

KDialog.prototype._getRB = function()
{
    var right = parseInt(this._jDom.css('padding-left')) + parseInt(this._jDom.css('padding-right'));
    var bottom = parseInt(this._jDom.css('padding-top')) + parseInt(this._jDom.css('padding-bottom'));
    var rBorder = parseInt(this._jDom.css('border-left-width')) + parseInt(this._jDom.css('border-right-width'));
    var bBorder = parseInt(this._jDom.css('border-top-width')) + parseInt(this._jDom.css('border-bottom-width'));

    return {right : right + rBorder,bottom : bottom + bBorder};
}
/*
 html 

    * 
    * 
    * 
          o 
          o 
    * 
    * 
    * 

 wangzheng
 1.0
 2010-02-26
 2010-03-12 23:07
 ============================================
 
 */
var KDropList = KClass.create("KDropList", KWidget);

/**
 * KDropList opts 
 * @param container Node  DOM 
 * @param opts KDropListOptions 
 */
KDropList.initialize = function(container, opts)
{
    this._dropPanel = undefined;
    this._list = undefined;
    this._dropPanelDom = undefined;
    this._listDom = undefined;

    if (KTools._isElement(container))
    {
        this._dom = container;
        this._opts = KTools.copyOptions(opts, KDropListOptions);
        this._theme = this._opts.theme;
        // add by zhangsq
        $(this._dom).removeClass().addClass(this.options().theme + '_dpl');
        this._dropPanelDom = $(">div", this._dom).get(0);
        this._listDom = $(">div:eq(1) >div >div", this._dropPanelDom).get(0);
        this._list = new KList(this._listDom, this._opts);
        this._dropPanel = new KDropPanel(this._dropPanelDom, this._opts);
        var this_ = this;

        KEvent.bind(this._list, "selectchanged", function(event, list, item) {
            if(this_._opts.select2text && !this_._opts.multiple && item.selected) this_._dropPanel.setText(item.text);
			KEvent.trigger(this_, "selectchanged", this_, item);
		});

		KEvent.bind(this._list, "itemclick", function(event, list, item, changed) {
            if(!this_._opts.multiple && item.selected) this_._dropPanel.close();
            KEvent.trigger(this_, "itemclick", this_, item, changed);
        });

        KEvent.bind(this._dropPanel, "opened", function(event, dropPanel, action) {
            KEvent.trigger(this_, "opened", this_, action);
        });
        KEvent.bind(this._dropPanel, "closed", function(event, dropPanel, action) {
            KEvent.trigger(this_, "closed", this_, action);
        });
        KEvent.bind(this._list, "beforedit", function(event, list, item){
            KEvent.trigger(this_, "beforedit", this_, item);
        });
        KEvent.bind(this._list, "afteredit", function(event, list, item){
            KEvent.trigger(this_, "afteredit", this_, item);
        });
        KEvent.bind(this._list, "beforemove", function(event, list, item){
            KEvent.trigger(this_, "beforemove", this_, item);
        });
        KEvent.bind(this._list, "afteremove", function(event, list, item){
            KEvent.trigger(this_, "afteremove", this_, item);
        });
        KEvent.bind(this._list, "aftersort", function(event, list, item){
            KEvent.trigger(this_, "aftersort", this_, item);
        });

    }
};


/**
 * @overwrite
 * @uncrunch
 */
KDropList.prototype.version = function()
{
    return "1.0";
};

/**
 * @overwrite
 * @uncrunch
 */
KDropList.prototype.cnname = function()
{
    return "";
};

/**
 * @overwrite
 * @uncrunch
 */
KDropList.prototype.setOptions = function(opts)
{
    this._opts = KTools.copyOptions(opts, KListOptions);
    this._theme = this._opts.theme;
    this._updateThemeClass(this._opts.userstyle);
};

/**
 * @overwrite
 * @uncrunch
 */
KDropList.prototype.setTheme = function(theme)
{
    if(typeof theme == "string")
    {
        this._theme = theme;
        this._opts.theme = this._theme;
        this._updateThemeClass(this._opts.userstyle);
    }
};

/**
 * @overwrite
 * @uncrunch
 */
KDropList.prototype.layout = function()
{
    if(this._dom) this._dropPanel.layout();
};

/**
 * @overwrite
 * @uncrunch
 */
KDropList.prototype.clearResult = function()
{
    if(this._dom) this._list.clearResult();
};

/**
 * @overwrite
 * @uncrunch
 */
KDropList.prototype.enable = function()
{
    if(this._dropPanel)this._dropPanel.enable();
    KWidget.prototype.enable.call(this);
};

/**
 * @overwrite
 * @uncrunch
 */
KDropList.prototype.disable = function()
{
    if(this._dropPanel)this._dropPanel.disable();
    KWidget.prototype.disable.call(this);
};


/**
 * 
 * @uncrunch
 */
KDropList.prototype.open = function()
{
    if(this._dropPanel) this._dropPanel.open();
};

/**
 * 
 * @uncrunch
 */
KDropList.prototype.close = function()
{
    if(this._dropPanel) this._dropPanel.close();
};

/**
 * @uncrunch
 */
KDropList.prototype.bubbleVisible = function()
{
    if(this._dropPanel) return this._dropPanel.bubbleVisible();
    return false;
};

/**
 * 
 * @return KListItem[] 
 * @uncrunch
 */
KDropList.prototype.selected = function()
{
    if(this._list) return this._list.selected();
    return [];
};

/**
 * 
 * @param index Integer 
 * @uncrunch
 */
KDropList.prototype.select = function(index)
{
    if(this._list) this._list.select(index);
};

/**
 *  item  index  index 
 * @param item KListItem 
 * @param index Integer 
 * @uncrunch
 */
KDropList.prototype.insert = function(item, index)
{
    if(this._list) {
        this._list.insert(item, index);
        if(this._opts.multiple === false && item.selected) this._dropPanel.setText(item.text);
    }
};

/**
 *  item
 * @param index Integer 
 * @param item KListItem 
 * @uncrunch
 */
KDropList.prototype.setItem = function(index, item)
{
    if(this._list) this._list.setItem(index, item);
};

/**
 *  index 
 * @param index Integer
 * @uncrunch
 */
KDropList.prototype.remove = function(index)
{
    if(this._list) this._list.remove(index);
};

/**
 * 
 * @return KListItem[] 
 * @uncrunch
 */
KDropList.prototype.items = function()
{
    if(this._list) return this._list.items();
    return [];
};

/**
 * 
 * @param index Integer 
 * @return KListItem 
 * @uncrunch
 */
KDropList.prototype.item = function(index)
{
    if(this._list) return this._list.item(index);
    return undefined;
};

/**
 *  index  target 
 * @param index Integer 
 * @param target Integer 
 * @uncrunch
 */
KDropList.prototype.setIndex = function(index, target)
{
    if(this._list) this._list.setIndex(index, target);
};

/**
 *   theme_dpp_e 
 * @param keepBoolean  false
 * @uncrunch
 */
KDropList.prototype.keepOpenedStyle = function(keep)
{
    if(this._dropPanel) this._dropPanel.keepOpenedStyle(keep);
};

KDropList.prototype._updateThemeClass = function(useDefault)
{
    if (this._dom && useDefault == false) this._dom.className = this._theme + "_dpl";
};

/**
 *   theme_dpl_e 
 * @return Boolean 
 * @uncrunch
 */
KDropList.prototype.openedStyleKept = function()
{
    if(this._dropPanel) return this._dropPanel.openedStyleKept();
    return false;
};



/**
 * @overwrite
 * @uncrunch
 */
KDropList.prototype.finalize = function()
{
    KEvent.clear(this._dropPanel);
    KEvent.clear(this._list);
    if(this._dropPanel) this._dropPanel.finalize();
    if(this._list) this._list.finalize();
    KWidget.prototype.finalize.apply(this);
};

/**
 * @overwrite
 * @uncrunch
 */
KDropList.prototype.dependent = function()
{
    return [KWidget, KTools, KDropListOptions,jQuery, KEvent, KBubble,KSize,KPosition,KList, KDropPanel, KListItem];
};
/*


    * 
    * 
    * 
          o 
          o 
    * 

 wangzheng
 1.0
 2010-02-26
 2010-02-26 23:07
 ============================================
 
 */
var KDropPanel = KClass.create("KDropPanel", KWidget);

/**
 * KDropPanel opts 
 * @param container Node  DOM 
 * @param opts KDropPanelOptions  
 */
KDropPanel.initialize = function(container, opts)
{
    //
    this._bubble = undefined;
    //jdom
    this._resultDiv = undefined;
    this._bubbleDom = undefined;
    this._resultDivA1 = undefined;
    this._resultDivA2 = undefined;
    this._keepOpen = false;

    if (KTools._isElement(container))
    {
        this._dom = container;
        this._opts = KTools.copyOptions(opts, KDropPanelOptions);
        this._theme = this._opts.theme;
        this._divs = $(">div", this._dom);
        this._resultDiv = this._divs.eq(0);
        var _as = $(">a", this._resultDiv);
        this._resultDivA1 = _as.eq(0);
        this._resultDivA2 = _as.eq(1);
        this._doms = [this._dom, this._resultDiv.get(0), this._resultDivA1.get(0), this._resultDivA2.get(0)];
        this._defaultDomClass(this._doms, true);
        this._bubbleDom = this._divs.get(1);
        if (this._bubbleDom) this._bubble = new KBubble(this._bubbleDom, {theme : this._theme, userstyle:true});
        if (this._opts.userstyle == false) this._updateThemeClass(false);
        var this_ = this;
        var _2AClickFun = function(event){
            event.preventDefault();
            //
            if (!this_._enabled) return true;
            var _action = "text";
            if (this === this_._resultDivA2.get(0)) _action = "dropbtn";
            if (this_._bubble.visible() == true) {
                this_.close(_action);
                this_._updateResultA2Class(false);
            } else {
                this_.open(_action);
                this_._updateResultA2Class(true);
            }
        };
        if (this._opts.hover && this._opts.hover === true) {
            this._resultDiv.bind("mouseenter", function(event){
                event.preventDefault();
                //
                if (!this_._enabled) return true;
                var _action = "text";
                if (this_._bubble.visible() == false) {
                    this_.open(_action);
                    this_._updateResultA2Class(true);
                }
            });
            $(this._dom).bind("mouseleave", function(event){
                event.preventDefault();
                //
                if (!this_._enabled) return true;
                var _action = "text";
                if (this_._bubble.visible() == true) {
                    this_.close(_action);
                    this_._updateResultA2Class(false);
                }
            });
        } else {
            KEvent.bind(this._resultDiv.get(0), "click", _2AClickFun);
        }
        
        
        KEvent.bind(this._bubble, 'aftershow', function() {
            if (this_._opts.userstyle == false)
            {
                this_._resultDiv.addClass(this_._theme + "_dpp_e");
            }
            KEvent.trigger(this_, "opened", this_, this_._mouse_action);
        });
        KEvent.bind(this._bubble, 'afterhide', function() {
            this_._updateResultA2Class(false);
            if (this_._opts.userstyle == false && this_._keepOpen == false)
            {
                this_._resultDiv.removeClass(this_._theme + "_dpp_e");
            }
            var _action = arguments[2];
            if(_action === "method") _action = this_._mouse_action
            KEvent.trigger(this_, "closed", this_, _action);
        });
        if(this._opts.size instanceof KSize && this_._bubble) this_._bubble.resize(this._opts.size);
    }
};

/**
 * @overwrite
 * @uncrunch
 */
KDropPanel.prototype.version = function()
{
    return "1.0";
};

/**
 * @overwrite
 * @uncrunch
 */
KDropPanel.prototype.cnname = function()
{
    return "";
};

/**
 * @overwrite
 * @uncrunch
 */
KDropPanel.prototype.setOptions = function(obj)
{
    if(!this._enabled)return;
    this._opts = KTools.copyOptions(obj, this._opts);
    this._theme = this._opts.theme;
    if(this._dom) this._updateThemeClass(this._opts.userstyle);
    if(this._bubble)
    {
        this._bubble.setOptions({theme:this._theme,userstyle:this._opts.userstyle});
        if(obj.size instanceof KSize) this._bubble.resize(this._opts.size);
        if(this._bubble.visible() == true) this._bubble.show(this._resultDivA1.get(0), this._opts);
    }
};

/**
 * @uncrunch
 */
KDropPanel.prototype.bubbleVisible = function()
{
    if(!this._enabled) return;
    if(this._bubble) return this._bubble.visible();
    return false;
};

/**
 * @overwrite
 * @uncrunch
 */
KDropPanel.prototype.setTheme = function(scheme)
{
    if(!this._enabled)return;
    if (typeof scheme == 'string') this._theme = scheme;
    this._updateThemeClass(this._opts.userstyle);
};

/**
 * @overwrite
 * @uncrunch
 */
KDropPanel.prototype.layout = function()
{
    if(!this._enabled)return;
    if (this._bubble instanceof KBubble) this._bubble.layout();
};

/**
 * @overwrite
 * @uncrunch
 */
KDropPanel.prototype.clearResult = function()
{
    if(!this._enabled)return;
    if(!this._enabled)return;
    if (this._bubble instanceof KBubble) this._bubble.clearResult();
};

/**
 * @overwrite
 * @uncrunch
 */
KDropPanel.prototype.enable = function()
{
    if(this._dom)
    {
        $(this._dom).removeClass(this._theme+"_dpp_dis");
//        $(this._resultDivA1).css("cursor","");
//        $(this._resultDivA2).css("cursor","");
        if(this._lastbubbleV)
        {
            $(this._bubbleDom).show();
            this._bubble.layout();
        }
    }
    KWidget.prototype.enable.call(this);
};

/**
 * @overwrite
 * @uncrunch
 */
KDropPanel.prototype.disable = function()
{
    if(this._dom)
    {
        $(this._dom).addClass(this._theme+"_dpp_dis");
        this._lastbubbleV = $(this._bubbleDom).is(":visible");
        if(this._lastbubbleV) $(this._bubbleDom).hide();
    }
    KWidget.prototype.disable.call(this);
};

/**
 * 
 * @uncrunch
 */
KDropPanel.prototype.open = function()
{
    if(!this._enabled) return;
    if(this._bubble instanceof KBubble && !this._bubble.visible())
    {
        this._mouse_action = arguments[0];
        if(typeof this._mouse_action != 'string') this._mouse_action = "method";
        this._bubble.show(this._resultDiv.get(0), this._opts);
    }
};

/**
 * 
 * @uncrunch
 */
KDropPanel.prototype.close = function()
{
    if(!this._enabled)return;
    if(this._bubble instanceof KBubble && this._bubble.visible())
    {
        this._mouse_action = arguments[0];
        if(typeof this._mouse_action != 'string') this._mouse_action = "method";
        this._bubble.hide();
    }
};

/**
 * 
 * @param text KHtmlContent 
 * @uncrunch
 */
KDropPanel.prototype.setText = function(text)
{
    if(!this._enabled)return;
    if(!this._resultDivA1) return;
    if(typeof text == "string")
    {
        this._resultDivA1.html(text);
        this.layout();
    } else if(KTools._isElement(text)){
        this._resultDivA1.html("");
        this._resultDivA1.append(text);
        this.layout();
    }
};

/**
 * 
 * @param content KHtmlContent 
 * @uncrunch
 */
KDropPanel.prototype.setContent = function(content)
{
    if(!this._enabled)return;
    if(this._bubble) this._bubble.setContent(content);
};

/**
 * 
 * @param size KSize 
 * @uncrunch
 */
KDropPanel.prototype.setPanelSize = function(size)
{
    if(!this._enabled)return;
    if(this._bubble && this._bubble.visible() == true && size instanceof KSize)
    {
        this._opts.size = size;
        this._bubble.resize(size);
    }
};

/**
 *   theme_dpp_e 
 * @param keepBoolean  false
 * @uncrunch
 */
KDropPanel.prototype.keepOpenedStyle = function(keep)
{
    if(!this._enabled)return;
    if(typeof keep != 'boolean') keep = false;
    this._keepOpen = keep;
    if(this._dom && this._opts.userstyle == false)
    {
        if(keep) this._resultDiv.addClass(this._theme + "_dpp_e");
        else this._resultDiv.removeClass(this._theme + "_dpp_e");
    }
};

KDropPanel.prototype._defaultDomClass = function(doms, save)
{
    if (save)
    {
        for (var i = 0; i < doms.length; i++)
            if (doms[i]) doms[i]._dDClass = doms[i].className;
    } else {
        for (var i = 0; i < doms.length; i++)
            if (doms[i]) doms[i].className = doms[i]._dDClass;
    }
};

KDropPanel.prototype._updateThemeClass = function(useDefault)
{
    if (this._dom)
    {
        if (useDefault == true)
        {
            this._defaultDomClass(this._doms, false);
        } else {
            this._setClass(this._dom, this._theme + "_dpp");
            if (this._resultDiv.get(0))
            {
                if (this._resultDiv.get(0).className != "")
                {
                    var c = this._resultDiv.get(0).className;
                    c = c.replace(/[^\ ]*?_dpp_s/g, this._theme + "_dpp_s");
                    c = c.replace(/[^\ ]*?_dpp_e/g, this._theme + "_dpp_e");
                    this._setClass(this._resultDiv.get(0), c);
                } else
                    this._setClass(this._resultDiv.get(0), this._theme + "_dpp_s");
            }
            this._setClass(this._resultDivA1.get(0), this._theme + "_dpp_sv");
            if (this._resultDivA2.get(0))
            {
                if (this._resultDivA2.get(0).className != "")
                {
                    var c = this._resultDivA2.get(0).className;
                    c = c.replace(/[^\ ]*?_dpp_b/g, this._theme + "_dpp_b");
                    c = c.replace(/[^\ ]*?_dpp_bd/g, this._theme + "_dpp_bd");
                    this._setClass(this._resultDivA2.get(0), c);
                } else
                    this._setClass(this._resultDivA2.get(0), this._theme + "_dpp_b");
            }
        }
    }
};
KDropPanel.prototype._setClass = function(dom, className)
{
    if (dom) dom.className = className;
};

KDropPanel.prototype._updateResultA2Class = function(d)
{
    if (d == true)
    {
        if(this._resultDivA2.get(0)) this._resultDivA2.addClass(this._resultDivA2.get(0).className.replace(/([^\ ]*?)_dpp_b/g, "$1_dpp_b $1_dpp_bd"));
    } else {
        if(this._resultDivA2.get(0)) this._resultDivA2.get(0).className = this._resultDivA2.get(0).className.replace(/([^\ ]*?)_dpp_bd/g, "");
    }
};

/**
 *   theme_dpl_e 
 * @return Boolean 
 * @uncrunch
 */
KDropPanel.prototype.openedStyleKept = function()
{
    return this._keepOpen;
};



/**
 * @overwrite
 * @uncrunch
 */
KDropPanel.prototype.finalize = function()
{
    if(this._dom)
    {
        KEvent.clear(this._dom);
        KEvent.clear(this._bubble);
        this._bubble.finalize();
        KEvent.clear(this._resultDiv.get(0));
    }
    KWidget.prototype.finalize.apply(this);
};

/**
 * @overwrite
 * @uncrunch
 */
KDropPanel.prototype.dependent = function()
{
    return [KWidget, KTools, KDropPanelOptions,jQuery, KEvent, KBubble,KSize,KPosition];
};
/*
 
 songyr
 1.0
 2010-03-03
 2010-03-03 14:01
 ============================================
 
 */

var KHScrollList = KClass.create("KHScrollList", KWidget);

KHScrollList.conf =
{
    CLASSNAME :
    {
        //
        HSL : "_hsl"
        //
        ,MSK : "_hsl_msk"
        //
        ,US:"_hsl_us"
        //
        ,LM:"_hsl_lm"
        // 
        ,LMD :"_hsl_lmd"
        // 
        ,RM:"_hsl_rm"
        //  
        ,RMD:"_hsl_rmd"
        //
        ,RST:"_hsl_rst"
        // li 
        ,S:"_hsl_s"
        ,DIS:"_hsl_dis"
    }
};


/**
 * 
 * @param container Node
 * @param opts KScrollListOptions
 * @uncrunch
 */

KHScrollList.initialize = function(container, opts)
{
    var _this = this;
    this._scrollWidth = 0;
    //opts
    this.setOptions(KHScrollListOptions);
    this.setOptions(opts);
    this.setTheme(this.options().theme);
    //Dom
    this._jDom = $(container);
    this._dom = this._jDom[0];
    this._buttons = $(">a", this._jDom);
    this._msk = $("> div", this._jDom).eq(0);
    this._mskUl = $(">ul", this._msk);
    this._mskLis = $(">li", this._mskUl);
    this._mskLiWidth = this._mskLis.eq(0).outerWidth(true);
    this._mskSize = this._mskLis.size();
    this._listCount = Math.floor(this._msk.outerWidth(true) / this._mskLiWidth);
    this._resetBtn = null;
    this._enabled = true;
    this._buttons.each(function(i) {
        if (i > 1) {
            _this._resetBtn = $(this);
            _this.showResetBtn(false);
            $(this).click(function() {
                if(_this.enabled())_this.reset();
            });
            return false;
        }
        $(this).click(function() {
            if(_this.enabled())_this._scrollList(i);
        });

    });

    var ind = 0;
    if (this.options().multiple) {

        this._mskLis.each(function() {
            var $li = $(this);
            this.index = ind++;
            $li.bind("click",
                    function() {
                        if(_this.enabled()) {
                            $(this).toggleClass(_this._setClassName("S"));
                            _this.showResetBtn(!_this.selected().length == 0);
                            KEvent.trigger(_this, "selectchanged", _this, _this._liTodom(this), this);
                        }
                    }).mouseenter(function() {
                if(_this.enabled()){
                    KEvent.trigger(_this, "mouseover", _this, _this._liTodom(this), this);
                }
            }).mouseleave(function() {
                if(_this.enabled()){
                    KEvent.trigger(_this, "mouseout", _this, _this._liTodom(this), this);
                }
            });

            if ($li.attr("selected")) {
                _this.showResetBtn();
                $li.addClass(_this._setClassName("S"));
            }
        });
    } else {
        var _thisSelected = this._mskLis.filter("li[selected='true']").last().addClass(_this._setClassName("S"));
        this._mskLis.each(function() {
            var $li = $(this);
            this.index = ind++;
            $li.bind("click",
                    function() {
                        if(_this.enabled()) {

                            _thisSelected.removeClass(_this._setClassName("S"));
                            _thisSelected = $(this).toggleClass(_this._setClassName("S"));
    //                        _this._liTodom(this)
                            _this.showResetBtn(!_this.selected().length == 0);
                            KEvent.trigger(_this, "selectchanged", _this, _this._liTodom(this), this);
                        }
                    }).mouseenter(function() {
                if(_this.enabled()) {
                    KEvent.trigger(_this, "mouseover", _this, _this._liTodom(this), this);
                }
            }).mouseleave(function() {
                if(_this.enabled()) {
                    KEvent.trigger(_this, "mouseout", _this, _this._liTodom(this), this);
                }
            });
        });

    }
};

/**
 *  
 *  @return  KListItem[] 
 * @uncrunch
 */
KHScrollList.prototype.selected = function()
{
    var tmpArry = [],JLitem,KLitem;

    for (var i = 0, j = this._mskLis.length; i < j; i++) {
        JLitem = this._mskLis.eq(i);

        if (JLitem.is("." + this._setClassName("S")))
        {
            //            console.log(JLitem.is("." + this._setClassName("S")));
            KLitem = KTools.copyOptions({}, KListItem);
            KLitem.index = i;
            KLitem.text = JLitem.html();
            KLitem.kvalue = JLitem.attr("kvalue") || "";
            KLitem.node = JLitem[0];
            KLitem.itemClass = JLitem.children("a").attr("class");
            KLitem.selected = true;
            //            KLitem = {
            //                index:i,
            //                text: JLitem.children("a").html().split("<span>")[0]  ,
            //                node: JLitem[0],
            //                kvalue:  JLitem.attr("kvalue") || "" ,
            //                itemClass:JLitem.children("a").attr("class")  ,
            //                selected: true
            //            };
            tmpArry.push(KLitem);
        }
    }

    return tmpArry;
    //    return  this._mskLis.filter("." + this._setClassName("S"));
};

/**
 * 
 * @uncrunch
 */
KHScrollList.prototype.reset = function()
{
    var _cName = this._setClassName("S");
    this._mskLis.each(function() {
        $(this).removeClass(_cName);
    });
    //    this._buttons
    this.showResetBtn(false);
    KEvent.trigger(this, "reset", this);
};

KHScrollList.prototype.showResetBtn = function(show){
    if(!this._resetBtn) return;
    var display = !this._resetBtn.is(":hidden");
    if(show || typeof show == "undefined"){
        if(display) return;
        this._resetBtn.show();
        this._jDom.width(this._jDom.width() + this._resetBtn.outerWidth());
    }else{
        if(!display) return;
        this._resetBtn.hide();
        this._jDom.width(this._jDom.width() - this._resetBtn.outerWidth());
    }
};
//KObject 
/**
 *  
 * @uncrunch
 */
KHScrollList.prototype.finalize = function()
{
    KManager.unregister(this);
    KEvent.clear(this);
    KEvent.clear(this._dom);
    KWidget.prototype.finalize.apply(this);
};

//KWidget 

/**
 * 
 * @return String 
 * @uncrunch
 */
KHScrollList.prototype.version = function()
{
    return "1.0";
};

/**
 * 
 * @return String
 * @uncrunch
 */
KHScrollList.prototype.cnname = function()
{
    return "";
};

/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KHScrollList.prototype.dependent = function()
{
    return [ KClass, KEvent, KHScrollListOptions, KListItem, KLitem, KManager, KObject, KScrollListOptions, KTools,
			KWidget, jQuery ];
};

/**
 * obj 
 * @param obj
 * @uncrunch
 */
KHScrollList.prototype.setOptions = function(obj)
{
    this._opts = KTools.copyOptions(obj, this.options());
};

/**
 * 
 * @param scheme
 * @uncrunch
 */
KHScrollList.prototype.setTheme = function(scheme)
{
    this._theme = scheme;
};

//end KWidget


/**
 * 
 * @param i
 */
KHScrollList.prototype._scrollList = function(i)
{
    if (i === 0)
    {
        if (this._scrollWidth == 0) {
            //        this.changeCss(i, true);
            //            this._buttons.eq(i).addClass(this.setClassName("RMD")).removeClass(this.setClassName("RM"));

            return;
        }
        this._scrollWidth += this._mskLiWidth * (this.options().scrollcount || this._listCount );

    }
    else if (i === 1) {
        if (this._mskSize + (this._scrollWidth / this._mskLiWidth) <= this._listCount) {
            //           this.changeCss(i, true);
            //              this._buttons.eq(i).addClass(this.setClassName("LMD")).removeClass(this.setClassName("LM"));
            return;

        }
        this._scrollWidth -= this._mskLiWidth * (this.options().scrollcount || this._listCount);
        //  $(this._buttons[i]).addClass(this.setClassName("RM")).removeClass("RMD")

    }
    //    this._scrollWidth = this._scrollWidth + (i ? this._mskLiWidth * (this.options().scrollcount || 1) : - this._mskLiWidth * (this.options().scrollcount || 1));
    else {
        this._scrollWidth = 0;
    }

    if (this.options().animation)
    {
        //
        this._mskUl.animate({marginLeft:this._scrollWidth}
                , 600
            //  3600/(this.options().scrollcount|| this._listCount)
                );

    } else {

        this._mskUl.css("marginLeft", this._scrollWidth);
    }
    this._changeCss(i);
};


/**
 *   
 * @param arg  
 */
KHScrollList.prototype._setClassName = function(arg)
{
    if (!this.options().userstyle && arg && KHScrollList.conf.CLASSNAME[arg])
    {
        return this.options().theme + KHScrollList.conf.CLASSNAME[arg];
    }
    return undefined;
};

/**
 * 
 * @param i   1 0
 */
KHScrollList.prototype._changeCss = function(i)
{
    this._buttons.eq(Math.abs(i - 1)).addClass(this._setClassName(i ? "LM" : "RM")).removeClass(this._setClassName(i ? "LMD" : "RMD"));

    // songyr
    if (this._scrollWidth == 0) {
        this._buttons.eq(0).addClass(this._setClassName("LMD")).removeClass(this._setClassName("LM"));
    }
    else if (this._mskSize + (this._scrollWidth / this._mskLiWidth) <= this._listCount) {
        this._buttons.eq(1).addClass(this._setClassName("RMD")).removeClass(this._setClassName("RM"));
    }
};


KHScrollList.prototype._liTodom = function(li) {

    var KLitem = KTools.copyOptions({}, KListItem), JLitem = $(li);
    KLitem.index = li.index;
    KLitem.text = JLitem.html();
    KLitem.kvalue = JLitem.attr("kvalue") || "";
    KLitem.node = JLitem[0];
    KLitem.itemClass = JLitem.children("a").attr("class");
    KLitem.selected = JLitem.hasClass(this._setClassName("S"));
    return KLitem;
};
/**
 * 
 * @uncrunch
 */
KHScrollList.prototype.enabled = function()
{
    return this._enabled;
};

/**
 * 
 * @uncrunch
 */
KHScrollList.prototype.enable = function()
{
    if(this._enabled) return;
    this._enabled = true;
    this._jDom.removeClass(this._setClassName("DIS"));
};

/**
 * 
 * @uncrunch
 */
KHScrollList.prototype.disable = function()
{
    if(!this._enabled) return;
    this._enabled = false;
    this._jDom.addClass(this._setClassName("DIS"));
};
/*
 select 

    * 
    * 
    * 
    * 
    *  checkbox  checkbox  selected 
    * 

 wangzheng
 1.0
 2010-03-09
 2010-03-09 20:07
 ============================================
 
 opt# 1011021057
 
 */
var KList = KClass.create("KList", KWidget);

/**
 * KList opts 
 * @param container Node  DOM 
 * @param opts KListOptions  
 */
KList.initialize = function(container, opts)
{
    var this_ = this;
    this._dom = undefined;
    this._opts = undefined;
    //[li node]
    this._items = [];
    //{li node}
    this._selected = [];

    var data_ = {this_:this_};
    if (KTools._isElement(container))
    {
        this._opts = KTools.copyOptions(opts, KListOptions);
        this._theme = this._opts.theme;
        this._dom = container;
        this._dom._ul = $(">ul", this._dom);
        this._lis = $(">ul >li", this._dom);
        this._items = [];
        this._editInput = $("<input type='text'' class='"+this._theme+"_lst_etb' ></input>").get(0);
        KEvent.bind(this._editInput, "click", KTools._stopPropagation);
        this._lis.each(function() {
            //
            this_._initLiAttr(this);
            //
            this.index = this_._items.length;
            this_._items.push(this);
            if(this.selected)
                this_._selected.push(this);
            //
            this_._liEvents(this);
        });
        this._updateThemeClass(this._opts.userstyle);
        this._moveDiv = $("<div class=\""+this._dom.className+"\" style=\"position:absolute;height:0px;width:0px;opacity:0.7;*filter:alpha(opacity=70);border:0px none;z-index:"+(KTools._zindexMax - 5)+";"+this._dom.style.cssText+"\"><ul class=\""+this._dom.className+"\" style=\"border:0px;height:auto;width:auto;"+this._dom.style.cssText+"\"></ul></div>").appendTo(document.body).hide().get(0);
        this._moveDiv._ul = $(">ul", this._moveDiv);
        this._blackLi = $("<li style='background-color:#eee;border:none;'></li>").get(0);
    }
};

/**
 * @overwrite
 * @uncrunch
 */
KList.prototype.version = function()
{
    return "1.0"
};

/**
 * @overwrite
 * @uncrunch
 */
KList.prototype.cnname = function()
{
    return "";
};

/**
 * @overwrite
 * @uncrunch
 */
KList.prototype.setOptions = function(opts)
{
    this._opts = KTools.copyOptions(opts, KListOptions);
    this._theme = this._opts.theme;
    this._updateThemeClass(this._opts.userstyle);
};

/**
 * @overwrite
 * @uncrunch
 */
KList.prototype.setTheme = function(theme)
{
    if(typeof theme == "string")
    {
        this._theme = theme;
        this._opts.theme = this._theme;
        this._updateThemeClass(this._opts.userstyle);
    }
};

/**
 * @overwrite
 * @uncrunch
 */
KList.prototype.clearResult = function()
{
    if(this._dom)
    {
        for(var i = 0; i < this._items.length; i++) this._removeLiDom(this._items[i]);
        this._items = [];
        this._selected = []; 
        KTools.removeNode($(">ul >li", this._moveDiv).get(0));
        this._lis = $(">ul >li", this._dom);
    }
};

/**
 * 
 * @return KListItem[] 
 * @uncrunch
 */
KList.prototype.selected = function()
{
    if(this._selected instanceof Array)
    {
        var _selects = [];
        for(var i = 0; i < this._selected.length; i++) _selects.push(this._liDomToItem(this._selected[i]));
        return _selects;
    }
    return [];
};

/**
 * 
 * @param index Integer 
 * @uncrunch
 */
KList.prototype.select = function(index, select)
{
    if(this._items instanceof Array && typeof index == 'number' && this._items[index])
    {
        if(typeof select != "boolean") select = true;
        if(this._opts.multiple == false)
        {
            var i = this._selected.pop();
            while(i) {
                i.selected = false;
                i._selectedIndex = -1;
                i._span0Input.attr("checked", "");
                if(this._opts.userstyle == false) i.className = "";
                i = this._selected.pop();
            }
        }
        var _liDom = this._items[index];
        var input_ = _liDom._span0Input;
        if(_liDom.selected)
        {
            if(select) return;
            _liDom._selectedIndex = -1;
            _liDom.selected = false;
            input_.attr("checked", "");
        } else {
            if(!select) return;
            _liDom.selected = true;
            input_.attr("checked", "checked");
        }
        if(this._opts.userstyle == false)
        {
            if(select) $(_liDom).addClass(this._theme + "_lst_s");else $(_liDom).removeClass(this._theme + "_lst_s");
        }
        this._updateItemAndSelect(false, false);
		var _lti = this._liDomToItem(_liDom);
		// selectchanged  true
		if(arguments[2]) KEvent.trigger(this, "itemclick", this, _lti, true);
		// selectchanged  true 
        if(!arguments[3]) KEvent.trigger(this, "selectchanged", this, _lti);
    }
};


/**
 * 
 * @param select Boolean  false
 * @uncrunch
 */
KList.prototype.selectAll = function(select)
{
    if(typeof select != "boolean") select = false;
    if(this._items)
        for(var i = 0; i < this._items.length; i++) this.select(i, select);
};


/**
 *  index  item index  index 
 * @param item KListItem 
 * @param index Integer 
 * @uncrunch
 */
KList.prototype.insert = function(item, index)
{
    if(item)
    {
        if(typeof index == 'number') index = parseInt(index); else index = this._items.length;
        if(index < 0) index = 0;
        item = KTools.copyOptions(item, KListItem);
        var _dom = this._itemToLiDom(item);
        this._initLiAttr(_dom);
        this._liEvents(_dom);
        if(this._items[index]) $(this._items[index]).before(_dom);
        else {
            if(this._items.length > 0)
                $(this._items[this._items.length - 1]).after(_dom);
            else $(this._dom._ul).prepend(_dom);
        }
		if(item.selected) {
			for(var i = 0; i < this._selected.length; i++) {
				var lidom = this._selected[i];
				lidom.selected = false;
				lidom._span0Input.eq(0).attr("checked", "");
				lidom.className = "";
			}
		}
        this._updateItemAndSelect(true);
		//this._lis = $(">ul >li", this._dom);
		//this.select(index, true, false, true);
    }
};

/**
 *  item
 * @param index Integer  
 * @param item KListItem 
 * @uncrunch
 */
KList.prototype.setItem = function(index, item)
{
    if(typeof index == 'number' && item && this._items[index])
    {
        this._removeLiDom(this._items[index]);
        this.insert(item, index+1);
    }
};

/**
 *  index 
 * @param index Integer
 * @uncrunch
 */
KList.prototype.remove = function(index)
{
    if(typeof index == 'number' && this._items[index])
    {
        this._removeLiDom(this._items[index]);
        KEvent.trigger(this, "afteremove", this, this._liDomToItem(this._items[index]));
        this._updateItemAndSelect(true);
    }
};

/**
 * 
 * @return KListItem[] 
 * @uncrunch
 */
KList.prototype.items = function()
{
    if(!this._items) return [];
    var _items = [];
    for(var i = 0; i < this._items.length; i++)
        _items.push(this.item(i));
    return _items;
};

/**
 * 
 * @param index Integer 
 * @return KListItem 
 * @uncrunch
 */
KList.prototype.item = function(index)
{
    if(typeof index == 'number' && this._items.length > 0)
    {
        index = parseInt(index);
        if(index < 0) index = 0;
        if(index >= this._items.length) index = this._items.length - 1;
        return this._liDomToItem(this._items[index]);
    }
    return undefined;
};

/**
 *  index  target 
 * @param index Integer 
 * @param target Integer 
 * @uncrunch
 */
KList.prototype.setIndex = function(index, target)
{
    if(this._opts.sortable == true && typeof index == 'number' && typeof target == 'number' && index != target && this._items[index] && this._items[target])
    {
        if(index < target) $(this._items[target]).after(this._items[index]);
        else $(this._items[target]).before(this._items[index]);
        this._updateItemAndSelect(true);
        KEvent.trigger(this, "aftersort", this, this._liDomToItem(this._items[index]));
    }
};

KList.prototype._liDomToItem = function(liDom)
{
    var _item = {};
        for(var j in KListItem)
        {
            if(j == "kvalue") _item[j] = decodeURIComponent(liDom[j]);
			else _item[j] = liDom[j];
        }
    return _item;
};

KList.prototype._itemToLiDom = function(item)
{
    var newLi = null;
    if(this._opts.checkbox === true)
        newLi = $('<li kvalue="'+encodeURIComponent(item.kvalue)+'" deletable="'+item.deletable+'" editable="'+item.editable+'" editable="'+item.editable+'" selected="'+item.selected+'"><span><input type="checkbox"  '+(item.selected?'checked="checked"':'')+'/></span><span class="'+item.iconClass+'"></span><label>'+item.text+'</label><a href="javascript:;" title=""></a><a href="javascript:;" title=""></a></li>').get(0);
    else
        newLi = $('<li kvalue="'+encodeURIComponent(item.kvalue)+'" deletable="'+item.deletable+'" editable="'+item.editable+'" editable="'+item.editable+'" selected="'+item.selected+'"><span></span><span class="'+item.iconClass+'"></span><label>'+item.text+'</label><a href="javascript:;" title=""></a><a href="javascript:;" title=""></a></li>').get(0);
    if(!this._opts.userstyle)
    {
        $(">span:eq(0)", newLi).addClass(this._theme+'_lst_c');
        $(">a:eq(0)", newLi).addClass(this._theme+'_lst_et');
        $(">a:eq(1)", newLi).addClass(this._theme+'_lst_rm');
    }
    return newLi;
};

KList.prototype._removeLiDom = function(liDom)
{
	if (liDom._span0Input && liDom._span0Input.get(0)) {
		KEvent.clear(liDom._span0Input.get(0));
	}
	//
	try{
		KEvent.clear(liDom._as.get(0));
		KEvent.clear(liDom._as.get(1));
	}catch(e){
	}
    KEvent.clear(liDom);
    liDom._spans = null;
    liDom._span0Input = null;
    liDom._labels = null;
    liDom._as = null;
    KTools.removeNode(liDom);
};

/**
 * @overwrite
 * @uncrunch
 */
KList.prototype.finalize = function()
{
    this.clearResult();
    KTools.removeNode(this._editInput);
    KEvent.clear(this._editInput);
    KTools.removeNode(this._blackLi);
    KEvent.clear(this._blackLi);
    KTools.removeNode(this._moveDiv);
    KEvent.clear(this._moveDiv);
    KEvent.clear(this._dom);
    KEvent.clear(this._dom);
    KEvent.unbind(document, "mousemove", this._docMouseMove);
    KEvent.unbind(document, "mouseup", this._docMouseUp);
    KWidget.prototype.finalize.apply(this);
};

/**
 * @overwrite
 * @uncrunch
 */
KList.prototype.dependent = function()
{
    return [KWidget, jQuery, KEvent, KTools, KListOptions, KListItem, KPoint];
};

KList.prototype._updateThemeClass = function(useDefault)
{
    var this_ = this;
    if (this._dom)
    {
        if (useDefault == false)
        {
            var _lis_ = this._lis;
            _lis_.each(function() {
                this._spans.eq(0).attr("className", this_._theme + "_lst_c");
                this._as.eq(0).attr("className", this_._theme + "_lst_et");
                this._as.eq(1).attr("className", this_._theme + "_lst_rm");
            });
            this._dom.className = this_._theme + "_lst";
        }
    }
};

KList.prototype._setClass = function(dom, className)
{
    if (dom) dom.className = className;
};

//opt# 1011021057 fix begin
/**
 * 
 * @param event
 */
KList.prototype._keydownFun = function(event)
{
    if(event.keyCode == 13)
    {
        this.blur();
    }
};
//opt# 1011021057 fix end

KList.prototype._inputBlurFun = function(event)
{
    var _input = event.data['_input'];
    var _label = event.data['_label'];
    var _inputBlurFun = event.data['_inputBlurFun'];
    var _this_ = event.data['_this_'];
    var this_ = event.data['this_'];
    $(_input).replaceWith(_label).hide();
    $(_label).text(_input.value).show();
    _this_.text = _input.value;
    _input._on = "false";
    KEvent.unbind(_input, "blur", _inputBlurFun);
    KEvent.trigger(this_, "afteredit", this_, this_._liDomToItem(_this_));
    KEvent.unbind(this_._dom, "click", this_._domClickFun);
};

KList.prototype._domClickFun = function(event){
    KEvent.trigger(event.data.this_._editInput, "blur");
};

/**
 * 
 * @param event
 */
KList.prototype._editClickFun = function(event)
{
    var this_ = event.data.this_;
    var _this_ = event.data._this_;
    var _label =  _this_._labels.get(0);
    if(this_._editInput._on == "true")
    {
        this_._inputBlurFun({data:{ _input: this_._editInput, _label:this_._editInput._label, _inputBlurFun:this_._editInput._inputBlurFun, this_:this_, _this_:_this_}});
        _label =  _this_._labels.get(0);
        if(this_._editInput._label == _label) return;
    }
    KEvent.trigger(this_, "beforedit", this_, this_._liDomToItem(_this_));
    this_._editInput._on = "true";
    this_._editInput._label = _label;
    this_._editInput._inputBlurFun = this_._inputBlurFun;
    $(_label).replaceWith(this_._editInput).hide();
    $(this_._editInput).show().get(0).value = $(_label).text();
    KEvent.unbind(this_._editInput, "click", KTools._stopPropagation);
    KEvent.bind(this_._editInput, "click", KTools._stopPropagation);
    //opt# 1011021057 fix begin
    //add by zhangsq
    KEvent.bind(this_._editInput, 'keydown', this_._keydownFun);
    //opt# 1011021057 fix end
    this_._editInput.focus();
    KEvent.bind(this_._dom, "click", this_._domClickFun, {this_:this_});
    KEvent.bind(this_._editInput, "blur", this_._inputBlurFun, { _input: this_._editInput, _label:this_._editInput._label, _inputBlurFun:this_._editInput._inputBlurFun, this_:this_, _this_:_this_});
    return KTools._stopPropagation(event);
};

/**
 * 
 * @param event
 */
KList.prototype._delClickFun = function(event)
{
    var this_ = event.data.this_;
    var _this_ = event.data._this_;
    KEvent.trigger(this_._editInput, "blur");
    var _item = this_._liDomToItem(_this_);
    KEvent.trigger(this_, "beforemove", this_, _item);
	if(!this_._opts.confirmdelete) {
		this_._removeLiDom(_this_);
		this_._updateItemAndSelect(true);
		KEvent.trigger(this_, "afteremove", this_, _item);
	}
    return KTools._stopPropagation(event);
};

/**
 * item
 * @param event
 */
KList.prototype._liClickFun = function(event) {
    var this_ = event.data.this_;
    var input_ = this._span0Input;
    if(this.selected && !this_._opts.multiple && !this_._opts.deselect) {
		KEvent.trigger(this_, "itemclick", this_, this_._liDomToItem(this), false);
		return;
	}
    this_.select(this.index, !this.selected, true);
};

KList.prototype._docMouseMove = function(event)
{
    var _this_ = event.data._this_;
    var this_ = event.data.this_;
    var _ulBounds = KTools.getBounds($(this_._dom).get(0));
    _this_.moved = true;
    //libody
    if($(_this_).parent().get(0) != this_._moveDiv._ul.get(0))
    {
        $(this_._moveDiv).css({"height": $(_this_).outerHeight() + "px", "width": $(_this_).outerWidth() + "px"}).show();
        this_._moveDiv._on = true;
        if(this_._opts.userstyle == false)
        {
            $(_this_).addClass(this_._theme + "_lst_h");
        }
        this_._moveDiv._ul.append(_this_);
        $(this_._blackLi).css("height", $(_this_).outerHeight());
        KEvent.trigger(this_._editInput, "blur");
    }
    $(this_._moveDiv).css({"top": (_this_._bounds.min.y + (event.pageY - _this_._downY)) + "px", "left": (_this_._bounds.min.x + (event.pageX - _this_._downX)) + "px"});
    _this_._downX = event.pageX;
    _this_._downY = event.pageY;
    _this_._bounds = KTools.getBounds(this_._moveDiv);
    //lili
    if(_ulBounds.intersects(_this_._bounds))
    {
        var _iDom = null;
        var _iBounds = null;
        var _finded = false;
        for(var i = 0; i < this_._items.length; i++)
        {
            _iDom = this_._items[i];
            if(_iDom == _this_) continue;
            _iBounds = KTools.getBounds(_iDom);
            if(_iBounds.intersect(_this_._bounds).size().height > _this_._bounds.size().height/2)
            {
                if(_this_._replaceIndex == i) _this_._replaceIndex = _iDom.index + 1;
                else _this_._replaceIndex = _iDom.index;
                _finded = true;
                break;
            }
        }
        if(_finded && _iBounds != null && !_ulBounds.contains(_iBounds))
        {
            if(_iBounds.min.y < _ulBounds.min.y + _ulBounds.size().height/2)
            {
                $(this_._dom).scrollTop($(this_._dom).scrollTop() - _iBounds.size().height);
            } else {
                $(this_._dom).scrollTop($(this_._dom).scrollTop() + _iBounds.size().height);
            }
        }
    }
    if(typeof _this_._replaceIndex != 'number' || _this_._replaceIndex == _this_.index)
    {
        //  
        _this_._replaceIndex = _this_.index + 1;
    }

    if(_this_._replaceIndex >= this_._items.length)
        this_._dom._ul.append(this_._blackLi);
    else
    {
        $(this_._blackLi).insertBefore(this_._items[_this_._replaceIndex]).show();
    }
};

KList.prototype._docMouseUp = function(event)
{
	
    if(event.button == 2) return;
    var this_ = event.data.this_;
    var _this_ = event.data._this_;
    this_._releaseCapture(_this_);
    if(_this_.moved != true)
    {
        if(event.target != _this_._as.get(0) && event.target != _this_._as.get(1))
        {
			
            this_._liClickFun.apply(_this_, [event]);
        }
    } else {
        $(this_._blackLi).appendTo(document.body).hide();
        $(this_._moveDiv).hide();
        this_._moveDiv._on = false;
        //
        if(_this_._replaceIndex >= this_._items.length)
            this_._dom._ul.append(_this_);
        else
            $(this_._items[_this_._replaceIndex]).before(_this_);
        if(_this_._replaceIndex != _this_.index + 1)
        {
            this_._updateItemAndSelect(true);
            KEvent.trigger(this_, "aftersort", this_, this_._liDomToItem(_this_));
        }
    }
    KEvent.unbind(document, "mousemove", this_._docMouseMove);
    KEvent.unbind(document, "mouseup", this_._docMouseUp);
    _this_.moved = false;
    return KTools._stopPropagation(event);
};

KList.prototype._liEvents = function(liDom)
{
    //li
    KEvent.bind(liDom, "mousedown", function(event) {

        var this_ = event.data.this_;
        if(event.target == this_._editInput || event.button == 2) return;
        this.moved = false;
        this._downX = event.pageX;
        this._downY = event.pageY;
        this._bounds = KTools.getBounds(this);
        this_._setCapture(this);
        if(this_._opts.sortable == true && this_._items.length > 1) KEvent.bind(document, "mousemove", this_._docMouseMove, {this_:this_, _this_:this});
        KEvent.bind(document, "mouseup", this_._docMouseUp, {this_:this_, _this_:this});
        return KTools._stopPropagation(event);
    }, {this_ : this});
    KEvent.bind(liDom._span0Input.get(0), "click", function(){
        if(this.checked) $(this).attr("checked", "");
        else $(this).attr("checked", "checked");
    });

    KEvent.bind(liDom, "mouseover", function(event) {
        var this_ = event.data.this_;
        if(this_._moveDiv._on == true) return;
        if(this_._opts.userstyle == false)
        {
            if(this_.lastHLi && !this_.lastHLi.selected) $(this_.lastHLi).removeClass();
            $(this).addClass(this_._theme + "_lst_h");
            this_.lastHLi = this;
        }
        if(this_._opts.scroll2view) KTools.scrollIntoView(this, $(this).parent().parent()[0]);
    }, {this_:this});
    KEvent.bind(liDom, "mouseout", function(event) {
        var this_ = event.data.this_;
        if(this_._moveDiv._on == true) return;
        if(this_._opts.userstyle == false) $(this).removeClass(this_._theme + "_lst_h");
    }, {this_:this});
    var _as = liDom._as;
    //edit
    if(this._opts.editable && liDom.editable) KEvent.bind(_as.eq(0).get(0), "click", this._editClickFun, {this_ : this, _this_: liDom});
    //del
    if(this._opts.deleteable && liDom.deletable) KEvent.bind(_as.eq(1).get(0), "click", this._delClickFun, {this_ : this, _this_: liDom});
};

KList.prototype._initLiAttr = function(liDom)
{
    liDom = $(liDom).get(0);
    liDom._spans = $(">span", liDom);
    liDom._span0Input = $(">input", liDom._spans.eq(0));
    liDom._labels = $(">label", liDom);
    liDom._as = $(">a", liDom);

    liDom.index = parseInt($(liDom).attr("index"));
    liDom.text = liDom._labels.eq(0).text();
    if($(liDom).attr("kvalue") == undefined) liDom.kvalue = "";
    else liDom.kvalue = $(liDom).attr("kvalue");
    if($(liDom).attr("deletable") == undefined) liDom.deletable = KListItem.deletable;
    else liDom.deletable = ("true" == $(liDom).attr("deletable")) ? true : false;
    if($(liDom).attr("editable") == undefined) liDom.editable = KListItem.editable;
    else liDom.editable = ("true" == $(liDom).attr("editable")) ? true : false;
    if($(liDom).attr("selected") == undefined) liDom.selected = KListItem.selected;
    else liDom.selected = ("true" == $(liDom).attr("selected")) ? true : false;

    if(liDom.selected)
    {
        liDom._span0Input.attr("checked", "checked");
        if(this._opts.userstyle == false) liDom.className = this._theme + "_lst_s";
    } else {
        liDom._span0Input.attr("checked", "");
        if(this._opts.userstyle == false) liDom.className = "";
    }
    this._updateButtons(liDom);
    liDom.node = liDom;
    liDom.iconClass = liDom._spans.eq(1).attr("class");
    
};

KList.prototype._updateButtons = function(liDom)
{
    var _as = liDom._as;
    if(this._opts.deleteable && liDom.deletable) _as.eq(1).show(); else _as.eq(1).hide();
    if(this._opts.editable && liDom.editable) _as.eq(0).show(); else _as.eq(0).hide();

};

KList.prototype._setCapture = function(dom) {
    if(dom.setCapture) {
        dom.setCapture();
    } else if(window.captureEvents) {
        window.captureEvents(Event.MOUSEMOVE | Event.MOUSEUP);
    }
};

KList.prototype._releaseCapture = function(dom) {
    if(dom.releaseCapture){
        dom.releaseCapture();
    }else if(window.captureEvents){
        window.captureEvents(Event.MOUSEMOVE|Event.MOUSEUP);
    }
};

KList.prototype._updateItemAndSelect = function(item, regetLis)
{
    var this_ = this;
    if(typeof regetLis != "boolean") regetLis = true;
    if(regetLis) this._lis = $(">ul >li", this._dom);
    //:this._span0Input,
    try{
	    if(item)
	    {
	        this_._items = [];
	        this_._selected = [];
	        this._lis.each(function() {
	            this.index = this_._items.length;
	            this_._items.push(this);
	            if(this.selected)
	            {
	                this._selectedIndex = this_._selected.length;
	                this_._selected.push(this);
	        	    this._span0Input.eq(0).attr("checked", "checked");
	            }
	        });
	    } else {
	        this_._selected = [];
	        this._lis.each(function() {
	            if(this.selected)
	            {
	                this._selectedIndex = this_._selected.length;
	                this_._selected.push(this);
	                this._span0Input.eq(0).attr("checked", "checked");
	            }
	        });
	    }
    }catch(e){}
};
/*
 
 xionggq fuyg
 2.1.1
 2010-03-08
 2010-03-08 23:07
 ============================================
 
opt#1010081700
mwpf
opt# 1011031702

opt#

bug#201012161519
{}
opt#201101111618

bug#201101141437
ie
 */
var KLocalsearch = KClass.create("KLocalsearch", KQuery);
KLocalsearch.conf =
{
    CLASSNAME :
    {
        //
        LS : "_ls"
    	// added by zwq
        ,SS: "_ls_ss"
        //
        ,TIP : "_ls_tip"
        //	
        ,CLB : "_ls_clb"
		//
		,HS:"_ls_hs"
		//
		,ST:"_ls_st"
		//
		,SC:"_ls_sc"
		//
		,HSM:"_ls_hsm"
		//
		,HSB:"_ls_hsb"
		//
		,HST:"_ls_hst"
        //
        ,RLT : "_ls_rlt"
        //
        ,RLS : "_ls_rls"
        //
        ,M : "_ls_m"
        //
        ,VA : "_ls_va"
        //
        ,RLN : "_ls_rln"
        //1
        ,RLN1 : "_ls_rln_"
        //
    	,RLNTG : "_ls_tg_rln"
    	//1	
		,RLNTG1 : "_ls_tg_rln"
        //
        ,LSS:"_ls_s"
        //
        ,LSPM:"_ls_pm"
        //
        ,SDB  :"_ls_sdb"
        ,MK : "_ls_mk"
        ,MHK : "_ls_mkh"
    }
};

/**
 * 
 * @param container
 * @param opts
 * @return String
 * @uncrunch
 */
KLocalsearch.initialize = function(container, opts)
{
    var _this = this;
    this._opts = KTools.copyOptions(opts, KLocalsearchOptions);
    this._theme = this._opts.theme;
    this._addMarkerFlag = false;
    this._cityRedirect = false;
    //c=&k=&pn=1&rn=10&cn=&cll=&cid=
    this._hashkeys = [ "k,c,pn,rn", "k,c,pn,rn,cn,cid", "k,c,pn,rn,cn,cid,cll", "k,c,pn,rn,pt,b", "k,c,pn,rn,n",
			"k,c,pn,rn,cn,cid,n", "k,c,pn,rn,cn,cid,cll,n", "k,c,pn,rn,pt,b,n" ];
    //add by fuyg: mwpf _hashkeys
    _this._mwpf= KConfig.get("mwpf");
    //add by zhangwq 
    this._isGasline = false;
    //add by ligj poi 
    this._isShowPoiListTopAd = false;
    
    
    //add by zhangwq 
    this._rainDropsLayer = null;
    this._lyptitle = $("#ylptitle").hide();
    
    this._queryopts = null;
    this._domAll = $(container);
    this._dom = this._domAll.get(0);

    //add by ligj poiDom 
    this._poiListTopAdDom = $(">div", this._domAll).eq(0).hide()
    
    //dom
    this._spellECDom = $("#spell_ec").hide();
    this._spellEcTipDom = $(">div", this._domAll).eq(1).hide();
    
    //added by zwq dom
    this._stdDom = $(">div", this._domAll).eq(2).hide();
    //this._stdHrefDom = $(">div>a", this._stdDom).eq(0);
    
    //added by zwq dom
    this._logDom = $(">div", this._domAll).eq(3).hide();
    this._logContent = $(">div", this._logDom).eq(0);
    this._logMore = $(">div>a", this._logDom).eq(0);
    this._logmoreFlag = true;
    
    //added by zwq dom
    this._ssDom = $(">div", this._domAll).eq(4).hide();
    this._ssDomContent = $(">div", this._ssDom).eq(0);
    this._ssMore = $(">div>span>a", this._ssDom).eq(0);
    this._ssmoreFlag = true;
    
    //divdiv
    var domIndex = 5;
    
    //dom
    this._tipDom = $(">div", this._domAll).eq(domIndex).hide();
    //this._tipHrefDom = $(">div>a", this._tipDom).eq(0);
    
    //dom
    this._hotelDom = $(">div", this._domAll).eq(domIndex+1).hide().addClass(this._theme + KLocalsearch.conf.CLASSNAME.HS);
    
    //dom
    this._topsxDom = $(">div", this._domAll).eq(domIndex+2).hide();
    
    this._isInitTopSx = false;
    
	//
	$(function(){
		_this._initHotelDom.apply(_this);
	});
	//
    this._gopageFlag = true;
    this._extendFlag = true;
    /*this._tipHrefDom.click(function() {
        KEvent.trigger(_this, "tipclick", _this, _this._queryopts.ls);
    });*/
    this._resultDom = $(">ol", this._domAll).eq(0);
    if (!this._resultDom)
    {
        this._resultDom = null;
    }
    //add by fuyg 2010-7-22
    this._queryHash=null;
    this._sendIndex=0;
	//added by zy,,
	this._sendFromBubble = false;
	this._bubbleIndex = 0;
    //
    this._queryResult = null;
    this._resultliDom = null;
    this._currentPage = 1;
    this._pagesize = 10;
    this._extendParam = "";
    _this._fitzoomflag = true;
    this._lsNoResultTip = $(">div", this._domAll).eq(domIndex+3).hide();
    this._$adWrap = $(">div", this._domAll).eq(domIndex+4);
	this._adHtml="";
	this._repeatTimes=0;
	//
	this._moEventTarget={};
	//
	var setAdHtml=function(){
		var $ads = $("a", _this._$adWrap);
		if (!_this._adHtml) {
			if ($ads.length) {
				var $tempDiv = $("<div/>");
				$ads.each(function(){
					$(this).clone().appendTo($tempDiv);
				});
				var html = $tempDiv.html();
				_this._adHtml = html;
			} else {
				if (_this._repeatTimes < 10) {
					_this._repeatTimes++;
					window.setTimeout(setAdHtml, 1000);
				}
			}
		}
	};
	if(this._$adWrap && this._$adWrap.length){
		this._$adWrap.hide();
		setAdHtml();
	}
	
    //
    //,
    this._KLocalsearch_bind_afteropeninfowindow = null;
    //N,0, 
    _this._showOnlyN=-1;
	//url
    this._forMobile = {
        latlon: undefined,
        name: undefined,
		level:undefined
    };
	this._IWDatePickers = {};
	//30sKDatePicker
	this._intervalID = 	window.setInterval(function(){
		_this._IWDatePickersMgr.apply(_this);
	}, 30000);
	
	// googletruefalse
	this._enableGoogleAd = false;
	
	this._rightKeyLatlon = undefined;


	
};
KLocalsearch.prototype._initDom = function()
{
    var _this = this;

    this._tipCloseDom = $(">div>span", this._tipDom).eq(0);
    this._selectMarker = null;
    this._selectLi = null;
    this._tipCloseDom.unbind("click").click(function(e) {
        e.stopPropagation();
        _this._tipDom.hide();
        _this._layoutDom();
        KEvent.trigger(_this, "tipclosed", _this);
    });
    
    this._stdCloseDom = $(">div>span", this._stdDom).eq(0);
    this._stdCloseDom.unbind("click").click(function(e) {
        e.stopPropagation();
        _this._stdDom.hide();
        _this._layoutDom();
        KEvent.trigger(_this, "tipclosed", _this);
    });
};
/**
 * 
 * @return String 
 * @uncrunch
 */
KLocalsearch.prototype.version = function()
{
    return "2.1.1";
};
/**
 * 
 * @return String
 * @uncrunch
 */
KLocalsearch.prototype.finalize = function()
{
    var _this = this;
	window.clearInterval(this._intervalID);
	this._clearIWDatePickers();
	if(this._startPicker && typeof  this._startPicker.finalize === "function"){
		this._startPicker.finalize();
	}
	if(this._endPicker && typeof  this._endPicker.finalize === "function"){
		this._endPicker.finalize();
	}
    KEvent.clear($(">a", _this._tabCloseDom));
    KEvent.clear(_this._tabCloseDom);
   this._clearLiEvent();
   //
   if(_this._resultDom&&_this._resultDom.empty){
	   _this._resultDom.empty();
   }
  // KTools.removeNode(this._dom);
};
KLocalsearch.prototype._clearLiEvent = function()
{
   if (this._resultliDom != null)
    {
        this._resultliDom.each(

                function(index, domEl)
                {
                    KEvent.clear($(this));
                    KEvent.clear($(">h2>a", $(this)).eq(0));
                    KEvent.clear($(">h2>a", $(this)).eq(1));
                    KEvent.clear($("a[mfg='fs']", $(this)).eq(0));
                    KEvent.clear($("a[mfg='jp']", $(this)).eq(0));
                    KEvent.clear($("a[mfg='jd']", $(this)).eq(0));
                    KEvent.clear($("a[mfg='su8']", $(this)).eq(0));
                    KEvent.clear($("a[mfg='58z']", $(this)).eq(0));
                    KEvent.clear($("a[mfg='58e']", $(this)).eq(0));
                    KEvent.clear($("a[mfg='qbfd']", $(this)).eq(0));
                });
        this._resultliDom.empty();
    }
};
/**
 * 
 * @return String
 * @uncrunch
 */
KLocalsearch.prototype.cnname = function()
{
    return "";
};

/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KLocalsearch.prototype.dependent = function()
{
    return [ KClass, KConfig, KEvent, KFeedbackType, KLine, KListener, KLocalsearchOptions, KMap, KMarker, KNamedValue,
			KObject, KPOIType, KPOInfo, KPrintOptions, KQuery, KQueryOptions, KQueryType, KSendOptions, KSendType,
			KTools, KUrlHash, KWidgetFlag, jQuery, KDatePicker ];
};
/**
 *  
 * @return String
 * @uncrunch
 */
KLocalsearch.prototype.flag = function()
{
    return KWidgetFlag.localsearch;
};
KLocalsearch.prototype._setOptions = function(opt)
{
    var _this = this;
    this._theme = this._opts.theme;
    var diffOpts = KTools.compareOptions(this._opts, opt);
    $.each(diffOpts, function(name, value) {
        switch (name)
        {
            case 'theme':
                _this._setOption({'theme':value});
                _this._updateThemeOptions();
                break;
            /* case 'result':
             _this._setOption({'result':value});
             _this._updateResultOption();
             break;
             case 'mapoperation':
             _this._setOption({'mapoperation':value});
             _this._updateMapoperation();
             break;*/
            case  'initmap':
                _this._setOption({'initmap':value});
                _this._updateInitmapOption();
                break;
            case 'tipurl' :
                _this._setOption({'tipurl':value});
                _this._updateTipurl();
                break;
            case 'url':
                _this._setOption({'url': value});
                break;
            default:
        }
    });
};
KLocalsearch.prototype._setOption = function(opts)
{
    this._theme = this._opts.theme;
    this._opts = KTools.copyOptions(opts, this._opts);
};
/**
 * 
 * @param opt
 * @uncrunch
 */
KLocalsearch.prototype.setOptions = function(opt)
{
    this._theme = this._opts.theme;
    this._setOptions(opt);
};
/**
 *  
 * @uncrunch
 */
KLocalsearch.prototype.setTheme = function(scheme)
{
    this._setOptions({theme:scheme});
};
/**
 * 
 * @uncrunch
 */
KLocalsearch.prototype.layout = function()
{
    this._layoutDom();
};
/**
 *  Hash
 * @return String
 * @uncrunch
 */
KLocalsearch.prototype.queryByHash = function(hash) {
	KQuery.prototype.queryByHash.call(this, hash);
	var queryHash = hash;
	var _this = this;
	this._extendParam = "";
	if (this._resultDom != null) {
		KQuery.prototype.queryByHash.call(this, hash);
		var queryOptions = KTools.copyOptions( {}, KQueryOptions);
		queryOptions.ls = KTools.copyOptions( {}, KPOInfo);
		if (queryHash.value("c") != null) {
			queryOptions.ls.city = queryHash.value("c");
		}
//		if (queryHash.value("vs") == "true") {
//			queryOptions.ls.vs = true;
//		}else{
		queryOptions.ls.vs = false;
//		}
		/******/
		if(queryHash.value("uid")!=null){
			queryOptions.ls.uid = queryHash.value("uid");
		}
		
		/******/
        if (queryHash.value("z")) {
            queryOptions.ls.level = parseInt(queryHash.value("z"), 10);
            if (queryHash.value("k") != null) {
                var kVal = queryHash.value("k");
				var kArr = kVal.split("_");
				queryOptions.ls.latlon = kArr[0];
				queryOptions.ls.name = kArr[1] || "";
            }
        } else {
            if (queryHash.value("k") != null) {
                queryOptions.ls.name = queryHash.value("k");
            }
        }
		if (queryHash.value("pn") != null) {
			this._currentPage = parseInt(queryHash.value("pn"));
		}
		if (queryHash.value("cn") != null) {
			queryOptions.center = KTools.copyOptions( {}, KPOInfo);
			queryOptions.center.pid = undefined;
			queryOptions.center.name = queryHash.value("cn");
			if (queryHash.value("cid") != null) {
				queryOptions.center.pid = queryHash.value("cid");
			}
			if (queryHash.value("cll") != null) {
				queryOptions.center.latlon = queryHash.value("cll");
			}
		} else {
			queryOptions.center = undefined;
		}
		this._gopageFlag = false;
		this._extendFlag = true;
		if (queryHash.value("rn") != null) {
			this._pagesize = queryHash.value("rn");
		}
		if (queryHash.value("b") != null) {
			this._extendFlag = false;
			this._extendParam = this._extendParam + "&b=" + queryHash.value("b");
		}
		if (queryHash.value("pt") != null) {
			this._extendFlag = false;
			this._extendParam = this._extendParam + "&pt=" + queryHash.value("pt");
		}
		if (queryHash.value("n") != null) {
			_this._showOnlyN = queryHash.value("n");
			_this._showOnlyN = parseInt(_this._showOnlyN, 10);
			if (isNaN(_this._showOnlyN)) {
				_this._showOnlyN = -1;
			}
		} else {
			_this._showOnlyN = -1;
		}
		queryOptions.type = KQueryType.localsearch;
		_this.query(queryOptions);
	} else {
	}
};

/**
 * opts _queryopts = opts 
 *
 * @return String
 * @uncrunch
 */
KLocalsearch.prototype.viewSearchQuery = function(city,keyword){
	
	var _this = this;
	var queryOptions = null;
	if(!_this._queryopts){
		queryOptions = KTools.copyOptions( {}, KQueryOptions);
		queryOptions.ls = KTools.copyOptions( {}, KPOInfo);
		queryOptions.type = "ls";
	}else{
		queryOptions = _this._queryopts;
	}
	queryOptions.ls.city = city;
	queryOptions.ls.name = keyword;
	queryOptions.ls.vs = true;
	queryOptions.ls.noqas = true;
    queryOptions.center = null;
	_this.query(queryOptions);
};

/**
 * opts _queryopts = opts 
 *
 * @return String
 * @uncrunch
 */
KLocalsearch.prototype.query = function(queryOpt){
	
	
    var _this = this;
    KQuery.prototype.query.call(this, queryOpt);
    _this._isGasline = false;//[]
    _this._isShowPoiListTopAd = false;
    
    var queryHash = new KUrlHash();
    var hasUseUid = false;
    if (queryOpt.ls) {
    	
        if (queryOpt.ls.city) {
            queryHash.setKey("c", queryOpt.ls.city);
        }
        
        if (queryOpt.ls.uid) {
            queryHash.setKey("uid", queryOpt.ls.uid);
            hasUseUid = true;
        }
        //url
        var setMobileInfo = function(hash, ls){
            hash.setKey("z", ls.level);
            var kVal = "";
            if (ls.latlon) {
                kVal = ls.latlon + "";
                kVal += "_" + (ls.name || "");
                hash.setKey("k", kVal);
            }
        }
        if (queryOpt.ls.level != undefined) {
            setMobileInfo(queryHash, queryOpt.ls);
            this._forMobile.level = queryOpt.ls.level;
            this._forMobile.name = queryOpt.ls.name;
            this._forMobile.latlon = queryOpt.ls.latlon;
        } else {
            if (this._forMobile.latlon != undefined && (this._forMobile.name === queryOpt.ls.name)) {
                queryOpt.ls.latlon = this._forMobile.latlon;
                queryOpt.ls.level = this._forMobile.level;
                setMobileInfo(queryHash, queryOpt.ls);
            } else {
                this._forMobile.level = undefined;
                this._forMobile.name = undefined;
                this._forMobile.latlon = undefined;
                if (queryOpt.ls.name) {
//                	var keyword = "";
                    queryHash.setKey("k", queryOpt.ls.name);
//                    (keyword === queryOpt.ls.name) ?_this._isGasline = true : _this._isGasline = false ;
                }
            }
        }
        if (this._gopageFlag) {
            this._currentPage = 1;
        }
        if (this._extendFlag) {
            this._extendParam = "";
        } else {
            var getb = _this._getRequestParam('b');
            var getpt = _this._getRequestParam('pt');
            (getb !== null) && (queryHash.setKey("b", getb));
            (getpt !== null) && (queryHash.setKey("pt", getpt));
        }
        // queryHash.setKeyString
        queryHash.setKey("pn", this._currentPage + "");
        queryHash.setKey("rn", this._pagesize + "");
        if (queryOpt.center) {
            if (queryOpt.center.name && queryOpt.center.name != "") {
                queryHash.setKey("cn", queryOpt.center.name);
            }
            if (queryOpt.center.latlon) {
                queryHash.setKey("cll", queryOpt.center.latlon);
            } else {
                //queryHash.setKey("cll", "");
            }
            if (queryOpt.center.pid) {
                queryHash.setKey("cid", queryOpt.center.pid);
            } else {
                //queryHash.setKey("cid", "");
            }
        }
        if (this._opts.searchbox && !hasUseUid) {
            this._opts.searchbox.query(queryOpt, true);
        }
        //
        if (_this._showOnlyN > -1 && _this._showOnlyN < _this._pagesize) {
            queryHash.setKey("n", _this._showOnlyN);
        } else {
            queryHash.remove("n");
        }
        //
        queryHash.setKey(_this._mwpf, _this.flag());
    }
    KListener.setHash(queryHash, true, false);
    this._gopageFlag = true;
    this._extendFlag = true;
    if (this._resultDom != null) {
    	_this._ajaxPostRequest();
    } else {
    }
};
/**
 * searchberfore
 */
KLocalsearch.prototype._searchbeforeEvent = function(){
    KEvent.trigger(this, "searchbefore", this, this._queryopts);
};
/**
 * resultload
 */
KLocalsearch.prototype._resultloadedEvent = function()
{

    KEvent.trigger(this, "resultloaded", this,"query",this._result);
};
/**
 * resultshow
 */
KLocalsearch.prototype._resultshowEvent = function()
{
	var _this=this;
    KEvent.trigger(this, "resultshown", this, "query", this._result);
    this._addResultEvent();
	
};
/**
 * theme
 */
KLocalsearch.prototype._updateThemeOptions = function(){
	
    var _this = this;
    this._domAll.removeClass(this._theme + KLocalsearch.conf.CLASSNAME.LS).addClass(this.theme() + KLocalsearch.conf.CLASSNAME.LS);
    //added by zwq dom
    this._ssDom.removeClass(this._theme + KLocalsearch.conf.CLASSNAME.TIP).addClass(this.theme() + KLocalsearch.conf.CLASSNAME.TIP);
    this._logDom.removeClass(this._theme + KLocalsearch.conf.CLASSNAME.TIP).addClass(this.theme() + KLocalsearch.conf.CLASSNAME.TIP);
    
    this._stdDom.removeClass(this._theme + KLocalsearch.conf.CLASSNAME.TIP).addClass(this.theme() + KLocalsearch.conf.CLASSNAME.TIP);
    
    this._tipDom.removeClass(this._theme + KLocalsearch.conf.CLASSNAME.TIP).addClass(this.theme() + KLocalsearch.conf.CLASSNAME.TIP);
    this._tipCloseDom.removeClass(this._theme + KLocalsearch.conf.CLASSNAME.CLB).addClass(this.theme() + KLocalsearch.conf.CLASSNAME.CLB);
    if (this._resultDom != null) {
        this._resultDom.removeClass(this._theme + KLocalsearch.conf.CLASSNAME.RLT).addClass(this.theme() + KLocalsearch.conf.CLASSNAME.RLT);
        //$(">li",_this._resultDom).removeClass(this._theme + KLocalsearch.conf.CLASSNAME.RLS).addClass(this._theme + KLocalsearch.conf.CLASSNAME.RLS)
        $("a[mfg='fs']", _this._resultDom).removeClass(this._theme + KLocalsearch.conf.CLASSNAME.SDB).addClass(this._opts.theme + KLocalsearch.conf.CLASSNAME.SDB);
        $(">li", _this._resultDom).each(function(index){
        	// t
        	var t = $("a[mfg='rz']", $(this)).eq(0).length>0 ? t =true : t = false;
        	
            $(">h2>a", $(this)).eq(1).removeClass(_this._theme + KLocalsearch.conf.CLASSNAME.M).addClass(_this._opts.theme + KLocalsearch.conf.CLASSNAME.M);
			var len = $(">div", $(this)).length;
            if (len > 1) {
                $(">div", $(this)).eq(len-2).removeClass(_this._theme + KLocalsearch.conf.CLASSNAME.VA).addClass(_this._opts.theme + KLocalsearch.conf.CLASSNAME.VA);
                $(">div", $(this)).eq(len-1).removeClass(_this._theme + KLocalsearch.conf.CLASSNAME.RLN).removeClass(_this._theme + KLocalsearch.conf.CLASSNAME.RLN1 + (index + 1)).addClass(_this._opts.theme + KLocalsearch.conf.CLASSNAME.RLN).addClass(_this._opts.theme + KLocalsearch.conf.CLASSNAME.RLN1 + (index + 1));
                if(t){
                    $(">div", $(this)).eq(len-1).removeClass(_this._theme + KLocalsearch.conf.CLASSNAME.RLNTG).removeClass(_this._theme + KLocalsearch.conf.CLASSNAME.RLNTG1 + (index + 1)).addClass(_this._opts.theme + KLocalsearch.conf.CLASSNAME.RLNTG).addClass(_this._opts.theme + KLocalsearch.conf.CLASSNAME.RLNTG1 + (index + 1));
                }
            
            } else {
                $(">div", $(this)).eq(len-1).removeClass(_this._theme + KLocalsearch.conf.CLASSNAME.RLN).removeClass(_this._theme + KLocalsearch.conf.CLASSNAME.RLN1 + (index + 1)).addClass(_this._opts.theme + KLocalsearch.conf.CLASSNAME.RLN).addClass(_this._opts.theme + KLocalsearch.conf.CLASSNAME.RLN1 + (index + 1));
                if(t){
                    $(">div", $(this)).eq(len-1).removeClass(_this._theme + KLocalsearch.conf.CLASSNAME.RLNTG).removeClass(_this._theme + KLocalsearch.conf.CLASSNAME.RLNTG1 + (index + 1)).addClass(_this._opts.theme + KLocalsearch.conf.CLASSNAME.RLNTG).addClass(_this._opts.theme + KLocalsearch.conf.CLASSNAME.RLNTG1 + (index + 1));
                }
            }
        });
    }
};
KLocalsearch.prototype._updateTipurl = function()
{
    var _this = this;
//    this._tipHrefDom.unbind("click").click(function() {
//    	KEvent.trigger(_this, "tipclick", _this, _this._queryopts.ls);
//        var value = $(this).html();
//        var opts = KTools.copyOptions({}, KQueryOptions);
//        opts.type = KQueryType.busline;
//        opts.busline = KTools.copyOptions({}, KPOInfo);
//        opts.busline.name = value;
//        if (_this._opts.searchbox)
//        {
//            _this._opts.searchbox.query(opts, false);
//        }
//    });
//    this._stdHrefDom.unbind("click").click(function() {
//    	KEvent.trigger(_this, "stdclick", _this, _this._queryopts.ls);
//        var value = $(this).html();
//        var opts = KTools.copyOptions({}, KQueryOptions);
//        opts.type = KQueryType.bustation;
//        opts.bustation = KTools.copyOptions({}, KPOInfo);
//        opts.bustation.name = value;
//        if (_this._opts.searchbox)
//        {
//            _this._opts.searchbox.query(opts, false);
//        }
//    });
};
/**
 * ajax
 */
KLocalsearch.prototype._ajaxPostRequest = function(qtype){
    var _this = this;
    //
    _this._searchbeforeEvent();
    var ajaxUrl = _this._opts.url;
    var hash = new KUrlHash();
    hash.setKey("s", "json");
    hash.setKey("pn", _this._currentPage + "");
    hash.setKey("rn", _this._pagesize);
    if (_this._queryopts.ls) {
        if (_this._queryopts.ls.city) {
            hash.setKey("c", _this._queryopts.ls.city);
        } else {
            //hash.setKey("c", _this._queryopts.ls.city);
        }
        //
        if (_this._queryopts.ls.topicPara && _this._isInitTopSx) {
        	hash.setKey("tp", _this._queryopts.ls.topicPara);
        }
        var keywordFlag = "k";
        if (_this._queryopts.ls.uid) {
            hash.setKey("uid", _this._queryopts.ls.uid);
            keywordFlag = "id";
        }
        if (_this._queryopts.ls.name) {
            hash.setKey(keywordFlag, _this._queryopts.ls.name);
        }
        
        // 7
//        if(KMap.zoom()>7 && _this._queryopts.ls.vs){
        if(_this._queryopts.ls.vs){
        	hash.setKey("ll", KMap.getMapViewBound().LeftUp);
        	hash.setKey("rl", KMap.getMapViewBound().RightDown);
        }

        if(_this._queryopts.ls.noqas){
        	hash.setKey("qas", "false");
        }
        //level,url
        if (_this._queryopts.ls.level) {
            hash.setKey("z", _this._queryopts.ls.level);
            var kVal = "";
            if (_this._queryopts.ls.latlon) {
                kVal = _this._queryopts.ls.latlon + "";
                kVal += "_" + (_this._queryopts.ls.name + "");
                hash.setKey("k", kVal);
                hash.setKey("kt", "1");
            }
        }
        //
        var ct = _this._queryopts.center;
        if (ct && ct.pid) {
            hash.setKey("cid", ct.pid);
        }
        if (ct && (ct.name || ct.latlon)) {
            hash.setKey("t", "ns");
            //hash.setKey("r", 2000);
            ct.name && hash.setKey("cn", ct.name);
            if(ct.name === "" && _this._rightKeyLatlon){
            	ct.latlon = _this._rightKeyLatlon;
            }
            ct.latlon && hash.setKey("cll", ct.latlon);
        } else {
            hash.setKey("t", "s1.2");
        }
        //added by zwq 
        if(!_this._ssmoreFlag){
        	hash.setKey("v","false");
        	_this._ssmoreFlag = true;
        }
        if(!_this._logmoreFlag){
        	hash.setKey("ns","false");
        	_this._logmoreFlag = true;
        }
        
        if (_this._extendParam != "") {
            var getb = _this._getRequestParam('b');
            var getpt = _this._getRequestParam('pt');
            (getb !== null) && (hash.setKey("b", getb));
            (getpt !== null) && (hash.setKey("pt", getpt));
        }
        if (_this._showOnlyN > -1 && _this._showOnlyN < _this._pagesize) {
            hash.setKey("n", _this._showOnlyN);
        } else {
            hash.remove("n");
        }
    }

    //added by zwq 
    hash.setKey("w", $(_this._opts.mapcontainer).width() + "");
    hash.setKey("h", $(_this._opts.mapcontainer).height() + "");
    
    var cl = KMap.maplet().getCenter();
    if(_this._queryopts.ls.topicFlag && _this._result && _this._result.d && _this._result.d.c){
    	cl = _this._result.d.c;
    }
    
    hash.setKey("cl", cl);
    
    if(_this._result && _this._result.pt){
        hash.setKey("pt", _this._result.pt);
    }


    _this._queryHash = hash;
    if (_this._opts.url) {
        if (ajaxUrl.indexOf("?") != -1) {
            var num = ajaxUrl.indexOf("?");
            ajaxUrl = ajaxUrl.substring(0, num);
        }
        $.ajax({
            type: "GET",
            url: ajaxUrl,
            cache: false,
            data: (hash.toString()),
            error: function(XMLHttpRequest, textStatus, errorThrown){
                if (!KMap.isInitialized(_this._opts.mapcontainer)) {
                    KEvent.trigger(_this, "mapready", _this, undefined, undefined);
                }
            },
            success: function(data){
            	_this._lyptitle.hide();
            	_this._poiListTopAdDom.hide();
            	_this._topsxDom.hide();
            	_this._spellECDom.hide();
            	_this._spellEcTipDom.hide();
            	_this._hotelDom.hide();
            	
                if (!data) {
                    _this._lsNoResultTip.show();
           			$(">div",_this._lsNoResultTip).eq(1).hide().end().eq(0).show();
                    return;
                }
                
                _this._result = data;
                
                //
                if(data && data.k && data.k.a === "true") {
                    _this._hotelBaseUrl = data.k.b;
                    _this._hotelDom.show()
                } else {
                    _this._hotelDom.hide();
                }
                
                
                //
                if(data && data.th){
                	_this._initTopSx();
                } 
                
                //
            	if(data && data.sf){
            		_isShowPoiListTopAd = true;
            		var re1=/^http:\/\//;
            		if(!re1.test(data.sf.b)){
            			data.sf.b = "http://"+data.sf.b;
            		}
            		$(">a",_this._poiListTopAdDom).attr("href",data.sf.b).attr("title",data.sf.c);
            		$(">a>img",_this._poiListTopAdDom).attr("src",data.sf.a);
                    $(_this._poiListTopAdDom).show();
            	}
            	//
            	if(data && data.qas){
            		var qas = data.qas;
					var lsDom = $(">div",_this._lsNoResultTip).eq(3);
					if(qas.c){
						var _lsDom = $(">div",lsDom).hide().eq(0).show(); 
						
						$("strong",_lsDom).html("");
						$("p",_lsDom).eq(1).html("");
						$("img",_lsDom).attr("src","").hide();
						
						$("strong",_lsDom)
							.eq(0).html(qas.c + qas.d).end()
							.eq(1).html(_this._queryopts.ls.city).end()
							.eq(2).html('"'+_this._queryopts.ls.name+'"');
						$("a",_lsDom).eq(0).attr("href",qas.u);
						$("a",_lsDom).eq(1).click(function(){
							_this._queryopts.ls.noqas = true;
							_this.query(_this._queryopts);
						});
						if(qas.i){
							$("img",_lsDom).attr("src",qas.i).show();
						}else{
							$("img",_lsDom).hide();
						}
						$("p",_lsDom).eq(1).html(qas.m);
					}else{
						var _lsDom = $(">div",lsDom).hide().eq(1).show(); 
						$("strong",_lsDom)
							.eq(0).html(qas.a).end()
							.eq(1).html(_this._queryopts.ls.city).end()
							.eq(2).html('"'+_this._queryopts.ls.name+'"');
						$("a",_lsDom).click(function(){
							_this._queryopts.ls.noqas = true;
							_this.query(_this._queryopts);
						});
					}
					setTimeout(function(){
            			if(qas.p && qas.p.length > 0){
            				var lines = Array();
    						for(j in qas.p){
    							var line = KLine.fromEncoded(qas.p[j], qas.l[j]);
    						    KMap.addLine(line);
    						    lines = lines.concat(line.latlons());
    						}
    						KMap.fitzoom(lines);	
                        }else{
                        	KMap.setCenter(data.d.a,parseInt(data.d.b));
                        }
            		},200);
            	}
            	//
            	if(data && data.qas2){
        			var qas2 = data.qas2,
                        isCityJump = qas2.j == 'true' ? true : false,
                        cDom = _this._logDom.find('span').eq(0);
        			$("strong",_this._logDom)
        				.eq(0).html(qas2.a).end()
        				.eq(1).html(isCityJump ? _this._queryopts.ls.city : qas2.c).end()
        				.eq(2).html(_this._queryopts.ls.name);

        			
                    if(!isCityJump) {
                        cDom.hide();
                    }else{
                        cDom.show();
                    }
                    var currentCity = _this._queryopts.ls.city;
        			$("a",_this._logDom).eq(0).unbind('click')
        				.click(function(){
        					_this._queryopts.ls.noqas = true;
                            if(!isCityJump){
                                _this._queryopts.ls.city = qas2.a;
                            }else{
                                _this._queryopts.ls.city = currentCity;
                            }
                            _this.query(_this._queryopts);
        				});
        			_this._logDom.show();
        			if(qas2.a){
        				_this._queryopts.ls.city = qas2.a;
        			}
        			
            	}else{
        			_this._logDom.hide();
        		}
            	//
            	$("#spellEC_tip").hide();

            	if(data && data.sp){
            		var spells = data.sp;
            		var spanDom = null;
            		if(data.e && data.e.length > 0){
            			spanDom = $("span",_this._spellEcTipDom).eq(0).html("");
            			_this._spellEcTipDom.show();
            			$("strong",_this._spellEcTipDom).html(_this._queryopts.ls.name);
            		}else{
            			spanDom = $("span",_this._spellECDom).html("");
            			_this._spellECDom.show();
            		}
            		for ( var i = 0; i < spells.length; i++) {
            			spanDom.append('<a href="javascript:void(0)" >'+spells[i]+'</a>&nbsp;');
            			$("a",spanDom).eq(i).click(function(){
            				_this._queryopts.ls.name = $(this).html();
            				_this.query(_this._queryopts);
            			});
					}
            	}
            	//
            	if(data && data.acd){
            		var rs = data.acd;
            		var lsDom = $(">div",_this._lsNoResultTip).eq(4);
            		$("strong",lsDom).eq(0).text(_this._queryopts.ls.city);
            		$("strong",lsDom).eq(1).text(_this._queryopts.ls.name);
            		$("strong",lsDom).eq(3).text(_this._queryopts.ls.name);

                    $("strong",lsDom).eq(4).text(_this._queryopts.ls.city);
                    $("strong",lsDom).eq(5).text(_this._queryopts.ls.name);

            		$("ul",lsDom).html("");
            		for ( var i = 0; i < rs.length; i++) {
						$("ul",lsDom).append('<li><a href="javascript:void(0)" c="'+ rs[i].a +'">'+rs[i].a+'</a>&nbsp;('+rs[i].b+')</li>');
					}
            		$("ul>li>a",lsDom).click(function(){
            			_this._queryopts.ls.city = $(this).attr("c");
        				_this.query(_this._queryopts);
            		});
            		$("p>a",lsDom).eq(0).click(function(){
            			_this._queryopts.ls.city = "";
        				_this.query(_this._queryopts);
            		}).end().eq(1).click(function(){
                        _this._queryopts.ls.noqas = true;
                        _this.query(_this._queryopts);
                    });
            	}
                
                
                //
                if(_this._rainDropsLayer){
                	KMap.maplet().removeLayer(_this._rainDropsLayer, true);
                	_this._rainDropsLayer = null;
                }
                //
                if(data && data.k && data.k.a === "true"){
                	_this._baseMapLayer("jiudian");
                }
                
                _this._hotelBaseUrl = (data && data.k && data.k.b) ? data.k.b : _this._hotelBaseUrl;	
               //n
                if (_this._opts.searchbox && data.n) {
                    var qOpts = $.extend(true, {}, _this._queryopts);
                    qOpts.ls.name = data.n;
                    _this._opts.searchbox.query(qOpts, true);//searchbox
                }
                
                _this._lsNoResultTip.hide();
                
                _this._appendLiToResult();
                _this._initMapTriggest();
                //
                _this._initHotelPrice();

                if (_this._fitzoomflag && data.d && data.d.a && data.d.b) {
                    //KMap.centerAndZoom(data.d.a, parseInt(data.d.b)); //
                }
              //
//                if(_this._isGasline){
////                	_this._baseMapLayer("youlp");
//////                	_this._lyptitle.show();
//                	//KMap.centerAndZoom(data.d.a, 8);
//                }
                
                // _showOnlyN
                _this._showOnlyN = -1;
                //added by zwq 
                KMap.clearLine();
            },
            dataType: "json"
        });
    }
};

KLocalsearch.prototype._initHotelPrice = function(){
    var _this = this, jsonData = this._result, i = 0, hotelIds = [];
    if (!!jsonData && !!jsonData.e) {
        for(;i < jsonData.e.length;i++){
            if(jsonData.e[i].m && jsonData.e[i].m.e){
                hotelIds.push(jsonData.e[i].m.e);
            }
        }
        if(hotelIds.length > 0){
            //http://social.hotel.kuxun.cn/Partner/GetPriceByHotelid?hotelid=10000881,10071380&callback=1234
            setTimeout(function(){
                $.ajax( {
                    url : 'http://social.hotel.kuxun.cn/Partner/GetPriceByHotelid?hotelid='+hotelIds.join(','),
                    type : "GET",
                    dataType : "jsonp",
                    jsonp:"callback",
                    success : function(data) {
                        if(data && data.status === 1 && data.data){
                            for(var p in data.data){
                                $("#hotel_" + p + " strong").html(data.data[p].price);
                                $("#hotel_" + p).css('visibility','visible');
                            }
                        }
                    }
                });
            },500);
        }
    }
};

//
KLocalsearch.prototype._initTopSx = function() {
	var _this = this;
	var data = _this._result;
	_this._topsxDom.show();
	if(!_this._isInitTopSx){

		$(_this._topsxDom).html(data.th);
		var topsx_tabs = $(".mwp_topsx_tabs",_this._topsxDom);
		var uc = null;//
		if(data.uc){
			uc = data.uc.split("=");
		}
        topsx_tabs.width((99/topsx_tabs.length) + '%');
    	$(topsx_tabs).each(function(index,obj){
    		$(obj).addClass("mwp_topsx_tabs_"+(index+1));
    		var tabs = $(".mwp_topsx_tab",obj);
    		var title = $(".mwp_topsx_tabs_title >strong",obj).hide();
    		var key = $(obj).attr("key");
    		
    		_this._setSxKeyValue(key,"",false);
    		
			if(uc && uc[0] == key){
				_this._setSxKeyValue(key,uc[1],false);
			}
    		
			var nowCode = function (text) {
                //title.eq(0).html(text).show();
            };
			
            $(".mwp_topsx_tabs_title span").click(function (){
            	$(".mwp_topsx_tab_t2").eq(1).show();
            	$(".mwp_topsx_tab_t3").hide();
            });
            
    		$(tabs).each(function(i,o){
    			
    			var aclick = function(clickObj,clickIndex,isInit){
    				var code = $(clickObj).attr("code");
                    nowCode($(clickObj).text());
    				$("a",o).removeClass("mwp_topsx_tab_current");
    				$(clickObj).addClass("mwp_topsx_tab_current");
    				return false;
    			};
    			$("a",o).click(function(){
    				var code = $(this).attr("code");
    				var i = ($(this).index())+1;
    				var mtab2 = $("#mwp_topsx_tab"+i);
    				if(mtab2.length > 0){
    					$(".mwp_topsx_tab_t2").eq(1).hide();
    					
    					mtab2.show();
    				}
    				_this._setSxKeyValue(key,code,true);
    				aclick(this,i);
    			});
    			if(uc && uc[0] == key){
    				$("a",o).each(function(i2,o2){
        				if(uc[1] === $(o2).attr("code")){
                            (function(index,obj){
        						var upCode = $(obj).attr("u");
            					if(upCode){
            						var upObj = $("a[code='"+ upCode +"']",$(tabs).eq(index-1)).eq(0);
            						clickUp(index-1,upObj);
            					}
            					aclick(obj,index,true);
            					return false;
        					})(i,o2);
        				}
        			});
    			}else{
    				i===0 && aclick($("a",o).eq(0));//.addClass("mwp_topsx_tab_current");
    			}
    			
    		});

    		if($(tabs).length){
				$(">a",topsx_tabs).show();
				$(obj).mouseover(function(){
					$(obj).addClass("mwp_topsx_tabs_on");
				})
				.mouseout(function(){
					$(obj).removeClass("mwp_topsx_tabs_on");
				});
			}

    		
    	});
	}
	_this._isInitTopSx = false;
};
//
KLocalsearch.prototype._setSxKeyValue = function(key,value,query){
	var _this = this;
	var topicParas = new Array();
	if(_this._topicPara != undefined){
		topicParas = _this._topicPara.split(";");
	}
	
	var para = new Array();
	if(typeof(key) == "string"){
		para[0] = ""+key+"="+value+"";	
	}else{
		for(var i=0;i<key.length;i++){
			para[i] = ""+key[i]+"="+value[i]+"";
		}
	}
	
	for(var i=0 ; i<para.length; i++){
		for(var j=0 ; j<topicParas.length; j++){
			
    		if(topicParas[j]==null || para[i]==null){continue;}
    		
			var k1 = para[i].split("=");
			var k2 = topicParas[j].split("=");
			if(k1[0] == k2[0]){
				topicParas[j] = para[i];
				para[i] = null;
			}
		}
	}
	
	var newPara = new Array();
	for(var i=0 ; i<para.length; i++){
		if(para[i] != null){newPara.push(para[i]);}
	}
	var _para = topicParas.concat(newPara).join(";");
	if(_this._topicPara != _para){
		_this._queryopts.ls.topicPara = _this._topicPara = _para;
		_this._isInitTopSx = true;
		_this._queryopts.ls.topicFlag = true;
		query && _this.query(_this._queryopts);
		return false;
	}
	return false;
};
KLocalsearch.prototype._addNbMarker = function(nbcity) {
	// if (this._result && this._result.g && this._result.g.n) {
	if (this._result) {
		var centerMarkerOpts = KConfig.get("mk_mo_ct");
		centerMarkerOpts.group = KWidgetFlag.localsearch + "_center";
		
		var result = this._result.g;
		centerMarkerOpts.infowin = KConfig.get("iw_iwo_poi", {
			c : !!result ? result.c : "",
			d : !!result ? result.d : "",
			"djp" : "none",
			"djd" : "none",
			"58z" : "none",
			"58e" : "none",
            "fjjd": "none"
		});
		// 
		centerMarkerOpts.infowin.title = !!result ? result.n : "";
		centerMarkerOpts.infowin.content = "<div class='mwpg_poiw_caW'><p>" + result.c + "<br>" + result.d + "</p></div>";
		centerMarkerOpts.infowin.cmdata = {poi:{city:nbcity,name:result.n,pid:result.f,latlon:result.e}};
		var nb = null;
		if (!!result) {
			nb = new KMarker(result.e, centerMarkerOpts);
		} else {
			var val = this._queryHash.value("cll");
			if (val) {
				nb = new KMarker(val.toString(), centerMarkerOpts);
			}
		}
		if (nb) {
			KMap.addMarker(nb);
		}
		//console.log(centerMarkerOpts);
		var addMEllipse = function(){   
            var say = sax = 1000;   
            var ctr = new MPoint(result.e);   
  
            var brush = new MBrush();   
            brush.color = "gray";   
            brush.bgcolor = "gray";   
            brush.fill = true;   
            brush.transparency = 80;   
            brush.bgtransparency = 30;   
            brush.stroke = 1;
            ellipse = new MEllipse(ctr, sax, say, brush);   
            maplet.addOverlay(ellipse);   
        }
		//addMEllipse();
	}
};
/**
 * 
 */
KLocalsearch.prototype._addResultEvent = function(){
    var _this = this;
    var jsonData = _this._result;
    this._clearAllOverlay("bsline");
    _this._resultliDom = $(">li", _this._resultDom);
    var length = $(">li", _this._resultDom).length;
    $(">li", _this._resultDom).each(function(index, domEl){
		//
        $(this).mouseenter(function(e){
        	// t
        	var t = $("a[mfg='rz']", $(this)).eq(0).length>0 ? t =true : t = false;
        	
            var obj = {
                data: {
                    num: index,
                    dom: undefined,
                    tg : t
                }
            };
            if (KMap.getMarkers(KWidgetFlag.localsearch) &&
            KMap.getMarkers(KWidgetFlag.localsearch)[length - index - 1]) {
                obj = {
                    data: {
                        num: index,
                        dom: KMap.getMarkers(KWidgetFlag.localsearch)[length - index - 1],
                        tg : t
                    }
                };
            }
            _this._hiliteMarker(obj);
        }).click(function(e){
            _this._clickMarker(e, index);
        });
        
		//
        $(">h2>a", $(this)).eq(0).click(function(e){
            e.preventDefault();
        }).end().eq(1).click(function(e){
            e.stopPropagation();
        });
        // 
        if (_this._opts.sender) {
            $("a[mfg='fs']", $(this)).eq(0).show().click(function(e){
                e.stopPropagation();
                _this._sendIndex = index;
                _this.send();
            });
        } else {
            $("a[mfg='fs']", $(this)).hide();
        }
        // 
        $("a[mfg='rz']", $(this)).attr("title", "").click(function(e){
            e.stopPropagation();
            e.preventDefault();
        });
        // 
        $("a[mfg='qbfd']", $(this)).eq(0).click(function(e){
            e.stopPropagation();
            _this._tgClickFun(index, this);
            _this._extrafun("qbfd", index);
        });
        // 
        $("a[mfg='jp']", $(this)).eq(0).click(function(e){
            e.stopPropagation();
            _this._extrafun("jp", index);
        });
        // 
        $("a[mfg='jd']", $(this)).eq(0).click(function(e){
            e.stopPropagation();
            _this._extrafun("jd", index);
        });
        // 
        $("a[mfg='tg']", $(this)).eq(0).click(function(e){
            e.stopPropagation();
            _this._extrafun("tg", index);
        });
        // VIP
        $("a[mfg='su8']", $(this)).eq(0).click(function(e){
            e.stopPropagation();
            _this._extrafun("su8", index);
        });
        // 
        $("a[mfg='58z']", $(this)).eq(0).click(function(e){
            e.stopPropagation();
            _this._extrafun("58z", index);
        });
        //
        $("a[mfg='58e']", $(this)).eq(0).click(function(e){
            e.stopPropagation();
            _this._extrafun("58e", index);
        });
        
        //
        $("a[mfg='tbsc']", $(this)).eq(0).click(function(e){
            e.stopPropagation();
            _this._sendIndex = index;
            //--collection.addRecord--
            collection.addRecord(_this._getCollection());
            _this._extrafun("tbsc", index);
        });
        
        // 
        $("a[mfg='xlwb']", $(this)).eq(0).click(function(e){
            e.stopPropagation();
            KMap.closeInfoWindow();
            var url = window.location.toString();
            var title = $(">h2>a", $(domEl)).eq(0).text() + " " + $(">p", $(domEl)).eq(0).text() + "  ";
            _this._toWeibo(title, url, index, _this._selectMarker);
            _this._extrafun("xlwb", index);
        });
        // 
        $("a[mfg='err']", $(this)).eq(0).click(function(e){
            e.stopPropagation();
            var poinfo = _this.resultAt(index);
            var info = {
                "type": KFeedbackType.POI_ERROR,
                "poinfo": poinfo,
                "url": window.location.href + "&n=" + (index)
            };
            KEvent.trigger(_this, "feedback", _this, info, null);
        });
        //
        $("a[mfg='bpic']", $(this)).eq(0).imageBox();
        
        //poi
        var initSPic = function(picDom){
         	var ajaxUrl = picDom.attr("src");
         	var imgPattern=/\.(gif|jpg|jpeg|png|bmp)$/i;
         	if(!ajaxUrl){
         		return;
         	}
         	var $img = picDom;
         	var setImgSrc = function(imgElem, src){
         		var img = new Image();
         		img.onload=function(){
         			$(imgElem).attr("src", src).show().css("visibility","visible");
         			img=null;
         		};
         		img.src=src;
         	};
     		if (imgPattern.test(ajaxUrl)) {
     			$img.attr("setsrc","true");
     			setImgSrc($img.get(0), ajaxUrl);
     		} else {
     			$.ajax({
     				url: ajaxUrl,
     				type: "get",
     				dataType: "text",
     				success: function(data){
     					if (data != null && data != "") {
     						$img.attr("setsrc","true");
     						setImgSrc($img.get(0), data);
     					}
     				}
     			});
     		}
        }
        initSPic($("img[mfg='spic']", $(this)).eq(0));
    });
    //dom 
	if ((jsonData.f || jsonData.sc) && jsonData.t !='true' && jsonData.k.a != "true") {
		var lihtml = undefined ;
		var atype = "busline" ;
		if(jsonData.f){
			lihtml = jsonData.f;
			atype = "busline";
			_this._resultDom.prepend('<div class="mwp_ls_bs_line " ></div>');
		}else{
			lihtml = jsonData.sc;
			atype = "station";
			_this._resultDom.prepend('<div class="mwp_ls_bs_station" ></div>');
		}
		$(">div", _this._resultDom).append(lihtml.h);
		_this._busLineOrStationHandler(lihtml,atype);
		if(jsonData.e.length == 0){
			setTimeout(function(){
				KMap.maplet().setAutoZoom();
			},100);
		}
	};
	
    //google ads add by ligj@mapbar.com
    if(_this._enableGoogleAd){
    	var googleAdId = "gad"+new Date().getTime();
    	_this._addGooleAdSense(_this._queryopts.ls.name,googleAdId,function(flag){
				if(flag){
	    			_this._resultDom.append('<li style="height:75px;"></li>');
	    			$(">li",_this._resultDom).last().append($("#"+googleAdId));
	    		}
			}
    	);
    }
};
/**
 * 
 */
KLocalsearch.prototype._sinaWeibo = function(s, d, e, r, l, p, t, z, c) {
	//var f = 'http://v.t.sina.com.cn/share/share.php?appkey=1355173317',
	var f = 'http://service.weibo.com/share/share.php?&appkey=112179156&ralateUid=1831898730',
	//u = z || d.location,
	u="",
	p = [ '&url=', e(u),
			'&title=', 	e(t || d.title),
			'&source=', e(r),
			'&sourceUrl=', e(l),
			'&content=', c || 'gb2312',
			'&wm=', '9972_0001',
			'&pic=',e(p || '')
			].join('');
	function a() {
		if (!window.open( [ f, p ].join(''), 'mb', [ 'toolbar=0,status=0,resizable=1,width=440,height=430,left=',
				(s.width - 440) / 2, ',top=', (s.height - 430) / 2 ].join(''))) u.href = [ f, p ].join('');
	}
	if (/Firefox/.test(navigator.userAgent))
		setTimeout(a, 0);
	else a();
};

KLocalsearch.prototype._toWeibo = function(title, url, index, marker) {
	var _this=this;
	var snapOpts = {
		size: new KSize(240,240),
		format : "jpg",
		zoom : 13
	};
	if(marker && marker.latlon){
		snapOpts.latlon = marker.latlon();
		KMap&&KMap.setCenter && KMap.setCenter(snapOpts.latlon, 13);
	}
	var latlon = snapOpts.latlon.getPid();
	var point = new KPoint(12,30);
	var configPoint = KConfig.get("mk_mo_sn", {
		a : (index+1)
	});
	if(configPoint && configPoint.icon && configPoint.icon.anchor){
		point=configPoint.icon.anchor;
	}
	//var url = [ "http://staticmap.mapbar.com/staticmap/?format=" + snapOpts.format ];
	var ajaxUrl = [ "proxy.jsp?format=" + snapOpts.format ];
	//
	ajaxUrl.push("size=" + snapOpts.size.width + "x" + snapOpts.size.height);
	ajaxUrl.push("zoom=" + snapOpts.zoom);
	ajaxUrl.push("codeform=1");
	ajaxUrl.push("customer=0");
	ajaxUrl.push("center=" + latlon);
	ajaxUrl.push("markers=" + latlon + ",,0,0,,,http://img.mapbar.com/web/3in1/icons/an" + (index + 1) + ".png," + point.x
			+ "," + point.y);
	ajaxUrl.push("processMode=event");
	//"weibo=1"proxy.jspurl
	ajaxUrl.push("weibo=1");
	//
	ajaxUrl = ajaxUrl.join("&");
	var imgurl="";
	//
	$.ajax( {
		url : ajaxUrl,
		type : "get",
		async:false,
		dataType : "json",
		error : function() {
			throw new Error("ajax error...");
		},
		success : function(data) {
			if(data && data.url){
//				imgurl = data.url;
				imgurl = 'http://www.mapbar.com/search/im?p=' + encodeURIComponent(data.url);
			}
		}
	});
	var getByteLength = function(str) {
		var len = 0, chlen, code;
		for ( var i = 0; i < str.length; i++) {
			code = str.charCodeAt(i);
			chlen = 0;
			do {
				chlen++;
			} while ((code = code / 256) > 1);
			len += chlen;
		}
		return len;
	};
	var getChineseLength = function(str) {
		str = $.trim(str);
		return Math.ceil(getByteLength(str) / 2);
	};
	
	var pid = marker._opts.infowin.cmdata.poi.pid;
    url = url + (pid ?"&pid="+pid : "");
    
	if (getChineseLength(title + url) > 140) {
		url = "http://www.mapbar.com/search/";
		if (getChineseLength(title + url)> 140) {
			url = "";
		}
	}

	var hash = url.split("&");
	var _keyValue = [];
	for (var i = 0; i < hash.length; i ++)
	{
		hash[i] = decodeURIComponent(decodeURIComponent(hash[i]));
	    var _hash = hash[i].split("=");
	    _keyValue.push(_hash[0] + "=" + encodeURIComponent(_hash[1]));
	}
	url = _keyValue.join("&");
	
	title = title + encodeURI(encodeURIComponent(url));
	_this._sinaWeibo(screen, document, encodeURIComponent, 'mapbar.com', 'http://www.mapbar.com/search/', imgurl, title, "", 'utf-8');
};

KLocalsearch.prototype._tgClickFun = function(index, obj)
{
    var b = $(obj).attr("b");
    this._queryopts.ls.name = b;
    var pt = $(obj).attr("pt");
    // []
    //this._extendParam = "&b=" + b + "&pt=" + pt;
    this._extendParam = "&pt=" + pt;
    
    this._extendFlag = false;
    this._queryopts.center = undefined;
    this.query(this._queryopts);
};
KLocalsearch.prototype._extrafun = function(mfg, index)
{
    var _this = this;
    KEvent.trigger(_this, "extrafun", _this, mfg, index);
};
/**
 * true
 */
KLocalsearch.prototype._updateInitmapOption = function()
{
    var _this = this;

    if (typeof this._opts.mapcontainer != "undefined")
    {      
        if (typeof this._opts.initmap == "undefined" || this._opts.initmap)
        {
            if (KMap.isInitialized(_this._opts.mapcontainer))
            {
                _this._addMarker();
            }
        }
    }
};
KLocalsearch.prototype._addMarker = function()
{
    var _this = this;
	var markerArray = [];
	KMap.clearMarker(KWidgetFlag.localsearch);
	KMap.clearMarker(KWidgetFlag.localsearch + "_center");
	if (!_this._result || !_this._result.e || !_this._result.e.length) {
		return;
	}
	var length = _this._result.e.length;
	for ( var i = length - 1; i >= 0; i--) {
		var result = {};
		for (var o in this._result.e[i]) {
			result[o] = this._result.e[i][o];
		}
		result.ex_djp = _this._getInforShow(i, "jp");
		result.ex_djd = _this._getInforShow(i, "jd");
		result._58z = _this._getInforShow(i, "58z");
		result._58e = _this._getInforShow(i, "58e");
		result.a = _this._result.e[i].c;
		result.p = _this._result.e[i].d;
		result.m = _this._result.e[i].m;
        //url
        result.fj = _this._result.e[i].fj || null;
		result.ex_pi = "none";
		//result.g = "";
        var isHotel = !!(result.m && result.m.a); 
        var statisticsCode = 'http://click.mapbar.com/GO/';
		var iconNum = -1;
		try {
			iconNum = parseInt(_this._result.e[i].a, 10);
		} catch (ex) {
		}
		if (isNaN(iconNum) || iconNum === -1) {
			iconNum = i + 1;
		}
		var lsOptions = KConfig.get("mk_mo_sn", {
			a : iconNum
		});
		//
		var t = false;
		if(result.rz == "true"){
			lsOptions = KConfig.get("mk_mo_sntg", {
				a : iconNum
			});
			t = true;
		}
		lsOptions.group = KWidgetFlag.localsearch;
        var iwOpts = {
        	pr:result.rzh?"<p class=ls_m_pr><span style='float:left;color:red;'></span><marquee style='float:left;width: 180px;' scrollamount='3' onMouseOut=this.start() onMouseOver=this.stop() behavior=scroll><a hidefocus='true' style='color: #333;text-decoration: none;' href='" + statisticsCode + result.l +"' target='_blank'>"+result.rzh+"</a></marquee></p>":"",
            c: result.c,
            //"&nbsp;"
            d: result.d||"",
            e: result.mh||"",
            "djp": result.ex_djp,
            "djd": result.ex_djd,
            "58z": result._58z,
            "58e": result._58e,
            "fjjd":(result.fj ? '' : 'none'),
            "djpurl": result.ex_djp,

            "djdurl": result.ex_djd,
            "58zurl": result._58z,
            "58eurl": result._58e,
            "fjjdurl": (result.fj || ""),
            //
            "ad_v": (!this._adHtml ? "none" : "block"),
            //
            "ad": this._adHtml
        }
		if(isHotel){
			var hotelHtml =['<span class="mwpg_poiw_h_tad"><em>&nbsp;</em>7x24<span>400-890-9817</span></span><ul>'];
			hotelHtml.push('<li class="mwpg_poiw_h_tab_s"><a href="javascript:void(0);"></a></li>');
			hotelHtml.push('<li><a href="javascript:void(0);"></a></li>');
			hotelHtml.push('<li><a href="javascript:void(0);"></a></li>');
			hotelHtml.push('<li><a href="javascript:void(0);"></a></li>');
			hotelHtml.push('<li><a href="javascript:void(0);"></a></li>');
			hotelHtml.push('</ul>');
			//
			hotelHtml.push('<div class="mwpg_poiw_h_tab_c"><div class="mwpg_poiw_h_rt"><table><thead></thead><tbody><tr><td>...</td></tr></tbody></table></div></div>');
			hotelHtml.push(result.m.a);
			hotelHtml.push(result.m.b);
			hotelHtml.push(result.m.c);
			hotelHtml.push(result.m.d);
			//hotelHtml.push(result.m.a);
			iwOpts.hotel=hotelHtml.join("");
		}
        
        lsOptions.infowin = KConfig.get(isHotel ? "iw_iwo_hotel" : "iw_iwo_poi", iwOpts);
        
        
        if(result.pd){
        	var poi_detail_html =['...'];
			iwOpts.poi_detail=poi_detail_html.join("");
			lsOptions.infowin = KConfig.get("iw_iwo_poi_detail", iwOpts);
        }
        
        
        if(result.op){
        	var priceHtml =['<ul class = "mwpg_poiw_ylp_data_ul">'];
        	for(var p = 0 ; p < result.op.length ; p++){
        		priceHtml.push('<li class="">'+result.op[p].b+'<span>('+result.op[p].a+')</span></li>');
        	}
        	if(result.op.length == 0){
        		priceHtml.push('<span></span>')
        	}
			priceHtml.push('</ul>');
			//$("#price").html(priceHtml.join(""))
            var html =['<ul class = "mwpg_poiw_ylpul">'];
        	html.push('<li class="mwpg_poiw_ylpul_li"></li>');
        	html.push('<li class="mwpg_poiw_ylpul_lg"><a href="http://www.youlaopo.com/" target="_blank"><em style="text-decoration:none;cursor:pointer;">&nbsp;</em></a></li>');
        	html.push('</ul>');
        	html.push('<div class="mwpg_poiw_ylp_div"><div class="mwpg_poiw_ylp_data" style="height:70px" ><span class="mwpg_poiw_ylpui_load"></span>'+priceHtml.join("")+'</div></div>');
    		iwOpts.hotel=html.join("");
        	lsOptions.infowin = KConfig.get("iw_iwo_gasoline", iwOpts);
        }
        
        
		
		if(result.rz == "true"){
			lsOptions.infowin.title = "<span title='"+ _this._result.e[i].n + "'>"+ cut_str(_this._result.e[i].n,28) + "</span><span class='mwpg_iw_ls_title'>&nbsp;-&nbsp;<a href='" + statisticsCode + _this._result.e[i].l + "' target='_blank'>&gt;&gt;</a><a class=mwp_ls_rz  mfg=rz></a></span>";
		}else if(_this._result.e[i].l){
			lsOptions.infowin.title = "<span title='"+ _this._result.e[i].n + "'>"+ cut_str(_this._result.e[i].n,32) + "</span><span class='mwpg_iw_ls_title'>&nbsp;-&nbsp;<a href='" + statisticsCode + _this._result.e[i].l + "' target='_blank'>&gt;&gt;</a></span>";
		}else{
			lsOptions.infowin.title = "<span title='"+ _this._result.e[i].n + "'>"+ cut_str(_this._result.e[i].n,33) + "</span><span class='mwpg_iw_ls_title'></span>";
		}
        
		var poiInfo = KTools.copyOptions( {
			type : KQueryType.localsearch,
			name : _this._result.e[i].n,
			//urlq
			city : (_this._result.e[i].q || this._queryopts.ls.city),
			latlon : _this._result.e[i].e,
			pid : _this._result.e[i].f || ""
		}, KPOInfo);
		lsOptions.infowin.cmdata = {
			poi : poiInfo
		};
		var markerAdd = new KMarker(_this._result.e[i].e, lsOptions);
		markerAdd._classObj = _this;//afteropeninfowindow
		// markerAdd._num = i + 1;
		markerAdd._num = iconNum;
		if(isHotel && result.m && result.m.e){
			markerAdd._hotelID = result.m.e;
		}
		if(result.pd){
			markerAdd._poiDetail = "show";
		}
		var obj = {
			num : i,
			dom : markerAdd,
			tg  : t
		};
		KEvent.bind(markerAdd, "mouseover", _this._hiliteMarker, obj, _this);
		markerArray.push(markerAdd);
	}
	//
	KMap.addMarkers(markerArray, false);
	if (_this._queryopts.center) {
		var nbcity = "";
		if(_this._queryopts.center.city){
			nbcity = _this._queryopts.center.city
		}else{
			nbcity = decodeURI(window.location.hash.split("&")[0].split("=")[1]);
		}
		_this._addNbMarker(nbcity);
	}
	if (_this._fitzoomflag && !_this._queryopts.ls.vs) {
		KMap.centerAndZoom(_this._result.d.a, parseInt(_this._result.d.b));
	}
};
/**
 * 
 *
 * @return String
 * @uncrunch
 */
KLocalsearch.prototype.pageCount = function()
{
	if(!this._result||!this._result.c){
		return 0;
	}
    if (this._result.c)
    {
        if (this._result.c == 0)
        {
            return 0;
        } else
        {
            return Math.ceil(this._result.a / this._result.c);
        }
    }
    return 0;

};
/**
 *  
 * @return String
 * @uncrunch
 */
KLocalsearch.prototype.currentPage = function()
{
    return parseInt(this._currentPage);
};
/**
 *  
 * @return String
 * @uncrunch
 */
KLocalsearch.prototype.pageSize = function()
{
    //return  this._result.c;
    return  this._pagesize;
};
KLocalsearch.prototype._hiliteMarker = function(eventinfo)
{
    var _this = this;
    var widget = eventinfo.data.dom;
    if (_this._selectLi != null)
    {
        _this._selectLi.removeClass(_this._opts.theme + KLocalsearch.conf.CLASSNAME.RLS);
    }
    if (_this._selectMarker != null)
    {
        _this._selectMarker.setOptions({icon:{snapIcon:KConfig.get("mk_s_sns",{h:"",a:_this._selectMarker._num})}});
        _this._selectMarker.setIconClass(KConfig.get("mk_s_snn", {a:_this._selectMarker._num}));//
        //
        if(_this._selectMarker.rz){
        	_this._selectMarker.setOptions({icon:{snapIcon:KConfig.get("mk_s_snstg",{h:"",a:_this._selectMarker._num})}});
        	_this._selectMarker.setIconClass(KConfig.get("mk_s_snntg", {a:_this._selectMarker._num}));//
        }
    }
    _this._selectLi = $(">li", _this._resultDom).eq(eventinfo.data.num);
    _this._selectLi.addClass(_this._opts.theme + KLocalsearch.conf.CLASSNAME.RLS);
    if (widget && widget != null)
    {
        var num = widget._num;
        widget.hilite();
        _this._selectMarker = widget;
        _this._selectMarker.rz = eventinfo.data.tg;
        this._selectMarker.setOptions({icon:{snapIcon:KConfig.get("mk_s_sns",{h:"a",a:_this._selectMarker._num})}});
        _this._selectMarker.setIconClass(KConfig.get("mk_s_snh", {a:_this._selectMarker._num}));
        if(eventinfo.data.tg){
        	 this._selectMarker.setOptions({icon:{snapIcon:KConfig.get("mk_s_snstg",{h:"a",a:_this._selectMarker._num})}});
             _this._selectMarker.setIconClass(KConfig.get("mk_s_snhtg", {a:_this._selectMarker._num}));
        }
        
    }
    KTools.scrollIntoView(_this._selectLi, _this._selectLi.parent(), "fast");
};
/**
 * 
 */
KLocalsearch.prototype._bindMapEvents = function(map, theMarker){
    var _this = this;
    KEvent.unbind(_this,"afteropeninfowindow", _this._afteropeninfowindow);
    KEvent.bind(_this, "afteropeninfowindow", _this._afteropeninfowindow);
};
KLocalsearch.prototype._afteropeninfowindow = function(event, map, theMarker){
	var _this = this;
    if (theMarker instanceof KMarker && theMarker.group) {
        var infoDom = theMarker.iwcDom();
        if (!infoDom) {
            return;
        }
        var hideAllLineSpan = function(elem){
            $("span", $(elem)).each(function(){
                var txt = $(this).text();
                if (txt && $.trim(txt) === "|") {
                    $(this).hide();
                }
            });
        };
        var hideNextLineSpan = function(elem){
            var $span = $(elem).next("span").eq(0);
            if ($span.text() && $.trim($span.text()) === "|") {
                $span.hide();
            }
        };
        //
        if(theMarker.group() === "tbsc"){
        	$(".mwpg_poiw_caV").hide();
        }
        if (theMarker.group() === KWidgetFlag.localsearch) {
            if (theMarker._KLocalsearch_bind_afteropeninfowindow !== true) {
                _this._setInforWinImg(theMarker);
                _this._initHotelTabs(theMarker);
                var mIndex = theMarker._num - 1;
				///,  
				$.each(["58z","58e", "djd", "djp"], function(index, val){
                    var $a = $("a[mfg='" + val + "']", infoDom);
					if ($a.length) {
						var href = $a.attr("href");
						//hrefnone(iehttp://www.mapbar.com/search/none)<a/>
						if (/none$/i.test(href)) {
							hideNextLineSpan($a);
						}
					}
                });
                // 
                var $err = $("a[mfg='err']", infoDom).eq(0);
                $err.bind("click", function(){
                    var poinfo = _this.resultAt(mIndex);
                    var info = {
                        "type": KFeedbackType.POI_ERROR,
                        "poinfo": poinfo,
                        "url": window.location.href + "&n=" + (mIndex)
                    };
                    KEvent.trigger(_this, "feedback", _this, info, theMarker);
                });
                // 
                var $fs = $("a[mfg='fs']", infoDom).eq(0);
                if (_this._opts.sender) {
                    $fs.click(function(e){
                        e.stopPropagation();
                        _this._sendIndex = (mIndex);
						//added by zy,
						_this._sendFromBubble = true;
						_this._bubbleIndex = _this._sendIndex;
                        _this.send();
                    });
                } else {
                    $fs.hide();
                    hideNextLineSpan($fs);
                }
                
              //() add by zwq
                var $tbsc = $("a[mfg='tbsc']", infoDom).eq(0);
                $tbsc.click(function(e){
                    e.stopPropagation();
                    _this._sendIndex = (mIndex);
                    collection.addRecord(_this._getCollection());
                });
                
                //
                var $wb = $("a[mfg='xlwb']", infoDom).eq(0);
                $wb.click(function(e){
                    e.stopPropagation();
                    var $li = $(">li", _this._resultDom).eq(mIndex);
                    var title = $(">h2>a", $li).eq(0).text() + " " + $(">p", $li).eq(0).text() + "  ";
                    var url = window.location.toString();
                    _this._toWeibo(title, url, mIndex, theMarker);
                });
                
                theMarker._KLocalsearch_bind_afteropeninfowindow = true;
                _this._loadHotelInfo(theMarker);
    			_this._loadPoiInfo(theMarker);
            }
            //google ad add by ligj@mapbar.com
            if(_this._enableGoogleAd){
            	var _gAdDom = $("#google_ads", infoDom);
            	if(_gAdDom.length > 0){
            		var query = theMarker._opts.infowin.cmdata.poi.name;
                	var pid = theMarker._opts.infowin.cmdata.poi.pid;
                	_this._addGooleAdForPoint(query,pid,_gAdDom,theMarker);
            	}
            	
            }
			
        }
        if (theMarker.group() === KWidgetFlag.localsearch + "_center") {
            $("a[mfg='err']", infoDom).hide();
            $("a[mfg='fs']", infoDom).hide();
            $("a[mfg='xlwb']", infoDom).hide();
            $("a[mfg='tbsc']", infoDom).hide();
            hideAllLineSpan(infoDom);
        }
    }

};
KLocalsearch.prototype._clickMarker = function(e, index)
{
	KEvent.clear(this._moEventTarget);
	var _this=this;
	_this._logRequest(index);
    e.stopPropagation();
    if (_this._selectMarker != null)
    {
        KMap.setCenter(_this._selectMarker.latlon(), KMap.zoom());
        _this._selectMarker._classObj = _this;//afteropeninfowindow
        KMap.openInfoWindow(_this._selectMarker);
    }
};
KLocalsearch.prototype._layoutDom = function(){
    if (!this._domAll.is(":visible")) return;
    //padding-top, padding-bottom 
    // _domAll;,_domAll.css("height")"auto"
    var aheight = parseInt(this._domAll.css("height"));
    if (isNaN(aheight)) {
        // _domAll,jQuery
        aheight = this._domAll.innerHeight();
    }
    // _domAll
    var temp = this._domAll.parent().innerHeight();
    // , aheight
    aheight = (temp < aheight) ? temp : aheight;
	//
    if (this._lsNoResultTip.is(":visible")) {
        this._resultDom.hide();
        //
        this._ssDom.hide();
        //
        this._logDom.hide();
        this._tipDom.hide();
        this._stdDom.hide();
        this._hotelDom.hide();
        this._lsNoResultTip.height(aheight-48)
    } else {
    	//added by zwq _ssDom
    	var ssHeight = this._ssDom.outerHeight(true);
    	var logHeight = this._logDom.outerHeight(true);
        var tipHeight = this._tipDom.outerHeight(true);
        var stdHeight = this._stdDom.outerHeight(true);
        var hotelHeight = this._hotelDom.outerHeight(true);
        var topsxHeight = this._topsxDom.outerHeight(true);
        var spellEcHeight = this._spellEcTipDom.outerHeight(true);
        var poiListTopAdHeight = this._poiListTopAdDom.outerHeight(true);
        
        var topHeight = 0;//poi
        
        if (this._hotelDom.is(":visible")) {
        	topHeight += hotelHeight;
        }
        if (this._tipDom.is(":visible")) {
        	topHeight += tipHeight;
        }
        if (this._stdDom.is(":visible")) {
        	topHeight += stdHeight;
        }
        if(this._ssDom.is(":visible")){
        	topHeight += ssHeight;
        }
        if(this._logDom.is(":visible")){
        	topHeight += logHeight;
        }
        if(this._poiListTopAdDom.is(":visible")){
        	topHeight += poiListTopAdHeight;
        }
        if(this._topsxDom.is(":visible")){
        	topHeight += topsxHeight;
        }
        if(this._spellEcTipDom.is(":visible")){
        	topHeight += spellEcHeight;
        }
        this._resultDom.css({
	        height: aheight  - topHeight
	    });
    }
    return;
};
KLocalsearch.prototype._initMapTriggest = function()
{
    var _this = this;
    _this._fitzoomflag = true;
    if (!KMap.isInitialized(_this._opts.mapcontainer))
    {
        _this._fitzoomflag = false;
        var point = undefined;
        if (_this._result && _this._result != null && _this._result.d && _this._result.d.a)
        {
            point = new MPoint(_this._result.d.a);
        }
        KEvent.bind(KMap, "mapinit", function() {
            KEvent.unbind(KMap, "mapinit", arguments.callee);
            _this._addMarker();
            _this._bindMapEvents();
        });
        var zoom = undefined;
        if (_this._result && _this._result != null && _this._result.d && _this._result.d.b)
        {
            zoom = _this._result.d.b;
        }
//        KEvent.trigger(_this, "mapready", _this, point, zoom); //
    } else {
        _this._addMarker();
        _this._bindMapEvents();
    }
};
KLocalsearch.prototype._appendLiToResult = function() {

	this._clearLiEvent();
	var _this = this;
	var resultDomArray = [];
	var jsonData = this._result;
	var isShowNoResult = true;
	if(jsonData.f || jsonData.sc){
		isShowNoResult = false;
	}
	/*if (!jsonData || !jsonData.e || jsonData.e.length === 0) {// 
		_this._lsNoResultTip.show();
		KEvent.trigger(_this, "noresults", _this, _this._lsNoResultTip);
	}*/
	//  "resultloaded"
	_this._resultloadedEvent();
	//
	
	if (!!jsonData && !!jsonData.e) {
		
		
		//add by zwq 
		if(jsonData.t=='true'){
			var ss = jsonData.t;
			_this._ssMore.unbind('click').click(function(e){
				e.stopPropagation();
				_this._ssmoreFlag = false;
				_this._ajaxPostRequest(false);
			});
			_this._ssDom.show();
		}else{
			_this._ssDom.hide();	
		}
		if (jsonData.e) {
			var resultDom = jsonData.e;
			var length = resultDom.length;
			for ( var i = 0; i < length; i++) {
				resultDomArray.push(resultDom[i].h);
			}
			_this._resultDom.show().empty().append($(resultDomArray.join(""))).scrollTop(0);
			//
			_this._resultDom.ready(function() {
				_this._initDom();
				_this._updateThemeOptions();
				_this._updateTipurl();
				_this._resultshowEvent();
				if (length === 0 && isShowNoResult) {
					KEvent.trigger(_this, "noresults", _this, _this._lsNoResultTip);
					_this._lsNoResultTip.show();
					if(jsonData.th){
						$(">div",_this._lsNoResultTip).hide().eq(1).show();
					}else if(_this._queryopts.ls.vs){
						$(">div",_this._lsNoResultTip).hide().eq(2).show();
					}else if(jsonData.qas){
						$(">div",_this._lsNoResultTip).hide().eq(3).show();
					}else if(jsonData.acd){
						$(">div",_this._lsNoResultTip).hide().eq(4).show();
					}else{
						$(">div",_this._lsNoResultTip).hide().eq(0).show();
					}
				}
				_this._layoutDom();
			});
		}
	} else {
		// no results, so to hide the result dom
		_this._resultDom.empty().hide();
		KMap.clearMarker(KWidgetFlag.localsearch);
		KMap.clearMarker(KWidgetFlag.localsearch + "_center");
		//
		KEvent.trigger(_this, "resultshown", _this, "query", _this._result);
		KEvent.trigger(_this, "noresults", _this, _this._lsNoResultTip);
		_this._lsNoResultTip.show();
		if(jsonData.th){
			$(">div",_this._lsNoResultTip).hide().eq(1).show();
		}else if(_this._queryopts.ls.vs){
			$(">div",_this._lsNoResultTip).hide().eq(2).show();
		}else{
			$(">div",_this._lsNoResultTip).hide().eq(0).show();
		}
	}
};
/**
 * 1
 *
 * @return String
 * @uncrunch
 */
KLocalsearch.prototype.goPage = function(page)
{
    if (page < 1)
    {
        this._currentPage = 1;
    } else if (page > this.pageCount())
    {
        this._currentPage = this.pageCount();
    }
    else
    {
        this._currentPage = page;
    }
    this._gopageFlag = false;
    this._extendFlag = false;
    
//    if(this._result.t == 'false'){
//    	this._ssmoreFlag = false;
//    	this._logmoreFlag = true;
//    }
//	
    //added by zwq   z
    if(this._result.z == '1'){
    	this._ssmoreFlag = false;
    }
    if(this._result.w == 'false' && this._result.z == '2'){
    	this._logmoreFlag = false;
    }
    //_isInitTopSx = true
    if(this._result.th)this._isInitTopSx = true;
    this.query(this._queryopts);
};
/**
 * 
 * @return String
 * @uncrunch
 */
KLocalsearch.prototype.clearResult = function()
{
    if (this._resultDom)
    {
        this._resultDom.empty();
        this._resultDom.hide();
    }
    KMap.clearMarker(KWidgetFlag.localsearch);
    KMap.clearMarker(KWidgetFlag.localsearch+"_center");
};
/**
 * IE6undefined
 */
KLocalsearch.prototype._shadow = function() {
    if ($.browser.msie && $.browser.version < 7) {
        return undefined;
    } else {
        return KConfig.get("mk_sn_s_t");
    }
};
KLocalsearch.prototype._getRequestParam = function(name)
{
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
    var r = this._extendParam.substr(this._extendParam.indexOf("\?") + 1).match(reg);
    if (r != null) return r[2];
    return null;
};
/**
 * 
 * @param index
 * @param type
 */
KLocalsearch.prototype._getInforShow = function(index, type)
{
    if (this._resultDom)
    {
        var length = $("a[mfg='" + type + "']", $(">li", this._resultDom).eq(index)).length;
        if (length > 0)
        {
            return $("a[mfg='" + type + "']", $(">li", this._resultDom).eq(index)).attr("href");
        }
        else
        {
            return "none";
        }
    }
};

KLocalsearch.prototype._setInforWinImg = function(marker) {
	var index = marker._num-1;
	var ajaxUrl = this._result.e[index].g;
	var imgPattern=/\.(gif|jpg|jpeg|png|bmp)$/i;
	var $img = $("img", marker.iwcDom()).eq(0);
	if(!ajaxUrl){
		var nextDiv = $("+ div",$img.parent());
		$("> p",nextDiv).width("96%");
		return;
	}
	//return;
	
	var setImgSrc = function(imgElem, src){
		var img = new Image();
		img.onload=function(){
			$(imgElem).attr("src", src).show().css("visibility","visible");
			img=null;
		};
		img.src=src;
	};
	if ($img.data("setsrc") !== "true") {
		if (imgPattern.test(ajaxUrl)) {
			$img.attr("setsrc","true");
			setImgSrc($img.get(0), ajaxUrl);
		} else {
			//ajaxUrl = ajaxUrl.replace("./s?", "/proxy.jsp?");
			$.ajax({
				url: ajaxUrl,
				type: "get",
				dataType: "text",
				error: function(){
				},
				success: function(data){
					if (data != null && data != "") {
						$img.attr("setsrc","true");
						setImgSrc($img.get(0), data);
					// $("img", marker.iwcDom()).eq(0).parent().show();
					}
				}
			});
		}
	}
};
/**
 * 
 * 
 * @uncrunch
 */
KLocalsearch.prototype.totalCount = function()
{
	//edit by zwq 0
//    if (this._result.a&&this._result.t!='true')
//    {
//       return parseInt(this._result.a);
//    }
//    else
//    {
//        return 0;
//    }
    return parseInt(this._result.a);
    
};

/**
 * 
 *
 * @uncrunch
 */
KLocalsearch.prototype.print = function() {

	//var l=new KLine([new MPoint(116.38672, 39.90805),new MPoint(116.38672, 39.80805),new MPoint(117.38672, 39.90805)],{});
	//KMap.addLine(l);
	//return;
	//
	var _this=this;
	if(!_this._opts||!_this._opts.printer){
		return;
	}
	//
	var printer = _this._opts.printer;
	var lines = KMap.getLines();
	// KPrintOptions
	var data = {
		"queryopts" : _this._queryopts,
		"resultnum": _this._selectMarker ? _this._selectMarker._num : 0,
		"pagenum" : _this._currentPage,
		"markers" : _this._getStringMarkers(),
		"lines" : lines.toString()
	};
	//
	printer.print(data);
};
/**
 * 
 *
 * @param sendtype
 *            KSendType  KSendType.all
 * @param selected
 *            KSendType 
 * @uncrunch
 */
KLocalsearch.prototype.send = function(sendtype, selected) {
	var _this=this;
	//sender, 
	if(!_this._opts||!_this._opts.sender){
		return;
	}
	//
	if (!_this._result || !_this._result.e || _this._result.e.length < 1) {
		return ;
	}
	//
	var sender =  _this._opts.sender;
	var data =KTools.copyOptions({}, KSendOptions);
	data.querytype = KQueryType.localsearch;
	//data.sendtype=KSendType.email| KSendType.gps | KSendType.sms;
	data.sendtype = sendtype || (KSendType.email | KSendType.gps | KSendType.sms);
	data.selected = selected || KSendType.sms;
	data.sms=[];
	data.email=[];
	data.gps=[];
	//added by zy,
	data.sendFromBubble = this._sendFromBubble;
	if(data.sendFromBubble) data.bubbleIndex = this._bubbleIndex;
    //opt# 1011031702 fix begin
    //add by zhangsq
    data.car = [];
	//
	var result= _this._result.e;
	var len = result.length, i;
	var smsData,gpsData,carData;    //add [carData] by zhangsq
	var queryHash = KUrlHash.parseByHash(_this._queryHash.toString(), true);
	queryHash.setKey("t","ssm");
	if (_this._queryHash.value("cn") !== null) {
		queryHash.setKey("t", "nssm");
	}
	queryHash.setKey("n", _this._sendIndex);
	//n0
	data.email.push(_this._getKNamedValue("param", queryHash.toString()));
//	var tempStr = "";
	for (i = 0; i < len; i++) {
//		tempStr = "";
//		if (result[i].d && $.trim(result[i].d).length) {
//			tempStr += " " + $.trim(result[i].d);
//		}
//		if (result[i].c && $.trim(result[i].c).length) {
//			tempStr += " " + $.trim(result[i].c);
//		}
//        console.log(result[i])
		smsData = {
			"selected" : (i === _this._sendIndex) ? true : false,
			"content" : (result[i].mv),
            "sendkey" : (result[i].mk)
		};
		gpsData = {
			"selected":(i === _this._sendIndex) ? true : false,
			"type" : "",
			"pos" : result[i].i,
			"name" : result[i].n,
			"address" : result[i].c,
			"phoneNumber" : result[i].d,
			"regionName" : ""
		};
        //add by zhangsq
        if(i === _this._sendIndex)
        {
            carData = {
                'latlon' : result[i].i
                ,'name' : result[i].n
                ,'address' : result[i].c
                ,'phone' : result[i].d
                ,'preview' : result[i].n + (result[i].c ? ('\n' + result[i].c) : '') + (result[i].d ? ('\n' + result[i].d) : '')
            };
			//added by zy,
			//if($('#_iw_shadow_0').length == 0){}
//			if ($('#olResult>li').hasClass('mwp_ls_rls')) {
//				var selectedNO = $('#olResult li.mwp_ls_rls').index();
//				console.log(selectedNO)
//				carData = {
//                	'latlon' : result[selectedNO].i
//                	,'name' : result[selectedNO].n
//                	,'address' : result[selectedNO].c
//                	,'phone' : result[selectedNO].d
//                	,'preview' : result[selectedNO].n + (result[selectedNO].c ? ('\n' + result[selectedNO].c) : '') + (result[selectedNO].d ? ('\n' + result[selectedNO].d) : '')
//            	};
//			}
            data.car.push(_this._getKNamedValue('car', carData));
        }
        //opt# 1011031702 fix end
		data.sms.push(_this._getKNamedValue(result[i].n, smsData));
		data.gps.push(_this._getKNamedValue(result[i].n, gpsData));
	}
	//
	this._sendFromBubble = false;
	sender.send(data);
};
/***
 * KNamedValue
 * @param name
 * @param val
 * @return KNamedValue object
 */
KLocalsearch.prototype._getKNamedValue = function(name,val)
{
   var obj = {"name":name, "kvalue":val};
   KTools.copyOptions(obj,KNamedValue);
   return obj;
};

/**
 * parse this._result to get map markers
 *
 * @return Array String[] the string can be converted to KMarker object;
 */
KLocalsearch.prototype._getStringMarkers=function(){
	var  _this=this;
	var markers=KMap.getMarkers();
	if(!markers||markers.length===0){return [];}
	//
	var len=markers.length;
	var index=0;
	var arrOut=[];
	for(index=0; index<len; index++){
		arrOut.push(markers[index].toString());
	}
	//
	return arrOut;
};
/**
 * 
 *
 * @param index
 *            Integer 0
 * @return KPOInfo 
 * @uncrunch
 */
KLocalsearch.prototype.resultAt = function(index) {
	var _this=this;
	var arr=[];
	if (_this._result && _this._result.e) {
		arr = _this._result.e;
	}
	var obj= arr[index];
	if(!obj){
		return undefined;
	}
	//KPOInfo
	var reObj={
		"type":KPOIType.NORMAL,
		"city" : _this._queryHash.value("c"),
		"name" : obj.n,
		"pid" : obj.f,
		"latlon" : obj.e,
		"address" : obj.c,
		"phone" : obj.d
	};
	return reObj;
};
/**
 *  Dom 
 *
 * @param index
 *            Integer 0
 * @return Node 
 * @uncrunch
 */
KLocalsearch.prototype.resultDomAt = function(index) {
	var _this = this;
	var $dom = null;
	if (_this._resultDom) {
		$dom = $(">li", _this._resultDom).eq(index);
		if ($dom && $dom.get) {
			return $dom.get(0);
		}
	}
};
/**
 * 
 */
KLocalsearch.prototype._initHotelDom = function(){
	var _this=this;
	var klass = KLocalsearch.conf.CLASSNAME;
	var theme = this._theme;
	var $inputContainer = this._hotelDom.children("div").eq(0).addClass(theme+klass.ST);
	var $listContainer = this._hotelDom.children("div").eq(1).addClass(theme+klass.SC);
	var $tipContainer = this._hotelDom.children("div").eq(2).addClass(theme+klass.HST);
	var $moreBtn = $listContainer.children("a").eq(0);
	var $queryBtn = $listContainer.children("input").eq(0);
	//
	var $inputs = $inputContainer.find("input");
    var box = this._hotelDom.parent().parent().get(0);
//    var today = new Date();
    var today = new Date(new Date().getTime() + 1*24*60*60*1000);

    var startOpts = {
        month: 2,
        icon: $inputs.eq(0).siblings("a").get(0),
        box: box,
        date: today,
		min:new Date(),
		max:this._nextMonthDay_1(today, 2)
    }
	var endDate = new Date(today.getTime() + 1*24*60*60*1000);//345600000 = 4*24*60*60*1000

    var endOpts = {
        month: 2,
        icon: $inputs.eq(1).siblings("a").get(0),
        box: box,
        date: endDate,
        min:new Date(),
		max:this._nextMonthDay_1(endDate, 2)
    }
	startOpts = KTools.copyOptions(startOpts, KDatePickerOptions);
	endOpts = KTools.copyOptions(endOpts, KDatePickerOptions);
    this._startPicker = new KDatePicker($inputs.get(0), startOpts);
  	this._endPicker = new KDatePicker($inputs.get(1), endOpts);
    this._endPicker.setReferPicker(this._startPicker);
    KEvent.bind(this._startPicker, "selected", function(evt, wgt, date){
        _this._endPicker.setOptions({
            //86400000 = 24*60*60*1000
            min: new Date(date.getTime() + 86400000)
        });
        window.setTimeout(function(){
            _this._endPicker.show();
        }, 10);
    });
	//
    var priceListOpts = {
        select2text: true,
        editable: false,
        deletable: false,
        sortable: false,
        multiple: false,
        deselect: false,
        checkbox: false,
        sroll2view: false,
		hover:true
    };
    var starListOpts = {
        select2text: true,
        editable: false,
        deletable: false,
        sortable: false,
        multiple: false,
        deselect: false,
        checkbox: false,
        sroll2view: false,
		hover:true
    };
    priceListOpts = KTools.copyOptions(priceListOpts, KDropListOptions);
    starListOpts = KTools.copyOptions(starListOpts, KDropListOptions);
	this._priceList = new KDropList($listContainer.children("div").get(0), priceListOpts);
	this._starList = new KDropList($listContainer.children("div").get(1), starListOpts);
	KEvent.bind(this._priceList, "opened", function(){
		_this._starList.close();
	});
	KEvent.bind(this._starList, "opened", function(){
		_this._priceList.close();
	});
    _this._hotelBaseUrl = "http://jiudian.kuxun.cn/?fromid=Kmapbar123-S1679378-T1001061&est=marketing";
	//
	$moreBtn.bind("click", function(event){
		event.preventDefault();
		var statisticsCode = 'http://click.mapbar.com/GO/';
		window.open(statisticsCode + _this._hotelBaseUrl);
	})
	//
    $queryBtn.bind("click", function(event){
		 event.preventDefault();
        var baseUrl = _this._hotelBaseUrl;
        var startDate = _this._startPicker.getDate(true);
        var endDate = _this._endPicker.getDate(true);
        var rank = _this._starList.selected()[0];
        rank = (rank && rank.kvalue) ? rank.kvalue : "0";
        var price = _this._priceList.selected()[0];
        price = (price && price.kvalue) ? price.kvalue : "0-200";
		var statisticsCode = 'http://click.mapbar.com/GO/';
		var url = statisticsCode + _this._hotelQueryUrl(baseUrl, startDate, endDate, rank, price);
		window.open(url);       
    });
	//
	this._resetHotelView();
	
};
/**
 * baseUrl: http://hotel.mapbar.com/hotellist.asp?cityid=53
 * &tm1=2011-05-05&tm2=2011-06-06&rank=3&price=0-200
 */
KLocalsearch.prototype._hotelQueryUrl = function(baseUrl, startDate, endDate, rank, price){
    var url = [baseUrl];
//    url.push("checkindate=" + startDate);
//    url.push("checkoutdate=" + endDate);
    switch (rank) {
        case "5":
        case "4":
        case "3":
        case "2":
        case "0":
            break;
        default:
            rank = "0"
    }
//    url.push("rank=" + rank);
	switch (price) {
        case "0-200":
        case "200-300":
        case "300-400":
        case "400-500":
        case "500-0":
//			url.push("price=" + price);
            break;
    }
    
    return url.join("&");
};

KLocalsearch.prototype._resetHotelView = function(){
	var today = new Date();
	this._startPicker.setDate(today);
	this._endPicker.setDate(new Date(today.getTime() + 345600000));//345600000 = 4*24*60*60*1000
	this._priceList.select(0);
	this._starList.select(0);
	
};
/**
 * N
 * @param {Date} date
 * @param {Integer} n
 * @return {Date} 
 */
KLocalsearch.prototype._nextMonthDay_1 = function(date, n){
    n = (typeof n !== "number" || isNaN(n)) ? 1 : n;
    var nextNMonth = new Date(date.getFullYear(), date.getMonth() + n, 1);
    var dateToday = date.getDate();
    var getLastDay = function(dateObj){
        var nextDateObj = new Date(dateObj.getFullYear(), dateObj.getMonth() + 1, 1);
        nextDateObj = new Date(nextDateObj.getTime() - 86400000);//86400000 = 24*60*60*1000
        return nextDateObj.getDate();
    };
    var returnDate = "";
    if (dateToday === 1) {
        returnDate = new Date(nextNMonth.getFullYear(), nextNMonth.getMonth(), 1);
        returnDate = new Date(returnDate.getTime() - 86400000);//86400000 = 24*60*60*1000
    } else {
        var nextMonthLastDay = getLastDay(nextNMonth);
        returnDate = new Date(nextNMonth.getFullYear(), nextNMonth.getMonth(), Math.min(dateToday, nextMonthLastDay));
		returnDate = new Date(returnDate.getTime() - 86400000);//86400000 = 24*60*60*1000
    };
    return returnDate;
};

/**
 *
 * @param {KMarker} marker
 */
KLocalsearch.prototype._initHotelTabs = function(marker){
	var _this=this;
    var infoDom = marker.iwcDom();
    var $hotel = $("[mfg='hotel']", infoDom);
	//3.x bug
	if ($.browser.mozilla) {
		$hotel.bind("mouseleave", function(){
			var $vDiv = $(">div", $hotel).filter(":visible");
			$vDiv.animate({
				scrollTop: 0
			}, 10);
		});
	}
    if ($hotel.length === 1) {
		//tabs
        var $lis = $(">ul>li", $hotel);
        var $divs = $(">div", $hotel);
		$lis.removeClass("mwpg_poiw_h_tab_s").eq(0).addClass("mwpg_poiw_h_tab_s");
		$divs.removeClass("mwpg_poiw_h_tab_sc").hide().eq(0).addClass("mwpg_poiw_h_tab_sc").fadeIn();
        $lis.bind("click", function(event){
            var index = $lis.index(this);
            $divs.removeClass("mwpg_poiw_h_tab_sc").hide().eq(index).addClass("mwpg_poiw_h_tab_sc").show();
            $lis.removeClass("mwpg_poiw_h_tab_s");
            $(this).addClass("mwpg_poiw_h_tab_s");
        });
		var $firstDiv = $divs.eq(0);
		//date picker
		var $inputs = $firstDiv.find("form input[type='text']");
		var today = new Date();
        if ($inputs.length === 2) {
			var box = $hotel.parents("table").get(0);
            var startOpts = {
                month: 2,
				box:box,
                date: today,
                min: new Date(),
                max: this._nextMonthDay_1(today, 2)
            }
            var endDate = new Date(today.getTime() + 345600000);//345600000 = 4*24*60*60*1000 
            var endOpts = {
                month: 2,
				box:box,
                date: endDate,
                min: new Date(),
                max: this._nextMonthDay_1(endDate, 2)
            }
            startOpts = KTools.copyOptions(startOpts, KDatePickerOptions);
            endOpts = KTools.copyOptions(endOpts, KDatePickerOptions);
			var startInput = $inputs.get(0);
			var endInput = $inputs.get(1);
            var startPicker = new KDatePicker(startInput, startOpts);
            var endPicker = new KDatePicker(endInput, endOpts);
            endPicker.setReferPicker(startPicker);
            KEvent.bind(startPicker, "selected", function(evt, wgt, date){
               endPicker.setOptions({
                    //86400000 = 24*60*60*1000
                    min: new Date(date.getTime() + 86400000)
                });
                window.setTimeout(function(){
                    endPicker.show();
                }, 10);
            });
			//
			var startUID = this._getUID();
			var endUID = this._getUID();
			$(startInput).attr("lsuid", startUID);
			$(endInput).attr("lsuid", endUID);
			this._IWDatePickers[startUID] = startPicker;
			this._IWDatePickers[endUID] = endPicker;
			//
			var hotelID = marker._hotelID;
			var $form = $firstDiv.find("form").eq(0);
			$form.bind("submit", function(event){
				event.preventDefault();
				var $inputs = $(this).find("input[type='text']");
//				var url = 'http://hotel.mapbar.com/'+hotelID+'/?tm1='+$inputs.eq(0).val()+'&tm2='+$inputs.eq(1).val();
                var url = 'http://jiudian.kuxun.cn/?fromid=Kmapbar123-S1679378-T1001061&est=marketing';
                    window.open(url);
			});
        }
		//table 
//		var $table = $firstDiv.find("table");
//		if($table.length===1){
//			$table.bind("click", function(event){
//				event.preventDefault();
//				var $target =$(event.target);
//				if($target.is("a")){
//				var hotelID = $target.attr("hotelid");
//				var roomID = $target.attr("roomid");
//				var planID = $target.attr("planid");
//				if(hotelID && roomID && planID){
//					_this._bookHotel(hotelID, roomID, planID);
//				}}
//			});
//		}
		
    };
};
KLocalsearch.prototype._loadHotelInfo = function(marker){
	if(!marker._hotelID){
		return;
	}
    var infoDom = marker.iwcDom();
    var $hotel = $("[mfg='hotel']", infoDom);
	if ($hotel.length === 1) {
		var $divs = $(">div", $hotel);
		var table = $divs.eq(0).find("table").get(0);
		if (!$(table).data("htmlcontent")) {
			this._jsopHotelInfo(table, marker._hotelID);
		}
	}
};

KLocalsearch.prototype._loadPoiInfo = function(marker){
	if(marker._poiDetail){
	    var infoDom = marker.iwcDom();
	    var $poiInfo = $("[mfg='poid']", infoDom);
	    this._jsonPoiInfo($poiInfo,marker._opts.infowin.cmdata.poi.pid);
	}
};

KLocalsearch.prototype._jsonPoiInfo= function(dom, poiId){
	var _this = this;
	var hash = new KUrlHash();
    var url = _this._opts.url;
    hash.setKey("t","ps");
    hash.setKey("c",_this._queryopts.ls.city);
    hash.setKey("id", poiId);
    if (url.indexOf("?") != -1) {
        var num = url.indexOf("?");
        url = url.substring(0, num);
    }
	$.ajax( {
		url : url + "?" +hash.toString(),
		type : "GET",
		dataType : "json",
		success : function(data) {
			if(data.html){
				var html = $(""+data.html+"");
				$(dom).html(html);
				var $uls = $(">ul", dom);
				var $lis = $(">ul>li", dom);
			    var $divs = $(">div", dom);
			    $uls.addClass("mwp_subPop_nav");
				$lis.removeClass("mwp_subPop_nav_currnet").eq(0).addClass("mwp_subPop_nav_currnet");
				$divs.removeClass("mwp_subPop_cont_box").hide().eq(0).addClass("mwp_subPop_cont_box").fadeIn();
			    $lis.bind("click", function(event){
			        var index = $lis.index(this);
			        $divs.removeClass("mwp_subPop_cont_box").hide().eq(index).addClass("mwp_subPop_cont_box").show();
			        $lis.removeClass("mwp_subPop_nav_currnet");
			        $(this).addClass("mwp_subPop_nav_currnet");
			    });
			    //
                $("a[mfg='bpic']", $(dom)).eq(0).imageBox();
			}else{
				$(dom).html("");
			}
		}
	});
};
/**
 *
 * jsonp
 * http://www.api.zhuna.cn/e/json.php?hid=10604
 tm1=2011-05-07
 tm2=2011-05-08
 orderfrom=undefined
 call=callback
 r=0.4653051046192864
 * @param {HTMLElement} table
 * @param {String}  hotelID
 */
KLocalsearch.prototype._jsopHotelInfo= function(table, hotelID){
	var today = new Date();
	//345600000 = 4*24*60*60*1000
    //http://social.hotel.kuxun.cn/Partner/TubaPrice?hotelid=10030485&fromid=Kmapbar123-S1679378-T1001061&est=marketing&startDate=2014-05-02&endDate=2014-05-05
//	var next4Day =new Date(today.getTime() + 60*60*24*1000*4);
	var url =["http://social.hotel.kuxun.cn/Partner/TubaPrice?hotelid="+ hotelID];
	url.push("startDate="+ this._formatDate(new Date(today.getTime() + 60*60*24*1000*1)));
	url.push("endDate="+ this._formatDate(new Date(today.getTime() + 60*60*24*1000*2)));
	url.push("fromid=Kmapbar123-S1679378-T1001061");
    url.push("est=marketing");
	//
	var _this=this;
	$.ajax( {
		url : url.join("&"),
		type : "GET",
		dataType : "jsonp",
		jsonp:"callback",
		success : function(data) {

			if(data && data.status === 1 && data.data && data.data.room){
				var inner = _this._genHotelTBodyInner(data.data.room, hotelID);
				if(!inner){
					inner="<tr><td colspan='5'><p class='mwpg_poiw_h_haveNot'></p></td></tr>"
				}
				$("tbody", table).html(inner);
				$(table).data("htmlcontent",true);
			}
		}
	});
};
/**
 * 
 * @param {Date} date
 */
KLocalsearch.prototype._formatDate = function(date){
    return date.getFullYear() + "-" + this._prefixZero((date.getMonth() + 1), 2) + "-" + this._prefixZero(date.getDate());
};
/**
 * 
 * @param {Integer} num
 * @param {Integer} n
 */
KLocalsearch.prototype._prefixZero = function(num, n){
    while ((num + "").length < n) {
        num = "0" + num;
    }
	return num;
};
/**
 * 
 * @param {Object} data
 * @param {String} hotelID
 */
KLocalsearch.prototype._genHotelTBodyInner = function(data, hotelID){
	var tbody=[""];
    for(var i in data){
        tbody.push(this._genHotelTR(data[i]));
    }
//	if(data && data.rooms){
//        for (var index = 0; index < data.rooms.length; index++) {
//            tbody.push(this._genHotelTR(data.rooms[index], data.status, hotelID));
//        }
//	}
	return tbody.join("");
	
};
/**
 * 
 * @param {Object} room
 * @param {String} status
 * @param {String} hotelID
 */
KLocalsearch.prototype._genHotelTR = function(room){
    var html = ['<tr>'];
    //
    html.push("<td style='width:100px;'>" + room.roomName + "</td>");
    html.push("<td>" + room.priceNowDay + "</td>");
//    html.push("<td>" + Math.round(room.plans[0].totalprice / 4) + "</td>");
//    html.push("<td><b>" + room.priceNowDayWithDiscount+"</b></td>");
    html.push("<td style='width:80px;'><span class='mwpg_poiw_h_price'><em></em>" + (room.prize || 0) + "</span></td>");
//    html.push("<td>" + room.adsl + "</td>");
//    if ((status + "") === "0" && (room.status + "") === "0") {
        html.push("<td style='width:80px;'><a href='" + room.orderUrl + "' target='_blank'></a></td>");
//    } else {
//        html.push("<td><a href='javascript:void(0);' class='btn_dis'></a></td>");
//    }
    //
    html.push('</tr>');
    return html.join("");
};
/**
 * to get unique ic
 */
KLocalsearch.prototype._getUID = function(){
    if (!this._lsUID) {
        this._lsUID = 1;
    } else {
        this._lsUID++;
    }
	return this._prefixZero(this._lsUID, 6);
};
KLocalsearch.prototype._IWDatePickersMgr = function(){
	for(var prop in this._IWDatePickers){
		if(this._IWDatePickers.hasOwnProperty(prop) && /\d{6,}/.test(prop)){
			var $input = $("input[lsuid='"+prop+"']");
			if($input.length===0){
				var picker = this._IWDatePickers[prop];
				if (picker && typeof picker.finalize === "function") {
					this._IWDatePickers[prop]=undefined;
					delete this._IWDatePickers[prop];
					KEvent.unbind(picker);
					picker.finalize();
				}
			}
		}
	}
};
KLocalsearch.prototype._clearIWDatePickers = function(){
    for (var prop in this._IWDatePickers) {
        if (this._IWDatePickers.hasOwnProperty(prop) && /\d{6,}/.test(prop)) {
            var picker = this._IWDatePickers[prop];
            if (picker && typeof picker.finalize === "function") {
                this._IWDatePickers[prop] = undefined;
                delete this._IWDatePickers[prop];
                KEvent.unbind(picker);
                picker.finalize();
            }
        }
    }
};
/**
 * 
 * @param {String} hotelID
 * @param {String} roomID
 * @param {String} planID
 * @param {String} startDate
 * @param {String} endDate
 */
KLocalsearch.prototype._bookHotel = function(hotelID, roomID, planID, startDate, endDate){
    if (!this._hotelFormID || !$("#" + this._hotelFormID).length) {
        this._createHotelBookForm();
    }
    var form = $("#" + this._hotelFormID).get(0);
	var statisticsCode = 'http://click.mapbar.com/GO/';
    form.action = statisticsCode + "http://jiudian.kuxun.cn/?fromid=Kmapbar123-S1679378-T1001061&est=marketing";
//    form.hid.value = hotelID;
//    form.rid.value = roomID;
//    form.pid.value = planID;
//    var today = new Date();
//    form.tm1.value = startDate || this._formatDate(today);
//    //345600000 = 4*24*60*60*1000
//    form.tm2.value = endDate || this._formatDate(new Date(today.getTime() + 345600000));
    form.submit();
};
KLocalsearch.prototype._createHotelBookForm = function(){
    var formID = "ls_hotel_form_" + this._getUID();
    var html = ['<form action="http://jiudian.kuxun.cn/?fromid=Kmapbar123-S1679378-T1001061&est=marketing" method="post" target="_blank" id="' + formID + '" name="' + formID + '" style="display:none">'];
//    html.push('<input name="hid" type="hidden"/>');
//    html.push('<input name="rid" type="hidden"/>');
//    html.push('<input name="pid" type="hidden"/>');
//    html.push('<input name="tm1" type="hidden"/>');
//    html.push('<input name="tm2" type="hidden"/>');
    html.push('</form>');
    $(document.body).append(html.join(""));
    this._hotelFormID = formID;
};


/**
 *  add by zhangwq
 */
KLocalsearch.prototype._getCollection =function(){
	var _this = this;
	var result= _this._result.e;
	var len = result.length, i;
	var _collData;
	for (i = 0; i < len; i++) {
		if(i === _this._sendIndex){
			_collData = {
				"city" : _this._queryopts.ls.city,
				"name" : result[i].n,
				"pid" : result[i].f,
				"latlon" : result[i].e,
				"addr" : result[i].c,
				"tel" : result[i].d,
				"type" : 1,
				"intro" : ""
			};
		}
	}
	return _collData;
}


/**
 * poi() add by zhangwq
 * */

KLocalsearch.prototype._logRequest = function(index){
    var _this = this;
    var ajaxUrl = _this._opts.url;
    var hash = new KUrlHash();
    hash.setKey("t", "logstat");
    hash.setKey("keyword", KUrlHash.parseByHash(location.href, false)._UrlHash.k);
    if(KUrlHash.parseByHash(location.href, false)._UrlHash.cn){
    	hash.setKey("cn", KUrlHash.parseByHash(location.href, false)._UrlHash.cn);
    }
    var city = decodeURI(window.location.hash.split("&")[0].split("=")[1]);
    if(_this._result.e[index].g !== ""){
    	city = decodeURI(decodeURI(KUrlHash.parseByHash(_this._result.e[index].g, false)._UrlHash.c));
    	hash.setKey("type", decodeURI(decodeURI(KUrlHash.parseByHash(_this._result.e[index].g, false)._UrlHash.pt)));
    }
    hash.setKey("pid", _this._result.e[index].f);
    hash.setKey("city", city);
    hash.setKey("index", index);
    if (_this._opts.url) {
        if (ajaxUrl.indexOf("?") != -1) {
            var num = ajaxUrl.indexOf("?");
            ajaxUrl = ajaxUrl.substring(0, num);
        }
        $.ajax({
            type: "GET",
            url: ajaxUrl,
            cache: false,
            data: (hash.toString()),
            error: function(XMLHttpRequest, textStatus, errorThrown){
            },
            success: function(data){
               
            },
            dataType: "json"
        });
    }
};


/**
 *  add by zhangwq
 * @param {String} t 
 * 
 */
KLocalsearch.prototype._baseMapLayer = function(t){
	var _this = this;
	_this._rainDropsLayer = null; 
	var serverPath = "";
	var dataPattern = "";
	var minLevel = 6;
	var maxLevel = 15;
    switch (t)
    {
        case 'jiudian':
        	serverPath = "http://img.mapbar.com/maplite/mapbank/maplayer/jiudian/";
        	dataPattern = "jiudian";
            break;
        case  'youlp':
        	serverPath = "http://img.mapbar.com/maplite/mapbank/maplayer/youlaopo/";
        	dataPattern = "youlaopo3";
            break;
        default:
    }
    _this._rainDropsLayer = new MLayer({
		serverPath: serverPath,
		dataFormat: MLayer.DATAFORMAT.GLOBALVARIABLE,
	    needData: true,
	    imgType: "png",
	    minLevel: minLevel,
	    maxLevel: maxLevel,
	    dataPattern: dataPattern + MLayer.DPLACEHOLDER,
	    tip:{mode:MLayer.TM_MOUSEOVER},
        click : {
				fun : function(){
					var _param = new KUrlHash();
					var ylpId = arguments[0]['ylp'];
					//
					var currlat = arguments[0]['l'];
					var hotname = arguments[0]['n'];
					_param.setKey("t","ps");
                    _param.setKey("id",arguments[0]['p']);
                    _param.setKey("c","");
                    $.ajax({
                        url : bjLayers_url
                        ,cache : false
                        ,data :  _param.toString()
                        ,success:function(data) {
                            try{
                            	var datac = data.c;
                            	if(!data.c && !data.d && !data.e){
                            		datac = ""
                            	};
                            	var iwOpts = {
                            			g: data.g,
                                        c: datac,
                                        //"&nbsp;"
                                        d: data.d || "&nbsp;"
                                    }
                            	var _iwOpts = "";
                            	if(t === "youlp"){
                            		var html =['<ul class = "mwpg_poiw_ylpul">'];
                                	html.push('<li class="mwpg_poiw_ylpul_li"></li>');
                                	html.push('<li class="mwpg_poiw_ylpul_lg"><a href="http://www.youlaopo.com/" target="_blank"><em style="text-decoration:none;cursor:pointer;">&nbsp;</em></a></li>');
                                	html.push('</ul>');
                        			//hotelHtml.push('<div class=""><div class=""><table style="height:100px;"><tbody id = "price"><tr><td>...</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr></tbody></table></div></div>');
                                	html.push('<div class="mwpg_poiw_ylp_div"><div class="mwpg_poiw_ylp_data" style="height:70px" id=price><span class="mwpg_poiw_ylpui_load">....</span></div></div>');
                        			iwOpts.hotel=html.join("");
                                	_iwOpts = KConfig.get("iw_iwo_gasoline",iwOpts);
                                    setTimeout(function(){
                                    	 _this._jsopGasolineInfo(ylpId);
                                    }, 500);
                            	}else{
                            		_iwOpts = KConfig.get("iw_iwo_poi",iwOpts);
                            		_iwOpts.content = "<div class='mwpg_poiw_caW'><p>" + datac + "<br>" + data.d + "</p></div>";
                            	}
                            	if(!data.n){
                            		data.n = hotname;
                            	}
                            	_iwOpts.title = data.n;
                                _iwOpts.cmdata = {poi:{city:data.h,name:data.n,pid:data.f,latlon:currlat}};
                                KMap.openInfoWindow(new MPoint(currlat), _iwOpts);
                            } catch(e) {
//                            	_showBaseMsg("");
                            }
                        }
                        ,error : function() {
//                            _showBaseMsg("");
                        }
                        ,dataType:"json"
                    });
					
				}
			}
	});
	maplet.addLayer(_this._rainDropsLayer);
};


KLocalsearch.prototype._jsopGasolineInfo= function(uid){
	var url = [ "./proxy.jsp?key=79517c0a3337da945bda7fadccb35098" ];
	url.push("uid="+uid);
	url.push("youlp=1");
	var _this=this;
	$.ajax( {
		url : url.join("&"),
		type : "GET",
		dataType : "json",
		success : function(data) {
			if(data&&data.code){
				var priceHtml =['<ul class = "mwpg_poiw_ylp_data_ul">'];
				if(data['90']){
					priceHtml.push('<li class="">'+data['90']+'<span>(90#)</span></li>');
				}
				if(data['93']){
					priceHtml.push('<li class="">'+data['93']+'<span>(93#)</span></li>');
				}
				if(data['97']){
					priceHtml.push('<li class="">'+data['97']+'<span>(97#)</span></li>');
				}
				if(data['92']){
					priceHtml.push('<li class="">'+data['92']+'<span>(92#)</span></li>');
				}
				if(data['95']){
					priceHtml.push('<li class="">'+data['95']+'<span>(95#)</span></li>');
				}
				if(data['98']){
					priceHtml.push('<li class="">'+data['98']+'<span>(98#)</span></li>');
				}
				if(data['10000']){
					priceHtml.push('<li class="">'+data['10000']+'<span>(0#)</span></li>');
				}
				if(data['10010']){
					priceHtml.push('<li class="">'+data['10010']+'<span>(-10#)</span></li>');
				}
				priceHtml.push('</ul>')
				$("#price").html(priceHtml.join(""))
			}else{
				$("#price").html("")
			}
		}
	});
};
/**
*google--add by ligj@mapbar.com
*/
KLocalsearch.prototype._addGooleAdSense = function(query,container,callback){
	var _this = this;
	var options = {
		'pubId' : 'googlepsotest-afs-china',
		'hl' : 'zh_CN',
		'query' : query,
		'linkTarget' : '_blank',
		'hl' : 'zh_CN'
	};
	var lockOpt = { 
		'container' : container,
		'number' : '1',
		'colorBackground' : '#fcfcfe',
		'colorTitleLink' : '#01479d',
		'colorDomainLink' : '#01479d'
	};
	
	if($("#"+lockOpt.container).length == 0){
		$("body").append("<div id='"+lockOpt.container+"'></div>");
	}
	var _googleAdDom = $("#"+lockOpt.container);
	try{
		if(typeof(eval(google.ads.search.Ads)) == "function"){
			_this._enableGoogleAd = false;
			new google.ads.search.Ads(options, lockOpt);
			var j = 0;
			var i = setInterval(function(){
				if($("#"+lockOpt.container).height() > 50){
					$("#"+lockOpt.container).prepend('<div style="width:30px;position: absolute;right: 15px;color:#c4c4c4;"></div>');
					clearInterval(i);
					setTimeout(function(){
						_this._enableGoogleAd = true;
						callback(true);
					},0);
				}else if(j == 4){
					clearInterval(i);
					_this._enableGoogleAd = true;
					callback(false);
					_googleAdDom.remove();
				}
				j++;
			},200);
		}
	}catch(e){
		_this._enableGoogleAd = false;
	}
};
/**
*google--add by ligj@mapbar.com
*/
KLocalsearch.prototype._addGooleAdForPoint = function(query,container,adDom,marker){
	var _this = this;
	if(marker._KLocalsearch_show_googlead == undefined){
    	_this._addGooleAdSense(query,container,function(flag){
    		if(flag){
    			marker._KLocalsearch_show_googlead = true;
    			if($("#"+container).length > 0 && $("#"+container).height() > 50){
    				setTimeout(function(){
    					adDom.empty().height(95).append($("#"+container));
    					KMap.openInfoWindow(marker);
    				},50);
    			}else{
        			marker._KLocalsearch_show_googlead = false;
        		}
    			
    		}else{
    			marker._KLocalsearch_show_googlead = false;
    		}
    	});
    	
	}else if($.browser.msie && $.browser.version < 9.0 && marker._KLocalsearch_show_googlead == true ){//ie9
		$("#"+container).appendTo(adDom.empty());
    }
};



/**
*
* @param item
*            {KTabItem}
* @return
*/
KLocalsearch.prototype._busLineOrStationHandler = function(reData,type){
	
   var _this = this;
   var urlHead = "http://bus.mapbar.com/" + reData.pc +"/poi/";
   if(type == "busline"){
	   var lineOpts = KConfig.get("ln_lo_bsl");
//	   lineOpts.group = _this.flag()+"_line";
	   lineOpts.group = "bs"+"_line";
	   var line = KLine.fromEncoded(reData.p, reData.l, lineOpts);
	   if (line) {
	       KMap.addLine(line);
	   }
//     var $headLinks = _this._tipDom.find("li>a");
//	   var $headLinks = _this._tipDom.find("a");
	   var $headLinks = $(">div", _this._resultDom).find("a");
	   $(">div", _this._resultDom).mouseover(function(event){
	       event.preventDefault();
	       $(">div", _this._resultDom).addClass("mwp_ls_bs_online");
	       if($('#olResult>li').hasClass('mwp_ls_rls')){
	    	   $('#olResult>li').removeClass("mwp_ls_rls");
	       }
	   }).mouseout(function(event){
		   event.preventDefault();
		   $(">div", _this._resultDom).removeClass("mwp_ls_bs_online");
	   });
	   $(">div", _this._resultDom).eq(0).click(function(){
		   KMap.closeInfoWindow();
		   KMap.setCenter(reData.m.a,parseInt(reData.m.b));
	   });
	   $(">div", _this._resultDom).find("div").eq(0).addClass("mwp_ls_bs_linediv1");
	   $(">div", _this._resultDom).find("div").eq(1).addClass("mwp_ls_bs_linediv2");
	   $headLinks.click(function(event){
	       event.preventDefault();
		   var value = $(this).html();
		   if(value.indexOf("") > -1 || value.indexOf("") > -1){
			   value = _this._queryopts.ls.name;
		   }
		   var opts = KTools.copyOptions({}, KQueryOptions);
		   opts.type = KQueryType.busline;
		   opts.busline = KTools.copyOptions({}, KPOInfo);
		   opts.busline.name = value;
		   if (_this._opts.searchbox)
		   {
		      _this._opts.searchbox.query(opts, false);
		   }
	   });
	   for(var i = 0 ;i<reData.s.length; i++){
		   var marker =  _this._createMarkerForBusLine(reData.s[i], i, reData.s.length, urlHead, "b");
		   KMap.addMarker(marker);
	   }
   }else if(type == "station"){
	   var markerOpts = KConfig.get("mk_mo_lss", {
           n: name,
           t: ""
       });
	   markerOpts.hoverLabel = false;
//       markerOpts.group = _this.flag() + "_line";
	   markerOpts.group = "bs" + "_line";
	   
       markerOpts.infowin = KConfig.get("iw_iwo_st", {
           h: urlHead + reData.a,
           cd: "none",
           fs: "none",
           nb: "none"
       });
       markerOpts.infowin.title = reData.n;
       markerOpts.icon.img = '<div class="bus_marker_sn_r" id="lstMarker"><span></span></div>';
       var stationMarker = new KMarker(reData.p, markerOpts);
       KMap.addMarker(stationMarker);
       $("#lstMarker").mouseover(function(event){
	       event.preventDefault();
	       $("#lstMarker").addClass("bus_marker_sn_or");;
	   }).mouseout(function(event){
		   event.preventDefault();
		   $("#lstMarker").removeClass("bus_marker_sn_or");;
	   });
//     KEvent.bind(stationMarker, "mouseover",stMarkerClass);
//     stationMarker.setOptions({icon:{snapIcon:KConfig.get("mk_s_sns",{h:"a",a:_this._selectMarker._num})}});
//     stationMarker.setIconClass("bus_marker_sn_or");  //marker
       var $stationHeadLinks = $(">div", _this._resultDom).find("a");
       $(">div", _this._resultDom).mouseover(function(event){
	       event.preventDefault();
	       $(">div", _this._resultDom).addClass("mwp_ls_bs_onstaion");
	       if($('#olResult>li').hasClass('mwp_ls_rls')){
	    	   $('#olResult>li').removeClass("mwp_ls_rls");
	       }
	       $("#lstMarker").addClass("bus_marker_sn_or");;
	   }).mouseout(function(event){
		   event.preventDefault();
		   $(">div", _this._resultDom).removeClass("mwp_ls_bs_onstaion");
		   $("#lstMarker").removeClass("bus_marker_sn_or");;
	   });
       $(">div", _this._resultDom).find("div").eq(0).addClass("mwp_ls_bs_stationdiv1");
	   $(">div", _this._resultDom).find("div").eq(1).addClass("mwp_ls_bs_stationdiv2");
	   $stationHeadLinks.click(function(event){
	       event.preventDefault();
		   var value = $(this).html();
		   if(value.indexOf("") > -1 || value.indexOf("") > -1){
			   value = _this._queryopts.ls.name;
		   }
		   var opts = KTools.copyOptions({}, KQueryOptions);
		   opts.type = KQueryType.bustation;
		   opts.bustation = KTools.copyOptions({}, KPOInfo);
		   opts.bustation.name = value;
		   if (_this._opts.searchbox)
		   {
		      _this._opts.searchbox.query(opts, false);
		   }
	   });
   }
   
};
/**
 *  add by zhangwq
 * */
KLocalsearch.prototype._createMarkerForBusLine = function(data, index, length, urlHead, stationType){
    var _this = this;
    var markerOpts;
    var isSoe = (index == 0 || index == length - 1);
    var name = data.a;
    name = $.trim(name.replace(/(\d+.)/i, ""));
    if (isSoe) {
        markerOpts = KConfig.get("mk_mo_sdt", {
            n: name,
            t: index == 0 ? "s" : "e"
        });
        markerOpts.hoverLabel = false;
//        markerOpts.group = _this.flag() + "_line_s";
        markerOpts.group = "bs" + "_line_s";
    } else {
        markerOpts = KConfig.get("mk_mo_s", {
            n: name,
            t: stationType
        });
        markerOpts.hoverLabel = true;
        //markerOpts.group = _this.flag() + "_line";
        markerOpts.group = "bs" + "_line";
    }
    // h:, infoWindow"
    markerOpts.infowin = KConfig.get("iw_iwo_st", {
        h: urlHead + data.n,
        cd: "none",
        fs: "none",
        nb: "none"
    });
    markerOpts.infowin.title = name;
    return (new KMarker(data.b, markerOpts));
};


/**
 *  add by zhangwq
 * @param type {String} trans, "busline","bustation", "all"
 * @return
 */
KLocalsearch.prototype._clearAllOverlay = function(type){
//    var flag = this.flag();
	var flag = "bs";
    var types = {
        trans: "_search_s,_search_l,_search_l_w,_search_s_all,_hoverlines",
        busline: "_line,_line_s,_line_e",
        bustation: "_station1,_station2"
    };
    types.all = types.trans + "," + types.busline + "," + types.bustation;
    var groups = (types[type || "all"] || types.all).split(",");
    $.each(groups, function(index, value){
        KMap.clear(flag + value);
    });
};

/**
 *  add by zhangwq qas
 * @param {String} trans, "busline","bustation", "all"
 * @return
 */
KLocalsearch.prototype._cityRedirectCheck = function(){
    //
	var _this = this ;
	var ct = _this._queryopts.center;
	var kvalue = _this._queryopts.ls.name;
	var kcity = _this._queryopts.ls.city;
    var charString = /^[\u4E00-\u9FA5\uF900-\uFA2D]*$/ ;
	if(charString.test(_this._queryopts.ls.name) && _this._queryopts.ls.name.length > 1 && !(ct && (ct.name || ct.latlon)) && !(kvalue === kcity || kvalue+"" === kcity) ){
        var sughash = new KUrlHash();
        var sugUrl = _this._opts.url;
        sughash.setKey("t","cs");
        sughash.setKey("a",8);
        sughash.setKey("s","json");
        sughash.setKey("k", _this._queryopts.ls.name);
        if (sugUrl.indexOf("?") != -1) {
            var num = sugUrl.indexOf("?");
            sugUrl = sugUrl.substring(0, num);
        }
        $.ajax({
            type: "GET",
            url: sugUrl,
            cache: false,
            data: (sughash.toString()),
            error: function(XMLHttpRequest, textStatus, errorThrown){
                if (!KMap.isInitialized(_this._opts.mapcontainer)) {
                    KEvent.trigger(_this, "mapready", _this, undefined, undefined);
                }
            },
            success: function(data){
            	if(data.a && data.a.length ==1 && (kvalue == data.a[0].c.split("<span>")[0] || kvalue+"" == data.a[0].c.split("<span>")[0] ) && kvalue !=""&&kvalue !=="" ){
            		KMap.setCenter(data.a[0].b.a,parseInt(data.a[0].b.b));
            		$("#resultCount").hide();
            		$("#losResult").hide();
            		$("#bkbtn").hide();
            		$("#pnBar").hide();
            		$("#navTopBts").hide();
            		$("#busNavLink").hide();
            		$("#bssButton").hide();
            		if($("#feedback").is(":visible")){
            			$("#feedback").hide();
            		}
            		if($("#bussResult").is(":visible")){
            			$("#bussResult").hide();
            			KMap.clearLine("bs_search_l");
            			KMap.clearMarker("bs_search_s")
            		}
            		if($("#navResult").is(":visible")){
            			$("#navResult").hide();
            			KMap.clearLine("navs");
            			KMap.clearMarker("navs");
            		}
            		if(!$("#mapmarker").is(":visible")){
            			$("#defaultDiv").show();
            		}
            	}else{
            		$("#bkbtn").show();
            		_this._ajaxPostRequest();
            	}
            },
            dataType: "json"
        });
    }else{
    	$("#bkbtn").show();
    	_this._ajaxPostRequest();
    }
};

KLocalsearch.prototype.menuNbQuery = function(mpoint,menuCity){
	KMap.clearMarker(KWidgetFlag.localsearch + "_center");
	var menuMarkerOpts = KConfig.get("mk_mo_mnct");
	menuMarkerOpts.group = KWidgetFlag.localsearch + "_center";
	menuMarkerOpts.infowin = KConfig.get("iw_iwo_poi", {
		"djp" : "none",
		"djd" : "none",
		"58z" : "none",
		"58e" : "none",
        "fjjd": "none"
	});
	// 
	menuMarkerOpts.infowin.title = "";
	menuMarkerOpts.infowin.content = "<div class='mwpg_poiw_caW'></div>";
	menuMarkerOpts.infowin.cmdata = {poi:{city:menuCity,name:'',latlon:mpoint.getPid()}};
	this._rightKeyLatlon = mpoint.getPid();
	var menuNb = new KMarker(mpoint,menuMarkerOpts);
	menuNb.menunb = "nbquery";
	KMap.addMarker(menuNb);
	KMap.openInfoWindow(menuNb, menuMarkerOpts.infowin);
};
/*
    
    * 
    * 
    * 
    * wangzheng
    * 1.0
    * 2010-05-13
    * 2010-05-15 23:07
 */
var KMsgBox = KClass.create("KMsgBox", KWidget);

KMsgBox.initialize = function(container, opts)
{
    if(KTools._isElement(container))
    {
        this._buttons = {};
        this._dom = container;
        this._opts = KTools.copyOptions(opts, KMsgBoxOptions);
        this._theme = this._opts.theme;
        this._bubbleJDom = $(">div:eq(0)", this._dom);
        this._titleJDom = $(">div:eq(0) >h3:eq(0)", this._bubbleJDom);
        this._cursorJDom = $(">span:eq(0)", this._bubbleJDom);
        this._closeJDom = $(">span:eq(1)", this._bubbleJDom);
        var _bubbleDiv0JDom = $(">div:eq(0)", this._bubbleJDom);
        this._msgJDom = $(">div:eq(0)", _bubbleDiv0JDom);
        this._btJDom = $(">div:eq(1)", _bubbleDiv0JDom);
        this._bubbleShadowJDom = $(">div:eq(1)", this._dom);
        this._bubble = new KBubble(this._bubbleJDom[0], {theme:this._theme, userstyle: this._opts.userstyle});
        this._updateThemeClass(this._opts.userstyle);
        KEvent.bind(this._bubble, "beforehide", function(evt, obj, action) {
            this._bubbleShadowJDom.hide();
        }, {}, this);
        KEvent.bind(this._bubble, "afterhide", function(evt, obj, action) {
            this._bubbleShadowJDom.hide();
            switch(action)
            {
                case "method":
                        action = this._closeAction;
                    break;
                case "document":
                        action = "outside";
                    break;
            }
            KEvent.trigger(this, "closed", this, action, this._closeButton);
            if(this._openOpts && this._openOpts.lightbox) KTools.lightbox({element:this._dom,visible:false});
        }, {}, this);
    }
};

/**
 * @overwrite
 * @uncrunch
 */
KMsgBox.prototype.cnname = function()
{
    return "";
};

/**
 * @overwrite
 * @uncrunch
 */
KMsgBox.prototype.version = function()
{
    return "1.0.0";
};

/**
 * @overwrite
 * @uncrunch
 */
KMsgBox.prototype.layout = function()
{
    if(this._bubbleJDom.is(":visible") && this._bubble)
    {
        if(this._elementJDom && this._openOpts.node === this._elementJDom[0]) this._updateElementJDom();
        this._bubble.layout();
        this._updateShadowJDom();
    }
};

/**
 * @overwrite
 * @uncrunch
 */
KMsgBox.prototype.setOptions = function(opts)
{
    if(!this._dom) return;
    this._opts = KTools.copyOptions(opts, this._opts);
    this.setTheme(this._opts.theme);
};

/**
 * @overwrite
 * @uncrunch
 */
KMsgBox.prototype.setTheme = function(theme)
{
    if(!this._dom) return;
    this._theme = theme;
    this._updateThemeClass(this._opts.userstyle);
};

/**
 * 
 * @param msg
 * @param opts
 */
KMsgBox.prototype.open = function(msg, opts)
{
    var _this = this;
    if(!msg || !this._dom)return;
    this._msgJDom.empty();
    if(KTools._isElement(msg))
    {
        this._msgJDom.append(msg);
        $(msg).show();
    } else this._msgJDom.html(msg);
    this._openOpts = KTools.copyOptions(opts, KMsgBoxOpenOptions);
    
    var bubbleOpenOpts = this._openOpts.buboptions;
    if(!bubbleOpenOpts) bubbleOpenOpts = {};
//    bubbleOpenOpts.offsetx = 136;
    if(typeof bubbleOpenOpts.closebtn === "undefined") bubbleOpenOpts.closebtn = KBubbleShowOptions.closebtn;
    if(typeof this._openOpts.title == 'string' && this._openOpts.title.length > 0)
    {
        this._titleJDom.show();
        $(this._dom).removeClass(this._theme+"_mbx_b");
        this._titleJDom.html(this._openOpts.title);
    } else {
        this._titleJDom.hide();
        $(this._dom).addClass(this._theme+"_mbx_b");
        if(bubbleOpenOpts.closebtn === true) this._msgJDom.css("padding-right", this._openOpts.cbmargin + "px");
    }

    if(bubbleOpenOpts.closebtn === false) $(this._dom).removeClass(this._theme+"_mbx_b");
    this._finalizeButtons();
    this._buttons = [];
    this._btJDom.hide();

    var _focusDom = null;
    if(this._openOpts.buttons instanceof Array && this._openOpts.buttons.length > 0)
    {
        this._btJDom.show();
        for(var i = 0; i < this._openOpts.buttons.length; i++)
        {
            var btI = this._openOpts.buttons[i];
            if(!btI.name || !btI.kvalue) continue;
            this._buttons[btI.name] = $('<input class="mwp_mbx_"'+btI.name+' kname="'+btI.name+'" type="button" value="'+btI.kvalue+'" />');
            KEvent.bind(this._buttons[btI.name], "click", this._closeButtonFun, {_this:this});
            this._btJDom.append(this._buttons[btI.name]);
            if(i != this._openOpts.buttons.length - 1) this._btJDom.append("&nbsp;");
            if(!_focusDom) _focusDom = this._buttons[btI.name][0];
        }
    } else {
        if(bubbleOpenOpts.closebtn) _focusDom = $(">span:eq(1) >a", this._bubbleJDom).get(0);
    }
    if(this._openOpts.autoclose > 0)
    {
        this._autoTimeout = setTimeout(function() {
            _this.close("auto");
        }, parseInt(this._openOpts.autoclose)*1000);
    }
    this._bubbleJDom.css({width:"",height:""});

    if(!KTools._isElement(this._openOpts.node))
    {
        this._cursorJDom.hide();
        bubbleOpenOpts.pos = KPosition.BOTTOM;
        if(!this._elementJDom) this._elementJDom = $('<div style="position:absolute;height:0px;width:0px;"></div>').appendTo(document.body);
        this._updateElementJDom();
        this._openOpts.node = this._elementJDom[0];
    }
    this._bubble.show(this._openOpts.node, bubbleOpenOpts);
    this._updateShadowJDom();
    if(this._openOpts.lightbox)
    {
        KTools.lightbox({element:this._dom,visible:true});
    }
    if(_focusDom) _focusDom.focus();
};

/**
 * 
 * @uncrunch
 */
KMsgBox.prototype.close = function()
{
    if(!this._dom) return;
    this._closeAction = arguments[0];
    this._closeButton = arguments[1];
    this._bubble.hide();
};

/**
 * @overwrite
 * @uncrunch
 */
KMsgBox.prototype.finalize = function()
{
    if(!this._dom) return;
    clearTimeout(this._autoTimeout);
    this._finalizeButtons();
    KTools.lightbox({element:this._dom,visible:false});
    this._bubble.finalize();

    if(this._elementJDom) KTools.removeNode(this._elementJDom[0]);

    KTools.removeNode(this._dom);
    KWidget.prototype.finalize.apply(this);
    
};

/**
 * @overwrite
 * @uncrunch
 */
KMsgBox.prototype.dependent = function()
{
    return [KWidget,KTools,KMsgBoxOptions,KBubble,KBubbleShowOptions,KEvent,KPosition,KSize,KMsgBoxOpenOptions];
};

KMsgBox.prototype._finalizeButtons = function()
{
    if(this._buttons)
    {
        for(var i in this._buttons)
        {
            KEvent.unbind(this._buttons[i], "click", this._closeButtonFun);
            KTools.removeNode(this._buttons[i][0]);
        }
        this._buttons = null;
    }
};

KMsgBox.prototype._closeButtonFun = function(event)
{
    var _this = event.data._this;
    _this.close("button", {name:$(this).attr("kname"), kvalue:$(this).attr("value")});
};

KMsgBox.prototype._updateElementJDom = function()
{
    var _viewBounds;
    if(this._openOpts.range instanceof KBounds)
    {
        _viewBounds = this._openOpts.range;
    } else {
        _viewBounds = KTools.getBounds(window)
    }
    var _viewSize = _viewBounds.size();
    var bubbleSize = new KSize(this._bubbleJDom.width(), this._bubbleJDom.height());
    this._elementJDom.css({top:(_viewBounds.min.y + _viewSize.height/2-bubbleSize.height/2)+"px", left:(_viewBounds.min.x + _viewSize.width/2)+"px"});
};

KMsgBox.prototype._updateShadowJDom = function()
{
    if(this._dom)
    {
        this._bubbleShadowJDom.offset(this._bubbleJDom.offset());
        this._bubbleShadowJDom.css({height:this._bubbleJDom.outerHeight(true)+1,width:this._bubbleJDom.outerWidth(true)+1});
    }
};

KMsgBox.prototype._setClass = function(dom, className)
{
    if (dom) dom.className = className;
};

KMsgBox.prototype._updateThemeClass = function(useDefault)
{
    if (this._dom)
    {
        if (useDefault == false)
        {
            this._setClass(this._dom, this._theme + "_mbx");
            this._setClass(this._bubbleShadowJDom.get(0), this._theme + "_mbx_s");
            this._setClass(this._titleJDom.get(0), this._theme + "_mbx_t");
            this._setClass(this._msgJDom.get(0), this._theme + "_mbx_c");
            this._setClass(this._btJDom.get(0), this._theme + "_mbx_ba");
        }
    }
};
/*
 
 zhangsq
 1.2.3
 2010-11-24
 2011-3-31 16:14
 ======================================================
 
 opt# 201103151005
 stationlistsimplenoresult
 opt# 201103151448
 sl_resultshow
 opt# 200103151801
 
 opt# 201103151953
 cancelappend
 bug# 201103231628
 
 opt# 201103301648
 UI
 err# 201103311612
 
*/

var KNavsearch = KClass.create('KNavsearch', KQuery);
KNavsearch.conf =
{
    CLASSNAME :
    {
        // div
        NS :''
        //div
        ,SP :'_sp'
        //div
        ,SR : '_sr'
        //->div
        ,SRT : '_srt'
        //->div
        ,SRCS : '_srcs'
        //->div
        ,SRCD : '_srcd'
        //->->->
        ,SSP : '_ssp'
        // 	->->->
        ,STP : '_stp'
        // 	->->->
        ,SEP : '_sep'
        //->div
        ,OPC : '_opc'
        //->div
        ,AC : '_ac'
        //->->div
        ,ACUS : '_acus'
        //->->div
        ,ACS : '_acs'
        //->->->span
        ,SAT : '_sat'
        //->->->a
        ,SAB : '_sab'
        //->->->div
        ,ATB : '_atb'
        //->->->input
        ,ATTB : '_attb'
        //->->->div
        ,ACD : '_acd'
        // 
        ,SRH : '_srh'
        //
        ,EPT :'_ept'
        //
        ,OCO2 : '_opc_co2'
        //.
        ,CO2 :'_g_co2'
        //->->
        ,SDO : '_sdo'
        //->->
        ,SDC :'_sdc'
    }
};

/**
 * 
 * @param container Node 
 * @param opts KNavsearchOptions
 */
KNavsearch.initialize = function(container, opts)
{
    //
    this._initVariable();
    //
    this.setOptions(opts);
    //DOM
    this._getDom(container);
    //
    this._applyTheme();
    //
    this._initEvent();
};

/*==================== KObject ====================*/
/**
 * 
 * @overwrite
 * @uncrunch
 */
KNavsearch.prototype.finalize = function()
{
    this.clearResult();
};

/*===================== KWidget =====================*/
/**
 * 
 * @return String 
 * @uncrunch
 */
KNavsearch.prototype.version = function()
{
    return "1.2.3";
};
/**
 * 
 * @return String
 * @uncrunch
 */
KNavsearch.prototype.cnname = function()
{
    return "";
};
/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KNavsearch.prototype.dependent = function()
{
    return [ KNamedValue, KQuery, KQueryType, KEvent, jQuery, KUrlHash, KWidgetFlag, KTools, KPOInfo,
			KNavsearchOptions, KQueryOptions, KConfig, KMap, KMarker, KLine, KStdSuggest, KAccordion, KStationList,
			KCityList, KPOIType, KSize, KListener, KCityInfo, KPrintOptions, KStdPrinter, KSendOptions, KStdSender,
			KNamedValue ];
};
/**
 * 
 * @param opts KNavsearchOptions
 */
KNavsearch.prototype.setOptions = function(opts)
{
    var _this = this;
    this.options() && (this._oldOpts = this.options().theme);
    var diffOpts = KTools.compareOptions(this._opts, opts);
    this._setOption(KTools.copyOptions(diffOpts, KNavsearchOptions));
    $.each(diffOpts, function(name, value) {
        if(name == 'theme') _this._applyTheme();
    });
};
/**
 * 
 * @overwrite
 * @uncrunch
 */
KNavsearch.prototype.setTheme = function(scheme)
{
    this.setOptions({'theme' : scheme});
};
/**
 *  
 * @overwrite
 * @uncrunch
 */
KNavsearch.prototype.flag = function()
{
    return KWidgetFlag.navsearch;
};
/**
 * 
 * @overwrite
 * @uncrunch
 */
KNavsearch.prototype.clearResult = function()
{
    //
    if(KMap.isInitialized(this._opts.mapcontainer))
    {
        KMap.clear(KWidgetFlag.navsearch);
    }
    //
    for(var m in this._markerArray)
    {
        this._markerArray[m] = null;
    }
    this._markerArray.length = 0;
    //
    for(var l in this._lineArray)
    {
        this._lineArray[l] = null;
    }
    this._lineArray.length = 0;
    //
    if (this._navExtendSearchAddList)
    {
        this._navExtendSearchAddList.clearResult();
    }
    //
    if (this._navStationList)
    {
        this._navStationList.clearResult();
    }
    this.menuSmarker = null;
    this.menuEmarker = null;
};

/*======================== KQuery =======================*/
/**
 * 
 * @param queryOpt KQueryOptions
 * @overwrite
 * @uncrunch
 */
KNavsearch.prototype.query = function(queryOpt)
{
	/*#opts fix start 
	 * added by zwq radio*/
	 /*change by liufang start 20131128
		urlradio
	*/
    if(this._navTypeCheck == undefined)	{	
		this._navTypeCheck = 0;
		this._navTypeByEMail = 0;
		this._navPrintByType = 0;
	}

	$(">input", this._navTypeDom).eq(this._navTypeCheck).attr("checked", true);
	/*#change by liufang end 20131128*/
    /*# fix end*/
    if(!this._innerQuery)
    {
        this._stationListQueryOpts = undefined;
    }
    this._innerQuery = false;
    this.clearResult();
    KQuery.prototype.query.call(this, queryOpt);    //_queryOpts
    this._startQuery(); //
};
/**
 * Hash
 * @param hash KUrlHash
 * @overwrite
 * @uncrunch
 */
KNavsearch.prototype.queryByHash = function (hash)
{
    var opts = KTools.copyOptions({
        type : KQueryType.navsearch
        ,navorig : KTools.copyOptions({name : hash.value("on") ? hash.value("on") : "", city : hash.value("oc") ? hash.value("oc") : "", latlon : hash.value("ol") ? hash.value("ol") : "", pid : hash.value("oid") ? hash.value("oid") : ""}, KPOInfo)
        ,navdest : KTools.copyOptions({name : hash.value("dn") ? hash.value("dn") : "", city : hash.value("dc") ? hash.value("dc") : "", latlon : hash.value("dl") ? hash.value("dl") : "", pid : hash.value("did") ? hash.value("did") : ""}, KPOInfo)
        }, KQueryOptions);
    if(hash.value("os")){
        //opts.navorig.latlon = '_' + opts.navorig.name;  //
    	opts.navorig.latlon = opts.navorig.name;  //
        opts.navorig.name = hash.value("os");
    }
    if(hash.value("ds")){
        //opts.navdest.latlon = '_' + opts.navdest.name;  //
    	opts.navdest.latlon = opts.navdest.name;  //
        opts.navdest.name = hash.value("ds");
    }
	if (hash.value("mc")) {
		opts.mapcity = KTools.copyOptions( {}, KCityInfo);
		opts.mapcity.name = hash.value("mc");
	}
	if (hash.value("nh")) {
		opts = this._setQueryOptions(hash.value("nh"));
	}
	/*add by liufang 20131128 start
		bw
	*/
	if (!isNaN(hash.value('bw'))) {
		this._navTypeCheck = hash.value('bw'); //
		this._navTypeByEMail = hash.value('bw');//
		this._navPrintByType = hash.value('bw');//
	}
	/*add by liufang 20131128 end*/
	
	/* delete by liufang 20131128 start*/
	/*
	if (hash.value("bw") && hash.value("bw") == 2) {
		this._noHightwayCheck = true;
	} else {
		this._noHightwayCheck = false;
	}
	this._noHightwayClick = false;
	*/
	/* delete by liufang 20131128 end*/
	
    this._innerQuery = true;
	this.query(opts);
};
/**
 * 
 * @uncrunch
 */
KNavsearch.prototype.print = function()
{
    if(this.options().printer)
    {
        var printopts = KTools.copyOptions({queryopts : this._queryopts, markers : [], lines : []}, KPrintOptions);
        for(var i = 0; i < this._markerArray.length; i++)
        {
            printopts.markers.push(this._markerArray[i].toString());
        }
        for(var j = 0; j < this._lineArray.length; j++)
        {
            printopts.lines.push(this._lineArray[j].toString());
        }
        this.options().printer.print(printopts);
    }
};
/**
 * 
 * @param sendtype KSendType
 * @param selected KSendType 
 * @uncrunch
 */
KNavsearch.prototype.send = function(sendtype, selected)
{
    if(this.options().sender)
    {
    	/*  start  added by zwq*/
    	if(this._navTypeByEMail == undefined){
    		this._navTypeByEMail = 0;
    	}
        var sendopts = KTools.copyOptions({querytype : KQueryType.navsearch, sendtype : sendtype ? sendtype : KSendType.email, selected : selected ? selected : KSendType.email, email : []}, KSendOptions);
        sendopts.email.push(KTools.copyOptions({name : 'param', kvalue : this._buildHash({t : 'nsm', nh : this._gethash(this._queryopts), di : '0',nt : this._navTypeByEMail}).toString()}, KNamedValue));
        /* end*/
        this.options().sender.send(sendopts);
    }
};

/*=========================  ==========================*/
/**
 * 
 * @overwrite
 * @uncrunch
 */
KNavsearch.prototype.detail = function()
{
    this._displayPattern('detail');
};
/**
 * 
 * @overwrite
 * @uncrunch
 */
KNavsearch.prototype.summary = function()
{
    this._displayPattern('summary');
};
/**
 * 
 * @overwrite
 * @uncrunch
 */
KNavsearch.prototype.reverse = function()
{
    var backopt = KTools.copyOptions({navdest : this._queryopts.navorig, navorig : this._queryopts.navdest, mid : []}, KQueryOptions);
    backopt.mid = this._queryopts.mid.concat().reverse();
    this.query(backopt);
};
/**
 * 
 * @overwrite
 * @uncrunch
 */
KNavsearch.prototype.showall = function()
{
    KMap.fitzoom();
};
/**
 * 
 * @return Boolean
 * @uncrunch
 */
KNavsearch.prototype.supportbus = function()
{
    return this._chkSupport('b');
};
/**
 * 
 * @return Boolean
 * @uncrunch
 */
KNavsearch.prototype.supportTaxi = function()
{
    return this._result && this._result.taxi && this._result.taxi != '';
};
/**
 *  url 
 * @return String
 * @uncrunch
 */
KNavsearch.prototype.airticket = function()
{
    return this._chkSupport('a') ? 'http://jipiao.mapbar.com' : '';
};
/**
 * 
 * @uncrunch
 */
KNavsearch.prototype.reListStations = function()
{
    if(!this._stationListQueryOpts) //
    {
        this._stationListQueryOpts = KTools.copyOptions({type : KQueryType.navsearch, highway : this._queryopts.highway, navorig : KTools.copyOptions({name : this._queryopts.navorig.name, city : this._queryopts.navorig.city}, KPOInfo), navdest : KTools.copyOptions({name : this._queryopts.navdest.name, city : this._queryopts.navdest.city}, KPOInfo)}, KQueryOptions);
    }
    this._stationListAutoSelect = false;
    this.query($.extend(true, {}, this._stationListQueryOpts));
};
/**
 * /
 * @return Boolean
 * @uncrunch
 */
KNavsearch.prototype.allowReList = function()
{
    return this._navResultDom.is(':visible');
};
/**
 * 
 * @uncrunch
 */
KNavsearch.prototype.layout = function()
{
    if (!this._domAll.is(":visible")) return;
    //opt# 201103301648 fix begin
    //add by zhangsq
    this._fareId && KTools.hideMsg(this._fareId);
    this._msgId && KTools.hideMsg(this._msgId);
    //opt# 201103301648 fix end
    var aheight = parseInt(this._domAll.css("height"));
    if (this._navSearchDom.is(":visible"))
    {
        this._navSearchDom.css({height:(aheight)});
        $(">div", this._navSearchDom).css({height:(aheight)});
        if (this._navStationList)
        {
            this._navStationList.layout();
        }
    }
    else
    {
    	aheight = aheight - 57;//dom -57
        this._navResultDom.css({"overflow-y":"scroll",height:aheight});
    }
    if(this._opts.sender)
    {
        this._opts.sender.layout();
    }
};
/**
 * 
 * @param opts KMsgBoxOpenOptions 
 * @uncrunch
 */
KNavsearch.prototype.showTaxiFare = function(opts){
    var _this = this;
    var _opts = $.extend(true, {}, opts);
    _opts['closedcbk'] = function(){_this._navTaxiFareDom.hide();};
    if(this._chkSupport('b') && !this._navTaxiFareDom.is(':visible'))
    {
        this._fareId = KTools.showMsg(this._navTaxiFareDom.get(0), KTools.copyOptions(_opts, KMsgBoxOpenOptions));
    }
    else
    {
        if(this._fareId)
        {
            this._navTaxiFareDom.hide();
            KTools.hideMsg(this._fareId);
        }
        this._fareId = undefined;
    }
	/*if(!node){
		return;
	}
	//
	if(!this._$taxiFareDom || !this._$taxiFareDom.length || !this._taxiContent){
		return;
	}
	var _this=this;
	if (!this._$taxiFareDom.is(":visible")) {
		//this._$taxiFareDom.html(this._taxiContent.replace(/\<p[^<]+/g, "<p></p>")).show();
		this._$taxiFareDom.html(this._taxiContent).show();
		this._msgId = KTools.showMsg(this._$taxiFareDom.get(0), {
			closedcbk : function() {
				_this._$taxiFareDom.hide().html("");
			},
			node : $(node).get(0),
			cbmargin : 0,
			buboptions : {
				offsetx : 113
			},
			//theme:"blue",
			title:""
		});
	} else {
		this._$taxiFareDom.hide().html("");
		KTools.hideMsg(this._msgId);
	}
	//*/
};

/*====================  =====================*/
/**
 * 
 */
KNavsearch.prototype._initVariable = function()
{
    this._navstationList = undefined;  //
    this._mwpf = KConfig.get("mwpf");   //UrlHash
    this._split = ",";      //
    this._splitN = "_";     //
	/*delete by liufang 20131128 start
	2012
	*/
	/*
    this._noHightwayCheck = false;  //
	*/
	/*delete by liufang 20131128 end*/
    
    /*added by zwq  start*/
    this._navTypeCheck = undefined; //
    this._navTypeByEMail = undefined;//
    this._navPrintByType = undefined;//
    /*end*/
    this._LIMITNUM = 10;    //
    this._lineArray = [];   //
    this._markerArray = []; //
    this._result = undefined;   //
    this._extendOpen = false;   //
    this._requesting = false;   //
    this._dragLeftLine = undefined;     //
    this._dragRightLine = undefined;    //
    this._dragingTempData = undefined;     //
    this._dragedTempData = undefined;       //
    this._revDragTempData = undefined;      //
    this._dragTempIndex = undefined;    //
    this._dragedSuccess = false;        //
    this._stationListQueryOpts = undefined; //StationList
    this._stationListAutoSelect = true; //KStationList
    this._innerQuery = false;  //
    
    this._menuLablename = undefined;
    
    this._wangyiIconDom = $("#wangyiIcon").hide();
    
};
/**
 * 
 * @param sign String 
 * @param theme String Theme
 * @return String 
 */
KNavsearch.prototype._getClassName = function(sign, theme)
{
    return (theme ? theme : this.theme()) + '_ns' + KNavsearch.conf.CLASSNAME[sign];
};
/**
 * 
 */
KNavsearch.prototype._setOption = function(opts)
{
    this.options() && (this._oldOpts = this.options().theme);
    this._opts = KTools.copyOptions(opts, this._opts);
};
/**
 * 
 * @param p String  summary -   detail - 
 */
KNavsearch.prototype._displayPattern = function(p)
{
    this._navResultContainDom.removeClass().addClass(p == 'detail' ? this._getClassName('SRCD') : this._getClassName('SRCS'));
    KMap.closeInfoWindow();
    this._pattern = p;
};
/**
 * DOM
 * @param container Node
 */
KNavsearch.prototype._getDom = function(container)
{
    this._domAll = $(container);
    this._dom = this._domAll.get(0);
    var tempDom = $(">div", this._domAll);
    this._navSearchDom = tempDom.eq(0); //
    this._navResultDom = tempDom.eq(1).hide(); //
    this._navstationListDom = $(">div", this._navSearchDom).eq(0).hide();  //KStationListDom
    this._origDestSelectEtn = $(">div>div>input", this._navSearchDom).eq(0);    //
    var navResultDomArray = $(">div", this._navResultDom);
    /*added by zwq  start*/
    var num = 1;
    this._navTypeDom = navResultDomArray.eq(0);
    $(">input", this._navTypeDom).eq(0).attr("checked", true);//radio
    /*end*/
    this._navResultDescDom = navResultDomArray.eq(num+0);   //
    this._navResultContainDom = navResultDomArray.eq(num+1).hide();    //
    this._navResultOperationDom = navResultDomArray.eq(num+2);  //
    this._navResultExtendDom = navResultDomArray.eq(num+3); //
    this._navNoResultTip = navResultDomArray.eq(num+4).hide();     //
    this._navCo2ShowDom = navResultDomArray.eq(num+5).hide();  //
    this._navTaxiFareDom = navResultDomArray.eq(num+6).hide();  //
    this._navCo2ShowDistance = $(">p>span", this._navCo2ShowDom).eq(0); //
    this._navCo2ShowUI = $(">ul", this._navCo2ShowDom).eq(0);   //
    this._navCo2Href = $(">a[mfg='bsc']", this._navResultOperationDom).eq(0);   //
    this._navCo2Content = $(">span[mfg='bscv']", this._navCo2Href).eq(0);   //
    this._addFavHrefDom = $(">a[mfg='nfav']", this._navResultOperationDom).eq(0);   //
    this._sendHrefDom = $(">a[mfg='nfs']", this._navResultOperationDom).eq(0);  //
    this._printHrefDom = $(">a[mfg='nprt']", this._navResultOperationDom).eq(0);    //
    this._errorHrefDom = $(">a[mfg='nerr']", this._navResultOperationDom).eq(0);    //
    this._startDescDom = $(">div>strong", this._navResultDescDom).eq(0);    //Dom
    this._endDescDom = $(">div>strong", this._navResultDescDom).eq(1);  //Dom
    this._distanceDom = $(">span", this._navResultDescDom).eq(0);   //Dom
    var navResultExtendBtn = $(">div", this._navResultExtendDom);
    this._navExtendDiv = navResultExtendBtn.eq(0);  //Dom
    this._navExtendSearchList = navResultExtendBtn.eq(1);
    this._navExtendSearchDom = $(">div", navResultExtendBtn.eq(1)).eq(0).hide();   //KList
    this._navExtendsearchContainer = $(">div>div>ul", navResultExtendBtn.eq(1)).eq(0);
    this._navExtendsearchClose = $(">div>div>a", navResultExtendBtn.eq(1)).eq(0);   //
    this._navExtendAddEnterBtn = $("div>input", navResultExtendBtn.eq(1)).eq(0);
    this._navExtendCannelBtn = $("pre>a", this._navResultExtendDom).eq(0);  //
    this._navExtendBtn = $(">div>a", this._navResultExtendDom).eq(0);   //
    this._navExtendSearchAddEnterbtn = $("pre>input", this._navResultExtendDom).eq(0);
    this._navExtendCitylistDiv = $(">div", this._navExtendDiv).eq(0);
    this._navExtendCitylistDom = $(">div>div", this._navExtendCitylistDiv).eq(0);   //(KCityList)
    this._navExtendNameInput = $(">div>input", this._navExtendCitylistDiv).eq(0);   //
    this._navResultSeletDom = $(">div", this._navResultContainDom).eq(0).hide();    //(KAccordion)
};
/**
 * 
 */
KNavsearch.prototype._applyTheme = function()
{
    if(this._domAll)
    {
        this._domAll.removeClass().addClass(this._getClassName('NS'));
        this._navSearchDom.removeClass().addClass(this._getClassName('SP'));
        this._navResultDom.removeClass().addClass(this._getClassName('SR'));
        this._navResultDescDom.removeClass().addClass(this._getClassName('SRT'));
        this._navResultContainDom.removeClass().addClass(this._getClassName((this._pattern == 'detail' ? 'SRCD' : 'SRCS')));
        this._navResultOperationDom.removeClass().addClass(this._getClassName('OPC'));
        this._navResultExtendDom.removeClass().addClass(this._getClassName('AC'));
        this._navNoResultTip.removeClass().addClass(this._getClassName('EPT'));
        this._navCo2ShowDom.removeClass().addClass(this._getClassName('CO2'));
        this._navCo2Href.removeClass().addClass(this._getClassName('OCO2'));
        this._navExtendDiv.removeClass().addClass(this._getClassName((this._extendOpen ? 'ACS' : 'ACUS')));
        this._navExtendSearchList.removeClass().addClass(this._getClassName('ACD'));
        this._navExtendBtn.removeClass().addClass(this._getClassName('SAB'));
        this._navExtendCitylistDiv.removeClass().addClass(this._getClassName('ATB'));
        $(">div>span", this._navResultExtendDom).eq(0).removeClass().addClass(this._getClassName('SAT'));
        this._navExtendNameInput.removeClass().addClass(this._getClassName('ATTB'));
    }
};
/**
 * 
 */
KNavsearch.prototype._updateTitle = function()
{
    var acc = this._navAccordion;
    if (acc)
    {
        var length = acc.length();
        this._startDescDom.html($(">strong", acc.tab(0).tabDom).html());
        this._endDescDom.html($(">strong", acc.tab(length - 1).tabDom).html());
        var tmp = this._getTimeAndDistance();
        var descstr = this._convertDistance(tmp.d) + " / " + this._convertTime(tmp.t);
        this._distanceDom.html(descstr);
    }
};
/**
 * 
 * @param lines Integer[] 
 */
KNavsearch.prototype._getTimeAndDistance = function(lines)
{
    var lineLength = this._lineArray.length;
    var time = 0;
    var distance = 0;
    for(var i in (lines || this._lineArray))
    {
        time += parseInt(this._lineArray[lines ? lines[i] : i].time);
        distance += parseInt(this._lineArray[lines ? lines[i] : i].distance);
    }
    return {t : time, d : distance};
};
/**
 * indexindex
 * @param midx Integer index
 * @return Integer[] index
 */
KNavsearch.prototype._getLineIndex = function(midx)
{
    var result = [];
    result.push(midx == 0 ? 0 : parseInt(midx - 1));
    if((midx != this._markerArray.length - 1) && midx != 0)
    {
        result.push(midx);
    }
    return result;
};
/**
 * 
 */
KNavsearch.prototype._initEvent = function()
{
    var _this = this;
    //Click
    this._navCo2Href.click(function() {
        //
        if (_this._msgId == undefined)
        {
            _this._msgId = KTools.showMsg(_this._navCo2ShowDom.get(0), {cbmargin:0, buboptions : {offsetx : 125}, node : _this._navCo2Content.get(0), closedcbk : function(){
                _this._navCo2ShowDom.hide();
                _this._msgId = undefined;
            }});
        }
        else
        {
            KTools.hideMsg(_this._msgId);   //
            _this._msgId = undefined;
        }
    });

    //Click
    this._addFavHrefDom.click(function() {
        KTools.addFavorite("" + (_this._queryopts.navorig.city ? _this._queryopts.navorig.city : '') + (_this._queryopts.navorig.name ? _this._queryopts.navorig.name : '') + '' + (_this._queryopts.navdest.city ? _this._queryopts.navdest.city : '') + (_this._queryopts.navdest.name ? _this._queryopts.navdest.name : '') + ' -   :', document.location.href, this);
    });

    //Click
    this._sendHrefDom.click(function(){
       _this.send();
    });

    //Click
    this._printHrefDom.click(function(){
       _this.print();
    });

    //Click
    this._errorHrefDom.click(function(){
        var kfeedbackInfo = KTools.copyOptions({}, KFeedbackInfo);
        kfeedbackInfo.type = KFeedbackType.ROUTE_ERROR;
        kfeedbackInfo.errortype = KFBErrorType.INFO;
        kfeedbackInfo.notes = _this._queryopts.navorig.name +""+_this._queryopts.navdest.name;
        var krouteInfo =  KTools.copyOptions({}, KRouteInfo);
        krouteInfo.type = KRouteType.NAVIGATION;
        krouteInfo.queryopts =_this._queryopts;
        krouteInfo.name = _this._queryopts.navorig.name +""+_this._queryopts.navdest.name;
        KEvent.trigger(_this, "feedback", _this,kfeedbackInfo,krouteInfo);
    });

    //Click
    this._navExtendsearchClose.click(function(e) {
        KEvent.trigger(_this, "sl_submitbtn", _this, false);
        //opt# 201103151953 fix begin
        //add by zhangsq
        KEvent.trigger(_this, "cancelappend", _this);
        //opt# 201103151953 fix end
        //_this._navExtendCloseClick();
        _this._triggerExtend(false);
    });

    //
    this._navExtendCannelBtn.click(function(e) {
        _this._extendOpen = false;
        _this._triggerExtend(false);
    });

    this._navExtendSearchAddEnterbtn.click(function(e) {
        _this._extendQuery();
    });

    this._navExtendNameInput.keydown(function(e)
    {
        if(e.keyCode == 13)
        {
            _this._extendQuery();
        }
    }).focus(function() {
        if (_this._navExtendTip)
        {
            KTools.hideMsg(_this._navExtendTip);
            _this._navExtendTip = undefined;
        }
    });

    this._navExtendBtn.click(function() {
        _this._triggerExtend(true);
    });
};
/**
 * 
 */
KNavsearch.prototype._extendQuery = function()
{
    var _this = this;
    var insertValue = this._navExtendNameInput.val();
    if (insertValue.replace(/(^\s*)|(\s*$)/g, '') == "")
    {
        this._navExtendTip = KTools.showMsg("", {node:this._navExtendNameInput.get(0),outside:true,autoclose:5,closedcbk:function() {
            _this._navExtendTip = undefined;
        }});
        return;
    }
    this._navExtendDiv.hide();
    this._navAccordion.collapse();
    this._setExtendQueryOpts();
    //this._setOverlyDragFun(false);
    this._initExtendSearchList();
    this._navExtendSearchDom.show();
    this._navExtendDiv.removeClass(this._getClassName('ACS', this._oldOpts)).addClass(this._getClassName('ACUS'));
};
/**
 * 
 */
KNavsearch.prototype._setExtendQueryOpts = function()
{
    this._extendOpts = KTools.copyOptions({type : KQueryType.navsearch},KQueryOptions);
    this._extendOpts.navdest = this._extendOpts.navdest || {};
    this._extendOpts.navdest.city = this._navExtendCitylist ? this._navExtendCitylist.city().name : '';
    this._extendOpts.navdest.name = this._navExtendNameInput.val();

    this._extendOpts.navorig = $.extend(true, {}, this._queryopts.navdest);
};
/**
 *  
 */
KNavsearch.prototype._initExtendSearchList = function()
{
    var _this = this;
    if (!this._navExtendSearchAddList)
    {
        var opts = KTools.copyOptions({
            initmap:false,
            citylist:false,
            autoheight:true,
            origarea:false,
            changehash:false
        }, this._opts.slopts);
        this._navExtendSearchAddList = new KStationList(this._navExtendSearchDom, opts);
        KEvent.bind(this._navExtendSearchAddList, "selectdone", function(evt, w, oinfo, dinfo) {
            var q = {orig : oinfo, dest : dinfo};
			if (!_this._navstationListDom._query) {
				if (_this._checkLatlonExtend(q)) {
					//_this._navExtendBtnClick(evt, w, q);
                    _this._startExtendQuery(q);
				} else {
					KTools.showMsg("");
					KEvent.trigger(_this, "sl_submitbtn", _this, true);
				}
			}
		});
        KEvent.bind(this._navExtendSearchAddList, "submitbtn", function(evt, w, v) {
            KEvent.trigger(_this, "sl_submitbtn", _this, v);
        });
        KEvent.bind(this._navExtendSearchAddList, "resultloaded", function() {
            _this._navExtendSearchDom._query = true;    //
            _this._navstationListDom._query = false;    //
            KEvent.trigger(_this, "sl_resultloaded", _this);
        });
        KEvent.bind(this._navExtendSearchAddList, "resultshown", function(evt, w, action, result, isNoResult) {
            //opt# 201103151448 fix begin
            //delete by zhangsq
            //KEvent.trigger(_this, "sl_resultshown", _this);
            //add by zhangsq
            _this._triggerSlResultShown('appenddest');
            //opt# 201103151448 fix end
            if(isNoResult)
            {
                _this._triggerExtend(false);
                _this._navExtendDiv.removeClass(_this._getClassName('ACUS')).addClass(_this._getClassName('ACS'));
                this.showNoResultTip([_this._navExtendNameInput.get(0)]);
            }
            else
            {
                _this.layout();
            }
        });
        KEvent.bind(this._navExtendSearchAddList, "mapready", function(evt, w, c, l) {
            KEvent.trigger(_this, "mapready", _this, c, l);
        });
        KEvent.bind(this._navExtendSearchAddList, "selectchanged", function(evt, w, p) {
            KMap.fitzoom();
        });
        this.layout();
    }
    this._navExtendSearchAddList.query(this._extendOpts);
    this._changeEndMarkerIcon(0);
};
/**
 * 
 * @param q object
 */
KNavsearch.prototype._startExtendQuery = function(q)
{
    this._extendOpts.navdest = this._extendOpts.navdest || {};
    //this._extendOpts.navorig = this._extendOpts.navdest && this._queryopts.navdest;
    this._extendOpts.navdest.name = q.dest.name;
    this._extendOpts.navdest.latlon = q.dest.latlon;
    //this._setOverlyDragFun(true);
    this._queryExtendResult();
};
/**
 * 
 */
KNavsearch.prototype._queryExtendResult = function()
{
    this._ajaxFun(this._buildHash({nh : this._gethash(this._extendOpts), di : this._getTimeAndDistance().d}), this._queryExtendComplete);
};
/**
 * 
 * @param data JSON
 */
KNavsearch.prototype._queryExtendComplete = function(data)
{
    this._parseResult(data);        //
    this._triggerResultLoaded('appendest', this._result);   //resultloaded
    this._showExtendResult();       //
    this._syncSearchbox();          //
    this.showall();                 //
    this._updateTitle();
    this._updateQueryOpts();
    this._triggerResultShown('appendest', this._result); //resultshown
    this._updateCo2ShowDom(); //
    this._updateTaxiFare(); //
    //opt# 200103151801 fix begin
    //add by zhangsq
    this._toggleExtend();   //
    //opt# 200103151801 fix end
};
/**
 * 
 */
KNavsearch.prototype._showExtendResult = function()
{
    var _lidx = [];
    var _idxs = this._getLineIndex(this._markerArray.length);//
    KEvent.trigger(this, "resultloaded", this, 'appendest', this._result);  //resultloaded
    KEvent.trigger(this, "sl_submitbtn", this, false);    //sl_submitbtn
    if (this._navExtendSearchAddList)
    {
        this._navExtendSearchAddList.clearResult();
    }
    this._insertResultDesc(this._result);   //
    var lines = this._initLineAndMarker(true);
    for(var i = 0; i < lines.length; i++)
    {
        _lidx.push(lines[i]._idx);
    }
    this._initAccordionIndex(_lidx);
    this._volumeBindDetailHerfEvent(_lidx);
    this._volumeBindResultEvent(_lidx); //
    this._triggerExtend(false); //
    this._updateQueryOpts();
    this._updateDragState();
};
/**
 * 
 * @param data Object 
 * @param tabindex Integer
 * @param index Integer
 */
KNavsearch.prototype._insertResultDesc = function(data, tabindex, index)
{
    if(tabindex == undefined)
    {
        tabindex = this._navAccordion.length() - 1;
        var text = '<span class="' + this._getClassName('STP') + '"></span><pre/><strong>' + $(">strong", this._navAccordion.tab(tabindex).tabDom).eq(0).html() + '</strong><i style="display:block;height:0;font-size:0;clear:both;"></i>';
        this._navAccordion.insert({index : tabindex, text : text, content : ''});
        //$('>strong' , this._navAccordion.tab(tabindex + 1).tabDom).eq(0).html(this._extendOpts.navdest.name);
        this._changeAccordionTab(tabindex + 1, this._extendOpts.navdest.name);  //
    }
    var des = this._getDescript(data);
    var d = des[tabindex] ? des[tabindex] : des[0];
    var next = undefined;
    if(index != undefined) next = $('>ol', this._navAccordion.tab(tabindex).contentDom).eq(index);
    if(next && next.get(0))
    {
        next.before(d);
    }
    else
    {
        $(this._navAccordion.tab(tabindex).contentDom).append(d);
    }
    this._resetDesNum(tabindex);
    this._triggerAccordionTab(tabindex); //
    //this._navAccordion.select(tabindex); //
};
/**
 * Tab
 * @param idx Integer 
 * @param text String 
 */
KNavsearch.prototype._changeAccordionTab = function(idx, text)
{
    idx && $('>strong' , this._navAccordion.tab(idx).tabDom).eq(0).html(text);
};
/**
 * 
 * @param data Object 
 * @return String 
 */
KNavsearch.prototype._getDescript = function(data)
{
    var result = [];
    if(data && data.b && data.b != '')
    {
        var tmp  = data.b.replace(/<h3[\s\S]*?<\/h3>/gi, '').split(/<\/div>/);
        for(var i = 0; i < tmp.length; i++)
        {
            if(tmp[i] && tmp[i].length > 0)
            {
                result.push(tmp[i].replace(/<div[\s\S]*?>/gi, '').replace(/<\/div>/gi, ''));
            }
        }
    }
    return result;
};
/**
 * 
 * @param tabindex Integer 
 */
KNavsearch.prototype._resetDesNum = function(tabindex)
{
    if(tabindex == undefined)
    {
        var len = this._navAccordion.length();
        for(var i = 0; i < len; i++)
        {
            this._resetDesNum(i);
        }
    }
    else
    {
        var c = this._navAccordion.tab(tabindex).contentDom;
        $('>ol>li', c).each(function(i){
            $('>b', this).html((i + 1) + '.');
        });
        $('>dl>dt', c).each(function(j){
            $('>b', this).html((j + 1) + '.');
        });
    }
};
/**
 * Accordion
 * @param idxs Integer[]
 */
KNavsearch.prototype._removeResult = function(idxs)
{
    var _dls = $('>div>dl', this._navAccordion.dom());
    var _ols = $('>div>ol', this._navAccordion.dom());
    var tidx = [];
    for(var j in idxs)
    {
        var idx = parseInt(idxs[j]);
        this._bindDetailHerfEvent(idx, true);   //
        this._bindResultEvent(idx, true);       //
        tidx.push(this._getIndexInTab(_ols[idx]));
        $(_dls[idx]).remove();
        $(_ols[idx]).remove();
    }
    return tidx;
};
/**
 * Tab
 * @param ol Node
 * @return Integer 
 */
KNavsearch.prototype._getIndexInTab = function(ol)
{
    var idx = undefined;
    $('>ol', $(ol).parent()).each(function(i){
        if(this == ol) idx = i;
    });
    return idx;
};
/**
 * 
 * @param dest
 */
KNavsearch.prototype._updateWaypoint = function(dest)
{
    if(dest)
    {
        this._queryopts.mid = this._queryopts.mid || [];
        this._queryopts.navdest.type = KPOIType.MIDNODE;    //type
        this._queryopts.mid.push(this._queryopts.navdest);  //
        this._queryopts.navdest = dest; //
        this._setHash(true);    //UrlHash
    }
};
/**
 * QueryOptions
 * @param updateurl Boolean Url true
 */
KNavsearch.prototype._updateQueryOpts = function(updateurl)
{
    updateurl = updateurl == undefined ? true : updateurl;
    var length = this._markerArray.length;
    /*edit by zwq  highway _noHightwayCheck  _navPrintByType  #start*/
    var opts = KTools.copyOptions({type : KQueryType.navsearch, highway : this._navPrintByType, navorig : KTools.copyOptions({}, KPOInfo), navdest : KTools.copyOptions({}, KPOInfo)}, KQueryOptions);
    /*end*/
    opts.navdest.latlon = this._markerArray[length - 1].latlon().getPid();
    opts.navdest.name = this._markerArray[length - 1].POIName;
    opts.navdest.city = this._markerArray[length - 1]._city;
    opts.navdest.type = KPOIType.NORMAL;
    opts.navorig.latlon = this._markerArray[0].latlon().getPid();
    opts.navorig.name = this._markerArray[0].POIName;
    opts.navorig.type = KPOIType.NORMAL;
    opts.navorig.city = this._markerArray[0]._city;

    opts.mid = [];
    for (var i = 1; i < length - 1; i++)
    {
        var marker = this._markerArray[i];
        var tempPOI = KTools.copyOptions({latlon : marker.latlon().getPid(), name : marker.POIName, type : marker._type}, KPOInfo);
        tempPOI.city = this._markerArray[i]._city;
        opts.mid.push(tempPOI);
    }
    this._queryopts = opts;
    updateurl && this._setHash(true);
};
/**
 * 
 * @param q
 */
KNavsearch.prototype._checkLatlonExtend = function(q)
{
    if ((q.dest.name == this._queryopts.navorig.name && q.dest.city == this._queryopts.navorig.city) || (q.dest.name == this._queryopts.navdest.name && q.dest.city == this._queryopts.navdest.city))
    {
        return false;
    }
    if (this._queryopts.mid)
    {
        for (var i in this._queryopts.mid)
        {
            if (q.dest.name == this._queryopts.mid[i].name && q.dest.city == this._queryopts.mid[i].city && this._queryopts.mid[i].type == KPOIType.MIDNODE)
            {
                return false;
            }
        }
    }
    return true;
};
/**
 * 
 * @param flag Boolean
 */
KNavsearch.prototype._triggerExtend = function(flag)
{
    flag = flag == undefined ? (!this._extendOpen) : flag;
    this._extendOpen = flag;
    if(flag)    //
    {
        this._initExtendCitylist(); //
        this._navExtendNameInput.val("");
        this._navExtendDiv.removeClass(this._getClassName('ACUS', this._oldOpts)).addClass(this._getClassName('ACS'));
        this.layout();
        KTools.scrollIntoView(this._navExtendCannelBtn, this._navResultDom, "fast");
    }
    else    //
    {
        this._navExtendSearchDom.hide();
        this._navExtendDiv.show();
        //this._setOverlyDragFun(true);
        this._changeEndMarkerIcon(1);
        this._navExtendDiv.removeClass(this._getClassName('ACS', this._oldOpts)).addClass(this._getClassName('ACUS'));
        if(this._navExtendSearchAddList)
        {
            this._navExtendSearchAddList.clearResult();
        }
    }
};
/**
 * 
 * @param flag
 */
KNavsearch.prototype._setOverlyDragFun = function(flag)
{
    for(var i in this._markerArray)
    {
        this._markerArray[i].setEditable(flag);
    }
    for(var j in this._lineArray)
    {
        this._lineArray[j].setEditable(flag);
    }
};
/**
 *
 * @param flag
 */
KNavsearch.prototype._changeEndMarkerIcon = function(flag)
{
    var _endArr = this._markerArray[this._markerArray.length - 1];
    var text = (flag == 0 ? 'w' : 'e');
    var extendIcon = KConfig.get("mk_s_sdtn", {t:text});
    var labelCss = KConfig.get("mk_s_sdtln", {t:text});
    var endtab = this._navAccordion.tab(this._navAccordion.length() - 1).tabDom;
    $(">span", endtab).eq(0).removeClass().addClass(this._getClassName((flag == 0 ? 'STP' : 'SEP')));
    _endArr.setOptions({icon:{snapIcon:KConfig.get("mk_s_sdts", {t:text})}});
    _endArr.setIconClass(extendIcon);
    _endArr.setLabelClass(labelCss);
    _endArr._type = (flag == 0 ? KPOIType.MIDNODE : KPOIType.NORMAL);
};
/**
 * 
 */
KNavsearch.prototype._initExtendCitylist = function()
{
    if (!this._navExtendCitylist)
    {
        var _this = this;
        this._navExtendCitylist = new KCityList(this._navExtendCitylistDom, this._opts.cylopts ? this._opts.cylopts : {});
        KEvent.bind(this._navExtendCitylist, 'citychanged', function(e,w,c,p){
            if(_this._navExtendNameSug)
            {
                _this._navExtendNameSug.clearCache();
                var _hash = new KUrlHash();
                _hash.setKey('c', c.name);
                _this._navExtendNameSug.setOptions({url:_this.options().sugopts.url + '&' + _hash.toString()});
            }
        });
    }
    if(!this._navExtendNameSug && this.options().sugopts)
    {
        var _hash = new KUrlHash();
        _hash.setKey('c', this._navExtendCitylist.city().name);
        var _opt = KTools.copyOptions({}, this.options().sugopts);
        _opt.url += '&' + _hash.toString();
        this._navExtendNameSug = new KStdSuggest(this._navExtendNameInput.get(0), _opt);
    }
};
/**
 * 
 */
KNavsearch.prototype._startQuery = function()
{
	/*add by liufang 20131128 start
		
		
	*/
    this._clearAllOverlay('all');
	/*add by liufang 20131128 end*/
	KEvent.trigger(this, 'searchbefore', this, this._queryopts);    //searchbefore
    //
    if(this._queryopts.navorig && this._queryopts.navorig.latlon && this._queryopts.navdest && this._queryopts.navdest.latlon)
    {
        this._queryResult();   //
    }
    else
    {
        this._stationListQueryOpts = $.extend(true, {}, this._queryopts);
        this._wangyiIconDom.hide(); //
        this._queryStationList();   //
    }
};
/**
 * stationlist
 * @param flag Integer 1   0 
 */
KNavsearch.prototype._changeShowState = function(flag)
{
    if (flag == 1)
    {
        this._navSearchDom.hide();
        this._navstationListDom.hide();
        this._navResultDom.show();
    }
    else
    {
        this._navResultDom.hide();
        this._navstationListDom.show();
        this._navSearchDom.show();
    }
};
/**
 * UrlHash
 * @param flag
 */
KNavsearch.prototype._setHash = function(flag)
{
    var queryHash = new KUrlHash();
    var queryOpt = this._queryopts;
    if (queryOpt)
    {
        if (!queryOpt.navorig.latlon || !queryOpt.navdest.latlon)
        {
            if (queryOpt.navdest.name)
            {
                queryHash.setKey("dn", queryOpt.navdest.name);
            }
            if (queryOpt.navorig.name)
            {
                queryHash.setKey("on", queryOpt.navorig.name);
            }
            if (queryOpt.navorig.city != undefined)
            {
                if (queryOpt.navorig.city != "")
                {
                    queryHash.setKey("oc", queryOpt.navorig.city);
                }
                else
                {
                    queryHash.setKey("oc", "none");
                }
            }
            if (typeof queryOpt.navdest.city != undefined)
            {
                if (queryOpt.navdest.city != "")
                {
                    queryHash.setKey("dc", queryOpt.navdest.city);
                }
                else
                {
                    queryHash.setKey("dc", "none");
                }
            }
            if (queryOpt.mapcity)
            {
                queryHash.setKey("mc", queryOpt.mapcity.name);
            }
        }
        else
        {
            queryHash.setKey("nh", this._gethash(queryOpt));
			/*change by liufang 20131128 start
			  bw 2012
				  nt 
				0 	1.	2.
			*/
			queryHash.setKey("bw", this._navTypeCheck);
			/*change by liufang 20131128 end*/
			
			/*delete by liufang 20131128 start*/
			/*
            queryHash.setKey("bw", this._noHightwayCheck ? "2" : "1");
			*/
			/*delete by liufang 20131128 end*/
        }
    }
    queryHash.setKey(this._mwpf, KWidgetFlag.navsearch);
    KListener.setHash(queryHash, flag);
};
/**
 * SearchBox
 * @param opts KQueryOptions
 */
KNavsearch.prototype._syncSearchbox = function(opts)
{
    if(this.options().searchbox)
    {
        this.options().searchbox.query(opts ? opts : this._queryopts, true);
    }
};
/**
 * 
 */
KNavsearch.prototype._queryStationList = function()
{
    if(!this._navStationList)
    {
        var _this = this;
        var opts = KTools.copyOptions({
            initmap:false,
            citylist:true,
            changehash:false,
            autoselect:this._stationListAutoSelect
            //opt# 201103151005 fix begin
            //delete by zhangsq
            //simplenoresult : false
            //opt# 201103151005 fix end
        }, this._opts.slopts);
        this._navStationList = new KStationList(this._navstationListDom, opts); //
        //resultloaded
        KEvent.bind(this._navStationList, 'resultloaded', function(evt, wgt, action, result){
            _this._navExtendSearchDom._query = false;   //
            _this._navstationListDom._query = true;     //
            KEvent.trigger(_this, 'sl_resultloaded', _this);    //sl_resultloaded
        });
        //resultshown
        KEvent.bind(this._navStationList, 'resultshown', function(eventinfo, widget, action, query, result){
            _this._navStationList.show();   //
            _this._changeShowState(0);  //
            _this.layout(); //
            _this._syncSearchbox(); //
            if (_this.options().searchbox) {
				this.showNoResultTip(_this.options().searchbox.getCurrInputs());
			}
            _this._navStationList.setOptions({autoselect : true}); //KStationList
            _this._stationListAutoSelect = true; //KStationList
            //opt# 201103151448 fix begin
            //add by zhangsq
            _this._triggerSlResultShown('query');
            //delete by zhangsq
            //KEvent.trigger(_this, 'sl_resultshown', _this); //sl_resultshown
            //opt# 201103151448 fix end
        });
        //changehash
        KEvent.bind(this._navStationList, 'changehash', function(e,w,opt,urlhash){
            urlhash = urlhash.clone();
            urlhash.setKey(_this._mwpf, _this.flag());
            KListener.setHash(urlhash, true);   //UrlHash
        });
        //locationchanged
        KEvent.bind(this._navStationList, 'locationchanged', function(e,w,which,poinfo){
            switch(which)
            {
                case 'orig':
                    _this._queryopts.navorig = poinfo;
                    break;
                case 'dest':
                    _this._queryopts.navdest = poinfo;
                    break;
            }
            _this._syncSearchbox($.extend(true, {}, _this._queryopts)); //Searchbox
        });
        //selectdone
        KEvent.bind(this._navStationList, "selectdone", function(evt, w, oinfo, dinfo) {
            //
            if (_this._navstationListDom._query)
            {
                _this._noHightwayCheck = false;
                /*#start added by zwq  */
                _this._navTypeByEMail = undefined;
        		_this._navPrintByType = undefined;
        		
        		/*#end*/
                _this._navEnterSearch(evt, w, {orig : oinfo, dest : dinfo});
            }
        });
        //mapready
        KEvent.bind(this._navStationList, "mapready", function(evt, w, c, l) {
            KEvent.trigger(_this, "mapready", _this, c, l); //mapready
        });
        //submitbtn
        KEvent.bind(this._navStationList, "submitbtn", function(evt, w, v) {
            KEvent.trigger(_this, "sl_submitbtn", _this, v);    //sl_submitbtn
        });
    }
    this._navStationList.setOptions({autoselect : this._stationListAutoSelect});
    this._navStationList.query(this._queryopts);    //
};
/**
 * 
 */
KNavsearch.prototype._queryResult = function()
{
    var obj = {};
    if(this._queryopts.navdest)
    {
        obj.dl = this._queryopts.navdest.latlon ? this._queryopts.navdest.latlon : '';
        obj.did = this._queryopts.navdest.latlon ? this._queryopts.navdest.latlon : '';
        obj.dn = this._queryopts.navdest.name ? this._queryopts.navdest.name : '';
    }
    if(this._queryopts.navorig)
    {
        obj.ol = this._queryopts.navorig.latlon ? this._queryopts.navorig.latlon : '';
        obj.oid = this._queryopts.navorig.pid ? this._queryopts.navorig.pid : '';
        obj.on = this._queryopts.navorig.name ? this._queryopts.navorig.name : '';
    }
    obj.nh = this._gethash(this._queryopts);
    obj.di = "0";
    this._ajaxFun(this._buildHash(obj), this._queryComplete);
};
/**
 * Hash
 * @param data Object
 * @param hash KUrlHash
 */
KNavsearch.prototype._buildHash = function(data, hash)
{
    hash = hash || new KUrlHash();
    data = $.extend(true, {
        t : 'n'
        ,h : this._getRequestParam('h')
        ,w : this._getRequestParam('w')
        ,z : this._getRequestParam('z')
    }, data);
	/*delete by liufang 20131128 start
	_noHightwayCheck 
	*/
	/*
    this._noHightwayCheck && (data.nt = '2');
	*/
    /*added by zwq nt start*/
	/* 
    if(this._navTypeCheck){
    	data.nt = this._navTypeCheck;
    	this._navTypeCheck = undefined;
    }*/
    /*end*/
	/*delete by liufang 20131128 end*/
	/*add by liufang 20131128 start*/	
	data.nt = this._navTypeCheck;
	/*add by liufang 20131128 end*/
    for(var i in data)
    {
        hash.setKey(i.toString(), data[i]);
    }
    hash.setKey(this._mwpf, KWidgetFlag.navsearch);

    return hash;
};
/**
 * 
 * @param data
 */
KNavsearch.prototype._queryComplete = function(data)
{
    if(data)
    {
        var _this = this;
        if(!KMap.isInitialized(this.options().mapcontainer))
        {
            KEvent.bind(KMap, 'mapinit', function(){
                KEvent.unbind(KMap, 'mapinit', arguments.callee);
                _this._queryComplete(data);
            });
        }
        else
        {
            this._parseResult(data);    //
            this._triggerResultLoaded(this._noHightwayClick ? 'highway' : 'query', this._result); //resultloaded
            this._showResult();         //
            this._triggerResultShown(this._noHightwayClick ? 'highway' : 'query', this._result); //resultshown
            this._noHightwayClick = false;
            this._updateQueryOpts();
            this._syncSearchbox();      //
            this.layout();              //
            this.showall();             //
            this._wangyiIconDom.show();  //
            //opt# 200103151801 fix begin
            //add by zhangsq
            this._toggleExtend();   //
            //opt# 200103151801 fix end

            var point = undefined;
            if (_this._result && _this._result != null && _this._result.f && _this._result.f.a)
            {
                point = new MPoint(_this._result.f.a);
            }
            var zoom = undefined;
            if (_this._result && _this._result != null && _this._result.f && _this._result.f.b)
            {
                zoom = _this._result.f.b;
            }
            KEvent.trigger(this, 'mapready', this, point, zoom);
        }
    }
};
/**
 * resultshown
 * @param type String  query  heighwayappendesteditpath
 * @param data Object
 */
KNavsearch.prototype._triggerResultShown = function(type, data)
{
    KEvent.trigger(this, 'resultshown', this, type, data);
};
/**
 * resultshown
 * @param type String
 * @param data
 */
KNavsearch.prototype._triggerSlResultShown = function(type, data)
{
    KEvent.trigger(this, 'sl_resultshown', this, type, data);
};
/**
 * resultloaded
 * @param type String  ighwayappendesteditpath
 * @param data Object
 */
KNavsearch.prototype._triggerResultLoaded = function(type, data)
{
    KEvent.trigger(this, 'resultloaded', this, type, data);
};
/**
 * Ajax
 * @param hash KUrlHash
 * @param sCallback 
 * @param eCallback 
 */
KNavsearch.prototype._ajaxFun = function(hash, sCallback, eCallback)
{
    var _this = this;
    var ajaxUrl = this._opts.url ? (this._opts.url.replace(/\?.*$/, '')) : undefined;   //
    if(ajaxUrl)
    {
        $.ajax({
            type : 'GET'
            ,url : ajaxUrl
            ,cache : false
            ,data : hash.toString()
            ,dataType : 'json'
            ,error : function(){
                eCallback && eCallback.call(_this);
            }
            ,success : function(data){
                sCallback && sCallback.call(_this, data);
            }
        });
    }
};
/**
 * 
 */
KNavsearch.prototype._showResult = function()
{
    KEvent.trigger(this, "sl_submitbtn", this, false);  //sl_submitbtn
    this.clearResult();
    this._initLineAndMarker();  //
    this._initAccordion(this._result.b);    //
    this._resetDesNum();
    this._updateCo2ShowDom(); //
    this._updateTaxiFare(); //
    this._navAccordion.show();
    this._navResultContainDom.show();
    this._navNoResultTip.hide();
    this._updateTitle();    //
    this._setHash(true);    //UrlHash
    this._setOverlyDragFun(true);   //
    this._changeShowState(1);   //
    this._updateDragState();   //
};
/**
 * 
 * @param extend Boolean 
 */
KNavsearch.prototype._initLineAndMarker = function(extend)
{
    if(!this._result) return;
    var newLines = [];
    var sIdx = this._lineArray.length;  //
    var a = this._result.a;
    var c = this._result.c;
    //
    if(a && a.length > 0)
    {
        for(var j in a)
        {
            newLines.push(this._addLine(a[j].a, a[j].b, parseInt(j) + sIdx, this._result.a[j]));
        }
    }
    //()
    if(c && c.length > 0)
    {
		/*delete by liufang 20131202 start
			
			url
			
			url65
		*/
		/*
		1.bug
		2.extend
		*//*
		var _e, flag, latlon, labelname, newlineNum, _opts;
		var _queryopts = this._queryopts;
        for(var i in c)
        {
			//_e:124
            _e = parseInt(c[i].e);	
            flag = _e == 1 ? (i == 0 ? 's' : 'e') : (_e == 2 ? 'd' : (_e == 4 ? 'w' : ''));
			//
			if(_e == 1) {
				_opts = flag == 's' ? _queryopts.navorig : _queryopts.navdest;
				labelname = _opts.name;
				newlineNum = i == newLines.length ? newLines.length - 1 : 0;
				latlon = newLines[newlineNum].latlons(i == 0 ? 'begin' : 'end');
			} else {		
				labelname = _queryopts.mid[i - 1].name;
				latlon = newLines[i].latlons('begin');
			}
            this._addMarker(flag, latlon, labelname, c[i].f);
        }*/
		/*delete by liufang 20131202 end*/		

        for(var i in c)
        {
            var _e = parseInt(c[i].e);
            // s    e    w    d 
            var flag = _e == 1 ? (i == 0 ? 's' : 'e') : (_e == 2 ? 'd' : (_e == 4 ? 'w' : ''));
            var latlon = newLines[i < newLines.length ? i : i - 1].latlons(i == newLines.length ? 'end' : 'begin');
            var labelname = i == 0 ? (extend ? this._extendOpts.navorig.name : this._queryopts.navorig.name) : (i == c.length - 1 ? (extend ? this._extendOpts.navdest.name : this._queryopts.navdest.name) : (this._queryopts.mid[i - 1].name));
            if(i == 0 && extend) continue;
            this._addMarker(flag, latlon, labelname, c[i].f);
        }		
    }
    return newLines;
};
/**
 * 
 * @param flag String  s    e    w    d 
 * @param latlon String 
 * @param name String 
 * @param city String 
 * @param idx Integer 
 */
KNavsearch.prototype._addMarker = function(flag, latlon, name, city, idx)
{
    if(!KMap.isInitialized(this.options().mapcontainer)) return;
    name = (!name) || name == '' ? '' : name;

    var markeropts = flag == 'd' ? KConfig.get('mk_mo_m', {n : name}) : KConfig.get('mk_mo_sdt', {t : flag, n : name});
    markeropts.editable = true;
    markeropts.group = KWidgetFlag.navsearch;
	/*add by liufang 20131202 start
		
		
		
	*/
	latlon = typeof latlon === 'string' ? latlon : latlon.getPid();
	/*add by liufang 2013202 end*/
    var marker = new KMarker(latlon, markeropts);
    marker.POIName = name;
    marker._city = city;
    switch(flag)
    {
        case 's':   //
        	this.menuSmarker = marker;
            marker._type = KPOIType.NORMAL;
            break;
        case 'e':   //
        	this.menuEmarker = marker;
            marker._type = KPOIType.NORMAL;
            break;
        case 'w':   //
            marker._type = KPOIType.MIDNODE;
            break;
        case 'd':   //
            marker._type = KPOIType.DRAGNODE;
            break;
    }
    idx = idx == undefined ? this._markerArray.length : idx;
    marker._idx = idx;
    KEvent.bind(marker, "dragstart", this._dragStart, {type : 'm'}, this);
    KEvent.bind(marker, "draging", this._draging, {type : 'm'}, this);
    KEvent.bind(marker, "dragend", this._draged, {type : 'm'}, this);
    KMap.addMarker(marker);
    if(flag == 'd')
    {
        var _this = this;
        $('>div>div>a[mfg="ncc"]', marker.labelDom()).eq(0).unbind('click').bind('click', function(){
            _this._revDrag(marker._idx);
        });
    }
    this._insertMarker(marker);
};
/**
 * 
 * @param marker
 */
KNavsearch.prototype._insertMarker = function(marker)
{
    if(marker._idx == this._markerArray.length)
    {
        this._markerArray.push(marker);
    }
    else
    {
        for(var i in this._markerArray)
        {
            if(i >= marker._idx)
            {
                this._markerArray[i]._idx += 1;
            }
        }
        this._markerArray.splice(marker._idx, 0, marker);
    }
};
/**
 * 
 * @param idx Integer[] 
 */
KNavsearch.prototype._removeMarker = function(idx)
{
    for(var i in idx)
    {
        KMap.removeMarker(this._markerArray[idx[i]]);
    }
    var tmp = [];
    for(var j = 0; j < this._markerArray.length; j++)
    {
        if($.inArray(j, idx) == -1) tmp.push(this._markerArray[j]);
    }
    this._markerArray = tmp.concat([]);
    for(var k = 0; k < this._markerArray.length; k++)
    {
        this._markerArray[k]._idx = parseInt(k);
    }
};
/**
 * 
 */
KNavsearch.prototype._removeTempLine = function()
{
    this._dragLeftLine && KMap.removeLine(this._dragLeftLine);
    this._dragRightLine && KMap.removeLine(this._dragRightLine);
    this._dragLeftLine = undefined;
    this._dragRightLine = undefined;
};
/**
 * 
 */
KNavsearch.prototype._dragStart = function(e, o, p)
{
    //opt# 200103151801 fix begin
    //add by zhangsq
    //if(this._markerArray.length >= this._LIMITNUM) return;
    //opt# 200103151801 fix end
    this._requesting = false;      //
    this._dragedSuccess = false;    //
    if(e.data.type == 'm')
    {
        if(o._type && o._type != KPOIType.MIDNODE && o._type != KPOIType.NORMAL)
        {
            o.hideLabel();
        }
    }
};
/**
 * 
 * @param e KEventInfo
 * @param o KOverlay KMarkerKLine
 * @param p MPoint
 */
KNavsearch.prototype._draging = function(e, o, p)
{
    //opt# 200103151801 fix begin
    //add by zhangsq
//    if(this._markerArray.length >= this._LIMITNUM) return;
    //opt# 200103151801 fix end
    if(this._requesting) return;
    this._requesting = true;    //
    this._dragingTempData = {e : e, o : o, p : p}; //
    this._ajaxFun(this._buildHash({f : e.data.type == 'm' ? 'real' : 'temp', nh : this._gethash(this._buildDragQueryOptions(e, o, p))}), this._dragingComplete);
};
/**
 * 
 * @param e KEventInfo
 * @param o KOverlay KMarkerKLine
 * @param p MPoint
 */
KNavsearch.prototype._draged = function(e, o, p)
{
    //opt# 200103151801 fix begin
    //add by zhangsq
//    if(this._markerArray.length >= this._LIMITNUM) return;
    //opt# 200103151801 fix end
    this._dragedTempData = {e : e, o : o, p : p}; //
    var obj = {
        nh : this._gethash(this._buildDragQueryOptions(e, o, p)),
        di : this._getTimeAndDistance().d - (o._type ? this._getTimeAndDistance(this._getLineIndex(parseInt(o._idx))).d : this._getTimeAndDistance([o._idx]).d)
    };
    /*this._removeTempLine(); //
    KMap.hideCursorTip();
    return;*/
    this._ajaxFun(this._buildHash(obj), this._dragedComplete);
};
/**
 * 
 * @param idx Integer 
 */
KNavsearch.prototype._revDrag = function(idx)
{
    this._revDragTempData = {idx : idx}; //
    this._ajaxFun(this._buildHash({nh : this._gethash(this._buildQueryOptions('r', this._markerArray[idx])), di : (this._getTimeAndDistance().d - this._getTimeAndDistance(this._getLineIndex(parseInt(idx))).d).toString()}), this._revDragComplete);
};
/**
 * 
 * @param data Object
 */
KNavsearch.prototype._revDragComplete = function(data)
{
    if(data && data.a && data.a.length > 0)
    {
        this._parseResult(data);    //.
        var idx = this._revDragTempData.idx;
        var _tabindex = this._getTabIndex('m', idx);
        _tabindex.sort();
        var _tidx = [];
        var _idxs = [];
        var _lines = [];
        var _lidx = [];
        _idxs = this._getLineIndex(parseInt(idx));
        //
        this._removeLine(_idxs);
        _tidx = this._removeResult(_idxs);
        //
        for(var j in data.a)
        {
            var a = data.a[j].a;
            var b = data.a[j].b;
            _lines.push(this._addLine(a, b, _idxs[j], this._result.a[j]));
            _lidx.push(_lines[_lines.length - 1]._idx);
        }
        //
        for(var i = 0; i < _tabindex.length; i++)
        {
            this._insertResultDesc(data, _tabindex[i], _tidx[i]);
        }
        this._removeMarker([idx]);  //
        this._initAccordionIndex(_lidx); //
        this._volumeBindDetailHerfEvent(_lidx);
        this._volumeBindResultEvent(_lidx);//
        this._updateTitle();
        this._updateQueryOpts();
        this._updateCo2ShowDom(); //
        this._updateTaxiFare(); //
        this._triggerResultShown('editpath', this._result); //resultshown
        //opt# 200103151801 fix begin
        //add by zhangsq
        this._toggleExtend();   //
        //opt# 200103151801 fix end
        this._updateDragState();   //
    }
};
/**
 * 
 * @param data
 */
KNavsearch.prototype._dragedComplete = function(data)
{
    this._removeTempLine(); //
    if(data && data.a && (data.a.length > 0))
    {
        var _obj = this._dragedTempData.o;
        var _idx = _obj._idx;
        var _type = this._dragedTempData.e.data.type;
        var _tabindex = this._getTabIndex(_type, _idx);
        _tabindex.sort();
        var _idxs = [];
        var _lines = [];
        var _lidx = [];
        var _tidx = [];
        this._parseResult(data);    //
        this._triggerResultLoaded('editpath', this._result);    //resultloaded
        //
        if(_type == 'm') //
        {
            _idxs = this._getLineIndex(parseInt(_idx));
            this._removeLine(_idxs);
            _tidx = this._removeResult(_idxs);
        }
        else if(_type == 'l') //
        {
            _idxs.push(_idx);
            this._removeLine(_idxs);
            _tidx = this._removeResult(_idxs);
            _idxs = new Array(_idx, _idx + 1);
        }
        //
        for(var j in data.a)
        {
            var a = data.a[j].a;
            var b = data.a[j].b;
            _lines.push(this._addLine(a, b, _idxs[j], this._result.a[j]));
            _lidx.push(_lines[_lines.length - 1]._idx);
        }
        //
        for(var i = 0; i < _tabindex.length; i++)
        {
            this._insertResultDesc(data, _tabindex[i], _tidx[i]);
        }
        //
        if(_type == 'm')
        {
            if(_obj._type == KPOIType.DRAGNODE || _obj._type == KPOIType.MIDNODE)   //
            {
                _obj._city = data.c[1].f;
            }
            else if(_obj._type == KPOIType.NORMAL) ///
            {
                _obj._city = data.c[_idx == 0 ? 0 : 1].f;
            }
        }
        //Tab
        if(_type == 'm' && _obj._type != KPOIType.DRAGNODE)
        {
            var tabidx = undefined;
            var text = undefined;
            if(_obj._type == KPOIType.MIDNODE) //
            {
                tabidx = _tabindex[0] > _tabindex[1] ? _tabindex[0] : _tabindex[1];
                text = data.c[1].a;
            }
            else if(_obj._type == KPOIType.NORMAL) ///
            {
                tabidx = _idx == 0 ? _tabindex[0] : _tabindex[0] + 1;
                text = data.c[_idx == 0 ? 0 : 1].a;
            }
            text = text || '';
            this._changeAccordionTab(tabidx, text);
        }
        if(_type == 'l')
        {
            this._addMarker('d', this._lineArray[_idxs[0]].latlons('end').getPid(), data.c[1].a || '', data.c[1].f, parseInt(_idx) + 1);  //
        }
        this._setMarkerLabel('draged', data);
        this._initAccordionIndex(_lidx); //
        this._volumeBindDetailHerfEvent(_lidx);//
        this._volumeBindResultEvent(_lidx);//
        this._updateTitle();    //
        this._updateCo2ShowDom(); //
        this._updateTaxiFare(); //
        this._triggerAccordionTab(tabidx);  //
        this._triggerResultShown('editpath', this._result); //resultshown
        this._updateQueryOpts();    //queryopts
        this._syncSearchbox();  //Searchbox
        //opt# 200103151801 fix begin
        //add by zhangsq
        this._toggleExtend();   //DOM
        //opt# 200103151801 fix end
    }
	//data.a
    if((!data || !data.a || data.a.length == 0) || this._dragedTempData.e.data.type == 'm')
    {
        this._correctionMarker(this._dragedTempData.o._idx);  //
    }
    if(this._dragedTempData.o._type == KPOIType.DRAGNODE)
    {
        this._dragedTempData.o.showLabel();
    }
    KMap.hideCursorTip();
    this._updateDragState();   //
    this._dragedSuccess = true;
};

/**
 * marker
 */
KNavsearch.prototype._updateDragState = function()
{	
	var able = this._lineArray.length < this._LIMITNUM-1 ;
	for ( var i = 0; i < this._lineArray.length; i++) {
		this._lineArray[i].setEditable(able);
	}
	
//	var able = this._markerArray.length < this._LIMITNUM ;
//	for ( var i = 0; i < this._markerArray.length; i++) {
//		this._markerArray[i].setEditable(able);
//	}
};
/**
 * 
 * @param data JSON 
 */
KNavsearch.prototype._dragingComplete = function(data)
{
    this._removeTempLine();
    if(this._dragedSuccess) return; //
    if(data && data.a && (data.a.length == 1 || data.a.length == 2))
    {
        this._setMarkerLabel('draging', data);
        for(var i in data.a)
        {
            var a = data.a[i].a;
            var b = data.a[i].b;
            var line = this._addTmpLine(a, b, undefined, true, data);
            if(i == 1)
            {
                this._dragRightLine = line;
            }
            else if(i == 0)
            {
                data.a.length > 1 ? (this._dragLeftLine = line) : (this._dragRightLine = line);
            }
        }
    }

    this._requesting = false;   //
};
/**
 * 
 */
KNavsearch.prototype._toggleExtend = function()
{
    if(this._markerArray.length >= this._LIMITNUM)
    {
        this._navResultExtendDom.hide();
    }
    else
    {
        this._navResultExtendDom.show();
    }
};
/**
 * Tab
 * @param flag String m   l 
 * @param idx Integer 
 * @return Integer[] Tab
 */
KNavsearch.prototype._getTabIndex = function(flag, idx)
{
    var result = [0];
    for(var i = 0; i < this._markerArray.length; i++)
    {
        if(this._markerArray[i]._type == KPOIType.MIDNODE)
        {
            result[0] += 1;
        }
        if(parseInt(this._markerArray[i]._idx) == parseInt(idx))
        {
            if(this._markerArray[i]._type == KPOIType.MIDNODE && flag == 'm')
            {
                result.push(result[0] - 1);
            }
            return result;
        }
    }
    return result;
};
/**
 * 
 * @param etype String  drageddraging
 * @param data Object 
 */
KNavsearch.prototype._setMarkerLabel = function(etype, data)
{
    if(data && data.c && data.c.length > 0)
    {
        var tmpData = etype == 'draged' ? this._dragedTempData : this._dragingTempData;
        if((tmpData.e.data.type == 'm' && tmpData.o._type != KPOIType.DRAGNODE) || (etype == 'draged' && tmpData.o._type == KPOIType.DRAGNODE))
        {
            var _type = tmpData.o._type;
            var idx = parseInt(tmpData.o._idx);
            this._markerArray[idx].POIName = data.c[idx == 0 ? 0 : 1].a || '';
            //this._markerArray[idx]._city = data.c[idx == 0 ? 0 : 1].f;
            if(_type)
            {
                $((tmpData.o._type == KPOIType.DRAGNODE ? 'span' : 'div') + '[mfg ="lbl"]', $(this._markerArray[idx].labelDom())).html(data.c[idx == 0 ? 0 : 1].a || '');
            }
        }
        else if(tmpData.e.data.type == 'l' || tmpData.o._type == KPOIType.DRAGNODE)
        {
            KMap.showCursorTip(data.c[1].a || '');
        }
    }
};
/**
 * 
 * @param idx Integer 
 */
KNavsearch.prototype._correctionMarker = function(idx)
{
    /*if(idx != undefined)
    {*/
        var latlon = this._lineArray[this._getLineIndex(idx)[0]].latlons(idx == 0 ? 'begin' : 'end').getPid();
        var marker = this._markerArray[idx];
        if(latlon != marker.latlon().getPid())
        {
            marker.setLatlon(latlon);
        }
    /*}*/
};
/**
 * KQueryOptions
 * @param e KEventInfo
 * @param obj KOverlay 
 * @param point MPoint 
 */
KNavsearch.prototype._buildDragQueryOptions = function(e, obj, point)
{
    return this._buildQueryOptions(e.data.type, obj, point);
};
/**
 * 
 * @param type String  m   l   r 
 * @param obj KOverlay 
 * @param point MPoint
 * @return KQueryOptions
 */
KNavsearch.prototype._buildQueryOptions = function(type, obj, point)
{
    var opts = KTools.copyOptions({type : KQueryType.navsearch, navorig : KTools.copyOptions({}, KPOInfo), navdest : KTools.copyOptions({}, KPOInfo)}, KQueryOptions);
    var idx = obj._idx; //
    if(type == 'm') //
    {
        if (idx == this._markerArray.length - 1)
        {
            opts.navorig.latlon = this._markerArray[idx - 1].latlon().getPid();
            opts.navdest.latlon = point.getPid();
        }
        else if (idx == 0)
        {
            opts.navorig.latlon = point.getPid();
            opts.navdest.latlon = this._markerArray[idx + 1].latlon().getPid();
        }
        else if (idx != -1)
        {
            opts.navorig.latlon = this._markerArray[idx - 1].latlon().getPid();
            opts.navorig.name = this._markerArray[idx - 1].POIName;
            opts.navdest.latlon = this._markerArray[idx + 1].latlon().getPid();
            opts.navdest.name = this._markerArray[idx + 1].POIName;
            opts.mid = [];
            opts.mid.push(KTools.copyOptions({latlon : point.getPid(), type : obj._type}, KPOInfo));
        }
    }
    else if(type == 'l')
    {
        opts.navorig.latlon = obj.latlons('begin').getPid();
        opts.navdest.latlon = obj.latlons('end').getPid();
        opts.mid = [];
        opts.mid.push(KTools.copyOptions({latlon : point.getPid(), type : KPOIType.DRAGNODE}, KPOInfo));
    }
    else if(type == 'r')
    {
        var preMarker = this._markerArray[idx - 1];
        var nextMarker = this._markerArray[idx + 1];
        opts.navorig.latlon = preMarker.latlon().getPid();
        opts.navorig.name = preMarker.POIName;
        opts.navdest.latlon = nextMarker.latlon().getPid();
        opts.navdest.name = nextMarker.POIName;
    }
    return opts;
};
/**
 * 
 * @param markers
 * @param leave
 * @param idx
 * @param data Object 
 * @param cover Boolean 
 */
KNavsearch.prototype._addLine = function(markers, leave, idx, data, cover)
{
    if(!KMap.isInitialized(this.options().mapcontainer)) return;
    cover = cover || false;
    var line = this._addTmpLine(markers, leave, idx, false, data);
    line.addDirMarkers(line._d.split(','), KTools.copyOptions({}, KDirMarkOptions));
    KEvent.bind(line, 'pathnode_dragstart', this._dragStart, {type : 'l'}, this);
    KEvent.bind(line, 'pathnode_draging', this._draging, {type : 'l'}, this);
    KEvent.bind(line, 'pathnode_dragend', this._draged, {type : 'l'}, this);
    this._insertLine(line, cover);
    return line;
    //this._lineArray.splice(idx, 1, line);
};
/**
 * 
 * @param line
 */
KNavsearch.prototype._insertLine = function(line, cover)
{
    var idx = parseInt(line._idx == undefined ? this._lineArray.length - 1 : line._idx);
    this._lineArray.splice(idx, cover ? 1 : 0, line);
    if(!cover)
    {
        for(var i in this._lineArray)
        {
            if(i > idx)
            {
                this._lineArray[i]._idx = parseInt(this._lineArray[i]._idx) + 1;
            }
        }
    }
};
/**
 * 
 * @param idx Ingeter[]
 */
KNavsearch.prototype._removeLine = function(idx)
{
    for(var i in idx)
    {
        KMap.removeLine(this._lineArray[idx[i]]);
    }
    var tmp = [];
    for(var j = 0; j < this._lineArray.length; j++)
    {
        if($.inArray(j, idx) == -1) tmp.push(this._lineArray[j]);
    }
    this._lineArray = tmp.concat([]);
    for(var k = 0; k < this._lineArray.length; k ++)
    {
        this._lineArray[k]._idx = parseInt(k);
    }
};
/**
 * 
 * @param markers
 * @param leave
 * @param idx
 * @param temp Boolean
 * @pram data Object 
 */
KNavsearch.prototype._addTmpLine = function(markers, leave, idx, temp, data)
{
    var lineopts = KConfig.get(temp ? 'ln_lo_navd' : 'ln_lo_navs');
    lineopts.editable = true;
    lineopts.path = true;
    lineopts.group = KWidgetFlag.navsearch;
    var line = KLine.fromEncoded(markers, leave, lineopts);
    if(data)
    {
        line.time = parseInt(data.f);
        line.distance = parseInt(data.e);
        line._c = data.c;
        line._d = data.d;
        line._h = data.h;
    }
    if(idx != undefined) line._idx = parseInt(idx);
    KMap.addLine(line);

    return line;
};
/**
 * 
 * @param data_b String
 */
KNavsearch.prototype._initAccordion = function(data_b)
{
    var _this = this;
    this._navResultSeletDom.html(data_b);
    var opts = KTools.copyOptions({collapse : true, initexpand : this._LIMITNUM}, KAccordionOptions);
    this._navAccordion = new KAccordion(this._navResultSeletDom.get(0), opts);  //KAccordion
    
    this._getResultByNavType();
    //
    /* delete by zwq 
     * radio
    if(this._navAccordion.tab(0))
    {
        $("input[type='checkbox']", this._navAccordion.tab(0).tabDom)
                .attr('checked', (this._noHightwayCheck ? 'checked' : false)).click(function(e){
            if ($(this).attr("checked"))
                {
                    _this._noHightwayClick = true;
                    _this._noHightwayCheck = true;
                    _this._queryopts.highway = true;
                }
                else
                {
                    _this._noHightwayClick = true;
                    _this._noHightwayCheck = false;
                    _this._queryopts.highway = false;
                }
                e.stopPropagation();
                _this.query(_this._queryopts);
        });
    }
    */
    this._bindDetailHerfEvent();    //
    this._initAccordionIndex();     //Accordionindex
    this._bindResultEvent();    //
    //bug# 201103231628 fix begin
    //add by zhangsq
    !this._noHightwayClick &&this._displayPattern('summary');    //
    //bug# 201103231628 fix end
};
/**
 * Accordionindex
 * @param num Integer
 */
KNavsearch.prototype._initAccordionIndex = function(num)
{
    var _this = this;
    if(num)
    {
        if(typeof num == 'number')
        {
            //var c = $(this._navAccordion.tab(num).contentDom).attr('tIdx', num);
            var c = $('>div>dl', this._navAccordion.dom()).eq(num);
            var oc = $('>div>ol', this._navAccordion.dom()).eq(num);
            $(c).get(0)._line = this._lineArray[num];
            $(oc).get(0)._line = this._lineArray[num];
            $('>dt', c).each(function(i){
                $(this).attr('tIdx', i);
            });
            $('>dd', c).each(function(){
                $('>ul>li', this).each(function(j){
                    $(this).attr('tIdx', j);
                });
            });
            $('>li', oc).each(function(i){
                $(this).attr('tIdx', i);
            });
        }
        else if(num instanceof Array)
        {
            for(var i = 0; i < num.length; i++)
            {
                this._initAccordionIndex(parseInt(num[i]));
            }
        }
    }
    else
    {
        $('>div>dl', this._navAccordion.dom()).each(function(i){
            $(this).get(0)._line = _this._lineArray[i];
            $('>dt', this).each(function(j){
                $(this).attr('tidx', j);
                $('>ul>li',$(this).next('dd')).each(function(k){
                    $(this).attr('tidx', k);
                });
            });
        });
        $('>div>ol', this._navAccordion.dom()).each(function(i){
            $(this).get(0)._line = _this._lineArray[i];
            $('>li', this).each(function(j){
                $(this).attr('tidx', j);
            });
        });
    }
};
/**
 * 
 * @param idxs
 * @param unbind
 */
KNavsearch.prototype._volumeBindDetailHerfEvent = function(idxs, unbind)
{
    for(var i = 0; i < idxs.length; i++)
    {
        this._bindDetailHerfEvent(parseInt(idxs[i]), unbind);
    }
};
/**
 * 
 * @param num Integer
 * @param unbind Boolean 
 */
KNavsearch.prototype._bindDetailHerfEvent = function(num, unbind)
{
    var _this = this;
    //var container = num ? this._navAccordion.tabs(num).contentDom : this._navAccordion.dom();
    //var container = num ? $('>div>dt', this._navAccordion.dom()).eq(num) : this._navAccordion.dom();
    var _href = $('>div>dl' + (num != undefined ? ':eq(' + num + ')' : '') + '>dt>p>a', this._navAccordion.dom()).unbind('click');
    if(!unbind)
    {
        _href.click(function(e){
            e.stopPropagation();
            var content = $(this).parent().parent().next();
            content.is(':visible') ? content.hide() : content.show();
            $(this).removeClass().addClass(_this._getClassName(content.is(':visible') ? 'SDO' : 'SDC'))
                    .html('<span></span>' + (content.is(':visible') ? '' : ''));
        });
    }
};
/**
 * 
 * @param idxs
 * @param unbind
 */
KNavsearch.prototype._volumeBindResultEvent = function(idxs, unbind)
{
    for(var i = 0; i < idxs.length; i++)
    {
        this._bindResultEvent(parseInt(idxs[i]), unbind);
    }
};
/**
 * 
 * @param num
 * @param unbind Boolean 
 */
KNavsearch.prototype._bindResultEvent = function(num, unbind)
{
    var _this = this;
    //var container = num ? this._navAccordion.tabs(num).contentDom : this._navAccordion.dom();
    var container = this._navAccordion.dom();
    var _hstyle = this._getClassName('SRH');
    var _dt = $('>div>dl' + (num != undefined ? ':eq(' + num + ')' : '') + '>dt', container).unbind('hover').unbind('click');    //DT
    var _uli = $('>div>dl' + (num != undefined ? ':eq(' + num + ')' : '') + '>dd>ul>li', container).unbind('hover').unbind('click');   //LI
    var _oli = $('>div>ol' + (num != undefined ? ':eq(' + num + ')' : '') + '>li', container).unbind('hover').unbind('click');   //LI
    if(!unbind)
    {
        //DT
        _dt.hover(function(){
                _this._hiliteLine('s', $(this).parent().get(0)._line, parseInt($(this).attr('tIdx')));
                $(this).addClass(_hstyle);
        },
        function(){
            _this._resumeLine($(this).parent().get(0)._line);
            $(this).removeClass(_hstyle);
        }).bind('click', function(){
            _this._showInfoWindow(this, $('>p', this).html().replace(/<a[\s\S]*?<\/a>/gi, ''), 's', $(this).parent().get(0)._line, parseInt($(this).attr('tIdx')));
        });
        //LI
        _uli.hover(function(){
            _this._hiliteLine('s', $(this).parent().parent().parent().get(0)._line, parseInt($(this).parent().parent().prev().attr('tIdx')), parseInt($(this).attr('tIdx')));
            $(this).addClass(_hstyle);
        },
        function(){
            _this._resumeLine($(this).parent().parent().parent().get(0)._line);
            $(this).removeClass(_hstyle);
        }).bind('click', function(){
            _this._showInfoWindow(this, $('>p', this).html(), 's', $(this).parent().parent().parent().get(0)._line, parseInt($(this).parent().parent().prev().attr('tIdx')), parseInt($(this).attr('tIdx')));
        });
        //LI
        _oli.hover(function(){
            _this._hiliteLine('d', $(this).parent().get(0)._line, parseInt($(this).attr('tIdx')));
            $(this).addClass(_hstyle);
        },
        function(){
            $(this).removeClass(_hstyle);
            _this._resumeLine($(this).parent().get(0)._line);
        }).bind('click', function(){
            _this._showInfoWindow(this, $('>p', this).html(), 'd', $(this).parent().get(0)._line, parseInt($(this).attr('tIdx')));
        });
    }
};
/**
 * 
 * @param type String  's'  s -   d - 
 * @param line KLine 
 * @param tidx Integer /
 * @param lidx Integer 
 */
KNavsearch.prototype._hiliteLine = function(type, line, tidx, lidx)
{
    var se = this._getStartAndEnd(type, line, tidx, lidx);
    line.hilite(se.start, se.end);
    return se;
};
/**
 * 
 * @param line KLine 
 */
KNavsearch.prototype._resumeLine = function(line)
{
    if(line == undefined) line = this._lineArray;
    if(line instanceof Array)
    {
        for(var i = 0; i < line.length; i++)
        {
            this._resumeLine(line[i]);
        }
    }
    else
    {
        line.resume();
    }
};
/**
 * 
 * @param type String 's'  s -   d - 
 * @param line KLine 
 * @param tidx Integer  /
 * @param lidx Integer 
 */
KNavsearch.prototype._getStartAndEnd = function(type, line, tidx, lidx)
{
    var d = line._d.split(',');
    var h = line._h.split(',');
    var c = line._c.split(',');

    var result = {start : undefined, end : undefined};
    if(lidx != undefined)
    {
        var tmp = h[tidx].replace(/'/g, '').split('-');
        result.start = parseInt(tmp[0]) == 0 ? 0 : (parseInt(d[parseInt(tmp[0]) + lidx]));
        result.end = (parseInt(tmp[0]) + lidx + 1) == d.length ? parseInt(c[1]) : (parseInt(d[parseInt(tmp[0]) + lidx + 1]));
    }
    else
    {
        if(type == 's')
        {
            result.start = tidx == 0 ? 0 : (parseInt(d[parseInt(h[tidx == 0 ? 0 : (tidx - 1)].split('-')[1]) + 1]));
            result.end = tidx == h.length - 1 ? parseInt(c[1]) : parseInt(d[parseInt(h[tidx].split('-')[1]) + 1]);
        }
        else if(type == 'd')
        {
            result.start = tidx == 0 ? 0 : parseInt(d[tidx]);
            result.end = tidx == d.length - 1 ? parseInt(c[1]) : parseInt(d[tidx + 1]);
        }
    }
    return result;
};
/**
 * 
 * @param data
 */
KNavsearch.prototype._parseResult = function(data)
{
    if(data.a)
    {
        for(var i in data.a)
        {
            data.a[i].h = data.a[i].h.replace(/(')(\d+)(')/g, '$1$2-$2$3');
        }
    }
    this._result = data;
};
/**
 * 
 */
KNavsearch.prototype._updateCo2ShowDom = function()
{
    if (this._result.e)
    {
        var data_e = this._result.e;
        this._navCo2Content.html(data_e.f);
        this._navCo2ShowDistance.html((this._getTimeAndDistance().d / 1000).toFixed(2));
        $(">strong", $(">li[mfg='bscmoto']", this._navCo2ShowUI)).html(data_e.a);
        $(">strong", $(">li[mfg='bscebk']", this._navCo2ShowUI)).html(data_e.b);
        $(">strong", $(">li[mfg='bsctram']", this._navCo2ShowUI)).html(data_e.c);
        $(">strong", $(">li[mfg='bscbus']", this._navCo2ShowUI)).html(data_e.d);
        $(">strong", $(">li[mfg='bscsbw']", this._navCo2ShowUI)).html(data_e.e);
        $(">strong", $(">li[mfg='bsccar']", this._navCo2ShowUI)).html(data_e.f);
        $(">strong", $(">li[mfg='bsccoach']", this._navCo2ShowUI)).html(data_e.g);
        $(">strong", $(">li[mfg='bsctrain']", this._navCo2ShowUI)).html(data_e.h);
        $(">strong", $(">li[mfg='bscplain']", this._navCo2ShowUI)).html(data_e.i);
    }
};
/**
 * 
 */
KNavsearch.prototype._updateTaxiFare = function()
{
    this._navTaxiFareDom.html(this._result.taxi);
};
/**
 * stationlist
 * @param evt
 * @param w
 * @param q
 */
KNavsearch.prototype._navEnterSearch = function(evt, w, q)
{
    this._queryopts.navdest = q.dest;
    this._queryopts.navorig = q.orig;
    this._navStationList.clearMarkers(); //
    this._syncSearchbox(); //Searchbox
    this._innerQuery = true;
    this.query(this._queryopts);
};
/**
 *
 * @param queryots
 */
KNavsearch.prototype._gethash = function(queryots)
{
	var hashArray = [];
	hashArray.push(queryots.navorig.latlon + this._splitN + (queryots.navorig.name ? queryots.navorig.name : ""));
	if (queryots.mid) {
		for ( var i = 0; i < queryots.mid.length; i++) {
			hashArray.push((queryots.mid[i].type ? queryots.mid[i].type : KPOIType.DRAGNODE) + this._splitN
					+ queryots.mid[i].latlon + this._splitN + (queryots.mid[i].name ? queryots.mid[i].name : ""));
		}
	}
	hashArray.push(queryots.navdest.latlon + this._splitN + (queryots.navdest.name ? queryots.navdest.name : ""));
	return hashArray.join(this._split);
};
/**
 * 
 */
KNavsearch.prototype._getMapletOption = function()
{
    if (this.options().mapcontainer)
    {
        return '&h=' + $(this.options().mapcontainer).outerHeight() + '&w=' + $(this.options().mapcontainer).outerWidth() + '&z=' + KMap.zoom();
    }
    return "&h=" + 1084 + "&w=" + 502 + "&z=8";
};
/**
 * requestname
 * @param name
 */
KNavsearch.prototype._getRequestParam = function(name)
{
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
    var r = this._getMapletOption().substr(this._getMapletOption().indexOf("\?") + 1).match(reg);
    if (r != null) return r[2];
    return null;
};
/**
 * hash
 * @param strUrl String
 */
KNavsearch.prototype._setQueryOptions = function(strUrl)
{
    var UrlArray = strUrl.split(this._split);
    var length = UrlArray.length;
    var origArray = UrlArray[0].split(this._splitN);
    var destArray = UrlArray[length - 1].split(this._splitN);
    var midArray = [];
    for (var i = 1; i < length - 1; i++)
    {
        var tempArray = UrlArray[i].split(this._splitN);
        midArray.push(KTools.copyOptions({name : tempArray[2], latlon : tempArray[1], type : tempArray[0]}, KPOInfo));
        //this._DRAGNUM = this._DRAGNUM + 1;//
    }
    return  KTools.copyOptions({mid : midArray, type : KQueryType.navsearch, navorig : KTools.copyOptions({name : origArray[1], latlon : origArray[0]}, KPOInfo), navdest : KTools.copyOptions({name : destArray[1], latlon : destArray[0]}, KPOInfo)}, KQueryOptions);
};
/**
 * 
 * @param streetDistance
 */
KNavsearch.prototype._convertDistance = function(streetDistance)
{
    var distance = streetDistance > 1000 ? (streetDistance / 1000).toFixed(2) + "" : parseInt(streetDistance) + "";
    return distance == 'NaN'  || distance == 'NaN' ? '' : distance;
};
/**
 *   sec : 
 * @param sec
 */
KNavsearch.prototype._convertTime = function(sec) {
    if (sec < 60) {
        return  sec + "";
    }
    var times = Math.round(sec / 60); //minute
    if (times > 60) {
        var h = parseInt(times / 60);
        var d = times % 60;
        return h + "" + d + "";
    }
    return times + "";
};
/**
 * InfoWindow
 * @param node Node 
 * @param content String 
 * @param type String  's'  s -   d - 
 * @param line KLine 
 * @param tidx Integer /
 * @param lidx Integer 
 */
KNavsearch.prototype._showInfoWindow = function(node, content, type, line, tidx, lidx)
{
    if(KMap.isInitialized(this.options().mapcontainer)) //
    {
        this._resumeLine(); //
        var se = this._hiliteLine(type, line, tidx, lidx);  //
        var center = line.latlons()[se.start]; //
        KMap.setCenter(center, 13); //
        var iwopts = KConfig.get('iw_iwo_wk', {t : content});//InfoWindow
        //err# 201103311612 fix begin
        //delete by zhangsq
        //KEvent.unbind(KMap, 'afteropeninfowindow', this._openedInfoWindow);
        //err# 201103311612 fix end
        KEvent.bind(KMap, 'afteropeninfowindow', this._openedInfoWindow, {opentype : KQueryType.navsearch, intedata : {type : type, line : line, se : se, node : node}}, this);    //afteropeninfowindow
        KMap.openInfoWindow(center, iwopts);
    }
};
/**
 * InfoWindow
 * @param eventinfo KEventInfo
 * @param container Node 
 * @param overlay KOverlay 
 */
KNavsearch.prototype._openedInfoWindow = function(eventinfo, container, overlay)
{
    if(eventinfo.data.opentype == KQueryType.navsearch)
    {
        //err# 201103311612 fix begin
        //add by zhangsq
        KEvent.unbind(KMap, 'afteropeninfowindow', this._openedInfoWindow);
        //err# 201103311612 fix end
        var line = eventinfo.data.intedata.line;
        var se = eventinfo.data.intedata.se;
        //Loadding
        /*this._loadding = new Image();
        this._loadding.src = '/loadding.gif';*/
        this._bindInfowinEvent(eventinfo.data, overlay);    //
        this._setSnapshot(line.latlons()[se.start], overlay);    //
    }
};
/**
 * InfoWindow
 * @param latlon MPoint 
 * @param infowin KOverlay
 */
KNavsearch.prototype._setSnapshot = function(latlon, infowin)
{
    var img = $('img[mfg="pic"]', infowin.iwcDom()).eq(0); //
    //img.attr('src', this._loadding.src).show(); //Loadding
    var icontainer = img.parent(); //
    var width = icontainer.width();
    var height = icontainer.height();
    var isize = new KSize(width, height); //
    KMap.snapshot({latlon : latlon, size : isize, zoom : 13, oncomplete : {fun : function(){
        img.attr('src', arguments[1]).show();
    }}});
};
/**
 * Infowindow
 * @param data Object 
 * @param infowin KOverlay
 */
KNavsearch.prototype._bindInfowinEvent = function(data, infowin)
{
    var _this = this;
    var prevNode = this._getNearNode('prev', data.intedata.node);
    var nextNode = this._getNearNode('next', data.intedata.node);
    var prev = $('>div>div>a[mfg="prev"]', infowin.iwcDom()).css({display : prevNode ? '' : 'none'}).unbind('click').bind('click', function(){
        _this._openInfoWindow(data.intedata.node, prevNode);
    });
    var next = $('>div>div>a[mfg="next"]', infowin.iwcDom()).css({display : nextNode ? '' : 'none'}).unbind('click').bind('click', function(){
        _this._openInfoWindow(data.intedata.node, nextNode);
    });
};
/**
 * 
 * @param flag String prev   next 
 * @param node Node 
 * @return Node 
 */
KNavsearch.prototype._getNearNode = function(flag, node)
{
    var noteType = this._getTagName(node);
    var parentType = this._getTagName($(node).parent());
    var result = undefined;
    var _idx = undefined;
    var tmp = undefined;
    var _childStr = flag == 'prev' ? 'last-child' : 'first-child';
    if(parentType == 'ol')  //
    {
        result = flag == 'prev' ? $(node).prev().get(0) : (flag == 'next' ? $(node).next().get(0) : undefined); //
        if(result == undefined) //
        {
            _idx = parseInt($(node).parent().get(0)._line._idx); //
            if((flag == 'prev' && _idx == 0) || (flag == 'next' && _idx == this._lineArray.length - 1))
            {
                result = undefined;
            }
            else
            {
                result = $('>li:' + _childStr, $('>div>ol', this._navAccordion.dom()).eq(flag == 'prev' ? _idx - 1 : _idx + 1)).get(0);
            }
        }
    }
    else if(parentType == 'ul') //
    {
        result = flag == 'prev' ? $(node).prev().get(0) : (flag == 'next' ? $(node).next().get(0) : undefined); //
        if(result == undefined) //
        {
            var _dd = $(node).parent().parent();
            var _dt = _dd.prev();
            _idx = parseInt(_dt.parent().get(0)._line._idx);//
            if((flag == 'prev' && (_dt.prevAll("dt").get(0) == undefined) && _idx == 0) || (flag == 'next' && (_dt.nextAll("dt").get(0) == undefined) && _idx == this._lineArray.length - 1))
            {
                result = undefined;
            }
            else
            {
                tmp = flag == 'prev' ? _dt.prev() : _dd.next();
                tmp = tmp.get(0) ? tmp : $('>dt:' + _childStr, $('>div>dl', this._navAccordion.dom()).eq(flag == 'prev' ? _idx - 1 : _idx + 1));
                result = this._getTagName(tmp) == 'dd' ? ($('>ul>li:' + _childStr, tmp).get(0)) : (tmp.next().get(0) && this._getTagName(tmp.next()) == 'dd' ? $('>ul>li:' + _childStr, tmp.next()).get(0) : tmp.get(0));
            }
        }
    }
    else if(parentType == 'dl') //
    {
        result = flag == 'prev' ? $(node).prev().get(0) : $(node).next().get(0); //
        if(result == undefined) //
        {
            _idx = parseInt($(node).parent().get(0)._line._idx);
            if((flag == 'prev' && _idx == 0) || (flag == 'next' && _idx == this._lineArray.length - 1))
            {
                result = undefined;
            }
            else
            {
                tmp = $('>dt', $('>div>dl', this._navAccordion.dom()).eq(flag == 'prev' ? _idx - 1 : _idx + 1));
                tmp = flag == 'prev' ? tmp.last() : tmp.first();
                result = tmp.next().get(0) && this._getTagName(tmp.next()) == 'dd' ? ($('>ul>li:' + _childStr, tmp.next()).get(0)) : tmp.get(0);
            }
        }
        if(result != undefined)
        {
            result = this._getTagName(result) == 'dd' ? ($('>ul>li:' + _childStr, result).get(0)) : ($(result).next().get(0) && this._getTagName($(result).next()) == 'dd' ? ($('>ul>li:' + _childStr, $(result).next()).get(0)) : result);
        }
    }
    return result;
};
/**
 * 
 * @param node Node
 * @return String 
 */
KNavsearch.prototype._getTagName = function(node)
{
    return $(node).get(0).tagName.toLowerCase();
};
/**
 * InfoWindow
 * @param prevNode Node InfoWindow
 * @param node Node InfoWindow
 */
KNavsearch.prototype._openInfoWindow = function(prevNode, node)
{
    if(!node) return;
    var tag = this._getTagName($(node).parent());
    var parent = tag == 'ul' ? $(node).parent().parent().parent() : $(node).parent();
    var type = tag == 'ul' || tag == 'dl' ? 's' : 'd';
    var tidx = tag == 'ul' ? parseInt($(node).parent().parent().prev().attr('tIdx')) : parseInt($(node).attr('tIdx'));
    var lidx = tag == 'ul' ? parseInt($(node).attr('tIdx')) : undefined;
    this._hiliteDes(prevNode, node);    //
    this._showInfoWindow(node, $('>p', node).html(), type, parent.get(0)._line, tidx, lidx);
};
/**
 * 
 */
KNavsearch.prototype._hiliteDes = function(prevNode, node)
{
    if(!node) return;
    var tag = this._getTagName($(node).parent());
    var parent = tag == 'ul' ? $(node).parent().parent().parent() : $(node).parent();
    var div = parent.parent();
    var tabidx = 0;
    var cla = this._getClassName('SRH');
    KTools.scrollIntoView(node, $(this._navAccordion.dom()).parent().parent().get(0));
    //Tab
    $('>div', this._navAccordion.dom()).each(function(i){
        if(this == div.get(0)) tabidx = i;
    });
    //if(div.is(':hidden')) this._navAccordion.select(tabidx);    //
    this._triggerAccordionTab(tabidx);  //
    if(tag == 'ul')
    {
        var content = $(node).parent().parent();
        content.show();
        $('>p>a', content.prev()).removeClass().addClass(this._getClassName('SDO')).html('<span></span>');
    }
    $(node).addClass(cla);
    $(prevNode).removeClass(cla);
};
/**
 * Tab
 * @param tidx Integer[]/Integer
 * @param action Boolean true    false   true
 */
KNavsearch.prototype._triggerAccordionTab = function(tidx, action)
{
    action = action == undefined ? true :action;
    if(tidx instanceof Array)
    {
        for(var i in tidx)
        {
            this._triggerAccordionTab(parseInt(tidx[i]), action);
        }
    }
    else if(typeof tidx == 'number')
    {
        if($(this._navAccordion.tab(tidx).contentDom).is(action ? ':hidden' : ':visible')) this._navAccordion.select(tidx);
    }
};
/**
 * 
 * @param flag String b    a 
 * @return Boolean
 */
KNavsearch.prototype._chkSupport = function(flag)
{
    if(flag == 'a')
    {
        return (this._getTimeAndDistance().d > 500000 ? true : false);
    }
    else if(flag == 'b')
    {
        var city = undefined;
        for(var i in this._markerArray)
        {
            city = city ? city : this._markerArray[i]._city;
            if(city != this._markerArray[i]._city) return false;
        }
        return true;
    }
    return false;
};
/**
 *  added by zwq 
 * @param 
 * @return 
 */
KNavsearch.prototype._getResultByNavType = function()
{
	var _this = this;
	$(">input", this._navTypeDom).eq(0).unbind("click").click(function(e) {
		_this._navTypeCheck = 0;
		_this._navTypeByEMail = 0;
		_this._navPrintByType = 0;
		_this.query(_this._queryopts);
	});
	
	$(">input", this._navTypeDom).eq(1).unbind("click").click(function(e) {
		_this._navTypeCheck = 1;
		_this._navTypeByEMail = 1;
		_this._navPrintByType = 1;
		_this.query(_this._queryopts);
	});
	
	$(">input", this._navTypeDom).eq(2).unbind("click").click(function(e) {
		_this._navTypeCheck = 2;
		_this._navTypeByEMail = 2;
		_this._navPrintByType = 2;
		_this.query(_this._queryopts);
	});
	
}
/**
 * 
 * @param flag
 * @param latlon
 * @param name
 * @param city
 * @param idx
 * @uncrunch
 */
KNavsearch.prototype.menuaddMarker = function(flag, latlon, name, city, idx)
{
    if(!KMap.isInitialized(this.options().mapcontainer)) return;
    if(KMap.getLines().length === 0){
		KMap.clearMarker("bs_search_s");
	}
    name = (!name) || name == '' ? '' : name;

    if (flag === 's') {
        this.menuSmarker && KMap.removeMarker(this.menuSmarker);
    } else {
        this.menuEmarker && KMap.removeMarker(this.menuEmarker);
    }
    if(!$(this._navstationListDom).is(":hidden")){
        this._navStationList._dragEndMarker({data:flag},null,new MPoint(latlon),name);
    }else{
        this._addMarker(flag,latlon,name, city, idx);
    }
    if(this.menuSmarker && this.menuEmarker){
    	var opts = KTools.copyOptions({type : KQueryType.navsearch, highway : 0, navorig : KTools.copyOptions({}, KPOInfo), navdest : KTools.copyOptions({}, KPOInfo)}, KQueryOptions);
	    opts.navorig.latlon = this.menuSmarker._point.getPid();

	    if(flag === "s"){
	    	opts.navorig.name = name;
	    }else{
	    	opts.navorig.name = this.menuSmarker.POIName;
	    }
	    opts.navorig.type = KPOIType.NORMAL;
	    opts.navorig.city = this.menuSmarker._city;

	    opts.navdest.latlon = this.menuEmarker._point.getPid();

	    if(flag === "e"){
	    	opts.navdest.name = name;
	    }else{
	    	opts.navdest.name =  this.menuEmarker.POIName;
	    }

	    opts.navdest.city =  this.menuEmarker._city;

	    opts.navdest.type = KPOIType.NORMAL;
	    this._queryopts = opts;
	    this.query(this._queryopts);
	    
    }
};
/**
 * 
 * @param type
 * @returns {{s: *, e: *}}
 * @uncrunch
 */
KNavsearch.prototype.getStartAndEnd = function(type){
    this.menuSmarker && (this.menuSmarker.city = this.menuSmarker._city);
    this.menuEmarker && (this.menuEmarker.city = this.menuEmarker._city);
    return {s:this.menuSmarker,e:this.menuEmarker}
};
/**
 * 
 * @param type
 * @returns {{s: *, e: *}}
 * @uncrunch
 */
KNavsearch.prototype.removeStartAndEnd = function(type){
    KMap.clear(KWidgetFlag.navsearch);
    this.menuSmarker = null;
    this.menuEmarker = null;
};

/**
 * 
 * @param type {String} trans, "busline","bustation", "all"
 * @return
 */
KNavsearch.prototype._clearAllOverlay = function(type){
	if(this._hLine){
		this._hLine.resume();
		this._hLine = undefined;
	}
    var flag = 'bs';
    var types = {
        trans: "_search_s,_search_l,_search_l_w,_search_s_all,_hoverlines",
        busline: "_line,_line_s,_line_e",
        bustation: "_station1,_station2"
    };
    types.all = types.trans + "," + types.busline + "," + types.bustation;
    var groups = (types[type || "all"] || types.all).split(",");
    $.each(groups, function(index, value){
        KMap.clear(flag + value);
    });
};

/*
 
 xionggq  fuyg
 1.0.8
 2010-02-24
 2010-02-24 15:40
 ============================================
 
 opt#   1006291032
 "tabchanged"
 
opt# 1006291318 
 "secondcatchanged"

bug# 1006301022
dependentJQueryjQuery

opt# 1006301645
_getCurrQueryOptsifinputValue

opt# 1010261200


opt# 1011241025
(KSearchboxOptions.check)
opt#1011301329
value
bug#1011301338
cookiebug
bug#1011301912
bug
opt#201012061514
KSearchbox.defaultdemo
bug#201012201357
Enterie
bug#201012211654
KSearchbox.defaultdemobug
opt#201012222032
txtlendemos
opt#201012271855
1.demohint
2.

 */
var KSearchbox = KClass.create("KSearchbox", KWidget);

KSearchbox.conf =
{
    CLASSNAME :
    {
        //
        SHX : "_shx"
        //
        ,SWO: "_shx_swo"
        //
        ,SWD: "_shx_swd"
        //
        ,TIP : "_shx_tip"
        //
        ,SMT : "_shx_smt"
        ,GRAY : "_shx_gray"
    }
};
/**
 * 
 * @param container
 * @param opts
 */
KSearchbox.initialize = function(container, opts)
{
    var _this = this;
    this._dom = $(container).get(0);
    this._domAll = $(container);
    this._opts = KTools.copyOptions(opts, KSearchboxOptions);
    this._oldOpts = this._opts.theme;
    this.setTheme(this.options().theme);
    this._currentItem = null;
    this._secondHeader = null;
    this._tipContentHeader = null;
    this._busSecondTabs = null;
    this._lcCityList = null;
    this._busChangeCityList = null;
    this._busLineCityList = null;
    this._busStationCityList = null;
    this._tipContentItems = [];
    this._queryOptions = KTools.copyOptions({},KQueryOptions);
    //
    this._demoSum = {
		ls : 10,// 
		bl : 10,// 
		bz : 10,// 
		bo : 10,// 
		no : 10,// 
		zc : 10// 
	};
    if (opts.demos) {
		for ( var i in opts.demos) {
			var sum = opts.demos[i];
			if (typeof sum == "number" && sum > -1) {
				this._demoSum[i] = sum;
			}
		}
	}
    //
    this._demohint = (opts.demohint || ",").split(",");
	//
    //this._supportDefaultDemo();
    //
    this._navorigCity = undefined;
    this._navdestCity = undefined;
    this._domAll.addClass(this.options().theme + "_shx");
    this._firstHeader = $(">div", this._domAll).eq(0);
    //
    this._tipContentHeader = $(">div", this._domAll).eq(1);
    if(this._tipContentHeader.length){
    	this._tipContentHeader.addClass(this.options().theme+KSearchbox.conf.CLASSNAME.TIP);
    }
  
    this._mfgArray = ["ls","bl","bz","bo","bd","no","nd","zc","zk"];
    this._tipArray = ["","","","","","","","",""];
    
    //
    this._zkInputTip = ["","","","KTV","","","ATM"];
    if (opts.hints) {
		var i = -1;
		for ( var hint in opts.hints) {
			i = this._indexArray(this._mfgArray, hint);
			if (i > -1) {
				this._tipArray[i] = opts.hints[hint];
			}
			i = -1;
		}
	}
    var enterKeyHandler = function(event){
    	if($.browser.msie){
    		if(event.keyCode===13){
    			event.preventDefault();
    			$(this.form).trigger("submit");
    		}
    	}
    };
    this._lsInputDom = $("input[mfg='ls']", this._domAll);
    this._blInputDom = $("input[mfg='bl']", this._domAll);
    this._bzInputDom = $("input[mfg='bz']", this._domAll);
    this._boInputDom = $("input[mfg='bo']", this._domAll).bind("keyup", enterKeyHandler);
    this._bdInputDom = $("input[mfg='bd']", this._domAll).bind("keyup", enterKeyHandler);
    this._noInputDom = $("input[mfg='no']", this._domAll).bind("keyup", enterKeyHandler);
    this._ndInputDom = $("input[mfg='nd']", this._domAll).bind("keyup", enterKeyHandler);
    this._zcInputDom = $("input[mfg='zc']", this._domAll).bind("keyup", enterKeyHandler);
    this._zkInputDom = $("input[mfg='zk']", this._domAll).bind("keyup", enterKeyHandler);
    
    this._lsbimg = $("input[mfg='lsb']", this._domAll);
    this._blbimg = $("input[mfg='blb']", this._domAll);
    this._bzbimg = $("input[mfg='bzb']", this._domAll);
    this._bsbimg = $("input[mfg='bsb']", this._domAll);
    this._nsbimg = $("input[mfg='nsb']", this._domAll);
    this._zsbimg = $("input[mfg='zsb']", this._domAll);
    this._imgArray = [this._lsbimg,this._blbimg,this._bzbimg,this._bsbimg,this._nsbimg,this._zsbimg];

    
    //false--
    this._lsFlag = false;
    this._bsFlag = false;
    this._blFlag = false;
    this._bstFlag = false;
    this._navsFlag = false;
    this._nsFlag = false;
    
    
    this._input = {};
    this._inputSuggestArray = [];
    //
    this._firstTabs = new KStdTabs(this._firstHeader);
	/*****************************************/ 
    var firstTabItems = this._firstTabs.tabs();
    this._lsTabIndex = this._bsTabIndex = this._navsTabIndex = this._nsTabIndex = undefined; 
    $.each(firstTabItems, function(index, item) {
		switch (item.kvalue) {
			case "ls":
				_this._lsTabItem = item;
				break;
			case "bs":
				_this._bsTabItem = item;
				break;
			case "navs":
				_this._navsTabItem = item;
				break;
			case "ns":
				_this._nsTabItem = item;
				break;
		}
	});
    //
    var $contentDiv; 
    if(this._lsTabItem){
    	$contentDiv = $(this._lsTabItem.contentDom);
    	this._lcCityDom = $(">form>div", $contentDiv);
    }
    if (this._bsTabItem) {
    	$contentDiv = $(this._bsTabItem.contentDom);
		this._busChangeCityListDom = $("form>div", $contentDiv).eq(0);
		this._busChangeADom = $("form>span a", $contentDiv).eq(0);
		this._busLineCityListDom = $("form>div", $contentDiv).eq(1);
		this._busStationCityListDom = $("form>div", $contentDiv).eq(2);
		this._busSecondHeaderDom = $(">div", $contentDiv);
		this._busChangeIDomArray = $(">ul input", this._busSecondHeaderDom);
		// Atabindex="-1"
		this._busChangeADom.attr("tabindex", "-1");
		this._busChangeADom.click(function(e) {
			_this._swapFg("bo", "bd", $(this));
		});
	}
    //
    if (this._navsTabItem) {
    	$contentDiv = $(this._navsTabItem.contentDom);
		this._navChangeADom = $("form>span a", $contentDiv).eq(0).addClass(this.options().theme+KSearchbox.conf.CLASSNAME.SWO);
		this._navChangeADom.attr("tabindex", "-1").click(function(){
			_this._swapFg("no", "nd", $(this));
		});
	}
    //
    if (this._nsTabItem) {
    	$contentDiv = $(this._nsTabItem.contentDom);
		this._nbCityListDom = $("form>div", $contentDiv).eq(0);
	}
    
    
    /****************************************/
    this._initInputFg();
    //
	KEvent.bind(_this._firstTabs, "selected", function(eventinfo, widget, oldItem, currentItem) {
		_this._setSuggestEventHandle();
		 switch (currentItem.kvalue)
		    {
		        case 'bs':
		        case 'navs': _this._setnavbusValue(); break;
		        case 'ns': _this._setzkValue(); break;
		    }
		_this._updateDemos(currentItem.kvalue);
		// opt# 2010-6-29 trigger "tabchanged" event
		KEvent.trigger(_this, "tabchanged", _this, _this.tab(), _this.secondcat());
	});
	KEvent.bind(_this._firstTabs, "funtab", function(eventinfo, widget, tabitem) {
		KEvent.trigger(_this, "funtab", _this, tabitem);
	});

    $("form", _this._domAll).each(function() {
		$(this).submit(function(e) {
			e.preventDefault();
			if (_this._checkGrayImg()) {
				// e.stopPropagation();
				_this._submitQuery();
			}
		});
	});


    this._LCOOKIE = 10;
    this._CSPLIT = ",";
    //
    this._mfgInputSelect();
    this._updateThemeOptions();
    this._updateInputSuggestUrl();
    this._updateDemopos();
    this._updateDemolist();
    this._updateCitylist();
    this._suggestFun({data:{dom:this._lsInputDom,num:0}});
    this._updateSuggest();
    this._updateDemos(firstTabItems[0].kvalue);
    
};
/***********************************************************************************************************************
 * KObject
 **********************************************************************************************************************/
/**
 * 
 * @uncrunch
 */
KSearchbox.prototype.finalize = function()
{
    var _this = this;
    //finalize KStdTabs Object(s)
    if(_this._busSecondTabs&&_this._busSecondTabs.finalize){
    	_this._busSecondTabs.finalize();
    }
    if(_this._firstTabs&&_this._firstTabs.finalize){
    	_this._firstTabs.finalize();
    }
    //finalize KStdSuggest Object(s)
    if(_this._inputSuggestArray){
    	var i=0, temp=null;
    	//finalize KStdSuggeest object
    	for(i=_this._inputSuggestArray.length-1;i>=0;i--){
    		temp=_this._inputSuggestArray[i];
    		if(temp&&temp.finalize){
    			temp.finalize();
    		}
    	}
    	//
    	delete _this._inputSuggestArray;
    }
    //finalize KCityList Object(s)
   if(_this._nbCityList&&_this._nbCityList.finalize){
    	_this._nbCityList.finalize();
    } 
    if (_this._busStationCityList && _this._busStationCityList.finalize) {
    	 _this._busStationCityList.finalize();
	}
	if (_this._busLineCityList && _this._busLineCityList.finalize) {
		 _this._busLineCityList.finalize();
	}
	if (_this._busChangeCityList && _this._busChangeCityList.finalize) {
		 _this._busChangeCityList.finalize();
	}
	if (_this._lcCityList && _this._lcCityList.finalize) {
		 _this._lcCityList.finalize();
	}
    //
    KEvent.clear(_this._busChangeADom);
    KEvent.clear(_this._navChangeADom);
    $("form", _this._domAll).each(function()
    {
        KEvent.clear($(this));
    });
    KWidget.prototype.finalize.call(this);

};


/***********************************************************************************************************************
 * KWidget
 **********************************************************************************************************************/
/**
 * 
 * @return String
 * @uncrunch
 */
KSearchbox.prototype.cnname = function()
{
    return "";
};
/**
 * 
 * @return String 
 * @uncrunch
 */
KSearchbox.prototype.version = function()
{
    return "1.0.8";
};
/**
 * 
 *  @uncrunch
 */
KSearchbox.prototype.flag = function()
{
    return "searchbox";
};
/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KSearchbox.prototype.dependent = function()
{
   return [ KCityInfo, KCityList, KClass, KEvent, KManager, KObject, KPOInfo, KPosition, KQuery, KQueryOptions,
			KQueryType, KSearchboxOptions, KStdSuggeest, KStdSuggest, KStdTabs, KTools, KUrlHash, KWidget, KWidgetFlag,
			jQuery ];
};
/**
 * 
 * @param opt
 * @uncrunch
 */
KSearchbox.prototype.setOptions = function(opt)
{

    this._setOptions(opt);
};
/**
 *     
 * @uncrunch
 */
KSearchbox.prototype.setTheme = function(scheme)
{
    var newTheme = {"theme":scheme};
    this._setOptions(newTheme);
};
///**
// * 
// * @uncrunch
// */
//KSearchbox.prototype.layout = function()
//{
//
//};
///**
// *  Dom 
// * @uncrunch
// */
//KSearchbox.prototype.dom = function()
//{
//    return this._domAll;
//};
/***********************************************************************************************************************
 * 
 **********************************************************************************************************************/
/**
 *   types 
 * @overwrite
 * @uncrunch
 */
KSearchbox.prototype.disableQuery = function(type) {
	if (typeof type == "undefined") {
		var length = this._imgArray.length;
		for ( var i = 0; i < length; i++) {
			this._setGrayImg(this._imgArray[i]);
		}
	} else {
		var length = type.length;
		for ( var i = 0; i < length; i++) {
			var domlength = this._getImgDom(type[i]).length;
			for ( var j = 0; j < domlength; j++) {
				this._setGrayImg(this._getImgDom(type[i])[j]);
			}
		}
	}
};
/**
 *  types 
 * 
 * @overwrite
 * @uncrunch
 */
KSearchbox.prototype.enableQuery = function(type) {
	if (typeof type == "undefined") {
		var length = this._imgArray.length;
		for ( var i = 0; i < length; i++) {
			this._setbackImg(this._imgArray[i]);
		}
	} else {
		var length = type.length;
		for ( var i = 0; i < length; i++) {
			var domlength = this._getImgDom(type[i]).length;
			for ( var j = 0; j < domlength; j++) {
				this._setbackImg(this._getImgDom(type[i])[j]);
			}
		}
	}
};
/**
 * 
 * 
 * @uncrunch
 */
KSearchbox.prototype.secondcat = function() {
	if (this.tab().kvalue == KWidgetFlag.busearch) {
		var tabsIndex = this._busSecondTabs.current().index;
		var tabsItem = this._busSecondTabs.current();
		var secondTabsLiDom = $(">ul>li", this._busSecondHeaderDom).eq(tabsIndex);
		if (tabsItem.kvalue == -1 || typeof tabsItem.kvalue == "undefined") {
			tabsItem.kvalue = secondTabsLiDom.attr("kvalue");
		}
		if (tabsItem.text == "" || typeof tabsItem.text == "undefined") {
			tabsItem.text = secondTabsLiDom.attr("text");
		}
		return tabsItem;
	} else {
		return null;
	}
};
/**
 * 
 * 
 * @uncrunch
 */
KSearchbox.prototype.tab = function()
{
    var tabsIndex = this._firstTabs.current().index;
    var tabsItem = this._firstTabs.current();
    var firstTabsLiDom = $(">ul>li", this._firstHeader).eq(tabsIndex);
    if (tabsItem.kvalue == -1 || typeof tabsItem.kvalue == "undefined")
    {
        tabsItem.kvalue = firstTabsLiDom.attr("kvalue");
    }
    if (tabsItem.text == -1 || typeof tabsItem.text == "undefined")
    {
        tabsItem.text = firstTabsLiDom.attr("text");
    }

    return tabsItem;
};
/**
 *  opts  only2text 
 * @return String
 * @uncrunch
 */
KSearchbox.prototype.query = function(opts, only2text)
{
    var _this = this;
    var result = this._setQueryOptions(opts);
    if (!only2text && !result)
    {
        this._submitQuery();
    }
};
/**
 * input
 * @return {Array} input
 * @uncrunch
 */
KSearchbox.prototype.getCurrInputs = function(){
	return $("input[mfg]:text:visible", this._dom).get();
}

/***********************************************************************************************************************
 * 
 **********************************************************************************************************************/
KSearchbox.prototype._initInputFg = function() {
	var grayClass = this.options().theme + KSearchbox.conf.CLASSNAME.GRAY, length = this._mfgArray.length, $input, val;
	for ( var i = 0; i < length; i++) {
		$input = $("input[mfg='" + this._mfgArray[i] + "']", this._domAll);
		if ($input.length) {
			val = $input.val();
			(val && val !== this._tipArray[i]) ? $input.removeClass(grayClass) : $input.addClass(grayClass).val(
					this._tipArray[i]);
		}
	}
};

KSearchbox.prototype._setSuggestEventHandle = function()
{
    var _this = this;
    switch (_this.tab().kvalue)
    {
        case KWidgetFlag.localsearch:
            _this._suggestFun({data:{dom:_this._lsInputDom,num:0}});
            break;
        case KWidgetFlag.busearch:
            var secondcat = _this.secondcat().kvalue;
            if (secondcat == KQueryType.busearch)
            {
                _this._suggestFun({data:{dom:_this._boInputDom,num:3}});
                _this._suggestFun({data:{dom:_this._bdInputDom,num:4}});

            }
            else if (secondcat == KQueryType.busline)
            {
                _this._suggestFun({data:{dom:_this._blInputDom,num:1}});
            } else if (secondcat == KQueryType.bustation)
            {
                _this._suggestFun({data:{dom:_this._bzInputDom,num:2}});
            }
            break;
        case KWidgetFlag.navsearch:
            _this._suggestFun({data:{dom:_this._noInputDom,num:5}});
            _this._suggestFun({data:{dom:_this._ndInputDom,num:6}});

            break;
        case "ns":
            _this._suggestFun({data:{dom:_this._zcInputDom,num:7}});
            _this._suggestFun({data:{dom:_this._zkInputDom,num:8}});

            break;
        default :
    }
};
/**
 * 
 * @param opt
 */
KSearchbox.prototype._setOptions = function(opt)
{
	var _this = this;
    this._oldOpts = this._opts.theme;
    var diffOpts = KTools.compareOptions(this._opts, opt);
    $.each(diffOpts, function(name, value) {
        switch (name)
        {
            case 'theme':
                _this._setOption({'theme':value});
                _this._updateThemeOptions();
                break;
            case 'suggest':
                _this._setOption({'suggest':value});
                _this._updateSugOptions();
                break;
            case 'demolist':
                _this._setOption({'demolist':value});
                _this._updateDemolist();
                break;
            case  'demopos':
                _this._setOption({'demopos':value});
                _this._updateDemopos();
                break;
            case  'citylist':
                _this._setOption({'citylist':value});
                _this._updateCitylist();
                break;
            case  'sugopts':
                _this._setOption({'sugopts':value});
                _this._updateSuggest();
                break;
            case  'cylopts':
                _this._setOption({'citylist':value});
                _this._updateCitylist();
                break;
            case 'cityfun':
                _this._setOption({'cityfun' : value});
                break;
            case 'check':
            	if (value !== 0 && value !== 1 && value !== 2) {
					value = 0;
				}
            	_this._setOption({'check':value});
            default:
        }
    });
};
/**
 *  options
 * @param opt
 */
KSearchbox.prototype._updateOptions = function(opt)
{
    this._oldOpts = this._opts.theme;
    this._opts = KTools.copyOptions(opt, this._opts);
};





/**
 * 
 * @uncrunch
 */
KSearchbox.prototype.queryOptions = function()
{
    //this._getCurrQueryOpts();
    return this._queryOptions;
};
/**
 * theme
 */
KSearchbox.prototype._updateThemeOptions = function() {
	var _this = this;
	this._domAll.removeClass(this._oldOpts + KSearchbox.conf.CLASSNAME.SHX).addClass(
			this.options().theme + KSearchbox.conf.CLASSNAME.SHX);
	if (this._busChangeADom) {
		this._busChangeADom.removeClass(this._oldOpts + KSearchbox.conf.CLASSNAME.SWO).addClass(
				this.options().theme + KSearchbox.conf.CLASSNAME.SWO);
	}
	if (this._navChangeADom) {
		this._navChangeADom.removeClass(this._oldOpts + KSearchbox.conf.CLASSNAME.SWO).addClass(
				this.options().theme + KSearchbox.conf.CLASSNAME.SWO);
	}
	$("input[type='image']", this._domAll).each(function() {
		$(this).removeClass(_this._oldOpts + KSearchbox.conf.CLASSNAME.SMT).addClass(
						_this.options().theme + KSearchbox.conf.CLASSNAME.SMT);
	});
	/*
	 * var mfgArray =["ls","bl","bz","bo","bd","no","nd","zc","zk"]; var length = mfgArray.length; for(var i=0;i<length;i++) {
	 * if(this._input[mfgArray[i]]) { $("input[fg='"+mfgArray[i]+"']", this._domAll).removeClass(this._opts.theme +
	 * KSearchbox.conf.CLASSNAME.GRAY); } else { $("input[fg='"+mfgArray[i]+"']",
	 * this._domAll).addClass(this._opts.theme + KSearchbox.conf.CLASSNAME.GRAY); } }
	 */
};
/**
 * 
 */
KSearchbox.prototype._updateDemolist = function() {
	var _this = this;
	// this._tipContentHeader.show();
	/*
	 * if(this._opts.demopos == KPosition.RIGHT) { this._tipContentHeader.hide(); } else {
	 */
	if (this._opts.demolist !== false) {
		this._tipContentHeader.show();
	} else {
		this._tipContentHeader.hide();
	}
	// }
};
/**
 * 
 */
KSearchbox.prototype._updateDemopos = function()
{
    if (this._opts.demopos == KPosition.RIGHT)
    {
        this._domAll.addClass(this.options().theme+"_shx_h");
    }
    else
    {
        this._domAll.removeClass(this.options().theme+"_shx_h");
    }
};
/**
 * 
 */
KSearchbox.prototype._updateCitylist = function() {
	var _this = this;
	var citylistOpt = _this._opts.cylopts;
	
	var seachCitychange = function (citydom){
		KEvent.bind(citydom,"citychanged",function(e,w,c,o){
//			_this._opts.cylopts.defcity = c;
			$(">span>input", _this._lcCityDom).val(c.name);
			$(">span>input", _this._busChangeCityListDom).val(c.name);
			$(">span>input", _this._busLineCityListDom).val(c.name);
			$(">span>input", _this._busStationCityListDom).val(c.name);
			$(">span>input", _this._nbCityListDom).val(c.name);
			var cityObjMap = [_this._lcCityList,_this._busChangeCityList,_this._busLineCityList,_this._busStationCityList,_this._nbCityList];
			for(var i = 0;i < cityObjMap.length;i++){
				if(citydom != cityObjMap[i]){
//					KEvent.trigger(cityObjMap[i], "citychanged", cityObjMap[i], c, o);
					cityObjMap[i]._city = c;
				}
			}
		});
	}
	
	if (this._opts.citylist) {
		if (this._lcCityDom && this._lcCityDom.length != 0 && this._lcCityList == null) {
			this._lcCityList = new KCityList(this._lcCityDom, citylistOpt);
			seachCitychange(this._lcCityList);
		}
		if (this._busChangeCityListDom && this._busChangeCityListDom.length != 0 && this._busChangeCityList == null) {
			this._busChangeCityList = new KCityList(this._busChangeCityListDom, citylistOpt);
			seachCitychange(this._busChangeCityList);
		}
		if (this._busLineCityListDom&&this._busLineCityListDom.length != 0 && this._busLineCityList == null) {
			this._busLineCityList = new KCityList(this._busLineCityListDom, citylistOpt);
			seachCitychange(this._busLineCityList);
		}
		if (this._busStationCityListDom&&this._busStationCityListDom.length != 0 && this._busStationCityList == null) {
			this._busStationCityList = new KCityList(this._busStationCityListDom, citylistOpt);
			seachCitychange(this._busStationCityList);
		}
		if (this._nbCityListDom && this._nbCityListDom.length != 0 && this._nbCityList == null) {
			this._nbCityList = new KCityList(this._nbCityListDom, citylistOpt);
			seachCitychange(this._nbCityList);
		}
	} else {
		if (this._lcCityDom && this._lcCityDom.length != 0) {
			this._lcCityList = null;
			this._lcCityDom.hide();
		}
		if (this._busChangeCityListDom && this._busChangeCityListDom.length != 0) {
			this._busChangeCityList = null;
			this._busChangeCityListDom.hide();
		}
		if (this._busLineCityListDom && this._busLineCityListDom.length != 0) {
			this._busLineCityList = null;
			this._busLineCityListDom.hide();
		}
		if (this._busStationCityListDom && this._busStationCityListDom.length != 0) {
			this._busStationCityList = null;
			this._busStationCityListDom.hide();
		}
		if (this._nbCityListDom && this._nbCityListDom.length != 0) {
			this._nbCityList = null;
			this._nbCityListDom.hide();
		}
	}
	if (this._busSecondTabs == null && this._busSecondHeaderDom) {
		//$.browser.msie ? $(initRadio) : initRadio();
		_this._busSecondHeaderDom.find("input:radio").attr("checked", false).eq(0).attr("checked", true);
		this._busSecondTabs = new KStdTabs(this._busSecondHeaderDom);
		KEvent.bind(_this._busSecondTabs, "selected", function(eventinfo, widget, oldItem, currentItem) {
			//window.alert("second tabs: " + currentItem.index);
			_this._busChangeIDomArray.eq(currentItem.index).attr("checked", "checked");
			_this._setSuggestEventHandle();
			_this._updateDemos(_this.tab().kvalue);
			// opt# 1006291318 trigger "secondcatchanged"
			KEvent.trigger(_this, "secondcatchanged", _this, _this.tab(), _this.secondcat());
		});
	}
};
KSearchbox.prototype._getSuggestUrl = function() {
	var _this = this;
	if (this._opts.sugopts.url) {
		var sugopts = this._opts.sugopts.url;
		if (sugopts.indexOf("?") != -1) {
			var num = sugopts.indexOf("?");
			sugopts = sugopts.substring(0, num);
		}
		sugopts = sugopts + "?s=json&c=";
		switch (this.tab().kvalue) {
			case KWidgetFlag.localsearch:
				sugopts = sugopts + _this._getCityListCity(_this._lcCityDom, _this._lcCityList).name + "&t=ks&";
				break;
			case KWidgetFlag.busearch:
				if (_this.secondcat().kvalue == KQueryType.busearch) {
					sugopts = sugopts
							+ _this._getCityListCity(_this._busChangeCityListDom, _this._busChangeCityList).name
							+ "&t=ks";
				} else if (_this.secondcat().kvalue == KQueryType.bustation) {
					sugopts = sugopts
							+ _this._getCityListCity(_this._busStationCityListDom, _this._busStationCityList).name
							+ "&t=bss";
				} else if (_this.secondcat().kvalue == KQueryType.busline) {
					sugopts = sugopts + _this._getCityListCity(_this._busLineCityListDom, _this._busLineCityList).name
							+ "&t=bls";
				}
				break;
			case KWidgetFlag.navsearch:
				// sugopts = sugopts + _this._getCityListCity([], null).name+"&t=nas";
				sugopts = sugopts + "&t=nas";
				break;
			case "ns":
				sugopts = sugopts + _this._getCityListCity(_this._nbCityListDom, _this._nbCityList).name + "&t=ks";
				break;
			default:
				sugopts = sugopts + _this._getCityListCity( [], null).name + "&t=ks";
		}
		return sugopts;
	} else {
		return "";
	}
};
KSearchbox.prototype._suggestFun = function(eventinfo) {
	var _this = this;
	var arrTemp = [ "ks", "bls", "bss", "ks", "ks", "nas", "nas", "ks", "ks" ];
	var num = eventinfo.data.num;
	var obj = eventinfo.data.dom;
	var inputbones = KTools.getBounds(obj.get(0));
	var minwidth1 = parseInt(inputbones.max.x - inputbones.min.x);
	if (_this._inputSuggestArray && typeof _this._inputSuggestArray[num] != "undefined") {
		_this._inputSuggestArray[num].clearCache();
		var sugurl = _this._gethashvalue(_this._getSuggestUrl());
		_this._inputSuggestArray[num].setOptions( {
			url : sugurl
		});
	} else if (_this._opts.sugopts) {
		if (typeof _this._opts.sugopts != "undefined" && typeof _this._opts.sugopts.url != "undefined" && arrTemp[num]) {
			var sugopts = _this._opts.sugopts.url;
			sugopts = _this._getSuggestUrl();
			var sugurl = sugopts.replace(/t=[^&]*/g, "t=" + arrTemp[num]).replace(/(^\s*)|(\s*$)/g, '');
			sugurl = _this._gethashvalue(sugurl);
			_this._inputSuggestArray[num] = new KStdSuggest(obj, {
				'url' : sugurl,
				'autocomplete' : false,
				'listlimit' : _this._opts.suglimit,
				minwidth : minwidth1
			});
			if (arrTemp[num] == "nas") // suggest
			{
				_this._navGetCity(num);
			}
		}
	} else {
		if (_this._inputSuggestArray[num]) {
			_this._inputSuggestArray[num].finalize();
			_this._inputSuggestArray[num] = undefined;
		}
	}
};
/**
 * 
 * 
 * @param eventinfo
 */
KSearchbox.prototype._suggestDomFun = function(eventinfo)
{
	var _this = eventinfo.data._this;
    _this._suggestFun({data:{dom:$(this),num:eventinfo.data.num}});
};
KSearchbox.prototype._updateInputSuggestUrl = function()
{
    var _this = this;
    KEvent.bind(this._lsInputDom, "focus", _this._suggestDomFun, {_this:this,num:0});
    KEvent.bind(this._blInputDom, "focus", _this._suggestDomFun, {_this:this,num:1});
    KEvent.bind(this._bzInputDom, "focus", _this._suggestDomFun, {_this:this,num:2});
    KEvent.bind(this._boInputDom, "focus", _this._suggestDomFun, {_this:this,num:3});
    KEvent.bind(this._bdInputDom, "focus", _this._suggestDomFun, {_this:this,num:4});
    KEvent.bind(this._noInputDom, "focus", _this._suggestDomFun, {_this:this,num:5});
    KEvent.bind(this._ndInputDom, "focus", _this._suggestDomFun, {_this:this,num:6});
    KEvent.bind(this._zcInputDom, "focus", _this._suggestDomFun, {_this:this,num:7});
    KEvent.bind(this._zkInputDom, "focus", _this._suggestDomFun, {_this:this,num:8});
};
KSearchbox.prototype._navGetCity = function(num)
{
    var _this = this;
    if (num == 5) {
		KEvent.bind(this._inputSuggestArray[num], "datachanged", function(eventInfo, widget, suggsetInfo) {
			if (suggsetInfo.kvalue) {
				//
				_this._navorigCity = suggsetInfo.kvalue.a;
			} else {
				_this._navorigCity = undefined;
			}
		});
	} else {
		KEvent.bind(this._inputSuggestArray[num], "datachanged", function(eventInfo, widget, suggsetInfo) {
			if (suggsetInfo.kvalue) {
				//
				_this._navdestCity = suggsetInfo.kvalue.a;
			} else {
				_this._navdestCity = undefined;
			}

		});
	}
};
KSearchbox.prototype._updateKeywordSuggest = function()
{
    var _this = this;
    var suggestShowFlag = (_this._opts.suggest || typeof this._opts.suggest == "undefined");
    if (suggestShowFlag)
    {
        _this._setSuggestEventHandle();
    }
};
/**
 * 
 */
KSearchbox.prototype._updateSuggest = function()
{
    var _this = this;
    var suggestShowFlag = (_this._opts.suggest || typeof this._opts.suggest == "undefined");
    _this._updateKeywordSuggest();

    if (this._lcCityList != null)
    {
        this._lcCityList.setOptions({sugurl:(suggestShowFlag ? _this._lcCityList.sugurl : "")});
        this._lcCityList._updateSugOptions();
    }
    if (this._busChangeCityList != null)
    {
        this._busChangeCityList.setOptions({sugurl:(suggestShowFlag ? _this._busChangeCityList.sugurl : "")});
        this._busChangeCityList._updateSugOptions();
    }
    if (this._busLineCityList != null)
    {
        this._busLineCityList.setOptions({sugurl:(suggestShowFlag ? _this._busLineCityList.sugurl : "")});
        this._busLineCityList._updateSugOptions();
    }
    if (this._busStationCityList != null)
    {
        this._busStationCityList.setOptions({sugurl:(suggestShowFlag ? _this._busStationCityList.sugurl : "")});
        this._busStationCityList._updateSugOptions();
    }
    if (this._nbCityList != null)
    {
        this._nbCityList.setOptions({sugurl:(_this._opts.suggest ? _this._nbCityList.sugurl : "")});
        this._nbCityList._updateSugOptions();
    }
};
/**
 * 
 * @returns Boolean
 */
KSearchbox.prototype._getCurrQueryOpts = function() {
	var _this = this;
	var firstItem = this.tab();
	var queryOptions =KTools.copyOptions(queryOptions, KQueryOptions);
	var secondItem = this.secondcat();
	switch (firstItem.kvalue) {
		case KWidgetFlag.localsearch:
			queryOptions.type = KQueryType.localsearch;
			queryOptions.ls = KTools.copyOptions( {}, KPOInfo);
			queryOptions.ls.name = this._lsInputDom.val();
			queryOptions.ls.city = this._getCityListCity(this._lcCityDom, this._lcCityList).name;
			delete queryOptions.center;
			break;
		case KWidgetFlag.busearch:
			if (secondItem.kvalue == KQueryType.busearch) {
				queryOptions.type = KQueryType.busearch;
				queryOptions.busorig = KTools.copyOptions( {}, KPOInfo);
				queryOptions.busdest = KTools.copyOptions( {}, KPOInfo);
				queryOptions.busorig.name = this._boInputDom.val();
				queryOptions.busdest.name = this._bdInputDom.val();
				queryOptions.busorig.city = this._getCityListCity(this._busChangeCityListDom, this._busChangeCityList).name;
				queryOptions.busdest.city = this._getCityListCity(this._busChangeCityListDom, this._busChangeCityList).name;
				if (queryOptions.busorig.name === "") {
					queryOptions.busorig = $.extend(true, {}, this._queryOptions.busorig);
				}
				if (queryOptions.busdest.name === "") {
					queryOptions.busdest = $.extend(true, {}, this._queryOptions.busdest);
				}
			} else if (secondItem.kvalue == KQueryType.busline) {
				queryOptions.type = KQueryType.busline;
				queryOptions.busline = KTools.copyOptions( {}, KPOInfo);
				queryOptions.busline.name = this._blInputDom.val();
				queryOptions.busline.city = this._getCityListCity(this._busLineCityListDom, this._busLineCityList).name;
			} else if (secondItem.kvalue == KQueryType.bustation) {
				queryOptions.type = KQueryType.bustation;
				queryOptions.bustation = KTools.copyOptions( {}, KPOInfo);
				queryOptions.bustation.name = this._bzInputDom.val();
				queryOptions.bustation.city = this._getCityListCity(this._busStationCityListDom,
						this._busStationCityList).name;
			}
			break;
		case KWidgetFlag.navsearch:
			queryOptions.type = KQueryType.navsearch;
			//
			queryOptions.navorig = KTools.copyOptions( {}, KPOInfo);
			queryOptions.navdest = KTools.copyOptions( {}, KPOInfo);
			//
			var isOrigNameEqual = false, isDestNameEqual=false;
			var noInputVal = this._noInputDom.val(), ndInputVal = this._ndInputDom.val();
			if (this._queryOptions && this._queryOptions.navorig && this._queryOptions.navorig.name === noInputVal) {
				isOrigNameEqual =true;
			}
			if (this._queryOptions && this._queryOptions.navdest &&  this._queryOptions.navdest.name === ndInputVal) {
				isDestNameEqual = true;
			}
			queryOptions.navorig.name = noInputVal;
			queryOptions.navdest.name = ndInputVal;
			//
			if(this._navorigCity){
				queryOptions.navorig.city = this._navorigCity;
			}else if(isOrigNameEqual && this._queryOptions.navorig.city){
				queryOptions.navorig.city = this._queryOptions.navorig.city;
			}else{
				queryOptions.navorig.city = "";
			}
			if(this._navdestCity){
				queryOptions.navdest.city = this._navdestCity;
			}else if(isDestNameEqual && this._queryOptions.navdest.city){
				queryOptions.navdest.city = this._queryOptions.navdest.city;
			}else{
				queryOptions.navdest.city = "";
			}
			//
			var currentCity = "";
			if (this._opts.cityfun && this._opts.cityfun.fun && this._opts.cityfun.thisobj) {
				currentCity = _this._opts.cityfun.fun.call(_this._opts.cityfun.thisobj);
			}
			queryOptions.mapcity = currentCity;
			//
			var customNavOrig = (queryOptions.navorig.name === "");
			var customNavDest = (queryOptions.navdest.name === "");
			if (customNavOrig || customNavDest) {
				if (customNavOrig) {
					queryOptions.navorig = $.extend(true, {}, this._queryOptions.navorig);
				}
				if (customNavDest) {
					queryOptions.navdest = $.extend(true, {}, this._queryOptions.navdest);
				}
				queryOptions.mapcity = $.extend(true, {}, this._queryOptions.mapcity);
			}
			_this._navorigCity = undefined;// undefined
			_this._navdestCity = undefined; // undefined
			break;
		case "ns":
			queryOptions.type = KQueryType.localsearch;
			queryOptions.center = KTools.copyOptions( {}, KPOInfo);
			queryOptions.ls = KTools.copyOptions( {}, KPOInfo);
			queryOptions.center.name = this._zcInputDom.val();
			queryOptions.ls.name = this._zkInputDom.val();
			queryOptions.center.city = this._getCityListCity(this._nbCityListDom, this._nbCityList).name;
			queryOptions.ls.city = this._getCityListCity(this._nbCityListDom, this._nbCityList).name;
			break;
		default:
			queryOptions =false;
	}
	return queryOptions;
};
/**
 * dom
 * 
 * @param dom
 * @param listObj
 */
KSearchbox.prototype._getCityListCity = function(dom, listObj) {
	var _this = this;
	var currentCity = "";
	if (dom.length != 0 && listObj != null) {
		// currentCity = listObj.city();
		currentCity = listObj.city();
	} else {
		if (!this._opts.citylist && this._opts.cityfun && this._opts.cityfun.fun && this._opts.cityfun.thisobj) {
			currentCity = _this._opts.cityfun.fun.call(_this._opts.cityfun.thisobj);
		} else {
			currentCity = KCityInfo;
		}
	}
	return currentCity;
};
/**
 * fgfg
 * 
 * @param firstFg
 * @param secondFg
 * @param dom
 */
KSearchbox.prototype._swapFg = function(firstFg, secondFg, dom)
{
    var _this = this;
    if (this._input[firstFg] || this._input[secondFg])
    {
        var tempvalue = this._input[firstFg] ? $("input[mfg='" + firstFg + "']", _this._domAll).val() : "";
        var tempsvalue = this._input[secondFg] ? $("input[mfg='" + secondFg + "']", _this._domAll).val() : "";
        var tempFfg = this._input[firstFg];
        var tempSfg = this._input[secondFg];
        if (tempFfg) {
            this._input[secondFg] = tempFfg;
            $("input[mfg='" + secondFg + "']", _this._domAll).removeClass(this.options().theme + KSearchbox.conf.CLASSNAME.GRAY).val(tempvalue).blur();
        }
        else
        {
            this._input[secondFg] = undefined;
            $("input[mfg='" + secondFg + "']", _this._domAll).addClass(this.options().theme + KSearchbox.conf.CLASSNAME.GRAY).val(tempvalue).blur();
        }
        if (tempSfg) {
            this._input[firstFg] = tempSfg;
            $("input[mfg='" + firstFg + "']", _this._domAll).removeClass(this.options().theme + KSearchbox.conf.CLASSNAME.GRAY).val(tempsvalue).blur();
        }
        else
        {
            this._input[firstFg] = undefined;
            $("input[mfg='" + firstFg + "']", _this._domAll).addClass(this.options().theme + KSearchbox.conf.CLASSNAME.GRAY).val(tempsvalue).blur();
        }
    }
    //dom.removeClass(_this.options().theme + KSearchbox.conf.CLASSNAME.SWO).addClass(_this.options().theme + KSearchbox.conf.CLASSNAME.SWD);
};
/**
 * option
 * @param opt
 */
KSearchbox.prototype._setOption = function(opt)
{
    this._oldOpts = this._opts.theme;
    this._opts = KTools.copyOptions(opt, this._opts);
};
/**
 * autoquery submit
 */
KSearchbox.prototype._updateAutoquery = function()
{  //autoqueryquery
    var _this = this;
    if (this._opts.autoquery)
    {
        _this._submitQueryEvent();
    }
    else
    {

    }
};
/**
 *  autoqueryquery
 */
KSearchbox.prototype._submitQueryEvent = function()
{
    var _this = this;
    var matchvalue = _this.tab().kvalue;
    switch (matchvalue)
    {
        case 'ls':
			//suggest
			this._inputSuggestArray[0] && this._inputSuggestArray[0].setVisible(false);
            matchvalue = KWidgetFlag.localsearch;
            break;
        case 'bs':
			this._inputSuggestArray[3] && this._inputSuggestArray[3].setVisible(false);
			this._inputSuggestArray[4] && this._inputSuggestArray[4].setVisible(false);
            matchvalue = KWidgetFlag.busearch;
            break;
        case 'navs':
			this._inputSuggestArray[5] && this._inputSuggestArray[5].setVisible(false);
			this._inputSuggestArray[6] && this._inputSuggestArray[6].setVisible(false);
            matchvalue = KWidgetFlag.navsearch;
            break;
        case 'ns':
			this._inputSuggestArray[7] && this._inputSuggestArray[7].setVisible(false);
			this._inputSuggestArray[8] && this._inputSuggestArray[8].setVisible(false);			
			
            matchvalue = KWidgetFlag.localsearch;
            break;
        default :
    }
    //if(_this.tab().kvalue =="ns") matchvalue = KWidgetFlag.localsearch;
    var kqueryWidget = KManager.match(matchvalue, KQuery);
    this._setCookie();
    if (kqueryWidget.length > 0) {
		if (this._opts.preprocessFun) {
			var fun = _this._opts.preprocessFun.fun;
			var thisobj = _this._opts.preprocessFun.thisobj;
			kqueryWidget[0].query(fun.call(thisobj, _this.queryOptions()));
		} else {
			kqueryWidget[0].query(_this.queryOptions());
		}
	}
};

KSearchbox.prototype._setQueryOptions = function(opts) {
	var _this = this;
	var tabs = this._firstTabs.tabs();
	var keys = {}, kvalue;
	for ( var i = 0; i < tabs.length; i++) {
		keys[tabs[i].kvalue] = tabs[i].index; 
	}
	if (opts.type) {
		switch (opts.type) {
			case KQueryType.localsearch:
				if (opts.center) {
					this._firstTabs.select(keys["ns"]);
					// opts.centeropts.center.name
					if (!opts.center.name) {
						return true;
					}
					if (opts.ls) {
						this._setInputValue(this._zkInputDom, opts.ls.name);
					}
					this._setInputValue(this._zcInputDom, opts.center.name);
				} else {
					this._firstTabs.select(keys["ls"]);
					if (opts.ls) {
						this._setInputValue(this._lsInputDom, opts.ls.name);
					}
				}
				break;
			case KQueryType.busearch:
				this._firstTabs.select(keys["bs"]);
				this._busSecondTabs.select(0);
				var tab0 = this._busSecondTabs.tab(0);
				//0
				KEvent.trigger(this._busSecondTabs, "selected", this._busSecondTabs, tab0, tab0);
				if (opts.busorig) {
					
					this._setInputValue(this._boInputDom, opts.busorig.name);
					// 
					if (opts.busorig.name === "") {
						if (!this._queryOptions.busorig) {
							this._queryOptions.busorig = {};
						}
						this._queryOptions.busorig.name = "";
						if (opts.busorig.latlon) {
							this._queryOptions.busorig.latlon = opts.busorig.latlon;
						}
						if (opts.busorig.pid) {
							this._queryOptions.busorig.pid = opts.busorig.pid;
						}
					}
				}
				if (opts.busdest) {
					this._setInputValue(this._bdInputDom, opts.busdest.name);
					// 
					if (opts.busdest.name === "") {
						if (!this._queryOptions.busdest) {
							this._queryOptions.busdest = {};
						}
						this._queryOptions.busdest.name = "";
						if (opts.busdest.latlon) {
							this._queryOptions.busdest.latlon = opts.busdest.latlon;
						}
						if (opts.busdest.pid) {
							this._queryOptions.busdest.pid = opts.busdest.pid;
						}
					}
				}
				break;
			case KQueryType.busline:
				this._firstTabs.select(1);
				this._busSecondTabs.select(1);
				if (opts.busline) {
					this._setInputValue(this._blInputDom, opts.busline.name);
				}
				break;
			case KQueryType.bustation:
				this._firstTabs.select(1);
				this._busSecondTabs.select(2);
				if (opts.bustation) {
					this._setInputValue(this._bzInputDom, opts.bustation.name);
				}
				break;
			case KQueryType.navsearch:
				this._firstTabs.select(keys["navs"]);
				if (opts.navorig) {
					this._setInputValue(this._noInputDom, opts.navorig.name);
					// 
					if (opts.navorig.name === "") {
						if (!this._queryOptions.navorig) {
							this._queryOptions.navorig = {};
						}
						this._queryOptions.navorig.name = "";
						if (opts.navorig.latlon) {
							this._queryOptions.navorig.latlon = opts.navorig.latlon;
						}
						if (opts.navorig.pid) {
							this._queryOptions.navorig.pid = opts.navorig.pid;
						}
					}
				}
				if (opts.navdest) {
					this._setInputValue(this._ndInputDom, opts.navdest.name);
					// 
					if (opts.navdest.name === "") {
						if (!this._queryOptions.navdest) {
							this._queryOptions.navdest = {};
						}
						this._queryOptions.navdest.name = "";
						if (opts.navdest.latlon) {
							this._queryOptions.navdest.latlon = opts.navdest.latlon;
						} else if (opts.navdest.pid) {
							this._queryOptions.navdest.pid = opts.navdest.pid;
						}
					}
				}
				break;
			default:
				return true;
		}
	}
	// if(opts.ns)
};
KSearchbox.prototype._setInputValue = function(dom, value)
{
    this._input[dom.attr("mfg")] = dom.attr("mfg");
    dom.removeClass(this.options().theme + KSearchbox.conf.CLASSNAME.GRAY).val(value);
};
KSearchbox.prototype._setCookie = function() {
	var _this = this, val="";
	switch (_this.tab().kvalue) {
		case KWidgetFlag.localsearch:
			val = this._lsInputDom.val();
			this._updateCookie("ls", val);
			this._updateCookie("nls", this._getCity("nls") + ":" + val);
			break;
		case KWidgetFlag.busearch:
			if (_this.secondcat().kvalue == KQueryType.busearch) {
				this._updateCookie("bo", this._boInputDom.val());
				this._updateCookie("bd", this._bdInputDom.val());
				this._updateCookie("bod", this._getBodOrNod(true));
			} else if (_this.secondcat().kvalue == KQueryType.busline) {
				val = this._blInputDom.val();
				this._updateCookie("bl", val);
				this._updateCookie("nbl", this._getCity("nbl") + ":" + val);
			} else if (_this.secondcat().kvalue == KQueryType.bustation) {
				val = this._bzInputDom.val();
				this._updateCookie("ba", val);
				this._updateCookie("nba", this._getCity("nba") + ":" + val);
			}
			break;
		case KWidgetFlag.navsearch:
			this._updateCookie("no", this._noInputDom.val());
			this._updateCookie("nd", this._ndInputDom.val());
			this._updateCookie("nod", this._getBodOrNod(false));
			break;
		case "ns":
	/*		val = this._zcInputDom.val() + ":" + this._zkInputDom.val();
			this._updateCookie("nb", val);
		*/	
			this._updateCookie("zc", this._zcInputDom.val());
			val = $.trim(this._zkInputDom.val());
			
			//cookie
			var tipHas = false;
			for(var i = 0; i < this._zkInputTip.length; i ++){
				if(this._zkInputTip[i] == val){	tipHas = true;	break;		}
			};
			if(tipHas){		break;		};
			
			this._updateCookie("zk", val);
			this._updateCookie("nnb", this._getCity("nnb") + ":" + val);
			break;
	}
};
/**
 * cookie
 * 
 * @param name
 *            cookie
 * @returns Array
 */
KSearchbox.prototype._getCookie = function(name, lenLast) {
	var  cookie = KTools.getCookie(name), reArr = [];
	var tempArr = [];
	if (typeof cookie === "string") {
		tempArr = cookie.split(this._CSPLIT);
	}
	switch (name) {
		case "ls":
		case "bo":
		case "bd":
		case "bl":
		case "ba":
		case "no":
		case "nd":
				reArr = tempArr;
			break;
		case "nls":
		case "nbl":
		case "nba":
			for ( var i = 0; i < tempArr.length; i++) {
				var parsed = this._parseNblItem(tempArr[i]);
				if (parsed) {
					reArr.push(parsed);
				}
			}
			break;
		case "bod":
		case "nod":
			for ( var i = 0; i < tempArr.length; i++) {
				var parsed = this._parseBodOrNodItem(tempArr[i]);
				if (parsed) {
					reArr.push(parsed);
				}
			}
			break;
		case "nb":
		case "nnb":
			var hasCity = name === "nnb";
			for ( var i = 0; i < tempArr.length; i++) {
				var parsed = this._parseNbItem(tempArr[i], hasCity);
				if (parsed) {
					reArr.push(parsed);
				}
			}
			break;
	}
	while(reArr.length > lenLast){
		reArr.shift();
	}
	//reverse 
	var reverse = [];
	for(var i = reArr.length-1; i>=0; i=i-1){
		reverse.push(reArr[i]);
	}
	return reverse;
};

KSearchbox.prototype._updateDemos = function(tabKvalue) {
	var _this=this;
	if (this._opts.demolist && this._opts.customdemo !== true && this._tipContentHeader) {
		var html=[ this._demohint[1]], arr;
		var demoOpts=[];
		var _this=this;
		var matchvalue;
		var isNearBy = false;
		var isNew = true;
		var getShort = function(str,type) {
			var len = (_this._opts && _this._opts.txtlen && (typeof _this._opts.txtlen[type] === "number")) ? _this._opts.txtlen[type]
					: -1;
			return ((len > -1) && (str.length > len + 2)) ? str.substring(0, len) + ".." : str;
		};
		
		var getDefaultDemo = function(flag, len){
			var reArr=[];
			if(_this._opts.defaultdemo && _this._opts.defaultdemo[flag]){
				var tempArr = _this._opts.defaultdemo[flag].split(_this._CSPLIT);
				switch (flag) {
					case "nls":
					case "nbl":
					case "nba":
						for ( var i = 0; i < tempArr.length; i++) {
							var parsed = _this._parseNblItem(tempArr[i]);
							if (parsed) {
								reArr.push(parsed);
							}
						}
						break;
					case "bod":
					case "nod":
						for ( var i = 0; i < tempArr.length; i++) {
							var parsed = _this._parseBodOrNodItem(tempArr[i]);
							if (parsed) {
								reArr.push(parsed);
							}
						}
						break;
					case "nnb":
						for ( var i = 0; i < tempArr.length; i++) {
							var parsed = _this._parseNbItem(tempArr[i], true);
							if (parsed) {
								reArr.push(parsed);
							}
						}
						break;
				}
			}
			while(reArr.length>len){
				reArr.shift();
			}
			return reArr;
		};
		switch (tabKvalue) {
			default:
			case KWidgetFlag.localsearch:
				arr = this._getCookie("nls", this._demoSum["ls"]);
				if(!arr || !arr.length){
					arr = getDefaultDemo("nls", this._demoSum["ls"]);
					if(arr && arr.length){
						html=[ [ this._demohint[0]]];
					}
				}
				if(!arr || !arr.length){
					isNew = false;
					arr = this._getCookie("ls", this._demoSum["ls"]); 
				};
				matchvalue = KWidgetFlag.localsearch;
				$.each(arr, function(index, obj) {
					var lsObj = isNew ? {
						city : obj.city,
						name : obj.key
					} : {
						name : obj
					};
					html.push( "<a href='javascript:void(0)' title='"+lsObj.name+"'>" + getShort(lsObj.name, "ls") + "</a>");
					demoOpts.push({
						ls : lsObj,
						type : KWidgetFlag.localsearch
					});
				});
				break;
			case KWidgetFlag.busearch:
				matchvalue = KWidgetFlag.busearch;
				 var secondcat = _this.secondcat().kvalue;
				 switch (secondcat) {
					default:
					case KQueryType.busearch:
						arr = this._getCookie("bod", this._demoSum["bo"]);
						if(!arr || !arr.length){
							arr = getDefaultDemo("bod", this._demoSum["bo"]);
							if(arr && arr.length){
								html=[ [ this._demohint[0]]];
							}
						}
						$.each(arr, function(index, obj) {
							html.push("<a href='javascript:void(0)' title='" + obj.origkey + "" + obj.destkey + "'>"
									+ getShort(obj.origkey, "bo") + "" + getShort(obj.destkey,"bd") + "</a>");
							demoOpts.push( {
								busorig : {
									city : obj.origcity,
									name : obj.origkey
								},
								busdest : {
									city : obj.destcity,
									name : obj.destkey
								},
								mapcity:{
									city:obj.origcity
								},
								type : KWidgetFlag.busearch
							});
						});
						break;
					case KQueryType.busline:
						arr = this._getCookie("nbl", this._demoSum["bl"]);
						if(!arr || !arr.length){
							arr = getDefaultDemo("nbl", this._demoSum["bl"]);
							if(arr && arr.length){
								html=[ [ this._demohint[0]]];
							}
						}
						if(!arr || !arr.length){
							isNew = false;
							arr = this._getCookie("bl", this._demoSum["bl"]);
						}
						$.each(arr, function(index, obj) {
							var blObj = isNew ? {
								city : obj.city,
								name : obj.key
							} : {
								name : obj
							};
							html.push("<a href='javascript:void(0)' title='" + blObj.name + "'>"
									+ getShort(blObj.name, "bl") + "</a>");
							demoOpts.push( {
								busline : blObj,
								type : KQueryType.busline
							});
						});
						break;
					case KQueryType.bustation:
						arr = this._getCookie("nba", this._demoSum["bz"]);
						if(!arr || !arr.length){
							arr = getDefaultDemo("nba", this._demoSum["bz"]);
							if(arr && arr.length){
								html=[ [ this._demohint[0]]];
							}
						}
						if(!arr && !arr.length){
							isNew = false;
							arr = this._getCookie("ba", this._demoSum["bz"]);
						}
						$.each(arr, function(index, obj) {
							var baObj = isNew ? {
								city : obj.city,
								name : obj.key
							} : {
								name : obj
							};
							html.push("<a href='javascript:void(0)' title='"+baObj.name+"'>" + getShort(baObj.name,"bz") + "</a>");
							demoOpts.push( {
								bustation : baObj,
								type : KQueryType.bustation
							});
						});
						break;
				}
				break;
			case KWidgetFlag.navsearch:
				matchvalue = KWidgetFlag.navsearch;
				arr = this._getCookie("nod", this._demoSum["no"]);
				if(!arr || !arr.length){
					arr = getDefaultDemo("nod", this._demoSum["no"]);
					if(arr && arr.length){
						html=[ [ this._demohint[0]]];
					}
				}
				$.each(arr, function(index, obj) {
					html.push("<a href='javascript:void(0)' title='" + obj.origkey + "" + obj.destkey + "'>"
							+ getShort(obj.origkey,"no") + "" + getShort(obj.destkey,"nd") + "</a>");
					demoOpts.push( {
						navorig : {
							city : obj.origcity,
							name : obj.origkey
						},
						navdest : {
							city : obj.destcity,
							name : obj.destkey
						},
						mapcity:{
							city:obj.origcity
						},
						type:KWidgetFlag.navsearch
					});
				});
				break;
			case "ns":
				isNearBy=true;
				matchvalue = KWidgetFlag.localsearch;
				arr = this._getCookie("nnb", this._demoSum["zc"]);
				if(!arr || !arr.length){
					arr = getDefaultDemo("nnb", this._demoSum["zc"]);
					if(arr && arr.length){
						html=[ [ this._demohint[0]]];
					}
				}
				if(!arr || !arr.length){
					isNew = false;
					arr = this._getCookie("nb", this._demoSum["zc"]);
				}
				$.each(arr, function(index, obj) {
					html.push("<a href='javascript:void(0)' title='" + obj.center + "" + obj.key + "'>"
							+ getShort(obj.center, "zc") + "" + getShort(obj.key, "zk") + "</a>");
					var nsObj = {
						center : {
							name : obj.center
						},
						ls : {
							name : obj.key
						},
						type : KWidgetFlag.localsearch
					};
					if (isNew && obj.city) {
						nsObj.center.city = obj.city;
						nsObj.ls.city = obj.city;
					}
					demoOpts.push(nsObj);
				});
				break;
		}
		this._tipContentHeader.empty();
		if (html.length < 2) {
			return;
		}
		this._tipContentHeader.html(html.join(" ")).find("a").each(function(index){
			$(this).bind("click", function(event){
				event.preventDefault();
				var queryOpts={};
				$.extend(true, queryOpts, KQueryOptions, _this._queryOptions, demoOpts[index] );
				if(!isNearBy){
					delete queryOpts.center;
				}
				_this._queryOptions = queryOpts;
				//
				var grayClass = _this.options().theme + KSearchbox.conf.CLASSNAME.GRAY;
				var updateInput = function($input, val){
					$input.val(val).removeClass(grayClass);
				};
				var setCity = function(objKCityList, cityName){
					if(objKCityList && objKCityList.setCity){
						objKCityList.setCity(KTools.copyOptions( {
							name : cityName
						}, KCityInfo));
					}
				};
				
				switch(queryOpts.type){
					case KQueryType.localsearch:
						if (queryOpts.center) {
							updateInput(_this._zcInputDom, queryOpts.center.name);
							updateInput(_this._zkInputDom, queryOpts.ls.name);
							setCity(_this._nbCityList, queryOpts.ls.city ||queryOpts.center.city);
						} else {
							updateInput(_this._lsInputDom, queryOpts.ls.name);
							setCity(_this._lcCityList, queryOpts.ls.city);
						}
						break;
					case  KQueryType.busline:
						updateInput(_this._blInputDom, queryOpts.busline.name);
						setCity(_this._busLineCityList, queryOpts.busline.city);
						break;
					case  KQueryType.bustation:
						updateInput(_this._bzInputDom, queryOpts.bustation.name);
						setCity(_this._busStationCityList, queryOpts.bustation.city);
						break;
					case  KQueryType.busearch:
						updateInput(_this._boInputDom, queryOpts.busorig.name);
						updateInput(_this._bdInputDom, queryOpts.busdest.name);
						setCity(_this._busChangeCityList, queryOpts.busorig.city || queryOpts.busdest.city);
						break;
					case KQueryType.navsearch:
						updateInput(_this._noInputDom, queryOpts.navorig.name);
						updateInput(_this._ndInputDom, queryOpts.navdest.name);
						break;
				}
				KEvent.trigger(_this, "search", _this, _this.tab(), _this.secondcat(), _this._queryOptions);
				_this._setCookie();
				//
				var kqueryWidget = KManager.match(matchvalue, KQuery);
				if (kqueryWidget.length > 0) {
					if (_this._opts.preprocessFun) {
						var fun = _this._opts.preprocessFun.fun;
						var thisobj = _this._opts.preprocessFun.thisobj;
						kqueryWidget[0].query(fun.call(thisobj, _this._queryOptions));
					} else {
						kqueryWidget[0].query(_this._queryOptions);
					}
				}
				//
			});
		});
		
	}
};
/**
 * 
 * @param type  String  nls, nbl, nba, nnb 
 * @returns
 */
KSearchbox.prototype._getCity = function(type) {
	var city = "", opts = this._queryOptions;
	switch (type) {
		case "nnb":
		case "nls":
			if (opts.ls && opts.ls.city) {
				city = opts.ls.city;
			}
			if (!city) {
				if (type === "nnb" && opts.center && opts.center.city) {
					city = opts.center.city;
				}
			}
			break;
		case "nbl":
			if (opts.busline && opts.busline.city) {
				city = opts.busline.city;
			}
			break;
		case "nba":
			if (opts.bustation && opts.bustation.city) {
				city = opts.bustation.city;
			}
	}
	if (!city && opts.mapcity && opts.mapcity.name) {
		city = opts.mapcity.name;
	}
	return city;
};
/**
 * 
 * @param isBod
 *            Boolean bod
 * @returns String "a:a;a:a"
 */
KSearchbox.prototype._getBodOrNod = function(isBod) {
	var origKey = "", origCity = "", destKey = "", destCity = "", flag = "";
	if (isBod) {
		origKey = this._boInputDom.val();
		destKey = this._bdInputDom.val();
		flag = "bus";
	} else {
		origKey = this._noInputDom.val();
		destKey = this._ndInputDom.val();
		flag = "nav";
	}
	var opts = this._queryOptions;
	if (opts) {
		if (opts[flag + "orig"] && opts[flag + "orig"].city) {
			origCity = opts[flag + "orig"].city;
		} else if (opts.mapcity && opts.mapcity.name) {
			origCity = opts.mapcity.name;
		}
		if (opts[flag + "dest"] && opts[flag + "dest"].city) {
			destCity = opts[flag + "dest"].city;
		} else if (opts.mapcity && opts.mapcity.name) {
			destCity = opts.mapcity.name;
		}
	}
	return (origCity + ":" + origKey + ";" + destCity + ":" + destKey);
};
/**
 * 
 * @param str
 *            String
 * @returns Object
 */
KSearchbox.prototype._parseBodOrNodItem = function(str) {
	if (typeof str !=="string" || str.indexOf(":") === -1 || str.indexOf(";") === -1) {
		return;
	}
	var arr = str.split(";");
	var origArr = arr[0].split(":");
	var destArr = arr[1].split(":");
	return {
		origcity : origArr[0],//
		origkey : origArr[1],//
		destcity : destArr[0],//
		destkey : destArr[1]//
	};
};
/**
 * 
 * @param str
 *            String
 * @returns Object
 */
KSearchbox.prototype._parseNblItem = function(str) {
	if (typeof str !== "string" || str.indexOf(":") === -1) {
		return;
	}
	var arr = str.split(":");
	return {
		city:arr[0],//
		key:arr[1]//
	};
};
/**
 * cookie
 * @param str  String
 * @param hasCity Boolean false
 * @returns
 */
KSearchbox.prototype._parseNbItem = function(str, hasCity) {
	if (typeof str !== "string" || str.indexOf(":") === -1) {
		return;
	}
	var arr = str.split(":");
	return !hasCity ? {
		center : arr[0],// 
		key : arr[1]// 
	} : {
		city : arr[0],// 
		center : arr[1],// 
		key : arr[2]//
	};
};
/**
 * preprocessfun sumbit
 */
KSearchbox.prototype._updatePreprocessFun = function()
{
    var _this = this;
    if (this._opts.preprocessFun)
    {
        if (this._opts.autoquery)
        {
            var matchvalue = _this.tab().kvalue;
            switch (matchvalue)
            {
                case 'ls':
                    matchvalue = KWidgetFlag.localsearch;
                    break;
                case 'bs':
                    matchvalue = KWidgetFlag.busearch;
                    break;
                case 'navs':
                    matchvalue = KWidgetFlag.navsearch;
                    break;
                case 'ns':
                    matchvalue = KWidgetFlag.localsearch;
                    break;
                default :
            }
            var kqueryWidget = KManager.match(matchvalue, KQuery);
            if (kqueryWidget.length > 0)
            {
                var fun = _this._opts.preprocessFun.fun;
                var thisobj = _this._opts.preprocessFun.thisobj;
                kqueryWidget.query(fun.call(thisobj, _this.queryOptions()));
            }
        }
        else
        {

        }
    }
};
KSearchbox.prototype._initInputEvent = function()
{
    var _this = this;
    //
    //kcitylist
    //changejquerychange  intputonkeydown
    this._lsInputDom.change(function() {
        _this._initQueryOptions();
        if (_this._lcCityList != null)
        {
            _this._queryOptions.city = _this._lcCityList.city().name;
        }
        _this._queryOptions.keyword = $(this).val();
    });
    this._blInputDom.change(function() {

        if (_this._busLineCityList != null) {
            _this._queryOptions.city = _this._busLineCityList.city().name;
        }
        _this._queryOptions.keyword = $(this).val();
    });
    this._bzInputDom.change(function() {

        if (_this._busStationCityList != null) {
            _this._queryOptions.city = _this._busStationCityList.city().name;
        }
        _this._queryOptions.keyword = $(this).val();
    });
    this._boInputDom.change(function() {

        if (_this._busChangeCityList != null) {
            _this._queryOptions.city = _this._busChangeCityList.city().name;
        }
        _this._queryOptions.origname = $(this).val();
        _this._queryOptions.destname = this._bzInputDom.val().name;
    });
    this._bdInputDom.change(function() {
        _this._initQueryOptions();
        if (_this._busChangeCityList != null) {
            _this._queryOptions.city = _this._busChangeCityList.city();
        }
        _this._queryOptions.destname = $(this).val();
        _this._queryOptions.origname = this._boInputDom.val();
    });
    this._noInputDom.change(function() {
        _this._initQueryOptions();
        _this._queryOptions.origname = $(this).val();
        _this._queryOptions.destname = this._ndInputDom.val();
    });
    this._ndInputDom.change(function() {
        _this._initQueryOptions();
        _this._queryOptions.destname = $(this).val();
        _this._queryOptions.origname = this._noInputDom.val();
    });
    this._zcInputDom.change(function() {
        _this._initQueryOptions();
        if (_this._nbCityList != null) {
            _this._queryOptions.city = _this._nbCityList.city();
        }
        _this._queryOptions.centername = $(this).val();
        _this._queryOptions.centerlatlon = this._zkInputDom.val();
    });
    this._zkInputDom.change(function() {
        _this._initQueryOptions();
        if (_this._nbCityList != null) {
            _this._queryOptions.city = _this._nbCityList.city().name;
        }
        _this._queryOptions.centerlatlon = $(this).val();
        _this._queryOptions.centername = this._zcInputDom.val();
    });
};
/**
 * 
 */
KSearchbox.prototype._initQueryOptions = function()
{
    this._queryOptions = KTools.copyOptions({}, KQueryOptions);
};
KSearchbox.prototype._submitQuery = function() {
	var _this = this;
	if($("#bkbtn")){
		$("#bkbtn").show();
	}
	var queryOpts = _this._getCurrQueryOpts();
	if(!queryOpts || !queryOpts.type){
		return ;
	}
	var optCheck = this.options().check;
	if (typeof optCheck !== "number") {
		optCheck = 0;
	}
	var $input;
	var isAutoSearch=false, isOnlyTrigger=false;
	var valify = function(str){
		str = $.trim(str);
		if(!str || $.inArray(str, _this._tipArray)>-1){
			return false;
		}
		return true;
	};
	var isValidA, isValidB;
	//to check 
	switch (queryOpts.type) {
		case KWidgetFlag.localsearch:
			if (queryOpts.center) {//
				_this._nsFlag = true;
				isValidA = valify(queryOpts.center.name);
				isValidB = valify(queryOpts.ls.name);
				if(!isValidA){
					delete queryOpts.center;
				}
				if(!isValidB){
					delete queryOpts.ls;
				}
				switch (optCheck) {
					default:
					case 0:
						if (isValidA) {
							if (isValidB) {
								isAutoSearch = true;
							} else {
								$input = this._zkInputDom;
							}
						} else {
							$input = this._zcInputDom;
						}
						break;
					case 1:
						if(isValidA){
							if(isValidB){
								isAutoSearch = true;
							}else{
								$input = this._zkInputDom;
							}
						}else{
							if(isValidB){
								$input =this._zcInputDom;
							}else{
								isOnlyTrigger = true;
							}
						}
						break;
					case 2:
						if(isValidA && isValidB){
							isAutoSearch = true;
						}else{
							isOnlyTrigger = true;
						}
						break;
				}
			} else {//
				_this._lsFlag = true;
				isValidA = valify(queryOpts.ls.name);
				if(!isValidA){
					delete queryOpts.ls;
				}
				$input = this._lsInputDom;
				switch (optCheck) {
					default:
					case 0:
						isAutoSearch = isValidA;
						break;
					case 1:
					case 2:
						isAutoSearch = true;
						break;
				}
			}
			break;
		case KQueryType.busearch:
			_this._bsFlag = true;
			isValidA = valify(queryOpts.busorig.name);
			isValidB = valify(queryOpts.busdest.name);
			if(!isValidA){
				delete queryOpts.busorig;
			}
			if(!isValidB){
				delete queryOpts.busdest;
			}
			switch (optCheck) {
				default:
				case 0:
					if (isValidA) {
						if (isValidB) {
							isAutoSearch = true;
						} else {
							$input = this._bdInputDom;
						}
					} else {
						$input = this._boInputDom;
					}
					break;
				case 1:
					if(isValidA){
						if(isValidB){
							isAutoSearch = true;
						}else{
							$input = this._bdInputDom;
						}
					}else{
						if(isValidB){
							$input =this._boInputDom;
						}else{
							isOnlyTrigger = true;
						}
					}
					break;
				case 2:
					if(isValidA && isValidB){
						isAutoSearch = true;
					}else{
						isOnlyTrigger = true;
					}
					break;
			}
			break;
		case KQueryType.busline:
		    _this._blFlag = true;
			$input = this._blInputDom;
			isValidA = valify(queryOpts.busline.name);
			if(!isValidA){
				delete queryOpts.busline;
			}
			switch (optCheck) {
				default:
				case 0:
					isAutoSearch = isValidA;
					break;
				case 1:
				case 2:
					isAutoSearch = true;
					break;
			}
			break;
		case KQueryType.bustation:
		    _this._bstFlag = true;
			$input = this._bzInputDom;
			isValidA = valify(queryOpts.bustation.name);
			if(!isValidA){
				delete  queryOpts.bustation;
			}
			switch (optCheck) {
				default:
				case 0:
					isAutoSearch = isValidA;
					break;
				case 1:
				case 2:
					isAutoSearch = true;
					break;
			}
			break;
		case KQueryType.navsearch:
			_this._navsFlag = true;
			isValidA = valify(queryOpts.navorig.name);
			isValidB = valify(queryOpts.navdest.name);
			if(!isValidA){
				delete queryOpts.navorig;
			}
			if(!isValidB){
				delete queryOpts.navdest;
			}
			
			switch (optCheck) {
				default:
				case 0:
					if (isValidA) {
						if (isValidB) {
							isAutoSearch = true;
						} else {
							$input = this._ndInputDom;
						}
					} else {
						$input = this._noInputDom;
					}
					break;
				case 1:
					if(isValidA){
						if(isValidB){
							isAutoSearch = true;
						}else{
							$input = this._ndInputDom;
						}
					}else{
						if(isValidB){
							$input =this._noInputDom;
						}else{
							isOnlyTrigger = true;
						}
					}
					break;
				case 2:
					if(isValidA && isValidB){
						isAutoSearch = true;
					}else{
						isOnlyTrigger = true;
					}
					break;
			}
			break;
		default:
			return;
	}
	//
	this._queryOptions = queryOpts;
	if (isAutoSearch) {
		_this._updateAutoquery();
		KEvent.trigger(_this, "search", _this, _this.tab(), _this.secondcat(), _this.queryOptions());
	}else{
		if (isOnlyTrigger) {
			KEvent.trigger(_this, "search", _this, _this.tab(), _this.secondcat(), _this.queryOptions());
		}else{
			var msgId = KTools.showMsg("", {
				outside : true,
				//autoclose : 5,
				node : $input.get(0)
			});
			//KTools.showMsg()(focus)msgbox
//			window.setTimeout(function() {
//				$input.one("keydown", function(){
//					KTools.hideMsg(msgId);
//				});
//				$input.focus();
//			}, 100);
		}
	}
};
KSearchbox.prototype._updateCookie = function(name, cookie) {
	
	// """" cookie;
	if (cookie.indexOf("") > -1) {
		return;
	}
	for ( var i = 0; i < this._tipArray.length; i++) {
		if (cookie.indexOf(this._tipArray[i]) > -1) {
			return;
		}
	}
	var oldCookie = KTools.getCookie(name);
	if (oldCookie && oldCookie != null) {
		var arrCookie = oldCookie.split(this._CSPLIT);
		var length = arrCookie.length;
		//,cookie
		for ( var i = 0; i < length; i++) {
			if (arrCookie[i] == cookie) {
				arrCookie.splice(i,1);
			}
		}
		if(length > this._LCOOKIE){
			arrCookie.length = this._LCOOKIE;
		}
		if(length === this._LCOOKIE){
			arrCookie.splice(0,1);
		}
		arrCookie.push(cookie);
		KTools.setCookie(name, arrCookie.join(","), {expires:365});
	} else {
		KTools.setCookie(name, cookie, {expires:365});
	}
};


KSearchbox.prototype._mfgInputSelect = function()
{
    var _this = this;
    var length = this._mfgArray.length;
    var clickNum = 0;
    for (var i = 0; i < length; i++)
    {
        $("input[mfg='" + this._mfgArray[i] + "']", _this._domAll).focus(function() {
            var fg = $(this).attr("mfg");
            if (!_this._input[fg])
            {
                _this._input[fg] = fg;
                $(this).removeClass(_this.options().theme + KSearchbox.conf.CLASSNAME.GRAY).val("");
            }
            //##fix start chorme -- added by zwq
            var inputbox = $(this).get(0);
            var leg = inputbox.value.length ;
            if(inputbox.setSelectionRange){
            	inputbox = $(this).get(0);
            	inputbox.setSelectionRange(0,leg);
            }else if(inputbox.createTextRange){
            	var range = inputbox.createTextRange();
            	range.collapse(true);
            	range.moveStart("character",0);
            	range.moveEnd("character",leg);
            	range.select();
            }
            //## fix end
        }).blur(function(i)
        {
        	//  --added by zwq
        	clickNum = 0;
            if ($.trim($(this).val()) === "")
            {
                for (var j = 0; j < length; j++)
                {
                    if ($(this).attr("mfg") == _this._mfgArray[j])
                    {
                        $(this).addClass(_this.options().theme + KSearchbox.conf.CLASSNAME.GRAY).val(_this._tipArray[j]);
                        _this._input[$(this).attr("mfg")] = undefined;
                        break;
                    }
                }
            }
        }).click(function(){//##fix start chorme -- added by zwq
        	clickNum++;
        	var Sys = {};
        	var ua = navigator.userAgent.toLowerCase();
	        if (window.ActiveXObject)
	            Sys.ie = ua.match(/msie ([\d.]+)/)[1];
	        else if (document.getBoxObjectFor)
	            Sys.firefox = ua.match(/firefox\/([\d.]+)/)[1];
	        else if (window.MessageEvent && !document.getBoxObjectFor)
	        	try{
	        		Sys.chrome = ua.match(/chrome\/([\d.]+)/)[1];
	        	}catch(e){}
	        else if (window.opera)
	            Sys.opera = ua.match(/opera.([\d.]+)/)[1];
	        else if (window.openDatabase)
	            Sys.safari = ua.match(/version\/([\d.]+)/)[1];
	        if(Sys.chrome){
	        	if(clickNum>1){
	        		var intext = $(this).get(0).value;
	        		$(this).removeClass(_this.options().theme + KSearchbox.conf.CLASSNAME.GRAY).val("");
	        		$(this).removeClass(_this.options().theme + KSearchbox.conf.CLASSNAME.GRAY).val(intext);
	        		clickNum = 0;
	        	}
	        }
        });
        //##fix end
    }
};

KSearchbox.prototype._setnavbusValue = function()
{
    if (this.secondcat() && this.secondcat().kvalue == KQueryType.busearch)
    {
        if (this._input[this._noInputDom.attr("mfg")] && this._noInputDom.val() != ""
         && this._input[this._ndInputDom.attr("mfg")] && this._ndInputDom.val() != "" )
        {
        	if(!this._input[this._boInputDom.attr("mfg")]){
        		this._boInputDom.removeClass(this.options().theme + KSearchbox.conf.CLASSNAME.GRAY).val(this._noInputDom.val());
                this._input[this._boInputDom.attr("mfg")] = this._boInputDom.attr("mfg");
        	};
        	if(!this._input[this._bdInputDom.attr("mfg")]){
        		this._bdInputDom.removeClass(this.options().theme + KSearchbox.conf.CLASSNAME.GRAY).val(this._lsInputDom.val());
        		this._input[this._bdInputDom.attr("mfg")] = this._bdInputDom.attr("mfg");
        	};
        }else{
        	if(this._input[this._lsInputDom.attr("mfg")] && this._lsInputDom.val() != ""){
        		if(!this._bsFlag){
        			this._bdInputDom.removeClass(this.options().theme + KSearchbox.conf.CLASSNAME.GRAY).val(this._lsInputDom.val());
            		this._input[this._bdInputDom.attr("mfg")] = this._bdInputDom.attr("mfg");
        		};
        	};
        };
    }
    else if (this.tab() && this.tab().kvalue == KQueryType.navsearch)
    {
        if (this._input[this._boInputDom.attr("mfg")] && this._boInputDom.val() != ""
         && this._input[this._bdInputDom.attr("mfg")] && this._bdInputDom.val() != "")
        {
        	if(!this._input[this._noInputDom.attr("mfg")]){
        		this._noInputDom.removeClass(this.options().theme + KSearchbox.conf.CLASSNAME.GRAY).val(this._boInputDom.val());
                this._input[this._noInputDom.attr("mfg")] = this._noInputDom.attr("mfg");
        	};
            
        	if(!this._input[this._ndInputDom.attr("mfg")]){
        		this._ndInputDom.removeClass(this.options().theme + KSearchbox.conf.CLASSNAME.GRAY).val(this._bdInputDom.val());
        		this._input[this._ndInputDom.attr("mfg")] = this._ndInputDom.attr("mfg");
        	};
        }else{
        	if(this._input[this._lsInputDom.attr("mfg")] && this._lsInputDom.val() != ""){
        		if(!this._navsFlag){
        			this._ndInputDom.removeClass(this.options().theme + KSearchbox.conf.CLASSNAME.GRAY).val(this._lsInputDom.val());
            		this._input[this._ndInputDom.attr("mfg")] = this._ndInputDom.attr("mfg");
        		};
        	};
        };
    };
};
KSearchbox.prototype._setzkValue = function()
{
//	if(!this._input[this._zcInputDom.attr("mfg")]){
		if(this._input[this._lsInputDom.attr("mfg")] && this._lsInputDom.val() != "" ){
			this._zcInputDom.removeClass(this.options().theme + KSearchbox.conf.CLASSNAME.GRAY).val(this._lsInputDom.val());
		    this._input[this._zcInputDom.attr("mfg")] = this._zcInputDom.attr("mfg");
		}else{
			this._input[this._zcInputDom.attr("mfg")] = undefined;
		}
//	}
};

KSearchbox.prototype._setGrayImg = function(dom1)
{
    var dom = $(dom1);
    if (dom.attr("mfg") && !this._input[dom.attr("mfg")])  //
    {
        var name = dom.attr("src");
        var imgname = name.lastIndexOf(".");
        var newName = name.substring(0, imgname) + "_d" + name.substring(imgname);
        dom.attr("src", newName);
        this._input[dom.attr("mfg")] = dom.attr("mfg");
    }
};
KSearchbox.prototype._setbackImg = function(dom1)
{    
    var dom = $(dom1);
    if (dom.attr("mfg") && this._input[dom.attr("mfg")]) //
    {
        var name = dom.attr("src");
        var imgname = name.lastIndexOf(".");
        var newName = name.substring(0, imgname - 2) + name.substring(imgname);
        dom.attr("src", newName);
        this._input[dom.attr("mfg")] = undefined;
    }
};

KSearchbox.prototype._getImgDom = function(type) {
	var _this = this;
	switch (type) {
		case KQueryType.localsearch:
			var domArray = [];
			if (this._imgArray[0].length > 0) {
				domArray.push(this._imgArray[0]);
			}
			if (this._imgArray[5].length > 0) {
				domArray.push(this._imgArray[5]);
			}
			return domArray;
			break;
		case KQueryType.busearch:
			if (this._imgArray[3].length > 0) {
				return this._imgArray[3];
			}
			return [];
			break;
		case KQueryType.busline:
			if (this._imgArray[1].length > 0) {
				return this._imgArray[1];
			}
			return [];
			break;
		case KQueryType.bustation:
			if (this._imgArray[2].length > 0) {
				return this._imgArray[2];
			}
			return [];
			break;
		case KQueryType.navsearch:
			if (this._imgArray[4].length > 0) {
				return this._imgArray[4];
			}
			return [];
			break;
		/*
		 * case "ns": if (this._imgArray[5].length > 0) { return this._imgArray[5]; } return []; break;
		 */
		default:
			return [];
	}
};
KSearchbox.prototype._checkGrayImg = function()
{
    var _this = this;
	switch (_this.tab().kvalue) {
		case KWidgetFlag.localsearch:
			if (this._imgArray[0].length > 0 && !this._input[this._imgArray[0].attr("mfg")]) {
				return true;
			}
			return false;
			break;
		case KWidgetFlag.busearch:
			var secondcat = _this.secondcat().kvalue;
			if (secondcat == KQueryType.busearch) {
				if (this._imgArray[3].length > 0 && !this._input[this._imgArray[3].attr("mfg")]) {
					return true;
				}
			} else if (secondcat == KQueryType.busline) {
				if (this._imgArray[1].length > 0 && !this._input[this._imgArray[1].attr("mfg")]) {
					return true;
				}
			} else if (secondcat == KQueryType.bustation) {
				if (this._imgArray[2].length > 0 && !this._input[this._imgArray[2].attr("mfg")]) {
					return true;
				}
			}
			return false;
			break;
		case KWidgetFlag.navsearch:
			if (this._imgArray[4].length > 0 && !this._input[this._imgArray[0].attr("mfg")]) {
				return true;
			}
			return false;
			break;
		case "ns":
			if (this._imgArray[5].length > 0 && !this._input[this._imgArray[5].attr("mfg")]) {
				return true;
			}
			return false;
			break;
		default:
			return false;
	}
};
KSearchbox.prototype._getRequestParam = function(name,value)
{
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
    var r = value.substr(value.indexOf("\?") + 1).match(reg);
    if (r != null) return r[2];
    return null;
};
KSearchbox.prototype._gethashvalue = function(url)
{
        var hash = new KUrlHash();
        hash.setKey("s","json");
        hash.setKey("t",this._getRequestParam("t",url));
        hash.setKey("c",this._getRequestParam("c",url));
        if (url.indexOf("?") != -1)
        {
            var num = url.indexOf("?");
            url = url.substring(0, num);
        }
        return url +"?"+ hash.toString();
};
/**
 * ksearchbox.defaultdemo
 * 
 */
KSearchbox.prototype._supportDefaultDemo = function() {
	if (this._opts && this._opts.defaultdemo) {
		for ( var prop in this._opts.defaultdemo) {
			var cookie = KTools.getCookie(prop);
			if (!cookie) {
				KTools.setCookie(prop, this._opts.defaultdemo[prop]);
			}
		}
	}
};
KSearchbox.prototype._indexArray = function(arr, val) {
	for ( var i = 0; i < arr.length; i++) {
		if (arr[i] === val) {
			return i;
		}
	}
	return -1;
};

KSearchbox.prototype.setFirstTab = function() {
    //itab 0-ls,1-bs,2-navs,3-nb
    var _this = this;
    var hashurl = window.location.href + '';
    var nItab = hashurl.indexOf('#itab=');
    if(nItab < 0){
    	nItab = hashurl.indexOf('&itab=');
    }
    if(nItab >= 0){
    	nItab = nItab + 6;
    	var itabString = hashurl.substring(nItab);
        if(itabString.indexOf('&') == 1 || itabString.length == 1 ){
        	var itab = parseInt(hashurl.substring(nItab,(nItab + 1)));
        	if(itab < 4){
        		_this._firstTabs.select(itab);
        	}
        }
    }
};
/*
 
 songyr
 1.0
 2010-03-22
 2010-03-22 14:01
 ============================================
 
opt#1010081709
 mwpf
opt#1010251707
 finalize
opt#1010251759
_createKPOInfoObjectpoiname 
opt#1010251855
"opt#1010251759"
opt#1010251454

bug#1012091448
ie
 */
var KStationList = KClass.create("KStationList", KQuery);
KStationList.conf = {
	CLASSNAME : {
		SL : "_sl"// div
		,T : "_sl_t"// 
		,B : "_sl_b" // 
		,LST : "_lst"
		,EPT:"_sl_ept"
	}
};
/**
 * 
 * 
 * @param container
 *            DOMHTMLElement
 * @param opts
 *            KStationListOptions
 * @uncrunch
 */
KStationList.initialize = function(container, opts){
	var _this = this;
	//
	// opts
	this.setOptions(KStationListOptions);
	this.setOptions(opts);
	this.setTheme(this.options().theme);
	// add by zhangsq cylopts
	this._opts.cylopts = KTools.copyOptions(this._opts.cylopts, KCityListOptions);
	this._cssClassName = this._initCssName(this.options().theme);
	this._parsedData = {
		"s": undefined,
		"e": undefined
	};
	// this._hashkeys = [ "ac,oc,on,dc,dn,st,mc,qnav",
	// "ac,on,dn,st,mc,qbus,oid,did", "ac,on,dn,st,mc,qbus,ol,dl",
	// "ac,on,dn,st,mc,qbus,oid,did,ol,dl" ];
	// add by fuyg: mwpf _hashkeys
	_this._mwpf = KConfig.get("mwpf");
	_this._searchbox = opts.searchbox;
	//
	this._$dom = $(container);
	this._dom = this._$dom[0];
	var divs = this._$dom.children("div");
	this._listDiv = {
		"s": undefined,
		"e": undefined
	};
	this._msgBox = {
		"s": undefined,
		"e": undefined
	};
	_this._pageNumber = {
		"s": 1,
		"e": 1
	};
	_this._kCityListObjs = {
		"s": undefined,
		"e": undefined
	};
	_this._kCityListContainer = {
		"s": undefined,
		"e": undefined
	};
	_this._head = {
		"s": undefined,
		"e": undefined
	};
	//
	_this._selectedMarkers = {
		"s": undefined,
		"e": undefined,
		"currentSelected": undefined// marker, "s""e",_this._selectedMarkers.se
	};
	//
	this._noResult={
		"s":false,
		"e":false
	}
	
	//KCityListfalse
	_this._setCityFromInner = false;
	//
	this._selectedItemsInfo = {
		"orig": undefined,
		"dest": undefined
	};
	
	this._kCityListContainer["s"] = divs.eq(0);
	this._head["s"] = divs.eq(1).addClass(this._cssClassName.T);
	this._listDiv.s = divs.eq(2);
	this._msgBox.s = divs.eq(3).addClass(this._cssClassName.EPT);;
	//
	this._kCityListContainer["e"] = divs.eq(4);
	this._head["e"] = divs.eq(5).addClass(this._cssClassName.T);
	this._listDiv.e = divs.eq(6);
	this._msgBox.e = divs.eq(7).addClass(this._cssClassName.EPT);
	// init children's visiblity
	this._initChildVision();
	//
	this._isInnerSubmitBtn = false;
	this._submitBtn = this._opts.submitbtn;
	//
	if(!this._submitBtn){
		if (divs.eq(8).length) {
			this._submitBtn = divs.eq(8).addClass(this._cssClassName.B).find("input").eq(0);
			this._isInnerSubmitBtn = true;
		}
	}else{
		if (divs.eq(8).length) {
			divs.eq(8).hide();
		}
	}
	if (this._submitBtn) {
		KEvent.bind($(this._submitBtn), "click", function(){
			_this._triggerSelectDone();
		});
	}
	_this._kListObjs = {
		"s": undefined,
		"e": undefined
	};
	//
	_this._isSupportMap= !!_this._opts.mapcontainer;
	//
	_this._mapInitedFlag = false;
	if (_this._isSupportMap) {
		KEvent.bind(KMap, "mapinit", function(){
			_this._mapInitedFlag = true;
		});
		if (_this.options().initmap !== false && KMap.isInitialized(_this._opts.mapcontainer)===false) {
			KMap.init($(_this._opts.mapcontainer).get(0),{});
		}
	}
	this.layout();
};
/*******************************************************************************
 * KObject
 ******************************************************************************/
/**
 * 
 * 
 * @uncrunch
 */
KStationList.prototype.finalize = function() {
	KEvent.clear($(this._submitBtn), "click");
	this._clearAllMarkers("s");
	this._clearAllMarkers("e");
	if (this._$dom) {
		KEvent.clear(this._$dom);
		KEvent.clear(this._head["s"]);
		KEvent.clear(this._head["e"]);
		KEvent.clear(this._kCityListContainer["s"]);
		KEvent.clear(this._kCityListContainer["e"]);
		KEvent.clear(this._listDiv.s);
		KEvent.clear(this._listDiv.e);
		for ( var i in this._kListObjs) {
			if (this._kListObjs[i]) {
				KEvent.clear(this._kListObjs[i]);
				this._kListObjs[i].finalize();
				this._listDiv[i].removeClass().html("");
			}
		}
	}
	KQuery.prototype.finalize.apply(this);
};
/**
 * 
 * 
 * @uncrunch
 */
KStationList.prototype.clearResult = function() {
	var _this=this;
	this._clearAllMarkers("s");
	this._clearAllMarkers("e");
	this._result=undefined;
	this._parsedData = {
		"s": undefined,
		"e": undefined
	};
	for ( var i in this._listDiv) {
		KEvent.clear(this._listDiv[i]);
		if (this._listDiv[i]) {
			this._listDiv[i].removeClass().children().remove();
		}
		_this._kListObjs[i]=undefined;
	}
};
/*******************************************************************************
 * KWidget
 ******************************************************************************/
/**
 * 
 * 
 * @return String 
 * @uncrunch
 */
KStationList.prototype.version = function() {
	return "1.1.1";
};
/**
 * 
 * 
 * @return String
 * @uncrunch
 */
KStationList.prototype.cnname = function() {
	return "";
};
/**
 * 
 * 
 * @return KObject[]
 * @uncrunch
 */
KStationList.prototype.dependent = function(){
	return [KCityInfo, KCityList, KCityListOptions, KClass, KConfig, KEvent, KList, KListItem, KListener, KMap, KMarker, KNavsearch, KObject, KPOInfo, KPOInfoObject, KQuery, KQueryOptions, KQueryType, KStationListOptions, KTools, KUrlHash, KWidget, KWidgetFlag, jQuery];
};
/**
 * obj 
 * 
 * @param obj
 * @uncrunch
 */
KStationList.prototype.setOptions = function(obj) {
	this._opts = KTools.copyOptions(obj, this.options());
};
/**
 * 
 * 
 * @param scheme
 * @uncrunch
 */
KStationList.prototype.setTheme = function(scheme) {
	this._theme = scheme;
};
/**
 * @returns FLAG
 * @uncrunch
 */
KStationList.prototype.flag = function() {
	return KWidgetFlag.stationlist;
};
/**
 * 
 * 
 * @uncrunch
 */
KStationList.prototype.layout = function() {
	if (this.options().autoheight) {
		this._$dom.css("height", "");
		return;
	}
	var _bs = this.options().origarea;
	var _be = this.options().destarea;
	var allHeight = parseInt(this._$dom.css("height"));
	// var hr = ($(">hr", this._$dom).outerHeight() + 10) / 2 - 5;
	var hrHeight = ($(">hr", this._$dom).outerHeight(true) + 10) / 2 - 5;
	if (isNaN(allHeight)) {
		allHeight = this._$dom.height();
	}
	var sCityHeight = 0, eCityHeight = 0, sHeadHeight=0, eHeadHeight=0, sMargin=0, eMargin=0;
	if (_bs) {
		if (this._kCityListContainer["s"].is(":visible")) {
			sCityHeight = this._kCityListContainer["s"].outerHeight(true);
		}
		sHeadHeight = this._head["s"].outerHeight(true);
		sMargin = this._listDiv.s.outerHeight(true) - this._listDiv.s.height();
	}
	if (_be) {
		if (this._kCityListContainer["e"].is(":visible")) {
			eCityHeight = this._kCityListContainer["e"].outerHeight(true);
		}
		eHeadHeight = this._head["e"].outerHeight(true);
		eMargin = this._listDiv.e.outerHeight(true) - this._listDiv.e.height();
	}
	var btnHeight = 0;
	if (this._isInnerSubmitBtn) {
		btnHeight = this._submitBtn.parent().outerHeight(true);
	}
	if (_bs && _be) {
		var extraHeight = hrHeight + btnHeight;
		/****/
		var reduced = 4;
		if ($.browser.msie) {
			if (eCityHeight==0) {
				if (this._ieEngineVersion() < 8) {
					reduced = 10;
				}else{
					reduced=2;
				}
			} else {
				if (this._ieEngineVersion() < 8) {
					 reduced = 12;
				} else {
					reduced = 0;
				}
			}
		}
		/****/
		var valHeight = 0;
		if (this._msgBox.s.is(":hidden") && this._msgBox.e.is(":hidden")) {
			extraHeight += sMargin + eMargin + reduced;
			valHeight = allHeight - extraHeight - (sHeadHeight + sCityHeight + eHeadHeight + eCityHeight);
			valHeight = valHeight / 2 ;
			if(eCityHeight!=0&&sCityHeight!=0){
				if($.browser.msie){
					valHeight += 25;
				}else{
					valHeight += 30;
				}
			}
			this._listDiv.s.height(valHeight);
			this._listDiv.e.height(valHeight);
		} else if (this._msgBox.s.is(":visible") && this._msgBox.e.is(":hidden")) {
			extraHeight += (this._msgBox.s.outerHeight(true) - this._msgBox.s.height()) + eMargin + reduced;
			valHeight = allHeight - extraHeight - this._msgBox.s.outerHeight(true)
					- (sHeadHeight + sCityHeight + eHeadHeight + eCityHeight);
			this._listDiv.e.height(valHeight);
		} else if (this._msgBox.e.is(":visible") && this._msgBox.s.is(":hidden")) {
			extraHeight += (this._msgBox.e.outerHeight(true) - this._msgBox.e.height()) + sMargin + reduced;
			valHeight = allHeight - extraHeight - (sHeadHeight + sCityHeight + eHeadHeight + eCityHeight);
			valHeight = valHeight / 2;
			this._listDiv.s.height(valHeight);
		}
	} else {
		if (_bs) {
			this._listDiv.s.height(allHeight - sHeadHeight - sCityHeight - btnHeight - sMargin);
		}
		if (_be) {
			this._listDiv.e.height(allHeight - eHeadHeight - eCityHeight - btnHeight - eMargin);
		}
	}
	if (this._kCityListObjs["s"]) {
		this._kCityListObjs["s"].layout();
	}
	if (this._kCityListObjs["e"]) {
		this._kCityListObjs["e"].layout();
	}
};
/*******************************************************************************
 * KQuery
 ******************************************************************************/
/**
 * opts
 * 
 * @param opts
 *            KQueryOptions 
 * @uncrunch
 */
KStationList.prototype.query = function(opts) {
	opts = $.extend(true, {}, opts);
	var _this = this;
	if (opts.type !== KQueryType.busearch && opts.type !== KQueryType.navsearch) {
		return;
	}
	//
	var orig, dest, st, mc;
	_this._selectedItemsInfo = {
		"orig" : undefined,
		"dest" : undefined
	};
	_this._pageNumber = {
		"s" : 1,
		"e" : 1
	};
	//
	if (opts.type === KQueryType.busearch) {
		origInfo = opts["busorig"];
		destInfo = opts["busdest"];
		mc = (typeof opts.city == "undefined") ? origInfo.city : opts.city;
	} else {
		origInfo = opts["navorig"];
		destInfo = opts["navdest"];
		mc = (typeof opts.mapcity == "undefined") ? destInfo.city : opts.mapcity.name;
	}
	//
	_this._queryopts = opts;
	//() 
	KQuery.prototype.query.call(_this, _this._queryopts);
	this._updateSearchbox();
	var urlHash= _this._createUrlHashByQueryOpts(_this._queryopts);
	_this._requestData(urlHash);
};
/**
 * Hash
 * 
 * @param hash
 *            KUrlHash 
 * @uncrunch
 */
KStationList.prototype.queryByHash = function(hash) {
	var hash = hash.clone();
	var opts = KTools.copyOptions( {}, KQueryOptions);
	opts.type = this.options().querytype;
	var orig, dest;
	if (opts.type === KQueryType.busearch) {
		orig = "busorig";
		dest = "busdest";
	} else if (opts.type === KQueryType.navsearch) {
		orig = "navorig";
		dest = "navdest";
	} else {
		KTools.showMsg("querytype");
		return;
	}
	opts[orig] = KTools.copyOptions( {}, KPOInfo);
	opts[dest] = KTools.copyOptions( {}, KPOInfo);
	opts[orig].city = hash.value("oc");
	opts[orig].name = hash.value("on");
	opts[orig].pid = hash.value("oid");
	opts[orig].latlon = hash.value("ol");
	opts[dest].city = hash.value("dc");
	opts[dest].name = hash.value("dn");
	opts[dest].pid = hash.value("did");
	opts[dest].latlon = hash.value("dl");
	opts.city = hash.value("mc");
	this.query(opts);
};
/*******************************************************************************
 * 
 ******************************************************************************/
/**
 * @uncrunch
 */
KStationList.prototype.showNoResultTip = function(arrDom){
    if (!arrDom || !arrDom.length) {// 
        return;
    }
    if (!(this._noResult.s || this._noResult.e)) {//
        return;
    }
    var i,  s = this._noResult.s, e = this._noResult.e, len = arrDom.length;
    if (s && e) {
        for ( i = 0; i < len; i++) {
            this._showMsgTip(arrDom[i]);
        }
    } else if (s) {
        this._showMsgTip(arrDom[0])
    } else if (e) {
        this._showMsgTip(arrDom[1] || arrDom[0]);
    }
	
};


/*******************************************************************************
 * 
 ******************************************************************************/
/**
 * @param opts
 * @returns {KUrlHash}
 */
KStationList.prototype._createUrlHashByQueryOpts = function(opts) {
	var _this = this, mc;
	var urlHash = new KUrlHash();
	if (opts.type === KQueryType.busearch) {
		origInfo = opts["busorig"];
		destInfo = opts["busdest"];
		urlHash.setKey("ac", "bus");
		urlHash.setKey("st", "b");
		urlHash.setKey("qbus", "1");
		mc = (!opts.city) ? origInfo.city : opts.city;
	} else if(opts.type === KQueryType.navsearch){
		origInfo = opts["navorig"];
		destInfo = opts["navdest"];
		urlHash.setKey("ac", "nav");
		urlHash.setKey("st", "n");
		urlHash.setKey("qnav", "1");
		urlHash.setKey("oc", origInfo.city);
		urlHash.setKey("dc", destInfo.city);
		mc = (!opts.mapcity || !opts.mapcity.name) ? destInfo.city : opts.mapcity.name;
	}
	urlHash.setKey("mc", mc);
	var onValue =_this._latlonPidName(origInfo);
	var dnValue =_this._latlonPidName(destInfo);
	urlHash.setKey("on", onValue);
	urlHash.setKey("dn", dnValue);
	//
	if (origInfo.name && (origInfo.name !== onValue)) {
		urlHash.setKey("os", origInfo.name);
	}
	if(destInfo.name && (destInfo.name !== dnValue)){
		urlHash.setKey("ds", destInfo.name);
	}
	urlHash.setKey(_this._mwpf, _this.flag());
	return urlHash;
};

/**
 * ajax request 
 * 
 * @param hash
 *            KUrlHash
 * @param soe
 *            "s""e", "s""e", 
 * @param pageNumber
 *            {Integer} 
 * @returns {String} Url
 */
KStationList.prototype._createRequestUrl = function(hash, soe, pageNumber) {
	var _this = this;
	hash = hash.clone();
	var bs = "true", be = "true";
	if (soe === "s") {
		be = "false";
	} else if (soe === "e") {
		bs = "false";
	}
	var rn = _this.options().pagesize;
	var mapc = $(_this.options().mapcontainer);
	var w, h;
	if (mapc) {
		w = mapc.width();
		h = mapc.height();
	}
	hash.setKey("bs", bs);
	hash.setKey("be", be);
	hash.setKey("pn", pageNumber + "");
	hash.setKey("rn", rn + "");
	hash.setKey("w", w + "");
	hash.setKey("h", h + "");
	return _this.options().url + "&" + hash.toString();
};
/**
 * 
 * @param {Boolean} isAutoSelect
 */
KStationList.prototype._triggerResultShown = function(isAutoSelect) {
	var _this = this;
	KEvent.trigger(_this, "resultshown", _this, "query", _this._result, (this._noResult.s || this._noResult.e));
	//
	var isVisible = false;
	if (isAutoSelect) {
		isVisible = false;
	} else {
		var sd_l = 0, ed_l = 0;
		if (_this._kListObjs.s)
			sd_l = _this._kListObjs.s.items().length;
		if (_this._kListObjs.e)
			ed_l = _this._kListObjs.e.items().length;
		if (_this.options().origarea && _this.options().destarea) {
			isVisible = (sd_l > 0 && ed_l > 0);
		} else if (_this.options().origarea) {
			isVisible = sd_l > 0;
		} else if (_this.options().destarea) {
			isVisible = ed_l > 0;
		}
	}
	//
	KEvent.trigger(_this, "submitbtn", _this, isVisible);
};
/**
 * query()
 * @param {KUrlHash} urlHash
 */
KStationList.prototype._requestData = function(urlHash) {
	var _this = this;
	KEvent.trigger(_this, "searchbefore", _this, _this._queryopts);
	$.ajax( {
		type : "GET",
		url : _this._createRequestUrl(urlHash, false, 1),
		success : function(data) {
			if (!data || !data.m) {
				return;
			}
			//
			KEvent.trigger(_this, "resultloaded", _this, "query", data);
			//
			var isAutoSelect = false;
			if (_this.options().autoselect !== false && data && data.as) {
				isAutoSelect = (parseInt(data["as"], 10) === 1) ? true : false;
				var isEqual = false;// 
				try {
					isEqual = (data.s.d[0].c === data.e.d[0].c);
				} catch (ex) {
					isEqual = false;
				}
				if (isEqual) {
					isAutoSelect = false;
				}
				if(!!_this.options().samecity){
					var isSameCity=false;
					try {
						isSameCity = (data.s.e === data.e.e);
					} catch (ex) {
						isSameCity = false;
					}
					if (isSameCity !== true) {
						isAutoSelect = false;
					}
				}
			}
			//mapHTML,
			_this.clearResult();
			_this._result = data;
			_this._dataToDom(data, isAutoSelect);
		},
		error : function() {
			if (!_this._isMapInitialized()) {
				KEvent.trigger(_this, "mapready", _this, undefined, undefined);
			}
		},
		dataType : "json"
	});
};
/**
 * 
 * @param {KUrlHash} urlHash
 * @param {String} soe
 */
KStationList.prototype._requestDataForCityChanged = function(urlHash, soe) {
	var _this = this;
	$.ajax( {
		type : "GET",
		url : _this._createRequestUrl(urlHash, soe, 1),
		success : function(data) {
			if (!data || !data.m) {
				return;
			}
			var dataArr = data[soe].d;
			//
			var listItems = _this._handleData(dataArr, 0);
			_this._parsedData[soe] = listItems;
			_this._result[soe]= data[soe];
			//urlhash
			_this._changeHashAction();
			//KList
			var j, node, obj;
			var objKList = _this._kListObjs[soe];
			objKList.clearResult();
			for (j = 0; j < listItems.length; j++) {
				obj = listItems[j];
				obj.deletable = false;
				obj.editable = false;
				obj.selected = false;
				node = $(obj.node);
				obj.text = node.children("label").html();
				obj.iconClass = node.children("span").eq(1).attr("class");
				objKList.insert(obj);
			}
			//marker
			var $soeInput=_this._head[soe].find("input:checkbox");
			if($soeInput.is(":checked")){
				if (objKList.items().length == 0) {
					$soeInput.attr("checked", false);
					return;
				}
				_this._clearAllMarkers(soe);
				_this._addMarkersByCheckBox(soe);
			}
			objKList.select(0);	
			//KCityList
			_this._setCityName(soe, data[soe].e);
		},
		error : function() {
			if (!_this._isMapInitialized()) {
				KEvent.trigger(_this, "mapready", _this, undefined, undefined);
			}
		},
		dataType : "json"
	});
};
/**
 * Maker
 * @param {KUrlHash} urlHash
 * @param {String} soe
 */
KStationList.prototype._requestDataForDrag = function(urlHash, soe) {
	var _this = this;
	$.ajax( {
		type : "GET",
		url : _this._createRequestUrl(urlHash, soe, 1),
		success : function(data) {
			if (!data || !data[soe] ||data[soe].d.length<1) {
				return;
			}
			var firstItem = data[soe].d[0];
			_this._updateLabelContent(_this._selectedMarkers[soe], firstItem.n);
			//
			var dataArr = data[soe].d;
			var latlon = dataArr[0].c;
			//Marker
			_this._selectedMarkers[soe].setLatlon(latlon);
			// event "locationchanged" event
			var poinfo = _this._createKPOInfoObject(dataArr[0].n, dataArr[0].c, dataArr[0].d, data[soe].e, dataArr[0].t);
			var which = (soe === "s") ? "orig" : "dest";
			KEvent.trigger(_this, "locationchanged", _this, which, poinfo);
			// 
			if (_this._queryopts.type === KQueryType.busearch) {
				_this._queryopts[(soe === "s") ? "busorig" : "busdest"].name = dataArr[0].n;
			} else if (_this._queryopts.type === KQueryType.navsearch) {
				_this._queryopts[(soe ==="s" ) ? "navorig" : "navdest"].name = dataArr[0].n;
			}
			_this._changeHashAction();
			//KList	
			var listItems = _this._handleData(dataArr, 0);
			_this._parsedData[soe] = listItems;
			_this._result[soe] =  data[soe];
			var j, node, obj;
			var objKList = _this._kListObjs[soe];
			$(objKList.dom()).find("ul>div").hide();
			objKList.clearResult();
			for (j = 0; j < listItems.length; j++) {
				obj = listItems[j];
				obj.deletable = false;
				obj.editable = false;
				obj.selected = false;
				node = $(obj.node);
				obj.text = node.children("label").html();
				obj.iconClass = node.children("span").eq(1).attr("class");
				objKList.insert(obj);
			}
			_this._isDragEnd = true;
			objKList.select(0);
			// update KCityList Object
			_this._setCityName(soe, data[soe].e);
		},
		error : function() {
			if (!_this._isMapInitialized()) {
				KEvent.trigger(_this, "mapready", _this, undefined, undefined);
			}
		},
		dataType : "json"
	});
};
/**
 * KListItem[]
 * @param {Array} data
 * @param {Number} index
 * @return {KListItem[]}
 */
KStationList.prototype._handleData = function(data, index) {
	var listItems = [], item, temp;
	for ( var i = 0, j = data.length + index; index < j; index++, i++) {
		item = KTools.copyOptions( {}, KListItem);
		item.index = index;
		temp = data[i];
		item.name = temp.n;
		item.kvalue = temp.c;
		item.node = temp.e;
		item.type = temp.t;
		item.pid = temp.d;
		listItems.push(item);
	}
	return listItems;
};

/**
 *  
 * 
 * @param data
 *            JSON
 * @param isAutoSelect
 *            {Boolean}
 */
KStationList.prototype._dataToDom = function(data, isAutoSelect){
	var _this = this;
	var latlon = data["m"].a;
	var zoomLevel = data["m"].b;
	//
	this._noResult.s=false;
	this._noResult.e=false;
	var conf = this.options();
    if (conf.origarea && (!data.s || !data.s.d || !data.s.d.length)) {
        this._noResult.s=true;
    }
    if (conf.destarea && (!data.e || !data.e.d || !data.e.d.length)) {
        this._noResult.e=true;
    }
	//noresults event
//	if(this._noResult.s || this._noResult.e){
//		KEvent.trigger(this, "noresults", this);
//	}
    if (conf.simplenoresult === true && (this._noResult.s || this._noResult.e)) {
   // if (true && (this._noResult.s || this._noResult.e)) {
        this._simpleNoResult();
        return;
    }
	
	if (isAutoSelect === false) {
		if (_this.options().origarea) {
			_this._updateDomBySoeData(data, "s");
			if (_this._isSupportMap) {
				_this._bindCheckBoxBySoe("s");
			}
		}
		if (_this.options().destarea) {
			_this._updateDomBySoeData(data, "e");
			if (_this._isSupportMap) {
				_this._bindCheckBoxBySoe("e");
			}
		}
		if (_this._isSupportMap) {//map
			if (!_this._isMapInitialized()) {//
				KEvent.bind(KMap, "mapinit", function(){
					KEvent.unbind(KMap, "mapinit", arguments.callee);
					for (var i in _this._kListObjs) {
						if (_this._kListObjs[i] && _this._kListObjs[i].select) {
							_this._kListObjs[i].select(0);
						}
					}
				});
				KEvent.trigger(_this, "mapready", _this, new MPoint(latlon || ""), zoomLevel || 8);
			} else {
				KMap.setCenter(latlon, zoomLevel);
				for (var i in _this._kListObjs) {
					if (_this._kListObjs[i] && _this._kListObjs[i].select) {
						_this._kListObjs[i].select(0);
					}
				}
			}
		} else {//map
			for (var i in _this._kListObjs) {
				if (_this._kListObjs[i] && _this._kListObjs[i].select) {
					_this._kListObjs[i].select(0);
				}
			}
		}
		if (!(this._noResult.s || this._noResult.e)) {//
			_this._initChildVision();
		}
		_this.layout();
		//
		_this._changeHashAction();
		//
		_this._triggerResultShown(isAutoSelect);
	} else {
		var item;
		if (_this.options().origarea) {
			item = data.s.d[0];
			_this._selectedItemsInfo["orig"] = _this._createKPOInfoObject(item.n, item.c, item.d, data.s.e, item.t);
		}
		if (_this.options().destarea) {
			item = data.e.d[0];
			_this._selectedItemsInfo["dest"] = _this._createKPOInfoObject(item.n, item.c, item.d, data.e.e, item.t);
		}
		_this._triggerSelectDone();
	}
};

KStationList.prototype._simpleNoResult=function(){
	/**UI**/
	var errorMsg, place, city;
	var s = this._noResult.s, e = this._noResult.e, opts = this._queryopts;
    if (s && e) {
        place = "";
    } else if (s) {
        place = "";
    } else if (e) {
        place = "";
    }
    if (opts.type === KQueryType.busearch) {
        city = (opts.mapcity && opts.mapcity.name) || (opts.busorig && opts.busorig.city) || (opts.busdest && opts.busdest.city) || opts.city || "";
        errorMsg = "<p style='font-size:14px;'><strong>" + city + "</strong>" + place + "</p><p style='color:#454545'></p>";
    } else if (opts.type === KQueryType.navsearch) {
        errorMsg = "<p style='font-size:14px;'>" + place + "</p><p style='color:#454545'></p>";
    } else {
        return;
    }
	this._msgBox.e.html(errorMsg).prevAll().hide().end().show();
	/**url**/
	this._changeHashAction()
	/****/
	KEvent.trigger(this, "resultshown", this, "query", this._result, (this._noResult.s || this._noResult.e));
	/**showNoResultTip()**/
	
}
/**
 * 
 * 
 * @param data
 * @param soe
 */
KStationList.prototype._updateDomBySoeData = function(data, soe) {
	var _this = this;
	var counter = data[soe].a;
	counter = parseInt(counter, 10);
	var arrData = data[soe].d;
	//
	_this._head[soe].find("input:checkbox").attr("checked", false);
	_this._updateObjKCityList(data, soe);
	_this._updateObjKList(arrData, soe, counter);
	_this._kListObjs[soe].select(0);
};
/**
 * query()KCityList
 * @param {Object} data
 * @param {String} soe
 */
KStationList.prototype._updateObjKCityList = function(data, soe) {
	var _this = this;
	var reSoe = (soe === "s") ? "e" : "s";
	var areaFlag = (soe === "s") ? "origarea" : "destarea";
	var navFlag = (soe === "s") ? "navorig" : "navdest";
	var busFlag = (soe === "s") ? "busorig" : "busdest";
	//
	if (this._opts.citylist && (!!_this.options()[areaFlag])) {
		this._cityIndex = 10;
		var city = data[soe].e;
		if (!city) {
			city = "";
		}
		if (!this._kCityListObjs[soe]) {
			this._opts.cylopts.defcity.name=city;
			this._kCityListObjs[soe] = new KCityList(this._kCityListContainer[soe], this._opts.cylopts);
			KEvent.bind(this._kCityListObjs[soe], "beforeopenhotcity", function(evt, widget) {
				widget.dom().css( {
					"z-index" : _this._cityIndex++
				});
				if (_this._kCityListObjs[reSoe]) {
					_this._kCityListObjs[reSoe].hideHotCity();
				}
			});
			KEvent.bind(this._kCityListObjs[soe], "citychanged", function(data, obj, curCityInfo, oldCityInfo) {
				if (_this._setCityFromInner === true) {
					_this._setCityFromInner = false;
					return;
				}
				var cityName = curCityInfo.name;
				if (oldCityInfo.name === cityName) {
					return;
				}
				//
				if (_this._queryopts.type == KQueryType.navsearch) {
					_this._queryopts[navFlag].city = cityName;
				} else if (_this._queryopts.type == KQueryType.busearch) {
					_this._queryopts[busFlag].city = cityName;
				}
				//
				var urlHash = _this._createUrlHashByQueryOpts(_this._queryopts);
				_this._pageNumber[soe]=1;
				_this._requestDataForCityChanged(urlHash, soe);
			});
		} else {
			_this._setCityName(soe, city);
		}
	}
};
/**
 * query()KList
 * @param {Array} arr
 * @param {String} soe
 * @param {Number} sum
 */
KStationList.prototype._updateObjKList = function(arr, soe, sum) {
	var _this = this;
	_this._parsedData[soe] = _this._handleData(arr, 0);
	
	if (!_this._kListObjs[soe]) {
		var $listDiv = _this._listDiv[soe];
		$listDiv.html("").addClass(_this._cssClassName.LST);
		$("<ul/>").appendTo($listDiv).html(_this._parseDataToNode(_this._parsedData[soe]));
		$listDiv.children().append(
				"<div class=\"mwp_sl_m\"><a href=\"javascript:void(0);\"><span>&gt;&gt;</span></a></div>");
		var $origMoreBtn = $listDiv.find("ul>div>a").eq(0);
		KEvent.bind($origMoreBtn, "click", _this._clickMoreHandler, {
			soe : soe,
			obj : this
		});
		var objKList = new KList($listDiv.get(0), {
			sortable : false,
			multiple : false,
			deselect : false,
			scroll2view : false
		});
		_this._kListObjs[soe] = objKList;
		_this._bindSelect(objKList, soe);
	} else {
		var j, node, obj;
		_this._kListObjs[soe].clearResult();
		for (j = 0; j < _this._parsedData[soe].length; j++) {
			obj = _this._parsedData[soe][j];
			obj.deletable = false;
			obj.editable = false;
			obj.selected = false;
			node = $(obj.node);
			obj.text = node.children("label").html();
			obj.iconClass = node.children("span").eq(1).attr("class");
			_this._kListObjs[soe].insert(obj);
		}
	}
	if (arr.length < 1) {
		_this._listDiv[soe].hide();
		_this._msgBox[soe].show();
	} else {
		_this._listDiv[soe].show();
		_this._msgBox[soe].hide();
	}
	if (sum <= _this.options().pagesize) {// don't show more button
		$(_this._kListObjs[soe].dom()).find("ul>div").hide();
	} else {
		$(_this._kListObjs[soe].dom()).find("ul>div").show();
	}
};

/**
 * soechechbox
 * @param {String} soe
 */
KStationList.prototype._bindCheckBoxBySoe = function(soe){
	var _this = this;
	var reSoe = (soe === "s") ? "e" : "s";
	var $soeInput = _this._head[soe].find("input");
	var $reSoeInput = false;
	if (_this._head[reSoe]) {
		$reSoeInput = _this._head[reSoe].find("input");
	}
	KEvent.clear($soeInput, "click");
	KEvent.bind($soeInput, "click", function(){
		if ($reSoeInput && $reSoeInput.length && $reSoeInput.is(":checked")) {
			$reSoeInput.attr("checked", false);
			_this._clearNormalMarkers(reSoe);
		}
		if (!$soeInput.is(":checked")) {
			_this._clearNormalMarkers(soe);
		} else {
			if (_this._kListObjs[soe].items().length == 0) {
				$soeInput.attr("checked", false);
				return;
			}
			_this._clearAllMarkers(soe);
			_this._addMarkersByCheckBox(soe);
		}
	});
};
/**
 * checkboxmarker
 * @param {String} soe
 */
KStationList.prototype._addMarkersByCheckBox = function(soe) {
	var _this = this;
	//
	var selectedItem = _this._kListObjs[soe].selected()[0];
	var selectedItemIndex = (selectedItem ? selectedItem.index : 0);
	//
	var tempMarkers = [];
	var markerData = _this._parsedData[soe];
	var markerDataLength = markerData.length;
	//
	var marker, latlon, markerDataItem;
	for (index=0; index < markerDataLength; index++) {
		markerDataItem = markerData[index];
		latlon = markerDataItem.kvalue || "";
		if (markerDataItem.index === selectedItemIndex) {
			_this._clearSoeMarkers(soe);
			marker = _this._createSoeMarker(soe, latlon, markerDataItem.name, index);
			_this._selectedMarkers[soe] = marker;
		} else {
			marker = _this._createNormalMarker(soe, latlon, index);
		}
		markerDataItem.marker = marker;
		tempMarkers.push(marker);
	}
	// to create soe markers
	KMap.addMarkers(tempMarkers);
	_this._selectedMarkers[soe].hilite();
	for (index = 0; index < tempMarkers.length; index++) {
		KEvent.bind(tempMarkers[index], "click", _this._markerClickHandler, {
			mk : tempMarkers[index],
			t : soe
		}, _this);
	}
	KEvent.trigger(_this._kListObjs[soe], "selectchanged");
};
/**
 * soemarkergroup
 * @param {String} soe
 * @return {String} 
 */
KStationList.prototype._normalMarkerGroup = function(soe) {
	return (this.flag() + "_" + soe + "_sel");
};
/**
 * soemarkerKMarkerOptions 
 * @param {String} soe
 * @return {KMarkerOptions} 
 */
KStationList.prototype._normalMarkerOpts = function(soe) {
	var markerOpts = KConfig.get("mk_mo_sd", {
		t : soe
	});
	markerOpts.label = null;
	markerOpts.icon.shadow="";
	markerOpts.group = this._normalMarkerGroup(soe);
	return markerOpts;
};
/**
 * marker
 * @param {String} soe
 * @param {String} latlon
 * @param {Integer} index
 * @return {KMarker}
 */
KStationList.prototype._createNormalMarker = function(soe, latlon, index) {
	var _this = this;
	var marker = new KMarker(latlon, _this._normalMarkerOpts(soe));
	marker._liIndex = index;
	return marker;
};
/**
 * soeMarkergroup
 * @param {String} soe
 * @return {String} 
 */
KStationList.prototype._soeMarkerGroup = function(soe) {
	return (this.flag() + "_" + soe);
};
/**
 * soeMarkerKMarkerOptions 
 * @param {String} soe
 * @param {String} name
 * @return {KMarkerOptions} 
 */
KStationList.prototype._soeMarkerOpts = function(soe, name) {
	name = (typeof name === "undefined") ? "" : name;
	var markerOpts = KConfig.get("mk_mo_sdt", {
		n : name,
		t : soe
	});
	markerOpts.group = this._soeMarkerGroup(soe);
	return markerOpts;
};
/**
 * soeMarker
 * @param {String} soe
 * @param {String} latlon
 * @param {String} name
 * @param {Integer} listItemIndex
 * @return {KMarker}
 */
KStationList.prototype._createSoeMarker = function(soe, latlon, name, listItemIndex) {
	var _this = this;
	var marker = new KMarker(latlon, _this._soeMarkerOpts(soe, name));
	marker._liIndex = listItemIndex;
	_this._selectedMarkers[soe] = marker;
	_this._selectedMarkers.currentSelected = soe;
	return marker;
};
/**
 * marker
 * @param {Object} eventinfo
 */
KStationList.prototype._markerClickHandler = function(eventinfo){
	var _this = this;
	var marker = eventinfo.data.mk;
	var soe = eventinfo.data.t;
	if (marker.group() === _this._normalMarkerGroup(soe)) {
		_this._kListObjs[soe].select(marker._liIndex);
	}
};
/**
 * 
 * @param data
 *            {KListItem[]}
 * @return {String} HTML
 */
KStationList.prototype._parseDataToNode = function(data) {
	var nodes = [];
	for ( var j = 0; j < data.length; j++) {
		nodes.push(data[j].node);
	}
	return nodes.join("");
};

/**
 *  KList
 * @param {KList} objKList
 * @param {String} soe
 */
KStationList.prototype._bindSelect = function(objKList, soe) {
	var _this = this;
	var changedHandler = function(event, list, item) {
		var soe = event.data;
		if (!item) {// KEvent.trigger"selectchanged"item
			item = _this._kListObjs[soe].selected()[0];
			if (!item) {//
				item = _this._kListObjs[soe].item(0);
			}
		}
		var marker, latlon = item.kvalue || "";
		var index = item.index;
		var name = _this._result[soe].d[index].n;
		var listItem = _this._parsedData[soe][index];
		if (_this._isSupportMap&&_this._isMapInitialized()) {//
			if (_this._head[soe].find("input:checkbox").is(":checked")) {
				if (_this._isDragEnd !== true) {
					var oldMarker = _this._selectedMarkers[soe];
					oldMarker.setEditable(false);
					oldMarker.setOptions(_this._normalMarkerOpts(soe));
					var selectedMarker = listItem.marker;
					selectedMarker.setOptions(_this._soeMarkerOpts(soe, name));
					selectedMarker.hilite();
					_this._bindDragForMarker(selectedMarker, soe);
					selectedMarker.setEditable(true);
					_this._selectedMarkers[soe] = selectedMarker;
					_this._mapFitZoom();
					var $liDom = $(item.node);
					KTools.scrollIntoView($liDom, $liDom.parent().parent(), "fast");
				} else {
					_this._isDragEnd = false;
				}
			} else {
				if (_this._isDragEnd !== true) {
					_this._clearSoeMarkers(soe);
					marker = _this._createSoeMarker(soe, latlon, name, index);
					KMap.addMarker(marker);
					marker.hilite();
					_this._bindDragForMarker(marker, soe);
					marker.setEditable(true);
					_this._mapFitZoom();
				} else {
					_this._isDragEnd = false;
				}
			}
		}
		var _key = (soe === "s") ? "orig" : "dest";
		var dataItem = _this._parsedData[soe][index];
		var info = _this._createKPOInfoObject(dataItem.name, dataItem.kvalue, dataItem.pid, _this._result[soe].e,
				dataItem.type);
		_this._selectedItemsInfo[_key] = info;
		/**-----start---KNavsearch KBusearch 1.01.0**/
		//KEvent.trigger(_this, "selectchanged", _this, info);
		KEvent.trigger(_this, "selectchanged", _this);
		/**-----end---KNavsearch KBusearch 1.01.0**/
	};
	if (_this._kListObjs && _this._kListObjs[soe]) {
		KEvent.unbind(_this._kListObjs[soe], "selectchanged");
	}
	KEvent.bind(objKList, "selectchanged", changedHandler, soe);
	this._kListObjs[soe] = objKList;
};
/**
 * KPOInfo
 * @param {String} name
 * @param {String} latlon
 * @param {String} pid
 * @param {String} city
 * @param {String} type
 * @return {KPOInfo}
 */
KStationList.prototype._createKPOInfoObject = function(name, latlon, pid, city, type) {
	var info = KTools.copyOptions( {}, KPOInfo);
	info.name = name;
	info.latlon = latlon;
	info.pid = pid;
	info.city = city;
	if (typeof type !== "number") {
		type = parseInt(type, 10);
		type = isNaN(type) ? KPOInfo.type : type;
	}
	info.type = type;
	return info;
};
/**
 * Marker
 * @param {KMarker} marker
 * @param {String} soe
 */
KStationList.prototype._bindDragForMarker = function(marker, soe) {
	var _this = this;
	if (!marker._sl_bind_drag) {//
		marker._sl_bind_drag=true;
		KEvent.bind(marker, "dragstart", _this._dragStartMarker, soe, _this);
		KEvent.bind(marker, "dragend", _this._dragEndMarker, soe, _this);
	}
};
/**
 * dragstart
 * @param {Object} eventInfo
 * @param {KMarker} marker
 */
KStationList.prototype._dragStartMarker = function(eventInfo, marker) {
	var _this = this;
	var soe = eventInfo.data;
	_this._selectedMarkers[soe] = marker;
	_this._selectedMarkers["currentSelected"] = soe;
	KMap.clearMarker(_this._normalMarkerGroup(soe));
	_this._head[soe].find("input:checkbox").attr("checked", false);
};
/**
 * dragend
 * @param {Object} eventInfo
 * @param {KMarker} marker
 * @param  {MPoint} point
 * @param  {String} name
 */
KStationList.prototype._dragEndMarker = function(eventInfo, marker, point, name) {
	var _this = this;
	var soe = eventInfo.data;
	var latlon = point.getPid();
    if(!name){
        KMap.getGeo(latlon,function(city,name){
            //_queryopts
            if (_this._queryopts.type == KQueryType.navsearch) {
                if (soe === "s") {
                    _this._queryopts.navorig={"latlon":latlon,"name":name};
                } else {
                    _this._queryopts.navdest={"latlon":latlon,"name":name};
                }
            } else if (_this._queryopts.type == KQueryType.busearch) {
                if (soe === "s") {
                    _this._queryopts.busorig={"latlon":latlon,"name":name};
                } else {
                    _this._queryopts.busdest={"latlon":latlon,"name":name};
                }
            }
            //
            var urlHash = _this._createUrlHashByQueryOpts(_this._queryopts);
            _this._requestDataForDrag(urlHash, soe);
        });
    }else{
        //_queryopts
        if (_this._queryopts.type == KQueryType.navsearch) {
            if (soe === "s") {
                _this._queryopts.navorig={"latlon":latlon,"name":name};
            } else {
                _this._queryopts.navdest={"latlon":latlon,"name":name};
            }
        } else if (_this._queryopts.type == KQueryType.busearch) {
            if (soe === "s") {
                _this._queryopts.busorig={"latlon":latlon,"name":name};
            } else {
                _this._queryopts.busdest={"latlon":latlon,"name":name};
            }
        }
        //
        var urlHash = _this._createUrlHashByQueryOpts(_this._queryopts);
        _this._requestDataForDrag(urlHash, soe);
    }
};
/**
 * "selectdone"
 */
KStationList.prototype._triggerSelectDone = function(){
	var info = this._selectedItemsInfo;
	if (!info.orig && !info.dest) {//
		 return; 
	}
	if (info.orig && info.dest) {//
		if (info.orig.latlon == info.dest.latlon) {
			KTools.showMsg("", {
				node: this._submitBtn
			});
			return;
		}
		if (!!this.options().samecity && (info.orig.city !== info.dest.city)) {
			KTools.showMsg("", {
				node: this._submitBtn
			});
			return;
		}
	}
	KEvent.trigger(this, "selectdone", this, info.orig, info.dest);
	//KEvent.trigger(this, "submitbtn", this, false);
};
/**
 * 
 * 
 * @param eventinfo
 */
KStationList.prototype._clickMoreHandler = function(eventinfo) {
	var _this = eventinfo.data.obj;
	var soe = eventinfo.data.soe;
	if (_this._pageNumber[soe] >= _this.options().pagecount) {
		return;
	}
	_this._pageNumber[soe]++;
	var urlHash = _this._createUrlHashByQueryOpts(_this._queryopts);
	$.ajax({
		type : "GET",
		url : _this._createRequestUrl(urlHash, soe, _this._pageNumber[soe]),
		success : function(data) {
			if (!data || !data.m) {
				return;
			}
			var city = data[soe].e;
			var dataArr = data[soe].d;
			//  _this._result
			_this._result[soe].d = _this._result[soe].d.concat(dataArr);
			// 
			var j, node, obj;
			var objKList = _this._kListObjs[soe];
			var listItems = _this._handleData(dataArr, _this._parsedData[soe].length);
			for (j = 0; j < listItems.length; j++) {
				obj = listItems[j];
				obj.deletable = false;
				obj.editable = false;
				obj.selected = false;
				node = $(obj.node);
				obj.text = node.children("label").html();
				obj.iconClass = node.children("span").eq(1).attr("class");
				objKList.insert(obj);
			}
			// checkbox,
			if (_this._head[soe].find("input:checkbox").is(":checked")) {
				_this._addMoreMarkers(listItems, soe, _this._parsedData[soe].length);
			}
			//_this._parsedData
			_this._parsedData[soe] = _this._parsedData[soe].concat(listItems);
			// 
			var sum = parseInt(data[soe].a, 10);
			var configOpts = _this.options();
			if (sum <= configOpts.pagesize || _this._pageNumber[soe] >= _this.options().pagecount) {
				$(_this._kListObjs[soe].dom()).find("ul>div").hide();
			}
			// KEvent.clear(objKList, "selectchanged");
			// _this._bindSelect(objKList, soe);
		},
		error : function() {
			if (!KMap.isInitialized(_this._opts.mapcontainer)) {
				KEvent.trigger(_this, "mapready", _this, undefined, undefined);
			}
		},
		dataType : "json"
	});
};
/**
 * checkbox marker
 * @param {Object} arr
 * @param {Object} soe
 * @param {Object} base
 */
KStationList.prototype._addMoreMarkers = function(arr, soe, base) {
	var _this = this;
	var index, item, temp, markers = [];
	for (index = 0; index < arr.length; index++) {
		item = arr[index];
		latlon = item.kvalue;
		temp = _this._createNormalMarker(soe, latlon, (base + index));
		item.marker = temp;
		markers.push(temp);
	}
	KMap.addMarkers(markers);
	_this._selectedMarkers[soe].hilite();
	for (index = 0; index < markers.length; index++) {
		KEvent.bind(markers[index], "click", _this._markerClickHandler, {
			mk : markers[index],
			t : soe
		}, _this);
	}
};
/**
 * KMarkerlabel
 * @param {KMarker} marker
 * @param {String} content
 */
KStationList.prototype._updateLabelContent = function(marker, content) {
    if(!marker || !marker.labelDom) return ;
	var labelDom = marker.labelDom();
	if (!content) {
		content = "";
	}
	$("[mfg='lbl']", labelDom).eq(0).html(content);
};
/**
 * ()Marker
 * 
 * @param soe
 *            "s""e",
 */
KStationList.prototype._clearSoeMarkers = function(soe) {
	var _this = this;
	KMap.clearMarker(_this._soeMarkerGroup(soe));// 
	_this._selectedMarkers[soe] = undefined;
	var reSoe = (soe === "s") ? "e" : "s";
	if (!!_this._selectedMarkers[reSoe]) {
		_this._selectedMarkers.currentSelected = reSoe;
	} else {
		_this._selectedMarkers.currentSelected = undefined;
	}
};
/**
 * soe()marker
 * 
 * @param soe
 *            "s""e",
 */
KStationList.prototype._clearNormalMarkers = function(soe) {
	var _this = this;
	KMap.clearMarker(_this._normalMarkerGroup(soe));
};
/**
 * soe()()marker
 * 
 * @param soe
 *            "s""e",
 */
KStationList.prototype._clearAllMarkers = function(soe) {
	var _this = this;
	_this._clearNormalMarkers(soe);
	_this._clearSoeMarkers(soe);
};
/**
 * Pidnameondn
 * 
 * @param obj
 * @returns latlon, pid, name ""
 */
KStationList.prototype._latlonPidName = function(obj) {
	var tempVal = "";
	if (!obj) {
		return "";
	}
	if (!!obj.latlon) {
		tempVal = obj.latlon;
	} else if (!!obj.pid) {
		tempVal = obj.pid;
	} else if (!!obj.name) {
		tempVal = obj.name;
	} else {
		tempVal = "";
	}
	return tempVal;
};
/**
 * fitzoom
 */
KStationList.prototype._mapFitZoom = function(){
	var sMarkers = KMap.getMarkers(this._soeMarkerGroup("s"));
	var eMarkers = KMap.getMarkers(this._soeMarkerGroup("e"));
	var sNormalMarkers = KMap.getMarkers(this._normalMarkerGroup("s"));
	var eNormalMarkers = KMap.getMarkers(this._normalMarkerGroup("e"));
	var allMarkers=sMarkers.concat(sMarkers, eMarkers,sNormalMarkers,eNormalMarkers);
	var points=[];
	for(var index=0; index<allMarkers.length; index++){
		if(allMarkers[index] && allMarkers[index].latlon){
			points.push(allMarkers[index].latlon());
		}
	}
	KMap.fitzoom(points);
};
/**
 * themecss
 * @param {String} theme
 * @returns  {Object}
 */
KStationList.prototype._initCssName = function(theme) {
	var initCss = {};
	for ( var i in KStationList.conf.CLASSNAME) {
		initCss[i] = theme + KStationList.conf.CLASSNAME[i];
	}
	return initCss;
};
/**
 * 
 * @param {String} soe
 * @param {String} name
 */
KStationList.prototype._setCityName = function(soe, name){
	var _this=this;
	if (_this._kCityListObjs && _this._kCityListObjs[soe]&&_this._kCityListObjs[soe].setCity) {
		var cityInfo = KTools.copyOptions({}, KCityInfo);
		cityInfo.name = (!name) ? "" : name;
		_this._setCityFromInner = true;
		_this._kCityListObjs[soe].setCity(cityInfo);
	}
};
/**
 * map(_this._maplet) true, false
 * 
 * @returns Boolean
 */
KStationList.prototype._isMapInitialized = function(){
	var _this = this;
	if (_this._isSupportMap === false) { return false; }
	if (_this._mapInitedFlag) { return true; }
	if (KMap.isInitialized(_this._opts.mapcontainer)) {
		_this._mapInitedFlag = true;
	}else{
		if (KMap.isInitialized()) {
			_this._mapInitedFlag = true;
		}
	}
	return _this._mapInitedFlag;
};
/**
 * urlHash
 * @param opst {Object}
 */
KStationList.prototype._changeHashAction = function(opts) {
	var _this = this;
	var queryOpts;
	if (opts) {
		queryOpts = opts;
	} else {
		queryOpts = $.extend(true, {}, _this._queryopts);
	}
	var urlHash = _this._createUrlHashByQueryOpts(queryOpts);
	KEvent.trigger(_this, "changehash", _this, queryOpts, urlHash);
	if (_this.options().changehash !== false) {
		KListener.setHash(urlHash, true);
	}
};
/**
 * KSearchboxthis._queryopts
 */
KStationList.prototype._updateSearchbox = function(){
	if(this._searchbox&&this._searchbox.query){
		this._searchbox.query($.extend(true,{},this._queryopts), true);
	}
};
/**
 * to get engine version of ie
 * @returns Number
 */
KStationList.prototype._ieEngineVersion = function() {
	if ($.browser.msie) {
		var engine = document.documentMode ? document.documentMode : 5;
		engine = document.compactMode == "CSS1Compact" ? 7 : engine;
		return engine;
	}
};
KStationList.prototype._initChildVision = function() {
	this._msgBox.e.prevAll().show();
	//
	this._msgBox.s.hide()
	if (!this.options().origarea) {
		this._kCityListContainer["s"].hide();
		this._head["s"].hide();
		this._listDiv.s.hide();
		this._$dom.children("hr").hide();
	}else{
		if (this.options().citylist) {
			this._kCityListContainer["s"].show();
		} else {
			this._kCityListContainer["s"].hide();
		}
	}
	//
	this._msgBox.e.hide();
	if (!this.options().destarea) {
		this._kCityListContainer["e"].hide();
		this._head["e"].hide();
		this._listDiv.e.hide();
		this._$dom.children("hr").hide();
	}else{
		if (this.options().citylist) {
			this._kCityListContainer["e"].show();
		} else {
			this._kCityListContainer["e"].hide();
		}
	}
};

KStationList.prototype._showMsgTip = function(elem){
	if(!elem){
		return;
	}
    var hint = "";
    var msgId = KTools.showMsg(hint, {
        node: elem,
		autoclose:5,
		buboptions:{
			outside:false
		}
    });
    $(elem).one("click keydown focus", function(){
        KTools.hideMsg(msgId);
    });
};
/*******************************************************************************
 * 
 ******************************************************************************/
/**
 * 1.0KNavsearch
 */
KStationList.prototype.clearMarkers = function(){
	this._clearAllMarkers("s");
	this._clearAllMarkers("e");
};


/* *

 fuyg
 2.0.0
 2010-07-19
 2010-07-19 23:07
 ============================================
 
 */

var KStdAccount = KClass.create("KStdAccount", KAccount);

KStdAccount.conf = {
	CLASSNAME : {
		// div
		A : "_acc"
		// div
		,AT : "_acc_t"
		// a
		,ACB : "_acc_cb"
		// div
		,AC : "_acc_c"
	
	}
};
/**
 * 
 * @param container 
 * @param options
 * 
 */
KStdAccount.initialize = function(container, options) 
{
	var _this = this;
	// html
	// ,
	_this._$dom = $(container).eq(0).hide();
	_this._dom = _this._$dom.get(0);
	// 
	_this._$clsDiv = $(">div:first", _this._$dom);
	_this._$clsA = $(">a:first", _this._$clsDiv);
	// 
	_this._$ac = $(">div:eq(1)", _this._$dom);
	_this._$iframe = $("iframe", _this._$dom);
	_this._origSrc = _this._$iframe.attr("src");

	// 
	_this._opts = {};
	_this.setOptions(options);
	// private info
	//
	_this._userInfomation = {
			"signin" : false
		};
	//
	_this._state = {
		_isBindResizeWgt : false,
		_msgBoxId : null
	};

	_this._$clsA.bind("click", function() {
		_this.hide();
	});

	//"signin"
	window.setTimeout(function() {
		_this._signinHandler();
	}, 100);
	//iframe
	var fnName = this._getRandomName();
	this._callbackName = fnName;
	//this._setCallBack(fnName);
	window[fnName] = function(){
		_this._signinHandler();
	};
};
/** ****************KObject************** */
/**
 * 
 * @uncrunch
 */
KStdAccount.prototype.finalize = function() 
{
	var _this = this;

	_this._$clsA.unbind();

	window[this._callbackName] = null;
	 KAccount.prototype.finalize.apply(_this);
};

/** ****************KWidget************** */
/**
 * 
 * @return String 
 * @uncrunch
 */
KStdAccount.prototype.version = function() 
{
	return "2.0.0";
};
/**
 * 
 * @return String
 * @uncrunch
 */
KStdAccount.prototype.cnname = function() 
{
	return "";
};
/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KStdAccount.prototype.dependent = function() 
{
	return [ KAccount, KAccountInfo, KClass, KEvent, KObject, KPosition, KSigninOptions, KSignoutOptions,
			KStdAccountOptions, KTools, KWidget, jQuery ];
};
/**
 * 
 * @param options
 * @uncrunch
 */
KStdAccount.prototype.setOptions = function(obj) 
{
	var _this = this;
	obj = KTools.copyOptions(obj, _this._opts, KStdAccountOptions);
	_this._setUserStyle(obj.userstyle);
	_this.setTheme(obj.theme);
	_this._setOpt4(obj);
};

/***
 * (theme)
 * @param thm  String   
 * @return true;false;
 * @uncrunch
 */
KStdAccount.prototype.setTheme = function(scheme) 
{
	var _this = this;
	// trim
	if (_this._opts.userstyle ===true  || typeof scheme !== "string" || $.trim(scheme).length < 1) {
		return false;
	}
	scheme = $.trim(scheme);
	// 
	if (_this._opts.theme === scheme) {
		return true;
	}
	//
	var oldTheme = _this._opts.theme || "mwp";
	var cn = KStdAccount.conf.CLASSNAME;
	// 
	_this._$dom.removeClass(oldTheme + cn.A).addClass(scheme + cn.A);

	// 
	_this._$clsDiv.removeClass(oldTheme + cn.AT).addClass(scheme + cn.AT);
	_this._$clsA.removeClass(oldTheme + cn.ACB).addClass(scheme + cn.ACB);
	// 
	_this._$ac.removeClass(oldTheme + cn.AC).addClass(scheme + cn.AC);

	_this._opts.theme = scheme;
	return true;
};
/** ****************KAccount************** */

/**
 * signin
 * @uncrunch
 */
KStdAccount.prototype.signin = function(){
	
	
};
/**
 * 
 * @param opts KSignoutOptions 
 * @return KAccountInfo 
 * @uncrunch
 */
KStdAccount.prototype.signout = function(){
    var _this = this;
    // 
    if (!_this._userInfomation || _this._userInfomation.signin === false) {
        return _this.account();
    }
    _this._userInfomation.signin = false;
    //
    var obj = _this.account();
    //
	$("body").append("<script type='text/javascript' src='http://passport.mapbar.com/index.php?m=user&a=setcookieout' reload='1'>");
	_this._$iframe.attr("src", _this._origSrc);
	KEvent.trigger(_this, "signout", _this, obj);
//    $.ajax({
//        type: "GET",
//        url: "http://ucport.mapbar.com/index.php?m=port&a=synlogout&mode=2&encode=1",
//        dataType: "jsonp",
//        success: function(data){
//            if (data && data.loginoutscript) {
//                //$(data.loginoutscript).appendTo(document.body);
//
//            } else {
//                //
//            }
//        }
//    })
    //
    return obj;
};
/**
 *  signin 
 * @return KAccountInfo 
 * @uncrunch
 */
KStdAccount.prototype.account = function() 
{
	var ui = this._userInfomation;
	var obj = {};
	if (ui) {
		obj = {
			"signin" : ui.signin,
			"uid" : ui.uid,
			"uidc" : ui.uidc,
			"user" : ui.user,
			"email" : ui.email,
			"lastime" : ui.lastime,
			"token" : ui.token
		};
	}
	return obj;
};

/** ****************KStdAccount************** */
/**
 * 
 * @uncrunch
 */
KStdAccount.prototype.show = function() 
{
	var _this = this;
	//_$dom
	if(!_this._$dom||_this._$dom.is(":visible")===true){
		return;
	}
	this._setCallBack(this._callbackName);

	KTools.lightbox( {
		element : _this._dom,
		visible : true
	});
	_this._reposition();
	_this._$dom.show();
	//_this._$usr.trigger("focus");
	if (_this._state._isBindResizeWgt === false) {
		var resizeHanler = function() {
			//_repositionfunction
			if (typeof _this._reposition === "function") {
				_this._reposition();
			} else {//_repositionfunction 
				$(window).unbind("resize", resizeHanler);
			}
		};
		//show
		$(window).bind("resize", resizeHanler);
		_this._state._isBindResizeWgt = true;
	}
	
};
/**
 * 
 * 
 * @uncrunch
 */
KStdAccount.prototype.hide = function() 
{
	var _this = this;
	if (!_this._$dom || _this._$dom.is(":visible") === false) {
		return;
	}
	KTools.lightbox( {});
	_this._$dom.hide();
};
/** ****************************** */




/***
 * 
 * 
 */
KStdAccount.prototype._reposition = function() 
{
	var _this = this;
	var wgtW = $(window).width() - _this._$dom.width();
	var wgtH = $(window).height() - _this._$dom.height();

	wgtW = (wgtW > 0) ? wgtW : 0;
	wgtH = (wgtH > 0) ? wgtH : 0;
	//
	_this._$dom.css( {
		left : wgtW / 2,
		top : wgtH / 2
	});
};


/***
 * cookie
 * @return Objectnull
 */
KStdAccount.prototype._getCookies = function(){
    var getCookie = function(name){
        var value = document.cookie.match(new RegExp("(^| )" + name + "=([^;]*)(;|$)"));
        if (value != null) return decodeURI(decodeURIComponent(value[2]));
        return null;
    };
    var userId = getCookie("userId");
    var userIdc = getCookie("userIdc");
    var userName = getCookie("userName");
	var token = getCookie("ucenter_token");
	var auth = getCookie("ucenter_auth");
    if (!userId || !userIdc || !userName || !token || !auth) {
        return null;
    }
    return {
        "userId": userId,
        "userIdc": userIdc,
        "userName": userName,
		"token":token
    };
};

/***
 * cookie 
 */
KStdAccount.prototype._signinHandler = function() 
{
	var _this = this;
	var cookies = _this._getCookies();
	//window.alert(cookies);
	if (!cookies) {
		return;
	}
	//KAccountInfo
	_this._userInfomation = {
		"user" : cookies.userName,
		"uid" : cookies.userId,
		"uidc" : cookies.userIdc,
		"token" : cookies.token,
		"signin" : true,
		"lastime" : new Date()
	};
	//
	KEvent.trigger(_this, "signin", _this, _this.account());
	_this.hide();
};
/***
 * 
 * @param opts KSigninOptions
 * @return true;false;
 */

KStdAccount.prototype._isSignined = function(opts) 
{
	var _this=this;
	var ui = _this._userInfomation;

	// _userInfomation user
	if (ui.user === undefined ) {
		return false;
	}
	// 
	if (opts.user === undefined || opts.pwd === undefined) {
		return false;
	}
	// 
	if (ui.user !== opts.user) {
		return false;
	}
	// 
	if (ui.signin === true) {
		return true;
	}
	return false;
};

/**
 * 
 * 
 * @param bStyle
 *            Boolean 
 */
KStdAccount.prototype._setUserStyle = function(bStyle) {
	var _this = this;
	if (typeof _this._opts.userstyle !== "boolean") {
		_this._opts.userstyle = false;
	}
	bStyle = !!bStyle;
	if (bStyle === true) {
		var cn = KStdAccount.conf.CLASSNAME;
		var curTheme = _this._opts.theme||"mwp";
		// 
		_this._$dom.removeClass(curTheme + cn.A);

		// 
		_this._$clsDiv.removeClass(curTheme + cn.AT);
		_this._$clsA.removeClass(curTheme + cn.ACB);
		// 
		_this._$ac.removeClass(curTheme + cn.AC);

		//
		_this._opts.theme=null;
	}
	_this._opts.userstyle = bStyle;
};

KStdAccount.prototype._setOpt4 = function(obj) {
	var _this = this;
	var arr = [ "url", "pwdurl", "regurl", "timelen" ];
	$.each(arr, function(index, val) {
		if (!_this._opts[val] || _this._opts[val] !== obj[val]) {
			_this._opts[val] = obj[val];
		}
	});
};

KStdAccount.prototype._getRandomName = function(){
	//return "oniframelogin";
    return "acount_" + (new Date()).getTime();
};

KStdAccount.prototype._setCallBack = function(name){
    var src = this._$iframe.attr("loginurl");
    var pattern = /backfunction=([^&]*)/ig;
    var match = pattern.exec(src);
    //backfunction
    if (match === null) {
        src = src + "&backfunction=" + name;
    } else {
        if (match[1] && match[1] === name) {
            srcChanged = false;
        } else {
            src = src.replace(pattern, "backfunction=" + name);
        }
    }
    this._$iframe.attr("loginurl", src);
	this._$iframe.attr("src", src);
};

/* *

 fuyg
 1.0
 2010-07-27
 2010-07-27 10:40
 ============================================
 
 */

var KStdFeedback = KClass.create("KStdFeedback", KFeedback);
KStdFeedback.conf = {
	CLASSNAME : {
		// (div)
		FDB : "_fdb"
		// mwp_fdb
		,FDBF : "_fdb_f"
		// (ul)
		,ETL : "_fdb_etl"
		// (div)
		,FIF : "_fdb_if"
		// (div)
		,DES : "_fdb_des"
		// (div)
		,ACT : "_fdb_act"
		// (div)
		,FEX : "_fdb_ex"
		// (a)
		,FCB : "_fdb_cb"
		// (input)
		,EMP : "_fdb_emp"
	}
};
/**
 * 
 * 
 * @param container
 *            Node 
 * @param opts
 *            KStdFeedbackOptions 
 * @return KStdFeedback 
 * 
 */
KStdFeedback.initialize = function(container, opts) {
	var _this = this;
	_this._opts = KTools.copyOptions( {}, opts, KStdFeedbackOptions);
	_this._maplet = null;	
	_this._setMaplet();
	//
	if (typeof _this._opts.userstyle !== "boolean") {
		_this._opts.userstyle = false;
	}
	_this.setTheme(_this._opts.theme);
	// HTMLElement
	// 
	_this._$dom = $(container).eq(0);
	_this._dom = _this._$dom.get(0);
	// 
	// 
	_this._$tabsDom = $(">div", _this._$dom);
	// 
	_this._$forms = $(">div>form", _this._$tabsDom);
	_this._$decInputs = $("input[mfg='dec']", _this._$tabsDom);
	_this._$dedTextAreas = $("textarea[mfg='ded']", _this._$tabsDom);
	// 
	_this._$closeBtn = $(">a", _this._$dom);
	// 
	_this._objKStdTabs = new KStdTabs(_this._$tabsDom.get(0));
	_this._inputHint(_this._$decInputs);
	_this._textAreaPop(_this._$dedTextAreas);
	_this._textAreaHint();
	_this._$forms.bind("submit", function() {
		return false;
	});
	$("input:submit", _this._$tabsDom).bind("click", function(event) {
		var index = $("input:submit", _this._$tabsDom).index($(event.target));
		_this._checkAndSubmit(index);
		return false;
	});
	(_this._opts.closebtn === true) ? _this._$closeBtn.show() : _this._$closeBtn.hide();
	_this._$closeBtn.bind("click", function() {
		_this.hide();
	});
	$("form>div>a", _this._$dom).bind("click", function() {
		KEvent.trigger(_this, "cancel");
		_this.hide();
	});
	$("input:checkbox", _this._$forms.eq(0)).eq(1).bind("change", function() {
		if ($(this).attr("checked")) {
			_this._setPoiMarkerAction();
		}
	});
	KEvent.bind(_this._objKStdTabs, "selected", function(event, wgt, prev, curr) {
		_this._tabSwitch(curr.index);

	});
	// private variables
	_this._msgBoxId = null;
	_this._errorType = null;
	// 0POI_ERROR
	_this._isPoiFd = true;
//	var obj = KConfig.get("mk_mo_mm", {
//		row : 8,
//		col : 5
//	});
//	_this._iconImg = obj.icon.img;
	_this._errorPoiInfo = null;
	_this._errorPoiMarker = null;
	_this._errorPoiEditable = null;
	_this._errorPoiOriLatlon = null;
	_this._errorRouteInfo = null;
	_this._userMarker = null;
	_this._decInputHintText = "";
	_this._taHintText = "";
	_this._taHTMemo = "";
	// setErrorPOI_errorPoiMarker
	_this._oriVisible = null;
	//setErrorPoiurlnotes
	_this._poiUN={};
	//setErrorRouteurl
	_this._routeUrl=null;
	//
	_this._resetForms();
	//
	_this._preLoad();

};
/*******************************************************************************
 * KObject
 */
/**
 * 
 * 
 * @uncrunch
 */
KStdFeedback.prototype.finalize = function() {
	var _this = this;
	_this._resetInitState();
	_this._$decInputs.unbind();
	_this._$dedTextAreas.unbind();
	KEvent.clear(_this._objKStdTabs);
	_this._objKStdTabs.finalize();
	//
	KFeedback.prototype.finalize.apply(_this);

};

/*******************************************************************************
 * KWidget
 */
/**
 * 
 * 
 * @return String 
 * @uncrunch
 */
KStdFeedback.prototype.version = function() {
	return "1.0";
};
/**
 * 
 * 
 * @return String
 * @uncrunch
 */
KStdFeedback.prototype.cnname = function() {
	return "";
};
/**
 * 
 * 
 * @return KObject[]
 * @uncrunch
 */
KStdFeedback.prototype.dependent = function() {
	return [ KClass, KConfig, KEvent, KFBErrorType, KFeedback, KFeedbackInfo, KFeedbackType, KIconOptions, KMap,
			KMarker, KMarkerOptions, KObject, KPOInfo, KPosition, KRouteInfo, KStdFeedbackOptions, KStdTabs, KTools,
			KWidget, KWidgetFlag, jQuery ];
};
/**
 * 
 * 
 * @param options
 * @uncrunch
 */
KStdFeedback.prototype.setOptions = function(options) {
	if (!options) {
		return;
	}
	
	var _this = this;
	//console.log(_this._opts);
	if (typeof options.url === "string") {
		var url = $.trim(options.url);
		if (url.length < 1) {
			return;
		}
		_this._opts.url = url;
	}
	if (typeof options.closebtn === "boolean") {
		(options.closebtn === true) ? _this._$closeBtn.show() : _this._$closeBtn.hide();
		_this._opts.closebtn = options.closebtn;
	}
	if (typeof options.userstyle === "boolean") {
		_this._setUserStyle(options.userstyle);
	}
	if (typeof options.theme === "string") {
		_this.setTheme(options.theme);
	}

};
/**
 * 
 * 
 * @param scheme
 *            String 
 * @uncrunch
 */
KStdFeedback.prototype.setTheme = function(scheme) {
	var _this = this;
	if (_this._opts.userstyle !== false || !scheme || typeof scheme !== "string" || scheme === _this._theme) {
		return;
	}
	
	var old = _this._theme;
	_this._objKStdTabs.setTheme(scheme);
	var klass = KStdFeedback.conf.CLASSNAME;
	_this._$dom.addClass(scheme + klass.FDB).removeClass(old + klass.FDB);
	if(_this._$dom.hasClass(old + klass.FDBF)){
		_this._$dom.addClass(scheme + klass.FDBF).removeClass(old + klass.FDBF);
	}
	_this._$decInputs.each(function() {
		$(this).removeClass(old + klass.EMP);
		var curVal = $(this).val();
		if (!curVal || /^\s*$/.test(curVal) || curVal === _this._decInputHintText) {
			$(this).addClass(scheme + klass.EMP).val(_this._decInputHintText);
		}
	});
	_this._$closeBtn.addClass(scheme + klass.FCB).removeClass(old + klass.FCB);
	//TAB 0 content
	var $form = _this._$forms.eq(0);
	$(">ul", $form).addClass(scheme + klass.ETL).removeClass(old + klass.ETL);
	$(">div[mfg='bi']", $form).addClass(scheme + klass.FIF).removeClass(old + klass.FIF);
	$(">div:eq(1)", $form).addClass(scheme + klass.DES).removeClass(old + klass.DES);
	$(">div:eq(2)", $form).addClass(scheme + klass.ACT).removeClass(old + klass.ACT);
	//Tab 1 content
	$form = _this._$forms.eq(1);
	$(">div[mfg='bi']", $form).addClass(scheme + klass.FIF).removeClass(old + klass.FIF);
	$(">div:eq(1)", $form).addClass(scheme + klass.DES).removeClass(old + klass.DES);
	$(">div:eq(2)", $form).addClass(scheme + klass.ACT).removeClass(old + klass.ACT);
	//Tab 2 content
	$form = _this._$forms.eq(2);
	$(">div:eq(0)", $form).addClass(scheme + klass.FEX).removeClass(old + klass.FEX);
	$(">div:eq(1)", $form).addClass(scheme + klass.DES).removeClass(old + klass.DES);
	$(">div:eq(2)", $form).addClass(scheme + klass.ACT).removeClass(old + klass.ACT);
	//
	_this._theme = scheme;
	_this._opts.theme = scheme;
};
/**
 * 
 * @uncrunch
 */
KStdFeedback.prototype.hide = function() {
	var _this = this;
	KFeedback.prototype.hide.apply(_this);
	_this._resetInitState();
};
/**
 * 
 * @uncrunch
 */
KStdFeedback.prototype.show = function() {
	var _this = this;
	if (_this._objKStdTabs.current().index === 1) {
		_this._tabUserCur();
	}
	KFeedback.prototype.show.apply(_this);
};
/*******************************************************************************
 * KFeedback
 */
/**
 * 
 * 
 * @param info
 *            KFeedbackInfo 
 * @uncrunch
 */
KStdFeedback.prototype.feedback = function(info) {
	var _this = this;
	var $submit = null;
	var tabIndex = null;
	switch (info.type) {
		case KFeedbackType.POI_ERROR:
		case KFeedbackType.ROUTE_ERROR:
			$submit = $("input:submit", _this._$forms.eq(0));
			tabIndex = 0;
			break;
		case KFeedbackType.USERPOI:
			$submit = $("input:submit", _this._$forms.eq(1));
			tabIndex = 1;
			break;
		case KFeedbackType.SUGGEST:
			$submit = $("input:submit", _this._$forms.eq(2));
			tabIndex = 2;
			break;
		default:
			return;
	}
	$submit.attr("disabled", true);
	var timeoutId = window.setTimeout(function() {
		_this._showOnlyOneMsg("...", {
			autoclose : 0,
			node : $submit.get(0),
			buboptions : {
				pos : KPosition.TOP,
				closebtn : false
			}
		});
	}, 150);
	var postData = _this._asPostData(info);
	var errorHandler = function() {
		KEvent.trigger(_this, "resultstate", _this, false);
		window.clearTimeout(timeoutId);
		$submit.attr("disabled", false);
		_this._showOnlyOneMsg("", {
			autoclose : 5,
			node : $submit.get(0),
			buboptions : {
				pos : KPosition.TOP,
				closebtn : true
			}
		});
		_this._resetMapOverlay(tabIndex);
		_this._resetForms(tabIndex);
	};
	$.ajax( {
		"type" : "POST",
		"dataType" : "json",
		"timeout" : 30000,
		"url" : _this._opts.url,
		"data" : postData,
		"success" : function(response) {
			var isSuccess = false;
			if (response && response.a && response.a === "1") {
				isSuccess = true;
			} 
			if (isSuccess === false) {
				errorHandler();
			} else {
				window.clearTimeout(timeoutId);
				KEvent.trigger(_this, "resultstate", _this, true);
				if (_this._msgBoxId !== null) {
					KTools.hideMsg(_this._msgBoxId);
				}
				_this._showOnlyOneMsg("", {
					autoclose : 5,
					node : $submit.get(0),
					buboptions : {
						pos : KPosition.TOP,
						closebtn : true
					}
				});
				_this._resetMapOverlay(tabIndex);
				_this._resetForms(tabIndex);
			}

		},
		"error" : function() {
			errorHandler();
		}
	});

};
/*******************************************************************************
 * KStdFeedback
 */
/**
 * 
 * 
 * @param type
 *            KFeedbackType 
 * 
 * @uncrunch
 */
KStdFeedback.prototype.showTab = function(type) {
	var _this = this;
	switch (type) {
		case KFeedbackType.POI_ERROR:
			_this._showTabPoi();
			break;
		case KFeedbackType.ROUTE_ERROR:
			_this._showTabRoute();
			break;
		case KFeedbackType.USERPOI:
			_this._showTabUser();
			break;
		case KFeedbackType.SUGGEST:
			_this._showTabSuggest();
			break;
	}
};

/**
 * 
 * 
 * @return KFeedbackType 
 * @uncrunch
 */
KStdFeedback.prototype.tab = function() {
	var _this = this;
	var index = _this._objKStdTabs.current().index;
	switch (index) {
		case 0:
			if (_this._isPoiFd !== false) {
				return KFeedbackType.POI_ERROR;
			} else {
				return KFeedbackType.ROUTE_ERROR;
			}
			break;
		case 1:
			return KFeedbackType.USERPOI;
			break;
		case 2:
			return KFeedbackType.SUGGEST;
			break;
	}
};
/**
 * 
 * 
 * @param type
 *            KFBErrorType 
 * @return
 * @uncrunch
 */
KStdFeedback.prototype.setErrorType = function(type) {
	if (typeof type !== "number") {
		return;
	}
	var _this = this;
	var $boxes = $("ul li input:checkbox", _this._$forms.eq(0));
	var arr = [ "INFO", "LOCATION", "INEXISTENT", "OTHER" ];
	$.each(arr, function(index, val) {
		if (type & KFBErrorType[val]) {
			if (_this._isPoiFd !== false) {
				$boxes.eq(_this._ERRORTYPELIORDER[val]).attr("checked", true);
			} else {
				if (val === "INFO" || val === "OTHER") {
					$boxes.eq(_this._ERRORTYPELIORDER[val]).attr("checked", true);
				} else {
					$boxes.eq(_this._ERRORTYPELIORDER[val]).attr("checked", false);
				}
			}
		} else {
			$boxes.eq(_this._ERRORTYPELIORDER[val]).attr("checked", false);
		}
	});
};
/**
 * 
 * 
 * @return KFBErrorType 
 * @uncrunch
 */
KStdFeedback.prototype.errorType = function() {
	var _this = this;
	var eType = 0;
	var $boxes = $("ul li input:checkbox", _this._$forms.eq(0));
	var arr = [ "INFO", "LOCATION", "INEXISTENT", "OTHER" ];

	$boxes.each(function(index, dom) {
		if ($(dom).attr("checked")) {
			if (_this._isPoiFd !== false) {
				eType = eType | KFBErrorType[arr[index]];
			} else {
				if (arr[index] === "INFO" || arr[index] === "OTHER") {
					eType = eType | KFBErrorType[arr[index]];
				}
			}
		}
	});
	return eType;
};
/**
 *  undefined 
 * 
 * @param info
 *            KPOInfo 
 * @param marker
 *            KMarker  undefined
 * @param url
 *            String  undefined
 * @param notes
 *            String  undefined
 * @return
 * @uncrunch
 */
KStdFeedback.prototype.setErrorPOI = function(info, marker, url, notes) {
	var _this = this;
	//
	if(_this._setMaplet()!==true){
		return;
	}
	//
	var index = _this._objKStdTabs.current().index;
	//if (index !== 0 || _this._isPoiFd !== true) {
	_this.showTab(KFeedbackType.POI_ERROR);
	//}
	//
	_this._poiUN = {
		"url" : url,
		"notes" : notes
	};
	_this._errorPoiInfo = info;
	if (!info) {
		info = {};
	}
	var $form = _this._$forms.eq(0);
	if (info.name) {
		$("input[mfg='bin']", $form).val(info.name);
	}
	if (info.address) {
		$("input[mfg='bia']", $form).val(info.address);
	}
	if (info.phone) {
		$("input[mfg='bip']", $form).val(info.phone);
	}
	if(notes){
		$("textarea[mfg='ded']", $form).val(notes).removeClass(_this._getThemeClass("EMP"));
	}
	if (_this._errorPoiMarker) {
		if (typeof _this._errorPoiMarker.setEditable === "function") {
			_this._errorPoiMarker.setEditable(_this._errorPoiEditable);
		}
		if (_this._oriVisible && _this._errorPoiMarker.showLabel
				&& typeof _this._errorPoiMarker.showLabel === "function") {
			_this._errorPoiMarker.showLabel();
		}
		//
		if (_this._errorPoiOriLatlon && _this._errorPoiMarker.setLatlon
				&& typeof _this._errorPoiMarker.setLatlon === "function") {
			_this._errorPoiMarker.setLatlon(_this._errorPoiOriLatlon);
		}
	}
	// Marker
	_this._errorPoiMarker = marker;
	if (!marker) {
		$("input:checkbox", $form).eq(1).attr( {
			"checked" : false,
			"disabled" : true
		});
		return;
	}
	try {
		_this._errorPoiOriLatlon = marker.latlon().getPid();
	} catch (ex) {
		_this._errorPoiOriLatlon = null;
	}
	_this._errorPoiEditable = marker.editable();
	//
	$("input:checkbox", $form).eq(1).attr( {
		"disabled" : false
	});
	KMap.setCenter(marker.latlon());
	_this._setPoiMarkerAction();
};
/**
 * 
 * 
 * @return KPOInfo 
 * @uncrunch
 */
KStdFeedback.prototype.errorPOInfo = function() {
	return this._errorPoiInfo;
};
/**
 * 
 * 
 * @return KMarker 
 * @uncrunch
 */
KStdFeedback.prototype.errorMarker = function() {
	return this._errorPoiMarker;
};
/**
 *  undefined 
 * 
 * @param info
 *            KRouteInfo 
 * @param url
 *            String  undefined
 * @return
 * @uncrunch
 */
KStdFeedback.prototype.setErrorRoute = function(info, url) {
	var _this = this;
	//
	if(_this._setMaplet()!==true){
		return;
	}
	//
	var index = _this._objKStdTabs.current();
	//if (index !== 0 || _this._isPoiFd === true) {
	_this.showTab(KFeedbackType.ROUTE_ERROR);
	//}
	_this._routeUrl=url;
	_this._errorRouteInfo = info;
	if (!info) {
		info = {};
	}
	_this._errorRouteInfo = info;
	var $form = _this._$forms.eq(0);
	if (info.name) {
		$("textarea[mfg='ded']", _this._$forms.eq(0)).addClass(_this._getThemeClass("EMP")).val(info.name);
		_this._taHintText = info.name;
	}
	KMap.fitzoom();
};
/**
 * 
 * 
 * @return KRouteInfo 
 * @uncrunch
 */
KStdFeedback.prototype.errorRouteInfo = function() {
	return this._errorRouteInfo;
};
/*******************************************************************************
 * KStdFeedback
 */
/**
 * 
 */
KStdFeedback.prototype._resetInitState = function() {
	var _this = this;
	_this._resetMapOverlay();
	_this._resetForms();
	_this._errorType = 1;
	//
};
/**
 * 
 * 
 * @param tabIndex
 *            Number 
 */
KStdFeedback.prototype._resetMapOverlay = function(tabIndex) {
	var _this = this;
	//
	if(_this._setMaplet()!==true){
		return;
	}
	//
	var flagPoi = false;
	var flagUser = false;
	if (typeof tabIndex !== "number") {
		flagPoi = true;
		flagUser = true;
	} else if (tabIndex === 0) {
		flagPoi = true;
	} else if (tabIndex === 1) {
		flagUser = true;
	}
	if (flagPoi && _this._errorPoiMarker) {
		(typeof _this._errorPoiMarker.setEditable === "function")
				&& (_this._errorPoiMarker.setEditable(_this._errorPoiEditable));
		if (typeof _this._errorPoiMarker.labelDom === "function" && _this._errorPoiMarker.labelDom()
				&& typeof _this._errorPoiMarker.showLabel === "function") {
			_this._errorPoiMarker.showLabel();
		}
		//
		if (_this._errorPoiOriLatlon && _this._errorPoiMarker.setLatlon
				&& typeof _this._errorPoiMarker.setLatlon === "function") {
			_this._errorPoiMarker.setLatlon(_this._errorPoiOriLatlon);
		}
	}
	if (flagUser && _this._userMarker) {
		KMap.removeMarker(_this._userMarker);
		_this._userMarker = null;
	}
};
/**
 * 
 * 
 * @param tabIndex
 *            Number 
 * 
 * 
 */

KStdFeedback.prototype._resetForms = function(tabIndex) {
	var _this = this;
	var $forms = _this._$forms;
	if (typeof tabIndex === "number") {
		$forms = $forms.eq(tabIndex);
	}
	_this._$forms.each(function(index, form) {
		if (index === 0) {
			$("input:checkbox", form).attr( {
				"checked" : false,
				"disabled" : false
			}).eq(0).attr("checked", true);
		}
		$("input:text", form).val("").filter("[mfg=dec]").addClass(_this._getThemeClass("EMP")).val(
				_this._decInputHintText);
		$("textarea", form).val("");
		$("input:submit", form).attr("disabled", false);
	});
	_this._taHintText = "";
	_this._taHTMemo = "";
};
/**
 * input:text 
 * 
 * @param $inputs
 *            jQueryinput[type="text"]
 * @param hintClass
 *            String css class
 * 
 * @return
 */
KStdFeedback.prototype._inputHint = function($inputs) {
	if (!$inputs) {
		return;
	}
	var _this = this;
	$inputs.bind( {
		"focus" : function() {
			var $input = $(this);
			var hintClass = _this._getThemeClass("EMP");
			if ($input.hasClass(hintClass)) {
				$input.removeClass(hintClass).val("");
			} else {
				$input.removeClass(hintClass).select();
			}
		},
		"blur" : function() {
			var $input = $(this);
			var hintClass = _this._getThemeClass("EMP");
			var curVal = $input.val();
			if (!curVal || /^\s*$/.test(curVal) || curVal === _this._decInputHintText) {
				$input.addClass(hintClass).val(_this._decInputHintText);
			}
		}
	});
};
/**
 * textarea
 * 
 * @param $areas
 *            jQuerytextarea
 * @return
 */
KStdFeedback.prototype._textAreaPop = function($areas) {
	var _this = this;
	if (!$areas) {
		return;
	}
	$areas.bind("keydown change focus", function(event) {
		var $area = $(this);
		var len = $area.val().length;
		var msg = false;
		var isShowMsg = false;
		var isCutOff = false;
		var isReFalse = false;
		
		switch(event.type){
			case "keydown":
				if(len >2000){
					isShowMsg = true;
					isCutOff =true;
					isReFalse = true;
				} else if (len === 2000) {
					isShowMsg = true;
					isReFalse = true;
					// (ctrl+A, ctrl+C)(<-[8],
					// Delete[46])pageUp(33),pageDown(34),home(36),end(35)(37-40)
					// console.log(event.keyCode);
					var keys = ",8,46,33,34,35,36,37,38,39,40,";
					if (event.ctrlKey === true || keys.indexOf("," + event.keyCode + ",") > -1) {
						isShowMsg = false;
						isReFalse = false;
					}
				}
				break;
			case "change":
				if(len>2000){
					isShowMsg = true;
					isCutOff =true;
				}else if(len===2000){
					isShowMsg = true;
				}
				break;
			case "focus":
				if(len>2000){
					isShowMsg = true;
					isCutOff =true;
				}
				break;
		}
		
		if(isShowMsg){
			msg = KTools.getMsg(_this._msgBoxId);
			if (!msg) {
				_this._showOnlyOneMsg("2000", {
					autoclose : 0,
					node : $area.get(0),
					buboptions : {
						pos : KPosition.TOP,
						closebtn : false
					}
				});
			}
		}else{
			_this._hideOnlyOneMsg();
		}
		
		if(isCutOff){
			$area.val($area.val().substr(0, 2000));
		}
		
		if(isReFalse){
			return false;
		}
	});
};

/**
 * KFeedbackType.ROUTE_ERRORtextarea
 * 
 * @return
 */
KStdFeedback.prototype._textAreaHint = function() {
	var _this = this;
	var $area = $("textarea[mfg='ded']", _this._$forms.eq(0));
	$area.bind( {
		"focus" : function() {
			var hintClass = _this._getThemeClass("EMP");
			if ($area.hasClass(hintClass)) {
				$area.removeClass(hintClass).val("");
			} else {
				$area.removeClass(hintClass).select();
			}
		},
		"blur" : function() {
			var hintClass = _this._getThemeClass("EMP");
			var curVal = $area.val();
			if (!curVal || /^\s*$/.test(curVal) || curVal === _this._taHintText) {
				$area.addClass(hintClass).val(_this._taHintText);
			}
		}
	});

};
/**
 * input
 * 
 * @param input
 *            jQueryInput HTMLElement
 * @return Boolean true;false;
 */
KStdFeedback.prototype._checkContact = function($input) {
	var _this = this;
	var msg = "";
	var val = $input.val();
	if (_this._isEmail(val) || _this._isPhoneNumber(val)) {
		return true;
	}
	if (val === _this._decInputHintText) {
		msg = "";
	}
	_this._showOnlyOneMsg(msg, {
		autoclose : 5,
		node : $input.get(0),
		buboptions : {
			pos : KPosition.TOP,
			closebtn : true
		}
	});
	return false;
};
/**
 * email
 * 
 * @param str
 *            String 
 * @return Boolean true;false;
 */
KStdFeedback.prototype._isEmail = function(str) {
	if (typeof str !== "string") {
		str = str.toString();
	}
	var pattern = /^\w+([-+.]\w+)*@\w+([-.]\w+)*.\w+([-.]\w+)*$/;
	return pattern.test(str);
};
/**
 * ()
 * 
 * @param str
 *            String 
 * @return Boolean true;false;
 */
KStdFeedback.prototype._isPhoneNumber = function(str) {
	if (typeof str !== "string") {
		str = str.toString();
	}
	// -_
	var pattern = /^\d*[-_]?\d+$/;
	return pattern.test(str);
};
/**
 *  theme+KStdFeedback.conf.CLASSNAME[str];
 * 
 * @param str
 *            KStdFeedback.conf.CLASSNAME
 * @return
 */
KStdFeedback.prototype._getThemeClass = function(str) {
	var _this = this;
	str = KStdFeedback.conf.CLASSNAME[str.toUpperCase()];
	return !_this._theme ? undefined : (_this._theme + str);
};

/**
 * KFeedbackType.POI_ERROR
 * 
 * @return
 */
KStdFeedback.prototype._showTabPoi = function() {
	var _this = this;
	var $form = _this._$forms.eq(0);
	var $lis = $(">ul>li", $form);
	var order = _this._ERRORTYPELIORDER;
	// 
	$lis.show();
	$("div[mfg='bi']", $form).show();
	_this._taHTMemo = _this._taHintText;
	_this._taHintText = "";
	$("textarea[mfg='ded']", $form).val("");
	_this._objKStdTabs.select(0);
	_this._isPoiFd = true;
	_this.show();
};
/**
 * KFeedbackType.ROUTE_ERROR
 * 
 * @return
 */
KStdFeedback.prototype._showTabRoute = function() {
	var _this = this;
	var $form = _this._$forms.eq(0);
	var $lis = $(">ul>li", $form);
	var order = _this._ERRORTYPELIORDER;
	// 
	$lis.each(function(index, dom) {
		if (!(index === order.INFO || index === order.OTHER)) {
			$(dom).hide();
		}
	});
	// 
	$("div[mfg='bi']", $form).hide();
	// 
	// 
	_this._taHintText = _this._taHTMemo;
	_this._taHTMemo = "";
	$("textarea[mfg='ded']", $form).val(_this._taHintText);
	//
	_this._objKStdTabs.select(0);
	_this._isPoiFd = false;
	_this.show();
};
/**
 * KFeedbackType.USERPOI
 * 
 * @return
 */
KStdFeedback.prototype._showTabUser = function() {
	var _this = this;
	_this._objKStdTabs.select(1);
	_this.show();
};
/**
 * KFeedbackType.SUGGEST
 * 
 * @return
 */
KStdFeedback.prototype._showTabSuggest = function() {
	var _this = this;
	_this._objKStdTabs.select(2);
	_this.show();
	$("textarea[mfg=ded]", _this._$forms.eq(2)).focus();
};
/**
 * liul,_ERRORTYPELIORDERKFBErrorType
 */
KStdFeedback.prototype._ERRORTYPELIORDER = {
	"INFO" : 0,
	"LOCATION" : 1,
	"INEXISTENT" : 2,
	"OTHER" : 3
};

/**
 * 
 * 
 * @param msg
 *            KTools.showMsg
 * @param opts
 *            KTools.showMsg
 */
KStdFeedback.prototype._showOnlyOneMsg = function(msg, opts) {
	var _this = this;
	// (cpu),
	if (_this._$dom.is(":visible") === false) {
		return;
	}
	if (_this._msgBoxId !== null) {
		KTools.hideMsg(_this._msgBoxId);
	}
	_this._msgBoxId = KTools.showMsg(msg, opts);

};
/**
 * 
 */
KStdFeedback.prototype._hideOnlyOneMsg = function() {
	var _this = this;
	if (_this._msgBoxId !== null) {
		KTools.hideMsg(_this._msgBoxId);
		_this._msgBoxId = null;
	}
};
/**
 * 
 * 
 * @param index
 *            Number 0,1,2
 * @return
 */
KStdFeedback.prototype._checkAndSubmit = function(index) {
	var _this = this;
	switch (index) {
		case 0:
			if (_this._isPoiFd !== false) {
				_this._checkAndSubmitPoi();
			} else {
				_this._checkAndSubmitRoute();
			}
			break;
		case 1:
			_this._checkAndSubmitUser();
			break;
		case 2:
			_this._checkAndSubmitSuggest();
			break;
		default:
			return;
	}
};
/**
 * _feedbackTypeKFeedbackType.POI_ERROR
 * 
 * @return
 */
KStdFeedback.prototype._checkAndSubmitPoi = function() {
	var _this = this;
	var tIndex = 0;
	var $form = _this._$forms.eq(tIndex);
	var $boxes = $("ul li input:checkbox", $form);
	var msgTarget = null;
	// 
	var eType = 0;
	var name = false;
	var description = false;
	var contact = false;
	var arr=["INFO","LOCATION","INEXISTENT","OTHER"];
	// 
	eType=_this.errorType();
	//  
	if (eType === 0) {
		msgTarget = $form.find("ul li:first").get(0);
		_this._showOnlyOneMsg("", {
			autoclose : 3,
			node : msgTarget,
			buboptions : {
				pos : KPosition.TOP,
				closebtn : true
			}
		});
		// $li_first.find("input").attr("checked", true);
		return;
	}
	//  
	msgTarget = $("input[mfg='bin']", $form);
	name = msgTarget.val();
	if (!name || $.trim(name).length === 0) {
		_this._showOnlyOneMsg("", {
			autoclose : 5,
			node : msgTarget.get(0),
			buboptions : {
				pos : KPosition.TOP,
				closebtn : true
			}
		});
		return;
	}
	// 
	description = _this._checkTextArea($("textarea[mfg='ded']", $form));
	if (description !== true) {
		return;
	}
	// 
	contact = _this._checkContact($("input[mfg='dec']", $form));
	if (contact !== true) {
		return;
	}
	// ,
	_this._errorType = eType;
	description = $.trim(KTools.text($("textarea[mfg='ded']", $form).val()));
	contact = $.trim($("input[mfg='dec']", $form).val());
	var poinfo = {
		"name" : $.trim(name),
		"address" : $.trim($("input[mfg='bia']", $form).val()),
		"phone" : $.trim($("input[mfg='bip']", $form).val())
	};
	if(_this._errorPoiMarker){
		var mp = _this._errorPoiMarker.latlon();
		if(mp){
			poinfo.latlon = mp.getPid();
		}
		//
		if (_this._errorPoiOriLatlon && _this._errorPoiMarker.setLatlon
				&& typeof _this._errorPoiMarker.setLatlon === "function") {
			_this._errorPoiMarker.setLatlon(_this._errorPoiOriLatlon);
		}
	}
	if (_this._errorPoiInfo) {
		poinfo = KTools.copyOptions(poinfo, _this._errorPoiInfo);
	}
	_this.feedback({
		"url": _this._poiUN.url || window.location.href,
		"type": KFeedbackType.POI_ERROR,
		"errortype": eType,
		"poinfo": poinfo,
		"notes": description,
		"contact": contact
	});

};
/**
 * _feedbackTypeKFeedbackType.ROUTE_ERROR
 * 
 * @return
 */
KStdFeedback.prototype._checkAndSubmitRoute = function() {
	var _this = this;
	var order = _this._ERRORTYPELIORDER;
	var tIndex = 0;
	var $form = _this._$forms.eq(tIndex);
	var $boxes = $("ul li input:checkbox", $form);
	var msgTarget = null;
	// 
	var eType = 0;
	var description = false;
	var contact = false;
	// 
	eType=_this.errorType();
	//  
	if (eType === 0) {
		msgTarget = $form.find("ul li:first").get(0);
		_this._showOnlyOneMsg("", {
			autoclose : 3,
			node : msgTarget,
			buboptions : {
				pos : KPosition.TOP,
				closebtn : true
			}
		});
		return;
	}

	// 
	description = _this._checkTextArea($("textarea[mfg='ded']", $form));
	if (description !== true) {
		return;
	}
	// 
	contact = _this._checkContact($("input[mfg='dec']", $form));
	if (contact !== true) {
		return;
	}
	// ,
	_this._errorType = eType;
	description = $.trim(KTools.text($("textarea[mfg='ded']", $form).val()));
	if (_this._taHintText) {
		description = "[" + _this._taHintText + "]" + description;
	}
	contact = $.trim($("input[mfg='dec']", $form).val());
	//
	var city = null;
	if (_this._errorRouteInfo && _this._errorRouteInfo.type) {
		if (_this._errorRouteInfo.type === KRouteType.BUS) {
			try {
				city = _this._errorRouteInfo.queryopts.city;
			} catch (ex) {
				try {
					city = _this._errorRouteInfo.queryopts.busline.city;
				} catch (ex) {
					try {
						city = _this._errorRouteInfo.queryopts.bustation.city;
					} catch (ex) {
					}
				}
			}
		} else if (_this._errorRouteInfo.type === KRouteType.NAVIGATION) {
			//do something here
		}
	}

	//console.log(city);
	var poinfo = {};
	if (city !== null) {
		poinfo.city = city;
	}

	_this.feedback( {
		"url" : _this._routeUrl || window.location.href,
		"type" : KFeedbackType.ROUTE_ERROR,
		"errortype" : eType,
		"notes" : description,
		"contact" : contact,
		"poinfo" : poinfo
	});
};
/**
 * _feedbackTypeKFeedbackType.USERPOI
 * 
 * @return
 */
KStdFeedback.prototype._checkAndSubmitUser = function() {
	var _this = this;
	var tIndex = 1;
	var $form = _this._$forms.eq(tIndex);
	var msgTarget = null;
	// 
	var name = false;
	var description = false;
	var contact = false;
	//  
	msgTarget = $("input[mfg='bin']", $form);
	name = msgTarget.val();
	if (!name || $.trim(name).length === 0) {
		_this._showOnlyOneMsg("", {
			autoclose : 5,
			node : msgTarget.get(0),
			buboptions : {
				pos : KPosition.TOP,
				closebtn : true
			}
		});
		return;
	}
	// 
	description = _this._checkTextArea($("textarea[mfg='ded']", $form));
	if (description !== true) {
		return;
	}
	// 
	contact = _this._checkContact($("input[mfg='dec']", $form));
	if (contact !== true) {
		return;
	}
	// ,
	description = $.trim(KTools.text($("textarea[mfg='ded']", $form).val()));
	contact = $.trim($("input[mfg='dec']", $form).val());
	//
	var poinfo = {
		"name" : $.trim(name),
		"address" : $.trim($("input[mfg='bia']", $form).val()),
		"phone" : $.trim($("input[mfg='bip']", $form).val())
	};
	if(_this._userMarker){
		var mp = _this._userMarker.latlon();
		if(mp){
			poinfo.latlon = mp.getPid();
		}		
	}
	_this.feedback( {
		"url":window.location.href,
		"type" : KFeedbackType.USERPOI,
		"poinfo" : poinfo,
		"notes" : description,
		"contact" : contact
	});
};
/**
 * _feedbackTypeKFeedbackType.SUGGEST
 * 
 * @return
 */
KStdFeedback.prototype._checkAndSubmitSuggest = function() {
	var _this = this;
	var tIndex = 2;
	var $form = _this._$forms.eq(tIndex);
	// 
	var description = false;
	var contact = false;
	// 
	description = _this._checkTextArea($("textarea[mfg='ded']", $form));
	if (description !== true) {
		return;
	}
	// 
	contact = _this._checkContact($("input[mfg='dec']", $form));
	if (contact !== true) {
		return;
	}
	// ,
	description = $.trim(KTools.text($("textarea[mfg='ded']", $form).val()));
	contact = $.trim($("input[mfg='dec']", $form).val());
	//
	_this.feedback( {
		"url":window.location.href,
		"type" : KFeedbackType.SUGGEST,
		"notes" : description,
		"contact" : contact
	});
};
/**
 * 
 * @param $area
 *            jQuerytextarea
 * @return textareatrue; false;
 */
KStdFeedback.prototype._checkTextArea = function($area) {
	var _this = this;
	// 
	var len = $area.val();
	if (!len || $.trim(len).length === 0) {
		len = 0;
	} else {
		len = len.length;
	}
	// 
	if (len === 0 || len > 2000) {
		_this._showOnlyOneMsg((len > 2000) ? "2000" : "", {
			autoclose : 0,
			node : $area.get(0),
			buboptions : {
				pos : KPosition.TOP,
				closebtn : true
			}
		});
		return false;
	}
	return true;
};
/**
 * 
 * 
 * @param index
 *            Numbertab, 0,1,2
 * @return
 */
KStdFeedback.prototype._tabSwitch = function(index) {
	var _this=this;
	_this._hideOnlyOneMsg();
	switch (index) {
		case 0:
			_this._tabErrorCur();
			break;
		case 1:
			_this._tabUserCur();
			break;
		case 2:
			$("textarea[mfg=ded]", _this._$forms.eq(2)).focus();
			break;
	}
};

/**
 * ,
 * 
 * @return
 */
KStdFeedback.prototype._tabErrorCur = function() {
	var _this = this;
	if(_this._setMaplet()!==true){
		return;
	}
	if (_this._isPoiFd) {
		if (_this._errorPoiMarker && typeof _this._errorPoiMarker === "function") {
			KMap.setCenter(_this._errorPoiMarker.latlon());
			if(_this._userMarker){
				_this._userMarker.resume();
			}
			_this._bindMarkerPop(_this._errorPoiMarker);
		}
	} else {
		if (_this._errorRouteInfo) {
			KMap.fitzoom();
		}
	}
};

/**
 * ,
 * 
 * @return
 */
KStdFeedback.prototype._tabUserCur = function() {
	var _this = this;
	if(_this._setMaplet()!==true){
		return;
	}
	if (_this._userMarker) {
		KMap.setCenter(_this._userMarker.latlon());
		_this._userMarker.hilite();
		_this._bindMarkerPop(_this._userMarker);
		return;
	}
	var center = KMap.center();
	//var icon = {
//		img : _this._iconImg
//	};
	//icon = KTools.copyOptions(icon, KIconOptions);
	var markerOpts = KConfig.get("mk_mo_mm", {
		row : 8,
		col : 5
	});
	markerOpts.editable=true;
	markerOpts.group=KWidgetFlag.feedback;	
	var marker = new KMarker(center, markerOpts);
	marker = KTools.copyOptions(marker, KMarkerOptions);
	_this._userMarker = marker;
	KMap.addMarker(marker);
	_this._userMarker.hilite();
	_this._bindMarkerPop(marker);
};

/**
 * KFeedbackType.POI_ERRORKMarker
 * 
 * @return
 */
KStdFeedback.prototype._setPoiMarkerAction = function() {
	var _this = this;
	if (!_this._errorPoiMarker) {
		return;
	}
	if(_this._setMaplet()!==true){
		return;
	}
	var $box = $("input:checkbox", _this._$forms.eq(0)).eq(1);
	var isChecked = $box.attr("checked");
	if (isChecked) {
		_this._errorPoiMarker.setEditable(true);
	}
	if (_this._errorPoiMarker.editable()) {
		var label = _this._errorPoiMarker.labelDom();
		if (label) {
			_this._oriVisible = $(label).is(":visible");
			if (_this._oriVisible) {
				_this._errorPoiMarker.hideLabel();
			}
		}
		KMap.setCenter(_this._errorPoiMarker.latlon());
		_this._bindMarkerPop(_this._errorPoiMarker);
	}else{
		_this._hideOnlyOneMsg();
	}
};
/**
 * KMarkereditableKMarker
 * 
 * @param marker
 *            KMarker
 * @return
 */
KStdFeedback.prototype._bindMarkerPop = function(marker) {
	var _this = this;
	if (marker && marker.editable()) {
		_this._showOnlyOneMsg("", {
			autoclose : 0,
			node : marker.iconDom(),
			buboptions : {
				pos : KPosition.RIGHT,
				closebtn : true
			}
		});
		KEvent.bind(marker, "dragstart", function(event, mapNode, point) {
			_this._hideOnlyOneMsg();
			KEvent.unbind(marker, "dragstart");
		});
	}
};

/**
 * 
 * @param info
 *            KFeedbackInfo 
 * @return
 */
KStdFeedback.prototype._asPostData = function(info) {
	// info = KTools.copyOptions(info, KFeedbackInfo);
	var out = new KUrlHash();
	var obj;
	out.setKey("t", "f");
	// out.push("fu="+encodeURI(window.location.href));
	for ( var pro in info) {
		if (info.hasOwnProperty(pro)) {
			switch (pro) {
				case "type":
					out.setKey("ft", info[pro]);
					break;
				case "errortype":
					out.setKey("fet", info[pro]);
					break;
				case "notes":
					out.setKey("fd", info[pro]);
					break;
				case "contact":
					out.setKey("fc", info[pro]);
					break;
				case "url":
					out.setKey("fu", info[pro]);
					break;
				case "poinfo":
					obj = info[pro];
					// console.log(obj);
					if (obj) {
						(!!obj.name) && out.setKey("fn", obj.name);
						(!!obj.address) && out.setKey("fa", obj.address);
						(!!obj.phone) && out.setKey("fp", obj.phone);
						(!!obj.latlon) && out.setKey("fl", obj.latlon);
						(!!obj.city) && out.setKey("c", obj.city);
					}
					break;
			}

		}
	}
	return out.toString();
};
/**
 * to set the userstyle option
 * 
 * @param bStyle
 *            Boolean
 * 
 * @return
 */
KStdFeedback.prototype._setUserStyle = function(bStyle) {
	var _this = this;
	if (typeof bStyle !== "boolean" || _this._opts.userstyle === bStyle) {
		return;
	}
	if (bStyle === true) {
		//
		var old = _this._theme;
		var klass = KStdFeedback.conf.CLASSNAME;
		_this._$dom.removeClass(old + klass.FDB).removeClass(old + klass.FDBF);
		_this._$decInputs.removeClass(old + klass.EMP);
		_this._$closeBtn.removeClass(old + klass.FCB);
		//TAB 0 content
		var $form = _this._$forms.eq(0);
		$(">ul", $form).removeClass(old + klass.ETL);
		$(">div[mfg='bi']", $form).removeClass(old + klass.FIF);
		$(">div:eq(1)", $form).removeClass(old + klass.DES);
		$(">div:eq(2)", $form).removeClass(old + klass.ACT);
		//Tab 1 content
		$form = _this._$forms.eq(1);
		$(">div[mfg='bi']", $form).removeClass(old + klass.FIF);
		$(">div:eq(1)", $form).removeClass(old + klass.DES);
		$(">div:eq(2)", $form).removeClass(old + klass.ACT);
		//Tab 2 content
		$form = _this._$forms.eq(2);
		$(">div:eq(0)", $form).removeClass(old + klass.FEX);
		$(">div:eq(1)", $form).removeClass(old + klass.DES);
		$(">div:eq(2)", $form).removeClass(old + klass.ACT);
	}
	//
	_this._objKStdTabs.setOptions( {
		"userstyle" : bStyle
	});
	//console.log(bStyle);
	_this._opts.userstyle = bStyle;
	_this._theme=null;
};
/**
 * map(_this._maplet) true, false
 * 
 * @returns Boolean
 */
KStdFeedback.prototype._setMaplet = function() {
	var _this = this;
	if (_this._maplet) {
		return true;
	} else {
		if (!!_this._opts.mapcontainer) {
			if (KMap.isInitialized(_this._opts.mapcontainer)) {
				_this._maplet = KMap.maplet(_this._opts.mapcontainer);
				KMap.setCurrentMap(_this._opts.mapcontainer);
			}
		} else {
			if (!!KMap.isInitialized()) {
				_this._maplet = KMap.maplet();
			}
		}
		if (_this._maplet) {
			return true;
		}
	}
	return false;
};
/**
 * 
 * 
 * 
 * @returns
 */
KStdFeedback.prototype._preLoad = function() {
	if (document.images) {
		var img = new Image();
		img.onload = function() {
			img = null;
		};
		img.src = "http://img.mapbar.com/web/3in1/imgs/iconm.gif";
	}
};
/*
  
 gongyong
 1.0.1
 2010-03-03
 2010-03-03 12:43
 ============================================
 
 1.getPoiByLatlon()poicomplete
 */
var KStdGeocoder = KClass.create("KStdGeocoder", KGeocoder);
KStdGeocoder.conf = {
    classNamePrefix : "_geo_"
    ,classNameArr : "lst,st".split(",")
    ,CLASSNAME  : {}
    ,type : {city : 'c',district : 'dl', dlist : 'd',map :'m',init:"i"}
};
$.each(KStdGeocoder.conf.classNameArr,
        function(i, val)
        {
            KStdGeocoder.conf.CLASSNAME[val.toUpperCase()] = KStdGeocoder.conf.classNamePrefix + val;
        }
        );
KStdGeocoder.conf.CLASSNAME['PARENT'] = "_geo";
/**
 * 
 * @param container Node
 * @param opts KStdGeocoderOptions
 * @uncrunch
 */
KStdGeocoder.initialize = function(container, opts)
{
    this._opts = KTools.copyOptions(opts, KStdGeocoderOptions);
    //
    this.setTheme(this._opts.theme);
    //Dom
    this._dom = $(container)[0];
    this._geocoderInfo = KTools.copyOptions({}, KGeocoderInfo);
    this._init_container(this._opts.mapcontainer);

};

KStdGeocoder.prototype._init_container = function(container){
    if(container){
        var _this = this;

        if(KMap.isInitialized(container))
        {
            this._map = KMap.maplet(container);
            this._buildDom();
            this._registerMapEventListener();
            this._parseData(this._map.getCenter(),this._map.getZoomLevel(),KStdGeocoder.conf.type.init);
        }
        else
        {
            KEvent.bind(KMap, 'mapinit', function(){
                _this._map = KMap.maplet(container);
                _this._buildDom();
                _this._registerMapEventListener();
                _this._parseData(_this._map.getCenter(),_this._map.getZoomLevel(),KStdGeocoder.conf.type.init);
            });
        }
    }
}


/**
 * 
 * @uncrunch
 */
KStdGeocoder.prototype.finalize = function()
{
    KTools.removeNode(this._cityListDom);
    KTools.removeNode(this._dropListDom);
    if(this._cityList)
    {
        this._cityList.finalize();
    }
    if(this._dropList)
    {
        this._dropList.finalize();
    }
    KWidget.prototype.finalize.apply(this);
};
/**
 * 
 * @return String 
 * @uncrunch
 */
KStdGeocoder.prototype.version = function()
{
    return "1.0.1";
};
/**
 * 
 * @return String
 * @uncrunch
 */
KStdGeocoder.prototype.cnname = function()
{
    return "";
};
/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KStdGeocoder.prototype.dependent = function()
{
    //return [KCityList, KCityListOptions, KClass, KDropList, KEvent, KGeocoder, KGeocoderInfo, KManager, KMap, KObject, KSize, KStdGeocoderOptions, KTools, KUrlHash,KWidget,jQuery];
    return [KGeocoder, KCityList, KDropList, KEvent, KManager, KMap, jQuery, KStdGeocoderOptions, KCityListOptions, KGeocoderInfo];
};
/**
 * 
 * @param opts KStdGeocoderOptions
 * @uncrunch
 */
KStdGeocoder.prototype.setOptions = function(opts)
{
    var oldTheme = this._theme;
    var diffOpts = KTools.compareOptions(this._opts, opts);
    this._opts = KTools.copyOptions(opts, this._opts);
    var _this = this;
    $.each(diffOpts, function(name, value) {
        if (name == "theme") {
            _this._changeTheme(value, oldTheme);
        }
        else if (name == "citylist") {
            _this._displayDom(_this._cityListDom, value);
        }
        else if (name == "district") {
            _this._displayDom(_this._dropListDom, value);
        }
        else if (name == "street") {
            _this._displayDom(_this._streetDom, value);
        }
        else if (name == "cylopts") {
            if (_this._opts.citylist) {
                _this._cityList.setOptions(value);
            }
        }
        else if(name == 'container'){
            _this._init_container(opts.mapcontainer);
        }
    });
};
/**
 * 
 * @param scheme
 * @uncrunch
 */
KStdGeocoder.prototype.setTheme = function(scheme)
{
    var oldTheme = this._theme;
    this._changeTheme(scheme, oldTheme);
};
/**
 * 
 * @param scheme
 * @uncrunch
 */
KStdGeocoder.prototype._changeTheme = function(newTheme, oldTheme)
{
    this._theme = newTheme;
    this._updateClass(this._dom, oldTheme, KStdGeocoder.conf.CLASSNAME.PARENT);
    this._updateClass(this._contentDom, oldTheme, KStdGeocoder.conf.CLASSNAME.LST);
    this._updateClass(this._streetDom, oldTheme, KStdGeocoder.conf.CLASSNAME.ST);
};
/**
 * @param dom jQuery
 * @param oldTheme  String
 * @param className     String
 */
KStdGeocoder.prototype._updateClass = function(dom, oldTheme, className)
{
    if (dom) {
        dom.removeClass(this._getClassName(className, oldTheme)).addClass(this._getClassName(className));
    }
};
/**
 * 
 * @param latlon String 
 * @param zoom String 
 * @uncrunch
 */
KStdGeocoder.prototype.parse = function(latlon, zoom)
{
    this._parseData(latlon, zoom);
};
/**
 * 
 * @return String
 * @uncrunch
 */
KStdGeocoder.prototype.province = function()
{
    return this._geocoderInfo.province;
};
/**
 * 
 * @return String
 * @uncrunch
 */
KStdGeocoder.prototype.city = function()
{
    return this._geocoderInfo.city;
};
/**
 * 
 * @return String
 * @uncrunch
 */
KStdGeocoder.prototype.district = function()
{
    return this._geocoderInfo.district;
};
/**
 * 
 * @return String
 * @uncrunch
 */
KStdGeocoder.prototype.street = function()
{
    return this._geocoderInfo.street;
};
/**
 * 
 * @return String
 * @uncrunch
 */
KStdGeocoder.prototype.latlon = function()
{
    return this._geocoderInfo.latlon;
};
/**
 * 
 * @return String
 * @uncrunch
 */
KStdGeocoder.prototype.zoom = function()
{
    return this._geocoderInfo.zoom;
};
/**
 * 
 * @return KCityList
 * @uncrunch
 */
KStdGeocoder.prototype.cityWidget = function()
{
    if (this._opts.citylist) {
        return this._cityList;
    }
    else {
        return undefined;
    }
};
/**
 * 
 * @uncrunch
 */
KStdGeocoder.prototype.layout = function()
{
    if (this._cityList) {
        return this._cityList.layout();
    }
};
/**
 * Dom
 */
KStdGeocoder.prototype._buildDom = function()
{
    var _this = this;
    //
    this._contentDom = $(">ul", this._dom).eq(0);
    this._streetDom = $(">li:eq(2) > span", this._contentDom).eq(0);
    //KCityList
    this._cityListDom = $(">li:eq(0) >div:eq(0)", this._contentDom).eq(0);
    this._cityList = new KCityList(this._cityListDom, this._opts.cylopts ? this._opts.cylopts : KCityListOptions);
    KEvent.bind(this._cityList, "citychanged", function(evt, widget, cityInfo, oldCityInfo) {
        KEvent.trigger(_this,"cyl_citychanged",_this,oldCityInfo,cityInfo);
        if (!_this._nocitychanged && cityInfo && cityInfo.latlon && _this._isLatlonZoomChanged(cityInfo.latlon, cityInfo.level)) {
            _this._parseData(cityInfo.latlon, cityInfo.level, KStdGeocoder.conf.type.city);
        }
        else {
            _this._nocitychanged = false;
        }
    });
    //KDropList
    this._dropListDom = $(">li:eq(1) >div:eq(0)", this._contentDom).eq(0);
    this._dropList = new KDropList(this._dropListDom.get(0), {deselect : false,select2text:true,multiple:false,closebtn:false,sortable : false});//{select2text:true, closebtn:true, size:new KSize(200, 300)});
    //input
    KEvent.bind(this._dropList, "opened", function(evt, widget) {
    	var ua = navigator.userAgent.toLowerCase();
    	var _isie = false;
    	if (ua.match(new RegExp("msie")) && _this._dropList.items().length > 1 && _this._dropList.items()[0].text == _this._dropList.items()[1].text){
    		_isie = true;
    	}
    	 _this._cityList.hideHotCity();
        if (_this._dropList.items().length == 1 || _isie) {
            var a = _this._dropList.item(0).kvalue.split("#");
            _this._dropList.clearResult();
            if(!a || !jQuery.trim(a[0])){
                a[0] = _this._geocoderInfo.latlon;
                a[1] = _this._geocoderInfo.zoom;
            }
            _this._parseData(a[0], a[1], KStdGeocoder.conf.type.dlist);
        }
    });
    //selectchanged
    KEvent.bind(this._dropList, "itemclick", function(evt, widget, item) {
        widget.close();
        //
        if (item.kvalue && !_this._noselectchanged) {
            var a = item.kvalue.split("#");
            if (_this._isLatlonZoomChanged(a[0], a[1])) {
                _this._parseData(a[0], a[1], KStdGeocoder.conf.type.district);
            }
        }
        else {
            _this._noselectchanged = false;
        }
    });
    this._displayAllDom(true, true, true);
};
/**
 * 
 * @param className String
 */
KStdGeocoder.prototype._getClassName = function(className, theme)
{
    if (!theme) {
        theme = this.theme();
    }
    return theme + className;
};
/**
 * this._domjQuery
 * @return jQuery
 */
KStdGeocoder.prototype._jdom = function()
{
    return this._dom ? $(this._dom) : undefined;
};

/**
 * 
 * @param latlon String
 * @param zoom Integer
 */
KStdGeocoder.prototype._parseData = function(latlon, zoom, type)
{
    var _this = this;
    //parse
    if (latlon) {
        if (this._map && type != KStdGeocoder.conf.type.init) {
            if (type == KStdGeocoder.conf.type.city || type == KStdGeocoder.conf.type.district) {
                this._nocenterchanged = true;
                this._map.centerAndZoom(latlon, zoom);
            }
            else if (!type) {
                this._map.centerAndZoom(latlon, zoom);
                return ;
            }
        }
        $.ajax({
            url : _this._genUrl(latlon, zoom, type)
            ,type:'GET'
            ,dataType : 'json'
            ,success : function(data) {
                if (data) {
                    if(type == KStdGeocoder.conf.type.init){
                        _this._nocitychanged = true;
                        _this._setGeocoderInfo({province :data.p ,city : data.c,latlon : data.cc,zoom : data.cz,district : data.d,street : data.a});
                        _this._cityList.setCity({name:data.c ? data.c : (data.p ? data.p : ""),latlon : data.cc,level:data.cz,province:data.p,bus: parseInt(data.ib) == 1});
                        _this._streetDom.text(data.a);
                        _this._dropList.clearResult();
                        _this._dropList.insert({text : data.d,kvalue : data.dc + "#" + data.dz,deletable : false,editable : false,selected : true});
                        _this._displayAllDom(true,data.d,data.a);
                        return ;
                    }

                    if (!data.c && type != KStdGeocoder.conf.type.dlist) {
                         _this._nocitychanged = true;
                         _this._setGeocoderInfo({province :data.p ,city : data.c,latlon : data.cc,zoom : data.cz,district : data.d,street : data.a});
						 _this._cityList.setCity({name:data.c ? data.c : (data.p ? data.p : ""),latlon : data.cc,level:data.cz,province:data.p,bus: parseInt(data.ib) == 1});
                        _this._displayAllDom(true);
                        return;
                    }
                    if (!type) {
                        //parse
                        if (!_this._map) {
                            $.extend(data, {latlon : latlon,zoom : zoom});
                            _this._handleMap(data);
                        }
                    }
                    else if (type == KStdGeocoder.conf.type.city) {
                        //
                        var oldcity = _this._geocoderInfo.city;
                        _this._setGeocoderInfo({province :data.p ,city : data.c,latlon : data.cc,zoom : data.cz,district : data.d,street : data.a});
                        if (data.d) {
                            _this._noselectchanged = false;
                            _this._displayDom(_this._dropListDom, _this._opts.district);
                            if (data.c == oldcity && _this._dropList.items().length == data.dn) {
                                _this._dropList.select(parseInt(data.di));
                            }
                            else {
                                _this._dropList.clearResult();
                                _this._dropList.insert({text : data.d,kvalue : data.dc + "#" + data.dz,deletable : false,editable : false,selected : true});
                            }
                            _this._handleStreet(data.a);
                        }
                        else {
                            _this._displayAllDom(true);
                        }
                        KEvent.trigger(_this, "changed", _this, _this._geocoderInfo);
                    }
                    else if (type == KStdGeocoder.conf.type.district) {
                        _this._setGeocoderInfo({province : data.p,city : data.c,latlon : data.dc,zoom : data.dz,district : data.d,street : data.a});
                        _this._handleStreet(data.a);
                        KEvent.trigger(_this, "changed", _this, _this._geocoderInfo);
                    }
                    else if (type == KStdGeocoder.conf.type.dlist) {
                        _this._noselectchanged = false;
                        _this._insertItems(data.z[0].p[0].c[0].d);
                    }
                    else if (type == KStdGeocoder.conf.type.map) {
                        $.extend(data, {latlon : latlon,zoom : zoom});
                        _this._handleMap(data);
                    }
                }
            }
        });
    }
};
/**
 * kmap
 *
 */
KStdGeocoder.prototype._registerMapEventListener = function()
{
    var _this = this;
    if (this._map) {
        KEvent.bind(this._map, "geocode", function(evt, container, level, center, bounds) {
            //
            if (!_this._nocenterchanged) {
                _this._parseData(center.pid, level, KStdGeocoder.conf.type.map);
            }
            else {
                _this._nocenterchanged = false;
            }
        });
    }
}
KStdGeocoder.prototype._insertItems = function(items) {
    var _this = this;
    $.each(items, function(i, n) {
        var selected = n.n == _this._geocoderInfo.district ? true : false;
        _this._dropList.insert({text : n.n,kvalue : n.l + "#" + n.z,deletable : false,editable : false,selected : selected});
    });
}
KStdGeocoder.prototype._setGeocoderInfo = function(item) {
    var _this = this;
    $.each(item, function(k, v) {
        _this._geocoderInfo[k] = v;
    });
}
KStdGeocoder.prototype._genUrl = function(latlon, zoom, type) {
    var param = new KUrlHash();
    var _u = {t : type == KStdGeocoder.conf.type.dlist ? "cln" : "ig",l : latlon,z : "" + zoom,ct : type};
    $.each(_u, function(k, v) {
         param.setKey(k,v);
    });
    return this._opts.url + "?" + param.toString();
}
KStdGeocoder.prototype._handleMap = function(data) {
    var _this = this;
    var oldcity = this._geocoderInfo.city;
    this._setGeocoderInfo({province : data.p,city : data.c,latlon : data.latlon,zoom : data.zoom,district : data.d,street : data.a});
    if (data.c != oldcity) {
        this._nocitychanged = true;
        this._cityList.setCity({name : data.c,latlon : data.cc,level : data.cz,province:data.p,bus:parseInt(data.ib) == 1});
    }
    if (data.d) {
        this._noselectchanged =  false;
        this._displayDom(this._dropListDom, this._opts.district);
        if (data.c == oldcity && this._dropList.items().length == data.dn) {
            this._dropList.select(parseInt(data.di));
        }
        else {
            this._dropList.clearResult();
            this._dropList.insert({text : data.d,kvalue : data.dc + "#" + data.dz,deletable : false,editable : false,selected : true});
        }
        this._handleStreet(data.a);
    }
    else {
        window.setTimeout(function(){_this._dropList.clearResult();_this._displayAllDom(true, false, false)},0);
    }
    KEvent.trigger(this, "changed", this, this._geocoderInfo);
}
KStdGeocoder.prototype._displayAllDom = function(city, district, street) {
    this._displayDom(this._cityListDom, this._opts.citylist && city);
    this._displayDom(this._dropListDom, this._opts.district && district);
    this._displayDom(this._streetDom, this._opts.street && street);
}
KStdGeocoder.prototype._displayDom = function(dom, isshow) {
    dom && isshow ? dom.show() : dom ? dom.hide() : "";
}
KStdGeocoder.prototype._handleStreet = function(street) {
    street ? this._streetDom.text(street) : "";
    this._displayDom(this._streetDom, street && this._opts.street);
}
KStdGeocoder.prototype._isLatlonZoomChanged = function(latlon, zoom) {
    return latlon != this._geocoderInfo.latlon || zoom != this._geocoderInfo.zoom;
}



/**
 * poicomplete
 * @param latlon 
 * @returns 
 * @uncrunch
 */
KStdGeocoder.prototype.getPoiByLatlon = function(latlon) {
	var _this=this;
	if (typeof latlon !== "string") {
		if (typeof latlon.getPid === "function") {
			latlon = latlon.getPid();
		} else {
			throw new Error("getPoiByLatlon() needs a string of latlon");
			return;
		}
	}
	var zoom = 13;
	var hash = new KUrlHash();
	hash.setKey("t", "ig");
	hash.setKey("l", latlon);
	hash.setKey("z", zoom);
	 $.ajax( {
		url : this._opts.url + "?" + hash.toString(),
		type : 'GET',
		dataType : 'json',
		success : function(data) {
		 	var poi = KTools.copyOptions( {
				"latlon" : latlon
			}, KPOInfo);
		 	if(data && data.c){
		 		poi.city = data.c;
		 	}
		 	KEvent.trigger(_this, "poicomplete", _this, poi, data);
		},
		error:function(){
			throw new Error("");
		}
	});
};

/*
 KStdMapMarkers

2.0
2011-1-12
2011-3-2 15:40
==============================================================================
[]
*/

var KStdMapMarkers = KClass.create('KStdMapMarkers', KMapMarkers);

KStdMapMarkers.conf =
{
    CLASSNAME :
    {
        SMM : ''             //
        ,TLST : '_tlst'     //ul
        ,TM : '_tm'         //a
        ,TMS : '_tms'       //a
        ,TL : '_tl'         //a
        ,TLS : '_tls'       //a
        ,TC : '_tc'         //a
        ,TCS : '_tcs'       //a
        ,TF : '_tf'         //a
        ,TFS : '_tfs'       //a
        ,RST : '_rst'       //ul
        ,S : '_s'           //(li)
        ,H : '_h'           //li
        ,IM : '_im'         //span
        ,IL : '_il'         //span
        ,IC : '_ic'         //span
        ,IF : '_if'         //span
    }
    ,CONST :
    {
        bkIcon : 'http://img.mapbar.com/web/3in1/icons/mm11.gif'   //
        ,titlelen : 18
        ,colors : ['#ffffff','#dddddd','#cccccc','#999999','#666666','#333333','#000000','#ffcccc','#ff6666','#ff0000','#cc0000','#990000','#660000','#330000','#ffcc99','#ff9966','#ff9900','#ff6600','#cc6600','#993300','#663300','#ffff99','#ffff66','#ffcc66','#ffcc33','#cc9933','#996633','#663333','#ffffcc','#ffff33','#ffff00','#ffcc00','#999900','#666600','#333300','#99ff99','#66ff99','#33ff33','#33cc00','#009900','#006600','#003300','#99ffff','#33ffff','#66cccc','#00cccc','#339999','#336666','#003333','#ccffff','#66ffff','#33ccff','#3366ff','#3333ff','#000099','#000066','#ccccff','#9999ff','#6666cc','#6633ff','#6600cc','#333399','#330099','#ffccff','#ff99ff','#cc66cc','#cc33cc','#993399','#663366','#330033']
        ,wname : '_smm' //
        ,txtDes : '' //
        ,txtDist : '' //
        ,txtArea : '' //
        ,txtNoDes : '' //
        ,aunit : ''  //
        ,baunit : ''    //
        ,dunit : ''    //
        ,bdunit : ''  //
        ,opanel : '<a href="javascript:void(0);" onfocus="this.blur();" mfg="edt"></a><a href="javascript:void(0);" onfocus="this.blur();" mfg="del"></a>'    //
        //<a href="javascript:void(0);" onfocus="this.blur();" mfg="swb"></a><a href="javascript:void(0);" onfocus="this.blur();" mfg="fav"></a>
        //
        ,recordStruct :
        {
            info :      //
            {
                at : '1'    //  1  2  4  8
                ,did : ''   //
                ,mt : ''    // IM   IL   IC   IF 
                ,l : ''     //
                ,t : ''     //
                ,d : ''     //
                ,i : ''     //
                ,s :        //
                {
                    c : {x : 1, y : 1}  //
                    ,l :                //
                    {
                        c : '#F00'      //
                        ,w : 5          //
                        ,a : 60         //
                    }
                    ,f :                //
                    {
                        c : '#F00'      //
                        ,a : 30         //
                    }
                }
            }
            ,overlays :             //
            {
                m : []              //marker
                ,l : []             //line
                ,a : []             //area
            }
            ,latlon :               //
            {
                m : []              //
                ,l : []             //
                ,a : []             //
            }
        }
    },
    FLASHCONF:
    {
    	file_size_limit : "512",
		file_types : "*.jpg;*.jpeg;*.png",
		file_types_description : "All images",
		file_upload_limit : "0",
		flash_url : "http://img.mapbar.com/web/3in1/flash/swfupload.swf",
		button_image_url : 'http://img.mapbar.com/web/3in1/imgs/swfuploadbutton.png',
		button_width : 65,
		button_height : 26
    }
};

/**
 * 
 * @param container Node 
 * @param opts KStdMapMarkersOptions 
 * @uncrunch
 */
KStdMapMarkers.initialize = function(container, opts)
{
    var _this = this;
    this._isHasFlash = this._flashChecker()?true:false;
    this._initVariable();    //
    this._setOptions(opts, true); //
    this._getDom(container); //
    this._applyTheme();     //
    if(this.options().mapcontainer && KMap.isInitialized(this.options().mapcontainer))
    {
        this._bindEvent();      //
    }
    else
    {
        KEvent.bind(KMap, 'mapinit', this._mapInit, {}, this);    //
    }
    this._clearList();
    //window
    window.mmGetShardUrl = function() {
        return _this._getShardUrl.apply(_this, arguments);
    };
    window.mmCopyShardUrl = function() {
        return _this._copyShardUrl.apply(_this, arguments);
    };
};

/*======================== KObject =======================*/
/**
 * 
 * @uncrunch
 */
KStdMapMarkers.prototype.finalize = function()
{
    this._tools.unbind();   //
    this.options().clearbtn && $(this.options().clearbtn).unbind();
    this.options().sharebtn && $(this.options().sharebtn).unbind();
    KEvent.unbind(KMap, 'modechanged', this._mapModeChanged);  //modechanged
    KEvent.unbind(KMap, 'mapinit', this._mapInit);   //
    KEvent.unbind(KMap, 'modechanged', this._mapModeChanged);
    KEvent.unbind(KMap, 'bookmark', this._bookmark);
    KEvent.unbind(KMap, 'drawline', this._drawline);
    KEvent.unbind(KMap, 'roadline', this._roadline);
    KEvent.unbind(KMap, 'drawarea', this._drawarea);
    KEvent.unbind(KMap, 'iw_hide', this._iw_hide);
    KEvent.unbind(KMap, 'afteropeninfowindow', this._afterOpenInfoWindow);

    this._toolbar.appendTo(this._$dom);
    this._$dom.hide();
};

/*======================== KWidget ========================*/
/**
 * 
 * @uncrunch
 */
KStdMapMarkers.prototype.version = function()
{
    return '2.0.3';
};
/**
 * 
 * @uncrunch
 */
KStdMapMarkers.prototype.cnname = function()
{
    return '';
};
/**
 * 
 * @uncrunch
 */
KStdMapMarkers.prototype.dependent = function()
{
    return [jQuery, KArea, KConfig, KMap, KMapMarkerInfo, KMapMarkers, KStdMapMarkersOptions, KQueryOptions,
        KQueryType, KUrlHash];
};
/**
 * 
 * @param opts KStdMapMarkersOptions 
 * @uncrunch
 */
KStdMapMarkers.prototype.setOptions = function(opts)
{
    this._setOptions(opts, false);
};
/**
 * 
 * @param scheme String 
 * @return Boolean 
 * @uncrunch
 */
KStdMapMarkers.prototype.setTheme = function(scheme)
{
    this._setTheme(scheme);
};
/**
 * 
 * @uncrunch
 */
KStdMapMarkers.prototype.show = function()
{
    this._show(true, true);
};
/**
 * 
 * @uncrunch
 */
KStdMapMarkers.prototype.hide = function()
{
    //this._clearMarkers();   //
    this._$dom.hide();      //
    KEvent.trigger(this, 'hide');
    this.hideToolbar();   //
    this._setMarkMode();    //
};
/**
 * 
 * @return Boolean 
 * @uncrunch
 */
KStdMapMarkers.prototype.visible = function()
{
    return KWidget.prototype.visible.apply(this);
};
/**
 * 
 * @uncrunch
 */
KStdMapMarkers.prototype.layout = function()
{
    var _offset = this.options().markbtn ? $(this.options().markbtn).offset() : {left : 0, top : 0};
    this._toolbar.css({
        top : (_offset.top + (this.options().offset ? this.options().offset.top : 0)) + 'px'
        ,left : (_offset.left + (this.options().offset ? this.options().offset.left : 0)) + 'px'
    });
};

/*====================== KQuery =====================*/
/**
 * 
 * @uncrunch
 */
KStdMapMarkers.prototype.hashKeys = function()
{
    return ['mmid'];
};
/**
 * Hash
 * @param hash KUrlHash
 * @uncrunch
 */
KStdMapMarkers.prototype.queryByHash = function(hash)
{
    var _this = this;
    if(hash.value('mmid'))
    {
        if(!this.visible())
        {
            this._show(false);
        }
        //
        this._mmid = hash.value('mmid');
        //
        this._at = 4;
        //
        if(KMap.isInitialized(this.options().mapcontainer))
        {
            this._load();
        } else {
            KEvent.bind(KMap, 'mapinit', function(){
                _this._load();
                KEvent.unbind(KMap, 'mapinit', arguments.callee)
            });
        }
    }
};

/*==================== KMapMarkers ====================*/
/**
 * 
 * @return KMapMarkerInfo[]
 * @uncrunch
 */
KStdMapMarkers.prototype.markers = function()
{
    var m = [];
    for(var i = 0; i < this._recorder.records.length; i++)
    {
        var r = this._recorder.records[i];
        m.push(KTools.copyOptions({
            nid : r.info.did
            ,order : i
            ,title : r.info.t
            ,content : r.info.d
            ,img : r.info.i
            ,type : r.info.mt
            ,latlons : r.info.l
            ,style : $.extend(true, {}, r.info.s)
        }, KMapMarkerInfo));
    }
    return m;
};
/**
 * 
 * @param marker KMapMarkerInfo
 * @return Boolean 
 * @uncrunch
 */
KStdMapMarkers.prototype.add = function(marker)
{
    var _this = this;
    var _r = KTools.copyOptions({
        info : {
            t : marker.title
            ,d : marker.content
            ,i : marker.img
            ,l : marker.latlons
            ,mt : marker.type
            ,s : eval('(' + marker.style + ')')
        }
    }, KStdMapMarkers.conf.CONST.recordStruct);
    switch(marker.type)
    {
        case KOverlayType.MARKER:
        {
            _r.info.mt = 'IM';
            break;
        }
        case KOverlayType.POLYLINE:
        {
            _r.info.mt = 'IL';
            break;
        }
        case KOverlayType.ROADLINE:
        {
            _r.info.mt = 'IC';
            break;
        }
        case KOverlayType.AREA:
        {
            _r.info.mt = 'IF';
            break;
        }
    }
    //var _val = this._markerInfo2Note(marker);
    //var _d = eval('(' + marker.data + ')');
    var _ls = marker.latlons.split(',');
    var _l = [];
    for(var i in _ls)
    {
        _l.push(new MPoint(_ls[i]));
    }

    //
    if(marker.type == KOverlayType.MARKER)
    {
        this._addMarkerRecord(this._addMarker(_l[0], false, eval('(' + marker.style + ')')), false, _r.info);
    }
    //
    if(marker.type == KOverlayType.POLYLINE)
    {
        this._addLineRecord(this._addLine(_l, false, eval('(' + marker.style + ')')), false, _r.info);
    }
    //
    if(marker.type == KOverlayType.ROADLINE)
    {
        if(this.options().roadurl)
        {
            var _lines = [];
            for(var i = 1; i < _ls.length; i++)
            {
                var _url = this.options().roadurl + '&nh=' + _ls[i-1] + ',' + _ls[i];
                $.ajax({
                    async : false
                    ,type : 'GET'
                    ,url : _url
                    ,success : function(data){
                        if(data)
                        {
                            eval(data);
                            var _line = KLine.fromEncoded(_map_rlm.a[0].a, _map_rlm.a[0].b);
                            //var _lls = _line.latlons();
                            _lines = _lines.concat(_line.latlons());
                            /*for(var n in _lls)
                            {
                                _lines.push(_lls[n]);
                            }*/
                        }
                    }
                });
            }
            var result = this._addRoadLine(_l, _lines, false, eval('(' + marker.style + ')'));
            this._addRoadLineRecord(result.markers, result.lines, false, _r.info);
        }

    }
    //
    if(marker.type == KOverlayType.AREA)
    {
        this._addAreaRecord(this._addArea(_l, false, eval('(' + marker.style + ')')), false, _r.info);
    }
};
/**
 * 
 * @param marker KMapMarkerInfo
 * @return Boolean 
 * @uncrunch
 */
KStdMapMarkers.prototype.update = function(marker)
{
    this.add(marker);
    this._update(1, false);
    return true;
};
/**
 * 
 * @param mapmarker KMarker
 * @return Boolean 
 * @uncrunch
 */
KStdMapMarkers.prototype.remove = function(mapmarker)
{
    var _idx = this._getMarkerIndex(mapmarker);
    this._removeList(_idx);
    this._removeRecord(_idx);
    return true;
};

/*===========================  ==========================*/
/**
 * 
 * @uncrunch
 */
KStdMapMarkers.prototype.showToolbar = function()
{
    var _offset = this.options().markbtn ? $(this.options().markbtn).offset() : {left : 0, top : 0};
    this._toolbar.css({
        top : (_offset.top + (this.options().offset ? this.options().offset.top : 0)) + 'px'
        ,left : (_offset.left + (this.options().offset ? this.options().offset.left : 0)) + 'px'
    });
    this._toolbar.show();
    KEvent.trigger(this, 'toolshow');
};
/**
 * 
 * @uncrunch
 */
KStdMapMarkers.prototype.hideToolbar = function()
{
    this._toolbar.hide();
    KEvent.trigger(this, 'toolhide');
};
/**
 * 
 * @uncrunch
 */
KStdMapMarkers.prototype.clear = function()
{
    this._clearList();
    this._clearMarkers();
    this._clearRecord();
};
/**
 * 
 * @return Boolean
 * @uncrunch
 */
KStdMapMarkers.prototype.toolVisible = function()
{
    return this._toolbar.is(':visible');
};
/**
 * ID
 * @param id IntegerID
 * @uncrunch
 */
KStdMapMarkers.prototype.loadByLink = function(id)
{
    var _this = this;
    //
    this._mmid = id;
    //
    this._at = 4;
    //
    if(KMap.isInitialized(this.options().mapcontainer))
    {
        this._load();
    } else {
        KEvent.bind(KMap, 'mapinit', function(){
            _this._load();
            KEvent.unbind(KMap, 'mapinit', arguments.callee)
        });
    }
};
/**
 * 
 * @return KMapMode[] 
 * @uncrunch
 */
KStdMapMarkers.prototype.supportMapModels = function()
{
    return [KMapMode.BOOKMARK, KMapMode.DRAWLINE, KMapMode.DRAWAREA, KMapMode.ROADLINE];
};


/*===========================  ===========================*/
/**
 * 
 */
KStdMapMarkers.prototype._initVariable = function()
{
    this._$dom = undefined; // jQuery
    this._toolbar = undefined;  // jQuery
    this._rstcontainer = undefined; // jQuery
    this._tools = undefined;    //
    /*this._tmb = undefined;   //
    this._tlb = undefined;   //
    this._tcb = undefined;   //
    this._tfb = undefined;  //*/
    this._recorder =    //
    {
        sno :        //
        {
            m : 1   //
            ,l : 1  //
            ,r : 1  //
            ,a : 1  //
        }
        ,records : []   //
    };
    this._idx = undefined;  //
    this._overlay = undefined;  //
    this._infowin = undefined;  //Dom
    this._iwEdit = undefined;   //Dom
    this._iwNormal = undefined; //Dom
    this._iwStyle = undefined;  //Dom
    this._uploadFrm = undefined;    //Iframe
    this._dTitle = undefined;   //
    this._at = 1;                   //
    this._mmid = undefined;     //
    this._alertmsg = function(dom){
      KTools.showMsg('<div style="padding:5px 10px 5px 10px;font-size:13px;"></div>', {title:"",lightbox:true,closedcbk:function(){dom.focus();},buboptions:{outside:false,closebtn:true}});
    };
    this._tmpInfo = {t : undefined, d : undefined}; //
};
/**
 * DOM
 * @param container
 */
KStdMapMarkers.prototype._getDom = function(container)
{
    this._dom = container;
    this._$dom = $(container).hide();
    this._toolbar = $('ul', this._$dom).eq(0); //
    this._rstcontainer = $('ul', this._$dom).eq(1); //
    this._tools = $('>li>a', this._toolbar);    //
    /*this._tmb = $('>li>a[mfg="bk"]', this._toolbar).eq(0);  //
    this._tlb = $('>li>a[mfg="pl"]', this._toolbar).eq(0);    //
    this._tcb = $('>li>a[mfg="rl"]', this._toolbar).eq(0);    //
    this._tfb = $('>li>a[mfg="pg"]', this._toolbar).eq(0);    //*/

    //body
    this._toolbar.appendTo($('body')).hide().css({'z-index' : this.options().zindex});
};
/**
 * 
 * @param sign String 
 * @param theme String 
 */
KStdMapMarkers.prototype._class = function(sign, theme)
{
    theme = theme || this._theme;
    return theme + KStdMapMarkers.conf.CONST.wname + KStdMapMarkers.conf.CLASSNAME[sign];
};
/**
 * 
 * @param scheme
 * @param init Boolean 
 */
KStdMapMarkers.prototype._setTheme = function(scheme, init)
{
    this._theme = scheme;
    if(!init) this._applyTheme();
};
/**
 * 
 * @param opts
 * @param init Boolean 
 */
KStdMapMarkers.prototype._setOptions = function(opts, init)
{
    var _opts = KTools.copyOptions(opts, KStdMapMarkersOptions);
    var _diff = KTools.compareOptions(this._opts, _opts);   //
    this._opts = _opts;
    for(var p in _diff)
    {
        if(p == 'theme') this._setTheme(_diff[p], init);
        if(p == 'zindex' && !init && this._toolbar)  this._toolbar.css({'z-index' : _diff[p]});
    }
};
/**
 * 
 */
KStdMapMarkers.prototype._applyTheme = function()
{
    var _this = this;
    this._$dom.removeClass().addClass(this._class('SMM'));  //
    this._toolbar.removeClass().addClass(this._class('TLST'));  //
    this._rstcontainer.removeClass().addClass(this._class('RST'));  //
    this._tools.each(function(){
        var _cla = '';
        switch($(this).attr('mfg'))
        {
            case 'bk':
            {
                _cla = _this._class('TM');
                break;
            }
            case 'pl':
            {
                _cla = _this._class('TL');
                break;
            }
            case 'rl':
            {
                _cla = _this._class('TC');
                break;
            }
            case 'pg':
            {
                _cla = _this._class('TF');
                break;
            }
        }
        $(this).removeClass().addClass(_cla);
    });
    /*this._tmb.removeClass().addClass(this._class('TM'));  //
    this._tlb.removeClass().addClass(this._class('TL'));    //
    this._tcb.removeClass().addClass(this._class('TC'));    //
    this._tfb.removeClass().addClass(this._class('TF'));    //*/
};
/**
 * 
 * @param mfg String 
 */
KStdMapMarkers.prototype._resumeTools = function(mfg)
{
    this._tools.each(function(){
        var _cla = this.className;
        if(mfg && ($(this).attr('mfg') == mfg))
        {
            $(this).removeClass().addClass(_cla.replace(/s$/, '') + 's');
        }
        else
        {
            $(this).removeClass().addClass(_cla.replace(/s$/, ''));
        }
    });
};
/**
 * 
 */
KStdMapMarkers.prototype._bindEvent = function()
{
    var _this = this;
    //
    this._tools.unbind().bind('click', function(){
        var reg = new RegExp('.*s$');
        var _cla = this.className;
        if(!reg.test(_cla))
        {
            _this._setMarkMode($(this).attr('mfg'));
        }
        else
        {
            _this._setMarkMode();
        }
    });
    //
    if(this.options().clearbtn)
    {
        $(this.options().clearbtn).unbind().bind('click', function(){
            KTools.showMsg('', {title : '', buttons : KMsgBoxButtons.YesNo, node : this,
                closedcbk : function(action, button){
                if(action == 'button' && button.name == 'yes')
                {
                    KMap.closeInfoWindow();
                    _this.clear();
                }
            }});
        });
    }
    //
    if(this.options().sharebtn)
    {
        $(this.options().sharebtn).unbind().bind('click', function(){
            _this._shardLink();
        });
    }
    //modechanged
    KEvent.bind(KMap, 'modechanged', this._mapModeChanged, {}, this);
    //bookmark
    KEvent.bind(KMap, 'bookmark', this._bookmark, {}, this);
    //drawline
    KEvent.bind(KMap, 'drawline', this._drawline, {}, this);
    //roadline
    KEvent.bind(KMap, 'roadline', this._roadline, {}, this);
    //drawarea
    KEvent.bind(KMap, 'drawarea', this._drawarea, {}, this);
    //iw_hide
    KEvent.bind(KMap, 'iw_hide', this._iw_hide, {}, this);
    //afteropeninfowindow
    KEvent.bind(KMap, 'afteropeninfowindow', this._afterOpenInfoWindow, {}, this);
};
/**
 * 
 * @param overlay KOverlay
 */
KStdMapMarkers.prototype._initInfoWindow = function(overlay)
{
    //
    this._idx = this._getMarkerIndex(overlay);
    this._overlay = overlay;

    this._infowin = overlay.iwcDom();
    this._iwNormal = $('div[mfg="df"]', this._infowin); //
    this._iwEdit = $('div[mfg="ep"]', this._infowin);   //
    this._iwStyle = $('div[mfg="se"]', this._infowin);  //
    //
    this._setInfoWindowDefaultValue();
    //
    if(this._idx > -1)
    {
        //
        this._showInterface('df', this._recorder.records[this._idx] ? this._recorder.records[this._idx].info.t : '');
        //
        this._bindInfoWindowFun();
    }
    else
    {
        //
        //
        this._showInterface('ep', '');
        //
        this._bindInfoWindowFun();

    }
};
/**
 * 
 */
KStdMapMarkers.prototype._bindInfoWindowFun = function()
{
    var _this = this;
    var _n = this._recorder.records[this._idx];

    //----------  ----------
    //
    $('a[mfg="ep_c"]', this._iwEdit).unbind().bind('click', function(){
        KMap.closeInfoWindow();
    });
    //
    $('a[mfg="ep_l"]', this._iwEdit).unbind().bind('click', function(){
        _this._showInterface('se', _this._overlay.options().extdata['mark'] == 'bk' ? '' : '');
    });
    //
    if(!_this._isHasFlash){
    	//$('input[mfg="ep_frm_f"]', this._iwEdit).unbind().bind('change', {owner : this, obj : $('input[mfg="ep_frm_f"]', this._iwEdit)}, this._uploadFile);
    }
    //
    $('div[mfg="ep_p"] a', this._iwEdit).unbind().bind('click', {owner : this}, _this._isHasFlash?_this._removeSwfImage:_this._removeImage);
    //$('div[mfg="ep_p"] a', this._iwEdit).unbind().bind('click', {owner : this}, this._removeImage);
    //
    $('input[mfg="ep_s"]', this._iwEdit).unbind().bind('click', function(){
        _this._saveInfo();
        KMap.closeInfoWindow();
    });

    //----------  ----------
    //
    $('a[mfg="df_e"]', this._iwNormal).unbind().bind('click', function(){
        _this._showInterface('ep', '');
    });
    //
    $('a[mfg="df_d"]', this._iwNormal).unbind().bind('click', function(){
        KTools.showMsg('', {title : '', buttons : KMsgBoxButtons.YesNo, node : $(this).get(0), closedcbk : function(action, button){
            if(action == 'button' && button.name == 'yes')
            {
                KMap.closeInfoWindow();
                _this._removeRecord(_this._idx);
                _this._removeList(_this._idx);
            }
        }});
    });
    this._initSearchbox();

    //----------  ----------
    //
    var _bcolor = $('div[mfg="se_bc"]', this._iwStyle);
    //
    var _bcl = $('div[mfg="se_bcp"]', this._iwStyle);
    //
    var _lcolor = $('div[mfg="se_c"]', this._iwStyle);
    //
    var _lcl = $('div[mfg="se_cp"]', this._iwStyle);
    //
    var _bwidth = $('input[mfg="se_st"]', this._iwStyle);
    //
    var _balpha = $('input[mfg="se_t"]', this._iwStyle);
    //
    var _fcolor = $('div[mfg="se_fc"]', this._iwStyle);
    //
    var _fcl = $('div[mfg="se_fcp"]', this._iwStyle);
    //
    var _falpha = $('input[mfg="se_ft"]', this._iwStyle);


    //
    $('a[mfg="se_b"]', this._iwStyle).unbind().bind('click', function(){
        _this._showInterface('ep', '');
    });
    if(this._overlay.options().extdata['mark'] == 'bk')
    {
        //
        $('ul[mfg="se_c"] li a', this._iwStyle).unbind().bind('click', function(){
            $('a[mfg="ep_l"] div', _this._iwEdit).attr('class', $('div', $(this)).attr('class'));
            _this._showInterface('ep', '');
        });
    }
    else
    {
        //
        $('a[mfg="se_c"]', this._iwStyle).unbind().bind('click', function(){
            _this._showInterface('ep', '');
        });
        //
        $('input[mfg="se_s"]', this._iwStyle).unbind().bind('click', function(){
            var _l = $('a[mfg="ep_l"]', this._iwEdit);
            var _s = {};
            var _bs = {};

            if(!_fcolor.get(0))
            {
                _s.backgroundColor = _this._Rgb2HexColor(_lcolor.css('background-color'));
                _s.opacity = parseFloat(_balpha.val()) / 100;

                $('span', _l).css(_s);
            }
            else
            {
                _s.backgroundColor = _this._Rgb2HexColor(_fcolor.css('background-color'));
                _s.opacity = parseFloat(_falpha.val()) / 100;

                $('span', _l).css(_s);
            }

            _this._showInterface('ep', '');
        });


        //
        _lcolor.unbind().bind('click', function(){
            _lcl.css('display', _lcl.css('display') == 'none' ? 'block' : 'none');
        });
        _lcl.colorPicker({
            columns : 18
            ,color : KStdMapMarkers.conf.CONST.colors
            ,defaultColor : _this._Rgb2HexColor(_n ? _n.info.s.l.c : '#ff0000')
            ,click : function(color){
                color = _this._Rgb2HexColor(color);
                _lcolor.css('background-color', color);
                _lcl.css('display','none');
                _this._setSampleStyle({color : color});
            }
        });
        _lcolor.css({'background-color' : _this._Rgb2HexColor(_n ? _n.info.s.l.c : '#ff0000')});
        //
        _bcolor.unbind().bind('click', function(){
            _bcl.css('display', _bcl.css('display') == 'none' ? 'block' : 'none');
        });
        _bcl.colorPicker({
            columns : 18
            ,color : KStdMapMarkers.conf.CONST.colors
            ,defaultColor : _this._Rgb2HexColor(_n ? _n.info.s.l.c : '#ff0000')
            ,click : function(color){color = _this._Rgb2HexColor(color);_bcolor.css('background-color', color);_bcl.css('display','none');}
        });
        _bcolor.css({'background-color' : _this._Rgb2HexColor(_n ? _n.info.s.l.c : '#ff0000')});
        //
        _fcolor.unbind().bind('click', function(){
            _fcl.css('display',  _fcl.css('display') == 'none' ? 'block' : 'none');
        });
        _fcl.colorPicker({
            columns : 18
            ,color : KStdMapMarkers.conf.CONST.colors
            ,defaultColor : _this._Rgb2HexColor(_n ? _n.info.s.f.c : '#ff0000')
            ,click : function(color){
                color = _this._Rgb2HexColor(color);
                _fcolor.css('background-color', color);
                _fcl.css('display','none');
                _this._setSampleStyle({color : color});
            }
        });
        _fcolor.css({'background-color' : _this._Rgb2HexColor(_n ? _n.info.s.f.c : '#ff0000')});
        var _oval = '';

        //
        _bwidth.unbind().bind('keydown', function(e){
            _oval = $(this).val();
            var _kc = e.keyCode;
            if((_kc == 8) || (_kc >= 96 && _kc <= 105) || (_kc >= 48 && _kc <= 57))
            {
            }
            else
            {
                return false;
            }
        }).bind('keyup', function(e){
            if(isNaN($(this).val()) || parseInt($(this).val()) == 0) {
                $(this).val(_oval == '' ? '5' : _oval);
            }
        }).bind('blur', function(){
            if($(this).val() == ''){
                $(this).val(_oval == '' ? '5' : _oval);
            }
        });
        //
        _balpha.unbind().bind('keydown', function(e){
            _oval = $(this).val();
            var _kc = e.keyCode;
            if((_kc == 8) || (_kc >= 96 && _kc <= 105) || (_kc >= 48 && _kc <= 57))
            {
            }
            else
            {
                return false;
            }
        }).bind('keyup', function(e){
            if(isNaN($(this).val()) || parseInt($(this).val()) == 0){
                $(this).val(_oval == '' ? '60' : _oval);
            }
            if(!_falpha.get(0))
            {
                _this._setSampleStyle({alpha : $(this).val()});
            }
        }).bind('blur', function(){
            if($(this).val() == ''){
                $(this).val(_oval == '' ? '5' : _oval);
            }
        });
        //
        _falpha.unbind().bind('keydown', function(e){
            _oval = $(this).val();
            var _kc = e.keyCode;
            if((_kc == 8) || (_kc >= 96 && _kc <= 105) || (_kc >= 48 && _kc <= 57))
            {
            }
            else
            {
                return false;
            }
        }).bind('keyup', function(e){
            if(isNaN($(this).val()) || parseInt($(this).val()) == 0){
                $(this).val(_oval == '' ? '30' : _oval);
            }
            _this._setSampleStyle({alpha : $(this).val()});
        }).bind('blur', function(){
            if($(this).val() == ''){
                $(this).val(_oval == '' ? '5' : _oval);
            }
        });
    }
};
/**
 * 
 * @param opt Object  color   alpha 
 */
KStdMapMarkers.prototype._setSampleStyle = function(opt)
{
    var _s = $('span[mfg="se_cs"]', this._iwStyle);
    if(opt.color)
    {
        _s.css('background-color', opt.color);
    }
    if(opt.alpha)
    {
        opt.alpha = isNaN(opt.alpha) ? 99 : opt.alpha;
        opt.alpha = (parseInt(opt.alpha) > 99 || parseInt(opt.alpha) < 1) ? 99 : opt.alpha;
        opt.alpha = parseFloat(opt.alpha) / 100;
        _s.css({opacity : opt.alpha});
    }
};
/**
 * RGBHex
 * @param color String RGB
 * @return String Hex
 */
KStdMapMarkers.prototype._Rgb2HexColor = function(color)
{
    //Hex
    if(color.indexOf('#') >= 0) return color;
    var _pattern = new RegExp('2[0-4]\\d|25[0-5]|[01]?\\d\\d?','ig');
    var _va = color.match(_pattern);
    //RGB
    if(_va.length != 3) return color;
    var _result = '#';
    for(var i = 0; i < 3; i++)
    {
        var _num  = parseInt(_va[i]);
        _result += _num < 16 ? '0' + _num.toString(16) : _num.toString(16);
    }
    return _result;
};
/**
 * 
 */
KStdMapMarkers.prototype._saveInfo = function()
{
    var _idx = this._getMarkerIndex(this._overlay);
    var _n = this._recorder.records[_idx];
    //
    _n.info.d = this._escapeHtml($('textarea[mfg="ep_i"]', this._iwEdit).val());
    //
    var _t = this._escapeHtml($('input[mfg="ep_t"]', this._iwEdit).val().substring(0, KStdMapMarkers.conf.CONST.titlelen));
    if($.trim(_t) != '')
    {
        _n.info.t = _t;
        //this._changeNameOnList(_n.info.t);
    }
    //
    _n.info.i = $('div[mfg="ep_p"] img', this._iwEdit).attr('src');
    //
    switch(_n.info.mt)
    {
        //
        case 'IM':
            var _c = $('a[mfg="ep_l"] div', this._iwEdit).attr('class');
            //
            _n.info.s.c.x = parseInt(_c.substr(_c.length - 2, 1));
            _n.info.s.c.y = parseInt(_c.substr(_c.length - 1, 1));
            //
            this._overlay.setIconClass(_c);
            break;
        //
        case 'IC':
        //
        case 'IL':
            var _a = $('input[mfg="se_t"]', this._iwStyle).val();
            var _w = $('input[mfg="se_st"]', this._iwStyle).val();
            var _c = $('div[mfg="se_c"]', this._iwStyle).css('background-color');
            //
            _n.info.s.l.a = isNaN(_a) ? 60 : parseInt(_a);
            _n.info.s.l.w = isNaN(_w) ? 5 : parseInt(_w);
            _n.info.s.l.c = _c == '' ? '#FF0000' : _c;
            this._overlay.setBrush({color : _n.info.s.l.c, width : _n.info.s.l.w, transparency : _n.info.s.l.a});
            break;
        //
        case 'IF':
            var _lc = $('div[mfg="se_bc"]', this._iwStyle).css('background-color');
            var _lw = $('input[mfg="se_st"]', this._iwStyle).val();
            var _la = $('input[mfg="se_t"]', this._iwStyle).val();
            var _fc = $('div[mfg="se_fc"]', this._iwStyle).css('background-color');
            var _fa = $('input[mfg="se_ft"]', this._iwStyle).val();
            //
            _n.info.s.l.c = _lc == '' ? '#FF0000' : _lc;
            _n.info.s.l.w = isNaN(_lw) ? 5 : parseInt(_lw);
            _n.info.s.l.a = isNaN(_la) ? 60 : parseInt(_la);
            _n.info.s.f.c = _fc == '' ? '#FF0000' : _fc;
            _n.info.s.f.a = isNaN(_fa) ? 30 : parseInt(_fa);
            //
            this._overlay.setBrush({color : _n.info.s.l.c, width : _n.info.s.l.w, transparency : _n.info.s.l.a, bgcolor : _n.info.s.f.c, bgtransparency : _n.info.s.f.a});
            break;
    }
    //
    this._updateList(_idx);
    //
    this._recorder.records[_idx].at = 1;
};
/**
 * html
 * @param str String 
 * @return String 
 */
KStdMapMarkers.prototype._escapeHtml = function(str)
{
    return str ? str.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';
};

/**
 * html
 * @param str String 
 * @return String 
 */
KStdMapMarkers.prototype._unescapeHtml = function(str)
{
    return str ? str.replace(/(\&lt;)/g, '<').replace(/(\&gt;)/g, '>') : '';
};
/**
 * 
 * @param Event Object
 */
KStdMapMarkers.prototype._uploadFile = function(event)
{
    var _this = event.data && event.data.owner ? event.data.owner : this;
    var _this_ = event.data && event.data.obj ? event.data.obj : this;
    if($(_this_).val() != '')
    {
        if(!_this.options().uploadUrl)
        {
            KTools.showMsg('', {node : _this_, title : '', autoclose : 5})
        }
        else
        {
            var _reg = /.+\.(jpg|jpeg|png)/;
            var _fileName = $(_this_).val().toLowerCase();
            //
            if(_reg.test(_fileName))
            {
                if(!_this._uploadFrm)
                {
                    //IEIFramecreateElementnamename
                    if($.browser.msie) {
                        //IEIFramename
                        iframe = document.createElement("<IFRAME name='uf" + Math.floor(Math.random() * 99) + "'>");
                    } else {
                        iframe = document.createElement("IFRAME");
                        iframe.name = 'uf' + Math.floor(Math.random() * 99);
                    }
                    iframe.frameBorder = "0";
                    iframe.style.width = "0px";
                    iframe.style.height = "0px";
                    iframe.style.zIndex = -1;
                    document.body.appendChild(iframe);
                    _this._uploadFrm = $(iframe);
                    _this._uploadFrm.unbind().bind('load', function(){
                        var _ifrm = _this._uploadFrm.get(0);
                        var _r;
                        if (_ifrm.contentDocument) {
                            _r = _ifrm.contentDocument.body.innerHTML;
                        }
                        else if (_ifrm.contentWindow) {
                            _r = _ifrm.contentWindow.document.body.innerHTML;
                        }
                        _this._imgUploaded(eval('(' + _r + ')'));
                    });
                }
                var _frm = $('form[mfg="ep_frm"]', _this._iwEdit).attr({action : _this.options().uploadUrl, target : _this._uploadFrm.attr('name')}).submit();
            }
            else
            {
                $('input[mfg="ep_frm_f"]', this._iwEdit).val('');
                if(!$('input[mfg="ep_frm_f"]', this._iwEdit).get(0).files)
                {
                    $('input[mfg="ep_frm_f"]', this._iwEdit).unbind();
                    var _html = $('form[mfg="ep_frm"]', this._iwEdit).html();
                    $('form[mfg="ep_frm"]', this._iwEdit).html(_html);
                    $('input[mfg="ep_frm_f"]', this._iwEdit).bind('change', {owner : _this, obj : $('input[mfg="ep_frm_f"]', this._iwEdit)},_this._uploadFile);
                }
                KTools.showMsg('', {title : '', autoclose : 5, node : $('input[mfg="ep_frm_f"]', _this._iwEdit).get(0)});
            }
        }
    }
};
/**
 * 
 * @param obj
 */
KStdMapMarkers.prototype._imgUploaded = function(obj)
{
    var _this = this;
    if(obj.e)
    {
        //
        KTools.showMsg(obj.e, {node : $('input[mfg="ep_frm_f"]', this._iwEdit).get(0), title : '', autoclose : 5})
    }
    else
    {
        if(obj.a.length > 0)
        {
            //
            var _ic = $('div[mfg="ep_p"]', this._iwEdit);
            //
            $('img', _ic).attr('src', obj.a[0].a);
            //
            $('form[mfg="ep_frm"]', this._iwEdit).css('display', 'none');
            //
            _ic.css('display', 'block');

            //Iframe  
            /*KTools.removeNode(this._uploadFrm.get(0));
            this._uploadFrm = undefined;*/
        }
    }
    $('input[mfg="ep_frm_f"]', this._iwEdit).val('');
    if(!$('input[mfg="ep_frm_f"]', this._iwEdit).get(0).files)
    {
        $('input[mfg="ep_frm_f"]', this._iwEdit).unbind();
        var _html = $('form[mfg="ep_frm"]', this._iwEdit).html();
        $('form[mfg="ep_frm"]', this._iwEdit).html(_html);
        $('input[mfg="ep_frm_f"]', this._iwEdit).bind('change', {owner : _this, obj : $('input[mfg="ep_frm_f"]', this._iwEdit)}, _this._uploadFile);
        KTools.removeNode(this._uploadFrm.get(0));
        this._uploadFrm = undefined;
    }
};
/**
 * 
 * @param obj
 */
KStdMapMarkers.prototype._imgSwfUploaded = function(obj)
{
    var _this = this;
    if(obj.e)
    {
        //
        KTools.showMsg(obj.e, {node : $('input[mfg="ep_frm_f"]', this._iwEdit).get(0), title : '', autoclose : 5})
    }
    else
    {
        if(obj.a.length > 0)
        {
            //
            var _ic = $('div[mfg="ep_p"]', this._iwEdit);
            var img = $('img', _ic).get(0);
            img.src = obj.a[0].a;
            var count = 0;
            img.onerror = function () {
                setTimeout(function() {
                    count++;
                    if(count < 8) {
                        img.src = obj.a[0].a+ "?" + count;
                    }
                },2000);
            };
            img.onload = function () {
                $('span[mfg="ep_frm"]', this._iwEdit).css('display', 'none');
                _ic.css('display', 'block');
                $('span[mfg="ep_frm_fname"]', this._infowin).html("");
            };
            //change by tanzh;
            /*setTimeout(function(){
            	//
//                $('img', _ic).attr('src', obj.a[0].a.replace("www.mapbar.com/search/","img.mapbar.com/web/3in1/"));
                $('img', _ic).attr('src', obj.a[0].a);
                //
                $('span[mfg="ep_frm"]', this._iwEdit).css('display', 'none');
                //
                _ic.css('display', 'block');
                *//*$('span[mfg="ep_frm_fname"]', infoDom).html("");
                *change by tanzh*//*
                $('span[mfg="ep_frm_fname"]', this._infowin).html("");
            },1000);*/
            //Iframe  
            /*KTools.removeNode(this._uploadFrm.get(0));
            this._uploadFrm = undefined;*/
        }
    }
};
/**
 * 
 */
KStdMapMarkers.prototype._removeImage = function(event)
{
    var _this = event.data.owner;
    KTools.showMsg('', {title : '', buttons : KMsgBoxButtons.YesNo, node : $('div[mfg="ep_p"] img', _this._iwEdit).get(0), closedcbk : function(action, button){
        if(action == 'button' && button.name == 'yes')
        {
            var _ic = $('div[mfg="ep_p"]', _this._iwEdit);
            //
            $('img', _ic).attr('src', '');
            //
            $('form[mfg="ep_frm"]', _this._iwEdit).css('display', 'block');
            //
            _ic.css('display', 'none');
            //
            _this._recorder.records[_this._idx < 0 ? _this._recorder.records.length - 1 : _this._idx].info.i = '';
        }
    }});
};
/**
 * 
 */
KStdMapMarkers.prototype._removeSwfImage = function(event)
{
    var _this = event.data.owner;
    KTools.showMsg('', {title : '', buttons : KMsgBoxButtons.YesNo, node : $('div[mfg="ep_p"] img', _this._iwEdit).get(0), closedcbk : function(action, button){
        if(action == 'button' && button.name == 'yes')
        {
            var _ic = $('div[mfg="ep_p"]', _this._iwEdit);
            //
            $('img', _ic).attr('src', '');
            //
            $('span[mfg="ep_frm"]', _this._iwEdit).show();
            //
            _ic.css('display', 'none');
            //
            _this._recorder.records[_this._idx < 0 ? _this._recorder.records.length - 1 : _this._idx].info.i = '';
            KMap.moveMap(0,0);//chrome
        }
    }});
};
/**
 * infowWindow
 * @param mfg String mfg
 * @param title String 
 */
KStdMapMarkers.prototype._showInterface = function(mfg, title)
{
    title = title || '';;
    //

    this._iwNormal.css('display', 'none');
    this._iwEdit.css('display', 'none');
    this._iwStyle.css('display', 'none');
    //
    switch(mfg)
    {
        case 'df':
            this._overlay.setOptions({'infowin' : {'title' : title}});
            this._iwNormal.css('display', '');
            break;
        case 'ep':
            this._overlay.setOptions({'infowin' : {'title' : title}});
            this._iwEdit.css('display', '');
            break;
        case 'se':
            this._overlay.setOptions({'infowin' : {'title' : title}});
            this._iwStyle.css('display', '');
            break;
    }
};
/**
 * 
 */
KStdMapMarkers.prototype._setInfoWindowDefaultValue = function()
{
    var record = this._recorder.records[this._idx];
    var _this = this;
    //----------  ----------
    //
    $('span[mfg="se_cs"]', this._iwStyle).css({'background-color' : record ? record.info.s.l.c : '#FF0000', opacity : record ? record.info.s.l.a / 100 : 0.6});
    //
    $('input[mfg="se_st"]', this._iwStyle).val(record ? record.info.s.l.w : '5');
    //
    $('input[mfg="se_t"]', this._iwStyle).val(record ? record.info.s.l.a : '60');
    //
    $('input[mfg="se_ft"]', this._iwStyle).val(record ? record.info.s.f.a : '30');
    //
    $('span[mfg="se_cs"]', this._iwStyle).css({'background-color' : record ? record.info.s.f.c : '#FF0000', opacity : record ? record.info.s.f.a / 100 : 0.6});
    //----------  ----------
    //
    var _title = $('input[mfg="ep_t"]', this._iwEdit).attr('maxlength', KStdMapMarkers.conf.CONST.titlelen);
    if(record)
    {
        _title.val(this._unescapeHtml(record.info.t));
    }
    else
    {
        setTimeout(function(){
            _title.val(_this._tmpInfo.t);
        }, 10);
    }
    //
    $('textarea[mfg="ep_i"]', this._iwEdit).val(record ? this._unescapeHtml(record.info.d) : KStdMapMarkers.conf.CONST.txtNoDes);
    //
    var _ic = $('div[mfg="ep_p"]', this._iwEdit);
    var _frm = _this._isHasFlash?$('span[mfg="ep_frm"]', this._iwEdit):$('form[mfg="ep_frm"]', this._iwEdit);
    if(record && record.info.i && record.info.i != '')
    {
        $('img', _ic).attr('src', record.info.i);
        _ic.css('display', 'block');
        _frm.css('display', 'none');
    }
    else
    {
        _ic.css('display', 'none');
        _frm.css('display', 'block');
    }
    //
    var _msb = $('a[mfg="ep_l"]>div', this._iwEdit);
    if(_msb.get(0))
    {
        var _cla = _msb.attr('class');
        _msb.removeClass(_cla).addClass(_cla.replace(/(\d\d)$/, ((record ? record.info.s.c.x : 1).toString()) + (
                (record ? record.info.s.c.y : 1).toString())));
    }
    //
    var _lsb = $('a[mfg="ep_l"]>span', this._iwEdit);
    if(_lsb.get(0))
    {
        //
        if(record && (record.info.mt == 'IL' || record.info.mt == 'IC'))
        {
            _lsb.css({
                'background-color' : record ? record.info.s.l.c : '#FF0000'
                ,'opacity' : parseFloat(record ? record.info.s.l.a : 60) / 100
            });
        }
        //
        if(record && record.info.mt == 'IF')
        {
            _lsb.css({
                'background-color' : record ? record.info.s.f.c : '#FF0000'
                ,'opacity' : parseFloat(record ? record.info.s.f.a : 60) / 100
            });
        }
    }
    //----------  ----------
    //
    var _img = $('img[mfg="df_f"]', this._iwNormal);
    if(record && record.info.i != '')
    {
        _img.attr('src', record.info.i);
        _img.parent().css('display', 'block');
    }
    else
    {
        _img.parent().css('display', 'none');
    }
    //
    $('p[mfg="df_i"]').html(record && record.info.d != '' ? record.info.d : KStdMapMarkers.conf.CONST.txtNoDes);

    var _latlons = [];
    var _r = 0;
    var _aunit = '';
    var _lunit = '';
    //
    if(record && record.info.mt == 'IF')
    {
        for(i in record.latlon.a)
        {
            _latlons.push(new MPoint(record.latlon.a[i]));
        }
        $('strong[mfg="df_ds"]', this._iwNormal).html(this._convertData('a', KMap.area(_latlons)));
    }
    //
    if(record && (record.info.mt == 'IL' || record.info.mt == 'IC'))
    {
        for(i in record.latlon.l)
        {
            _latlons.push(new MPoint(record.latlon.l[i]));
        }
        $('strong[mfg="df_ds"]', this._iwNormal).html(this._convertData('d', KMap.distance(_latlons)));
    }
};
/**
 * 
 * @param type String  a    d 
 * @param value Integer 
 */
KStdMapMarkers.prototype._convertData = function(type, value)
{
    var result = value;
    var unit = (type == 'a' ? KStdMapMarkers.conf.CONST.aunit : KStdMapMarkers.conf.CONST.dunit);
    if(value > (type == 'a' ? 1000000 : 1000))
    {
        result = type == 'a' ? this._formatFloat((parseFloat(value) / 1000000), 1) : this._formatFloat((parseFloat(value) / 1000), 1);
        unit = type == 'a' ? KStdMapMarkers.conf.CONST.baunit : KStdMapMarkers.conf.CONST.bdunit;
    }
    return result + unit;
};
/**
 * 
 * @param src Float 
 * @param pos int 
 */
KStdMapMarkers.prototype._formatFloat = function(src,pos)
{
    return Math.round(src * Math.pow(10, pos)) / Math.pow(10, pos);
};
/**
 * 
 * @param mfg String 
 */
KStdMapMarkers.prototype._setMarkMode = function(mfg)
{
    this._resumeTools(mfg); //
    this._setMapMarkMode(mfg);   //
};
/**
 * ()
 * @param mfg String 
 * */
KStdMapMarkers.prototype.setMenuMarkMode = function(latlon)
{
	 this._addMarkerRecord(this._addMarker(latlon, true), true);
};

/**
 * 
 * @param mfg String 
 */
KStdMapMarkers.prototype._setMapMarkMode = function(mfg)
{
    var _mode = KMapMode.PAN; //
    if(mfg)
    {
        //
        switch(mfg)
        {
            case 'bk':
            {
                _mode = KMapMode.BOOKMARK;  //
                break;
            }
            case 'pl':
            {
                _mode = KMapMode.DRAWLINE;  //
                break;
            }
            case 'rl':
            {
                _mode = KMapMode.ROADLINE;  //
                break;
            }
            case 'pg':
            {
                _mode = KMapMode.DRAWAREA;  //
                break;
            }
        }
    }
    KMap.setMode(_mode);    //
};
/**
 * 
 * @param toolbar Boolean 
 * @param deftool Boolean 
 */
KStdMapMarkers.prototype._show = function(toolbar, deftool)
{
    this._$dom.show();  //
    KEvent.trigger(this, 'shown');
    toolbar && this.showToolbar(); //
    deftool && this._setMarkMode('bk');    //
    //this._resumeMarkers();  //
};
/**
 * 
 * @param info Object {ico : '', title : '', des : '', supp : ''}
 * @param select Boolean 
 * @return Node 
 */
KStdMapMarkers.prototype._addList = function(info, select)
{
    var _this = this;
    var node = $('<li/>');
    if(select)
    {
        this._resumeList();
        node.addClass(this._class('S'));
    }
    node.append($('<span/>').addClass(info.ico))
            .append($('<h4/>').html(info.title))
            .append($('<p/>').html(info.des))
            .append($('<p/>').html(info.supp))
            .append($('<p/>').html(KStdMapMarkers.conf.CONST.opanel))
            .appendTo(this._rstcontainer);
    //
    node.unbind().bind('click', function(){
        _this._resumeList();
        $(this).removeClass().addClass(_this._class('S'));
        var _idx = _this._getListIndex(this);
        var _overlays = _this._recorder.records[_idx].overlays;
        var _overlay = undefined;
        switch($('>span', this).attr('class').replace(/^mwp_smm_/, ''))
        {
            case 'im':  //
            {
                _overlay = _overlays.m[0];
                break;
            }
            case 'il':  //
            {
                _overlay = _overlays.l[0];
                break;
            }
            case 'ic':  //
            {
                _overlay = _overlays.l[0];
                break;
            }
            case 'if':  //
            {
                _overlay = _overlays.a[0];
                break;
            }
        }
        /*console.log(_overlay.latlon);
        console.log(_overlay.latlon());*/
        if(_overlay.latlon)
        {
            KMap.setCenter(_overlay.latlon().getPid());
        }
        KMap.openInfoWindow(_overlay);
    }).hover(function(){
        //var _idx = _this._getListIndex(this);
        $(this).addClass(_this._class('H'));
        //_this._hiliteMarker(_idx, true);
    }, function(){
        //var _idx = _this._getListIndex(this);
        $(this).removeClass(_this._class('H'));
        //_this._hiliteMarker(_idx, false);
    });
    //click
    $('a[mfg="del"]', $('>p', node).eq(2)).unbind().bind('click', function(e){
        e.stopPropagation();
        var _li = $(this).parent().parent();
        var _idx = _this._getListIndex(_li.get(0));
        _this._selectList(_idx);
        KTools.showMsg('', {title : '', buttons : KMsgBoxButtons.YesNo, node : $(this).get(0), closedcbk : function(action, button){
            if(action == 'button' && button.name == 'yes')
            {
                KMap.closeInfoWindow();
                _this._removeRecord(_idx);
                _this._removeList(_idx);
            }
            else
            {
                _this._resumeList();
            }
        }});
    });
    //click
    $('a[mfg="edt"]', $('>p', node).eq(2)).unbind().bind('click', function(e){
        e.stopPropagation();
        var _p = $(this).parent().parent();
        var _overlays = _this._recorder.records[_this._getListIndex(_p.get(0))].overlays;
        var _overlay = undefined;
        switch($('>span', _p).attr('class').replace(/^mwp_smm_/, ''))
        {
            case 'im':  //
            {
                _overlay = _overlays.m[0];
                break;
            }
            case 'il':  //
            {
                _overlay = _overlays.l[0];
                break;
            }
            case 'ic':  //
            {
                _overlay = _overlays.l[0];
                break;
            }
            case 'if':  //
            {
                _overlay = _overlays.a[0];
                break;
            }
        }
        KMap.openInfoWindow(_overlay);
        _this._showInterface('ep', '');
    });
    return node.get(0);
};
/**
 * 
 * @param idx Integer 
 */
KStdMapMarkers.prototype._removeList = function(idx)
{
    $('>li', this._rstcontainer).eq(idx).remove();
};
/**
 * 
 */
KStdMapMarkers.prototype._clearList = function()
{
    for(; this._listCount() > 0;)
    {
        this._removeList(0);
    }
};
/**
 * 
 * @param item 
 */
KStdMapMarkers.prototype._getListIndex = function(item)
{
    var _items = $('>li', this._rstcontainer).toArray();
    for(var i = 0; i < _items.length; i++)
    {
        if(item === _items[i]) return i;
    }
};
/**
 * 
 * @param idx Integer 
 */
KStdMapMarkers.prototype._resumeList = function(idx)
{
    var _this = this;
    /*var _items = $('>li', this._rstcontainer).toArray();
    for(var i = 0; i < _items.length; i++)
    {
        $(_items[i]).removeClass();
        if(idx == i) $(_items[i]).addClass(this._class('S'));
    }*/
    $('>li', this._rstcontainer).each(function(i){
        $(this).removeClass();
        if(idx == i) $(this).addClass(_this._class('S'));
    });
};
/**
 * 
 * @return Integer 
 */
KStdMapMarkers.prototype._listCount = function()
{
    return $('>li', this._rstcontainer).length;
};
/**
 * 
 * @param idx Integer 
 */
KStdMapMarkers.prototype._updateList = function(idx)
{
    var _item = $('>li', this._rstcontainer).eq(idx);
    var _info = this._recorder.records[idx].info;
    var _p = $('>p', _item);
    if(_item)
    {
        $('>h4', _item).html(_info.t);  //
        _p.eq(0).html('<em></em>' + ($.trim(_info.d) == '' ? KStdMapMarkers.conf.CONST.txtNoDes : _info.d));    //
    }
};
/**
 * 
 * @param idx Integer 
 * @param val Sring 
 */
KStdMapMarkers.prototype._updateListExt = function(idx, val)
{
    var _item = $('>li', this._rstcontainer).eq(idx);
    if(_item)
    {
        $('>p', _item).eq(1).html(val);
    }
};
/**
 * 
 * @param idx
 */
KStdMapMarkers.prototype._selectList = function(idx)
{
    if(this._listItemSelected(idx) == 0) this._resumeList(idx);
};
/**
 * 
 * @param idx Integer 
 * @return Integer 1    0    -1 
 */
KStdMapMarkers.prototype._listItemSelected = function(idx)
{
    var item = $('>li', this._rstcontainer).eq(idx).get(0);
    if(!item) return -1;
    if(item.className == this._class('S'))
    {
        return 1;
    }
    return 0;
};
/**
 * 
 * @param record Object 
 */
KStdMapMarkers.prototype._addRecord = function(record)
{
    this._recorder.records.push(record);
};
/**
 * 
 * @param idx Integer 
 */
KStdMapMarkers.prototype._removeRecord = function(idx)
{
    var _record = this._recorder.records[idx];
    if(_record.overlays.m.length > 0)
    {
        for(var m in _record.overlays.m)
        {
            KMap.removeMarker(_record.overlays.m[m]);
        }
    }
    if(_record.overlays.l.length > 0)
    {
        for(var l in _record.overlays.l)
        {
            KMap.removeLine(_record.overlays.l[l]);
        }
    }
    if(_record.overlays.a.length > 0)
    {
        for(var a in _record.overlays.a)
        {
            KMap.removeArea(_record.overlays.a[a]);
        }
    }
    delete this._recorder.records[idx];
    this._removeArrayItem(this._recorder.records, idx);
};
/**
 * 
 */
KStdMapMarkers.prototype._clearRecord = function()
{
    this._recorder.records.length = 0;
    this._recorder.sno = {
        m : 1
        ,l : 1
        ,r : 1
        ,a : 1
    };
};
/**
 * 
 * @param latlon MPoint 
 * @param openinfowin Boolean infowindow
 * @param opts Object 
 */
KStdMapMarkers.prototype._addMarker = function(latlon, openinfowin, opts)
{
	var _this = this;
    //
    var _mopt = KTools.copyOptions(
    		{
		        editable : true
		        ,group : 'smm'
		        ,extdata : {
		            flag : KWidgetFlag.mapmarkers
		            ,mark : 'bk'
		        }
		        ,infowin : KConfig.get(_this._isHasFlash?'iw_iwo_mmp_swf':'iw_iwo_mmp', 
		        			{
		        				ep_frm_fn : 'photo', 
		        				df_fs : ''
		        			}
		        		)
		    }, 
		    KConfig.get('mk_mo_mm', 
	    		{
	    			row : opts ? opts.c.x : 1, 
	    			col : opts ? opts.c.y : 1
	    		}
		    )
    );
    //
    var _marker = new KMarker(latlon, _mopt);
    //dragend
    KEvent.bind(_marker, 'dragend', this._markerDragend, {type : 'IM'}, this);
    //
    KMap.addMarker(_marker, false, openinfowin ? openinfowin : false);
    //
    if(KMap.mode() != KMapMode.PAN)
    {
        KMap.setMode(KMapMode.PAN);
    }
    return _marker;
};
/**
 * 
 * @param latlons MPoint[]
 * @param openinfowin Boolean infowindow
 * @param opts Object
 */
KStdMapMarkers.prototype._addLine = function(latlons, openinfowin, opts)
{
	var _this = this;
    //
    var _lopt = {
        brush :
        {
            color : opts && opts.l && opts.l.c ? opts.l.c : '#FF0000'
            ,width : opts && opts.l && opts.l.w ? parseInt(opts.l.w) : 5
            ,transparency : opts && opts.l && opts.l.a ? parseInt(opts.l.a) : 60
        }
        ,editable : true
        ,group : 'smm'
        ,extdata :
        {
            flag : KWidgetFlag.mapmarkers
            ,mark : 'pl'
        }
        ,infowin : KConfig.get(_this._isHasFlash?'iw_iwo_mml_swf':'iw_iwo_mml', {ep_frm_fn : 'photo', df_fs : ''})
    };
    //
    var _line = new KLine(latlons, _lopt);
    //KLinemodified
    KEvent.bind(_line, 'modified', this._modified, {type : 'IL'}, this);
    //
    KMap.addLine(_line, false);
    //infowindow
    openinfowin && KMap.openInfoWindow(_line);
    //
    if(KMap.mode() != KMapMode.PAN)
    {
        KMap.setMode(KMapMode.PAN);
    }
    //
    return _line;
};
/**
 * 
 * @param nodes MPoint[] 
 * @param latlons MPoint[] 
 * @param openinfowin Boolean infowindow
 * @param opts Object
 */
KStdMapMarkers.prototype._addRoadLine = function(nodes, latlons, openinfowin, opts)
{
	var _this = this;
    var result = {markers : [], lines : []};
    //
    var _ropt = {
        brush : {
            color : opts && opts.l && opts.l.c ? opts.l.c : '#FF0000'
            ,width : opts && opts.l && opts.l.w ? parseInt(opts.l.w) : 5
            ,transparency : opts && opts.l && opts.a ? parseInt(opts.l.a) : 60
        }
        ,group : 'smm'
        ,extdata : {
            flag : KWidgetFlag.mapmarkers
            ,mark : 'rl'
        }
        ,infowin : KConfig.get(_this._isHasFlash?'iw_iwo_mmr_swf':'iw_iwo_mmr', {ep_frm_fn : 'photo', df_fs : ''})
    };
    //
    var _line = new KLine(latlons, _ropt);
    result.lines.push(_line);
    //marker
    var _mopt = $.extend(true, {
        extdata : {
            flag : KWidgetFlag.mapmarkers
            ,mark : 'rl'
        }
        ,group : 'smm'
        ,editable : true
    }, KConfig.get('mk_mo_m'));
    delete(_mopt.label);
    //marker
    for(var i = 0; i < nodes.length; i++)
    {
        var _marker = new KMarker(nodes[i], _mopt);
        result.markers.push(_marker);
        //dargend
        KEvent.bind(_marker, 'dragend', this._markerDragend, {type : 'IC'}, this);
    }
    //
    KMap.addMarkers(result.markers, false);
    //
    KMap.addLine(_line, false);
    //infowindow
    openinfowin && KMap.openInfoWindow(_line);
    //
    return result;
};
/**
 * 
 * @param pts KMPoint[]
 * @param openinfowin Boolean 
 * @param opts Object
 */
KStdMapMarkers.prototype._addArea = function(pts, openinfowin, opts)
{
	var _this = this;
    //
    var _aopt = {
        brush : {
            color : opts && opts.l && opts.l.c ? opts.l.c : '#FF0000'
            ,width : opts && opts.l && opts.l.w ? parseInt(opts.l.w) : 5
            ,transparency : opts && opts.l && opts.l.a ? parseInt(opts.l.a) : 60
            ,bgcolor : opts && opts.f && opts.f.c ? opts.f.c : '#FF0000'
            ,bgtransparency : opts && opts.f && opts.f.a ? parseInt(opts.f.a) : 30
        }
        ,editable : true
        ,group : 'smm'
        ,extdata : {
            flag : KWidgetFlag.mapmarkers
            ,mark : 'pg'
        }
        ,infowin : KConfig.get(_this._isHasFlash?'iw_iwo_mma_swf':'iw_iwo_mma', {ep_frm_fn : 'photo', df_fs : ''})
        ,hiliteBrush : KTools.copyOptions({}, KBrushOptions)
    };
    //
    var _area = new KArea(pts, _aopt);
    //KAreamodified
    KEvent.bind(_area, 'modified', this._modified, {type : 'IF'}, this);
    //
    KMap.addArea(_area, false);
    //
    openinfowin && KMap.openInfoWindow(_area);
    //
    return _area;
};
/**
 * 
 * @param marker KMarker 
 * @param bookmark Boolean bookmark
 * @param opts Object
 */
KStdMapMarkers.prototype._addMarkerRecord = function(marker, bookmark, opts)
{
    this._tmpInfo.t = opts && opts.t ? opts.t : '' + this._getSerialNumber('m');
    this._tmpInfo.d = opts && opts.d ? opts.d : KStdMapMarkers.conf.CONST.txtNoDes;
    //
    var _info = {
        ico : this._class('IM')
        ,title : this._tmpInfo.t
        ,des : '<em>' + KStdMapMarkers.conf.CONST.txtDes + '</em>' + this._tmpInfo.d
        ,supp : ''
    };
    //
    var _record = $.extend(true, {}, KStdMapMarkers.conf.CONST.recordStruct);
    var _latlon = marker.latlon().getPid();
    _record.info.mt = 'IM';
    _record.info.l = _latlon;
    _record.info.t = _info.title;
    _record.info.d = opts && opts.d ? opts.d : '';
    _record.info.i = opts && opts.i ? opts.i : '';
    _record.overlays.m.push(marker);
    _record.latlon.m.push(marker.latlon().getPid());
    opts && opts.s && $.extend(true, _record.info.s, opts.s);
    //
    this._addList(_info, bookmark);
    //
    this._addRecord(_record);
};
/**
 * 
 * @param line KLine 
 * @param drawline Boolean drawline
 * @param opts Object
 */
KStdMapMarkers.prototype._addLineRecord = function(line, drawline, opts)
{
    this._tmpInfo.t = opts && opts.t ? opts.t : '' + this._getSerialNumber('l');
    this._tmpInfo.d = opts && opts.d ? opts.d : KStdMapMarkers.conf.CONST.txtNoDes;
    //
    var _info = {
        ico : this._class('IL')
        ,title : this._tmpInfo.t
        ,des : '<em>' + KStdMapMarkers.conf.CONST.txtDes + '</em>' + this._tmpInfo.d
        ,supp : '<em>' + KStdMapMarkers.conf.CONST.txtDist + '</em>' + this._convertData('l', KMap.distance(line.latlons()))
    };
    //
    var _record = $.extend(true, {}, KStdMapMarkers.conf.CONST.recordStruct);
    _record.info.mt = 'IL';
    _record.info.t = _info.title;
    _record.info.d = opts && opts.d ? opts.d : '';
    _record.info.i = opts && opts.i ? opts.i : '';
    _record.overlays.l.push(line);
    var _latlons = line.latlons();
    for(var l in _latlons)
    {
        _record.latlon.l.push(_latlons[l].getPid());
    }
    _record.info.l = _record.latlon.l.join(',');
    opts && opts.s && $.extend(true, _record.info.s, opts.s);
    //
    this._addList(_info, drawline);
    //
    this._addRecord(_record);
};
/**
 * 
 * @param markers KMarker[]
 * @param lines KLine[]
 * @param roadline Boolean roadline
 * @param opts Object
 */
KStdMapMarkers.prototype._addRoadLineRecord = function(markers, lines, roadline, opts)
{
    this._tmpInfo.t = opts && opts.t ? opts.t : '' + this._getSerialNumber('r');
    this._tmpInfo.d = opts && opts.d ? opts.d : KStdMapMarkers.conf.CONST.txtNoDes;
    var latlons = [];
    for(var j = 0; j < lines.length; j++)
    {
        latlons = latlons.concat(lines[j].latlons());
    }
    //
    var _info = {
        ico : this._class('IC')
        ,title : this._tmpInfo.t
        ,des : '<em>' + KStdMapMarkers.conf.CONST.txtDes + '</em>' + this._tmpInfo.d
        ,supp : '<em>' + KStdMapMarkers.conf.CONST.txtDist + '</em>' + this._convertData('l', KMap.distance(latlons))
    };
    //
    var _record =$.extend(true, {}, KStdMapMarkers.conf.CONST.recordStruct);
    _record.info.mt = 'IC';
    _record.info.t = _info.title;
    _record.info.d = opts && opts.d ? opts.d : '';
    _record.info.i = opts && opts.i ? opts.i : '';
    for(var i = 0; i < markers.length; i++)
    {
        _record.overlays.m.push(markers[i]);
        _record.latlon.m.push(markers[i].latlon().getPid());
    }
    _record.info.l = _record.latlon.m.join(',');
    for(var j = 0; j < lines.length; j ++)
    {
        var _latlons = lines[j].latlons();
        for(var k = 0; k < _latlons.length; k++)
        {
            _record.latlon.l.push(_latlons[k].getPid());
        }
        _record.overlays.l.push(lines[j]);
    }
    opts && opts.s && $.extend(true, _record.info.s, opts.s);
    //
    this._addList(_info, roadline);
    //
    this._addRecord(_record);
};
/**
 * 
 * @param area KArea
 * @param drawarea Boolean drawarea
 * @param opts Object
 */
KStdMapMarkers.prototype._addAreaRecord = function(area, drawarea, opts)
{
    this._tmpInfo.t = opts && opts.t ? opts.t : '' + this._getSerialNumber('a');
    this._tmpInfo.d = opts && opts.d ? opts.d : KStdMapMarkers.conf.CONST.txtNoDes;
    //
    var _info = {
        ico : this._class('IF')
        ,title : this._tmpInfo.t
        ,des : '<em>' + KStdMapMarkers.conf.CONST.txtDes + '</em>' + this._tmpInfo.d
        ,supp : '<em>' + KStdMapMarkers.conf.CONST.txtArea + '</em>' + this._convertData('a', KMap.area(area.latlons()))
    };
    //
    var _record = $.extend(true, {}, KStdMapMarkers.conf.CONST.recordStruct);
    _record.info.mt = 'IF';
    _record.info.t = _info.title;
    _record.info.d = opts && opts.d ? opts.d : '';
    _record.info.i = opts && opts.i ? opts.i : '';
    _record.overlays.a.push(area);
    var _latlons = area.latlons();
    for(var i = 0; i < _latlons.length; i++)
    {
        _record.latlon.a.push(_latlons[i].getPid());
    }
    _record.info.l = _record.latlon.a.join(',');
    opts && opts.s && $.extend(true, _record.info.s, opts.s);
    //
    this._addList(_info, drawarea);
    //
    this._addRecord(_record);
};
/**
 * 
 * @param arr Array 
 * @param idx Int index
 */
KStdMapMarkers.prototype._removeArrayItem = function(arr, idx)
{
    if(isNaN(idx) || idx > arr.length) return false;
    for(var i = 0, n = 0; i < arr.length; i++)
    {
        if(arr[i] != arr[idx])
        {
            arr[n++] = arr[i];
        }
    }
    arr.length -= 1;
};
/**
 * 
 * @param type String   m   l   r   a 
 * @return Integer 
 */
KStdMapMarkers.prototype._getSerialNumber = function(type)
{
    var _no = 0;
    switch(type)
    {
        case 'm':   //
        {
            _no = this._recorder.sno.m++;
            break;
        }
        case 'l':   //
        {
            _no = this._recorder.sno.l++;
            break;
        }
        case 'r':   //
        {
            _no = this._recorder.sno.r++;
            break;
        }
        case 'a':   //
        {
            _no = this._recorder.sno.a++;
            break;
        }
    }
    return _no;
};
/**
 * 
 * @param marker KOverlay
 */
KStdMapMarkers.prototype._getMarkerIndex = function(marker)
{
    for(var i = 0; i < this._recorder.records.length; i++)
    {
        var rd = this._recorder.records[i].overlays;
        var _i = i;
        //
        for(var _a = 0; _a < rd.a.length; _a++)
        {
            if(marker === rd.a[_a])
            {
                return _i;
            }
        }
        //
        for(var _l = 0; _l < rd.l.length; _l++)
        {
            if(marker === rd.l[_l])
            {
                return _i;
            }
        }
        //
        for(var _m = 0; _m < rd.m.length; _m++)
        {
            if(marker === rd.m[_m])
            {
                return _i;
            }
        }
    }
    return -1;
};
/**
 * 
 */
KStdMapMarkers.prototype._clearMarkers = function()
{
    for(i in this._recorder.records)
    {
        var r = this._recorder.records[i];
        r.overlays.m.length = 1;
        r.overlays.l.length = 1;
        r.overlays.a.length = 1;
    }
    KMap.clearMarker('smm');
    KMap.clearLine('smm');
    KMap.clearArea('smm');
};
/**
 * 
 */
KStdMapMarkers.prototype._resumeMarkers = function()
{
    for(i in this._recorder.records)
    {
        var r = this._recorder.records[i];
        switch(r.info.mt)
        {
            case 'IM':  //
            {
                var _marker = this._addMarker(r.latlon.m[0], false, r.info.s);
                r.overlays.m.length = 0;
                r.overlays.m.push(_marker);
                break;
            }
            case 'IL':  //
            {
                var latlons = [];
                for(var l in r.latlon.l)
                {
                    latlons.push(new MPoint(r.latlon.l[l]));
                }
                var _line = this._addLine(latlons, false, r.info.s);
                r.overlays.l.length = 0;
                r.overlays.l.push(_line);
                break;
            }
            case 'IC':
            {
                var markers = [], lines = [];
                for(var m in r.latlon.m)
                {
                    markers.push(new MPoint(r.latlon.m[m]));
                }
                for(var ls in r.latlon.l)
                {
                    lines.push(new MPoint(r.latlon.l[ls]));
                }
                var _result = this._addRoadLine(markers, lines, false, r.info.s);
                r.overlays.l.length = 0;
                r.overlays.m.length = 0;
                for(var l in _result.lines)
                {
                    r.overlays.l.push(_result.lines[l]);
                }
                for(var m in _result.markers)
                {
                    r.overlays.m.push(_result.markers[m]);
                }
                break;
            }
            case 'IF':
            {
                var area = [];
                for(var a in r.latlon.a)
                {
                    area.push(new MPoint(r.latlon.a[a]));
                }
                var _area = this._addArea(area, false, r.info.s);
                r.overlays.a.length = 0;
                r.overlays.a.push(_area);
                break;
            }
        }
    }
    KMap.fitzoom();
};
/**
 * 
 * @param eventinfo KEventInfo
 * @param container Node Dom
 * @param prevmode KMapMode 
 * @param currmode KMapMode 
 */
KStdMapMarkers.prototype._mapModeChanged = function(eventinfo, container, prevmode, currmode)
{
    if(currmode == KMapMode.PAN) this._resumeTools();
    if(currmode == KMapMode.BOOKMARK) KMap.setCursorIcon(KStdMapMarkers.conf.CONST.bkIcon);
};
/**
 * 
 */
KStdMapMarkers.prototype._mapInit = function()
{
    KEvent.unbind(KMap, 'mapinit', arguments.callee);
    this._bindEvent();
};
/**
 * 
 * @param eventinfo KEventInfo
 * @param container Node Dom
 * @param latlon MPoint 
 */
KStdMapMarkers.prototype._bookmark = function(eventinfo, container, latlon)
{
    this._addMarkerRecord(this._addMarker(latlon, true), true);
};
/**
 * 
 * @param eventinfo KEventInfo
 * @param container Node Dom
 * @param latlons MPoint[]
 */
KStdMapMarkers.prototype._drawline = function(eventinfo, container, latlons)
{
    this._addLineRecord(this._addLine(latlons, true), true);
};
/**
 * 
 * @param eventinfo KEventInfo
 * @param container Node Dom
 * @param nodes MPoint[] 
 * @param lines MPoint[] 
 */
KStdMapMarkers.prototype._roadline = function(eventinfo, container, nodes, lines)
{
    var result = this._addRoadLine(nodes, lines, true);
    this._addRoadLineRecord(result.markers, result.lines, true);
};
/**
 * 
 * @param eventinfo KEventInfo
 * @param container Node Dom
 * @param pts MPoint[] 
 */
KStdMapMarkers.prototype._drawarea = function(eventinfo, container, pts)
{
    this._addAreaRecord(this._addArea(pts, true), true);
};
/**
 * 
 * @param eventinfo KEventInfo
 * @param container Node Dom
 * @param overlay KOverlay 
 */
KStdMapMarkers.prototype._iw_hide = function(eventinfo, container, overlay)
{
    this._resumeList();
};
/**
 * 
 * @param eventinfo KEventInfo
 * @param container Node Dom
 * @param overlay KOverlay 
 */
KStdMapMarkers.prototype._afterOpenInfoWindow = function(eventinfo, container, overlay)
{
    _this = this;
    if(overlay.group() == 'smm')
    {
    	if(!overlay._isInitUpload && _this._isHasFlash){
    		var infoDom = overlay.iwcDom();
    		var baseUrl = 'http://' + window.location.host + window.location.pathname;
        	$('span[mfg="ep_frm"]', infoDom)
        	.show()
        	.swfupload({
        		upload_url: baseUrl + _this.options().uploadUrl,
        		file_size_limit : KStdMapMarkers.conf.FLASHCONF.file_size_limit,
        		file_types : KStdMapMarkers.conf.FLASHCONF.file_types,
        		file_types_description : KStdMapMarkers.conf.FLASHCONF.file_types_description,
        		file_upload_limit : KStdMapMarkers.conf.FLASHCONF.file_upload_limit,
        		flash_url : KStdMapMarkers.conf.FLASHCONF.flash_url,
        		button_image_url : KStdMapMarkers.conf.FLASHCONF.button_image_url,
        		button_width : KStdMapMarkers.conf.FLASHCONF.button_width,
        		button_height : KStdMapMarkers.conf.FLASHCONF.button_height,
        		button_placeholder : $('input[mfg="ep_frm_f"]', infoDom)[0]
        	})
        	.bind('fileQueued', function(event, file){
        		$(this).swfupload('startUpload');
        	})
        	.bind('fileQueueError', function(event, file, errorCode, message){
        		(errorCode=='-110' || errorCode=='-120')&&KTools.showMsg('512k', {title : '', autoclose : 5, node : $('input[mfg="ep_frm_f"]', infoDom).get(0)});
        		(errorCode=='-130')&&KTools.showMsg('', {title : '', autoclose : 5, node : $('input[mfg="ep_frm_f"]', infoDom).get(0)});
        	})
        	.bind('uploadProgress', function(event, file, bytesLoaded){
        		$('span[mfg="ep_frm_fname"]', infoDom).html(file.name + "&nbsp;" + parseInt(bytesLoaded/file.size*100) + "%");
        	})
        	.bind('uploadSuccess', function(event, file, serverData){
        		$('span[mfg="ep_frm_fname"]', infoDom).html("");
        		_this._imgSwfUploaded(eval('(' + serverData + ')'));
        	})
        	.bind('uploadError', function(event, file, errorCode, message){
        		(errorCode)&&KTools.showMsg('', {title : '', autoclose : 5, node : $('input[mfg="ep_frm_f"]', infoDom).get(0)});
        	});
    		overlay._isInitUpload = true;
    	}
    	
    	
        var _idx = this._getMarkerIndex(overlay);
        this._selectList(_idx);
    }
    //Overlay
    if(overlay.options().extdata && overlay.options().extdata['flag'] == KWidgetFlag.mapmarkers)
    {
        this._initInfoWindow(overlay);
    }
};

/**
 * 
 * @param eventinfo KEventInfo
 * @param marker KMarker
 * @param point MPoint
 */
KStdMapMarkers.prototype._markerDragend = function(eventinfo, marker, point)
{
    KMap.closeInfoWindow();
    var idx = this._getMarkerIndex(marker);
    var record = undefined;
    var latlon = point.getPid();
    switch(eventinfo.data.type)
    {
        case 'IM':
        {
            record = {
                info : {
                    l : latlon
                }
                ,latlon : {
                    m : [latlon]
                }
            };
            this._updateRecord(idx, record);
            break;
        }
        case 'IC':
        {
            record = $.extend(true, {}, this._recorder.records[idx]);
            var _i = this._getRoadLineMarkerIndex(idx, marker);
            record.latlon.m[_i] = latlon;
            record.info.l = record.latlon.m.join(',');
            this._updateRecord(idx, record);
            this._redrawRoadline(idx);
            break;
        }
    }
};
/**
 * 
 * @param idx
 */
KStdMapMarkers.prototype._redrawRoadline = function(idx)
{
    var record = this._recorder.records[idx];
    var _latlons = this._getRoadLine(record.latlon.m);
    //
    for(var i = 0; i < record.overlays.l.length; i++)
    {
        KMap.removeLine(record.overlays.l[i]);
    }
    //
    record.overlays.l.length = 0;
    record.latlon.l.length = 0;
    //
    var _lopt = {
        brush :
        {
            color : record.info.s.l.c
            ,width : record.info.s.l.w
            ,transparency : record.info.s.l.a
        }
        ,group : 'smm'
        ,extdata : {
            flag : KWidgetFlag.mapmarkers
            ,mark : 'rl'
        }
        ,infowin : KConfig.get('iw_iwo_mmr')
    };
    //
    var _line = new KLine(_latlons, _lopt);
    //
    record.overlays.l.push(_line);
    for(var j = 0; j < _latlons.length; j++)
    {
        record.latlon.l.push(_latlons[j].getPid());
    }
    //
    KMap.addLine(_line, false);
    //
    this._updateListExt(idx, '<em></em>' + this._convertData('l', KMap.distance(_latlons)));
};
/**
 * 
 * @param eventinfo
 * @param line
 */
KStdMapMarkers.prototype._modified = function(eventinfo, line)
{
    var idx = this._getMarkerIndex(line);
    var record = undefined;
    if(eventinfo.data.type == 'IL')
    {
        record = {
            info : {
                l : ''
            }
            ,latlon : {
                l : []
            }
        };
    }
    else if(eventinfo.data.type == 'IF')
    {
        record = {
            info: {
                l : ''
            }
            ,latlon : {
                a : []
            }
        };
    }
    var latlons = line.latlons();
    //
    this._updateListExt(idx, '<em>' + (eventinfo.data.type == 'IL' ? '' : '') + '</em>' + this._convertData(eventinfo.data.type == 'IL' ? 'l' : 'a', eventinfo.data.type == 'IL' ? KMap.distance(latlons) : KMap.area(latlons)));
    for(var i = 0; i < latlons.length; i++)
    {
        if(eventinfo.data.type == 'IL')
        {
            record.latlon.l.push(latlons[i].getPid());
        }
        else if(eventinfo.data.type == 'IF')
        {
            record.latlon.a.push(latlons[i].getPid());
        }
    }
    if(eventinfo.data.type == 'IL')
    {
        record.info.l = record.latlon.l.join(',');
    }
    else if(eventinfo.data.type == 'IF')
    {
        record.info.l = record.latlon.a.join(',');
    }
    this._updateRecord(idx, record);
};
/**
 * 
 * @param idx Integer 
 * @param record Object 
 */
KStdMapMarkers.prototype._updateRecord = function(idx, record)
{
    var _record = this._recorder.records[idx];
    $.extend(true, _record, record);
};
/**
 * Marker
 * @param idx Integer 
 * @param marker KMarker
 * @return Integer maker
 */
KStdMapMarkers.prototype._getRoadLineMarkerIndex = function(idx, marker)
{
    var record = this._recorder.records[idx];
    if(record && record.info.mt == 'IC')
    {
        var markers = record.overlays.m;
        for(var i = 0; i < markers.length; i++)
        {
            if(markers[i] === marker) return i;
        }
    }
    return -1;
};
/**
 * 
 * @param pts String[] 
 * @return MPoint[]
 */
KStdMapMarkers.prototype._getRoadLine = function(pts)
{
    var _url = '';
    var _latlons = [];
    for(var i = 0; i < pts.length - 1; i++)
    {
        _url = this.options().roadurl + '&nh=' + pts[i] + ',' + pts[i + 1];
        $.ajax({
            async : false
            ,type : 'GET'
            ,url : _url
            ,success : function(data){
                if(data)
                {
                    eval(data);
                    var _line = KLine.fromEncoded(_map_rlm.a[0].a, _map_rlm.a[0].b);
                    var latlon = _line.latlons();
                    for(var j = 0; j < latlon.length; j++)
                    {
                        _latlons.push(latlon[j]);
                    }
                }
            }
        });
    }
    return _latlons;
};
/**
 * 
 * @param idx Integer 
 * @param hilite Boolean 
 */
/*KStdMapMarkers.prototype._hiliteMarker = function(idx, hilite)
{
    var record = this._recorder.records[idx];
    if(record)
    {
        var overlay = undefined;
        switch(record.info.mt)
        {
            case 'IM':
            {
                overlay = record.overlays.m[0];
                break;
            }
            case 'IL':
            case 'IC':
            {
                overlay = record.overlays.l[0];
                break;
            }
            case 'IF':
            {
                overlay = record.overlays.a[0];
                break;
            }
        }
        overlay && (hilite ? overlay.hilite() : overlay.resume());
    }
};*/
/**
 * 
 */
KStdMapMarkers.prototype._shardLink = function()
{
    this._dTitle = document.title;
    var _this = this;
    if(this._recorder.records.length > 0)
    {
        this._update(0, false, function(data){
            _this._setClipboard(_this._shardurl);
        });
        //this._update(1, false);
    }
    else
    {
        KTools.showMsg('', {autoclose : 5, node : this.options().sharebtn, buboptions : {closebtn : false}})
    }
};
/**
 * 
 * @param val
 */
KStdMapMarkers.prototype._setClipboard = function(val)
{
    var _this = this;
    var _h = [];
    _h.push('<div style="padding:5px 0 0 10px;">');
    _h.push('<input id="mmShardUrl" readonly="readonly" style="font-size:12px;width:240px;height:20px;border:1px solid #CCC" value="' + val + '" />');
    _h.push('<div style="text-align:right;padding:5px 0 0 0;">');
    _h.push('<embed width="65px" height="22px" flashvars="copyStrFun=mmGetShardUrl&amp;copyStrCallBak=mmCopyShardUrl&amp;btnCaption=" quality="high" bgcolor="#FFFFFF" allowscriptaccess="always" wmode="window" type="application/x-shockwave-flash" src="http://img.mapbar.com/web/3in1/js/cp.swf"></embed>');
    _h.push("</div></div>");
    this._tipBox = KTools.showMsg(_h.join(''), {node : this.options().sharebtn});
    setTimeout(function(){document.title = _this._dTitle;},50);
};
/**
 * 
 * @return String 
 */
KStdMapMarkers.prototype._getShardUrl = function()
{
    //alert(this._copyText.val());
    var _urlBox = $('#mmShardUrl').get(0);
    var _url = _urlBox ? _urlBox.value : '';
    _urlBox = null;
    return _url;
};

/**
 * 
 * @param str
 */
KStdMapMarkers.prototype._copyShardUrl = function(str)
{
    var _success = true;
    KTools.hideMsg(this._tipBox);
    if(!str)
    {
        str = this._getShardUrl();
        $('#mmShardUrl').remove();
        _success = (window.clipboardData.clearData() && window.clipboardData.setData("Text",str));
    }
    if(!_success)
    {
        KTools.showMsg('', {node : this.options().sharebtn, autoclose : 5, buboptions : {closebtn : false}});
    }
    else
    {
        KTools.showMsg('', {node : this.options().sharebtn, autoclose : 5, buboptions : {closebtn : false}});
    }
    document.title = this._dTitle;
};
/**
 * 
 * @param at Integer  1   2   4   8   0
 * @param updatenote Boolean 
 * @param callback Function 
 */
KStdMapMarkers.prototype._update = function(at, updatenote, callback)
{
    var _this = this;
    if(!this.options().shareurl)
    {
        return false;
    }
    else
    {
        var _hash = new KUrlHash();
        _hash.setKey('d', this._buildMarkerInfo(at));
        $.ajax({
            type : 'POST'
            ,url : this.options().shareurl //KStdMapMarkers.conf.CONST.ajaxUrl
            ,data : _hash.toString()//encodeURIComponent(encodeURIComponent('d=' + this._buildNoteStr(at)))
            ,success : function(data, status){
                if($.trim(data) == '')
                {
                    KTools.showMsg('', {node : _this.options().sharebtn, title : '', autoclose : 5});
                }
                else
                {
                    var _d = eval('(' + data + ')');
                    if(_d.mu && _d.mmid)
                    {
                        //
                        _this._shardurl = _d.mu;
                        /*_this._mmid = _d.mmid;*/

                        if(callback)
                        {
                            callback(data)
                        }

                        /*if(updatenote)
                        {
                            _this._updateLocalNote(data);
                        }*/
                    }
                    else
                    {
                        KTools.showMsg('', {node : _this.options().sharebtn, autoclose : 5, buboptions : {closebtn : false}});
                    }
                }
            }
            ,error : function()
            {
                KTools.showMsg('', {node : _this.options().sharebtn, title : '', autoclose : 5});
            }
        });
    }
    return true;
};
/**
 * 
 * @return String 
 * @param at Integer  1   2   4   8   0
 */
KStdMapMarkers.prototype._buildMarkerInfo = function(at)
{
    var _str = [];
    _str.push('{at:' + this._at + ',mmid:"' + (this._mmid ? this._mmid : '') + '",mm:[');
    for(var i in this._recorder.records)
    {
        var _r = this._recorder.records[i];
        /*if(at && at != _r.at)
        {
            continue;
        }*/
        if(i > 0) _str.push(',');
        //_str.push('{at:' + _r.at);
        _str.push('{at:1');
        _str.push(',id:' + i);
        _str.push(',did:"' + _r.info.did + '"');
        _str.push(',t:"' + _r.info.t + '"');
        _str.push(',d:"' + _r.info.d + '"');
        _str.push(',i:"' + _r.info.i + '"');
        _str.push(',mt:"' + _r.info.mt + '"');
        //_str.push(',l:{a:"' + _r.latlon.a.toString() + '",l:"' + _r.latlon.l.toString() + '",m:"' + _r.latlon.m.toString() + '"}');
        _str.push(',l:"' + _r.info.l + '"');
        /*switch(_r.type)
        {
            case 'IC':
            case 'IM':
                _str.push(_r.latlon.m.toString());
                break;
            case 'IF':
                _str.push(_r.latlon.a.toString());
                break;
            case 'IL':
                _str.push(_r.latlon.l.toString());
                break;
        }
        _str.push('"');*/
        _str.push(',s:{c:{x:' + _r.info.s.c.x + ',y:' + _r.info.s.c.y + '},f:{a:' + _r.info.s.f.a + ',' +
                '' + 'c:"' + _r.info.s.f.c + '"},l:{a:' + _r.info.s.l.a + ',c:"' + _r.info.s.l.c + '",' + 'w:' + _r.info.s.l.w + '}}}');
    }
    _str.push(']}');
    return _str.join('');
};
/**
 * 
 */
KStdMapMarkers.prototype._load = function()
{
    var _this = this;
    //
    this._clearList();
    this._clearRecord();
    KMap.clear('smm');

    this._update(0, false, function(data){
        _this._batchAdd(eval('(' + data + ')'));
        KMap.fitzoom();
    });
    //resultloaded
    KEvent.trigger(this, 'resultloaded', this);
};
/**
 * 
 * @param obj Object
 */
KStdMapMarkers.prototype._batchAdd = function(obj)
{
    //
    for(var i in obj.mm)
    {
        this.add(this._result2MarkerInfo(obj.mm[i]));
    }
    //
    this._mmid = undefined;
    this._at = 1;
};
/**
 * KMapInfo
 * @param r Object 
 * @result KMapInfo
 */
KStdMapMarkers.prototype._result2MarkerInfo = function(r)
{
    var _marker = KTools.copyOptions({}, KMapMarkerInfo);
    _marker.nid = r.did;
    _marker.title = r.t;
    _marker.content = r.d;
    _marker.img = r.i;
    switch(r.mt)
    {
    case 'IM':
        _marker.type = KOverlayType.MARKER;
        break;
    case 'IL':
        _marker.type = KOverlayType.POLYLINE;
        break;
    case 'IC':
        _marker.type = KOverlayType.ROADLINE;
        break;
    case 'IF':
        _marker.type = KOverlayType.AREA;
        break;
    }
    _marker.latlons = r.l;
    var _s = [];
    _s.push('{c:{x:' + (r.s.c ? r.s.c.x : 1) + ',y:' + (r.s.c ? r.s.c.y : 1) + '},f:{a:' + (r.s.f ? r.s.f.a : 30) + ',c:"' + (r.s.f ? r.s.f.c : '#FF0000') + '"},l:{a:' + (r.s.l ? r.s.l.a : 60) + ',c:"' + (r.s.l ? r.s.l.c : '#FF0000') + '",w:' + (r.s.l ? r.s.l.w : 5) + '}}');

    _marker.style = _s.join('');

    return _marker;
};
/**
 * 
 */
KStdMapMarkers.prototype._initSearchbox = function()
{
    var _this = this;
    var shx = $('div[mfg="de_s"]', this._iwNormal);
    var tbs = $('>ul>li', shx);
    var contents = $('>div', shx);
    var forms = $('>form', contents);
    var buttons = $('>input[type="button"]', forms);
    var nsbtn = $('>input[type="submit"]', forms.eq(2));
    var getFormIndex = function(form)
    {
        var fs = forms.toArray();
        for(var k = 0; k < fs.length; k++)
        {
            if(fs[k] == form) return k;
        }
    };
    //
    tbs.each(function(i){$(this).removeClass().addClass(i == 0 ? 'mwpg_mm_is' : '').attr('idx', i);});
    contents.each(function(j){$(this).css({display : j == 0 ? 'block' : 'none'}).attr('idx', j);});
    //
    tbs.unbind().bind('click', function(){
        var idx = parseInt($(this).attr('idx'));
        tbs.each(function(i){$(this).removeClass().addClass(i == idx ? 'mwpg_mm_is' : '');});
        contents.each(function(j){$(this).css({display : j == idx ? 'block' : 'none'});});
    });
    //
    forms.each(function(){
        $(this).unbind().bind('submit', function(){return false;})
    });
    $('input[type="text"]', forms).val('');
    //
    nsbtn.unbind().click(function(){
        var kw = $(this).prev('input[type="text"]');
        if(kw.val() == '')
        {
            _this._alertmsg(kw.get(0));
        }
        else
        {
            var _opts = KTools.copyOptions({
                type : KQueryType.localsearch
                ,ls : {name : kw.val()}
                ,center : {
                    name : _this._recorder.records[_this._idx].info.t
                    ,latlon : _this._recorder.records[_this._idx].info.l
                }
            }, KQueryOptions);
            if(_this.options().latlonurl)
            {
                _this._localsearch(_opts);
            }
            //KEvent.trigger(_this, 'search', _this, _opts);
        }
    });
    //
    buttons.unbind().click(function(){
        var _type = undefined;  //
        var _kw = undefined;    //
        var _dir = 1;           // 1   0 
        if($(this).val() == '')
        {
            _type = KQueryType.navsearch;
        }
        else if($(this).val() == '')
        {
            _type = KQueryType.busearch;
        }
        _kw = $(this).prevAll('input[type="text"]');
        _dir = getFormIndex($(this).parent().get(0));

        if(!_type) return;

        if(_kw.val() == '')
        {
            _this._alertmsg(_kw.get(0));
        }
        else
        {
            var _mkp = {
                name : _this._recorder.records[_this._idx].info.t
                ,latlon : _this._recorder.records[_this._idx].info.l
            };
            var _op = {name : _kw.val()};
            var _opts = KTools.copyOptions({type : _type}, KQueryOptions);
            if(_type == KQueryType.navsearch)
            {
                _opts.navorig = _dir == 0 ? _op : _mkp;
                _opts.navdest = _dir == 0 ? _mkp : _op;
            }
            else if(_type == KQueryType.busearch)
            {
                _opts.busorig = _dir == 0 ? _op : _mkp;
                _opts.busdest = _dir == 0 ? _mkp : _op;
            }
            if((_type == KQueryType.navsearch) && _this.options().latlonurl)
            {
                _this._navsearch(_opts);
                //KEvent.trigger(_this, 'search', _this, _opts);
            }
            else if((_type == KQueryType.busearch) && _this.options().latlonurl)
            {
                _this._busearch(_opts);
            }
        }
    });
};
/**
 * 
 * @param opts Object 
 */
KStdMapMarkers.prototype._busearch = function(opts)
{
    if(this.options().latlonurl)
    {
        var _latlon = opts.busorig.latlon ? opts.busorig.latlon : opts.busdest.latlon;
        var _this = this;
        var hash = new KUrlHash();
        hash.setKey("t", "ig");
        hash.setKey("l", _latlon);
        hash.setKey("z", KMap.zoom());
        $.ajax( {
		    url : this.options().latlonurl + "?" + hash.toString(),
            type : 'GET',
            dataType : 'json',
            success : function(data) {
                opts.busdest.city = data.c;
                opts.busorig.city = data.c;
                KEvent.trigger(_this, 'search', _this, opts);
            },
            error:function(){
                throw new Error("");
            }
        });
    }
    else
    {
        KEvent.trigger(_this, 'search', _this, opts);
    }
};
/**
 * 
 * @param opts Object 
 */
KStdMapMarkers.prototype._navsearch = function(opts)
{
    if(this.options().latlonurl)
    {
        var _latlon = opts.navorig.latlon ? opts.navorig.latlon : opts.navdest.latlon;
        var _this = this;
        var hash = new KUrlHash();
        hash.setKey("t", "ig");
        hash.setKey("l", _latlon);
        hash.setKey("z", KMap.zoom());
        $.ajax( {
		    url : this.options().latlonurl + "?" + hash.toString(),
            type : 'GET',
            dataType : 'json',
            success : function(data) {
                opts.navdest.city = data.c;
                opts.navorig.city = data.c;
                KEvent.trigger(_this, 'search', _this, opts);
            },
            error:function(){
                throw new Error("");
            }
        });
    }
    else
    {
        KEvent.trigger(_this, 'search', _this, opts);
    }
};
/**
 * 
 * @param opts Object 
 */
KStdMapMarkers.prototype._localsearch = function(opts)
{
    if(this.options().latlonurl)
    {
        var _latlon = opts.center.latlon;
        var _this = this;
        var hash = new KUrlHash();
        hash.setKey("t", "ig");
        hash.setKey("l", _latlon);
        hash.setKey("z", KMap.zoom());
        $.ajax( {
		    url : this.options().latlonurl + "?" + hash.toString(),
            type : 'GET',
            dataType : 'json',
            success : function(data) {
                /*opts.navdest.city = data.c;
                opts.navorig.city = data.c;*/
                opts.center.city = data.c;
                opts.ls.city = data.c;
                KEvent.trigger(_this, 'search', _this, opts);
            },
            error:function(){
                throw new Error("");
            }
        });
    }
    else
    {
        KEvent.trigger(_this, 'search', _this, opts);
    }
};
KStdMapMarkers.prototype._flashChecker = function()
{
	var hasFlash = false; // flash
	var flashVersion = 0; // flash

	if ($.browser.msie) {
		var swf = false;
		try{
			swf = new ActiveXObject('ShockwaveFlash.ShockwaveFlash');
		}catch(e){
			
		}
		if (swf) {
			hasFlash = true;
			VSwf = swf.GetVariable("$version");
			flashVersion = parseInt(VSwf.split(" ")[1].split(",")[0]);
		}
	} else {
		if (navigator.plugins && navigator.plugins.length > 0) {
			var swf = navigator.plugins["Shockwave Flash"];
			if (swf) {
				hasFlash = true;
				var words = swf.description.split(" ");
				for ( var i = 0; i < words.length; ++i) {
					if (isNaN(parseInt(words[i])))
						continue;
					flashVersion = parseInt(words[i]);
				}
			}
		}
	}
//	return {
//		f : hasFlash,
//		v : flashVersion
//	};
	return hasFlash;
}

/*
 
 zhaobo
 1.0
 2010-04-16
 ============================================
 
 */
var KStdPrinter = KClass.create("KStdPrinter", KPrinter);


/**
 * 
 * @param opts KStdPrinterOptions
 * @uncrunch
 */
KStdPrinter.initialize = function(opts) {
    this._opts = KTools.copyOptions(opts, KStdPrinterOptions);

};
/**
 * 
 * @param opts KPrintOptions 
 */
KStdPrinter.prototype.print = function(opts)
{
    this._printOpts = KTools.copyOptions(opts, KPrintOptions);
    var url;
    switch (this._printOpts.queryopts.type) {
        case KQueryType.localsearch :
            url = this._opts.lsurl;
            break;
        case KQueryType.busearch :
            url = this._opts.bsurl;
            break;
        case KQueryType.busline :
            url = this._opts.blurl;
            break;
        case KQueryType.bustation :
            url = this._opts.bsturl;
            break;
        case KQueryType.navsearch :
            url = this._opts.navsurl;
            break;
    }
    if (url) this.openWin = window.open(url);
};


KStdPrinter.prototype.notify = function(data) {
    if (data == "print_page_loaded" && this.openWin && this.openWin.printDataReady){
        this.openWin.printDataReady(this._printOpts);
    }
};
/**
 * 
 * @return String 
 * @uncrunch
 */
KStdPrinter.prototype.version = function()
{
    return "1.0.1";
};

/**
 * 
 * @return String
 * @uncrunch
 */
KStdPrinter.prototype.cnname = function()
{
    return "";
};

/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KStdPrinter.prototype.dependent = function()
{
    return [jQuery,KEvent,KTools,KPrinter,KStdPrinterOptions];
};

/**
 * 
 * @uncrunch
 */
KStdPrinter.prototype.finalize = function()
{
};
/*
 
 xionggq zhangsq
 1.0
 2010-05-05
 2011-4-2 10:14
 ============================================
 
 opt# 1008261349
 IE6/7

 opt# 1008261353
 IEKSendType

 opt# 1008311116
 

 opt# 1008311132
 

 opt# 1008311135
 

 bug# 1011230914
 

 bug# 1011241916
 IE

 []
 E01 
 E02 

 //#opt 1012281138
 147187,188;180,189;185,186
 opt# 201103312210
 
 bug# 201104021006
 
 */


var KStdSender = KClass.create("KStdSender", KSender);
KStdSender.conf =
{
    CLASSNAME :
    {
        //div
        SND:'snd'
        //
        ,CLB:'snd_clb'
        //->div
        ,V:'snd_v'
        //->div
        ,C:'snd_c'
        //->->li
        ,PNC:'snd_pnc'
        //->->li
        ,PNH:'snd_pnh'
        //->->input
        ,SMSSND:'snd_smssnd'
        //->->input
        ,SSNDD:'snd_ssndd'  
        //->->div
        ,I:'snd_i'
        //->->div
        ,MC :'snd_mc'
        //->->->input
        ,M:'snd_m'
        //->->->input
        ,MSND:'snd_msnd'
        //->->div
        ,TIP:'snd_tip'
        //->->div
        ,MCT:'snd_mct'
        //->->->input
        ,MSNDD:'snd_msndd'
        //GPS->->->a
        ,D:'snd_d'
        //GPS->->->a
        ,DD:'snd_dd'
        //GPS->->->a
        ,DL : 'snd_dl'
        //GPS->->
        ,SUP : 'snd_sup'
        //
        ,STC : 'snd_stc'
        //->
        ,CC : 'snd_cc'
        //->
        ,CV : 'snd_cv'
        //->
        ,H : 'snd_h'
        //->ID(input[type=text])
        ,CN : 'snd_cn'
    }
};


/**
 * 
 * @param container
 * @param opts
 */
KStdSender.initialize = function(container, opts)
{
    var _this = this;
    this._timer = undefined;    //
    //add by zwq
    this.senderLog = false;     //
	this.senderState = 2;		//0  1 2
    this._opts = KTools.copyOptions(opts, KSenderOptions);
    this._initOption();
    this._oldOpts = this._opts.theme;
    this._domAll = $(container).removeClass().addClass(this._getClassName('SND')).hide();
    //Dom
    this._getDom();
    //
    if (!this._sendTab)
    {
        this._sendTab = new KStdTabs(this._sendTabDom);
    }
    //Dom
    this._bindEvent();
};

/*
====================================  ============================================
 */
/**
 * Dom
 */
KStdSender.prototype._bindEvent = function()
{
    var _this = this;
    //selected
    KEvent.bind(this._sendTab, "selected", function(eventinfo, widget, oldItem, currentItem) {
        if (currentItem.index == 1)
        {
            _this._initEmailpic = true;
            _this._MAILSendContentDom.empty();
            KMap.snapshot({oncomplete:{fun:function() {
                //
                _this._emailImgUrl = arguments[1];
                _this._mailGaryOrlightBtn(false);
                _this._getMailPreview();
            }}});
        }
        else if (currentItem.index == 0)
        {
            _this._setSMSBtnGary();
        }
    });
    //
    this._colseBtn.click(function() {
        _this._closed();
    });
    //Form
    $("form", this._domAll).each(function() {
        $(this).submit(function(e) {
            e.stopPropagation();
            return false;
        });
    });
};
/**
 * Dom
 */
KStdSender.prototype._getDom = function()
{
    this._dom =  this._domAll.get(0);
    this._colseBtn = $(">a", this._domAll).eq(0).removeClass().addClass(this._getClassName('CLB'));   //
    this._sendTabDom = $(">div", this._domAll).eq(0);   //
};
/**
 * CSS
 * @param sign String 
 * @return String CSS
 */
KStdSender.prototype._getClassName = function(sign)
{
    return this.options().theme + '_' + KStdSender.conf.CLASSNAME[sign];
};
/**
 * options
 */
KStdSender.prototype._initOption = function()
{
    if (!this._opts.smslimit)
    {
        this._opts.smslimit = 2000;
    }
    if (!this._opts.smsinterval)
    {
        this._opts.smsinterval = 0;
    }
};
/**
 * 
 */
KStdSender.prototype._init = function()
{
    var _this = this;
    this._initEmailpic = false;
    this._changeFlag = 0;
    this._emailImgUrl = undefined;
    this._smsSelectshow = false;
    this._gpsSelectshow = false;
    //    
	//add by zwq   #### problem:loginKStdAccount index.js
    var account = loginKStdAccount.account();
    if(!(account && account.signin) && (this._sendOpts.sendtype == KSendType.sms || this._sendOpts.sendtype == KSendType.email || this._sendOpts.sendtype == '52')){
    	loginKStdAccount.show();
		return;
	}else{
		this._initSendSMS();
	}
	
    //
    this._initSendMail();
    //
    this._initSendGPS();
    //
    this._initSendToCar();

    this._updateTabsOptions();

    this._initTabShow();

    if (this._sendTab && this._sendTab.current().index == 0)
    {
        this._setSMSBtnGary();
    }
    this._initselect();
    this._domAll.show();

    this._layout();
    
    KTools.lightbox({element:this._domAll,visible:true});

};
/**
 * tabitem
 */
KStdSender.prototype._initSendToCar = function()
{
    //bug# 1011230914 fix begin
    //add by zhangsq car
    if(this._sendOpts.car)
    {
        var _this = this;
        var MMSItemDom = this._sendTab.tab(3);
        $('>div', MMSItemDom.contentDom).eq(0).removeClass().addClass(this._getClassName('STC'));
        this._sendToCarForm = $('>div>form', MMSItemDom.contentDom).eq(0);
        $('>div', this._sendToCarForm).eq(0).removeClass().addClass(this._getClassName('CC'));
        $('>div', this._sendToCarForm).eq(1).removeClass().addClass(this._getClassName('CV'));
        this._sendToCarNum = $('>div>p>input[type="text"]', this._sendToCarForm).eq(0).removeClass().addClass(this._getClassName('CN'));
        this._sendToCarBtn = $('>div>p>input[type="submit"]', this._sendToCarForm).eq(0);
        this._sendToCarHelp = $('>div>label>a', this._sendToCarForm).eq(0).removeClass().addClass(this._getClassName('H'));
        this._sendToCarContent = $('>div>p>textarea', this._sendToCarForm).eq(0);
        //
        this._sendToCarContent.val(this._sendOpts.car[0].kvalue.preview);
        //ID
        this._sendToCarNum.val('');
        //bug# 201104021006 fix begin
        //
        this._sendToCarHelp.unbind().bind( 'click', function(){
            //opt# 201103312210 fix begin
            //delete by zhangsq
            /*if(!_this._help)
            {
                _this._help = KTools.showMsg($(this).attr('_h'), {node:this, buboptions:{closebtn:true, pos:KPosition.BOTTOM}});
            }
            else
            {
                KTools.hideMsg(_this._help);
                _this._help = undefined;
            }*/
            //add by zhangsq
            KTools.showMsg($(this).attr('_h'), {node:this, buboptions:{closebtn:true, pos:KPosition.BOTTOM}});
            //opt# 201103312210 fix end
        });
        //
        this._sendToCarForm.unbind().bind('submit', function(){
        	//add by zwq #fix start#
        	_this.senderState = 0;
        	setTimeout(function(){
        		if(_this.senderState == 0){
        			_this.senderLog = true;//
        			_this._sendToCar.apply(_this, arguments);
        			_this.senderState == 2;
        		}else{
        			_this.senderState = 2;
        		}
            }, 6000);
        	//add by zwq #fix end#
        	_this._sendToCar.apply(_this, arguments);
            return false;
        });
        //bug# 201104021006 fix end
    }
    //bug# 1011230914 fix end
};
/**
 * 
 */
KStdSender.prototype._sendToCar = function()
{
    this._timer = new Date();
    var _this = this;
    var _id = undefined;
    //ID
    if($.trim(this._sendToCarNum.val()) == '')
    {
        _id = KTools.showMsg('', {node:this._sendToCarNum.get(0), autoclose:5, buboptions:{closebtn:false, pos:KPosition.BOTTOM}});
        return;
    }
    //
    if($.trim(this._sendToCarContent.val()) == '')
    {
        _id = KTools.showMsg('', {node:this._sendToCarContent.get(0), autoclose:5, buboptions:{closebtn:false, pos:KPosition.BOTTOM}});
        return;
    }
    //
    if($.trim(this._sendToCarContent.val()).length > 1000)
    {
        _id = KTools.showMsg('1000', {node:this._sendToCarContent.get(0), autoclose:5, buboptions:{closebtn:false, pos:KPosition.BOTTOM}});
        return;
    }
    //
    _id = this._sendToCarBtn.attr('disabled', 'disabled');
    //
    this._killMsgTip(_id);
    _id = KTools.showMsg('...', {node:this._sendToCarBtn.get(0), autoclose:0, buboptions:{closebtn:false, pos:KPosition.RIGHT}});

    //
    var ajaxUrl = this._opts.url;
    if (ajaxUrl.indexOf("?") != -1)
    {
        var num = ajaxUrl.indexOf("?");
        ajaxUrl = ajaxUrl.substring(0, num);
    }
    var _hash = new KUrlHash();
    /*//ID
    _hash.setKey('cid', this._sendToCarNum.val());
    //
    _hash.setKey('lat', this._sendOpts.car[0].value.latlon);
    //
    _hash.setKey('c', this._sendToCarContent.val());*/
    _hash.setKey('t', 'sdmc');
    _hash.setKey('sp', 'car');
    _hash.setKey('cai', this._sendToCarNum.val());    //ID
    _hash.setKey('mt', '');     //
    _hash.setKey('mco', this._sendToCarContent.val());    //
    _hash.setKey('pon', this._sendOpts.car[0].kvalue.name);    //POI
    _hash.setKey('poa', this._sendOpts.car[0].kvalue.address);    //POI
    _hash.setKey('pop', this._sendOpts.car[0].kvalue.phone);    //POI
    _hash.setKey('pol', this._sendOpts.car[0].kvalue.latlon);    //POI
    // fix by zwq
    if(_this.senderLog){
    	_hash.setKey('sl', "true");
    	_this.senderLog = false;
    }
    $.ajax({
        type: 'POST'
        ,url: ajaxUrl
        ,cache: false
        ,data: _hash.toString()
        ,dataType: 'json'
        ,error: function(){
            _this._killMsgTip(_id);
            _id = KTools.showMsg('', {node:_this._sendToCarBtn.get(0), autoclose:5,buboptions:{pos:KPosition.RIGHT}});
            //
            _this._sendToCarBtn.attr('disabled', '');
        }
        ,success: function(data) {
            if(data)
            {
            	//,
            	_this.senderState = 1;
            	var _t = new Date();
                if(_t - _this._timer < 2000)
                {
                setTimeout(function(){
                    //
                    _this._killMsgTip(_id);
                    _id = KTools.showMsg('!', {node:_this._sendToCarBtn.get(0), autoclose:5,buboptions:{pos:KPosition.RIGHT}});
                    //
                    _this._sendToCarBtn.attr('disabled', '');
                    }, 2000 - (_t - _this._timer));
                }
                else
                {
                   //
                    _this._killMsgTip(_id);
                    _id = KTools.showMsg('!', {node:_this._sendToCarBtn.get(0), autoclose:5,buboptions:{pos:KPosition.RIGHT}});
                    //
                    _this._sendToCarBtn.attr('disabled', '');
                }
            }
            else
            {
                _this._killMsgTip(_id);
                _id = KTools.showMsg('', {node:_this._sendToCarBtn.get(0), autoclose:5,buboptions:{pos:KPosition.RIGHT}});
                //
                _this._sendToCarBtn.attr('disabled', '');
            }
        }
    });
    return false;
};
/**
 * tabitem
 */
KStdSender.prototype._initSendSMS = function()
{
    var _this = this;
    var MMSItemDom = this._sendTab.tab(0);
    this._SMScontentPhoneDom = $(">div", MMSItemDom.contentDom).eq(0);
    //add by zhangsq
    $('>div', MMSItemDom.contentDom).eq(0).removeClass().addClass(this._getClassName('V'));
    $('>div', MMSItemDom.contentDom).eq(1).removeClass().addClass(this._getClassName('C'));
    this._SMScontentDom = $(">div>dl>dd>p", MMSItemDom.contentDom).eq(0);
    var MMSContentDom = $(">div", MMSItemDom.contentDom).eq(1);
    // add by zhangsq
    this._SMSDropListDom = $(">div", MMSContentDom).get(0);
    if (!this._SMSDropList)
    {
        this._SMSDropList = new KDropList(this._SMSDropListDom, {
			deselect : false,
			select2text : true,
			multiple : false,
			closebtn : false,
			sortable : false,
			checkbox : false
		});
    }
    this._insertSMSItemFun();
    //KEvent.bind(this._SMSDropList, "opened", function(evt, widget) { });
    KEvent.bind(this._SMSDropList, "selectchanged", function(evt, widget, item) {

        var kvalue = eval(item.kvalue);
        _this._SMScontentDom.html(kvalue.content).data("paras", kvalue.paras || '').data('sendkey',kvalue.sendkey || '');
        _this._selectNum = item.index;
        if(_this._GPSDropList && _this._gpsSelectshow && !_this._changeFlag)
        {
            _this._changeFlag = "mms";
            _this._GPSDropList.select(item.index);

        }
        else
        {
           _this._changeFlag =undefined;
        }
    });
    this._SMSPhoneInputNum = 1;
    var MMSFromDom = $(">dl>dd>form", MMSContentDom).eq(0);
    this._SMSFormUlDom = $(">ul", MMSFromDom).eq(0);
    this._SMSAddPhoneInputBtn = $(">a", MMSFromDom).eq(0);
    $('<li><div class="' + (this._getClassName('PNC')) + '"><input type="text" /></div><a href="javascript:void(0);"></a></li>').appendTo(this._SMSFormUlDom.empty());
    this._SMSAddPhoneInputBtn.unbind("click").click(function() {
        _this._AddPhoneNumFun();
    });
    this._SMSSendBtn = $("input[type='submit']", MMSFromDom).eq(0);
    this._SMSSendBtn.unbind("click").click(function()
    {
        _this._timer = new Date();
        _this._sendSMSFun();
    });

};
/**
 * 
 */
KStdSender.prototype._initselect = function()
{
	var isIE6 = ($.browser.msie && parseInt($.browser.version, 10) < 7);
    if(this._sendOpts && this._sendOpts.selected && this._sendTab)
    {
        var sendtype = this._sendOpts.selected;
        if(sendtype == KSendType.sms)
        {
            this._sendTab.select(0);
            if (isIE6) {
				this._sendTab.tab(0).contentDom.find("div.mwp_dpp").css("visibility", "visible");
			}
        }
        if(sendtype == KSendType.email)
        {
            this._sendTab.select(1);
            if (isIE6) {
				this._sendTab.tab(0).contentDom.find("div.mwp_dpp").css("visibility", "hidden");
			}
        }
        if(sendtype == KSendType.gps)
        {
            this._sendTab.select(2);
        }
        if(sendtype == KSendType.car)
        {
            this._sendTab.select(3);
        }
    }
};
/**
 *  
 */
KStdSender.prototype._closed = function()
{
    if (this._sendTab)
    {
        //this._sendTab.current().contentDom.hide();
        //opt# 1008261349 fix begin
        //add by zhangsq
        this._sendTab.hideTab(0);
        this._sendTab.hideTab(1);
        this._sendTab.hideTab(2);
        //bug# 1011241916 fix begin
        //add by zhangsq
        this._sendTab.hideTab(3);


        //add by zhangsq
        this._sendTab.showTab(3);
        //bug# 1011241916 fix end
        this._sendTab.showTab(1);
        this._sendTab.showTab(2);
        this._sendTab.showTab(0);
        //opt# 1008261349 fix end
        this._sendTab.select(0);
    }
    this._domAll.hide();
    KTools.lightbox({});
};
/**
 *  
 * @uncrunch
 */
KStdSender.prototype._setTheme = function()
{
    var MMSItemDom = this._sendTab.tab(0);
    this._domAll.removeClass().addClass(this._getClassName('SND'));
    var MMSDivDoms = $(">div", MMSItemDom.contentDom);
    MMSDivDoms.eq(0).removeClass().addClass(this._getClassName('V'));
    MMSDivDoms.eq(1).removeClass().addClass(this._getClassName('C'));
    var length = $(">li", this._SMSFormUlDom).length;
    if (length > 1)
    {
        $(">li", this._SMSFormUlDom).each(function()
        {
            MMSDivDoms.eq(1).removeClass().addClass(this._getClassName('C'));
        });
    }
    else
    {
        $(">li", this._SMSFormUlDom).eq(0).removeClass().addClass(this._getClassName('PNC'));
    }
    //this._mailGaryOrlightBtn(this._GaryBtn);
    this._mailGaryOrlightBtn(false);
    this._SMSAddPhoneInputBtn.removeClass().addClass(this._getClassName('SMSSND'));
    $(">div", MMSDivDoms.eq(1)).eq(1).removeClass().addClass(this._getClassName('I'));
    var MAILItemDom = this._sendTab.tab(1);
    $("div", MAILItemDom).eq(0).removeClass().addClass(this._getClassName('C'));
    $("div", this._MAILSendForm).eq(0).removeClass().addClass(this._getClassName('MC'));
    this._MAILSendToInputDom.removeClass().addClass(this._getClassName('M'));
    this._MAILSendSubmitBtn.removeClass().addClass(this._getClassName('MSND'));
    $("div", this._MAILSendForm).eq(1).removeClass().addClass(this._getClassName('TIP'));
    $("div", this._MAILSendForm).eq(2).removeClass().addClass(this._getClassName('MCT'));
    $(this._GPSSendDownLandBtn).removeClass().addClass(this._getClassName('D'));
};
/**
 * 
 * @param opts
 */
KStdSender.prototype._setOption = function(opts)
{
    this._oldOpts = this._opts.theme;
    this._opts = KTools.copyOptions(opts, this._opts);
    this._initOption();
};
/**
 * 
 */
KStdSender.prototype._layout = function()
{
    //xgq
    if (!this._domAll.is(":visible")) return;
    var h =$(window).height();
    var w =$(window).width();
    var domHeight = this._domAll.outerHeight();
    var width = this._domAll.outerWidth();
    var docsroll =$(document).scrollTop();
    var t = (h - domHeight) / 2 > 0 ? (h - domHeight) / 2 +docsroll: 0;
    var l = (w - width) / 2 > 0 ? (w - width) / 2 : 0;
    this._domAll.css({position:'relative',top:t,left:l});
    this._domAll.show();
    KTools.lightbox({element:this._domAll,visible:true});
};
/**
 * GPStabitem
 */
KStdSender.prototype._initSendGPS = function()
{
    var _this = this;
    var GPSItemDom = this._sendTab.tab(2).contentDom;
    $('>div', GPSItemDom).eq(0).removeClass().addClass(this._getClassName('V'));
    this._GPSContentDom = $(">div>dl>dd", GPSItemDom).eq(0);
    var GPSSendSelectDom = $(">div", GPSItemDom).eq(1);
    GPSSendSelectDom.removeClass().addClass(this._getClassName('C'));
    $('>div', GPSSendSelectDom).eq(0).removeClass().addClass(this._getClassName('DL'));
    $('>div', GPSSendSelectDom).eq(1).removeClass().addClass(this._getClassName('SUP'));
    $('>div>a', GPSSendSelectDom).eq(0).removeClass().addClass(this._getClassName('D'));
    this._GPSDropListDom = $(">div>div", GPSSendSelectDom).eq(0);

    if (!this._GPSDropList)
    {
        this._GPSDropList = new KDropList(this._GPSDropListDom.get(0), {deselect : false,select2text:true,multiple:false,closebtn:false,sortable : false,checkbox : false});
        KEvent.bind(this._GPSDropList, "selectchanged", function(evt, widget, item) {
            _this._GPSContentDom.html(item.kvalue);
            _this._selectNum = item.index;
            if(_this._SMSDropList && _this._smsSelectshow && !_this._changeFlag)
        {
            _this._changeFlag = "gps";
			//added by zy,KDropList
            //_this._SMSDropList.select(item.index);

        }
        else
           {
              _this._changeFlag =undefined;
            }
        });

    }
    this._insertGPSItemFun();
    this._GPSSendDesDom = $(">div>dl>dd", GPSItemDom).eq(0);

    this._GPSSendDownLandBtn = $(">div>a", GPSSendSelectDom).eq(0);
    this._GPSSendDownLandBtn.unbind("click").click(function() {
        _this._downloadMyLine();
    });
};
/**
 * 
 */
KStdSender.prototype._AddPhoneNumFun = function()
{
    var _this = this;
    if (this._SMSPhoneInputNum == 5) return;
    this._SMSPhoneInputNum = this._SMSPhoneInputNum + 1;
    if (this._SMSPhoneInputNum > 4)
    {
        this._SMSAddPhoneInputBtn.hide();
    }
    $('<li><div class="' + (this._getClassName('PNC')) + '"><input type="text" /></div><a href="javascript:void(0);"></a></li>').mouseenter(function() {
        $(this).addClass(_this._getClassName('PNH'));
    }).mouseleave(function() {
        $(this).removeClass();
    }).appendTo(this._SMSFormUlDom);
    if (this._SMSPhoneInputNum == 2)//
    {
        $(">li", this._SMSFormUlDom).eq(0).mouseenter(function() {
            $(this).addClass(_this._getClassName('PNH'));
        }).mouseleave(function() {
            $(this).removeClass();
        });
    }
    $(">li", this._SMSFormUlDom).each(function()
    {
        $(">a", $(this)).eq(0).unbind("click").click(function()
        {
            $(this).parent().remove();
            _this._delPhoneNumFun();
        });
    });
};
/**
 * 
 */
KStdSender.prototype._delPhoneNumFun = function()
{
    this._SMSPhoneInputNum = this._SMSPhoneInputNum - 1;
    this._SMSAddPhoneInputBtn.show();
    if (this._SMSPhoneInputNum == 1)
    {
        $(">li", this._SMSFormUlDom).unbind("mouseenter").unbind("mouseleave");
    }
};
/**
 * 
 */
KStdSender.prototype._insertSMSItemFun = function()
{
    if (this._sendOpts.sms && this._sendOpts.sms.length > 1 && this._SMSDropList) {
		this._smsSelectshow = true;
		var length = this._sendOpts.sms.length;
		$(this._SMSDropListDom).show().css('visibility', 'visible');
		this._SMSDropList.clearResult();
		this._SMScontentDom.html("").removeData("paras").removeData("sendkey");
		var listItem = "";
		var k = 0;
		for ( var i = 0; i < length; i++) {
			listItem = this._sendOpts.sms[i];
			if (listItem.kvalue.selected){
                this._selectNum = i;
                this._SMSDropList.insert( {
                    text : listItem.name,
                    kvalue : '({"content":"' + listItem.kvalue.content + '","paras":"' + listItem.kvalue.paras + '","sendkey":"' + listItem.kvalue.sendkey + '"})',
                    deletable : false,
                    editable : false,
                    selected : listItem.kvalue.selected,
                    iconClass : '',
                    itemClass : ''
                });
                k++;
                this._SMScontentDom.html(listItem.kvalue.content).data("paras", listItem.kvalue.paras || '').data("sendkey", listItem.kvalue.sendkey || '');
            }
		}
		//added by zy,
//		if($('#olResult>li').hasClass('mwp_ls_rls')){
//			this._selectNum = $('#olResult li.mwp_ls_rls').index();
//			if(this._sendOpts.bubbleIndex) this._selectNum = this._sendOpts.bubbleIndex;
//			listItem = this._sendOpts.sms[this._selectNum];
//			this._SMScontentDom.html(listItem.kvalue.content).data("paras", listItem.kvalue.paras);
//			this._SMSDropList.select(this._selectNum);
//		}
		if (k == 0) {
			this._SMSDropList.select(0, true);
			var kval = eval(this._sendOpts.sms[0].kvalue);
			this._SMScontentDom.html(kval.content).data("paras", kval.paras || '').data("sendkey", kval.sendkey || '');
		}
		// 
	} else {
		this._smsSelectshow = false;
		$(this._SMSDropListDom).hide().css('visibility', 'hidden');
		if (this._sendOpts.sms && this._sendOpts.sms.length == 1 && this._SMSDropList) {
			var kval = eval(this._sendOpts.sms[0].kvalue);
			this._SMScontentDom.html(kval.content).data("paras", kval.paras || '').data("sendkey", kval.sendkey || '');
		}
	}
};
/**
 * 
 */
KStdSender.prototype._insertGPSItemFun = function()
{
    if (this._sendOpts.gps && this._sendOpts.gps.length > 1 && this._GPSDropList)
    {
        this._gpsSelectshow = true;
        var length = this._sendOpts.gps.length;
        $(this._GPSDropListDom).show();
        this._GPSDropList.clearResult();
        $(this._GPSContentDom).html("");
        var listItem = "";
        var k = 0;
        for (var i = 0; i < length; i++)
        {
            listItem = this._sendOpts.gps[i];
            this._GPSDropList.insert( {
				text : listItem.name,
				kvalue : (this._getGPSContent(listItem.kvalue)),
				deletable : false,
				editable : false,
				selected : listItem.kvalue.selected,
				iconClass : '',
				itemClass : ''
			});
            if (listItem.kvalue.selected)
            {
                k++;
                $(this._GPSContentDom).html(this._getGPSContent(listItem.kvalue));
            }

        }
		//added by zy,GPS
//		if($('#olResult>li').hasClass('mwp_ls_rls')){
//			var selectNO = $('#olResult li.mwp_ls_rls').index();
//			listItem = this._sendOpts.sms[selectNO];
//			this._GPSContentDom.html(listItem.kvalue.content).data("paras", listItem.kvalue.paras);
//			this._GPSDropList.select(selectNO);
//		}
        if (k == 0)
            {
                this._GPSDropList.select(0, true);
                $(this._GPSContentDom).html(this._sendOpts.sms[0].kvalue.content);
            }
    }
    else
    {
        $(this._GPSDropListDom).hide();
        this._gpsSelectshow = false;
        if (this._sendOpts.gps && this._sendOpts.gps.length == 1 && this._GPSDropList)
        {
            $(this._GPSContentDom).html(this._getGPSContent(this._sendOpts.gps[0].kvalue));
        }
    }

};
/**
 * 
 */
KStdSender.prototype._initSendMail = function()
{
    var _this = this;
    var MAILItemDom = this._sendTab.tab(1);
    //add by zhangsq
    $('>div', MAILItemDom.contentDom).eq(0).removeClass().addClass(this._getClassName('C'));
    this._MAILSendForm = $(">div>form", MAILItemDom.contentDom).eq(0);
    // add by zhangsq
    $('>div', this._MAILSendForm).eq(0).removeClass().addClass(this._getClassName('MC'));
    // add by zhangsq
    $('>div', this._MAILSendForm).eq(1).removeClass().addClass(this._getClassName('TIP'));
    // add by zhangsq
    $('>div', this._MAILSendForm).eq(2).removeClass().addClass(this._getClassName('MCT'));
    this._MAILSendToInputDom = $(">div>input[type='text']", this._MAILSendForm).eq(0);
    //add by zhangsq
    this._MAILSendToInputDom.removeClass().addClass(this._getClassName('M'));
    this._MAILSendSubmitBtn = $(">div>input[type='submit']", this._MAILSendForm).eq(0);
    //add by zhangsq
    this._MAILSendSubmitBtn.removeClass().addClass(this._getClassName('MSND'));
    this._MAILSendContentDom = $(">div", this._MAILSendForm).eq(2);
    this._MAILSendSubmitBtn.unbind("click").click(function() {
            _this._timer = new Date();
            _this._sendMailfun();
    });
};
/**
 * ,
 */
KStdSender.prototype._getMMSPhoneNums = function()
{
    var _this = this;
    var phoneInputDom = $(">li>div>input", this._SMSFormUlDom);
    var length = phoneInputDom.length;
    var phoneNum = "",phoneStr = "";
    //#opt 1012281138 fix begin
    //delete by zhangsq
    //var re = /^(((13[0-9]{1})|159|(18[0-9]{1})+\d{8}|(15[0-9]{1}))+\d{8})|0\d{2,3}\d{7,8}$/;
    //add by zhangsq
    var re = /^[0-9]{11}$/;   //11
    var a = /^\d{11}$}/;
    //#opt 1012281138 fix end
    for (var i = 0; i < length; i++)
    {
        phoneNum = phoneInputDom.eq(i).val();
        if (!re.test(phoneNum))
        {
            var id = KTools.showMsg("", {outside:true,autoclose:5,node:phoneInputDom.eq(i).get(0), buboptions : {closebtn: false, pos :KPosition.BOTTOM}});
            phoneInputDom.eq(i).unbind('focus').bind('focus', function(){
                _this._killMsgTip(id);
            });
            return undefined;
        }
        else
        {
            phoneStr = (i == length - 1 ? phoneStr + phoneNum : phoneStr + phoneNum + ",");
        }
    }
    return phoneStr;
};
/**
 * 
 */
KStdSender.prototype._sendSMSFun = function()
{
    if (this._GaryBtn) return;
    var phoneParam = this._getMMSPhoneNums();
    if (!phoneParam) return;
    if (!this._opts.url)  return;
    if($('#mwp_send_captcha').val() == ""){
        KTools.showMsg("", {autoclose:5,node : $('#mwp_send_captcha').get(0)});
        return ;
    }
    this._GaryBtn = true;
    this._SMSSendBtn.removeClass().addClass(
			this._getClassName('SMSSND') + " " + this._getClassName('SSNDD'));
    // opt# 1008311132 fix begin
    // delete by zhangsq
    //var id = KTools.showMsg("...", {node:this._SMSSendBtn,lightbox:true});
    //add by zhangsq
    var id = KTools.showMsg("...", {node:this._SMSSendBtn.get(0), buboptions : {closebtn : false, pos : KPosition.RIGHT}});
    // opt# 1008311132 fix end
    var ajaxUrl = this._opts.url;
    if (ajaxUrl.indexOf("?") != -1)
    {
        var num = ajaxUrl.indexOf("?");
        ajaxUrl = ajaxUrl.substring(0, num);
    }
    var _this = this;


    var hash = new KUrlHash();
    hash.setKey("pho", phoneParam);
    // 
    hash.setKey("sco", this._SMScontentDom.text());
    //hash.setKey("sco", this._SMScontentDom.data("paras"));
    hash.setKey("smk", this._SMScontentDom.data("sendkey"));
    hash.setKey("sp", "bus");
    hash.setKey("t", "sds");
    hash.setKey("ca", $('#mwp_send_captcha').val());

    $.ajax({
        type : "POST"
        ,url : ajaxUrl
        ,cache : false
        ,data :  hash.toString()
        ,error : function() {
            _this._killMsgTip(id);
            KTools.showMsg("<br/>(E02)", {autoclose:5,node:_this._SMSSendBtn.get(0)});
            _this._setSMSBtnGary();
        }
        ,success: function(data) {
            if(data)
            {
                var _t = new Date();
                if(_t - _this._timer < 2000)
                {
                    setTimeout(function(){
                        _this._sendSuccess('sms',id,data.result,phoneParam);
                    }, 2000 - (_t - _this._timer));
                }
                else
                {
                    _this._sendSuccess('sms',id,data.result,phoneParam);
                }
            }
            else
            {
                _this._killMsgTip(id);
                KTools.showMsg('', {autoclose : 5, node : _this._SMSSendBtn.get(0)});
                _this._setSMSBtnGary();
            }
            $('#mwp_send_captcha').val("");
            setTimeout(function(){
                $('#mwp_send_captcha_img').click();
            },5000);
        }
        ,dataType:"json"
    });
};
/**
 * 
 */
KStdSender.prototype._getSMSSendTime = function()
{};
/**
 * complate()
 */
KStdSender.prototype._trriggerComplete = function()
{
    KEvent.trigger(this, "complete", this);
};
KStdSender.prototype._getMAILUser = function()
{};
/**
 * truefalse
 */
KStdSender.prototype._checkEmail = function()
{
    var mailUser = this._MAILSendToInputDom.val();
    if (mailUser.length != 0) {
        var arr = null;
        var num = mailUser.toLowerCase();
        num = num.replace(/ |;||/g, ",");
        arr = num.split(",");
        for (var i = 0; i < arr.length; i++) {
            if (!(/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/.test(arr[i])))
            {
                KTools.showMsg("", {outside:true,autoclose:5,node:this._MAILSendToInputDom.get(0),buboptions:{closebtn:false, pos : KPosition.TOP}});
                this._MAILSendToInputDom.select();
                this._MAILSendToInputDom.focus();
                return false;
            }
        }
        if(this._MAILSendContentDom.html().length == 0)
        {
            return false;
        }
        {
            return true;
        }
    } else {
        KTools.showMsg("", {outside:true,autoclose:5,node:this._MAILSendToInputDom.get(0), buboptions : {closebtn : false, pos : KPosition.TOP}});
        this._MAILSendToInputDom.select();
        this._MAILSendToInputDom.focus();
        return false;
    }
};
/**
 * 
 */
KStdSender.prototype._sendMailfun = function()
{
    if (!this._checkEmail()) return;
    if (!this._opts.url) return;
    if (this._MAILGaryBtn) return;

    if($('#mwp_sendMail_captcha').val() == ""){
        KTools.showMsg("", {autoclose:5,node : $('#mwp_sendMail_captcha').get(0)});
        return ;
    }

    var ajaxUrl = this._opts.url;
    if (ajaxUrl.indexOf("?") != -1)
    {
        var num = ajaxUrl.indexOf("?");
        ajaxUrl = ajaxUrl.substring(0, num);
    }
    this._mailGaryOrlightBtn(false);
    var _this = this;
    $("img[mfg='mpm']", this._MAILSendContentDom).css({width : 'auto'});
    var hash = new KUrlHash();
    hash.setKey("em", this._MAILSendToInputDom.val().replace(/ |;||/g, ","));
    hash.setKey("t", "sdm");
    hash.setKey("mt", $("span[mfg='mpt']", this._MAILSendContentDom).text());
    hash.setKey("mco", $("div[mfg='mpc']", this._MAILSendContentDom).html());
    hash.setKey("sp", "search");
    hash.setKey("ca", $('#mwp_sendMail_captcha').val());
	//added by zy,
	if($('.mwp_bs_sopt:visible').get(0)){
		$('.mwp_bs_sopt:visible').eq(0).find('input').eq(0).is(":checked")?hash.setKey("isb", true):hash.setKey("isb", false);
	}
	//added over
    $("img[mfg='mpm']", this._MAILSendContentDom).css({width : '500px'});
    // opt# 1008311135 fix begin
    // delete by zhangsq
    //var id = KTools.showMsg("...", {node:this._MAILSendSubmitBtn});
    // add by zhangsq
    //var id = KTools.showMsg("...", {node:this._MAILSendSubmitBtn.get(0), buboptions : {closebtn : false, pos : KPosition.RIGHT}});//
    var id = KTools.showMsg('...', {node : this._MAILSendToInputDom.get(0), buboptions : {closebtn : false, pos : KPosition.TOP}});
    // opt# 1008311135 fix end
    $.ajax({
        type : "POST"
        ,url : ajaxUrl
        ,cache : false
        ,data : hash.toString()
        ,error : function() {
            _this._killMsgTip(id);
            KTools.showMsg("<br/>(E01)", {title : '', buttons : KMsgBoxButtons.OK});//{autoclose:5,node:_this._MAILSendSubmitBtn.get(0), buboptions : {closebtn : false, pos : KPosition.RIGHT}}
            _this._mailGaryOrlightBtn(true);
        }
        ,success: function(data) {
            var _t = new Date();
            if(_t - _this._timer < 2000)
            {
                setTimeout(function(){
                    _this._sendSuccess('mail', id, data.result);
                }, 2000 - (_t - _this._timer));
            }
            else
            {
                _this._sendSuccess('mail', id, data.result);
            }

        }
        ,dataType:"json"
    });

};
/**
 * 
 * @param type String 
 * @param tip String id
 * @param data String 
 * @param phoneParam String
 */
KStdSender.prototype._sendSuccess = function(type, tip, data, phoneParam)
{
    var _this = this;
    if(type == 'mail')
    {
        _this._trriggerComplete();
        _this._killMsgTip(tip);
        _this._sendCallback(data,_this._MAILSendToInputDom.get(0));
        //KTools.showMsg("", {autoclose:5,node:_this._MAILSendSubmitBtn});
        _this._initAllDom(KSendType.email);
        _this._mailGaryOrlightBtn(true);
    }
    if(type == 'sms')
    {
        _this._SMSAddPhoneInputBtn.show();
        _this._trriggerComplete();
        _this._killMsgTip(tip);
        _this._setMMSCookie();
         _this._sendCallback(data,_this._SMSSendBtn.get(0),phoneParam);
        _this._initAllDom(KSendType.sms);
        _this._setSMSBtnGary();
        /*
        _this._GaryBtn = false;*/
    }
};
/**
 * 
 */
KStdSender.prototype._getMailPreview = function()
{
    var _this = this;
    var querytype = this._sendOpts.querytype;
    var previewurl = this._opts.previewurl;

    if (this._opts.previewurl)
    {
        if (previewurl.indexOf("?") != -1)
        {
            var num = previewurl.indexOf("?");
            previewurl = previewurl.substring(0, num);
        }
        var hash = new KUrlHash();
        previewurl = previewurl+"?" + this._sendOpts.email[0].kvalue;

        if(this._sendOpts.querytype == KQueryType.localsearch && this._sendOpts.sendtype == KSendType.email)
        {
            if(previewurl.indexOf("&n=")!= -1)
        {
          previewurl = previewurl.replace(/&n=[^&]*/gi,"");
        }
        else
        {
        previewurl = previewurl.replace(/\?n=[^&]*/gi,"");
        }
        }
        else if(this._sendOpts.querytype == KQueryType.localsearch  && (this._selectNum|| this._selectNum == 0))
        {

         if(previewurl.indexOf("&n=")!= -1)
        {
          previewurl = previewurl.replace(/&n=[^&]*/gi,"&n="+this._selectNum);
        }
        else
        {
        previewurl = previewurl.replace(/\?n=[^&]*/gi,"\?n="+this._selectNum);
        }

        }

        this._MAILSendContentDom.empty().load(previewurl, function() {
            if (_this._MAILSendContentDom.html() != "")
            {
                var url = document.location.href;
                /*#fix start : edit by liufang ##20111210*/
               	var lurl = escape(url).replace('#','23%').replace('/','%2F','g');
            	$.ajax({
                	type 	: "GET",
                    url 	: short_url,
                    cache	: false,
                    data 	: "url="+lurl,
                    success	: function(data) {
                    			if(data && data.surl){
                    				url = data.surl;
                    			}
                                $("a[mfg='mpu']", _this._MAILSendContentDom).attr("href", url).attr("target", "_blank").text(url);
                              },
                    error 	: function(){
                        		$("a[mfg='mpu']", _this._MAILSendContentDom).attr("href", url).attr("target", "_blank").text(url);
		                    },
                    dataType:"json"
                });  
                $("a[mfg='mpu']", _this._MAILSendContentDom).attr("href", url).attr("target", "_blank").text(url);
                $("a[mfg='mpmu']", _this._MAILSendContentDom).attr("href", url).attr("target", "_blank");
                /*#fix end*/
                $("img[mfg='mpm']", _this._MAILSendContentDom).attr("src", _this._emailImgUrl).css({width : '500px'});
                _this._emailImgUrl = undefined;
                _this._mailGaryOrlightBtn(true);
            }
        });
    }
};
/**
 * GPSactivexobjectbody
 */
KStdSender.prototype._loadActiveX = function()
{
    $("<object id=\"MYActiveX\" classid=\"clsid:F0C7099F-9FFF-406F-83A6-C0A0E088BF0A\" WIDTH=\"0px\" HEIGHT=\"0px\"></object>").appendTo(this._domAll);

};
/**
 *  active
 */
KStdSender.prototype._isActiveX1 = function()
{
    if (window.confirm("")) {
        window.open("http://mapbarhome.mapbar.com/map/down/download.html");
    }
};
/**
 * 
 */
KStdSender.prototype._DetectActiveX = function()
{
    try {
        var comActiveX = new ActiveXObject('MAPBARHOMEASSIST.MapbarHomeAssistCtrl.1');
        this._loadActiveX();
        return true;
    } catch (e) {
        return false;
    }
};
/**
 * 
 */
KStdSender.prototype._downloadMyLine = function()
{
    if (!this._DetectActiveX()) {
        this._isActiveX1();
        return;
    }

    var lines = [];
    lines.push("[");
    var pcontent = $(">p", this._GPSContentDom);
    var pos = pcontent.eq(0).html();
    var tit = pcontent.eq(1).html();
    var addr = pcontent.eq(2).html();
    var phone = pcontent.eq(3).html();
    lines.push("{\"type\":\"\",\"pos\":\""+pos+"\",\"name\":\""+tit+"\",\"address\":\""+addr+"\",\"phoneNumber\":\""+phone+"\",\"regionName\":\"\"}");
    lines.push("]");
    this._chk(lines.join(""));

};
/**
 * actionX
 * @param retValue
 */
KStdSender.prototype._chk = function(retValue) {
    var obj = document.getElementById("MYActiveX");
    if (typeof obj != "undefined" && typeof obj.setDataCheckList != "undefined") {
        if (retValue) {
            //%POI% %POI% %POI% %% %%
            ret = obj.setDataCheckList(1, retValue);
            this._trriggerComplete();
        } else {
            return;
        }
    }
};
/**
 * @overwrite
 * @uncrunch
 */
KStdSender.prototype._updateTabsOptions = function()
{
    if (this._sendOpts.sendtype)
    {
        (this._sendOpts.sendtype & KSendType.sms) == KSendType.sms ? this._sendTab.showTab(0) : this._sendTab.hideTab(0);
        (this._sendOpts.sendtype & KSendType.email) == KSendType.email ? this._sendTab.showTab(1) : this._sendTab.hideTab(1);
        (this._sendOpts.sendtype & KSendType.gps) == KSendType.gps ? this._sendTab.showTab(2) : this._sendTab.hideTab(2);
        (this._sendOpts.sendtype & KSendType.car) == KSendType.car ? this._sendTab.showTab(3) : this._sendTab.hideTab(3);
        this._initTabShow();
    }
    else
    {
        this._sendTab.hideTab(0);
        this._sendTab.hideTab(1);
        this._sendTab.hideTab(2);
        this._sendTab.hideTab(3);
    }
};
/**
 * 
 * @param type
 */
KStdSender.prototype._initAllDom = function(type)
{
    if(type | KSendType.sms == KSendType.sms)
    {
    //MESSAGE
    $('<li><div class="' + (this._getClassName('PNC')) + '"><input type="text" /></div><a href="javascript:void(0);"></a></li>').appendTo(this._SMSFormUlDom.empty());
    this._SMScontentDom.html("").removeData("paras").removeData("sendkey");
    this._SMSPhoneInputNum = 1;
    this._insertSMSItemFun();
    }
    //EMAIL
    if(type | KSendType.email == KSendType.email)
    {
    this._MAILSendToInputDom.val("");
    //this._MAILSendContentDom.empty();
    this._emailImgUrl = undefined;
    }
    if(type | KSendType.gps == KSendType.gps)
    {

    }
    if(type | KSendType.mms == KSendType.mms)
    {

    }
};
KStdSender.prototype._setOption = function(opts)
{
    this._oldOpts = this._opts.theme;
    this._opts = KTools.copyOptions(opts, this._opts);
};
/**
 * GPS
 * @param json
 */
KStdSender.prototype._getGPSContent = function(json)
{
    var contenthtml = [];
    if (json)
    {
        contenthtml.push("<p style='display:none;'>" + (json.pos ? json.pos : "") + "</p>");
        contenthtml.push("<p>" + (json.name ? json.name : "") + "</p>");
        contenthtml.push("<p>" + (json.address ? json.address : "") + "</p>");
        contenthtml.push("<p>" + (json.phoneNumber ? json.phoneNumber : "") + "</p>");
    }
    contenthtml.push("<p>-www.mapbar.com</p>");
    return contenthtml.join("");
};
/**
 * Cookies
 */
KStdSender.prototype._setSMSBtnGary = function()
{
//    return;
    var signinfun = this._opts.signinfun;

    if (signinfun && signinfun.fun.apply(signinfun.thisobj, [signinfun.data]).signin)
    {
        //
     //   return;
    }
    var sndcookie = KTools.getCookie("sndsmsl");
    //sndcookie = "20,2010-07-21 11:30:20";
    var date = new Date();
    if (sndcookie)
    {

        var arrCookie = sndcookie.split(",");
        var sendtime = arrCookie[0];
        var senddate = arrCookie[1];
        if (parseInt(this._getDistanceDate(date, this._stringToDate(senddate))) >= parseInt(this._opts.smsinterval))
        {
            KTools.setCookie("sndsmsl", "0," + date.toString());
            this._SMSSendBtn.removeClass().addClass(this._getClassName('SMSSND'));
            this._GaryBtn = false;
            //
            return;
        }
        if (parseInt(sendtime) >= parseInt(this._opts.smslimit))
        {
            //
            this._SMSSendBtn.removeClass().addClass(this._getClassName('SMSSND') + " " + this._getClassName('SSNDD'));
            this._GaryBtn = true;
        }
        else
        {
            //
            this._SMSSendBtn.removeClass().addClass(this._getClassName('SMSSND'));
            this._GaryBtn = false;
        }
    }
    else
    {
        //
        KTools.setCookie("sndsmsl", "0," + this._dateToString(date));
        this._SMSSendBtn.removeClass().addClass(this._getClassName('SMSSND'));
        this._GaryBtn = false;
    }
};
/**
 * datestring
 * @param date Date
 * @return String
 */
KStdSender.prototype._dateToString = function(date)
{
    var strArray = [];
    strArray.push(date.getFullYear());
    strArray.push("-");
    strArray.push(date.getMonth() + 1);
    strArray.push("-");
    strArray.push(date.getDate());
    strArray.push(" ");
    strArray.push(date.getHours());
    strArray.push(":");
    strArray.push(date.getMinutes());
    strArray.push(":");
    strArray.push(date.getSeconds());
    return strArray.join("");

};
/**
 * stringdate
 * @param str
 */
KStdSender.prototype._stringToDate = function(str)
{
    return(new Date(Date.parse(str.replace(/-/g, "/"))));
};
/**
 * 
 * @param date1
 * @param date2
 */
KStdSender.prototype._getDistanceDate = function(date1, date2)
{
    var distance = date1.valueOf() - date2.valueOf();

    return Math.floor(distance / 86400000);

};
/**
 * 
 * @param flag
 */
KStdSender.prototype._mailGaryOrlightBtn = function(flag)
{
    if (flag)
    {
        this._MAILGaryBtn = false;
        this._MAILSendSubmitBtn.removeClass().addClass(this._getClassName('MSND'));
    }
    else
    {
        this._MAILSendSubmitBtn.removeClass().addClass(this._getClassName('MSND') + " " + this._getClassName('MSNDD'));
        this._MAILGaryBtn = true;
    }
};
/**
 * 
 * @param id
 */
KStdSender.prototype._killMsgTip = function(id)
{
    if (id)
    {
        KTools.hideMsg(id);
    }
};
/**
 * cookie
 */
KStdSender.prototype._setMMSCookie = function()
{
    if (!KTools.getCookie("sndsmsl")) return;
    var arrCookie = KTools.getCookie("sndsmsl").split(",");
    var sendtime = arrCookie[0];
    var senddate = arrCookie[1];
    KTools.setCookie("sndsmsl", (parseInt(sendtime) + 1) + "," + senddate);
};
/**
 * 
 * @param result
 * @param dom
 * @param str
 */
KStdSender.prototype._sendCallback = function(result,dom,str)
{
    var _this = this;
    if(!result || !result.result)
    {
        KTools.showMsg("<br/>", {title : '', buttons : KMsgBoxButtons.OK});
        return ;
    }
    var  strresult =result.result;
    var length = strresult.length;
    var  falg = false;
    var message ="";
    for(var i=0;i<length;i++)
    {
        if(result.type=="mail")//
        {
            if(strresult[i].send =="0")
            {
                message =  "";
                KTools.showMsg(message, {autoclose:5,node:_this._MAILSendToInputDom.get(0), buboptions : {closebtn : false, pos : KPosition.TOP}});
                falg =true;
                break;
            }
        }
        else if(result.type=="sms")//
        {
            if(strresult[i].send =="0")
            {
                if(parseInt(result.result[i].failcode) <= 50)
                {
                    message =  result.result[i].message;
                }
                else if(parseInt(result.result[i].failcode) >= 500 && parseInt(result.result[i].failcode) <= 600)
                {
                    message =  result.result[i].message;
                }
                else
                {
                    message = '';
                }

                KTools.showMsg(message, {autoclose:5,node:dom, buboptions : {pos : KPosition.RIGHT, closebtn : false}});
                _this._setSMSBtnGary();
                falg =true;
            }
        }
    }
    // opt# 1008311116 fix begin
    //delete by zhangsq
    //message= str ? ""+str+"":"";
    //add by zhangsq
    message = "";
    var sndcookie = KTools.getCookie("sndsmsl");
    var date = new Date();
    if (sndcookie)
    {
        var arrCookie = sndcookie.split(",");
        var sendtime = arrCookie[0];
        var senddate = arrCookie[1];
        if (parseInt(this._getDistanceDate(date, this._stringToDate(senddate))) >= parseInt(this._opts.smsinterval))
        {}
        else
        {
            if (parseInt(sendtime) >= parseInt(this._opts.smslimit))
            {
                message = "20";
            }
        }
    }
    // opt# 1008311116 fix end
    if(!falg)
        KTools.showMsg(message, {autoclose:5,node : dom, buboptions : {closebtn : false, pos : dom == _this._MAILSendToInputDom.get(0) ? KPosition.TOP : KPosition.RIGHT}});
};
KStdSender.prototype._initTabShow = function()
{
    if (this._sendOpts.querytype == KQueryType.navsearch)
    {
        this._sendTab.hideTab(0);
    }
    if(this._sendOpts.querytype == KQueryType.navsearch || this._sendOpts.querytype == KQueryType.busearch)
    {
        this._sendTab.hideTab(3);
    }
    //opt# 1008261353 fix begin
    //delete by zhangsq
    /*if (this._sendOpts.querytype == KQueryType.localsearch && $.browser.msie)
    {
        this._sendTab.showTab(2);
    }
    else
    {
        this._sendTab.hideTab(2);
    }*/
    //add by zhangsq
    if((this._sendOpts.querytype == KQueryType.localsearch) && (!$.browser.msie))
    {
        this._sendTab.hideTab(2);
    }
    if(this._sendOpts.querytype == KQueryType.localsearch)
    {
        this._sendTab.showTab(3);
    }
    //opt# 1008261353 fix end
};
/**
 *   UI 
 *  @overwrite
 *  @uncrunch
 */
KStdSender.prototype.close = function()
{
    this._domAll.hide();
    KTools.lightbox({});
    this._initAllDom(KSendType.email | KSendType.gps | KSendType.sms |KSendType.mms);
};

/*
==================================== KObject ===================================
 */
/**
 *  null this._dom
 *  @overwrite
 *  @uncrunch
 */
KStdSender.prototype.finalize = function()
{
    this._initialized = undefined;
    if (this._SMSAddPhoneInputBtn)
    {
        KEvent.clear(this._SMSAddPhoneInputBtn);
    }
    if (this._SMSSendBtn)
    {
        KEvent.clear(this._SMSSendBtn);
    }
    if (this._GPSSendDownLandBtn)
    {
        KEvent.clear(this._GPSSendDownLandBtn);
    }
    if (this._MAILSendSubmitBtn)
    {
        KEvent.clear(this._MAILSendSubmitBtn);
    }
    if (this._sendTab)
    {
        this._sendTab.finalize();
    }
    if (this._SMSDropList)
    {
        this._SMSDropList.finalize();
    }
};

/*
====================================== KWidget ========================================
 */
/**
 * 
 * @return String
 * @uncrunch
 */
KStdSender.prototype.cnname = function()
{
    return "";
};
/**
 * 
 * @return String 
 * @uncrunch
 */
KStdSender.prototype.version = function()
{
    return "1.2.1";
};
/**
 * 
 * @uncrunch
 */
KStdSender.prototype.layout = function()
{
    this._layout();
};
/**
 * 
 * @return String
 * @uncrunch
 */
KStdSender.prototype.setOptions = function(opts)
{
    this._oldOpts = this._opts.theme;
    var diffOpts = KTools.compareOptions(this._opts, opts);
    this._initOption();
    this._selectNum = undefined;
    $.each(diffOpts, function(name, value) {
        switch (name)
        {
            case 'theme':
                this._setOption({'theme':value});
                this._setTheme();
                break;
            case 'smslimit':
                this._setOption({'smslimit':value});
                break;
            case 'smsinterval':
                this._setOption({'smsinterval':value});
                break;
            case 'signinfun':
                this._setOption({'signinfun':value});
                break;
        }
    });
};
/**
 *  options
 *  @overwrite
 *  @uncrunch
 */
KStdSender.prototype.setOptions = function(opts)
{
    var _this = this;
    this._oldOpts = this._opts.theme;
    var diffOpts = KTools.compareOptions(this._opts, opts);
    $.each(diffOpts, function(name, value) {
        switch (name)
        {
            case 'theme':
                _this._setOption({'theme':value});
                _this._setTheme(this._opts.theme);
                break;
            default:
        }
    });
};
/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KStdSender.prototype.dependent = function()
{
    return [KQuery ,KEvent ,jQuery,KSender,KSendType,KDropList,KUrlHash,KStdTabs,KTools,KSendOptions,KMap];
};

/*
======================================= KSender ==========================================
 */
/**
 * ,
 * @param opts
 */
KStdSender.prototype.send = function(opts)
{
    this._sendOpts = KTools.copyOptions(opts, KSendOptions);
    if (!opts.sendtype || (opts.sendtype && opts.sendtype == KSendType.all))
    {
        this._sendOpts.sendtype = (KSendType.sms | KSendType.email | KSendType.gps | KSendType.car);
    }
    this._GaryBtn = false;

    this._init();
};








/* *
 
 songyr
 1.0
 2010-02-03
 2010-02-03 23:07
 ============================================
 
 bug# 1008190954
 datachanged

 bug# 1009011003
 
 */

var KStdSuggest = KClass.create("KStdSuggest", KSuggest);
KStdSuggest.conf =
{
    CLASSNAME :
    {
        A:"_sug_a"
        ,S:"_sug_s"
    }
};


/**
 *   
 * @param arg  
 */
KStdSuggest.prototype._setClassName = function(arg)
{
    if (arg && KStdSuggest.conf.CLASSNAME[arg])
    {
        return this.options().theme + KStdSuggest.conf.CLASSNAME[arg];
    }
    return undefined;
};

/**
 *
 * @uncrunch
 */
KStdSuggest.prototype.clearCache = function()
{
    this.cache = {};
    this.cache.data = {};
    this.cache.length = 0;
    this.cacheKeyArr = [];
};


/**
 * 
 * @param textbox Node
 * @param opts KSuggestOptions
 * @uncrunch
 */

KStdSuggest.initialize = function(textbox, opts)
{
    var _this = this;
    this.setOptions(KStdSuggestOptions);
    //opts
    this.setOptions(opts);
    this.setTheme(this.options().theme);
    //Dom
    this._jTextbox = $(textbox);
    this._textbox = this._jTextbox[0];
    this._autorevert = this._jTextbox.val();
//    if (this._jTextbox.val())  this._jTextbox.val("");

    this._parentResults = this.options().node ? $(this.options().node) : $("body");
    this._results = $("<ul/>").hide().addClass(this._setClassName("A"));
    if($.browser.msie){
    	$(function(){
    		_this._results.appendTo(_this._parentResults);
    	});
    }else{
    	this._results.appendTo(this._parentResults);
    }

    if(this.options().minwidth != 0){
        this._results.css(KTools.isIE6 ? {width : this.options().minwidth + "px"} : {"min-width":this.options().minwidth + "px"});
    }

    this._dom = this._results[0];
    //suggest
	this._visible = true;
    this.timeout = null;
    this.prev = "";
    this.active = -1;
    this.hasFocus = false;

    this.mouseDownOnSelect = false;
    //    this._keyEnter = false;
    this.hidingResults = false;

    this.lastKeyPressCode = null;
    this.requestId = 1;

    this.urlArray = [];
    //    this.urlArray.push(this.options().url, "&a=", this.options().listlimit, "&k=");
    //    this.urlString = encodeURI(this.urlArray.join(""));

    if (this.options().cache === true) {
        this.clearCache();
    }
    this._flag = false;
    this.tmpAjaxData = undefined;
    this._data = undefined;
    
    this._cookieSug = false;
    
    /*    this._jTextbox.bind("contextmenu",function(e){
     });*/
    this._jTextbox.keydown(function(e) {
	_this.setVisible(true);

//        if (!_this._flag && _this._jTextbox.is(":visible")) {
//        if (_this._jTextbox.is(":visible")) {
            /*_this._results.offset({
                top: _this._jTextbox.offset().top + _this._jTextbox.outerHeight(true),
                left: _this._jTextbox.offset().left
            });*/
//            _this._flag = true;
//        }

        _this.lastKeyPressCode = e.keyCode;
        switch (e.keyCode) {
            case 38: //
                _this.bmove = true;
                e.preventDefault();
                if(_this._results.children().length == 0) break;
                _this._results.show();
                _this._moveSelect(-1);
//                    KTools.showMsg("up");
                break;
            case 40: //
                _this.bmove = true;
                e.preventDefault();
                if(_this._results.children().length == 0) break;
                _this._results.show();
                _this._moveSelect(1);
//                    KTools.showMsg("down");
                break;
            case 9:  // tab
                _this._onBlur.apply(_this);
                break;
            case 13: // 
                if (_this.bmove && _this._selectCurrent()) {

                    //                    KEvent.trigger(_this, "datachanged", _this, {text:_this._jTextbox.val(),kvalue:_this._jTextbox.attr("kvalue") || ""});
                    //                    _this._keyEnter = true;
//                    _this._jTextbox.get(0).blur();
                    _this.bmove = false;
//                    e.preventDefault();
                } else {
                    _this._results.hide();
                }
//                _this._selectCurrent();
                _this._results.hide();
//                    KTools.showMsg("enter");
                break;
            case 16:  //shift
            case 17:  //ctrl
            case 18:  //alt
            case 37://
            case 39://
                break;
            case 229:
                if (!$.browser.msie) {
                    _this._jTextbox.bind("input", function() {
                        _this._inputChange(_this);
                    });
                    break;
                }
            default:
                _this._inputChange(_this);
                break;
        }
    }).focus(function() {
		_this._onFocus.apply(_this);
    }).blur(function(){
		_this._onBlur.apply(_this);
	});
	
	/*add by liufang 20131202
		suggest
	*/
	KEvent.bind(KMap, "mousedown", function () {
		_this._textbox.blur();
	});
	/*add by liufang 20131202*/
};
/**
 * 
 */
KStdSuggest.prototype._onFocus = function () {
	var _this = this;
	/*_this._results.offset({
			top: _this._jTextbox.offset().top + _this._jTextbox.outerHeight(true),
			left: _this._jTextbox.offset().left
		});*/
	var bounds = KTools.getBounds(_this._jTextbox[0]);
	_this._results.css({
			top: "",
			left: ""
		});
	// bug# 1009011003 fix begin
	// delete by zhangsq
	/*_this._results.offset({
			top: bounds.max.y - ($.browser.msie ? 2 : 0),
			left: bounds.min.x - ($.browser.msie ? 2 : 0)
			*//*top: _this._jTextbox.offset().top + _this._jTextbox.outerHeight(true),
			left: _this._jTextbox.offset().left*//*
		});*/
	// add by zhangsq
	_this._results.css({
		top : (bounds.max.y - ($.browser.msie ? 2 : 0)) + 'px'
		,left : (bounds.min.x - ($.browser.msie ? 2 : 0)) + 'px'
	});
	// bug# 1009011003 fix end
	_this.hasFocus = true;
	if(_this.hasFocus){
		var v = _this._jTextbox.val();
		if(v.length <= 0){
			_this._onChange();
		}
	}
};
/**
 * 
 */
KStdSuggest.prototype._onBlur = function() {
        var _this = this;
        _this.hasFocus = false;
        if (!_this.mouseDownOnSelect) {
            _this.clearTimer();
        }
        if (_this.options().autocomplete === true && _this._jTextbox.val() !== "" && _this._results.is(":visible") && _this.prev === _this._jTextbox.val() && _this._results.children().length && !_this._results.children().hasClass(_this._setClassName("S"))) {
            //            _this._textbox.val(_this._results.find("li").eq(0).html());
            _this.active = 0;
            _this._selectItem(_this._results.find("li").eq(0)[0]);
            //            _this._keyEnter = false;
        } else if (_this.options().autorevert) {
            _this._jTextbox.val(_this._autorevert);
            return;
        }
        //_this.setData(_this.tmpAjaxData ? _this.tmpAjaxData.a[_this.active] : undefined);
        _this.setData((_this.tmpAjaxData && _this.tmpAjaxData.a) ? _this.tmpAjaxData.a[_this.active] : undefined);
        _this._hideResultsNow();
    };


//KObject
/**
 * 
 * @uncrunch
 */
KStdSuggest.prototype.finalize = function()
{
    delete this.cache;
    delete this.cacheKeyArr;

    KTools.removeNode(this._results[0]);
    KEvent.clear(this._results);
    KEvent.clear(this._jTextbox);

    KTools.removeNode(this._results);

    //    this._results.remove();
    //    this._textbox.unbind();

};
//end KObject

//KWidget

/**
 * @return Dom
 * @uncrunch
 */
KStdSuggest.prototype.dom = function()
{
    return this._dom;
};

/**
 * 
 * @return String 
 * @uncrunch
 */
KStdSuggest.prototype.version = function()
{
    return "1.0";
};

/**
 * 
 * @return String
 *  @uncrunch
 */
KStdSuggest.prototype.cnname = function()
{
    return "";
};

/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KStdSuggest.prototype.dependent = function()
{
    return [KSuggest,jQuery,KEvent,KStdSuggestOptions,KTools,KUrlHash];
};

/**
 * 
 * @uncrunch
 */
KStdSuggest.prototype.clearTimer = function ()
{
    //bug# 201005211150 fix begin
    //delete by zhaobo
    if (this.timeout) clearTimeout(this.timeout);
    var _this = this;
    this.timeout = setTimeout(function() {
        _this._hideResultsNow();
    }, 200);
    //add by zhaobo
    /*this._results.children().remove();
    this._hideResultsNow();*/
    //bug# 201005211150 fix end
};
KStdSuggest.prototype.clearResult = function ()
{
    this._results.children().remove();
    this._hideResultsNow();
};
/**
 * obj 
 * @param obj
 * @uncrunch
 */
KStdSuggest.prototype.setOptions = function(obj)
{
    this._opts = KTools.copyOptions(obj, this.options());
};

/**
 * 
 * @param scheme
 * @uncrunch
 */
KStdSuggest.prototype.setTheme = function(scheme)
{
    this._theme = scheme;
};

//end KWidget


/**
 * 
 * @param textbox
 * KSuggsetInfo 
 * @uncrunch
 */
/*KStdSuggest.prototype.data = function()
 {

 //widgetKSuggest 
 //textboxNode 
 //dataKSuggsetInfo 
 return this._data;

 };*/

/**
 * 
 * @param data KSuggsetInfo 
 * @uncrunch
 */
KStdSuggest.prototype.setData = function(data)
{
	if (typeof data != "object")return;
    this._data = data;
    this._autorevert = this._data.text;
};

/**
 * textbox
 * @uncrunch
 */
KStdSuggest.prototype.hideTip = function()
{
    //this._results.hide();
};

/**
 * 
 * @param step
 */
KStdSuggest.prototype._moveSelect = function (step)
{
    var lis = $("li", this._results);
    if (!lis.length) {
        return;
    }

    this.active += step;
    if (this.active < 0) {
        this.active = lis.size() - 1;
    } else if (this.active >= lis.size()) {
        this.active = 0;
    }

    lis.removeClass(this._setClassName("S"));

    $(lis[this.active]).addClass(this._setClassName("S"));

    //input
    this._jTextbox.val(this._extractData($(lis[this.active])));
    //    this.setData( this._textbox,{text:this._extractData($(lis[this.active]))})


};

/**
 * 
 */
KStdSuggest.prototype._selectCurrent = function()
{
    var li = $("li", this._results).filter("." + this._setClassName("S"))[0];
    //    if (!li) {
    //        var $li = $("li", this._results);
    //    }
    if (li) {
        this._selectItem(li);
        return true;
    } else {
        return false;
    }
};

/**
 * SUGGEST
 * @param li    dom
 */
KStdSuggest.prototype._selectItem = function(li)
{
    //LI
    if (!li)  return;
    //   this._extractHtml(li);
    this._autorevert = this._extractData(li);
    this._jTextbox.val(this._autorevert);
    this._jTextbox.attr("kvalue", $(li).attr("kvalue"));
    this._jTextbox.attr("zoom", $(li).attr("zoom"));
    this._jTextbox.attr("isbus", $(li).attr("isbus"));
    this._hideResultsNow();
    //bug# 1008190954 fix begin
    //delete by zhangsq
    //KEvent.trigger(this, "datachanged", this, {text:this._jTextbox.val(),kvalue:this._jTextbox.attr("kvalue") || "",zoom:this._jTextbox.attr("zoom"), isbus:this._jTextbox.attr("isbus")});
    //add by zhangsq
    KEvent.trigger(this, "datachanged", this, {text:this._jTextbox.val(), kvalue:this.tmpAjaxData.a[this.active].b});
    //bug# 1008190954 fix end

};

/**
 *       html
 * @param li   dom
 * KSuggsetInfo 
 */
KStdSuggest.prototype._extractData = function (li)
{
    var _li = $(li);
    var v = _li.html();
    var t = v.toLowerCase().indexOf("<span>");
    //  this._results.html("");
    var returnV = _li.text();// t === -1 ? v : v.slice(0, t);
    if(t !== -1){
        //myA.text().replace(myA.children("span").html(), "")
        var tstr = _li.children("span").html();
        returnV = _li.text().replace(tstr, "");
    }
    return  returnV;
//    return  t === -1 ? v : v.slice(0, t);

};

KStdSuggest.prototype._inputChange = function (_this_)
{
    _this_.active = -1;
    if (_this_.timeout) {
        clearTimeout(_this_.timeout);
    }
    _this_.timeout = setTimeout(function() {
        _this_._onChange();
    }, _this_.options().speed);
};

/**
 * 
 */
KStdSuggest.prototype._onChange = function ()
{
    // del shift capslock
    if (this.lastKeyPressCode == 46 || (this.lastKeyPressCode > 8 && this.lastKeyPressCode < 32)) {
        //this._results.hide();
    }
    var v = this._jTextbox.val();
    //    if (this.lastKeyPressCode == 229) {
    //
    //    }
    //       var v = $.trim(this._textbox.val());

    //   this._textbox.change(function(){
    //   });

    //        if (v == this.prev) {
    //            return;
    //        }

    this.prev = v;
    this._requestData(v);
    
    /*
    if(v.length > 0){
        this.prev = v;
        if (v.length >= this.options().charcount) {
            //suggest
            this._requestData(v);
        }
    }else{
        var topTagStr = this._jTextbox.selector;
        var topTag = topTagStr.substring(topTagStr.indexOf('mfg=\'')+5,topTagStr.indexOf('\']'));
    	var cookie = KTools.getCookie(topTag);
    	if(cookie){
    		var cookieArr = cookie.split(',');
    		this.tmpAjaxData = {};
    		this.tmpAjaxData.a = new Array(); 
    	    var liArr = [];
    	    var _li = $("<li/>"),li;
    	    for (var i = 0; i < cookieArr.length; i++) {
    	    	this.tmpAjaxData.a[i] = {};
    	    	this.tmpAjaxData.a[i].b = '';
    	    	li = _li.clone();
    	    	li.html(cookieArr[i]);
    	    	liArr.push(li[0]);
    	    }
    	    this.active = 1;
    	    this._outParsedData(liArr);
    	}else{
    		this._hideResultsNow();
    	}
    }*/

};

/**
 * suggest
 * @param q    
 */
KStdSuggest.prototype._requestData = function (q)
{
    q = $.trim(q);
/*
    if (!q) {
        this._hideResultsNow();
        return;
    }
  */  
    var topTagStr = this._jTextbox.selector;
    var topTag = topTagStr.substring(topTagStr.indexOf('mfg=\'')+5,topTagStr.indexOf('\']'));
    if(topTag == 'bz'){
		topTag = 'ba';
	};
    if(!q){
    	var cookie = KTools.getCookie(topTag);
    	var cookieArr = {};
    	//--
		if(topTag == 'zk'){
			var zkInputTip = ",,,KTV,,,ATM";
			if(cookie){
				cookieArr = cookie.split(',');
				cookieArr = cookieArr.reverse();
				if(cookieArr.length > 3){	cookieArr.length = 3;	};
				cookie = cookieArr.join(",") + ",";
			}else{
				cookie = "";
			}
			cookie = cookie + zkInputTip;
		};
    	if(cookie){
    		cookieArr = cookie.split(',');
    		if(topTag != 'zk'){
    			cookieArr = cookieArr.reverse();
    		}
    		if(cookieArr.length > 0 ){
    			
    			var data = {};
        		data.a = new Array(); 
       		    var _this = this;
        	    for (var i = 0; i < cookieArr.length; i++) {
        	    	data.a[i] = {};
        	    	data.a[i].a = '';
        	    	data.a[i].b = '';
        	    	data.a[i].c = cookieArr[i] + '<span> </span>';
        	    };
        	    _this.tmpAjaxData = data;
        	    _this._handleData(q, data, this.requestId);
        	    this._cookieSug = true;
    		}else{
    			this._hideResultsNow();
    			this._cookieSug = false;
    		}
    	}else{
    		this._hideResultsNow();
    		this._cookieSug = false;
    	};
    	return;
    };
    if(topTag == 'zk'){return;};
    this._cookieSug = false;
    
    
    var cacheData = (this.options().cache === true) ? this._loadFromCache(q) : undefined;
//    var cacheData = this._loadFromCache(q);
    if (cacheData)
    {
        //
        //        this._outParsedData(cacheData);
        this._handleData(q, cacheData, this.requestId);
    }
    else if ((typeof this.options().url == "string") && (this.options().url.length > 0))
    {
        //
        this.requestId += 1;
        if (this.requestId > 5000) {
            this.requestId = 0;
        }
        var thisRequestId = this.requestId;
        // suggest   songyr

        //   $.get(makeUrl(q), function(data) {
        var _this = this;
        $.getJSON(this._getURL(q),
                function(data)
                {
        			_this.tmpAjaxData = data;
                    //   cache
                    if (_this.options().cache === true) {
                        _this._addToCache(q, data);
                    }	
					if(_this._visible) {
						_this._handleData(q, data, thisRequestId);
					}
                });
    }

};
/**
 * @desc 
 * @param {Boolean} visible true 
 * @uncrunch
 */
KStdSuggest.prototype.setVisible = function (visible){
	this._visible = typeof visible === 'boolean' ? visible : true;
};

/**
 * URL
 * @param q
 */
KStdSuggest.prototype._getURL = function(q) {

    /*var tempArray = [];
    tempArray.push(this.options().url, "&a=", this.options().listlimit, "&k=", q);
    return encodeURI(tempArray.join(""));*/
    var hash = new KUrlHash();
    hash.setKey("a", this.options().listlimit);
    hash.setKey("k", q);
    return this.options().url + "&" + hash.toString();
    // return encodeURI(this.options().url + "&k=" + q) + "&a=" + this.options().listlimit /*+ "&s=" + this.options().ajaxmode*/;
};


KStdSuggest.prototype._hideResultsNow = function ()
{
    if (this.hidingResults) {
        return;
    }
    this.hidingResults = true;
    if (this.timeout) {
        clearTimeout(this.timeout);
    }
    if (this._results) {
        this._results.hide();
    }

    this.hidingResults = false;
};

/**
 * SUGGEST 
 * @param q   
 * @param data    SUGGEST
 * @param thisRequestId  ID
 */
KStdSuggest.prototype._handleData = function (q, data, thisRequestId)
{
	//
	if(this.tmpAjaxData.a && this.tmpAjaxData.a.length == 0){
		KEvent.trigger(this,"nodata",{"dcount" : "0"});
	}else{
		KEvent.trigger(this,"hasdata",{"dcount" :"1"});
	}
    if (thisRequestId == this.requestId && data) {
        /*  var d = jsond.r[6].k.slice(1).split("-")
         jsond.r[6].l.slice(d[0], d[1])*/
        //        var data = this._parseData(data);
        //parsedData     {text:"",value:""}
        var parsedData;
        if (this.options().preprocessDataFun) {
            parsedData = this.options().preprocessDataFun.fun.call(this.options().preprocessDataFun.thisobj, data);
        } else {
            parsedData = this._parseDataToDom(data);
        }
        //       var ObjData= this._dataToObj(parsedData);

        //
        
        this._outParsedData(parsedData);
    }
};

/**
 * 
 * @param data
 * liArr
 */
KStdSuggest.prototype._parseDataToDom = function (data)
{
    if (!data || !data.a || !data.a.length) {
        return null;
    }
    //    if (this.options().ajaxmode == "html") return data;

    //
    //    var parsed = {},rows,row;
    var num = data.a.length,row;

    //rows = data.match(/\[.*\]/)[0].match(/\{.*?}/g);
    //    var parsed = [],rows

    /*    for (var i = 0; i < num; i++) {
     row = rows[i].l;
     if (row) {
     var aa = row.match(/'(.*?)'/g);
     parsed[parsed.length] = row.split(",");
     }
     }*/


    // var ul = $("<ul/>");
    /*    if ((this.options().listlimit > 0) && (this.options().listlimit < num))
     {
     num = this.options().listlimit;
     }*/
    //    var ul = document.createElement("ul");
    var liArr = [];
    var _li = $("<li/>"),li;
    for (var i = 0; i < num; i++) {
        row = data.a[i];
        if (!row) continue;
        li = _li.clone();
        //        var li = document.createElement("li");

        //    var a = document.createElement("a");

        //        li.appendChild(a);

        //        a.innerHTML = row.replace(/,/, "<span>").replace(/$/, "</span>");
        // li.selectValue = row[0];
        //        li.innerHTML = row;
        li.attr("kvalue", row.b.a);
        li.attr("zoom", row.b.b);
        li.attr("isbus", row.b.c);
        li.html(row.c);
        //        li.attr("text",row.k);
        liArr.push(li[0]);
        //        ul.appendChild(li);
    }
    return  liArr;
    /*.html() ? ul[0] : null;*/
};

/**
 * 
 * @param data
 */
KStdSuggest.prototype._outParsedData = function (data)
{
    var _this = this;
    if (data) {

        //$input.removeClass(options.loadingClass);
        //        this._results.html("");
        this._results.children().remove();
        // 
      if (!this.hasFocus || data.length == 0) return this._hideResultsNow();

        //        if ($.browser.msie) {
        //            this._results.css("position", "static");
        //        }
        /*  if (this.options().ajaxmode == "html") {
         this._results.append(data);

         } else {
         this._results.append(this._dataToDom(data));
         }*/

        this._results.append(data);
        //if(KTools.isIE6) $("<li style=\"position:relative;width:0;padding:0;height:0px;font-size:0px;border-left:"+this.options().minwidth+"px solid #FFF;\"></li>").appendTo(this._results);

        var _lis = $("li", this._results);
        $("li", this._results).hover(
                function() {
                    _lis.removeClass(_this._setClassName("S"));
                    $(this).addClass(_this._setClassName("S"));
                    _lis.each(function(index, domEle) {
                        if ($(domEle).hasClass(_this._setClassName("S"))) {
                            _this.active = index;
                            return false;
                        }
                    })
                },
                function() {
                    $(this).removeClass(_this._setClassName("S"));
                }).click(function(e) {
            e.preventDefault();
            e.stopPropagation();
          //  var li = $("li", this._results).filter("." + this._setClassName("S"))[0];
            if(!_this._cookieSug){
            	_this._selectItem(this);
            }
        }).mousedown(function(e) {
        	_this._selectItem(this);
        });
        $(this._results).mousedown(function() {
            _this.mouseDownOnSelect = true;
        }).mouseup(function() {
            _this.mouseDownOnSelect = false;
        });
        this._results.show();
    } else {
        this._hideResultsNow();
    }
};

/**
 * useless by songyr
 *  dom
 * @param data
 */
/*KStdSuggest.prototype._dataToDom = function (data) {

 //   var ul = document.createElement("ul");
 var _this = this;
 var ul = $("<ul/>");
 var num = data.length;
 if ((this.options().listlimit > 0) && (this.options().listlimit < num))
 {
 num = this.options().listlimit;
 }
 for (var i = 0; i < num; i++) {
 var row = data[i];
 if (!row) continue;
 var li = document.createElement("li");
 var a = document.createElement("a");

 li.appendChild(a);

 a.innerHTML = row.replace(/,/, "<span>").replace(/$/, "</span>");
 // li.selectValue = row[0];


 ul[0].appendChild(li);

 */
/* $(li).hover(
 function() {
 $("li", ul).removeClass(this._setClassName("S"));
 $(this).addClass(this._setClassName("S"));
 $("li", ul).each(function(index, domEle)
 {
 if ($(domEle).hasClass(this._setClassName("S")))
 {
 _this.active = index;
 return false;
 }
 })
 },
 function() {
 $(this).removeClass(this._setClassName("S"));
 }).click(function(e) {
 e.preventDefault();
 e.stopPropagation();
 _this._selectItem(this)
 });*/
/*

 }
 */
/*ul.mousedown(function() {
 _this.mouseDownOnSelect = true;
 }).mouseup(function() {
 _this.mouseDownOnSelect = false;
 });*/
/*
 return ul[0];
 };*/


/**
 * qcache
 * @param q
 */
KStdSuggest.prototype._loadFromCache = function (q)
{
    if (!q) {
        return null;
    }

    /*    if (this.cache.data[q]) {
     //        return $(this.cache.data[q]).removeClass(this._setClassName("S")).toArray();
     return this.cache.data[q];
     }
     return null;*/
    return  this.cache.data[q] ? this.cache.data[q] : null;

};

/**
 * 
 * @param q
 * @param data
 */
KStdSuggest.prototype._addToCache = function (q, data)
{

    if (!data || !q || ! this.options().cachelimit || this.cache[q]) return;
    if (!this.cache.length || this.cache.length < this.options().cachelimit) {
        //  this.clearCache();
        this.cache.length++;
    } else {
        delete  this.cache.data[this.cacheKeyArr[0]];
        this.cacheKeyArr = this.cacheKeyArr.slice(1);
    }

    this.cache.data[q] = data;
    this.cacheKeyArr.push(q);
};

/**
 * suggest
 * @param textbox    Node 
 * @param   opts KSuggestOptions 
 */
KStdSuggest._bind = function(textbox, opts)
{

    //    new KStdSuggest(textbox, opts);
    //   var kss=new KStdSuggest(textbox, opts);
    return new KStdSuggest(textbox, opts);


};


/**
 * suggest
 * @param textboxs   Node[]   
 * @param   opts KSuggestOptions 
 * @uncrunch
 */
KStdSuggest.bind = function(textboxs, opts)
{
    var kssArr = [];
    //textboxs
    if (textboxs && textboxs.constructor === window.Array)
    {
        for (var i = 0; i < textboxs.length; i++)
        {
            kssArr.push(KStdSuggest._bind(textboxs[i], opts));
        }

    }
    //textboxsjquery
    else if (textboxs && textboxs.jquery)
    {
        textboxs.each(function(i) {
            kssArr.push(KStdSuggest._bind(textboxs.eq(i), opts));
        });
    }
    else
    {
        kssArr.push(KStdSuggest._bind(textboxs, opts));
    }
    return kssArr;

};
/*
 
 pengkun gongyong
 1.0
 2010-01-22
 2010-02-22 16:37
 ============================================
 
 opt# 1010251433
 initlizekvalue
 opt#1011021023
 cssclassName
 opt#1012011744
 IE6layout()
 */

var KStdTabs = KClass.create("KStdTabs", KTabs);
KStdTabs.conf =
{
    CLASSNAME :
    {
        //div
        A : "_stb_a"
        // ul 
        ,US : "_stb_us"
        // li 
        ,S : "_stb_s"
        //div
        ,C : "_stb_c"
        // li 
        ,CF : "_stb_cf"
    }
};
/**
 * 
 * @param container Node
 * @param opts KStdTabsOptions
 * @uncrunch
 */
KStdTabs.initialize = function(container, opts)
{
    var _this = this;
    //ie6;contentDomhideshow
    _this._isIE6 = ($.browser.msie && parseInt($.browser.version, 10) < 7);
    //Dom
    this._dom = $(container).get(0);

    //this._opts = KTools.copyOptions(opts, KStdTabsOptions);
    //this.setTheme(this.options().theme);
    _this._opts = {};
	_this.setOptions(KTools.copyOptions(opts, KStdTabsOptions));
    //
    this._tabs = [];
    this._current = null;

    this.headContainer = $(">ul:eq(0)", this._jdom()).eq(0);

    this.contentContainer = this._jdom();
    if (!this.options().userstyle)
    {
        this.headContainer.addClass(this.theme() + KStdTabs.conf.CLASSNAME.US);
        this.contentContainer.addClass(this.theme() + KStdTabs.conf.CLASSNAME.A);
    }
    this.headContainer.children().each(function(i) {
		var jq_this = $(this);
		_this.insert( {
			index : null,
			text : jq_this.attr("text"),
			kvalue : jq_this.attr("kvalue"),
			url : jq_this.attr("url"),
			once : jq_this.attr("once") == "false" ? false : true,
			content : null,
			tabDom : jq_this,
			contentDom : null
		});
	});
  
	if (this.length() > 0) {
		this.select(this.tabs()[0]);
	}
};

/**
 * 
 * 
 * @return String 
 * @uncrunch
 */
KStdTabs.prototype.version = function()
{
    return "1.0.2";
};

/**
 * 
 * @return String
 * @uncrunch
 */
KStdTabs.prototype.cnname = function()
{
    //\u6807\u51c6\u9009\u9879\u5361\u7ec4\u4ef6
    return "";
};

/**
 * 
 * @return KObject[]
 * @uncrunch
 */
KStdTabs.prototype.dependent = function()
{
    return [KClass,KEvent,KObject,KStdTabsOptions,KTabItem,KTabs,KTools,KWidget,jQuery];
};

/**
 * item.indexitemindex
 * @param item KTabItem
 * @uncrunch
 */
KStdTabs.prototype.insert = function(item)
{
    var _this = this;

    var index = typeof item.index == "number" ? item.index : this._tabs.length;
    index = Math.min(this._tabs.length, Math.max(0, index));
    item.index = index;

    if (index >= this.length())
    {
        this._tabs.push(item);
    }
    else
    {
        this._tabs = $.map(this._tabs, function(obj, i) {
            if (i == index)
            {
                return [item, obj];
            }
            else
            {
                return obj;
            }
        });
    }

    this._index();
    var tabDom = null;
    var contentDom = null;
    //    var isLoad = false;
    if (!item.tabDom)
    {
        tabDom = this.getHeadDom(item);
        contentDom = this.getContentDom(item);
    }
    else
    {
        tabDom = $(item.tabDom);
    }

    var url = item.url;
    if (url)
    {
        if (!this.isAjax(item))
        {
            contentDom = $(url);
        }
        else
        {
            contentDom = this.getContentDom(item);
        }
    }
    else
    {
        contentDom = this.getContentDom(item);
    }

    this._addContentDomStyle(contentDom);

    this._setItemExtend(item, {
        tabDom : tabDom
        ,contentDom : contentDom
        ,isLoad : false
    });

    if (this.headContainer.children().length == 0)
    {
        this.headContainer.append(tabDom);
        this.contentContainer.append(contentDom);
    }
    else
    {
        if (this.headContainer.children().eq(Math.max(index - 1, 0)).get(0) != tabDom.get(0))
        {
            if (index > 0)
            {
                this.headContainer.children().eq(Math.max(index - 1, 0)).after(tabDom);
            }
            else
            {
                this.headContainer.children().eq(Math.max(index - 1, 0)).before(tabDom);
            }
        }

        if (this.contentContainer.children("div").eq(Math.max(index - 1, 0)).get(0) != contentDom.get(0))
        {
            if (index > 0)
            {
                this.contentContainer.children("div").eq(Math.max(index - 1, 0)).after(contentDom);
            }
            else
            {
                this.contentContainer.children("div").eq(Math.max(index - 1, 0)).before(contentDom);
            }
        }
    }

    tabDom.bind("click", function(event) {
        _this.select(item);
    });

    if (item.selected) {
        this.select(item);
    }
};

/**
 * index
 * @param index Integer
 * @uncrunch
 */
KStdTabs.prototype.remove = function(index)
{
    if (typeof index == "undefined")
    {
        this.clear();
        return;
    }
    var item = this._getItemByParam(index);
    if (item)
    {
        this._tabs = $.grep(this._tabs, function(obj, i) {
            return obj == item;
        }, true);

        if (this.current() == item)
        {
            this._current = null;
        }

        this._delItemExtend(item);

        this._index();
    }
};


/**
 * 
 * 
 * @param scheme
 * @uncrunch
 */
KStdTabs.prototype.setTheme = function(scheme) {
	var _this = this;
	var oldTheme = _this._theme;
	if (typeof _this._opts.userstyle !== "boolean") {
		_this._opts.userstyle = false;
	}
	if (_this._opts.userstyle === true || oldTheme === scheme) {
		return;
	}
	if (typeof _this._theme !== "string") {
		_this._theme = "mwp";
		_this._opts.theme = "mwp";
	}
	
	var klass = KStdTabs.conf.CLASSNAME;
	if (_this.headContainer) {
		_this.headContainer.removeClass(oldTheme + klass.US).addClass(scheme + klass.US).removeClass(
				oldTheme + klass.CF).addClass(scheme + klass.CF);
	}
	if (_this.contentContainer) {
		_this.contentContainer.removeClass(oldTheme + klass.A).addClass(scheme + klass.A);
	}
	var len = _this.length();
	var item = null;
	for ( var i = 0; i < len; i++) {
		item = _this._getItemByParam(i);
		if (_this._current && i == _this._current.index) {
			item.tabDom.removeClass(oldTheme + klass.S).addClass(scheme + klass.S);
		} else {
			item.tabDom.removeClass(oldTheme + klass.CF).addClass(scheme + klass.CF);
		}

		item.contentDom.removeClass(oldTheme + klass.C).addClass(scheme + klass.C);
	}
	_this._theme = scheme;
	_this._opts.theme = scheme;
};


/**
 * 
 * 
 * @param index
 *            Integer
 * @uncrunch
 */
KStdTabs.prototype.hideTab = function(index)
{
    var item = this._getItemByParam(index);
    if (item)
    {
        if (this._isHide(item)) {
            return;
        }

        var itemExtend = this._getItemExtend(item);
        itemExtend.tabDom.hide();
        this._hideContentDom(itemExtend.contentDom);

        if (this.current() == item) {
            for (var i = 0; i < this.length(); i++) {
                if (!this._isHide(i)) {
                    this.select(i);
                    break;
                }
            }
        }
    }
};

/**
 * 
 * @param index Integer
 * @uncrunch
 */
KStdTabs.prototype.showTab = function(index)
{
    var item = this._getItemByParam(index);
    if (item)
    {
        var itemExtend = this._getItemExtend(item);
        itemExtend.tabDom.show();
        if(this.current()===item){
        	this._showContentDom(itemExtend.contentDom);
        }
    }
};
/**
 * 
 * @param index Integer
 * @uncrunch
 */
KStdTabs.prototype.unselect = function(index)
{
    var item = this._getItemByParam(index);
    if (!item) return;
    var itemExtend = this._getItemExtend(item);
    this._hideContentDom(itemExtend.contentDom);
    if (this.current() == item)
    {
        this._current = null;
    }

    //className begin
    if (!this.options().userstyle)
    {
        itemExtend.tabDom.removeClass(this.theme() + KStdTabs.conf.CLASSNAME.S).removeClass(
				this.theme() + KStdTabs.conf.CLASSNAME.CF).addClass(this.theme() + KStdTabs.conf.CLASSNAME.CF);
    }
    // className end
};

/**
 * 
 * 
 * @param index
 *            Integer
 * @uncrunch
 */
KStdTabs.prototype.select = function(index)
{
    var item = this._getItemByParam(index);
    if (!item) return;

    if (item.url == "fun") {
        KEvent.trigger(this, "funtab", this, item);
        return;
    }

    if (this._isHide(item)) {
        this.showTab(item);
    }

    if (item == this.current())
    {
        if (this.current() && this.options().collapse)
        {
            this.unselect(this.current());
        }
        return;
    }

    var oldItem = this.current();
    if (this.current())
    {
        this.unselect(this.current());
    }
    var itemExtend = this._getItemExtend(item);
    this._addContentDom(itemExtend);
    var len= this.length();
    if (typeof index !== "number") {
		index = index.index;
	}
    for ( var i = 0; i < len; i++) {
		if (i !== index) {
			this._hideContentDom(this._getItemByParam(i).contentDom);
		}
	}
	this._showContentDom(itemExtend.contentDom);

    this._current = item;
    //className begin
    if (!this.options().userstyle)
    {
        var className = this.theme() + KStdTabs.conf.CLASSNAME.S;
        itemExtend.tabDom.removeClass(this.theme() + KStdTabs.conf.CLASSNAME.CF).removeClass(className).addClass(
				className);
    }
    // className end


    KEvent.trigger(this, "selected", this, oldItem, item);
};
/**
 * headDom
 * @param item KTabItem
 * @return jQuery
 */
KStdTabs.prototype.getHeadDom = function(item)
{	
    //return $("<li/>").html(item.text);
	return $("<li/>").html('<a href="javascript:void(0)">'+item.text+'</a>');
};
/**
 * contentDom
 * @param item KTabItem
 * @return jQuery
 */
KStdTabs.prototype.getContentDom = function(item)
{
    return $("<div/>").html(item.content || "").hide();
};
/**
 * item
 */
KStdTabs.prototype.clear = function()
{
    for (var i = 0; i < this._tabs.length; i++)
    {
        this._delItemExtend(this._tabs[i]);
        this._tabs[i] = undefined;
    }
    this._current = null;
    this._tabs.length = 0;
};
/**
 * 
 * @param item KTabItem
 * @return Boolean
 */
KStdTabs.prototype.isAjax = function(item)
{
    if (item.url)
    {
        return new RegExp("^[^#]", "g").test(item.url);
    }
    else
    {
        return false;
    }
};
/**
 * itemitemindex
 * @param item KTabItem
 * @return Boolean
 */
KStdTabs.prototype.getIndexByItem = function(item)
{
    for (var i = 0; i < this._tabs.length; i++)
    {
        if (item == this._tabs[i])
        {
            return i;
        }
    }
    return -1;
};
/**
 * itemobject
 * @param item KTabItem
 * @param itemExtend Object
 */
KStdTabs.prototype._setItemExtend = function(item, itemExtend)
{
    $.extend(item, itemExtend);
};
/**
 * itemobject
 * @param item KTabItem
 * @return KTabItem
 */
KStdTabs.prototype._getItemExtend = function(item)
{
    return item;
};
/**
 * itemobject
 * @param item KTabItem
 */
KStdTabs.prototype._delItemExtend = function(item)
{
    var itemExtend = this._getItemExtend(item);
    if (itemExtend)
    {
        itemExtend.tabDom.remove();
        itemExtend.tabDom = undefined;
        itemExtend.contentDom.remove();
        itemExtend.contentDom = undefined;
    }
    itemExtend = undefined;
};
/**
 * 
 */
KStdTabs.prototype._index = function()
{
    //
    $.each(this._tabs, function(i, item) {
        item.index = i;
    });
};
/**
 * Item
 * @param item KTabItem
 * @return KTabItem
 */
KStdTabs.prototype.getNextItem = function(item)
{
    var index = this.getIndexByItem(item) + 1;
    if (index >= this.tabs().length)
    {
        index = 0;
    }
    return this.tabs()[index];
};
KStdTabs.prototype._getItemByParam = function(index)
{
    if (typeof index == "number")
    {
        return this.tabs()[index];
    }
    else if (typeof index == "object")
    {
        return index;
    }
    return null;
};

/**
 * 
 * @param opts KStdTabsOptions
 * @uncrunch
 */
KStdTabs.prototype.setOptions = function(opts)
{
    var _this = this;
	opts = KTools.copyOptions(opts, _this._opts);
	var diffOpts = KTools.compareOptions(this._opts, opts);
	$.each(diffOpts, function(name, value) {
		if (name === 'userstyle') {
			_this._setUserStyle(value);
		} else if (name === 'theme') {
			_this.setTheme(value);
		} else if (name === 'collapse') {
			(typeof value === "boolean") && (_this._opts.collapse = value);
		}
	});
};


KStdTabs.prototype._setUserStyle = function(bStyle) {
	var _this = this;
	if (typeof bStyle !== "boolean") {
		return;
	}
	if (bStyle === true) {
		var oldTheme = _this._theme || "mwp";
		var klass = KStdTabs.conf.CLASSNAME;
		var len = _this.length();
		var item = null;
		//
		if (_this.headContainer) {
			_this.headContainer.removeClass(oldTheme + klass.US).removeClass(oldTheme + klass.CF);
		}
		if (_this.contentContainer) {
			_this.contentContainer.removeClass(oldTheme + klass.A);
		}

		for ( var i = 0; i < _this.length(); i++) {
			item = _this._getItemByParam(i);
			if (_this._current && i == _this._current.index) {
				item.tabDom.removeClass(oldTheme + klass.S);
			} else {
				item.tabDom.removeClass(oldTheme + klass.CF);
			}
			item.contentDom.removeClass(oldTheme + klass.C);
		}

		_this._opts.theme = null;
		_this._theme = null;
	}
	_this._opts.userstyle = bStyle;
};

/**
 * 
 * 
 * @uncrunch
 */
KStdTabs.prototype.finalize = function()
{
    KWidget.prototype.finalize.apply(this);
};
/**
 *
 * 
 * @uncrunch
 */
KStdTabs.prototype.layout = function()
{
    var height = this._jdom().parent().outerHeight();
    /******/
    if(KTools.isIE6){
    	var temp  = parseInt(this._jdom().parent().css("height"), 10);
    	if(!isNaN(temp) || temp>0){
    		height = temp;
    	}
    }
    /******/
    var p_b = (this._jdom().outerHeight() - this._jdom().height());
    this._jdom().height(height - p_b);
    var j_b = (this._jdom().outerHeight() - this._jdom().height());
    var h = height - j_b - this.headContainer.outerHeight();
    var current = this.current();
    var border = (current.contentDom.outerHeight()-current.contentDom.height());
    var z_height = h - border;
    var tabs = this.tabs();
    for(var i = 0;i<tabs.length;i++){
        tabs[i].contentDom.height(z_height);
    }
    
};

KStdTabs.prototype._isHide = function(index)
{
    var item;
    if (typeof index == "number") {
        item = this._getItemByParam(index);
    }
    else if (typeof index == "object") {
        item = index;
    }
    else {
        return false;
    }

    if (item.tabDom.css("display") == "none" && item.contentDom.css("display") == "none") {
        return true;
    }
    return false;
};

KStdTabs.prototype._jdom = function()
{
    if (this._dom) {
        return $(this._dom);
    }
};

KStdTabs.prototype._addContentDom = function(item)
{
    var _this = this;
    if(this.isAjax(item)){
        //; 
        if(!item.isLoad||!item.once){
            $.ajax({
                url : item.url
                ,type : 'GET'
                ,cache:false
                ,dataType : 'html'
                ,success : function(data){
            		_this._addDataLoadedEvent(item,data);
                    item.contentDom.empty().append(data);
                    _this._addDataShownEvent(data, item.contentDom);
                }
            });
            //
            if(!item.isLoad){
            	item.isLoad = true;
            }
        }
        /*/
        else if(!item.once){
            $.ajax({
                url : item.url
                ,type : 'GET'
                ,cache:false
                ,dataType : 'html'
                ,success : function(data){
            		_this._addDataLoadedEvent(item,data);
                    item.contentDom.empty().append(data);
                    _this._addDataShownEvent(data, item.contentDom);
                }
            });
        }*/
    }
};

KStdTabs.prototype._addContentDomStyle = function(contentDom) {
    //className begin
    if (!this.options().userstyle)
    {
        contentDom.addClass(this.theme() + KStdTabs.conf.CLASSNAME.C);
    }
    //className end
};


KStdTabs.prototype._addDataShownEvent = function(data,contentDom) {
    KEvent.trigger(this, "datashown", this, data, contentDom[0]);
};
KStdTabs.prototype._addDataLoadedEvent=function(item, data){
	  KEvent.trigger(this, "dataloaded", this, item, data);
};
/**
 * ie6bug, hide, KStdTabsContentDom
 * 
 * @param $dom
 *            jQuerydom
 * @returns
 */
KStdTabs.prototype._hideContentDom = function($dom) {
	$dom.hide();
	if (this._isIE6) {
		$dom.css( {
			"visibility" : "hidden"
		});
	}
};
/**
 * ie6bug, showKStdTabsContentDom
 * 
 * @param $dom
 *            jQuerydom
 * @returns
 */
KStdTabs.prototype._showContentDom = function($dom) {
	$dom.show();
	if (this._isIE6) {
		$dom.css( {
			"visibility" : "visible"
		});
	}
};
/* 
 
 */
    /**
	 * options 
	 */
	//options_link_start
	KMapOptions.overview = KMapCtrlState.NORMAL;//KMapOptions KMapCtrlState
	KMapOptions.fishbone = KMapCtrlState.NORMAL;//KMapOptions KMapCtrlState
	KSearchboxOptions.demopos = KPosition.BOTTOM;//KSearchboxOptions KPosition
	if (typeof DEFAULT_MAX_ZOOM_LEVEL != 'undefined'){KDirMarkOptions.minlevel = DEFAULT_MAX_ZOOM_LEVEL - 2;KDirMarkOptions.maxlevel = DEFAULT_MAX_ZOOM_LEVEL;}//KDirMarkOptions
	KLabelOptions.pos = KPosition.RIGHT;//KLabelOptions KPosition
	if (typeof MPoint != 'undefined') KMapOptions.center = new MPoint("\u5317\u4eac\u5e02");//KMapOptions
	KSendOptions.sendtype = KSendType.all;//KSendOptions KSendType
	KDirMarkStyleOptions.size = KBrushOptions.width * 4;//KDirMarkStyleOptions KBrushOptions
	KDirMarkStyleOptions.transparency = KBrushOptions.transparency;//KDirMarkStyleOptions KBrushOptions
    KPOInfo.type = KPOIType.NORMAL;//KPOInfo KPOIType
	KLineOptions.brush = $.extend({}, KBrushOptions);//KLineOptions
	KLineOptions.hiliteBrush = $.extend({color:'#00ff00',bgcolor:'#00ff00'}, KBrushOptions);//KLineOptions //KBrushOptions
	KAreaOptions.brush = KLineOptions.brush;//KAreaOptions KLineOptions
	KAreaOptions.hiliteBrush = KLineOptions.hiliteBrush;//KAreaOptions KLineOptions
    KDialogOpenOptions.pos = KDialogOptions.dragrange;//KDialogOpenOptions KDialogOptions
	KFeedbackInfo.type = KFeedbackType.POI_ERROR;//KFeedbackType KFeedbackInfo
	KFeedbackInfo.errortype = KFBErrorType.INFO;//KFBErrorType KFeedbackInfo
    //options_link_end
	
	
	if(typeof KConfig != "undefined")
    {
		KConfig.set("PROXY", "");
		KConfig.set("DEFAULT_ICON", $.extend({}, KIconOptions));//KIconOptions
		KConfig.set("DEFAULT_LABEL", $.extend({}, KLabelOptions));//KLabelOptions
		KConfig.set("INFOWINDOW_SIZE", new KSize(100, 100));//KSize
		KConfig.set("LINE_BRUSH", KLineOptions.brush);//KLineOptions
		KConfig.set("LINE_HILITE_BRUSH", KLineOptions.hiliteBrush);//KLineOptions
		KConfig.set("COOKIE", $.extend({}, KCookieOptions));//KCookieOptions
		KConfig.set("LISTENER_INTERVAL", 200);

        //opt# 1009281140 fix begin
        //add by panx
        KConfig.set("mwpf", "wf");
        //opt# 1009281140 fix end

		//
        KConfig.set("iw_cm", '<div class="mwpg_i" style="width:370px;"><div class="mwpg_ic"></div><div class="mwpg_iw" id = "infowin_cm"><div><ul><li><a href="javascript:void(0);"></a></li><li><a href="javascript:void(0);"></a></li><li class="mwpg_iw_s"><a href="javascript:void(0);"></a></li></ul><div class="mwpg_iw_c"><form onsubmit="return false;"><em></em><input class="mwpg_iw_kw mwpg_iw_kw_to" type="text" /><input class="mwpg_iw_sm" type="button" value="" /><input class="mwpg_iw_sm" type="button" value="" /></form></div><div class="mwpg_iw_c"><form onsubmit="return false;"><em></em><input class="mwpg_iw_kw mwpg_iw_kw_from" type="text" /> <input class="mwpg_iw_sm" type="button" value="" /><input class="mwpg_iw_sm" type="button" value="" /></form></div><div class="mwpg_iw_c mwpg_iw_cs"><form><em></em><input class="mwpg_iw_kw mwpg_iw_kw_nb" type="text" /> <input class="mwpg_iw_sm" type="submit" value="" /></form></div></div><div style="height:25px;"></div></div></div>');

        //POI
        KConfig.set("iw_iwo_poi", {
        	content:'<div class="mwpg_poiw_ca"><div class="mwpg_poiw_caI"><img mfg="pic"/></div><div class="mwpg_poiw_caW">[pr]<p>[c]</p><p>[d]</p>[e]<div class="mwpg_poiw_caV"><a href="javascript:void(0);"  mfg="fs"></a><span>\|</span><a href="javascript:void(0);" mfg="xlwb"></a><span>\|</span><a href="javascript:void(0);" mfg="tbsc"></a><span>\|</span><a href="javascript:void(0);" mfg="err"></a></div><div id="google_ads" style="height:0px;"></div></div></div>'
//            content:'<div class="mwpg_poiw_ca"><div class="mwpg_poiw_caI"><img mfg="pic"/></div><div class="mwpg_poiw_caW">[pr]<p>[c]</p><p>[d]</p>[e]<div class="mwpg_poiw_caV"><a href="javascript:void(0);"  mfg="fs"></a><span>\|</span><a href="javascript:void(0);" mfg="xlwb"></a><span>\|</span><a href="javascript:void(0);" mfg="tbsc"></a><span>\|</span><a href="javascript:void(0);" mfg="err"></a><a target="_blank" mfg="djd" href="[djdurl]" style="display:[djd]" class="mwp_iw_oh"></a><a target="_blank" mfg="djp" href="[djpurl]" style="display:[djp]" class="mwp_iw_ot"></a><a target="_blank" mfg="shrl" href="http://s.mapbar.com/nMVDOax" class="mwp_iw_ot" ></a></div><div id="google_ads" style="height:0px;"></div><div class="mwp_ls_a_hotel_tip"><span>400-890-9817</span>7X24</div></div></div>'
        });
       //POI,poi
        KConfig.set("iw_iwo_poi_detail", {
        	content:'<div class="mwpg_poiw_ca"><div class="mwpg_poiw_caI"><img mfg="pic"/></div><div class="mwpg_poiw_caW">[pr]<p>[c]</p><p>[d]</p>[e]<div class="mwpg_poiw_caV"><a href="javascript:void(0);"  mfg="fs"></a><span>\|</span><a href="javascript:void(0);" mfg="xlwb"></a><span>\|</span><a href="javascript:void(0);" mfg="tbsc"></a><span>\|</span><a href="javascript:void(0);" mfg="err"></a></div><div mfg="poid" style="height:170px;" class="mwp_subPop_box">[poi_detail]</div><div id="google_ads" style="height:0px;"></div></div></div>'
        });
		//POI
		KConfig.set("iw_iwo_hotel", {
			content:'<div class="mwpg_poiw_ca"><div class="mwpg_poiw_caI" style="width:93px;height:70px;"><img mfg="pic" width="93" height="70" style="width:93px;height:70px;display:none;"/></div><div class="mwpg_poiw_caW"><p>[c]<br/>[d]</p><div class="mwpg_poiw_caV"><a href="javascript:void(0);"  mfg="fs"></a><span>\|</span><a href="javascript:void(0);" mfg="xlwb"></a><span>\|</span><a href="javascript:void(0);" mfg="tbsc"></a><span>\|</span><a href="javascript:void(0);" mfg="err"></a></div></div></div><div mfg="hotel" class="mwpg_poiw_h">[hotel]</div><div style="display:[ad_v]" class="mwpg_poiw_h_AD"><b></b><span>[ad]</span></div>'
        });
		
		//
		KConfig.set("iw_iwo_gasoline", {
			content:'<div class="mwpg_poiw_ca"><div class="mwpg_poiw_caI" style="width:93px;height:10px;"><img mfg="pic" width="93" height="70" style="width:93px;height:70px;display:none;"/></div><div class="mwpg_poiw_caW"><p>[c]<br/>[d]</p></div></div><div mfg="ylprice" class="mwpg_poiw_lyp">[hotel]</div>'
			
		});
		
		//
        KConfig.set("iw_iwo_wk", {
            content:'<div class="mwpg_mkiw_ia" style="height:148px;"><img mfg="pic" style="height:148px;display:none;" /></div><div class="mwpg_mkiw_da"><p>[t]</p><div class="mwpg_mkiw_oa"><a class="mwpg_mkiw_pre" href="javascript:void(0);" mfg="prev"></a><a class="mwpg_mkiw_nxt" href="javascript:void(0);" mfg="next"></a></div></div>'
        });
		//
        KConfig.set("iw_iwo_st", {
        	content:'<div class="mwpg_btiw_ca"><div class="mwpg_btiw_caI"><img mfg="pic" width="70" height="70" style="margin:0;padding:0;display:none"/></div><div class="mwpg_btiw_caW"><p style="display:[cd]">[c]<br/>[d]</p><dl><p><a mfg="bl" href="[h]" target="_blank" style="display:[v]"></a></p></dl><div class="mwpg_btiw_caO"><a href="javascript:void(0);" mfg="fs" style="display:[fs]"><b class="mwpg_ic_oS"><span></span></b></a><a href="javascript:void(0);" mfg="err" style="display:[err]"><b class="mwpg_ic_oC"><span></span></b></a></div><div class="mwpg_btiw_c mwpg_btiw_cs" style="display:[nb]" mfg="nb"><form onsubmit="javascript:return false;"><input class="mwpg_btiw_kw" style="width:188px;" type="text" /><input class="mwpg_btiw_sm" type="submit" value="" /></form><p class="mwpg_btiw_sh"><span></span><a href="javascript:void(0);"></a>&nbsp;<a href="javascript:void(0);"></a>&nbsp;<a href="javascript:void(0);"></a>&nbsp;<a href="javascript:void(0);"></a>&nbsp;<a href="javascript:void(0);"></a>&nbsp;<a href="javascript:void(0);"></a></p></div></div></div>'
        });

		// 
        KConfig.set('map_s_ct', '<div class="mwpg_map_ct">[n]</div>');
 		//
        KConfig.set("mk_s_sns", 'http://img.mapbar.com/web/3in1/icons/[h]n[a].png');
		//1-10
        KConfig.set("mk_mo_sn", {
            icon : {img:'<div class="mwpg_sn mwpg_snnc[a]"><span></span></div>',shadow : '<div class="mwpg_sn_s"><span></span></div>',size : new KSize(27,36),anchor : new KPoint(12,38),shadowSize : new KSize(20,12), snapIcon:KConfig.get("mk_s_sns", {h:""})}
        });
		//
        KConfig.set("mk_s_snn", 'mwpg_sn mwpg_snnc[a]');
		//
        KConfig.set("mk_s_snh", 'mwpg_sn mwpg_snhc[a]');
        
        
        
        
       //
        KConfig.set("mk_s_snstg", 'http://img.mapbar.com/web/3in1/icons/[h]n[a].png');
        //1-10
        KConfig.set("mk_mo_sntg", {
            icon : {img:'<div class="mwpg_sntg mwpg_sntgnc[a]"><span></span></div>',shadow : '<div class="mwpg_sn_s"><span></span></div>',size : new KSize(27,36),anchor : new KPoint(12,38),shadowSize : new KSize(20,12), snapIcon:KConfig.get("mk_s_snstg", {h:""})}
        });
		//
        KConfig.set("mk_s_snntg", 'mwpg_sntg mwpg_sntgnc[a]');
		//
        KConfig.set("mk_s_snhtg", 'mwpg_sn mwpg_sntghc[a]');
        
        
        
		//
        KConfig.set("mk_mo_ct", {
        	icon:{img:'<div class="mwpg_ct"><span></span></div>',size : new KSize(26,30),anchor : new KPoint(13,26),snapIcon:'http://img.mapbar.com/web/3in1/icons/cp.png'}
        });
        
      //
        KConfig.set("mk_mo_mnct", {
            icon:{img:'<div class="mwpg_ct"><span></span></div>',size : new KSize(26,30),anchor : new KPoint(13,26),snapIcon:'http://img.mapbar.com/web/3in1/icons/cp.png'}
        });
        
		//,
        KConfig.set("mk_s_sdts", 'http://img.mapbar.com/web/3in1/icons/[t]p.png');
		//()
        KConfig.set("mk_mo_sdt", {
            icon : {img:'<div class="mwpg_std_[t]"><span></span></div>',shadow : '<div class="mwpg_std_sd"><span></span></div>',size : new KSize(25,33),anchor : new KPoint(12.5,33),shadowSize : new KSize(20,12),snapIcon:KConfig.get("mk_s_sdts")}
            ,label:{label:'<div class="mwpg_std_[t]l" mfg="lbl">[n]</div>',anchor : new KPoint(30,2)}
        });
		//,
        KConfig.set("mk_s_sdtn", 'mwpg_std_[t]');
		//
        KConfig.set("mk_s_sdtln", 'mwpg_std_[t]l');
		//()
        KConfig.set("mk_mo_sd", {
            icon:{img:'<div class="mwpg_sd_[t]"><span></span></div>', size : new KSize(23,32),anchor : new KPoint(11.5,30),snapIcon:'http://img.mapbar.com/web/3in1/icons/[t]pl.png'}
        });
		//
        KConfig.set("mk_mo_s", {
            icon:{img:'<div class="mwpg_s_w"></div>', size : new KSize(10,10),anchor : new KPoint(5,5),snapIcon:'http://img.mapbar.com/web/3in1/icons/swp.png'}
            ,label:{label:'<div class="mwpg_s_wl"><div class="mwpg_s"><div class="mwpg_s_i[t]"></div><div class="mwpg_s_s">[n]</div></div></div>', anchor : new KPoint(8, -26)}
        });
        
      //
        KConfig.set("mk_mo_lss", {
            icon:{img:'<div class="mwpg_s_w"></div>', size : new KSize(10,10),anchor : new KPoint(5,5),snapIcon:'http://img.mapbar.com/web/3in1/icons/swp.png'}
        });
        
		//
        KConfig.set("mk_s_sw", 'mwpg_s_w');
		//
        KConfig.set("mk_s_sh", 'mwpg_s_w mwpg_s_h');
		//
        KConfig.set("mk_mo_bs", {
            icon:{img:'<div class="mwpg_bs_t"><span></span></div>', size : new KSize(20,20),anchor : new KPoint(10,10),snapIcon:'http://img.mapbar.com/web/3in1/icons/tp.png'}
        });
		//
        KConfig.set("mk_mo_m", {
            icon:{img:'<div class="mwpg_m"><span></span></div>', size : new KSize(11,11),anchor : new KPoint(5.5,5.5),snapIcon:'http://img.mapbar.com/web/3in1/icons/nwp.png'}
            ,label:{label:'<div class="mwpg_m_l"><div class="mwpg_m_lc"><span mfg="lbl">[n]</span><a href="javascript:void(0);" title="" mfg="ncc"></a></div></div>', anchor : new KPoint(9, -26)}
            ,bouncy : false
        });
		//20x20
        KConfig.set("mk_mo_20", {
            icon:{img:'<div class="mwpg_20"><span class="mwpg_20_[t]"></span></div>',size : new KSize(20,20),anchor : new KPoint(10,10),snapIcon:'http://img.mapbar.com/web/3in1/icons/[t].png'}
            ,label:{label:'<div class="mwpg_20_l" mfg="lbl">[n]</div>', anchor : new KPoint(20, 1)}
            ,hoverLabel:true
        });

		//	 
        KConfig.set("ln_lo_bss", {
            brush:{color:"#0000ff", overlap:true, width:5, transparency:80}
            ,hiliteBrush:{color:"#ff0000", overlap:true, width:6, transparency:80}
        });
		// 
        KConfig.set("ln_lo_bsl", {
            brush:{color:"#0000ff", overlap:true, width:5, transparency:80}
        });
		// 
        KConfig.set("ln_lo_bst", {
            brush:{color:"#0000ff", overlap:true, width:5, transparency:80}
        });
		// 
        KConfig.set("ln_lo_navs", {
            brush:{color:"#0000ff", overlap:true, width:6, transparency:80}
            ,hiliteBrush:{color:"#ff0000", overlap:true, width:6, transparency:80}
        });
		// 
        KConfig.set("ln_lo_navd", {
            brush:{color:"#00FF00", overlap:true, width:5, transparency:80}
        });
		//
		KConfig.set("ln_lo_wk", {
            brush:{color:"#cc00ff", overlap:true, width:5, transparency:80}
        });
		//
		KConfig.set("ln_lo_gray", {
			brush:{color:"#969495", overlap:true, width:5, transparency:80}
		});
		//added by zy, 
		KConfig.set("ln_lo_subWalk", {
			brush:{color:"#cc00ff", overlap:true, width:6, dashed : true, transparency:80}
		});
		//
		KConfig.set("mk_mo_mm", {
            icon:{img:'<div class="mwpg_mm_[row][col]"></div>', size : new KSize(18,25),anchor : new KPoint(10,26)}
        });
        
		/** - **/
		//infowin
		KConfig.set("iw_iwo_mmp", {
			content:'<div class="mwpg_mm"><div mfg="ep"><div class="mwpg_mm_ec"><table><tbody><tr><th></th><td><input mfg="ep_t" class="mwpg_mm_it" type="text" /><span>18</span></td><td><a mfg="ep_l" class="mwpg_mm_bss" href="javascript:void(0);" title=""><div class="mwpg_mm_11"></div></a></td></tr><tr><th></th><td colspan="2"><textarea mfg="ep_i" class="mwpg_mm_ii"></textarea></td></tr><tr style="display:none"><th></th><td colspan="2"><form mfg="ep_frm" enctype="multipart/form-data" method="post"><input name="[ep_frm_fn]" mfg="ep_frm_f" type="file"/><p>png,jpg,jpeg</p><input type="submit" style="display:none;"/></form><div class="mwpg_mm_ui" mfg="ep_p"><img src="" /><a href="javascript:void(0);"></a></div></td></tr></tbody></table></div><div class="mwpg_mm_ea"><input mfg="ep_s" class="mwpg_mm_bs" type="button" value="" /><a mfg="ep_c" class="mwpg_mm_bc" href="javascript:void(0);"></a></div></div><div mfg="df" style="display:none;"><div class="mwpg_mm_i"><div class="mwpg_mm_ip"><img mfg="df_f" src="[df_fs]" /></div><p mfg="df_i"></p></div><div class="mwpg_mm_na"><a mfg="df_e" class="mwpg_mm_be" href="javascript:void(0);"></a><a mfg="df_d" class="mwpg_mm_bd" href="javascript:void(0);"></a></div><div class="mwpg_mm_ims" mfg="de_s"><ul><li><a href="javascript:void(0);"></a></li><li><a href="javascript:void(0);"></a></li><li class="mwpg_mm_is"><a href="javascript:void(0);"></a></li></ul><div class="mwpg_mm_imc"><form><input class="mwpg_mm_kw" style="width:100px;" type="text" /> <input class="mwpg_mm_sm" type="button" value="" /><input class="mwpg_mm_sm" type="button" value="" /></form></div><div class="mwpg_mm_imc"><form><input class="mwpg_mm_kw" style="width:100px;" type="text" /><input class="mwpg_mm_sm" type="button" value="" /><input class="mwpg_mm_sm" type="button" value="" /></form></div><div class="mwpg_mm_imc mwpg_mm_imcs"><form><input class="mwpg_mm_kw" style="width:173px;" type="text" /><input class="mwpg_mm_sm" type="submit" value="" /></form></div></div></div><div mfg="se" style="display:none;"><ul mfg="se_c" class="mwpg_mm_sl"><li><a href="javascript:void(0);"><div class="mwpg_mm_11"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_12"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_13"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_14"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_15"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_16"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_21"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_22"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_23"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_24"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_25"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_26"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_31"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_32"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_33"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_34"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_35"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_36"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_41"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_42"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_43"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_44"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_45"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_46"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_51"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_52"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_53"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_54"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_55"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_56"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_61"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_62"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_63"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_64"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_65"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_66"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_71"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_72"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_73"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_74"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_75"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_76"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_81"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_82"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_83"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_84"></div></a></li></ul><div class="mwpg_mm_sa"><a class="mwpg_mm_br" mfg="se_b" href="javascript:void(0);">&lt;&lt;</a></div></div></div>'
			,cmarea:false
        });
		/** -   flash**/
		//infowin
		KConfig.set("iw_iwo_mmp_swf", {
			content:'<div class="mwpg_mm"><div mfg="ep"><div class="mwpg_mm_ec"><table><tbody><tr><th></th><td><input mfg="ep_t" class="mwpg_mm_it" type="text" /><span>18</span></td><td><a mfg="ep_l" class="mwpg_mm_bss" href="javascript:void(0);" title=""><div class="mwpg_mm_11"></div></a></td></tr><tr><th></th><td colspan="2"><textarea mfg="ep_i" class="mwpg_mm_ii"></textarea></td></tr><tr><th></th><td colspan="2"><span mfg="ep_frm"><input mfg="ep_frm_f" type="button" value=""/><span mfg="ep_frm_fname"></span><p>png,jpg,jpeg</p><input type="submit" style="display:none;"/></span><div class="mwpg_mm_ui" mfg="ep_p"><img src="" /><a href="javascript:void(0);"></a></div></td></tr></tbody></table></div><div class="mwpg_mm_ea"><input mfg="ep_s" class="mwpg_mm_bs" type="button" value="" /><a mfg="ep_c" class="mwpg_mm_bc" href="javascript:void(0);"></a></div></div><div mfg="df" style="display:none;"><div class="mwpg_mm_i"><div class="mwpg_mm_ip"><img mfg="df_f" src="[df_fs]" /></div><p mfg="df_i"></p></div><div class="mwpg_mm_na"><a mfg="df_e" class="mwpg_mm_be" href="javascript:void(0);"></a><a mfg="df_d" class="mwpg_mm_bd" href="javascript:void(0);"></a></div><div class="mwpg_mm_ims" mfg="de_s"><ul><li><a href="javascript:void(0);"></a></li><li><a href="javascript:void(0);"></a></li><li class="mwpg_mm_is"><a href="javascript:void(0);"></a></li></ul><div class="mwpg_mm_imc"><form><input class="mwpg_mm_kw" style="width:100px;" type="text" /> <input class="mwpg_mm_sm" type="button" value="" /><input class="mwpg_mm_sm" type="button" value="" /></form></div><div class="mwpg_mm_imc"><form><input class="mwpg_mm_kw" style="width:100px;" type="text" /><input class="mwpg_mm_sm" type="button" value="" /><input class="mwpg_mm_sm" type="button" value="" /></form></div><div class="mwpg_mm_imc mwpg_mm_imcs"><form><input class="mwpg_mm_kw" style="width:173px;" type="text" /><input class="mwpg_mm_sm" type="submit" value="" /></form></div></div></div><div mfg="se" style="display:none;"><ul mfg="se_c" class="mwpg_mm_sl"><li><a href="javascript:void(0);"><div class="mwpg_mm_11"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_12"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_13"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_14"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_15"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_16"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_21"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_22"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_23"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_24"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_25"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_26"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_31"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_32"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_33"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_34"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_35"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_36"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_41"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_42"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_43"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_44"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_45"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_46"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_51"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_52"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_53"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_54"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_55"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_56"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_61"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_62"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_63"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_64"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_65"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_66"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_71"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_72"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_73"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_74"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_75"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_76"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_81"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_82"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_83"></div></a></li><li><a href="javascript:void(0);"><div class="mwpg_mm_84"></div></a></li></ul><div class="mwpg_mm_sa"><a class="mwpg_mm_br" mfg="se_b" href="javascript:void(0);">&lt;&lt;</a></div></div></div>'
			,cmarea:false
        });

		/** - **/
		//infowin
		KConfig.set("iw_iwo_mml", {
            content:'<div class="mwpg_ml"><div mfg="ep" style="display:none;"><div class="mwpg_ml_ec"><table><tbody><tr><th></th><td><input mfg="ep_t" class="mwpg_ml_it" type="text" /><span>18</span></td><td><a mfg="ep_l" class="mwpg_ml_bss" href="javascript:void(0);" title=""><span style="background-color:#FF0000;opacity:0.6;"></span></a></td></tr><tr><th></th><td colspan="2"><textarea mfg="ep_i" class="mwpg_ml_ii"></textarea></td></tr><tr style="display:none"><th></th><td colspan="2"><form mfg="ep_frm" enctype="multipart/form-data" method="post"><input name="[ep_frm_fn]" mfg="ep_frm_f" type="file" /><p>png,jpg,jpeg</p><input type="submit" style="display:none;"/></form><div class="mwpg_ml_ui" mfg="ep_p"><img src="" /><a href="javascript:void(0);"></a></div></td></tr></tbody></table></div><div class="mwpg_ml_ea"><input mfg="ep_s" class="mwpg_ml_bs" type="button" value="" /><a mfg="ep_c" class="mwpg_ml_bc" href="javascript:void(0);"></a></div></div><div mfg="df"><div class="mwpg_ml_i"><div class="mwpg_ml_ip"><img mfg="df_f" src="[df_fs]" src="" /></div><p mfg="df_i"></p></div><div class="mwpg_ml_na"><a class="mwpg_ml_be" mfg="df_e" href="javascript:void(0);"></a><a class="mwpg_ml_bd" mfg="df_d" href="javascript:void(0);"></a></div><div class="mwpg_ml_l"><strong mfg="df_ds"></strong></div></div><div mfg="se" style="display:none;"><div class="mwpg_ml_sl"><table><tr><th></th><td style="width:215px;"><div class="mwpg_ml_sc"><div mfg="se_c" class="mwpg_ml_sdc"></div><div mfg="se_cp" class="mwpg_ml_cl"></div></div></td><td><div title="" class="mwpg_ml_cs"><span mfg="se_cs" style="background-color:#F00;opacity:0.1;"></span></div></td></tr><tr><th></th><td colspan="2"><input mfg="se_st" type="text" class="mwpg_ml_ilw" maxlength="2" /><span class="mwpg_ml_tip">1-99</span></td></tr><tr><th></th><td colspan="2"><input mfg="se_t" type="text" class="mwpg_ml_ila" maxlength="2" /><span class="mwpg_ml_tip">1-99</span></td></tr></table></div><div class="mwpg_ml_ea"><input mfg="se_s" class="mwpg_ml_bo" type="button" value="" /><a mfg="se_c" class="mwpg_ml_bc" href="javascript:void(0);"></a></div></div></div>'
			,cmarea:false
		});
		/** -   flash**/
		//infowin
		KConfig.set("iw_iwo_mml_swf", {
            content:'<div class="mwpg_ml"><div mfg="ep" style="display:none;"><div class="mwpg_ml_ec"><table><tbody><tr><th></th><td><input mfg="ep_t" class="mwpg_ml_it" type="text" /><span>18</span></td><td><a mfg="ep_l" class="mwpg_ml_bss" href="javascript:void(0);" title=""><span style="background-color:#FF0000;opacity:0.6;"></span></a></td></tr><tr><th></th><td colspan="2"><textarea mfg="ep_i" class="mwpg_ml_ii"></textarea></td></tr><tr><th></th><td colspan="2"><span mfg="ep_frm"><input mfg="ep_frm_f" type="button" value=""/><span mfg="ep_frm_fname"></span><p>png,jpg,jpeg</p><input type="submit" style="display:none;"/></span><div class="mwpg_ml_ui" mfg="ep_p"><img src="" /><a href="javascript:void(0);"></a></div></td></tr></tbody></table></div><div class="mwpg_ml_ea"><input mfg="ep_s" class="mwpg_ml_bs" type="button" value="" /><a mfg="ep_c" class="mwpg_ml_bc" href="javascript:void(0);"></a></div></div><div mfg="df"><div class="mwpg_ml_i"><div class="mwpg_ml_ip"><img mfg="df_f" src="[df_fs]" src="" /></div><p mfg="df_i"></p></div><div class="mwpg_ml_na"><a class="mwpg_ml_be" mfg="df_e" href="javascript:void(0);"></a><a class="mwpg_ml_bd" mfg="df_d" href="javascript:void(0);"></a></div><div class="mwpg_ml_l"><strong mfg="df_ds"></strong></div></div><div mfg="se" style="display:none;"><div class="mwpg_ml_sl"><table><tr><th></th><td style="width:215px;"><div class="mwpg_ml_sc"><div mfg="se_c" class="mwpg_ml_sdc"></div><div mfg="se_cp" class="mwpg_ml_cl"></div></div></td><td><div title="" class="mwpg_ml_cs"><span mfg="se_cs" style="background-color:#F00;opacity:0.1;"></span></div></td></tr><tr><th></th><td colspan="2"><input mfg="se_st" type="text" class="mwpg_ml_ilw" maxlength="2" /><span class="mwpg_ml_tip">1-99</span></td></tr><tr><th></th><td colspan="2"><input mfg="se_t" type="text" class="mwpg_ml_ila" maxlength="2" /><span class="mwpg_ml_tip">1-99</span></td></tr></table></div><div class="mwpg_ml_ea"><input mfg="se_s" class="mwpg_ml_bo" type="button" value="" /><a mfg="se_c" class="mwpg_ml_bc" href="javascript:void(0);"></a></div></div></div>'
			,cmarea:false
		});
		/** - **/
		//infowin
		KConfig.set("iw_iwo_mmr", {
			content:'<div class="mwpg_mc"><div mfg="ep" style="display:none;"><div class="mwpg_mc_ec"><table><tbody><tr><th></th><td><input mfg="ep_t" class="mwpg_mc_it" type="text" /><span>18</span></td><td><a mfg="ep_l" class="mwpg_mc_bss" href="javascript:void(0);" title=""><span style="background-color:#FF0000;opacity:0.6;"></span></a></td></tr><tr><th></th><td colspan="2"><textarea mfg="ep_i" class="mwpg_mc_ii"></textarea></td></tr><tr  style="display:none"><th></th><td colspan="2"><form mfg="ep_frm" enctype="multipart/form-data" method="post"><input name="[ep_frm_fn]" mfg="ep_frm_f" type="file" /><p>png,jpg,jpeg</p><input type="submit" style="display:none;"/></form><div class="mwpg_mc_ui" mfg="ep_p"><img src="" /><a href="javascript:void(0);"></a></div></td></tr></tbody></table></div><div class="mwpg_mc_ea"><input mfg="ep_s" class="mwpg_mc_bs" type="button" value="" /><a mfg="ep_c" class="mwpg_mc_bc" href="javascript:void(0);"></a></div></div><div mfg="df"><div class="mwpg_mc_i"><div class="mwpg_mc_ip"><img mfg="df_f" src="[df_fs]" /></div><p mfg="df_i"></p></div><div class="mwpg_mc_na"><a mfg="df_e" class="mwpg_mc_be" href="javascript:void(0);"></a><a mfg="df_d" class="mwpg_mc_bd" href="javascript:void(0);"></a></div><div class="mwpg_mc_l"><strong mfg="df_ds"></strong></div></div><div mfg="se" style="display:none;"><div class="mwpg_mc_sl"><table><tr><th></th><td style="width:215px;"><div class="mwpg_mc_sc"><div mfg="se_c" class="mwpg_mc_sdc"></div><div mfg="se_cp" class="mwpg_mc_cl"></div></div></td><td><div title="" class="mwpg_mc_cs"><span mfg="se_cs" style="background-color:#F00;opacity:0.1;"></span></div></td></tr><tr><th></th><td colspan="2"><input mfg="se_st" type="text" class="mwpg_mc_ipt" maxlength="2" /><span class="mwpg_mc_tip">1-99</span></td></tr><tr><th></th><td colspan="2"><input mfg="se_t" type="text" class="mwpg_mc_ipt" maxlength="2" /><span class="mwpg_mc_tip">1-99</span></td></tr></table></div><div class="mwpg_ml_ea"><input mfg="se_s" class="mwpg_mc_bo" type="button" value="" /><a mfg="se_c" class="mwpg_mc_bc" href="javascript:void(0);"></a></div></div></div>'
			,cmarea:false
		});
		/** -   flash**/
		//infowin
		KConfig.set("iw_iwo_mmr_swf", {
			content:'<div class="mwpg_mc"><div mfg="ep" style="display:none;"><div class="mwpg_mc_ec"><table><tbody><tr><th></th><td><input mfg="ep_t" class="mwpg_mc_it" type="text" /><span>18</span></td><td><a mfg="ep_l" class="mwpg_mc_bss" href="javascript:void(0);" title=""><span style="background-color:#FF0000;opacity:0.6;"></span></a></td></tr><tr><th></th><td colspan="2"><textarea mfg="ep_i" class="mwpg_mc_ii"></textarea></td></tr><tr><th></th><td colspan="2"><span mfg="ep_frm"><input mfg="ep_frm_f" type="button" value=""/><span mfg="ep_frm_fname"></span><p>png,jpg,jpeg</p><input type="submit" style="display:none;"/></span><div class="mwpg_mc_ui" mfg="ep_p"><img src="" /><a href="javascript:void(0);"></a></div></td></tr></tbody></table></div><div class="mwpg_mc_ea"><input mfg="ep_s" class="mwpg_mc_bs" type="button" value="" /><a mfg="ep_c" class="mwpg_mc_bc" href="javascript:void(0);"></a></div></div><div mfg="df"><div class="mwpg_mc_i"><div class="mwpg_mc_ip"><img mfg="df_f" src="[df_fs]" /></div><p mfg="df_i"></p></div><div class="mwpg_mc_na"><a mfg="df_e" class="mwpg_mc_be" href="javascript:void(0);"></a><a mfg="df_d" class="mwpg_mc_bd" href="javascript:void(0);"></a></div><div class="mwpg_mc_l"><strong mfg="df_ds"></strong></div></div><div mfg="se" style="display:none;"><div class="mwpg_mc_sl"><table><tr><th></th><td style="width:215px;"><div class="mwpg_mc_sc"><div mfg="se_c" class="mwpg_mc_sdc"></div><div mfg="se_cp" class="mwpg_mc_cl"></div></div></td><td><div title="" class="mwpg_mc_cs"><span mfg="se_cs" style="background-color:#F00;opacity:0.1;"></span></div></td></tr><tr><th></th><td colspan="2"><input mfg="se_st" type="text" class="mwpg_mc_ipt" maxlength="2" /><span class="mwpg_mc_tip">1-99</span></td></tr><tr><th></th><td colspan="2"><input mfg="se_t" type="text" class="mwpg_mc_ipt" maxlength="2" /><span class="mwpg_mc_tip">1-99</span></td></tr></table></div><div class="mwpg_ml_ea"><input mfg="se_s" class="mwpg_mc_bo" type="button" value="" /><a mfg="se_c" class="mwpg_mc_bc" href="javascript:void(0);"></a></div></div></div>'
			,cmarea:false
		});
		/** - **/
		//infowin
		KConfig.set("iw_iwo_mma", {
            content:'<div class="mwpg_ma"><div mfg="ep" style="display:none;"><div class="mwpg_ma_ec"><table><tbody><tr><th></th><td><input mfg="ep_t" class="mwpg_ma_it" type="text" /><span>18</span></td><td><a mfg="ep_l" class="mwpg_ma_bss" href="javascript:void(0);" title=""><span style="background-color:#F66;"></span></a></td></tr><tr><th></th><td colspan="2"><textarea mfg="ep_i" class="mwpg_ma_ii"></textarea></td></tr><tr style="display:none"><th></th><td colspan="2"><form mfg="ep_frm" enctype="multipart/form-data" method="post"><input name="[ep_frm_fn]" mfg="ep_frm_f" type="file" /><p>png,jpg,jpeg</p></form><div class="mwpg_ma_ui" mfg="ep_p"><img src="" /><a href="javascript:void(0);"></a></div></td></tr></tbody></table></div><div class="mwpg_ma_ea"><input mfg="ep_s" class="mwpg_ma_bs" type="button" value="" /><a mfg="ep_c" class="mwpg_ma_bc" href="javascript:void(0);"></a></div></div><div mfg="df"><div class="mwpg_ma_i"><div class="mwpg_ma_ip"><img mfg="df_f" src="[df_fs]" /></div><p mfg="df_i"></p></div><div class="mwpg_ma_na"><a mfg="df_e" class="mwpg_ma_be" href="javascript:void(0);"></a><a mfg="df_d" class="mwpg_ma_bd" href="javascript:void(0);"></a></div><div class="mwpg_ma_a">:<strong mfg="df_ds"></strong></div></div><div mfg="se" style="display:none;"><div class="mwpg_ma_sl"><table><tr><th></th><td style="width:215px;"><div class="mwpg_ma_sc"><div mfg="se_bc" class="mwpg_ma_sdc"></div><div mfg="se_bcp" class="mwpg_ma_cl"></div></div></td><td><div title="" class="mwpg_ma_cs"><span mfg="se_cs" style="background-color:#F00;opacity:0.1;"></span></div></td></tr><tr><th></th><td colspan="2"><input mfg="se_st" type="text" class="mwpg_ma_ipt" maxlength="2" /><span class="mwpg_ma_tip">1-99</span></td></tr><tr><th></th><td colspan="2"><input mfg="se_t" type="text" class="mwpg_ma_ipt" maxlength="2" /><span class="mwpg_ma_tip">1-99</span></td></tr><tr><th></th><td colspan="2"><div class="mwpg_ma_sc"><div mfg="se_fc" class="mwpg_ma_sdc"></div><div mfg="se_fcp" class="mwpg_ma_cl"></div></div></td></tr><tr><th></th><td colspan="2"><input mfg="se_ft" type="text" class="mwpg_ma_ipt" maxlength="2" /><span class="mwpg_ma_tip">1-99</span></td></tr></table></div><div class="mwpg_ml_ea"><input mfg="se_s" class="mwpg_ma_bo" type="button" value="" /><a mfg="se_c" class="mwpg_ma_bc" href="javascript:void(0);"></a></div></div></div>'
			,cmarea:false
		});
		/** -   flash**/
		//infowin
		KConfig.set("iw_iwo_mma_swf", {
            content:'<div class="mwpg_ma"><div mfg="ep" style="display:none;"><div class="mwpg_ma_ec"><table><tbody><tr><th></th><td><input mfg="ep_t" class="mwpg_ma_it" type="text" /><span>18</span></td><td><a mfg="ep_l" class="mwpg_ma_bss" href="javascript:void(0);" title=""><span style="background-color:#F66;"></span></a></td></tr><tr><th></th><td colspan="2"><textarea mfg="ep_i" class="mwpg_ma_ii"></textarea></td></tr><tr><th></th><td colspan="2"><span mfg="ep_frm"><input mfg="ep_frm_f" type="button" value=""/><span mfg="ep_frm_fname"></span><p>png,jpg,jpeg</p><input type="submit" style="display:none;"/></span><div class="mwpg_ma_ui" mfg="ep_p"><img src="" /><a href="javascript:void(0);"></a></div></td></tr></tbody></table></div><div class="mwpg_ma_ea"><input mfg="ep_s" class="mwpg_ma_bs" type="button" value="" /><a mfg="ep_c" class="mwpg_ma_bc" href="javascript:void(0);"></a></div></div><div mfg="df"><div class="mwpg_ma_i"><div class="mwpg_ma_ip"><img mfg="df_f" src="[df_fs]" /></div><p mfg="df_i"></p></div><div class="mwpg_ma_na"><a mfg="df_e" class="mwpg_ma_be" href="javascript:void(0);"></a><a mfg="df_d" class="mwpg_ma_bd" href="javascript:void(0);"></a></div><div class="mwpg_ma_a">:<strong mfg="df_ds"></strong></div></div><div mfg="se" style="display:none;"><div class="mwpg_ma_sl"><table><tr><th></th><td style="width:215px;"><div class="mwpg_ma_sc"><div mfg="se_bc" class="mwpg_ma_sdc"></div><div mfg="se_bcp" class="mwpg_ma_cl"></div></div></td><td><div title="" class="mwpg_ma_cs"><span mfg="se_cs" style="background-color:#F00;opacity:0.1;"></span></div></td></tr><tr><th></th><td colspan="2"><input mfg="se_st" type="text" class="mwpg_ma_ipt" maxlength="2" /><span class="mwpg_ma_tip">1-99</span></td></tr><tr><th></th><td colspan="2"><input mfg="se_t" type="text" class="mwpg_ma_ipt" maxlength="2" /><span class="mwpg_ma_tip">1-99</span></td></tr><tr><th></th><td colspan="2"><div class="mwpg_ma_sc"><div mfg="se_fc" class="mwpg_ma_sdc"></div><div mfg="se_fcp" class="mwpg_ma_cl"></div></div></td></tr><tr><th></th><td colspan="2"><input mfg="se_ft" type="text" class="mwpg_ma_ipt" maxlength="2" /><span class="mwpg_ma_tip">1-99</span></td></tr></table></div><div class="mwpg_ml_ea"><input mfg="se_s" class="mwpg_ma_bo" type="button" value="" /><a mfg="se_c" class="mwpg_ma_bc" href="javascript:void(0);"></a></div></div></div>'
			,cmarea:false
		});
		
    }

//$(window).bind("unload", function() {});
